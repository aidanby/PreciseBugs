{"buggy_code": ["<?php\n/**\n * 2007-2020 PrestaShop SA and Contributors\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * https://opensource.org/licenses/OSL-3.0\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@prestashop.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade PrestaShop to newer\n * versions in the future. If you wish to customize PrestaShop for your\n * needs please refer to https://www.prestashop.com for more information.\n *\n * @author    PrestaShop SA <contact@prestashop.com>\n * @copyright 2007-2020 PrestaShop SA and Contributors\n * @license   https://opensource.org/licenses/OSL-3.0 Open Software License (OSL 3.0)\n * International Registered Trademark & Property of PrestaShop SA\n */\nuse PrestaShop\\PrestaShop\\Adapter\\ContainerBuilder;\nuse PrestaShop\\PrestaShop\\Core\\Feature\\TokenInUrls;\nuse PrestaShop\\PrestaShop\\Core\\Localization\\Locale;\nuse PrestaShop\\PrestaShop\\Core\\Localization\\Specification\\Number as NumberSpecification;\nuse PrestaShop\\PrestaShop\\Core\\Localization\\Specification\\Price as PriceSpecification;\n\nclass AdminControllerCore extends Controller\n{\n    /** @var string */\n    public $path;\n\n    /** @var string */\n    public static $currentIndex;\n\n    /** @var string */\n    public $content;\n\n    /** @var array */\n    public $warnings = [];\n\n    /** @var array */\n    public $informations = [];\n\n    /** @var array */\n    public $confirmations = [];\n\n    /** @var string|false */\n    public $shopShareDatas = false;\n\n    /** @var array */\n    public $_languages = [];\n\n    /** @var int */\n    public $default_form_language;\n\n    /** @var bool */\n    public $allow_employee_form_lang;\n\n    /** @var string */\n    public $layout = 'layout.tpl';\n\n    /** @var bool */\n    public $bootstrap = false;\n\n    /** @var string|array */\n    protected $meta_title = [];\n\n    /** @var string */\n    public $template = 'content.tpl';\n\n    /** @var string Associated table name */\n    public $table = 'configuration';\n\n    /** @var string */\n    public $list_id;\n\n    /** @var string|false Object identifier inside the associated table */\n    protected $identifier = false;\n\n    /** @var string */\n    protected $identifier_name = 'name';\n\n    /** @var string Associated object class name */\n    public $className;\n\n    /** @var array */\n    public $tabAccess;\n\n    /** @var int Tab id */\n    public $id = -1;\n\n    /** @var bool */\n    public $required_database = false;\n\n    /** @var string Security token */\n    public $token;\n\n    /** @var string \"shop\" or \"group_shop\" */\n    public $shopLinkType;\n\n    /** @var string Default ORDER BY clause when $_orderBy is not defined */\n    protected $_defaultOrderBy = false;\n\n    /** @var string */\n    protected $_defaultOrderWay = 'ASC';\n\n    /** @var array */\n    public $tpl_form_vars = [];\n\n    /** @var array */\n    public $tpl_list_vars = [];\n\n    /** @var array */\n    public $tpl_delete_link_vars = [];\n\n    /** @var array */\n    public $tpl_option_vars = [];\n\n    /** @var array */\n    public $tpl_view_vars = [];\n\n    /** @var array */\n    public $tpl_required_fields_vars = [];\n\n    /** @var string|null */\n    public $base_tpl_view = null;\n\n    /** @var string|null */\n    public $base_tpl_form = null;\n\n    /** @var bool If you want more fieldsets in the form */\n    public $multiple_fieldsets = false;\n\n    /** @var array|false */\n    public $fields_value = false;\n\n    /** @var array Errors displayed after post processing */\n    public $errors = [];\n\n    /** @var bool Define if the header of the list contains filter and sorting links or not */\n    protected $list_simple_header;\n\n    /** @var array List to be generated */\n    protected $fields_list;\n\n    /** @var array Modules list filters */\n    protected $filter_modules_list = null;\n\n    /** @var array Modules list filters */\n    protected $modules_list = [];\n\n    /** @var array Edit form to be generated */\n    protected $fields_form;\n\n    /** @var array Override of $fields_form */\n    protected $fields_form_override;\n\n    /** @var string Override form action */\n    protected $submit_action;\n\n    /** @var array List of option forms to be generated */\n    protected $fields_options = [];\n\n    /** @var string */\n    protected $shopLink;\n\n    /** @var string SQL query */\n    protected $_listsql = '';\n\n    /** @var array Cache for query results */\n    protected $_list = [];\n\n    /** @var string MySQL error */\n    protected $_list_error;\n\n    /** @var string|array Toolbar title */\n    protected $toolbar_title;\n\n    /** @var array List of toolbar buttons */\n    protected $toolbar_btn = null;\n\n    /** @var bool Scrolling toolbar */\n    protected $toolbar_scroll = true;\n\n    /** @var bool Set to false to hide toolbar and page title */\n    protected $show_toolbar = true;\n\n    /** @var bool Set to true to show toolbar and page title for options */\n    protected $show_toolbar_options = false;\n\n    /** @var int Number of results in list */\n    protected $_listTotal = 0;\n\n    /** @var bool Automatically join language table if true */\n    public $lang = false;\n\n    /** @var array WHERE clause determined by filter fields */\n    protected $_filter;\n\n    /** @var string */\n    protected $_filterHaving;\n\n    /** @var array Temporary SQL table WHERE clause determined by filter fields */\n    protected $_tmpTableFilter = '';\n\n    /** @var array Number of results in list per page (used in select field) */\n    protected $_pagination = [20, 50, 100, 300, 1000];\n\n    /** @var int Default number of results in list per page */\n    protected $_default_pagination = 50;\n\n    /** @var string ORDER BY clause determined by field/arrows in list header */\n    protected $_orderBy;\n\n    /** @var string Order way (ASC, DESC) determined by arrows in list header */\n    protected $_orderWay;\n\n    /** @var array List of available actions for each list row - default actions are view, edit, delete, duplicate */\n    protected $actions_available = ['view', 'edit', 'duplicate', 'delete'];\n\n    /** @var array List of required actions for each list row */\n    protected $actions = [];\n\n    /** @var array List of row ids associated with a given action for witch this action have to not be available */\n    protected $list_skip_actions = [];\n\n    /** @var bool Don't show header & footer */\n    protected $lite_display = false;\n\n    /** @var bool List content lines are clickable if true */\n    protected $list_no_link = false;\n\n    /** @var bool */\n    protected $allow_export = false;\n\n    /** @var array Cache for translations */\n    public static $cache_lang = [];\n\n    /** @var array Required_fields to display in the Required Fields form */\n    public $required_fields = [];\n\n    /** @var HelperList */\n    protected $helper;\n\n    /** @var bool */\n    private $allowAnonymous = false;\n\n    /** @var int DELETE access level */\n    const LEVEL_DELETE = 4;\n\n    /** @var int ADD access level */\n    const LEVEL_ADD = 3;\n\n    /** @var int EDIT access level */\n    const LEVEL_EDIT = 2;\n\n    /** @var int VIEW access level */\n    const LEVEL_VIEW = 1;\n\n    /**\n     * Actions to execute on multiple selections.\n     *\n     * Usage:\n     *\n     * array(\n     *      'actionName' => array(\n     *      'text' => $this->trans('Message displayed on the submit button (mandatory)'),\n     *      'confirm' => $this->trans('If set, this confirmation message will pop-up (optional)')),\n     *      'anotherAction' => array(...)\n     * );\n     *\n     * If your action is named 'actionName', you need to have a method named bulkactionName() that will be executed when the button is clicked.\n     *\n     * @var array\n     */\n    protected $bulk_actions;\n\n    /** @var array Ids of the rows selected */\n    protected $boxes;\n\n    /** @var string Do not automatically select * anymore but select only what is necessary */\n    protected $explicitSelect = false;\n\n    /** @var string Add fields into data query to display list */\n    protected $_select;\n\n    /** @var string Join tables into data query to display list */\n    protected $_join;\n\n    /** @var string Add conditions into data query to display list */\n    protected $_where;\n\n    /** @var string Group rows into data query to display list */\n    protected $_group;\n\n    /** @var string Having rows into data query to display list */\n    protected $_having;\n\n    /** @var string Use SQL_CALC_FOUND_ROWS / FOUND_ROWS to count the number of records */\n    protected $_use_found_rows = true;\n\n    /** @var bool */\n    protected $is_cms = false;\n\n    /** @var string Identifier to use for changing positions in lists (can be omitted if positions cannot be changed) */\n    protected $position_identifier;\n\n    /** @var string|int */\n    protected $position_group_identifier;\n\n    /** @var bool Table records are not deleted but marked as deleted if set to true */\n    protected $deleted = false;\n\n    /** @var bool Is a list filter set */\n    protected $filter;\n\n    /** @var bool */\n    protected $noLink;\n\n    /** @var bool|null */\n    protected $specificConfirmDelete = null;\n\n    /** @var bool */\n    protected $colorOnBackground;\n\n    /** @var bool If true, activates color on hover */\n    protected $row_hover = true;\n\n    /** @var string Action to perform : 'edit', 'view', 'add', ... */\n    protected $action;\n\n    /** @var string */\n    protected $display;\n\n    /** @var array */\n    protected $tab_modules_list = ['default_list' => [], 'slider_list' => []];\n\n    /** @var string */\n    public $tpl_folder;\n\n    /** @var string */\n    protected $bo_theme;\n\n    /** @var bool Redirect or not after a creation */\n    protected $_redirect = true;\n\n    /** @var array Name and directory where class image are located */\n    public $fieldImageSettings = [];\n\n    /** @var string Image type */\n    public $imageType = 'jpg';\n\n    /** @var ObjectModel Instantiation of the class associated with the AdminController */\n    protected $object;\n\n    /** @var int Current object ID */\n    protected $id_object;\n\n    /** @var string Current controller name without suffix */\n    public $controller_name;\n\n    /** @var int */\n    public $multishop_context = -1;\n\n    /** @var false */\n    public $multishop_context_group = true;\n\n    /** @var array Current breadcrumb position as an array of tab names */\n    protected $breadcrumbs;\n\n    /** @var bool Bootstrap variable */\n    public $show_page_header_toolbar = false;\n\n    /** @var string Bootstrap variable */\n    public $page_header_toolbar_title;\n\n    /** @var array|Traversable Bootstrap variable */\n    public $page_header_toolbar_btn = [];\n\n    /** @var bool Bootstrap variable */\n    public $show_form_cancel_button;\n\n    /** @var string */\n    public $admin_webpath;\n\n    /** @var array */\n    protected $list_natives_modules = [];\n\n    /** @var array */\n    protected $list_partners_modules = [];\n\n    /** @var array */\n    public $modals = [];\n\n    /** @var bool */\n    protected $logged_on_addons = false;\n\n    /** @var bool if logged employee has access to AdminImport */\n    protected $can_import = false;\n\n    /** @var string */\n    protected $tabSlug;\n\n    /** @var int Auth cookie lifetime */\n    const AUTH_COOKIE_LIFETIME = 3600;\n\n    public function __construct($forceControllerName = '', $default_theme_name = 'default')\n    {\n        global $timer_start;\n        $this->timer_start = $timer_start;\n\n        $this->controller_type = 'admin';\n        $this->controller_name = !empty($forceControllerName) ? $forceControllerName : get_class($this);\n        if (strpos($this->controller_name, 'ControllerOverride')) {\n            $this->controller_name = substr($this->controller_name, 0, -18);\n        }\n        if (strpos($this->controller_name, 'Controller')) {\n            $this->controller_name = substr($this->controller_name, 0, -10);\n        }\n        parent::__construct();\n\n        if ($this->multishop_context == -1) {\n            $this->multishop_context = Shop::CONTEXT_ALL | Shop::CONTEXT_GROUP | Shop::CONTEXT_SHOP;\n        }\n\n        if (defined('_PS_BO_ALL_THEMES_DIR_')) {\n            if (defined('_PS_BO_DEFAULT_THEME_') && _PS_BO_DEFAULT_THEME_\n                && @filemtime(_PS_BO_ALL_THEMES_DIR_ . _PS_BO_DEFAULT_THEME_ . DIRECTORY_SEPARATOR . 'template')) {\n                $default_theme_name = _PS_BO_DEFAULT_THEME_;\n            }\n\n            $this->bo_theme = $default_theme_name;\n            if (!@filemtime(_PS_BO_ALL_THEMES_DIR_ . $this->bo_theme . DIRECTORY_SEPARATOR . 'template')) {\n                $this->bo_theme = 'default';\n            }\n\n            $this->context->employee->bo_theme = (\n                Validate::isLoadedObject($this->context->employee)\n                && $this->context->employee->bo_theme\n            ) ? $this->context->employee->bo_theme : $this->bo_theme;\n\n            $this->bo_css = (\n                Validate::isLoadedObject($this->context->employee)\n                && $this->context->employee->bo_css\n            ) ? $this->context->employee->bo_css : 'theme.css';\n            $this->context->employee->bo_css = $this->bo_css;\n\n            $adminThemeCSSFile = _PS_BO_ALL_THEMES_DIR_ . $this->bo_theme . DIRECTORY_SEPARATOR . 'public' . DIRECTORY_SEPARATOR . $this->bo_css;\n\n            if (file_exists($adminThemeCSSFile)) {\n                $this->bo_css = 'theme.css';\n            }\n\n            $this->context->smarty->setTemplateDir([\n                _PS_BO_ALL_THEMES_DIR_ . $this->bo_theme . DIRECTORY_SEPARATOR . 'template',\n                _PS_OVERRIDE_DIR_ . 'controllers' . DIRECTORY_SEPARATOR . 'admin' . DIRECTORY_SEPARATOR . 'templates',\n            ]);\n        }\n\n        $this->id = Tab::getIdFromClassName($this->controller_name);\n        $this->token = Tools::getAdminToken($this->controller_name . (int) $this->id . (int) $this->context->employee->id);\n\n        $this->_conf = [\n            1 => $this->trans('Successful deletion.', [], 'Admin.Notifications.Success'),\n            2 => $this->trans('The selection has been successfully deleted.', [], 'Admin.Notifications.Success'),\n            3 => $this->trans('Successful creation.', [], 'Admin.Notifications.Success'),\n            4 => $this->trans('Successful update.', [], 'Admin.Notifications.Success'),\n            5 => $this->trans('The status has been successfully updated.', [], 'Admin.Notifications.Success'),\n            6 => $this->trans('The settings have been successfully updated.', [], 'Admin.Notifications.Success'),\n            7 => $this->trans('The image was successfully deleted.', [], 'Admin.Notifications.Success'),\n            8 => $this->trans('The module was successfully downloaded.', [], 'Admin.Modules.Notification'),\n            9 => $this->trans('The thumbnails were successfully regenerated.', [], 'Admin.Notifications.Success'),\n            10 => $this->trans('The message was successfully sent to the customer.', [], 'Admin.Orderscustomers.Notification'),\n            11 => $this->trans('Comment successfully added.', [], 'Admin.Notifications.Success'),\n            12 => $this->trans('Module(s) installed successfully.', [], 'Admin.Modules.Notification'),\n            13 => $this->trans('Module(s) uninstalled successfully.', [], 'Admin.Modules.Notification'),\n            14 => $this->trans('The translation was successfully copied.', [], 'Admin.International.Notification'),\n            15 => $this->trans('The translations have been successfully added.', [], 'Admin.International.Notification'),\n            16 => $this->trans('The module transplanted successfully to the hook.', [], 'Admin.Modules.Notification'),\n            17 => $this->trans('The module was successfully removed from the hook.', [], 'Admin.Modules.Notification'),\n            18 => $this->trans('Successful upload.', [], 'Admin.Notifications.Success'),\n            19 => $this->trans('Duplication was completed successfully.', [], 'Admin.Notifications.Success'),\n            20 => $this->trans('The translation was added successfully, but the language has not been created.', [], 'Admin.International.Notification'),\n            21 => $this->trans('Module reset successfully.', [], 'Admin.Modules.Notification'),\n            22 => $this->trans('Module deleted successfully.', [], 'Admin.Modules.Notification'),\n            23 => $this->trans('Localization pack imported successfully.', [], 'Admin.International.Notification'),\n            24 => $this->trans('Localization pack imported successfully.', [], 'Admin.International.Notification'),\n            25 => $this->trans('The selected images have successfully been moved.', [], 'Admin.Notifications.Success'),\n            26 => $this->trans('Your cover image selection has been saved.', [], 'Admin.Notifications.Success'),\n            27 => $this->trans('The image\\'s shop association has been modified.', [], 'Admin.Notifications.Success'),\n            28 => $this->trans('A zone has been assigned to the selection successfully.', [], 'Admin.Notifications.Success'),\n            29 => $this->trans('Successful upgrade.', [], 'Admin.Notifications.Success'),\n            30 => $this->trans('A partial refund was successfully created.', [], 'Admin.Orderscustomers.Notification'),\n            31 => $this->trans('The discount was successfully generated.', [], 'Admin.Catalog.Notification'),\n            32 => $this->trans('Successfully signed in to PrestaShop Addons.', [], 'Admin.Modules.Notification'),\n        ];\n\n        $this->_error = [\n            1 => $this->trans(\n                'The root category of the shop %shop% is not associated with the current shop. You can\\'t access this page. Please change the root category of the shop.',\n                [\n                    '%shop%' => $this->context->shop->name,\n                ],\n                'Admin.Catalog.Notification'\n            ),\n        ];\n\n        if (!$this->identifier) {\n            $this->identifier = 'id_' . $this->table;\n        }\n        if (!$this->_defaultOrderBy) {\n            $this->_defaultOrderBy = $this->identifier;\n        }\n\n        // Fix for homepage\n        if ($this->controller_name == 'AdminDashboard') {\n            $_POST['token'] = $this->token;\n        }\n\n        if (!Shop::isFeatureActive()) {\n            $this->shopLinkType = '';\n        }\n\n        //$this->base_template_folder = _PS_BO_ALL_THEMES_DIR_.$this->bo_theme.'/template';\n        $this->override_folder = Tools::toUnderscoreCase(substr($this->controller_name, 5)) . '/';\n        // Get the name of the folder containing the custom tpl files\n        $this->tpl_folder = Tools::toUnderscoreCase(substr($this->controller_name, 5)) . '/';\n\n        $this->initShopContext();\n\n        if (defined('_PS_ADMIN_DIR_')) {\n            $this->admin_webpath = str_ireplace(_PS_CORE_DIR_, '', _PS_ADMIN_DIR_);\n            $this->admin_webpath = preg_replace('/^' . preg_quote(DIRECTORY_SEPARATOR, '/') . '/', '', $this->admin_webpath);\n        }\n\n        // Check if logged on Addons\n        $this->logged_on_addons = false;\n        if (isset($this->context->cookie->username_addons, $this->context->cookie->password_addons) && !empty($this->context->cookie->username_addons) && !empty($this->context->cookie->password_addons)) {\n            $this->logged_on_addons = true;\n        }\n\n        // Set context mode\n        if (defined('_PS_HOST_MODE_') && _PS_HOST_MODE_) {\n            if (isset($this->context->cookie->is_contributor) && (int) $this->context->cookie->is_contributor === 1) {\n                $this->context->mode = Context::MODE_HOST_CONTRIB;\n            } else {\n                $this->context->mode = Context::MODE_HOST;\n            }\n        } elseif (isset($this->context->cookie->is_contributor) && (int) $this->context->cookie->is_contributor === 1) {\n            $this->context->mode = Context::MODE_STD_CONTRIB;\n        } else {\n            $this->context->mode = Context::MODE_STD;\n        }\n\n        //* Check if logged employee has access to AdminImport controller */\n        $import_access = Profile::getProfileAccess($this->context->employee->id_profile, Tab::getIdFromClassName('AdminImport'));\n        if (is_array($import_access) && isset($import_access['view']) && $import_access['view'] == 1) {\n            $this->can_import = true;\n        }\n\n        $this->context->smarty->assign([\n            'context_mode' => $this->context->mode,\n            'logged_on_addons' => $this->logged_on_addons,\n            'can_import' => $this->can_import,\n        ]);\n    }\n\n    /**\n     * Set breadcrumbs array for the controller page.\n     *\n     * @param int|null $tab_id\n     * @param array|null $tabs\n     */\n    public function initBreadcrumbs($tab_id = null, $tabs = null)\n    {\n        if (!is_array($tabs)) {\n            $tabs = [];\n        }\n\n        if (null === $tab_id) {\n            $tab_id = $this->id;\n        }\n\n        $tabs = Tab::recursiveTab($tab_id, $tabs);\n\n        $dummy = ['name' => '', 'href' => '', 'icon' => ''];\n        $breadcrumbs2 = [\n            'container' => $dummy,\n            'tab' => $dummy,\n            'action' => $dummy,\n        ];\n        if (!empty($tabs[0])) {\n            $this->addMetaTitle($tabs[0]['name']);\n            $breadcrumbs2['tab']['name'] = $tabs[0]['name'];\n            $breadcrumbs2['tab']['href'] = $this->context->link->getTabLink($tabs[0]);\n            if (!isset($tabs[1])) {\n                $breadcrumbs2['tab']['icon'] = 'icon-' . $tabs[0]['class_name'];\n            }\n        }\n        if (!empty($tabs[1])) {\n            $breadcrumbs2['container']['name'] = $tabs[1]['name'];\n            $breadcrumbs2['container']['href'] = $this->context->link->getTabLink($tabs[1]);\n            $breadcrumbs2['container']['icon'] = 'icon-' . $tabs[1]['class_name'];\n        }\n\n        /* content, edit, list, add, details, options, view */\n        switch ($this->display) {\n            case 'add':\n                $breadcrumbs2['action']['name'] = $this->trans('Add');\n                $breadcrumbs2['action']['icon'] = 'icon-plus';\n\n                break;\n            case 'edit':\n                $breadcrumbs2['action']['name'] = $this->trans('Edit');\n                $breadcrumbs2['action']['icon'] = 'icon-pencil';\n\n                break;\n            case '':\n            case 'list':\n                $breadcrumbs2['action']['name'] = $this->trans('List');\n                $breadcrumbs2['action']['icon'] = 'icon-th-list';\n\n                break;\n            case 'details':\n            case 'view':\n                $breadcrumbs2['action']['name'] = $this->trans('View details');\n                $breadcrumbs2['action']['icon'] = 'icon-zoom-in';\n\n                break;\n            case 'options':\n                $breadcrumbs2['action']['name'] = $this->trans('Options');\n                $breadcrumbs2['action']['icon'] = 'icon-cogs';\n\n                break;\n            case 'generator':\n                $breadcrumbs2['action']['name'] = $this->trans('Generator');\n                $breadcrumbs2['action']['icon'] = 'icon-flask';\n\n                break;\n        }\n\n        $this->context->smarty->assign([\n            'breadcrumbs2' => $breadcrumbs2,\n            'quick_access_current_link_name' => Tools::safeOutput($breadcrumbs2['tab']['name'] . (isset($breadcrumbs2['action']) ? ' - ' . $breadcrumbs2['action']['name'] : '')),\n            'quick_access_current_link_icon' => $breadcrumbs2['container']['icon'],\n        ]);\n\n        /* BEGIN - Backward compatibility < 1.6.0.3 */\n        $this->breadcrumbs[] = $tabs[0]['name'];\n        $navigation_pipe = (Configuration::get('PS_NAVIGATION_PIPE') ? Configuration::get('PS_NAVIGATION_PIPE') : '>');\n        $this->context->smarty->assign('navigationPipe', $navigation_pipe);\n        /* END - Backward compatibility < 1.6.0.3 */\n    }\n\n    /**\n     * Set default toolbar_title to admin breadcrumb.\n     */\n    public function initToolbarTitle()\n    {\n        $this->toolbar_title = is_array($this->breadcrumbs) ? array_unique($this->breadcrumbs) : [$this->breadcrumbs];\n\n        switch ($this->display) {\n            case 'edit':\n                $this->toolbar_title[] = $this->trans('Edit');\n                $this->addMetaTitle($this->trans('Edit'));\n\n                break;\n\n            case 'add':\n                $this->toolbar_title[] = $this->trans('Add new');\n                $this->addMetaTitle($this->trans('Add new'));\n\n                break;\n\n            case 'view':\n                $this->toolbar_title[] = $this->trans('View');\n                $this->addMetaTitle($this->trans('View'));\n\n                break;\n        }\n\n        if ($filter = $this->addFiltersToBreadcrumbs()) {\n            $this->toolbar_title[] = $filter;\n        }\n    }\n\n    /**\n     * @return string|void\n     */\n    public function addFiltersToBreadcrumbs()\n    {\n        if ($this->filter && is_array($this->fields_list)) {\n            $filters = [];\n\n            foreach ($this->fields_list as $field => $t) {\n                if (isset($t['filter_key'])) {\n                    $field = $t['filter_key'];\n                }\n\n                if (($val = Tools::getValue($this->table . 'Filter_' . $field)) || $val = $this->context->cookie->{$this->getCookieFilterPrefix() . $this->table . 'Filter_' . $field}) {\n                    if (!is_array($val)) {\n                        $filter_value = '';\n                        if (isset($t['type']) && $t['type'] == 'bool') {\n                            $filter_value = ((bool) $val) ? $this->trans('yes') : $this->trans('no');\n                        } elseif (isset($t['type']) && $t['type'] == 'date' || isset($t['type']) && $t['type'] == 'datetime') {\n                            $date = json_decode($val, true);\n                            if (isset($date[0])) {\n                                $filter_value = $date[0];\n                                if (isset($date[1]) && !empty($date[1])) {\n                                    $filter_value .= ' - ' . $date[1];\n                                }\n                            }\n                        } elseif (is_string($val)) {\n                            $filter_value = htmlspecialchars($val, ENT_QUOTES, 'UTF-8');\n                        }\n                        if (!empty($filter_value)) {\n                            $filters[] = $this->trans('%s: %s', [$t['title'], $filter_value]);\n                        }\n                    } else {\n                        $filter_value = '';\n                        foreach ($val as $v) {\n                            if (is_string($v) && !empty($v)) {\n                                $filter_value .= ' - ' . htmlspecialchars($v, ENT_QUOTES, 'UTF-8');\n                            }\n                        }\n                        $filter_value = ltrim($filter_value, ' -');\n                        if (!empty($filter_value)) {\n                            $filters[] = $this->trans('%s: %s', [$t['title'], $filter_value]);\n                        }\n                    }\n                }\n            }\n\n            if (count($filters)) {\n                return $this->trans('filter by %s', [implode(', ', $filters)]);\n            }\n        }\n    }\n\n    /**\n     * @param string $action\n     * @param bool $disable\n     */\n    public function access($action, $disable = false)\n    {\n        if (empty($this->tabAccess[$action])) {\n            $slugs = [];\n\n            foreach ((array) Access::getAuthorizationFromLegacy($action) as $roleSuffix) {\n                $slugs[] = $this->getTabSlug() . $roleSuffix;\n            }\n\n            $this->tabAccess[$action] = Access::isGranted(\n                $slugs,\n                $this->context->employee->id_profile\n            );\n        }\n\n        return $this->tabAccess[$action];\n    }\n\n    /**\n     * Check rights to view the current tab.\n     *\n     * @param bool $disable\n     *\n     * @return bool\n     */\n    public function viewAccess($disable = false)\n    {\n        return $this->access('view', $disable);\n    }\n\n    /**\n     * Check for security token.\n     *\n     * @return bool\n     */\n    public function checkToken()\n    {\n        if (TokenInUrls::isDisabled() || $this->isAnonymousAllowed()) {\n            return true;\n        }\n\n        $token = Tools::getValue('token');\n        if ($token === $this->token) {\n            return true;\n        }\n\n        if (count($_POST) || !isset($_GET['controller']) || !Validate::isControllerName($_GET['controller']) || !$token) {\n            return false;\n        }\n\n        foreach ($_GET as $key => $value) {\n            if (is_array($value) || !in_array($key, ['controller', 'controllerUri'])) {\n                return false;\n            }\n        }\n\n        $cookie = Context::getContext()->cookie;\n        $whitelist = ['date_add', 'id_lang', 'id_employee', 'email', 'profile', 'passwd', 'remote_addr', 'shopContext', 'collapse_menu', 'checksum'];\n        foreach ($cookie->getAll() as $key => $value) {\n            if (!in_array($key, $whitelist)) {\n                unset($cookie->$key);\n            }\n        }\n\n        $cookie->write();\n\n        return true;\n    }\n\n    /**\n     * Set the filters used for the list display.\n     */\n    protected function getCookieFilterPrefix()\n    {\n        return str_replace(['admin', 'controller'], '', Tools::strtolower(get_class($this)));\n    }\n\n    public function processFilter()\n    {\n        Hook::exec('action' . $this->controller_name . 'ListingFieldsModifier', [\n            'fields' => &$this->fields_list,\n        ]);\n\n        if (!isset($this->list_id)) {\n            $this->list_id = $this->table;\n        }\n\n        $prefix = $this->getCookieFilterPrefix();\n\n        if (isset($this->list_id)) {\n            foreach ($_POST as $key => $value) {\n                if ($value === '') {\n                    unset($this->context->cookie->{$prefix . $key});\n                } elseif (stripos($key, $this->list_id . 'Filter_') === 0) {\n                    $this->context->cookie->{$prefix . $key} = !is_array($value) ? $value : json_encode($value);\n                } elseif (stripos($key, 'submitFilter') === 0) {\n                    $this->context->cookie->$key = !is_array($value) ? $value : json_encode($value);\n                }\n            }\n\n            foreach ($_GET as $key => $value) {\n                if (stripos($key, $this->list_id . 'Filter_') === 0) {\n                    $this->context->cookie->{$prefix . $key} = !is_array($value) ? $value : json_encode($value);\n                } elseif (stripos($key, 'submitFilter') === 0) {\n                    $this->context->cookie->$key = !is_array($value) ? $value : json_encode($value);\n                }\n                if (stripos($key, $this->list_id . 'Orderby') === 0 && Validate::isOrderBy($value)) {\n                    if ($value === '' || $value == $this->_defaultOrderBy) {\n                        unset($this->context->cookie->{$prefix . $key});\n                    } else {\n                        $this->context->cookie->{$prefix . $key} = $value;\n                    }\n                } elseif (stripos($key, $this->list_id . 'Orderway') === 0 && Validate::isOrderWay($value)) {\n                    if ($value === '' || $value == $this->_defaultOrderWay) {\n                        unset($this->context->cookie->{$prefix . $key});\n                    } else {\n                        $this->context->cookie->{$prefix . $key} = $value;\n                    }\n                }\n            }\n        }\n\n        $filters = $this->context->cookie->getFamily($prefix . $this->list_id . 'Filter_');\n        $definition = false;\n        if (isset($this->className) && $this->className) {\n            $definition = ObjectModel::getDefinition($this->className);\n        }\n\n        foreach ($filters as $key => $value) {\n            /* Extracting filters from $_POST on key filter_ */\n            if ($value != null && !strncmp($key, $prefix . $this->list_id . 'Filter_', 7 + Tools::strlen($prefix . $this->list_id))) {\n                $key = Tools::substr($key, 7 + Tools::strlen($prefix . $this->list_id));\n                /* Table alias could be specified using a ! eg. alias!field */\n                $tmp_tab = explode('!', $key);\n                $filter = count($tmp_tab) > 1 ? $tmp_tab[1] : $tmp_tab[0];\n\n                if ($field = $this->filterToField($key, $filter)) {\n                    $type = (array_key_exists('filter_type', $field) ? $field['filter_type'] : (array_key_exists('type', $field) ? $field['type'] : false));\n                    if (($type == 'date' || $type == 'datetime') && is_string($value)) {\n                        $value = json_decode($value, true);\n                    }\n                    $key = isset($tmp_tab[1]) ? $tmp_tab[0] . '.`' . $tmp_tab[1] . '`' : '`' . $tmp_tab[0] . '`';\n\n                    // Assignment by reference\n                    if (array_key_exists('tmpTableFilter', $field)) {\n                        $sql_filter = &$this->_tmpTableFilter;\n                    } elseif (array_key_exists('havingFilter', $field)) {\n                        $sql_filter = &$this->_filterHaving;\n                    } else {\n                        $sql_filter = &$this->_filter;\n                    }\n\n                    /* Only for date filtering (from, to) */\n                    if (is_array($value)) {\n                        if (isset($value[0]) && !empty($value[0])) {\n                            if (!Validate::isDate($value[0])) {\n                                $this->errors[] = $this->trans('The \\'From\\' date format is invalid (YYYY-MM-DD)', [], 'Admin.Notifications.Error');\n                            } else {\n                                $sql_filter .= ' AND ' . pSQL($key) . ' >= \\'' . pSQL(Tools::dateFrom($value[0])) . '\\'';\n                            }\n                        }\n\n                        if (isset($value[1]) && !empty($value[1])) {\n                            if (!Validate::isDate($value[1])) {\n                                $this->errors[] = $this->trans('The \\'To\\' date format is invalid (YYYY-MM-DD)', [], 'Admin.Notifications.Error');\n                            } else {\n                                $sql_filter .= ' AND ' . pSQL($key) . ' <= \\'' . pSQL(Tools::dateTo($value[1])) . '\\'';\n                            }\n                        }\n                    } else {\n                        $sql_filter .= ' AND ';\n                        $check_key = ($key == $this->identifier || $key == '`' . $this->identifier . '`');\n                        $alias = ($definition && !empty($definition['fields'][$filter]['shop'])) ? 'sa' : 'a';\n\n                        if ($type == 'int' || $type == 'bool') {\n                            $sql_filter .= (($check_key || $key == '`active`') ? $alias . '.' : '') . pSQL($key) . ' = ' . (int) $value . ' ';\n                        } elseif ($type == 'decimal') {\n                            $sql_filter .= ($check_key ? $alias . '.' : '') . pSQL($key) . ' = ' . (float) $value . ' ';\n                        } elseif ($type == 'select') {\n                            $sql_filter .= ($check_key ? $alias . '.' : '') . pSQL($key) . ' = \\'' . pSQL($value) . '\\' ';\n                        } elseif ($type == 'price') {\n                            $value = (float) str_replace(',', '.', $value);\n                            $sql_filter .= ($check_key ? $alias . '.' : '') . pSQL($key) . ' = ' . pSQL(trim($value)) . ' ';\n                        } else {\n                            $sql_filter .= ($check_key ? $alias . '.' : '') . pSQL($key) . ' LIKE \\'%' . pSQL(trim($value)) . '%\\' ';\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    /**\n     * @TODO uses redirectAdmin only if !$this->ajax\n     *\n     * @return ObjectModel|bool\n     */\n    public function postProcess()\n    {\n        try {\n            if ($this->ajax) {\n                // from ajax-tab.php\n                $action = Tools::getValue('action');\n                // no need to use displayConf() here\n                if (!empty($action) && method_exists($this, 'ajaxProcess' . Tools::toCamelCase($action))) {\n                    Hook::exec('actionAdmin' . ucfirst($this->action) . 'Before', ['controller' => $this]);\n                    Hook::exec('action' . get_class($this) . ucfirst($this->action) . 'Before', ['controller' => $this]);\n\n                    $return = $this->{'ajaxProcess' . Tools::toCamelCase($action)}();\n\n                    Hook::exec('actionAdmin' . ucfirst($this->action) . 'After', ['controller' => $this, 'return' => $return]);\n                    Hook::exec('action' . get_class($this) . ucfirst($this->action) . 'After', ['controller' => $this, 'return' => $return]);\n\n                    return $return;\n                } elseif (!empty($action) && $this->controller_name == 'AdminModules' && Tools::getIsset('configure')) {\n                    $module_obj = Module::getInstanceByName(Tools::getValue('configure'));\n                    if (Validate::isLoadedObject($module_obj) && method_exists($module_obj, 'ajaxProcess' . $action)) {\n                        return $module_obj->{'ajaxProcess' . $action}();\n                    }\n                } elseif (method_exists($this, 'ajaxProcess')) {\n                    return $this->ajaxProcess();\n                }\n            } else {\n                // Process list filtering\n                if ($this->filter && $this->action != 'reset_filters') {\n                    $this->processFilter();\n                }\n\n                if (isset($_POST) && count($_POST) && (int) Tools::getValue('submitFilter' . $this->list_id) || Tools::isSubmit('submitReset' . $this->list_id)) {\n                    $this->setRedirectAfter(self::$currentIndex . '&token=' . $this->token . (Tools::isSubmit('submitFilter' . $this->list_id) ? '&submitFilter' . $this->list_id . '=' . (int) Tools::getValue('submitFilter' . $this->list_id) : ''));\n                }\n\n                // If the method named after the action exists, call \"before\" hooks, then call action method, then call \"after\" hooks\n                if (!empty($this->action) && method_exists($this, 'process' . ucfirst(Tools::toCamelCase($this->action)))) {\n                    // Hook before action\n                    Hook::exec('actionAdmin' . ucfirst($this->action) . 'Before', ['controller' => $this]);\n                    Hook::exec('action' . get_class($this) . ucfirst($this->action) . 'Before', ['controller' => $this]);\n                    // Call process\n                    $return = $this->{'process' . Tools::toCamelCase($this->action)}();\n\n                    // Hook After Action\n                    Hook::exec('actionAdmin' . ucfirst($this->action) . 'After', ['controller' => $this, 'return' => $return]);\n                    Hook::exec('action' . get_class($this) . ucfirst($this->action) . 'After', ['controller' => $this, 'return' => $return]);\n\n                    return $return;\n                }\n            }\n        } catch (PrestaShopException $e) {\n            $this->errors[] = $e->getMessage();\n        }\n\n        return false;\n    }\n\n    /**\n     * Object Delete images.\n     *\n     * @return ObjectModel|false\n     */\n    public function processDeleteImage()\n    {\n        if (Validate::isLoadedObject($object = $this->loadObject())) {\n            if (($object->deleteImage())) {\n                $redirect = self::$currentIndex . '&update' . $this->table . '&' . $this->identifier . '=' . Tools::getValue($this->identifier) . '&conf=7&token=' . $this->token;\n                if (!$this->ajax) {\n                    $this->redirect_after = $redirect;\n                } else {\n                    $this->content = 'ok';\n                }\n            }\n        }\n        $this->errors[] = $this->trans('An error occurred while attempting to delete the image. (cannot load object).', [], 'Admin.Notifications.Error');\n\n        return $object;\n    }\n\n    /**\n     * @param string $text_delimiter\n     *\n     * @throws PrestaShopException\n     */\n    public function processExport($text_delimiter = '\"')\n    {\n        // clean buffer\n        if (ob_get_level() && ob_get_length() > 0) {\n            ob_clean();\n        }\n        $this->getList($this->context->language->id, null, null, 0, false);\n        if (!count($this->_list)) {\n            return;\n        }\n\n        header('Content-type: text/csv');\n        header('Content-Type: application/force-download; charset=UTF-8');\n        header('Cache-Control: no-store, no-cache');\n        header('Content-disposition: attachment; filename=\"' . $this->table . '_' . date('Y-m-d_His') . '.csv\"');\n\n        $fd = fopen('php://output', 'wb');\n        $headers = [];\n        foreach ($this->fields_list as $key => $datas) {\n            if ('PDF' === $datas['title']) {\n                unset($this->fields_list[$key]);\n            } else {\n                if ('ID' === $datas['title']) {\n                    $headers[] = strtolower(Tools::htmlentitiesDecodeUTF8($datas['title']));\n                } else {\n                    $headers[] = Tools::htmlentitiesDecodeUTF8($datas['title']);\n                }\n            }\n        }\n        fputcsv($fd, $headers, ';', $text_delimiter);\n\n        foreach ($this->_list as $i => $row) {\n            $content = [];\n            $path_to_image = false;\n            foreach ($this->fields_list as $key => $params) {\n                $field_value = isset($row[$key]) ? Tools::htmlentitiesDecodeUTF8(Tools::nl2br($row[$key])) : '';\n                if ($key == 'image') {\n                    if ($params['image'] != 'p' || Configuration::get('PS_LEGACY_IMAGES')) {\n                        $path_to_image = Tools::getShopDomain(true) . _PS_IMG_ . $params['image'] . '/' . $row['id_' . $this->table] . (isset($row['id_image']) ? '-' . (int) $row['id_image'] : '') . '.' . $this->imageType;\n                    } else {\n                        $path_to_image = Tools::getShopDomain(true) . _PS_IMG_ . $params['image'] . '/' . Image::getImgFolderStatic($row['id_image']) . (int) $row['id_image'] . '.' . $this->imageType;\n                    }\n                    if ($path_to_image) {\n                        $field_value = $path_to_image;\n                    }\n                }\n                if (isset($params['callback'])) {\n                    $callback_obj = (isset($params['callback_object'])) ? $params['callback_object'] : $this->context->controller;\n                    if (!preg_match('/<([a-z]+)([^<]+)*(?:>(.*)<\\/\\1>|\\s+\\/>)/ism', call_user_func_array([$callback_obj, $params['callback']], [$field_value, $row]))) {\n                        $field_value = call_user_func_array([$callback_obj, $params['callback']], [$field_value, $row]);\n                    }\n                }\n                $content[] = $field_value;\n            }\n            fputcsv($fd, $content, ';', $text_delimiter);\n        }\n        @fclose($fd);\n        die;\n    }\n\n    /**\n     * Object Delete.\n     *\n     * @return ObjectModel|false\n     *\n     * @throws PrestaShopException\n     */\n    public function processDelete()\n    {\n        if (Validate::isLoadedObject($object = $this->loadObject())) {\n            $res = true;\n            // check if request at least one object with noZeroObject\n            if (isset($object->noZeroObject) && count(call_user_func([$this->className, $object->noZeroObject])) <= 1) {\n                $this->errors[] = $this->trans('You need at least one object.', [], 'Admin.Notifications.Error') .\n                    ' <b>' . $this->table . '</b><br />' .\n                    $this->trans('You cannot delete all of the items.', [], 'Admin.Notifications.Error');\n            } elseif (array_key_exists('delete', $this->list_skip_actions) && in_array($object->id, $this->list_skip_actions['delete'])) { //check if some ids are in list_skip_actions and forbid deletion\n                $this->errors[] = $this->trans('You cannot delete this item.', [], 'Admin.Notifications.Error');\n            } else {\n                if ($this->deleted) {\n                    if (!empty($this->fieldImageSettings)) {\n                        $res = $object->deleteImage();\n                    }\n\n                    if (!$res) {\n                        $this->errors[] = $this->trans('Unable to delete associated images.', [], 'Admin.Notifications.Error');\n                    }\n\n                    $object->deleted = 1;\n                    if ($res = $object->update()) {\n                        $this->redirect_after = self::$currentIndex . '&conf=1&token=' . $this->token;\n                    }\n                } elseif ($res = $object->delete()) {\n                    $this->redirect_after = self::$currentIndex . '&conf=1&token=' . $this->token;\n                }\n                $this->errors[] = $this->trans('An error occurred during deletion.', [], 'Admin.Notifications.Error');\n                if ($res) {\n                    PrestaShopLogger::addLog(\n                        $this->trans('%s deletion', [$this->className]),\n                        1,\n                        null,\n                        $this->className,\n                        (int) $this->object->id,\n                        true,\n                        (int) $this->context->employee->id\n                    );\n                }\n            }\n        } else {\n            $this->errors[] = $this->trans('An error occurred while deleting the object.', [], 'Admin.Notifications.Error') .\n                ' <b>' . $this->table . '</b> ' .\n                $this->trans('(cannot load object)', [], 'Admin.Notifications.Error');\n        }\n\n        return $object;\n    }\n\n    /**\n     * Call the right method for creating or updating object.\n     *\n     * @return ObjectModel|false|void\n     */\n    public function processSave()\n    {\n        if ($this->id_object) {\n            $this->object = $this->loadObject();\n\n            return $this->processUpdate();\n        } else {\n            return $this->processAdd();\n        }\n    }\n\n    /**\n     * Object creation.\n     *\n     * @return ObjectModel|false\n     *\n     * @throws PrestaShopException\n     */\n    public function processAdd()\n    {\n        if (!isset($this->className) || empty($this->className)) {\n            return false;\n        }\n\n        $this->validateRules();\n        if (count($this->errors) <= 0) {\n            $this->object = new $this->className();\n\n            $this->copyFromPost($this->object, $this->table);\n            $this->beforeAdd($this->object);\n            if (method_exists($this->object, 'add') && !$this->object->add()) {\n                $this->errors[] = $this->trans('An error occurred while creating an object.', [], 'Admin.Notifications.Error') .\n                    ' <b>' . $this->table . ' (' . Db::getInstance()->getMsgError() . ')</b>';\n            } elseif (($_POST[$this->identifier] = $this->object->id /* voluntary do affectation here */) && $this->postImage($this->object->id) && !count($this->errors) && $this->_redirect) {\n                PrestaShopLogger::addLog(\n                    $this->trans('%s addition', [$this->className]),\n                    1,\n                    null,\n                    $this->className,\n                    (int) $this->object->id,\n                    true,\n                    (int) $this->context->employee->id\n                );\n                $parent_id = (int) Tools::getValue('id_parent', 1);\n                $this->afterAdd($this->object);\n                $this->updateAssoShop($this->object->id);\n                // Save and stay on same form\n                if (empty($this->redirect_after) && $this->redirect_after !== false && Tools::isSubmit('submitAdd' . $this->table . 'AndStay')) {\n                    $this->redirect_after = self::$currentIndex . '&' . $this->identifier . '=' . $this->object->id . '&conf=3&update' . $this->table . '&token=' . $this->token;\n                }\n                // Save and back to parent\n                if (empty($this->redirect_after) && $this->redirect_after !== false && Tools::isSubmit('submitAdd' . $this->table . 'AndBackToParent')) {\n                    $this->redirect_after = self::$currentIndex . '&' . $this->identifier . '=' . $parent_id . '&conf=3&token=' . $this->token;\n                }\n                // Default behavior (save and back)\n                if (empty($this->redirect_after) && $this->redirect_after !== false) {\n                    $this->redirect_after = self::$currentIndex . ($parent_id ? '&' . $this->identifier . '=' . $this->object->id : '') . '&conf=3&token=' . $this->token;\n                }\n            }\n        }\n\n        $this->errors = array_unique($this->errors);\n        if (!empty($this->errors)) {\n            // if we have errors, we stay on the form instead of going back to the list\n            $this->display = 'edit';\n\n            return false;\n        }\n\n        return $this->object;\n    }\n\n    /**\n     * Object update.\n     *\n     * @return ObjectModel|false|void\n     *\n     * @throws PrestaShopException\n     */\n    public function processUpdate()\n    {\n        /* Checking fields validity */\n        $this->validateRules();\n        if (empty($this->errors)) {\n            $id = (int) Tools::getValue($this->identifier);\n\n            /* Object update */\n            if (isset($id) && !empty($id)) {\n                /** @var ObjectModel $object */\n                $object = new $this->className($id);\n                if (Validate::isLoadedObject($object)) {\n                    /* Specific to objects which must not be deleted */\n                    if ($this->deleted && $this->beforeDelete($object)) {\n                        // Create new one with old objet values\n                        /** @var ObjectModel $object_new */\n                        $object_new = $object->duplicateObject();\n                        if (Validate::isLoadedObject($object_new)) {\n                            // Update old object to deleted\n                            $object->deleted = 1;\n                            $object->update();\n\n                            // Update new object with post values\n                            $this->copyFromPost($object_new, $this->table);\n                            $result = $object_new->update();\n                            if (Validate::isLoadedObject($object_new)) {\n                                $this->afterDelete($object_new, $object->id);\n                            }\n                        }\n                    } else {\n                        $this->copyFromPost($object, $this->table);\n                        $result = $object->update();\n                        $this->afterUpdate($object);\n                    }\n\n                    if ($object->id) {\n                        $this->updateAssoShop($object->id);\n                    }\n\n                    if (!$result) {\n                        $this->errors[] = $this->trans('An error occurred while updating an object.', [], 'Admin.Notifications.Error') .\n                            ' <b>' . $this->table . '</b> (' . Db::getInstance()->getMsgError() . ')';\n                    } elseif ($this->postImage($object->id) && !count($this->errors) && $this->_redirect) {\n                        $parent_id = (int) Tools::getValue('id_parent', 1);\n                        // Specific back redirect\n                        if ($back = Tools::getValue('back')) {\n                            $this->redirect_after = urldecode($back) . '&conf=4';\n                        }\n                        // Save and stay on same form\n                        // @todo on the to following if, we may prefer to avoid override redirect_after previous value\n                        if (Tools::isSubmit('submitAdd' . $this->table . 'AndStay')) {\n                            $this->redirect_after = self::$currentIndex . '&' . $this->identifier . '=' . $object->id . '&conf=4&update' . $this->table . '&token=' . $this->token;\n                        }\n                        // Save and back to parent\n                        if (Tools::isSubmit('submitAdd' . $this->table . 'AndBackToParent')) {\n                            $this->redirect_after = self::$currentIndex . '&' . $this->identifier . '=' . $parent_id . '&conf=4&token=' . $this->token;\n                        }\n\n                        // Default behavior (save and back)\n                        if (empty($this->redirect_after) && $this->redirect_after !== false) {\n                            $this->redirect_after = self::$currentIndex . ($parent_id ? '&' . $this->identifier . '=' . $object->id : '') . '&conf=4&token=' . $this->token;\n                        }\n                    }\n                    PrestaShopLogger::addLog(\n                        $this->trans('%s modification', [$this->className]),\n                        1,\n                        null,\n                        $this->className,\n                        (int) $object->id,\n                        true,\n                        (int) $this->context->employee->id\n                    );\n                } else {\n                    $this->errors[] = $this->trans('An error occurred while updating an object.', [], 'Admin.Notifications.Error') .\n                        ' <b>' . $this->table . '</b> ' . $this->trans('(cannot load object)', [], 'Admin.Notifications.Error');\n                }\n            }\n        }\n        $this->errors = array_unique($this->errors);\n        if (!empty($this->errors)) {\n            // if we have errors, we stay on the form instead of going back to the list\n            $this->display = 'edit';\n\n            return false;\n        }\n\n        if (isset($object)) {\n            return $object;\n        }\n    }\n\n    /**\n     * Change object required fields.\n     *\n     * @return ObjectModel\n     */\n    public function processUpdateFields()\n    {\n        if (!is_array($fields = Tools::getValue('fieldsBox'))) {\n            $fields = [];\n        }\n\n        /** @var $object ObjectModel */\n        $object = new $this->className();\n\n        if (!$object->addFieldsRequiredDatabase($fields)) {\n            $this->errors[] = $this->trans('An error occurred when attempting to update the required fields.', [], 'Admin.Notifications.Error');\n        } else {\n            $this->redirect_after = self::$currentIndex . '&conf=4&token=' . $this->token;\n        }\n\n        return $object;\n    }\n\n    /**\n     * Change object status (active, inactive).\n     *\n     * @return ObjectModel|false\n     *\n     * @throws PrestaShopException\n     */\n    public function processStatus()\n    {\n        if (Validate::isLoadedObject($object = $this->loadObject())) {\n            if ($object->toggleStatus()) {\n                $matches = [];\n                if (preg_match('/[\\?|&]controller=([^&]*)/', (string) $_SERVER['HTTP_REFERER'], $matches) !== false\n                    && strtolower($matches[1]) != strtolower(preg_replace('/controller/i', '', get_class($this)))) {\n                    $this->redirect_after = preg_replace('/[\\?|&]conf=([^&]*)/i', '', (string) $_SERVER['HTTP_REFERER']);\n                } else {\n                    $this->redirect_after = self::$currentIndex . '&token=' . $this->token;\n                }\n\n                $id_category = (($id_category = (int) Tools::getValue('id_category')) && Tools::getValue('id_product')) ? '&id_category=' . $id_category : '';\n\n                $page = (int) Tools::getValue('page');\n                $page = $page > 1 ? '&submitFilter' . $this->table . '=' . (int) $page : '';\n                $this->redirect_after .= '&conf=5' . $id_category . $page;\n            } else {\n                $this->errors[] = $this->trans('An error occurred while updating the status.', [], 'Admin.Notifications.Error');\n            }\n        } else {\n            $this->errors[] = $this->trans('An error occurred while updating the status for an object.', [], 'Admin.Notifications.Error') .\n                ' <b>' . $this->table . '</b> ' .\n                $this->trans('(cannot load object)', [], 'Admin.Notifications.Error');\n        }\n\n        return $object;\n    }\n\n    /**\n     * Change object position.\n     *\n     * @return ObjectModel|false\n     */\n    public function processPosition()\n    {\n        if (!Validate::isLoadedObject($object = $this->loadObject())) {\n            $this->errors[] = $this->trans('An error occurred while updating the status for an object.', [], 'Admin.Notifications.Error') .\n                ' <b>' . $this->table . '</b> ' . $this->trans('(cannot load object)', [], 'Admin.Notifications.Error');\n        } elseif (!$object->updatePosition((int) Tools::getValue('way'), (int) Tools::getValue('position'))) {\n            $this->errors[] = $this->trans('Failed to update the position.', [], 'Admin.Notifications.Error');\n        } else {\n            $id_identifier_str = ($id_identifier = (int) Tools::getValue($this->identifier)) ? '&' . $this->identifier . '=' . $id_identifier : '';\n            $redirect = self::$currentIndex . '&' . $this->table . 'Orderby=position&' . $this->table . 'Orderway=asc&conf=5' . $id_identifier_str . '&token=' . $this->token;\n            $this->redirect_after = $redirect;\n        }\n\n        return $object;\n    }\n\n    /**\n     * Cancel all filters for this tab.\n     *\n     * @param int|null $list_id\n     */\n    public function processResetFilters($list_id = null)\n    {\n        if ($list_id === null) {\n            $list_id = isset($this->list_id) ? $this->list_id : $this->table;\n        }\n\n        $prefix = $this->getCookieOrderByPrefix();\n        $filters = $this->context->cookie->getFamily($prefix . $list_id . 'Filter_');\n        foreach ($filters as $cookie_key => $filter) {\n            if (strncmp($cookie_key, $prefix . $list_id . 'Filter_', 7 + Tools::strlen($prefix . $list_id)) == 0) {\n                $key = substr($cookie_key, 7 + Tools::strlen($prefix . $list_id));\n                if (is_array($this->fields_list) && array_key_exists($key, $this->fields_list)) {\n                    $this->context->cookie->$cookie_key = null;\n                }\n                unset($this->context->cookie->$cookie_key);\n            }\n        }\n\n        if (isset($this->context->cookie->{'submitFilter' . $list_id})) {\n            unset($this->context->cookie->{'submitFilter' . $list_id});\n        }\n        if (isset($this->context->cookie->{$prefix . $list_id . 'Orderby'})) {\n            unset($this->context->cookie->{$prefix . $list_id . 'Orderby'});\n        }\n        if (isset($this->context->cookie->{$prefix . $list_id . 'Orderway'})) {\n            unset($this->context->cookie->{$prefix . $list_id . 'Orderway'});\n        }\n\n        $_POST = [];\n        $this->_filter = false;\n        unset(\n            $this->_filterHaving,\n            $this->_having\n        );\n    }\n\n    /**\n     * Update options and preferences.\n     */\n    protected function processUpdateOptions()\n    {\n        $this->beforeUpdateOptions();\n\n        $languages = Language::getLanguages(false);\n\n        $hide_multishop_checkbox = (Shop::getTotalShops(false, null) < 2) ? true : false;\n        foreach ($this->fields_options as $category_data) {\n            if (!isset($category_data['fields'])) {\n                continue;\n            }\n\n            $fields = $category_data['fields'];\n\n            foreach ($fields as $field => $values) {\n                if (isset($values['type']) && $values['type'] == 'selectLang') {\n                    foreach ($languages as $lang) {\n                        if (Tools::getValue($field . '_' . strtoupper($lang['iso_code']))) {\n                            $fields[$field . '_' . strtoupper($lang['iso_code'])] = [\n                                'type' => 'select',\n                                'cast' => 'strval',\n                                'identifier' => 'mode',\n                                'list' => $values['list'],\n                            ];\n                        }\n                    }\n                }\n            }\n\n            // Validate fields\n            foreach ($fields as $field => $values) {\n                // We don't validate fields with no visibility\n                if (!$hide_multishop_checkbox && Shop::isFeatureActive() && isset($values['visibility']) && $values['visibility'] > Shop::getContext()) {\n                    continue;\n                }\n\n                // Check if field is required\n                if ((!Shop::isFeatureActive() && !empty($values['required']))\n                    || (Shop::isFeatureActive() && isset($_POST['multishopOverrideOption'][$field]) && !empty($values['required']))) {\n                    if (isset($values['type']) && $values['type'] == 'textLang') {\n                        foreach ($languages as $language) {\n                            if (($value = Tools::getValue($field . '_' . $language['id_lang'])) == false && (string) $value != '0') {\n                                $this->errors[] = $this->trans('field %s is required.', [$values['title']], 'Admin.Notifications.Error');\n                            }\n                        }\n                    } elseif (($value = Tools::getValue($field)) == false && (string) $value != '0') {\n                        $this->errors[] = $this->trans('field %s is required.', [$values['title']], 'Admin.Notifications.Error');\n                    }\n                }\n\n                // Check field validator\n                if (isset($values['type']) && $values['type'] == 'textLang') {\n                    foreach ($languages as $language) {\n                        if (Tools::getValue($field . '_' . $language['id_lang']) && isset($values['validation'])) {\n                            $values_validation = $values['validation'];\n                            if (!Validate::$values_validation(Tools::getValue($field . '_' . $language['id_lang']))) {\n                                $this->errors[] = $this->trans('The %s field is invalid.', [$values['title']], 'Admin.Notifications.Error');\n                            }\n                        }\n                    }\n                } elseif (Tools::getValue($field) && isset($values['validation'])) {\n                    $values_validation = $values['validation'];\n                    if (!Validate::$values_validation(Tools::getValue($field))) {\n                        $this->errors[] = $this->trans('The %s field is invalid.', [$values['title']], 'Admin.Notifications.Error');\n                    }\n                }\n\n                // Set default value\n                if (Tools::getValue($field) === false && isset($values['default'])) {\n                    $_POST[$field] = $values['default'];\n                }\n            }\n\n            if (!count($this->errors)) {\n                foreach ($fields as $key => $options) {\n                    if (Shop::isFeatureActive() && isset($options['visibility']) && $options['visibility'] > Shop::getContext()) {\n                        continue;\n                    }\n\n                    if (!$hide_multishop_checkbox && Shop::isFeatureActive() && Shop::getContext() != Shop::CONTEXT_ALL && empty($options['no_multishop_checkbox']) && empty($_POST['multishopOverrideOption'][$key])) {\n                        Configuration::deleteFromContext($key);\n\n                        continue;\n                    }\n\n                    // check if a method updateOptionFieldName is available\n                    $method_name = 'updateOption' . Tools::toCamelCase($key, true);\n                    if (method_exists($this, $method_name)) {\n                        $this->$method_name(Tools::getValue($key));\n                    } elseif (isset($options['type']) && in_array($options['type'], ['textLang', 'textareaLang'])) {\n                        $list = [];\n                        foreach ($languages as $language) {\n                            $key_lang = Tools::getValue($key . '_' . $language['id_lang']);\n                            $val = (isset($options['cast']) ? $options['cast']($key_lang) : $key_lang);\n                            if ($this->validateField($val, $options)) {\n                                if (Validate::isCleanHtml($val)) {\n                                    $list[$language['id_lang']] = $val;\n                                } else {\n                                    $this->errors[] = $this->trans('Cannot add configuration %1$s for %2$s language', [$key, Language::getIsoById((int) $language['id_lang'])], 'Admin.International.Notification');\n                                }\n                            }\n                        }\n                        Configuration::updateValue($key, $list, isset($options['validation']) && $options['validation'] == 'isCleanHtml' ? true : false);\n                    } else {\n                        $val = (isset($options['cast']) ? $options['cast'](Tools::getValue($key)) : Tools::getValue($key));\n                        if ($this->validateField($val, $options)) {\n                            if (Validate::isCleanHtml($val)) {\n                                Configuration::updateValue($key, $val);\n                            } else {\n                                $this->errors[] = $this->trans('Cannot add configuration %s', [$key], 'Admin.Notifications.Error');\n                            }\n                        }\n                    }\n                }\n            }\n        }\n\n        $this->display = 'list';\n        if (empty($this->errors)) {\n            $this->confirmations[] = $this->_conf[6];\n        }\n    }\n\n    public function initPageHeaderToolbar()\n    {\n        if (empty($this->toolbar_title)) {\n            $this->initToolbarTitle();\n        }\n\n        if (!is_array($this->toolbar_title)) {\n            $this->toolbar_title = [$this->toolbar_title];\n        }\n\n        switch ($this->display) {\n            case 'view':\n                // Default cancel button - like old back link\n                $back = Tools::safeOutput(Tools::getValue('back', ''));\n                if (empty($back)) {\n                    $back = self::$currentIndex . '&token=' . $this->token;\n                }\n                if (!Validate::isCleanHtml($back)) {\n                    die(Tools::displayError());\n                }\n                if (!$this->lite_display) {\n                    $this->page_header_toolbar_btn['back'] = [\n                        'href' => $back,\n                        'desc' => $this->trans('Back to list'),\n                    ];\n                }\n                $obj = $this->loadObject(true);\n                if (Validate::isLoadedObject($obj) && isset($obj->{$this->identifier_name}) && !empty($obj->{$this->identifier_name})) {\n                    array_pop($this->toolbar_title);\n                    array_pop($this->meta_title);\n                    $this->toolbar_title[] = is_array($obj->{$this->identifier_name}) ? $obj->{$this->identifier_name}[$this->context->employee->id_lang] : $obj->{$this->identifier_name};\n                    $this->addMetaTitle($this->toolbar_title[count($this->toolbar_title) - 1]);\n                }\n\n                break;\n            case 'edit':\n                $obj = $this->loadObject(true);\n                if (Validate::isLoadedObject($obj) && isset($obj->{$this->identifier_name}) && !empty($obj->{$this->identifier_name})) {\n                    array_pop($this->toolbar_title);\n                    array_pop($this->meta_title);\n                    $this->toolbar_title[] = $this->trans(\n                        'Edit: %s',\n                        [\n                            (is_array($obj->{$this->identifier_name})\n                                && isset($obj->{$this->identifier_name}[$this->context->employee->id_lang])\n                            )\n                                ? $obj->{$this->identifier_name}[$this->context->employee->id_lang]\n                                : $obj->{$this->identifier_name},\n                        ]\n                    );\n                    $this->addMetaTitle($this->toolbar_title[count($this->toolbar_title) - 1]);\n                }\n\n                break;\n        }\n\n        if (is_array($this->page_header_toolbar_btn)\n            && $this->page_header_toolbar_btn instanceof Traversable\n            || count($this->toolbar_title)) {\n            $this->show_page_header_toolbar = true;\n        }\n\n        if (empty($this->page_header_toolbar_title)) {\n            $this->page_header_toolbar_title = $this->toolbar_title[count($this->toolbar_title) - 1];\n        }\n\n        $this->addPageHeaderToolBarModulesListButton();\n\n        $this->context->smarty->assign('help_link', 'https://help.prestashop.com/' . Language::getIsoById($this->context->employee->id_lang) . '/doc/'\n            . Tools::getValue('controller') . '?version=' . _PS_VERSION_ . '&country=' . Language::getIsoById($this->context->employee->id_lang));\n    }\n\n    /**\n     * assign default action in toolbar_btn smarty var, if they are not set.\n     * uses override to specifically add, modify or remove items.\n     */\n    public function initToolbar()\n    {\n        switch ($this->display) {\n            case 'add':\n            case 'edit':\n                // Default save button - action dynamically handled in javascript\n                $this->toolbar_btn['save'] = [\n                    'href' => '#',\n                    'desc' => $this->trans('Save'),\n                ];\n                $back = Tools::safeOutput(Tools::getValue('back', ''));\n                if (empty($back)) {\n                    $back = self::$currentIndex . '&token=' . $this->token;\n                }\n                if (!Validate::isCleanHtml($back)) {\n                    die(Tools::displayError());\n                }\n                if (!$this->lite_display) {\n                    $this->toolbar_btn['cancel'] = [\n                        'href' => $back,\n                        'desc' => $this->trans('Cancel'),\n                    ];\n                }\n\n                break;\n            case 'view':\n                // Default cancel button - like old back link\n                $back = Tools::safeOutput(Tools::getValue('back', ''));\n                if (empty($back)) {\n                    $back = self::$currentIndex . '&token=' . $this->token;\n                }\n                if (!Validate::isCleanHtml($back)) {\n                    die(Tools::displayError());\n                }\n                if (!$this->lite_display) {\n                    $this->toolbar_btn['back'] = [\n                        'href' => $back,\n                        'desc' => $this->trans('Back to list'),\n                    ];\n                }\n\n                break;\n            case 'options':\n                $this->toolbar_btn['save'] = [\n                    'href' => '#',\n                    'desc' => $this->trans('Save'),\n                ];\n\n                break;\n            default:\n                // list\n                $this->toolbar_btn['new'] = [\n                    'href' => self::$currentIndex . '&add' . $this->table . '&token=' . $this->token,\n                    'desc' => $this->trans('Add new'),\n                ];\n                if ($this->allow_export) {\n                    $this->toolbar_btn['export'] = [\n                        'href' => self::$currentIndex . '&export' . $this->table . '&token=' . $this->token,\n                        'desc' => $this->trans('Export'),\n                    ];\n                }\n        }\n        $this->addToolBarModulesListButton();\n    }\n\n    /**\n     * Load class object using identifier in $_GET (if possible)\n     * otherwise return an empty object, or die.\n     *\n     * @param bool $opt Return an empty object if load fail\n     *\n     * @return ObjectModel|false\n     */\n    protected function loadObject($opt = false)\n    {\n        if (!isset($this->className) || empty($this->className)) {\n            return true;\n        }\n\n        $id = (int) Tools::getValue($this->identifier);\n        if ($id && Validate::isUnsignedId($id)) {\n            if (!$this->object) {\n                $this->object = new $this->className($id);\n            }\n            if (Validate::isLoadedObject($this->object)) {\n                return $this->object;\n            }\n            // throw exception\n            $this->errors[] = $this->trans('The object cannot be loaded (or found)', [], 'Admin.Notifications.Error');\n\n            return false;\n        } elseif ($opt) {\n            if (!$this->object) {\n                $this->object = new $this->className();\n            }\n\n            return $this->object;\n        } else {\n            $this->errors[] = $this->trans('The object cannot be loaded (the identifier is missing or invalid)', [], 'Admin.Notifications.Error');\n\n            return false;\n        }\n    }\n\n    /**\n     * Check if the token is valid, else display a warning page.\n     *\n     * @return bool\n     */\n    public function checkAccess()\n    {\n        if (!$this->checkToken()) {\n            // If this is an XSS attempt, then we should only display a simple, secure page\n            // ${1} in the replacement string of the regexp is required,\n            // because the token may begin with a number and mix up with it (e.g. $17)\n            $url = preg_replace('/([&?]token=)[^&]*(&.*)?$/', '${1}' . $this->token . '$2', $_SERVER['REQUEST_URI']);\n            if (false === strpos($url, '?token=') && false === strpos($url, '&token=')) {\n                $url .= '&token=' . $this->token;\n            }\n            if (strpos($url, '?') === false) {\n                $url = str_replace('&token', '?controller=AdminDashboard&token', $url);\n            }\n\n            $this->context->smarty->assign('url', htmlentities($url));\n\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * @param string $key\n     * @param string $filter\n     *\n     * @return array|false\n     */\n    protected function filterToField($key, $filter)\n    {\n        if (!isset($this->fields_list)) {\n            return false;\n        }\n\n        foreach ($this->fields_list as $field) {\n            if (array_key_exists('filter_key', $field) && $field['filter_key'] == $key) {\n                return $field;\n            }\n        }\n        if (array_key_exists($filter, $this->fields_list)) {\n            return $this->fields_list[$filter];\n        }\n\n        return false;\n    }\n\n    public function displayAjax()\n    {\n        if ($this->json) {\n            $this->context->smarty->assign([\n                'json' => true,\n                'status' => $this->status,\n            ]);\n        }\n        $this->layout = 'layout-ajax.tpl';\n        $this->display_header = false;\n        $this->display_header_javascript = false;\n        $this->display_footer = false;\n\n        return $this->display();\n    }\n\n    protected function redirect()\n    {\n        Tools::redirectAdmin($this->redirect_after);\n    }\n\n    /**\n     * @throws Exception\n     * @throws SmartyException\n     */\n    public function display()\n    {\n        $this->context->smarty->assign([\n            'display_header' => $this->display_header,\n            'display_header_javascript' => $this->display_header_javascript,\n            'display_footer' => $this->display_footer,\n            'js_def' => Media::getJsDef(),\n            'toggle_navigation_url' => $this->context->link->getAdminLink('AdminEmployees', true, [], [\n                'action' => 'toggleMenu',\n            ]),\n        ]);\n\n        // Use page title from meta_title if it has been set else from the breadcrumbs array\n        if (!$this->meta_title) {\n            $this->meta_title = $this->toolbar_title;\n        }\n        if (is_array($this->meta_title)) {\n            $this->meta_title = strip_tags(implode(' ' . Configuration::get('PS_NAVIGATION_PIPE') . ' ', $this->meta_title));\n        }\n        $this->context->smarty->assign('meta_title', $this->meta_title);\n\n        $template_dirs = $this->context->smarty->getTemplateDir();\n\n        // Check if header/footer have been overriden\n        $dir = $this->context->smarty->getTemplateDir(0) . 'controllers' . DIRECTORY_SEPARATOR . trim($this->override_folder, '\\\\/') . DIRECTORY_SEPARATOR;\n        $module_list_dir = $this->context->smarty->getTemplateDir(0) . 'helpers' . DIRECTORY_SEPARATOR . 'modules_list' . DIRECTORY_SEPARATOR;\n\n        $header_tpl = file_exists($dir . 'header.tpl') ? $dir . 'header.tpl' : 'header.tpl';\n        $page_header_toolbar = file_exists($dir . 'page_header_toolbar.tpl') ? $dir . 'page_header_toolbar.tpl' : 'page_header_toolbar.tpl';\n        $footer_tpl = file_exists($dir . 'footer.tpl') ? $dir . 'footer.tpl' : 'footer.tpl';\n        $modal_module_list = file_exists($module_list_dir . 'modal.tpl') ? $module_list_dir . 'modal.tpl' : '';\n        $tpl_action = $this->tpl_folder . $this->display . '.tpl';\n\n        // Check if action template has been overridden\n        foreach ($template_dirs as $template_dir) {\n            if (file_exists($template_dir . DIRECTORY_SEPARATOR . $tpl_action) && $this->display != 'view' && $this->display != 'options') {\n                if (method_exists($this, $this->display . Tools::toCamelCase($this->className))) {\n                    $this->{$this->display . Tools::toCamelCase($this->className)}();\n                }\n                $this->context->smarty->assign('content', $this->context->smarty->fetch($tpl_action));\n\n                break;\n            }\n        }\n\n        if (!$this->ajax) {\n            $template = $this->createTemplate($this->template);\n            $page = $template->fetch();\n        } else {\n            $page = $this->content;\n        }\n\n        if ($conf = Tools::getValue('conf')) {\n            $this->context->smarty->assign('conf', $this->json ? json_encode($this->_conf[(int) $conf]) : $this->_conf[(int) $conf]);\n        }\n\n        if ($error = Tools::getValue('error')) {\n            $this->context->smarty->assign('error', $this->json ? json_encode($this->_error[(int) $error]) : $this->_error[(int) $error]);\n        }\n\n        foreach (['errors', 'warnings', 'informations', 'confirmations'] as $type) {\n            if (!is_array($this->$type)) {\n                $this->$type = (array) $this->$type;\n            }\n            $this->context->smarty->assign($type, $this->json ? json_encode(array_unique($this->$type)) : array_unique($this->$type));\n        }\n\n        if ($this->show_page_header_toolbar && !$this->lite_display) {\n            $this->context->smarty->assign(\n                [\n                    'page_header_toolbar' => $this->context->smarty->fetch($page_header_toolbar),\n                ]\n            );\n            if (!empty($modal_module_list)) {\n                $this->context->smarty->assign(\n                    [\n                        'modal_module_list' => $this->context->smarty->fetch($modal_module_list),\n                    ]\n                );\n            }\n        }\n\n        $this->context->smarty->assign('baseAdminUrl', __PS_BASE_URI__ . basename(_PS_ADMIN_DIR_) . '/');\n\n        $this->context->smarty->assign(\n            [\n                'page' => $this->json ? json_encode($page) : $page,\n                'header' => $this->context->smarty->fetch($header_tpl),\n                'footer' => $this->context->smarty->fetch($footer_tpl),\n            ]\n        );\n\n        $this->smartyOutputContent($this->layout);\n    }\n\n    /**\n     * Add a warning message to display at the top of the page.\n     *\n     * @param string $msg\n     */\n    protected function displayWarning($msg)\n    {\n        $this->warnings[] = $msg;\n    }\n\n    /**\n     * Add a info message to display at the top of the page.\n     *\n     * @param string $msg\n     */\n    protected function displayInformation($msg)\n    {\n        $this->informations[] = $msg;\n    }\n\n    /**\n     * Assign smarty variables for the header.\n     */\n    public function initHeader()\n    {\n        header('Cache-Control: no-store, no-cache');\n\n        // Multishop\n        $is_multishop = Shop::isFeatureActive();\n\n        // Quick access\n        if ((int) $this->context->employee->id) {\n            $quick_access = QuickAccess::getQuickAccessesWithToken($this->context->language->id, (int) $this->context->employee->id);\n        }\n\n        $tabs = $this->getTabs();\n        $currentTabLevel = 0;\n        foreach ($tabs as $tab) {\n            $currentTabLevel = isset($tab['current_level']) ? $tab['current_level'] : $currentTabLevel;\n        }\n\n        if (Validate::isLoadedObject($this->context->employee)) {\n            $accesses = Profile::getProfileAccesses($this->context->employee->id_profile, 'class_name');\n            $helperShop = new HelperShop();\n            /* Hooks are voluntary out the initialize array (need those variables already assigned) */\n            $bo_color = empty($this->context->employee->bo_color) ? '#FFFFFF' : $this->context->employee->bo_color;\n            $this->context->smarty->assign([\n                'help_box' => Configuration::get('PS_HELPBOX'),\n                'round_mode' => Configuration::get('PS_PRICE_ROUND_MODE'),\n                'brightness' => Tools::getBrightness($bo_color) < 128 ? 'white' : '#383838',\n                'bo_width' => (int) $this->context->employee->bo_width,\n                'bo_color' => isset($this->context->employee->bo_color) ? Tools::htmlentitiesUTF8($this->context->employee->bo_color) : null,\n                'show_new_orders' => Configuration::get('PS_SHOW_NEW_ORDERS') && isset($accesses['AdminOrders']) && $accesses['AdminOrders']['view'],\n                'show_new_customers' => Configuration::get('PS_SHOW_NEW_CUSTOMERS') && isset($accesses['AdminCustomers']) && $accesses['AdminCustomers']['view'],\n                'show_new_messages' => Configuration::get('PS_SHOW_NEW_MESSAGES') && isset($accesses['AdminCustomerThreads']) && $accesses['AdminCustomerThreads']['view'],\n                'employee' => $this->context->employee,\n                'search_type' => Tools::getValue('bo_search_type'),\n                'bo_query' => Tools::safeOutput(Tools::stripslashes(Tools::getValue('bo_query'))),\n                'quick_access' => empty($quick_access) ? false : $quick_access,\n                'multi_shop' => Shop::isFeatureActive(),\n                'shop_list' => $helperShop->getRenderedShopList(),\n                'current_shop_name' => $helperShop->getCurrentShopName(),\n                'shop' => $this->context->shop,\n                'shop_group' => new ShopGroup((int) Shop::getContextShopGroupID()),\n                'is_multishop' => $is_multishop,\n                'multishop_context' => $this->multishop_context,\n                'default_tab_link' => $this->context->link->getAdminLink(Tab::getClassNameById((int) Context::getContext()->employee->default_tab)),\n                'login_link' => $this->context->link->getAdminLink('AdminLogin'),\n                'logout_link' => $this->context->link->getAdminLink('AdminLogin', true, [], ['logout' => 1]),\n                'collapse_menu' => isset($this->context->cookie->collapse_menu) ? (int) $this->context->cookie->collapse_menu : 0,\n            ]);\n        } else {\n            $this->context->smarty->assign('default_tab_link', $this->context->link->getAdminLink('AdminDashboard'));\n        }\n\n        // Shop::initialize() in config.php may empty $this->context->shop->virtual_uri so using a new shop instance for getBaseUrl()\n        $this->context->shop = new Shop((int) $this->context->shop->id);\n\n        $this->context->smarty->assign([\n            'img_dir' => _PS_IMG_,\n            'iso' => $this->context->language->iso_code,\n            'class_name' => $this->className,\n            'iso_user' => $this->context->language->iso_code,\n            'lang_is_rtl' => $this->context->language->is_rtl,\n            'country_iso_code' => $this->context->country->iso_code,\n            'version' => _PS_VERSION_,\n            'lang_iso' => $this->context->language->iso_code,\n            'full_language_code' => $this->context->language->language_code,\n            'full_cldr_language_code' => $this->context->getCurrentLocale()->getCode(),\n            'link' => $this->context->link,\n            'shop_name' => Configuration::get('PS_SHOP_NAME'),\n            'base_url' => $this->context->shop->getBaseURL(),\n            'current_parent_id' => (int) Tab::getCurrentParentId(),\n            'tabs' => $tabs,\n            'current_tab_level' => $currentTabLevel,\n            'install_dir_exists' => file_exists(_PS_ADMIN_DIR_ . '/../install'),\n            'pic_dir' => _THEME_PROD_PIC_DIR_,\n            'controller_name' => htmlentities(Tools::getValue('controller')),\n            'currentIndex' => self::$currentIndex,\n            'bootstrap' => $this->bootstrap,\n            'default_language' => (int) Configuration::get('PS_LANG_DEFAULT'),\n            'display_addons_connection' => Tab::checkTabRights(Tab::getIdFromClassName('AdminModulesController')),\n        ]);\n    }\n\n    private function getNotificationTip($type)\n    {\n        $tips = [\n            'order' => [\n                $this->trans('Did you check your conversion rate lately?', [], 'Admin.Navigation.Notification'),\n                $this->trans('How about some seasonal discounts?', [], 'Admin.Navigation.Notification'),\n                $this->trans(\n                    'Have you checked your [1][2]abandoned carts[/2][/1]?[3]Your next order could be hiding there!',\n                        [\n                            '[1]' => '<strong>',\n                            '[/1]' => '</strong>',\n                            '[2]' => '<a href=\"' . $this->context->link->getAdminLink('AdminCarts', true, [], ['action' => 'filterOnlyAbandonedCarts']) . '\">',\n                            '[/2]' => '</a>',\n                            '[3]' => '<br>',\n                        ],\n                        'Admin.Navigation.Notification'\n                ),\n            ],\n            'customer' => [\n                $this->trans('Have you sent any acquisition email lately?', [], 'Admin.Navigation.Notification'),\n                $this->trans('Are you active on social media these days?', [], 'Admin.Navigation.Notification'),\n                $this->trans('Have you considered selling on marketplaces?', [], 'Admin.Navigation.Notification'),\n            ],\n            'customer_message' => [\n                $this->trans('That\\'s more time for something else!', [], 'Admin.Navigation.Notification'),\n                $this->trans('No news is good news, isn\\'t it?', [], 'Admin.Navigation.Notification'),\n                $this->trans('Seems like all your customers are happy :)', [], 'Admin.Navigation.Notification'),\n            ],\n        ];\n\n        if (!isset($tips[$type])) {\n            return '';\n        }\n\n        return $tips[$type][array_rand($tips[$type])];\n    }\n\n    private function getTabs($parentId = 0, $level = 0)\n    {\n        $tabs = Tab::getTabs($this->context->language->id, $parentId);\n        $current_id = Tab::getCurrentParentId($this->controller_name ? $this->controller_name : '');\n\n        foreach ($tabs as $index => $tab) {\n            if (!Tab::checkTabRights($tab['id_tab'])\n                || !$tab['enabled']\n                || ($tab['class_name'] == 'AdminStock' && Configuration::get('PS_ADVANCED_STOCK_MANAGEMENT') == 0)\n                || $tab['class_name'] == 'AdminCarrierWizard') {\n                unset($tabs[$index]);\n\n                continue;\n            }\n\n            // tab[class_name] does not contains the \"Controller\" suffix\n            if (($tab['class_name'] . 'Controller' == get_class($this)) || ($current_id == $tab['id_tab']) || $tab['class_name'] == $this->controller_name) {\n                $tabs[$index]['current'] = true;\n                $tabs[$index]['current_level'] = $level;\n            } else {\n                $tabs[$index]['current'] = false;\n            }\n            $tabs[$index]['img'] = null;\n            $tabs[$index]['href'] = $this->context->link->getTabLink($tab);\n            $tabs[$index]['sub_tabs'] = array_values($this->getTabs($tab['id_tab'], $level + 1));\n\n            $subTabHref = $this->getTabLinkFromSubTabs($tabs[$index]['sub_tabs']);\n            if (!empty($subTabHref)) {\n                $tabs[$index]['href'] = $subTabHref;\n            } elseif (0 == $tabs[$index]['id_parent'] && '' == $tabs[$index]['icon']) {\n                unset($tabs[$index]);\n            } elseif (empty($tabs[$index]['icon'])) {\n                $tabs[$index]['icon'] = 'extension';\n            }\n\n            if (array_key_exists($index, $tabs) && array_key_exists('sub_tabs', $tabs[$index])) {\n                foreach ($tabs[$index]['sub_tabs'] as $sub_tab) {\n                    if ((int) $sub_tab['current'] == true) {\n                        $tabs[$index]['current'] = true;\n                        $tabs[$index]['current_level'] = $sub_tab['current_level'];\n                    }\n                }\n            }\n        }\n\n        return $tabs;\n    }\n\n    /**\n     * Declare an action to use for each row in the list.\n     *\n     * @param string $action\n     */\n    public function addRowAction($action)\n    {\n        $action = strtolower($action);\n        $this->actions[] = $action;\n    }\n\n    /**\n     * Add an action to use for each row in the list.\n     *\n     * @param string $action\n     * @param array $list\n     */\n    public function addRowActionSkipList($action, $list)\n    {\n        $action = strtolower($action);\n        $list = (array) $list;\n\n        if (array_key_exists($action, $this->list_skip_actions)) {\n            $this->list_skip_actions[$action] = array_merge($this->list_skip_actions[$action], $list);\n        } else {\n            $this->list_skip_actions[$action] = $list;\n        }\n    }\n\n    /**\n     * Assign smarty variables for all default views, list and form, then call other init functions.\n     */\n    public function initContent()\n    {\n        if (!$this->viewAccess()) {\n            $this->errors[] = $this->trans('You do not have permission to view this.', [], 'Admin.Notifications.Error');\n\n            return;\n        }\n\n        if ($this->display == 'edit' || $this->display == 'add') {\n            if (!$this->loadObject(true)) {\n                return;\n            }\n\n            $this->content .= $this->renderForm();\n        } elseif ($this->display == 'view') {\n            // Some controllers use the view action without an object\n            if ($this->className) {\n                $this->loadObject(true);\n            }\n            $this->content .= $this->renderView();\n        } elseif ($this->display == 'details') {\n            $this->content .= $this->renderDetails();\n        } elseif (!$this->ajax) {\n            // FIXME: Sorry. I'm not very proud of this, but no choice... Please wait sf refactoring to solve this.\n            if (get_class($this) != 'AdminCarriersController') {\n                $this->content .= $this->renderModulesList();\n            }\n            $this->content .= $this->renderKpis();\n            $this->content .= $this->renderList();\n            $this->content .= $this->renderOptions();\n\n            // if we have to display the required fields form\n            if ($this->required_database) {\n                $this->content .= $this->displayRequiredFields();\n            }\n        }\n\n        $this->context->smarty->assign([\n            'content' => $this->content,\n        ]);\n    }\n\n    public function initToolbarFlags()\n    {\n        $this->getLanguages();\n\n        $this->initToolbar();\n        $this->initTabModuleList();\n        $this->initPageHeaderToolbar();\n\n        $this->context->smarty->assign([\n            'maintenance_mode' => !(bool) Configuration::get('PS_SHOP_ENABLE'),\n            'debug_mode' => (bool) _PS_MODE_DEV_,\n            'lite_display' => $this->lite_display,\n            'url_post' => self::$currentIndex . '&token=' . $this->token,\n            'show_page_header_toolbar' => $this->show_page_header_toolbar,\n            'page_header_toolbar_title' => $this->page_header_toolbar_title,\n            'title' => $this->page_header_toolbar_title,\n            'toolbar_btn' => $this->page_header_toolbar_btn,\n            'page_header_toolbar_btn' => $this->page_header_toolbar_btn,\n        ]);\n    }\n\n    /**\n     * Init tab modules list and add button in toolbar.\n     */\n    protected function initTabModuleList()\n    {\n        if (!$this->isFresh(Module::CACHE_FILE_MUST_HAVE_MODULES_LIST, 86400)) {\n            @file_put_contents(_PS_ROOT_DIR_ . Module::CACHE_FILE_MUST_HAVE_MODULES_LIST, Tools::addonsRequest('must-have'));\n        }\n        if (!$this->isFresh(Module::CACHE_FILE_TAB_MODULES_LIST, 604800)) {\n            $this->refresh(Module::CACHE_FILE_TAB_MODULES_LIST, _PS_TAB_MODULE_LIST_URL_);\n        }\n\n        $this->tab_modules_list = Tab::getTabModulesList($this->id);\n\n        if (is_array($this->tab_modules_list['default_list']) && count($this->tab_modules_list['default_list'])) {\n            $this->filter_modules_list = $this->tab_modules_list['default_list'];\n        } elseif (is_array($this->tab_modules_list['slider_list']) && count($this->tab_modules_list['slider_list'])) {\n            $this->addToolBarModulesListButton();\n            $this->addPageHeaderToolBarModulesListButton();\n            $this->context->smarty->assign([\n                'tab_modules_list' => implode(',', $this->tab_modules_list['slider_list']),\n                'admin_module_ajax_url' => $this->context->link->getAdminLink('AdminModules'),\n                'back_tab_modules_list' => $this->context->link->getAdminLink(Tools::getValue('controller')),\n                'tab_modules_open' => (int) Tools::getValue('tab_modules_open'),\n            ]);\n        }\n    }\n\n    protected function addPageHeaderToolBarModulesListButton()\n    {\n        $this->filterTabModuleList();\n\n        if (is_array($this->tab_modules_list['slider_list']) && count($this->tab_modules_list['slider_list'])) {\n            $this->page_header_toolbar_btn['modules-list'] = [\n                'href' => $this->getAdminModulesUrl(),\n                'desc' => $this->trans('Recommended Modules'),\n            ];\n        }\n    }\n\n    protected function addToolBarModulesListButton()\n    {\n        $this->filterTabModuleList();\n\n        if (is_array($this->tab_modules_list['slider_list']) && count($this->tab_modules_list['slider_list'])) {\n            $this->toolbar_btn['modules-list'] = [\n                'href' => $this->getAdminModulesUrl(),\n                'desc' => $this->trans('Recommended Modules'),\n            ];\n        }\n    }\n\n    protected function getAdminModulesUrl()\n    {\n        return $this->context->link->getAdminLink('AdminModulesCatalog');\n    }\n\n    protected function filterTabModuleList()\n    {\n        static $list_is_filtered = null;\n\n        if ($list_is_filtered !== null) {\n            return;\n        }\n\n        if (!$this->isFresh(Module::CACHE_FILE_DEFAULT_COUNTRY_MODULES_LIST, 86400)) {\n            file_put_contents(_PS_ROOT_DIR_ . Module::CACHE_FILE_DEFAULT_COUNTRY_MODULES_LIST, Tools::addonsRequest('native'));\n        }\n\n        if (!$this->isFresh(Module::CACHE_FILE_ALL_COUNTRY_MODULES_LIST, 86400)) {\n            file_put_contents(_PS_ROOT_DIR_ . Module::CACHE_FILE_ALL_COUNTRY_MODULES_LIST, Tools::addonsRequest('native_all'));\n        }\n\n        if (!$this->isFresh(Module::CACHE_FILE_MUST_HAVE_MODULES_LIST, 86400)) {\n            @file_put_contents(_PS_ROOT_DIR_ . Module::CACHE_FILE_MUST_HAVE_MODULES_LIST, Tools::addonsRequest('must-have'));\n        }\n\n        libxml_use_internal_errors(true);\n\n        $country_module_list = file_get_contents(_PS_ROOT_DIR_ . Module::CACHE_FILE_DEFAULT_COUNTRY_MODULES_LIST);\n        $must_have_module_list = file_get_contents(_PS_ROOT_DIR_ . Module::CACHE_FILE_MUST_HAVE_MODULES_LIST);\n        $all_module_list = [];\n\n        if (!empty($country_module_list) && $country_module_list_xml = @simplexml_load_string($country_module_list)) {\n            $country_module_list_array = [];\n            if (is_object($country_module_list_xml->module)) {\n                foreach ($country_module_list_xml->module as $k => $m) {\n                    $all_module_list[] = (string) $m->name;\n                }\n            }\n        } else {\n            foreach (libxml_get_errors() as $error) {\n                $this->errors[] = $this->trans('Error found : %1$s in country_module_list.xml file.', [$error->message], 'Admin.Modules.Notification');\n            }\n        }\n\n        libxml_clear_errors();\n\n        if (!empty($must_have_module_list) && $must_have_module_list_xml = @simplexml_load_string($must_have_module_list)) {\n            $must_have_module_list_array = [];\n            if (is_object($country_module_list_xml->module)) {\n                foreach ($must_have_module_list_xml->module as $l => $mo) {\n                    $all_module_list[] = (string) $mo->name;\n                }\n            }\n        } else {\n            foreach (libxml_get_errors() as $error) {\n                $this->errors[] = $this->trans('Error found : %1$s in must_have_module_list.xml file.', [$error->message], 'Admin.Modules.Notification');\n            }\n        }\n\n        libxml_clear_errors();\n\n        $this->tab_modules_list['slider_list'] = array_intersect($this->tab_modules_list['slider_list'], $all_module_list);\n\n        $list_is_filtered = true;\n    }\n\n    /**\n     * Initialize the invalid doom page of death.\n     */\n    public function initCursedPage()\n    {\n        $this->layout = 'invalid_token.tpl';\n    }\n\n    /**\n     * Assign smarty variables for the footer.\n     */\n    public function initFooter()\n    {\n        //RTL Support\n        //rtl.js overrides inline styles\n        //iso_code.css overrides default fonts for every language (optional)\n        if ($this->context->language->is_rtl) {\n            $this->addJS(_PS_JS_DIR_ . 'rtl.js');\n            $this->addCSS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/css/' . $this->context->language->iso_code . '.css', 'all', false);\n        }\n\n        // We assign js and css files on the last step before display template, because controller can add many js and css files\n        $this->context->smarty->assign('css_files', $this->css_files);\n        $this->context->smarty->assign('js_files', array_unique($this->js_files));\n\n        $this->context->smarty->assign([\n            'ps_version' => _PS_VERSION_,\n            'timer_start' => $this->timer_start,\n            'iso_is_fr' => strtoupper($this->context->language->iso_code) == 'FR',\n            'modals' => $this->renderModal(),\n        ]);\n    }\n\n    /**\n     * @throws Exception\n     * @throws SmartyException\n     */\n    public function initModal()\n    {\n        if ($this->logged_on_addons) {\n            $this->context->smarty->assign([\n                'logged_on_addons' => 1,\n                'username_addons' => $this->context->cookie->username_addons,\n            ]);\n        }\n\n        // Iso needed to generate Addons login\n        $iso_code_caps = strtoupper($this->context->language->iso_code);\n\n        $this->context->smarty->assign([\n            'img_base_path' => __PS_BASE_URI__ . basename(_PS_ADMIN_DIR_) . '/',\n            'check_url_fopen' => (ini_get('allow_url_fopen') ? 'ok' : 'ko'),\n            'check_openssl' => (extension_loaded('openssl') ? 'ok' : 'ko'),\n            'add_permission' => 1,\n            'addons_register_link' => 'https://addons.prestashop.com/' . $this->context->language->iso_code . '/login?'\n                . 'email=' . urlencode($this->context->employee->email)\n                . '&firstname=' . urlencode($this->context->employee->firstname)\n                . '&lastname=' . urlencode($this->context->employee->lastname)\n                . '&website=' . urlencode($this->context->shop->getBaseURL())\n                . '&utm_source=back-office&utm_medium=connect-to-addons'\n                . '&utm_campaign=back-office-' . Tools::strtoupper($this->context->language->iso_code)\n                . '&utm_content=' . (defined('_PS_HOST_MODE_') ? 'cloud' : 'download') . '#createnow',\n            'addons_forgot_password_link' => '//addons.prestashop.com/' . $this->context->language->iso_code . '/forgot-your-password',\n        ]);\n\n        $this->modals[] = [\n            'modal_id' => 'modal_addons_connect',\n            'modal_class' => 'modal-md',\n            'modal_title' => '<i class=\"icon-puzzle-piece\"></i> <a target=\"_blank\" href=\"https://addons.prestashop.com/'\n            . '?utm_source=back-office&utm_medium=modules'\n            . '&utm_campaign=back-office-' . Tools::strtoupper($this->context->language->iso_code)\n            . '&utm_content=' . (defined('_PS_HOST_MODE_') ? 'cloud' : 'download') . '\">PrestaShop Addons</a>',\n            'modal_content' => $this->context->smarty->fetch('controllers/modules/login_addons.tpl'),\n        ];\n    }\n\n    /**\n     * @return string\n     *\n     * @throws Exception\n     * @throws SmartyException\n     */\n    public function renderModal()\n    {\n        $modal_render = '';\n        if (is_array($this->modals) && count($this->modals)) {\n            foreach ($this->modals as $modal) {\n                $this->context->smarty->assign($modal);\n                $modal_render .= $this->context->smarty->fetch('modal.tpl');\n            }\n        }\n\n        return $modal_render;\n    }\n\n    /**\n     * Was used to display a list of recommended modules.\n     *\n     * @param string|bool $tracking_source Source information for URL used by \"Install\" button\n     *\n     * @return string Empty\n     *\n     * @deprecated since 1.7.4.0\n     */\n    public function renderModulesList($tracking_source = false)\n    {\n        return '';\n    }\n\n    /**\n     * Function used to render the list to display for this controller.\n     *\n     * @return string|false\n     *\n     * @throws PrestaShopException\n     */\n    public function renderList()\n    {\n        if (!($this->fields_list && is_array($this->fields_list))) {\n            return false;\n        }\n        $this->getList($this->context->language->id);\n\n        // If list has 'active' field, we automatically create bulk action\n        if (isset($this->fields_list) && is_array($this->fields_list) && array_key_exists('active', $this->fields_list)\n            && !empty($this->fields_list['active'])) {\n            if (!is_array($this->bulk_actions)) {\n                $this->bulk_actions = [];\n            }\n\n            $this->bulk_actions = array_merge([\n                'enableSelection' => [\n                    'text' => $this->trans('Enable selection'),\n                    'icon' => 'icon-power-off text-success',\n                ],\n                'disableSelection' => [\n                    'text' => $this->trans('Disable selection'),\n                    'icon' => 'icon-power-off text-danger',\n                ],\n                'divider' => [\n                    'text' => 'divider',\n                ],\n            ], $this->bulk_actions);\n        }\n\n        $helper = new HelperList();\n\n        // Empty list is ok\n        if (!is_array($this->_list)) {\n            $this->displayWarning($this->trans('Bad SQL query') . '<br />' . htmlspecialchars($this->_list_error));\n\n            return false;\n        }\n\n        $this->setHelperDisplay($helper);\n        $helper->_default_pagination = $this->_default_pagination;\n        $helper->_pagination = $this->_pagination;\n        $helper->tpl_vars = $this->getTemplateListVars();\n        $helper->tpl_delete_link_vars = $this->tpl_delete_link_vars;\n\n        // For compatibility reasons, we have to check standard actions in class attributes\n        foreach ($this->actions_available as $action) {\n            if (!in_array($action, $this->actions) && isset($this->$action) && $this->$action) {\n                $this->actions[] = $action;\n            }\n        }\n\n        $helper->is_cms = $this->is_cms;\n        $helper->sql = $this->_listsql;\n        $list = $helper->generateList($this->_list, $this->fields_list);\n\n        return $list;\n    }\n\n    public function getTemplateListVars()\n    {\n        return $this->tpl_list_vars;\n    }\n\n    /**\n     * Override to render the view page.\n     *\n     * @return string\n     */\n    public function renderView()\n    {\n        $helper = new HelperView($this);\n        $this->setHelperDisplay($helper);\n        $helper->tpl_vars = $this->getTemplateViewVars();\n        if (null !== $this->base_tpl_view) {\n            $helper->base_tpl = $this->base_tpl_view;\n        }\n        $view = $helper->generateView();\n\n        return $view;\n    }\n\n    public function getTemplateViewVars()\n    {\n        return $this->tpl_view_vars;\n    }\n\n    /**\n     * Override to render the view page.\n     *\n     * @return string|false\n     */\n    public function renderDetails()\n    {\n        return $this->renderList();\n    }\n\n    /**\n     * Function used to render the form for this controller.\n     *\n     * @return string\n     *\n     * @throws Exception\n     * @throws SmartyException\n     */\n    public function renderForm()\n    {\n        if (!$this->default_form_language) {\n            $this->getLanguages();\n        }\n\n        if (Tools::getValue('submitFormAjax')) {\n            $this->content .= $this->context->smarty->fetch('form_submit_ajax.tpl');\n        }\n\n        if ($this->fields_form && is_array($this->fields_form)) {\n            if (!$this->multiple_fieldsets) {\n                $this->fields_form = [['form' => $this->fields_form]];\n            }\n\n            // For add a fields via an override of $fields_form, use $fields_form_override\n            if (is_array($this->fields_form_override) && !empty($this->fields_form_override)) {\n                $this->fields_form[0]['form']['input'] = array_merge($this->fields_form[0]['form']['input'], $this->fields_form_override);\n            }\n\n            $fields_value = $this->getFieldsValue($this->object);\n\n            Hook::exec('action' . $this->controller_name . 'FormModifier', [\n                'object' => &$this->object,\n                'fields' => &$this->fields_form,\n                'fields_value' => &$fields_value,\n                'form_vars' => &$this->tpl_form_vars,\n            ]);\n\n            $helper = new HelperForm($this);\n            $this->setHelperDisplay($helper);\n            $helper->fields_value = $fields_value;\n            $helper->submit_action = $this->submit_action;\n            $helper->tpl_vars = $this->getTemplateFormVars();\n            $helper->show_cancel_button = (isset($this->show_form_cancel_button)) ? $this->show_form_cancel_button : ($this->display == 'add' || $this->display == 'edit');\n\n            $back = urldecode(Tools::getValue('back', ''));\n            if (empty($back)) {\n                $back = self::$currentIndex . '&token=' . $this->token;\n            }\n            if (!Validate::isCleanHtml($back)) {\n                die(Tools::displayError());\n            }\n\n            $helper->back_url = $back;\n            null !== $this->base_tpl_form ? $helper->base_tpl = $this->base_tpl_form : '';\n            if ($this->access('view')) {\n                if (Tools::getValue('back')) {\n                    $helper->tpl_vars['back'] = Tools::safeOutput(Tools::getValue('back'));\n                } else {\n                    $helper->tpl_vars['back'] = Tools::safeOutput(Tools::getValue(self::$currentIndex . '&token=' . $this->token));\n                }\n            }\n            $form = $helper->generateForm($this->fields_form);\n\n            return $form;\n        }\n    }\n\n    public function getTemplateFormVars()\n    {\n        return $this->tpl_form_vars;\n    }\n\n    public function renderKpis()\n    {\n    }\n\n    /**\n     * Function used to render the options for this controller.\n     *\n     * @return string\n     */\n    public function renderOptions()\n    {\n        Hook::exec('action' . $this->controller_name . 'OptionsModifier', [\n            'options' => &$this->fields_options,\n            'option_vars' => &$this->tpl_option_vars,\n        ]);\n\n        if ($this->fields_options && is_array($this->fields_options)) {\n            if (isset($this->display) && $this->display != 'options' && $this->display != 'list') {\n                $this->show_toolbar = false;\n            } else {\n                $this->display = 'options';\n            }\n\n            unset($this->toolbar_btn);\n            $this->initToolbar();\n            $helper = new HelperOptions($this);\n            $this->setHelperDisplay($helper);\n            $helper->id = $this->id;\n            $helper->tpl_vars = $this->tpl_option_vars;\n            $options = $helper->generateOptions($this->fields_options);\n\n            return $options;\n        }\n    }\n\n    /**\n     * This function sets various display options for helper list.\n     *\n     * @param Helper $helper\n     */\n    public function setHelperDisplay(Helper $helper)\n    {\n        if (empty($this->toolbar_title)) {\n            $this->initToolbarTitle();\n        }\n        // tocheck\n        if ($this->object && $this->object->id) {\n            $helper->id = $this->object->id;\n        }\n\n        // @todo : move that in Helper\n        $helper->title = is_array($this->toolbar_title) ? implode(' ' . Configuration::get('PS_NAVIGATION_PIPE') . ' ', $this->toolbar_title) : $this->toolbar_title;\n        $helper->toolbar_btn = $this->toolbar_btn;\n        $helper->show_toolbar = $this->show_toolbar;\n        $helper->toolbar_scroll = $this->toolbar_scroll;\n        $helper->override_folder = $this->tpl_folder;\n        $helper->actions = $this->actions;\n        $helper->simple_header = $this->list_simple_header;\n        $helper->bulk_actions = $this->bulk_actions;\n        $helper->currentIndex = self::$currentIndex;\n        $helper->className = $this->className;\n        $helper->table = $this->table;\n        $helper->name_controller = Tools::getValue('controller');\n        $helper->orderBy = $this->_orderBy;\n        $helper->orderWay = $this->_orderWay;\n        $helper->listTotal = $this->_listTotal;\n        $helper->shopLink = $this->shopLink;\n        $helper->shopLinkType = $this->shopLinkType;\n        $helper->identifier = $this->identifier;\n        $helper->token = $this->token;\n        $helper->languages = $this->_languages;\n        $helper->specificConfirmDelete = $this->specificConfirmDelete;\n        $helper->imageType = $this->imageType;\n        $helper->no_link = $this->list_no_link;\n        $helper->colorOnBackground = $this->colorOnBackground;\n        $helper->ajax_params = (isset($this->ajax_params) ? $this->ajax_params : null);\n        $helper->default_form_language = $this->default_form_language;\n        $helper->allow_employee_form_lang = $this->allow_employee_form_lang;\n        $helper->multiple_fieldsets = $this->multiple_fieldsets;\n        $helper->row_hover = $this->row_hover;\n        $helper->position_identifier = $this->position_identifier;\n        $helper->position_group_identifier = $this->position_group_identifier;\n        $helper->controller_name = $this->controller_name;\n        $helper->list_id = isset($this->list_id) ? $this->list_id : $this->table;\n        $helper->bootstrap = $this->bootstrap;\n\n        // For each action, try to add the corresponding skip elements list\n        $helper->list_skip_actions = $this->list_skip_actions;\n\n        $this->helper = $helper;\n    }\n\n    /**\n     * @deprecated 1.6.0\n     */\n    public function setDeprecatedMedia()\n    {\n    }\n\n    public function setMedia($isNewTheme = false)\n    {\n        if ($isNewTheme) {\n            $this->addCSS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/new-theme/public/theme.css', 'all', 1);\n            $this->addJS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/new-theme/public/main.bundle.js');\n            $this->addJqueryPlugin(['chosen']);\n        } else {\n            //Bootstrap\n            $this->addCSS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/css/' . $this->bo_css, 'all', 0);\n            $this->addCSS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/css/vendor/titatoggle-min.css', 'all', 0);\n            $this->addCSS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/public/theme.css', 'all', 0);\n\n            // add Jquery 3 and its migration script\n            $this->addJs(_PS_JS_DIR_ . 'jquery/jquery-3.4.1.min.js');\n            $this->addJs(_PS_JS_DIR_ . 'jquery/jquery-migrate-3.1.0.min.js');\n            // implement $.browser object and live method, that has been removed since jquery 1.9\n            $this->addJs(_PS_JS_DIR_ . 'jquery/jquery.browser-0.1.0.min.js');\n            $this->addJs(_PS_JS_DIR_ . 'jquery/jquery.live-polyfill-1.0.3.min.js');\n\n            $this->addJqueryPlugin(['scrollTo', 'alerts', 'chosen', 'autosize', 'fancybox']);\n            $this->addJqueryPlugin('growl', null, false);\n            $this->addJqueryUI(['ui.slider', 'ui.datepicker']);\n\n            $this->addJS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/js/vendor/bootstrap.min.js');\n            $this->addJS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/js/vendor/modernizr.min.js');\n            $this->addJS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/js/modernizr-loads.js');\n            $this->addJS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/js/vendor/moment-with-langs.min.js');\n            $this->addJS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/public/bundle.js');\n\n            $this->addJS(_PS_JS_DIR_ . 'jquery/plugins/timepicker/jquery-ui-timepicker-addon.js');\n\n            if (!$this->lite_display) {\n                $this->addJS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/js/help.js');\n            }\n\n            if (!Tools::getValue('submitFormAjax')) {\n                $this->addJS(_PS_JS_DIR_ . 'admin/notifications.js');\n            }\n\n            if (defined('_PS_HOST_MODE_') && _PS_HOST_MODE_) {\n                $this->addJS('https://cdn.statuspage.io/se-v2.js');\n\n                Media::addJsDefL('status_operational', $this->trans('Operational'));\n                Media::addJsDefL('status_degraded_performance', $this->trans('Degraded Performance'));\n                Media::addJsDefL('status_partial_outage', $this->trans('Partial Outage'));\n                Media::addJsDefL('status_major_outage', $this->trans('Major Outage'));\n                Media::addJsDef(['host_cluster' => defined('_PS_HOST_CLUSTER_') ? _PS_HOST_CLUSTER_ : 'fr1']);\n            }\n\n            // Specific Admin Theme\n            $this->addCSS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/css/overrides.css', 'all', PHP_INT_MAX);\n        }\n\n        $this->addJS([\n            _PS_JS_DIR_ . 'admin.js?v=' . _PS_VERSION_, // TODO: SEE IF REMOVABLE\n            __PS_BASE_URI__ . $this->admin_webpath . '/themes/new-theme/public/cldr.bundle.js',\n            _PS_JS_DIR_ . 'tools.js?v=' . _PS_VERSION_,\n            __PS_BASE_URI__ . $this->admin_webpath . '/public/bundle.js',\n        ]);\n\n        Media::addJsDef([\n            'changeFormLanguageUrl' => $this->context->link->getAdminLink(\n                'AdminEmployees',\n                true,\n                [],\n                ['action' => 'formLanguage']\n            ),\n        ]);\n        Media::addJsDef(['host_mode' => (defined('_PS_HOST_MODE_') && _PS_HOST_MODE_)]);\n        Media::addJsDef(['baseDir' => __PS_BASE_URI__]);\n        Media::addJsDef(['baseAdminDir' => __PS_BASE_URI__ . basename(_PS_ADMIN_DIR_) . '/']);\n        Media::addJsDef(['currency' => [\n            'iso_code' => Context::getContext()->currency->iso_code,\n            'sign' => Context::getContext()->currency->sign,\n            'name' => Context::getContext()->currency->name,\n            'format' => Context::getContext()->currency->format,\n        ]]);\n        Media::addJsDef(\n            [\n                'currency_specifications' => $this->preparePriceSpecifications($this->context),\n                'number_specifications' => $this->prepareNumberSpecifications($this->context),\n            ]\n        );\n\n        // Execute Hook AdminController SetMedia\n        Hook::exec('actionAdminControllerSetMedia');\n    }\n\n    /**\n     * Non-static method which uses AdminController::translate().\n     *\n     * @deprecated use Context::getContext()->getTranslator()->trans($id, $parameters, $domain, $locale); instead\n     *\n     * @param string $string Term or expression in english\n     * @param string|null $class Name of the class\n     * @param bool $addslashes If set to true, the return value will pass through addslashes(). Otherwise, stripslashes().\n     * @param bool $htmlentities If set to true(default), the return value will pass through htmlentities($string, ENT_QUOTES, 'utf-8')\n     *\n     * @return string the translation if available, or the english default text\n     */\n    protected function l($string, $class = null, $addslashes = false, $htmlentities = true)\n    {\n        $translated = $this->translator->trans($string);\n        if ($translated !== $string) {\n            return $translated;\n        }\n\n        if ($class === null || $class == 'AdminTab') {\n            $class = substr(get_class($this), 0, -10);\n        } elseif (strtolower(substr($class, -10)) == 'controller') {\n            /* classname has changed, from AdminXXX to AdminXXXController, so we remove 10 characters and we keep same keys */\n            $class = substr($class, 0, -10);\n        }\n\n        return Translate::getAdminTranslation($string, $class, $addslashes, $htmlentities);\n    }\n\n    /**\n     * Init context and dependencies, handles POST and GET.\n     */\n    public function init()\n    {\n        parent::init();\n\n        if (Tools::getValue('ajax')) {\n            $this->ajax = '1';\n        }\n\n        if (null === $this->context->link) {\n            $protocol_link = (Tools::usingSecureMode() && Configuration::get('PS_SSL_ENABLED')) ? 'https://' : 'http://';\n            $protocol_content = (Tools::usingSecureMode() && Configuration::get('PS_SSL_ENABLED')) ? 'https://' : 'http://';\n            $this->context->link = new Link($protocol_link, $protocol_content);\n        }\n\n        if (isset($_GET['logout'])) {\n            $this->context->employee->logout();\n        }\n        if (isset(Context::getContext()->cookie->last_activity)) {\n            if ($this->context->cookie->last_activity + self::AUTH_COOKIE_LIFETIME < time()) {\n                $this->context->employee->logout();\n            } else {\n                $this->context->cookie->last_activity = time();\n            }\n        }\n\n        if (\n            !$this->isAnonymousAllowed()\n            && (\n                $this->controller_name != 'AdminLogin'\n                && (\n                    !isset($this->context->employee)\n                    || !$this->context->employee->isLoggedBack()\n                )\n            )\n        ) {\n            if (isset($this->context->employee)) {\n                $this->context->employee->logout();\n            }\n            $email = false;\n            if (Tools::getValue('email') && Validate::isEmail(Tools::getValue('email'))) {\n                $email = Tools::getValue('email');\n            }\n            Tools::redirectAdmin($this->context->link->getAdminLink('AdminLogin') . ((!isset($_GET['logout']) && $this->controller_name != 'AdminNotFound' && Tools::getValue('controller')) ? '&redirect=' . $this->controller_name : '') . ($email ? '&email=' . $email : ''));\n        }\n\n        // Set current index\n        $current_index = 'index.php' . (($controller = Tools::getValue('controller')) ? '?controller=' . $controller : '');\n        if ($back = Tools::getValue('back')) {\n            $current_index .= '&back=' . urlencode($back);\n        }\n        self::$currentIndex = $current_index;\n\n        if ((int) Tools::getValue('liteDisplaying')) {\n            $this->display_header = false;\n            $this->display_header_javascript = true;\n            $this->display_footer = false;\n            $this->content_only = false;\n            $this->lite_display = true;\n        }\n\n        if ($this->ajax && method_exists($this, 'ajaxPreprocess')) {\n            $this->ajaxPreProcess();\n        }\n\n        $this->context->smarty->assign([\n            'table' => $this->table,\n            'current' => self::$currentIndex,\n            'token' => $this->token,\n            'host_mode' => defined('_PS_HOST_MODE_') ? 1 : 0,\n            'stock_management' => (int) Configuration::get('PS_STOCK_MANAGEMENT'),\n            'no_order_tip' => $this->getNotificationTip('order'),\n            'no_customer_tip' => $this->getNotificationTip('customer'),\n            'no_customer_message_tip' => $this->getNotificationTip('customer_message'),\n        ]);\n\n        if ($this->display_header) {\n            $this->context->smarty->assign('displayBackOfficeHeader', Hook::exec('displayBackOfficeHeader', []));\n        }\n\n        $this->context->smarty->assign([\n            'displayBackOfficeTop' => Hook::exec('displayBackOfficeTop', []),\n            'submit_form_ajax' => (int) Tools::getValue('submitFormAjax'),\n        ]);\n\n        Employee::setLastConnectionDate($this->context->employee->id);\n\n        $this->initProcess();\n        $this->initBreadcrumbs();\n        $this->initModal();\n        $this->initToolbarFlags();\n        $this->initNotifications();\n    }\n\n    /**\n     * Sets the smarty variables and js defs used to show / hide some notifications.\n     */\n    public function initNotifications()\n    {\n        $notificationsSettings = [\n            'show_new_orders' => Configuration::get('PS_SHOW_NEW_ORDERS'),\n            'show_new_customers' => Configuration::get('PS_SHOW_NEW_CUSTOMERS'),\n            'show_new_messages' => Configuration::get('PS_SHOW_NEW_MESSAGES '),\n        ];\n\n        $this->context->smarty->assign($notificationsSettings);\n\n        Media::addJsDef($notificationsSettings);\n    }\n\n    /**\n     * @throws PrestaShopException\n     */\n    public function initShopContext()\n    {\n        // Do not initialize context when the shop is not installed\n        if (defined('PS_INSTALLATION_IN_PROGRESS')) {\n            return;\n        }\n\n        // Change shop context ?\n        if (Shop::isFeatureActive() && Tools::getValue('setShopContext') !== false) {\n            $this->context->cookie->shopContext = Tools::getValue('setShopContext');\n            $url = parse_url($_SERVER['REQUEST_URI']);\n            $query = (isset($url['query'])) ? $url['query'] : '';\n            parse_str($query, $parse_query);\n            unset($parse_query['setShopContext'], $parse_query['conf']);\n            $http_build_query = http_build_query($parse_query, '', '&');\n            $this->redirect_after = $url['path'] . ($http_build_query ? '?' . $http_build_query : '');\n        } elseif (!Shop::isFeatureActive()) {\n            $this->context->cookie->shopContext = 's-' . (int) Configuration::get('PS_SHOP_DEFAULT');\n        } elseif (Shop::getTotalShops(false, null) < 2 && $this->context->employee->isLoggedBack()) {\n            $this->context->cookie->shopContext = 's-' . (int) $this->context->employee->getDefaultShopID();\n        }\n\n        $shop_id = null;\n        Shop::setContext(Shop::CONTEXT_ALL);\n        if ($this->context->cookie->shopContext && $this->context->employee->isLoggedBack()) {\n            $split = explode('-', $this->context->cookie->shopContext);\n            if (count($split) == 2) {\n                if ($split[0] == 'g') {\n                    if ($this->context->employee->hasAuthOnShopGroup((int) $split[1])) {\n                        Shop::setContext(Shop::CONTEXT_GROUP, (int) $split[1]);\n                    } else {\n                        $shop_id = (int) $this->context->employee->getDefaultShopID();\n                        Shop::setContext(Shop::CONTEXT_SHOP, $shop_id);\n                    }\n                } elseif (Shop::getShop($split[1]) && $this->context->employee->hasAuthOnShop($split[1])) {\n                    $shop_id = (int) $split[1];\n                    Shop::setContext(Shop::CONTEXT_SHOP, $shop_id);\n                } else {\n                    $shop_id = (int) $this->context->employee->getDefaultShopID();\n                    Shop::setContext(Shop::CONTEXT_SHOP, $shop_id);\n                }\n            }\n        }\n\n        // Check multishop context and set right context if need\n        if (!($this->multishop_context & Shop::getContext())) {\n            if (Shop::getContext() == Shop::CONTEXT_SHOP && !($this->multishop_context & Shop::CONTEXT_SHOP)) {\n                Shop::setContext(Shop::CONTEXT_GROUP, Shop::getContextShopGroupID());\n            }\n            if (Shop::getContext() == Shop::CONTEXT_GROUP && !($this->multishop_context & Shop::CONTEXT_GROUP)) {\n                Shop::setContext(Shop::CONTEXT_ALL);\n            }\n        }\n\n        // Replace existing shop if necessary\n        if (!$shop_id) {\n            $this->context->shop = new Shop((int) Configuration::get('PS_SHOP_DEFAULT'));\n        } elseif ($this->context->shop->id != $shop_id) {\n            $this->context->shop = new Shop((int) $shop_id);\n        }\n\n        // Replace current default country\n        $this->context->country = new Country((int) Configuration::get('PS_COUNTRY_DEFAULT'));\n        $this->context->currency = new Currency(Configuration::get('PS_CURRENCY_DEFAULT'));\n    }\n\n    /**\n     * Retrieve GET and POST value and translate them to actions.\n     */\n    public function initProcess()\n    {\n        if (!isset($this->list_id)) {\n            $this->list_id = $this->table;\n        }\n\n        // Manage list filtering\n        if (Tools::isSubmit('submitFilter' . $this->list_id)\n            || $this->context->cookie->{'submitFilter' . $this->list_id} !== false\n            || Tools::getValue($this->list_id . 'Orderby')\n            || Tools::getValue($this->list_id . 'Orderway')) {\n            $this->filter = true;\n        }\n\n        $this->id_object = (int) Tools::getValue($this->identifier);\n\n        /* Delete object image */\n        if (isset($_GET['deleteImage'])) {\n            if ($this->access('delete')) {\n                $this->action = 'delete_image';\n            } else {\n                $this->errors[] = $this->trans('You do not have permission to delete this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif (isset($_GET['delete' . $this->table])) {\n            /* Delete object */\n            if ($this->access('delete')) {\n                $this->action = 'delete';\n            } else {\n                $this->errors[] = $this->trans('You do not have permission to delete this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif ((isset($_GET['status' . $this->table]) || isset($_GET['status'])) && Tools::getValue($this->identifier)) {\n            /* Change object statuts (active, inactive) */\n            if ($this->access('edit')) {\n                $this->action = 'status';\n            } else {\n                $this->errors[] = $this->trans('You do not have permission to edit this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif (isset($_GET['position'])) {\n            /* Move an object */\n            if ($this->access('edit') == '1') {\n                $this->action = 'position';\n            } else {\n                $this->errors[] = $this->trans('You do not have permission to edit this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif (Tools::isSubmit('submitAdd' . $this->table)\n                 || Tools::isSubmit('submitAdd' . $this->table . 'AndStay')\n                 || Tools::isSubmit('submitAdd' . $this->table . 'AndPreview')\n                 || Tools::isSubmit('submitAdd' . $this->table . 'AndBackToParent')) {\n            // case 1: updating existing entry\n            if ($this->id_object) {\n                if ($this->access('edit')) {\n                    $this->action = 'save';\n                    if (Tools::isSubmit('submitAdd' . $this->table . 'AndStay')) {\n                        $this->display = 'edit';\n                    } else {\n                        $this->display = 'list';\n                    }\n                } else {\n                    $this->errors[] = $this->trans('You do not have permission to edit this.', [], 'Admin.Notifications.Error');\n                }\n            } else {\n                // case 2: creating new entry\n                if ($this->access('add')) {\n                    $this->action = 'save';\n                    if (Tools::isSubmit('submitAdd' . $this->table . 'AndStay')) {\n                        $this->display = 'edit';\n                    } else {\n                        $this->display = 'list';\n                    }\n                } else {\n                    $this->errors[] = $this->trans('You do not have permission to add this.', [], 'Admin.Notifications.Error');\n                }\n            }\n        } elseif (isset($_GET['add' . $this->table])) {\n            if ($this->access('add')) {\n                $this->action = 'new';\n                $this->display = 'add';\n            } else {\n                $this->errors[] = $this->trans('You do not have permission to add this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif (isset($_GET['update' . $this->table], $_GET[$this->identifier])) {\n            $this->display = 'edit';\n            if (!$this->access('edit')) {\n                $this->errors[] = $this->trans('You do not have permission to edit this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif (isset($_GET['view' . $this->table])) {\n            if ($this->access('view')) {\n                $this->display = 'view';\n                $this->action = 'view';\n            } else {\n                $this->errors[] = $this->trans('You do not have permission to view this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif (isset($_GET['details' . $this->table])) {\n            if ($this->access('view')) {\n                $this->display = 'details';\n                $this->action = 'details';\n            } else {\n                $this->errors[] = $this->trans('You do not have permission to view this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif (isset($_GET['export' . $this->table])) {\n            if ($this->access('view')) {\n                $this->action = 'export';\n            }\n        } elseif (isset($_POST['submitReset' . $this->list_id])) {\n            /* Cancel all filters for this tab */\n            $this->action = 'reset_filters';\n        } elseif (Tools::isSubmit('submitOptions' . $this->table) || Tools::isSubmit('submitOptions')) {\n            /* Submit options list */\n            $this->display = 'options';\n            if ($this->access('edit')) {\n                $this->action = 'update_options';\n            } else {\n                $this->errors[] = $this->trans('You do not have permission to edit this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif (Tools::getValue('action') && method_exists($this, 'process' . ucfirst(Tools::toCamelCase(Tools::getValue('action'))))) {\n            $this->action = Tools::getValue('action');\n        } elseif (Tools::isSubmit('submitFields') && $this->required_database && $this->access('add') && $this->access('delete')) {\n            $this->action = 'update_fields';\n        } elseif (is_array($this->bulk_actions)) {\n            $submit_bulk_actions = array_merge([\n                'enableSelection' => [\n                    'text' => $this->trans('Enable selection'),\n                    'icon' => 'icon-power-off text-success',\n                ],\n                'disableSelection' => [\n                    'text' => $this->trans('Disable selection'),\n                    'icon' => 'icon-power-off text-danger',\n                ],\n            ], $this->bulk_actions);\n            foreach ($submit_bulk_actions as $bulk_action => $params) {\n                if (Tools::isSubmit('submitBulk' . $bulk_action . $this->table) || Tools::isSubmit('submitBulk' . $bulk_action)) {\n                    if ($bulk_action === 'delete') {\n                        if ($this->access('delete')) {\n                            $this->action = 'bulk' . $bulk_action;\n                            $this->boxes = Tools::getValue($this->table . 'Box');\n                            if (empty($this->boxes) && $this->table == 'attribute') {\n                                $this->boxes = Tools::getValue($this->table . '_valuesBox');\n                            }\n                        } else {\n                            $this->errors[] = $this->trans('You do not have permission to delete this.', [], 'Admin.Notifications.Error');\n                        }\n\n                        break;\n                    } elseif ($this->access('edit')) {\n                        $this->action = 'bulk' . $bulk_action;\n                        $this->boxes = Tools::getValue($this->table . 'Box');\n                    } else {\n                        $this->errors[] = $this->trans('You do not have permission to edit this.', [], 'Admin.Notifications.Error');\n                    }\n\n                    break;\n                } elseif (Tools::isSubmit('submitBulk')) {\n                    if ($bulk_action === 'delete') {\n                        if ($this->access('delete')) {\n                            $this->action = 'bulk' . $bulk_action;\n                            $this->boxes = Tools::getValue($this->table . 'Box');\n                        } else {\n                            $this->errors[] = $this->trans('You do not have permission to delete this.', [], 'Admin.Notifications.Error');\n                        }\n\n                        break;\n                    } elseif ($this->access('edit')) {\n                        $this->action = 'bulk' . Tools::getValue('select_submitBulk');\n                        $this->boxes = Tools::getValue($this->table . 'Box');\n                    } else {\n                        $this->errors[] = $this->trans('You do not have permission to edit this.', [], 'Admin.Notifications.Error');\n                    }\n\n                    break;\n                }\n            }\n        } elseif (!empty($this->fields_options) && empty($this->fields_list)) {\n            $this->display = 'options';\n        }\n    }\n\n    /**\n     * Get the current objects' list form the database.\n     *\n     * @param int $id_lang Language used for display\n     * @param string|null $order_by ORDER BY clause\n     * @param string|null $order_way Order way (ASC, DESC)\n     * @param int $start Offset in LIMIT clause\n     * @param int|null $limit Row count in LIMIT clause\n     * @param int|bool $id_lang_shop\n     *\n     * @throws PrestaShopDatabaseException\n     * @throws PrestaShopException\n     */\n    public function getList(\n        $id_lang,\n        $order_by = null,\n        $order_way = null,\n        $start = 0,\n        $limit = null,\n        $id_lang_shop = false\n    ) {\n        Hook::exec('action' . $this->controller_name . 'ListingFieldsModifier', [\n            'select' => &$this->_select,\n            'join' => &$this->_join,\n            'where' => &$this->_where,\n            'group_by' => &$this->_group,\n            'order_by' => &$this->_orderBy,\n            'order_way' => &$this->_orderWay,\n            'fields' => &$this->fields_list,\n        ]);\n\n        if (!isset($this->list_id)) {\n            $this->list_id = $this->table;\n        }\n\n        if (!Validate::isTableOrIdentifier($this->table)) {\n            throw new PrestaShopException(sprintf('Table name %s is invalid:', $this->table));\n        }\n\n        /* Check params validity */\n        if (!is_numeric($start) || !Validate::isUnsignedId($id_lang)) {\n            throw new PrestaShopException('get list params is not valid');\n        }\n\n        $limit = $this->checkSqlLimit($limit);\n\n        /* Determine offset from current page */\n        $start = 0;\n        if ((int) Tools::getValue('submitFilter' . $this->list_id)) {\n            $start = ((int) Tools::getValue('submitFilter' . $this->list_id) - 1) * $limit;\n        } elseif (\n            empty($start)\n            && isset($this->context->cookie->{$this->list_id . '_start'})\n            && Tools::isSubmit('export' . $this->table)\n        ) {\n            $start = $this->context->cookie->{$this->list_id . '_start'};\n        }\n\n        // Either save or reset the offset in the cookie\n        if ($start) {\n            $this->context->cookie->{$this->list_id . '_start'} = $start;\n        } elseif (isset($this->context->cookie->{$this->list_id . '_start'})) {\n            unset($this->context->cookie->{$this->list_id . '_start'});\n        }\n\n        /* Cache */\n        $this->_lang = (int) $id_lang;\n\n        // Add SQL shop restriction\n        $select_shop = '';\n        if ($this->shopLinkType) {\n            $select_shop = ', shop.name as shop_name ';\n        }\n\n        if ($this->multishop_context && Shop::isTableAssociated($this->table) && !empty($this->className)) {\n            if (Shop::getContext() != Shop::CONTEXT_ALL || !$this->context->employee->isSuperAdmin()) {\n                $test_join = !preg_match('#`?' . preg_quote(_DB_PREFIX_ . $this->table . '_shop') . '`? *sa#', $this->_join);\n                if (Shop::isFeatureActive() && $test_join && Shop::isTableAssociated($this->table)) {\n                    $this->_where .= ' AND EXISTS (\n                        SELECT 1\n                        FROM `' . _DB_PREFIX_ . $this->table . '_shop` sa\n                        WHERE a.`' . bqSQL($this->identifier) . '` = sa.`' . bqSQL($this->identifier) . '`\n                         AND sa.id_shop IN (' . implode(', ', Shop::getContextListShopID()) . ')\n                    )';\n                }\n            }\n        }\n\n        $fromClause = $this->getFromClause();\n        $joinClause = $this->getJoinClause($id_lang, $id_lang_shop);\n        $whereClause = $this->getWhereClause();\n        $orderByClause = $this->getOrderByClause($order_by, $order_way);\n\n        $shouldLimitSqlResults = $this->shouldLimitSqlResults($limit);\n\n        do {\n            $this->_listsql = '';\n\n            if ($this->explicitSelect) {\n                foreach ($this->fields_list as $key => $array_value) {\n                    // Add it only if it is not already in $this->_select\n                    if (isset($this->_select) && preg_match('/[\\s]`?' . preg_quote($key, '/') . '`?\\s*,/', $this->_select)) {\n                        continue;\n                    }\n\n                    if (isset($array_value['filter_key'])) {\n                        $this->_listsql .= str_replace('!', '.`', $array_value['filter_key']) . '` AS `' . $key . '`, ';\n                    } elseif ($key == 'id_' . $this->table) {\n                        $this->_listsql .= 'a.`' . bqSQL($key) . '`, ';\n                    } elseif ($key != 'image' && !preg_match('/' . preg_quote($key, '/') . '/i', $this->_select)) {\n                        $this->_listsql .= '`' . bqSQL($key) . '`, ';\n                    }\n                }\n                $this->_listsql = rtrim(trim($this->_listsql), ',');\n            } else {\n                $this->_listsql .= ($this->lang ? 'b.*,' : '') . ' a.*';\n            }\n\n            $this->_listsql .= \"\\n\" . (isset($this->_select) ? ', ' . rtrim($this->_select, ', ') : '') . $select_shop;\n\n            $limitClause = ' ' . (($shouldLimitSqlResults) ? ' LIMIT ' . (int) $start . ', ' . (int) $limit : '');\n\n            if ($this->_use_found_rows || isset($this->_filterHaving) || isset($this->_having)) {\n                $this->_listsql = 'SELECT SQL_CALC_FOUND_ROWS ' . ($this->_tmpTableFilter ? ' * FROM (SELECT ' : '') .\n                    $this->_listsql .\n                    $fromClause .\n                    $joinClause .\n                    $whereClause .\n                    $orderByClause .\n                    $limitClause;\n\n                $list_count = 'SELECT FOUND_ROWS() AS `' . _DB_PREFIX_ . $this->table . '`';\n            } else {\n                $this->_listsql = 'SELECT ' . ($this->_tmpTableFilter ? ' * FROM (SELECT ' : '') .\n                    $this->_listsql .\n                    $fromClause .\n                    $joinClause .\n                    $whereClause .\n                    $orderByClause .\n                    $limitClause;\n\n                $list_count = 'SELECT COUNT(*) AS `' . _DB_PREFIX_ . $this->table . '` ' .\n                    $fromClause .\n                    $joinClause .\n                    $whereClause;\n            }\n\n            $this->_list = Db::getInstance()->executeS($this->_listsql, true, false);\n\n            if ($this->_list === false) {\n                $this->_list_error = Db::getInstance()->getMsgError();\n\n                break;\n            }\n\n            $this->_listTotal = Db::getInstance()->getValue($list_count, false);\n\n            if ($shouldLimitSqlResults) {\n                $start = (int) $start - (int) $limit;\n                if ($start < 0) {\n                    break;\n                }\n            } else {\n                break;\n            }\n        } while (empty($this->_list));\n\n        Hook::exec('action' . $this->controller_name . 'ListingResultsModifier', [\n            'list' => &$this->_list,\n            'list_total' => &$this->_listTotal,\n        ]);\n    }\n\n    /**\n     * @return string\n     */\n    protected function getFromClause()\n    {\n        $sql_table = $this->table == 'order' ? 'orders' : $this->table;\n\n        return \"\\n\" . 'FROM `' . _DB_PREFIX_ . $sql_table . '` a ';\n    }\n\n    /**\n     * @param $id_lang\n     * @param $id_lang_shop\n     *\n     * @return string\n     */\n    protected function getJoinClause($id_lang, $id_lang_shop)\n    {\n        $shopJoinClause = '';\n        if ($this->shopLinkType) {\n            $shopJoinClause = ' LEFT JOIN `' . _DB_PREFIX_ . bqSQL($this->shopLinkType) . '` shop\n                            ON a.`id_' . bqSQL($this->shopLinkType) . '` = shop.`id_' . bqSQL($this->shopLinkType) . '`';\n        }\n\n        return \"\\n\" . $this->getLanguageJoinClause($id_lang, $id_lang_shop) .\n            \"\\n\" . (isset($this->_join) ? $this->_join . ' ' : '') .\n            \"\\n\" . $shopJoinClause;\n    }\n\n    /**\n     * @param $idLang\n     * @param $idLangShop\n     *\n     * @return string\n     */\n    protected function getLanguageJoinClause($idLang, $idLangShop)\n    {\n        $languageJoinClause = '';\n        if ($this->lang) {\n            $languageJoinClause = 'LEFT JOIN `' . _DB_PREFIX_ . bqSQL($this->table) . '_lang` b\n                ON (b.`' . bqSQL($this->identifier) . '` = a.`' . bqSQL($this->identifier) . '` AND b.`id_lang` = ' . (int) $idLang;\n\n            if ($idLangShop) {\n                if (!Shop::isFeatureActive()) {\n                    $languageJoinClause .= ' AND b.`id_shop` = ' . (int) Configuration::get('PS_SHOP_DEFAULT');\n                } elseif (Shop::getContext() == Shop::CONTEXT_SHOP) {\n                    $languageJoinClause .= ' AND b.`id_shop` = ' . (int) $idLangShop;\n                } else {\n                    $languageJoinClause .= ' AND b.`id_shop` = a.id_shop_default';\n                }\n            }\n            $languageJoinClause .= ')';\n        }\n\n        return $languageJoinClause;\n    }\n\n    /**\n     * @return string\n     */\n    protected function getWhereClause()\n    {\n        $whereShop = '';\n        if ($this->shopLinkType) {\n            $whereShop = Shop::addSqlRestriction($this->shopShareDatas, 'a', $this->shopLinkType);\n        }\n        $whereClause = ' WHERE 1 ' . (isset($this->_where) ? $this->_where . ' ' : '') .\n            ($this->deleted ? 'AND a.`deleted` = 0 ' : '') .\n            (isset($this->_filter) ? $this->_filter : '') . $whereShop . \"\\n\" .\n            (isset($this->_group) ? $this->_group . ' ' : '') . \"\\n\" .\n            $this->getHavingClause();\n\n        return $whereClause;\n    }\n\n    /**\n     * @param $orderBy\n     * @param $orderDirection\n     *\n     * @return string\n     */\n    protected function getOrderByClause($orderBy, $orderDirection)\n    {\n        $this->_orderBy = $this->checkOrderBy($orderBy);\n        $this->_orderWay = $this->checkOrderDirection($orderDirection);\n\n        return ' ORDER BY ' . ((str_replace('`', '', $this->_orderBy) == $this->identifier) ? 'a.' : '') .\n            $this->_orderBy . ' ' . $this->_orderWay .\n            ($this->_tmpTableFilter ? ') tmpTable WHERE 1' . $this->_tmpTableFilter : '');\n    }\n\n    /**\n     * @param $orderBy\n     *\n     * @return false|string\n     */\n    protected function checkOrderBy($orderBy)\n    {\n        if (empty($orderBy)) {\n            $prefix = $this->getCookieFilterPrefix();\n\n            if ($this->context->cookie->{$prefix . $this->list_id . 'Orderby'}) {\n                $orderBy = $this->context->cookie->{$prefix . $this->list_id . 'Orderby'};\n            } elseif ($this->_orderBy) {\n                $orderBy = $this->_orderBy;\n            } else {\n                $orderBy = $this->_defaultOrderBy;\n            }\n        }\n\n        /* Check params validity */\n        if (!Validate::isOrderBy($orderBy)) {\n            throw new PrestaShopException('Invalid \"order by\" clause.');\n        }\n\n        if (!isset($this->fields_list[$orderBy]['order_key']) && isset($this->fields_list[$orderBy]['filter_key'])) {\n            $this->fields_list[$orderBy]['order_key'] = $this->fields_list[$orderBy]['filter_key'];\n        }\n\n        if (isset($this->fields_list[$orderBy]['order_key'])) {\n            $orderBy = $this->fields_list[$orderBy]['order_key'];\n        }\n\n        if (preg_match('/[.!]/', $orderBy)) {\n            $orderBySplit = preg_split('/[.!]/', $orderBy);\n            $orderBy = bqSQL($orderBySplit[0]) . '.`' . bqSQL($orderBySplit[1]) . '`';\n        } elseif ($orderBy) {\n            $orderBy = bqSQL($orderBy);\n        }\n\n        return $orderBy;\n    }\n\n    /**\n     * @param $orderDirection\n     *\n     * @return string\n     */\n    protected function checkOrderDirection($orderDirection)\n    {\n        $prefix = $this->getCookieOrderByPrefix();\n        if (empty($orderDirection)) {\n            if ($this->context->cookie->{$prefix . $this->list_id . 'Orderway'}) {\n                $orderDirection = $this->context->cookie->{$prefix . $this->list_id . 'Orderway'};\n            } elseif ($this->_orderWay) {\n                $orderDirection = $this->_orderWay;\n            } else {\n                $orderDirection = $this->_defaultOrderWay;\n            }\n        }\n\n        if (!Validate::isOrderWay($orderDirection)) {\n            throw new PrestaShopException('Invalid order direction.');\n        }\n\n        return pSQL(Tools::strtoupper($orderDirection));\n    }\n\n    /**\n     * @return mixed\n     */\n    protected function getCookieOrderByPrefix()\n    {\n        return str_replace(['admin', 'controller'], '', Tools::strtolower(get_class($this)));\n    }\n\n    /**\n     * @return string\n     */\n    protected function getHavingClause()\n    {\n        $havingClause = '';\n        if (isset($this->_filterHaving) || isset($this->_having)) {\n            $havingClause = ' HAVING ';\n            if (isset($this->_filterHaving)) {\n                $havingClause .= ltrim($this->_filterHaving, ' AND ');\n            }\n            if (isset($this->_having)) {\n                $havingClause .= $this->_having . ' ';\n            }\n        }\n\n        return $havingClause;\n    }\n\n    /**\n     * @param $limit\n     *\n     * @return bool\n     */\n    protected function shouldLimitSqlResults($limit)\n    {\n        return $limit !== false;\n    }\n\n    /**\n     * @param $limit\n     *\n     * @return int\n     */\n    protected function checkSqlLimit($limit)\n    {\n        if (empty($limit)) {\n            if (\n                isset($this->context->cookie->{$this->list_id . '_pagination'}) &&\n                $this->context->cookie->{$this->list_id . '_pagination'}\n            ) {\n                $limit = $this->context->cookie->{$this->list_id . '_pagination'};\n            } else {\n                $limit = $this->_default_pagination;\n            }\n        }\n\n        $limit = (int) Tools::getValue($this->list_id . '_pagination', $limit);\n        if (in_array($limit, $this->_pagination) && $limit != $this->_default_pagination) {\n            $this->context->cookie->{$this->list_id . '_pagination'} = $limit;\n        } else {\n            unset($this->context->cookie->{$this->list_id . '_pagination'});\n        }\n\n        if (!is_numeric($limit)) {\n            throw new PrestaShopException('Invalid limit. It should be a numeric.');\n        }\n\n        return $limit;\n    }\n\n    /**\n     * @param array|string $filter_modules_list\n     * @param string|bool $tracking_source\n     *\n     * @return bool\n     *\n     * @throws PrestaShopException\n     */\n    public function getModulesList($filter_modules_list, $tracking_source = false)\n    {\n        if (!is_array($filter_modules_list) && null !== $filter_modules_list) {\n            $filter_modules_list = [$filter_modules_list];\n        }\n\n        if (null === $filter_modules_list || !count($filter_modules_list)) {\n            return false;\n        } //if there is no modules to display just return false;\n\n        $all_modules = Module::getModulesOnDisk(true);\n        $this->modules_list = [];\n        foreach ($all_modules as $module) {\n            $perm = true;\n            if ($module->id) {\n                $perm &= Module::getPermissionStatic($module->id, 'configure');\n            } else {\n                $id_admin_module = Tab::getIdFromClassName('AdminModules');\n                $access = Profile::getProfileAccess($this->context->employee->id_profile, $id_admin_module);\n                if (!$access['edit']) {\n                    $perm &= false;\n                }\n            }\n\n            if (in_array($module->name, $filter_modules_list) && $perm) {\n                $this->fillModuleData($module, 'array', null, $tracking_source);\n                $this->modules_list[array_search($module->name, $filter_modules_list)] = $module;\n            }\n        }\n        ksort($this->modules_list);\n\n        if (count($this->modules_list)) {\n            return true;\n        }\n\n        return false; //no module found on disk just return false;\n    }\n\n    /**\n     * @return array\n     */\n    public function getLanguages()\n    {\n        $cookie = $this->context->cookie;\n        $this->allow_employee_form_lang = (int) Configuration::get('PS_BO_ALLOW_EMPLOYEE_FORM_LANG');\n        if ($this->allow_employee_form_lang && !$cookie->employee_form_lang) {\n            $cookie->employee_form_lang = (int) Configuration::get('PS_LANG_DEFAULT');\n        }\n\n        $lang_exists = false;\n        $this->_languages = Language::getLanguages(false);\n        foreach ($this->_languages as $lang) {\n            if (isset($cookie->employee_form_lang) && $cookie->employee_form_lang == $lang['id_lang']) {\n                $lang_exists = true;\n            }\n        }\n\n        $this->default_form_language = $lang_exists ? (int) $cookie->employee_form_lang : (int) Configuration::get('PS_LANG_DEFAULT');\n\n        foreach ($this->_languages as $k => $language) {\n            $this->_languages[$k]['is_default'] = (int) ($language['id_lang'] == $this->default_form_language);\n        }\n\n        return $this->_languages;\n    }\n\n    /**\n     * Return the list of fields value.\n     *\n     * @param ObjectModel $obj Object\n     *\n     * @return array\n     */\n    public function getFieldsValue($obj)\n    {\n        foreach ($this->fields_form as $fieldset) {\n            if (isset($fieldset['form']['input'])) {\n                foreach ($fieldset['form']['input'] as $input) {\n                    if (!isset($this->fields_value[$input['name']])) {\n                        if (isset($input['type']) && $input['type'] == 'shop') {\n                            if ($obj->id) {\n                                $result = Shop::getShopById((int) $obj->id, $this->identifier, $this->table);\n                                foreach ($result as $row) {\n                                    $this->fields_value['shop'][$row['id_' . $input['type']]][] = $row['id_shop'];\n                                }\n                            }\n                        } elseif (isset($input['lang']) && $input['lang']) {\n                            foreach ($this->_languages as $language) {\n                                $field_value = $this->getFieldValue($obj, $input['name'], $language['id_lang']);\n                                if (empty($field_value)) {\n                                    if (isset($input['default_value']) && is_array($input['default_value']) && isset($input['default_value'][$language['id_lang']])) {\n                                        $field_value = $input['default_value'][$language['id_lang']];\n                                    } elseif (isset($input['default_value'])) {\n                                        $field_value = $input['default_value'];\n                                    }\n                                }\n                                $this->fields_value[$input['name']][$language['id_lang']] = $field_value;\n                            }\n                        } else {\n                            $field_value = $this->getFieldValue($obj, $input['name']);\n                            if ($field_value === false && isset($input['default_value'])) {\n                                $field_value = $input['default_value'];\n                            }\n                            $this->fields_value[$input['name']] = $field_value;\n                        }\n                    }\n                }\n            }\n        }\n\n        return $this->fields_value;\n    }\n\n    /**\n     * Return field value if possible (both classical and multilingual fields).\n     *\n     * Case 1 : Return value if present in $_POST / $_GET\n     * Case 2 : Return object value\n     *\n     * @param ObjectModel $obj Object\n     * @param string $key Field name\n     * @param int|null $id_lang Language id (optional)\n     *\n     * @return string\n     */\n    public function getFieldValue($obj, $key, $id_lang = null)\n    {\n        if ($id_lang) {\n            $default_value = (isset($obj->id) && $obj->id && isset($obj->{$key}[$id_lang])) ? $obj->{$key}[$id_lang] : false;\n        } else {\n            $default_value = isset($obj->{$key}) ? $obj->{$key} : false;\n        }\n\n        return Tools::getValue($key . ($id_lang ? '_' . $id_lang : ''), $default_value);\n    }\n\n    /**\n     * Manage page display (form, list...).\n     *\n     * @param string|bool $class_name Allow to validate a different class than the current one\n     *\n     * @throws PrestaShopException\n     */\n    public function validateRules($class_name = false)\n    {\n        if (!$class_name) {\n            $class_name = $this->className;\n        }\n\n        /** @var $object ObjectModel */\n        $object = new $class_name();\n\n        if (method_exists($this, 'getValidationRules')) {\n            $definition = $this->getValidationRules();\n        } else {\n            $definition = ObjectModel::getDefinition($class_name);\n        }\n\n        $default_language = new Language((int) Configuration::get('PS_LANG_DEFAULT'));\n        $languages = Language::getLanguages(false);\n\n        foreach ($definition['fields'] as $field => $def) {\n            $skip = [];\n            if (in_array($field, ['passwd', 'no-picture'])) {\n                $skip = ['required'];\n            }\n\n            if (isset($def['lang']) && $def['lang']) {\n                if (isset($def['required']) && $def['required']) {\n                    $value = Tools::getValue($field . '_' . $default_language->id);\n                    // !isset => not exist || \"\" == $value can be === 0 (before, empty $value === 0 returned true)\n                    if (!isset($value) || '' == $value) {\n                        $this->errors[$field . '_' . $default_language->id] = $this->trans(\n                            'The field %field_name% is required at least in %lang%.',\n                            ['%field_name%' => $object->displayFieldName($field, $class_name), '%lang%' => $default_language->name],\n                            'Admin.Notifications.Error'\n                        );\n                    }\n                }\n\n                foreach ($languages as $language) {\n                    $value = Tools::getValue($field . '_' . $language['id_lang']);\n                    if (!empty($value)) {\n                        if (($error = $object->validateField($field, $value, $language['id_lang'], $skip, true)) !== true) {\n                            $this->errors[$field . '_' . $language['id_lang']] = $error;\n                        }\n                    }\n                }\n            } elseif (($error = $object->validateField($field, Tools::getValue($field), null, $skip, true)) !== true) {\n                $this->errors[$field] = $error;\n            }\n        }\n\n        /* Overload this method for custom checking */\n        $this->_childValidation();\n\n        /* Checking for multilingual fields validity */\n        if (isset($rules['validateLang']) && is_array($rules['validateLang'])) {\n            foreach ($rules['validateLang'] as $field_lang => $function) {\n                foreach ($languages as $language) {\n                    if (($value = Tools::getValue($field_lang . '_' . $language['id_lang'])) !== false && !empty($value)) {\n                        if (Tools::strtolower($function) == 'iscleanhtml' && Configuration::get('PS_ALLOW_HTML_IFRAME')) {\n                            $res = Validate::$function($value, true);\n                        } else {\n                            $res = Validate::$function($value);\n                        }\n                        if (!$res) {\n                            $this->errors[$field_lang . '_' . $language['id_lang']] = $this->trans(\n                                'The %field_name% field (%lang%) is invalid.',\n                                ['%field_name%' => call_user_func([$class_name, 'displayFieldName'], $field_lang, $class_name), '%lang%' => $language['name']],\n                                'Admin.Notifications.Error'\n                            );\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    /**\n     * Overload this method for custom checking.\n     */\n    protected function _childValidation()\n    {\n    }\n\n    /**\n     * Display object details.\n     */\n    public function viewDetails()\n    {\n    }\n\n    /**\n     * Called before deletion.\n     *\n     * @param ObjectModel $object Object\n     *\n     * @return bool\n     */\n    protected function beforeDelete($object)\n    {\n        return false;\n    }\n\n    /**\n     * Called before deletion.\n     *\n     * @param ObjectModel $object Object\n     * @param int $old_id\n     *\n     * @return bool\n     */\n    protected function afterDelete($object, $old_id)\n    {\n        return true;\n    }\n\n    /**\n     * @param ObjectModel $object\n     *\n     * @return bool\n     */\n    protected function afterAdd($object)\n    {\n        return true;\n    }\n\n    /**\n     * @param ObjectModel $object\n     *\n     * @return bool\n     */\n    protected function afterUpdate($object)\n    {\n        return true;\n    }\n\n    /**\n     * Check rights to view the current tab.\n     *\n     * @return bool\n     */\n    protected function afterImageUpload()\n    {\n        return true;\n    }\n\n    /**\n     * Copy data values from $_POST to object.\n     *\n     * @param ObjectModel &$object Object\n     * @param string $table Object table\n     */\n    protected function copyFromPost(&$object, $table)\n    {\n        /* Classical fields */\n        foreach ($_POST as $key => $value) {\n            if (array_key_exists($key, $object) && $key != 'id_' . $table) {\n                /* Do not take care of password field if empty */\n                if ($key == 'passwd' && Tools::getValue('id_' . $table) && empty($value)) {\n                    continue;\n                }\n                /* Automatically hash password in MD5 */\n                if ($key == 'passwd' && !empty($value)) {\n                    $value = $this->get('hashing')->hash($value, _COOKIE_KEY_);\n                }\n                $object->{$key} = $value;\n            }\n        }\n\n        /* Multilingual fields */\n        $class_vars = get_class_vars(get_class($object));\n        $fields = [];\n        if (isset($class_vars['definition']['fields'])) {\n            $fields = $class_vars['definition']['fields'];\n        }\n\n        foreach ($fields as $field => $params) {\n            if (array_key_exists('lang', $params) && $params['lang']) {\n                foreach (Language::getIDs(false) as $id_lang) {\n                    if (Tools::isSubmit($field . '_' . (int) $id_lang)) {\n                        $object->{$field}[(int) $id_lang] = Tools::getValue($field . '_' . (int) $id_lang);\n                    }\n                }\n            }\n        }\n    }\n\n    /**\n     * Returns an array with selected shops and type (group or boutique shop).\n     *\n     * @param string $table\n     *\n     * @return array\n     */\n    protected function getSelectedAssoShop($table)\n    {\n        if (!Shop::isFeatureActive() || !Shop::isTableAssociated($table)) {\n            return [];\n        }\n\n        $shops = Shop::getShops(true, null, true);\n        if (count($shops) == 1 && isset($shops[0])) {\n            return [$shops[0], 'shop'];\n        }\n\n        $assos = [];\n        if (Tools::isSubmit('checkBoxShopAsso_' . $table)) {\n            foreach (Tools::getValue('checkBoxShopAsso_' . $table) as $id_shop => $value) {\n                $assos[] = (int) $id_shop;\n            }\n        } elseif (Shop::getTotalShops(false) == 1) {\n            // if we do not have the checkBox multishop, we can have an admin with only one shop and being in multishop\n            $assos[] = (int) Shop::getContextShopID();\n        }\n\n        return $assos;\n    }\n\n    /**\n     * Update the associations of shops.\n     *\n     * @param int $id_object\n     *\n     * @return bool|void\n     *\n     * @throws PrestaShopDatabaseException\n     */\n    protected function updateAssoShop($id_object)\n    {\n        if (!Shop::isFeatureActive()) {\n            return;\n        }\n\n        if (!Shop::isTableAssociated($this->table)) {\n            return;\n        }\n\n        $assos_data = $this->getSelectedAssoShop($this->table);\n\n        // Get list of shop id we want to exclude from asso deletion\n        $exclude_ids = $assos_data;\n        foreach (Db::getInstance()->executeS('SELECT id_shop FROM ' . _DB_PREFIX_ . 'shop') as $row) {\n            if (!$this->context->employee->hasAuthOnShop($row['id_shop'])) {\n                $exclude_ids[] = $row['id_shop'];\n            }\n        }\n        Db::getInstance()->delete($this->table . '_shop', '`' . bqSQL($this->identifier) . '` = ' . (int) $id_object . ($exclude_ids ? ' AND id_shop NOT IN (' . implode(', ', array_map('intval', $exclude_ids)) . ')' : ''));\n\n        $insert = [];\n        foreach ($assos_data as $id_shop) {\n            $insert[] = [\n                $this->identifier => (int) $id_object,\n                'id_shop' => (int) $id_shop,\n            ];\n        }\n\n        return Db::getInstance()->insert($this->table . '_shop', $insert, false, true, Db::INSERT_IGNORE);\n    }\n\n    /**\n     * @param mixed $value\n     * @param array $field\n     *\n     * @return bool\n     */\n    protected function validateField($value, $field)\n    {\n        if (isset($field['validation'])) {\n            $valid_method_exists = method_exists('Validate', $field['validation']);\n            if ((!isset($field['empty']) || !$field['empty'] || (isset($field['empty']) && $field['empty'] && $value)) && $valid_method_exists) {\n                $field_validation = $field['validation'];\n                if (!Validate::$field_validation($value)) {\n                    $this->errors[] = $this->trans('%s: Incorrect value', [$field['title']], 'Admin.Notifications.Error');\n\n                    return false;\n                }\n            }\n        }\n\n        return true;\n    }\n\n    /**\n     * Can be overridden.\n     */\n    public function beforeUpdateOptions()\n    {\n    }\n\n    /**\n     * Overload this method for custom checking.\n     *\n     * @param int $id Object id used for deleting images\n     *\n     * @return bool\n     */\n    protected function postImage($id)\n    {\n        if (isset($this->fieldImageSettings['name'], $this->fieldImageSettings['dir'])) {\n            return $this->uploadImage($id, $this->fieldImageSettings['name'], $this->fieldImageSettings['dir'] . '/');\n        } elseif (!empty($this->fieldImageSettings)) {\n            foreach ($this->fieldImageSettings as $image) {\n                if (isset($image['name'], $image['dir'])) {\n                    $this->uploadImage($id, $image['name'], $image['dir'] . '/');\n                }\n            }\n        }\n\n        return !count($this->errors) ? true : false;\n    }\n\n    /**\n     * @param int $id\n     * @param string $name\n     * @param string $dir\n     * @param string|bool $ext\n     * @param int|null $width\n     * @param int|null $height\n     *\n     * @return bool\n     */\n    protected function uploadImage($id, $name, $dir, $ext = false, $width = null, $height = null)\n    {\n        if (isset($_FILES[$name]['tmp_name']) && !empty($_FILES[$name]['tmp_name'])) {\n            // Delete old image\n            if (Validate::isLoadedObject($object = $this->loadObject())) {\n                $object->deleteImage();\n            } else {\n                return false;\n            }\n\n            // Check image validity\n            $max_size = isset($this->max_image_size) ? $this->max_image_size : 0;\n            if ($error = ImageManager::validateUpload($_FILES[$name], Tools::getMaxUploadSize($max_size))) {\n                $this->errors[] = $error;\n            }\n\n            $tmp_name = tempnam(_PS_TMP_IMG_DIR_, 'PS');\n            if (!$tmp_name) {\n                return false;\n            }\n\n            if (!move_uploaded_file($_FILES[$name]['tmp_name'], $tmp_name)) {\n                return false;\n            }\n\n            // Evaluate the memory required to resize the image: if it's too much, you can't resize it.\n            if (!ImageManager::checkImageMemoryLimit($tmp_name)) {\n                $this->errors[] = $this->trans('Due to memory limit restrictions, this image cannot be loaded. Please increase your memory_limit value via your server\\'s configuration settings.', [], 'Admin.Notifications.Error');\n            }\n\n            // Copy new image\n            if (empty($this->errors) && !ImageManager::resize($tmp_name, _PS_IMG_DIR_ . $dir . $id . '.' . $this->imageType, (int) $width, (int) $height, ($ext ? $ext : $this->imageType))) {\n                $this->errors[] = $this->trans('An error occurred while uploading the image.', [], 'Admin.Notifications.Error');\n            }\n\n            if (count($this->errors)) {\n                return false;\n            }\n            if ($this->afterImageUpload()) {\n                unlink($tmp_name);\n\n                return true;\n            }\n\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * Delete multiple items.\n     *\n     * @return bool true if success\n     */\n    protected function processBulkDelete()\n    {\n        if (is_array($this->boxes) && !empty($this->boxes)) {\n            $object = new $this->className();\n\n            if (isset($object->noZeroObject)) {\n                $objects_count = count(call_user_func([$this->className, $object->noZeroObject]));\n\n                // Check if all object will be deleted\n                if ($objects_count <= 1 || count($this->boxes) == $objects_count) {\n                    $this->errors[] = $this->trans('You need at least one object.', [], 'Admin.Notifications.Error') .\n                        ' <b>' . $this->table . '</b><br />' .\n                        $this->trans('You cannot delete all of the items.', [], 'Admin.Notifications.Error');\n                }\n            } else {\n                $result = true;\n                foreach ($this->boxes as $id) {\n                    /** @var $to_delete ObjectModel */\n                    $to_delete = new $this->className($id);\n                    $delete_ok = true;\n                    if ($this->deleted) {\n                        $to_delete->deleted = 1;\n                        if (!$to_delete->update()) {\n                            $result = false;\n                            $delete_ok = false;\n                        }\n                    } elseif (!$to_delete->delete()) {\n                        $result = false;\n                        $delete_ok = false;\n                    }\n\n                    if ($delete_ok) {\n                        PrestaShopLogger::addLog(\n                            $this->trans('%s deletion', [$this->className]),\n                            1,\n                            null,\n                            $this->className,\n                            (int) $to_delete->id,\n                            true,\n                            (int) $this->context->employee->id\n                        );\n                    } else {\n                        $this->errors[] = $this->trans('Can\\'t delete #%id%', ['%id%' => $id], 'Admin.Notifications.Error');\n                    }\n                }\n                if ($result) {\n                    $this->redirect_after = self::$currentIndex . '&conf=2&token=' . $this->token;\n                }\n                $this->errors[] = $this->trans('An error occurred while deleting this selection.', [], 'Admin.Notifications.Error');\n            }\n        } else {\n            $this->errors[] = $this->trans('You must select at least one element to delete.', [], 'Admin.Notifications.Error');\n        }\n\n        if (isset($result)) {\n            return $result;\n        } else {\n            return false;\n        }\n    }\n\n    protected function ajaxProcessOpenHelp()\n    {\n        $help_class_name = $_GET['controller'];\n        $popup_content = \"<!doctype html>\n        <html>\n            <head>\n                <meta charset='UTF-8'>\n                <title>PrestaShop Help</title>\n                <link href='//help.prestashop.com/css/help.css' rel='stylesheet'>\n                <link href='//fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet'>\n                <script src='\" . _PS_JS_DIR_ . \"jquery/jquery-1.11.0.min.js'></script>\n                <script src='\" . _PS_JS_DIR_ . \"admin.js'></script>\n                <script src='\" . _PS_JS_DIR_ . \"tools.js'></script>\n                <script>\n                    help_class_name='\" . addslashes($help_class_name) . \"';\n                    iso_user = '\" . addslashes($this->context->language->iso_code) . \"'\n                </script>\n                <script src='themes/default/js/help.js'></script>\n                <script>\n                    $(function(){\n                        initHelp();\n                    });\n                </script>\n            </head>\n            <body><div id='help-container' class='help-popup'></div></body>\n        </html>\";\n        die($popup_content);\n    }\n\n    /**\n     * Enable multiple items.\n     *\n     * @return bool true if success\n     */\n    protected function processBulkEnableSelection()\n    {\n        return $this->processBulkStatusSelection(1);\n    }\n\n    /**\n     * Disable multiple items.\n     *\n     * @return bool true if success\n     */\n    protected function processBulkDisableSelection()\n    {\n        return $this->processBulkStatusSelection(0);\n    }\n\n    /**\n     * Toggle status of multiple items.\n     *\n     * @param bool $status\n     *\n     * @return bool true if success\n     *\n     * @throws PrestaShopException\n     */\n    protected function processBulkStatusSelection($status)\n    {\n        $result = true;\n        if (is_array($this->boxes) && !empty($this->boxes)) {\n            foreach ($this->boxes as $id) {\n                /** @var ObjectModel $object */\n                $object = new $this->className((int) $id);\n                $object->active = (int) $status;\n                $result &= $object->update();\n            }\n        }\n\n        return $result;\n    }\n\n    /**\n     * @return bool\n     */\n    protected function processBulkAffectZone()\n    {\n        $result = false;\n        if (is_array($this->boxes) && !empty($this->boxes)) {\n            /** @var Country|State $object */\n            $object = new $this->className();\n            $result = $object->affectZoneToSelection(Tools::getValue($this->table . 'Box'), Tools::getValue('zone_to_affect'));\n\n            if ($result) {\n                $this->redirect_after = self::$currentIndex . '&conf=28&token=' . $this->token;\n            }\n            $this->errors[] = $this->trans('An error occurred while assigning a zone to the selection.', [], 'Admin.Notifications.Error');\n        } else {\n            $this->errors[] = $this->trans('You must select at least one element to assign a new zone.', [], 'Admin.Notifications.Error');\n        }\n\n        return $result;\n    }\n\n    /**\n     * Called before Add.\n     *\n     * @param ObjectModel $object Object\n     *\n     * @return bool\n     */\n    protected function beforeAdd($object)\n    {\n        return true;\n    }\n\n    /**\n     * Prepare the view to display the required fields form.\n     *\n     * @return string|void\n     */\n    public function displayRequiredFields()\n    {\n        if (!$this->access('add') || !$this->access('delete') || !$this->required_database) {\n            return;\n        }\n\n        $helper = new Helper();\n        $helper->currentIndex = self::$currentIndex;\n        $helper->token = $this->token;\n        $helper->override_folder = $this->override_folder;\n\n        return $helper->renderRequiredFields($this->className, $this->identifier, $this->required_fields);\n    }\n\n    /**\n     * Create a template from the override file, else from the base file.\n     *\n     * @param string $tpl_name filename\n     *\n     * @return Smarty_Internal_Template\n     */\n    public function createTemplate($tpl_name)\n    {\n        // Use override tpl if it exists\n        // If view access is denied, we want to use the default template that will be used to display an error\n        if ($this->viewAccess() && $this->override_folder) {\n            if (!Configuration::get('PS_DISABLE_OVERRIDES') && file_exists($this->context->smarty->getTemplateDir(1) . DIRECTORY_SEPARATOR . $this->override_folder . $tpl_name)) {\n                return $this->context->smarty->createTemplate($this->override_folder . $tpl_name, $this->context->smarty);\n            } elseif (file_exists($this->context->smarty->getTemplateDir(0) . 'controllers' . DIRECTORY_SEPARATOR . $this->override_folder . $tpl_name)) {\n                return $this->context->smarty->createTemplate('controllers' . DIRECTORY_SEPARATOR . $this->override_folder . $tpl_name, $this->context->smarty);\n            }\n        }\n\n        return $this->context->smarty->createTemplate($this->context->smarty->getTemplateDir(0) . $tpl_name, $this->context->smarty);\n    }\n\n    /**\n     * Shortcut to set up a json success payload.\n     *\n     * @param string $message Success message\n     */\n    public function jsonConfirmation($message)\n    {\n        $this->json = true;\n        $this->confirmations[] = $message;\n        if ($this->status === '') {\n            $this->status = 'ok';\n        }\n    }\n\n    /**\n     * Shortcut to set up a json error payload.\n     *\n     * @param string $message Error message\n     */\n    public function jsonError($message)\n    {\n        $this->json = true;\n        $this->errors[] = $message;\n        if ($this->status === '') {\n            $this->status = 'error';\n        }\n    }\n\n    /**\n     * @param string $file\n     * @param int $timeout\n     *\n     * @return bool\n     */\n    public function isFresh($file, $timeout = 604800)\n    {\n        if (($time = @filemtime(_PS_ROOT_DIR_ . $file)) && filesize(_PS_ROOT_DIR_ . $file) > 0) {\n            return (time() - $time) < $timeout;\n        }\n\n        return false;\n    }\n\n    /** @var bool */\n    protected static $is_prestashop_up = true;\n\n    /**\n     * @param string $file_to_refresh\n     * @param string $external_file\n     *\n     * @return bool\n     */\n    public function refresh($file_to_refresh, $external_file)\n    {\n        if (self::$is_prestashop_up && $content = Tools::file_get_contents($external_file)) {\n            return (bool) file_put_contents(_PS_ROOT_DIR_ . $file_to_refresh, $content);\n        }\n        self::$is_prestashop_up = false;\n\n        return false;\n    }\n\n    /**\n     * @param Module $module\n     * @param string $output_type\n     * @param string|null $back\n     * @param string|bool $install_source_tracking\n     */\n    public function fillModuleData(&$module, $output_type = 'link', $back = null, $install_source_tracking = false)\n    {\n        /** @var Module $obj */\n        $obj = null;\n        if ($module->onclick_option) {\n            $obj = new $module->name();\n        }\n        // Fill module data\n        $module->logo = '../../img/questionmark.png';\n\n        if (@filemtime(_PS_ROOT_DIR_ . DIRECTORY_SEPARATOR . basename(_PS_MODULE_DIR_) . DIRECTORY_SEPARATOR . $module->name\n            . DIRECTORY_SEPARATOR . 'logo.gif')) {\n            $module->logo = 'logo.gif';\n        }\n        if (@filemtime(_PS_ROOT_DIR_ . DIRECTORY_SEPARATOR . basename(_PS_MODULE_DIR_) . DIRECTORY_SEPARATOR . $module->name\n            . DIRECTORY_SEPARATOR . 'logo.png')) {\n            $module->logo = 'logo.png';\n        }\n\n        $link_admin_modules = $this->context->link->getAdminLink('AdminModules', true);\n\n        $module->options['install_url'] = $link_admin_modules . '&install=' . urlencode($module->name) . '&tab_module=' . $module->tab . '&module_name=' . $module->name\n            . '&anchor=' . ucfirst($module->name) . ($install_source_tracking ? '&source=' . $install_source_tracking : '');\n        $module->options['update_url'] = $link_admin_modules . '&update=' . urlencode($module->name) . '&tab_module=' . $module->tab . '&module_name=' . $module->name . '&anchor=' . ucfirst($module->name);\n        $module->options['uninstall_url'] = $link_admin_modules . '&uninstall=' . urlencode($module->name) . '&tab_module=' . $module->tab . '&module_name=' . $module->name . '&anchor=' . ucfirst($module->name);\n\n        // free modules get their source tracking data here\n        $module->optionsHtml = $this->displayModuleOptions($module, $output_type, $back, $install_source_tracking);\n        // pay modules get their source tracking data here\n        if ($install_source_tracking && isset($module->addons_buy_url)) {\n            $module->addons_buy_url .= ($install_source_tracking ? '&utm_term=' . $install_source_tracking : '');\n        }\n\n        $module->options['uninstall_onclick'] = ((!$module->onclick_option) ?\n            ((empty($module->confirmUninstall)) ? 'return confirm(\\'' . $this->trans('Do you really want to uninstall this module?') . '\\');' : 'return confirm(\\'' . addslashes($module->confirmUninstall) . '\\');') :\n            $obj->onclickOption('uninstall', $module->options['uninstall_url']));\n\n        if ((Tools::getValue('module_name') == $module->name || in_array($module->name, explode('|', Tools::getValue('modules_list')))) && (int) Tools::getValue('conf') > 0) {\n            $module->message = $this->_conf[(int) Tools::getValue('conf')];\n        }\n\n        if ((Tools::getValue('module_name') == $module->name || in_array($module->name, explode('|', Tools::getValue('modules_list')))) && (int) Tools::getValue('conf') > 0) {\n            unset($obj);\n        }\n    }\n\n    /** @var array */\n    protected $translationsTab = [];\n\n    /**\n     * Display modules list.\n     *\n     * @param Module $module\n     * @param string $output_type (link or select)\n     * @param string|null $back\n     * @param string|bool $install_source_tracking\n     *\n     * @return string|array\n     */\n    public function displayModuleOptions($module, $output_type = 'link', $back = null, $install_source_tracking = false)\n    {\n        if (!isset($module->enable_device)) {\n            $module->enable_device = Context::DEVICE_COMPUTER | Context::DEVICE_TABLET | Context::DEVICE_MOBILE;\n        }\n\n        $this->translationsTab['confirm_uninstall_popup'] = (isset($module->confirmUninstall) ? $module->confirmUninstall : $this->trans('Do you really want to uninstall this module?'));\n        if (!isset($this->translationsTab['Disable this module'])) {\n            $this->translationsTab['Disable this module'] = $this->trans('Disable this module');\n            $this->translationsTab['Enable this module for all shops'] = $this->trans('Enable this module for all shops');\n            $this->translationsTab['Disable'] = $this->trans('Disable');\n            $this->translationsTab['Enable'] = $this->trans('Enable');\n            $this->translationsTab['Disable on mobiles'] = $this->trans('Disable on mobiles');\n            $this->translationsTab['Disable on tablets'] = $this->trans('Disable on tablets');\n            $this->translationsTab['Disable on computers'] = $this->trans('Disable on computers');\n            $this->translationsTab['Display on mobiles'] = $this->trans('Display on mobiles');\n            $this->translationsTab['Display on tablets'] = $this->trans('Display on tablets');\n            $this->translationsTab['Display on computers'] = $this->trans('Display on computers');\n            $this->translationsTab['Reset'] = $this->trans('Reset');\n            $this->translationsTab['Configure'] = $this->trans('Configure');\n            $this->translationsTab['Delete'] = $this->trans('Delete');\n            $this->translationsTab['Install'] = $this->trans('Install');\n            $this->translationsTab['Uninstall'] = $this->trans('Uninstall');\n            $this->translationsTab['Would you like to delete the content related to this module ?'] = $this->trans('Would you like to delete the content related to this module ?');\n            $this->translationsTab['This action will permanently remove the module from the server. Are you sure you want to do this?'] = $this->trans('This action will permanently remove the module from the server. Are you sure you want to do this?');\n            $this->translationsTab['Remove from Favorites'] = $this->trans('Remove from Favorites');\n            $this->translationsTab['Mark as Favorite'] = $this->trans('Mark as Favorite');\n        }\n\n        $link_admin_modules = $this->context->link->getAdminLink('AdminModules', true);\n        $modules_options = [];\n\n        $configure_module = [\n            'href' => $link_admin_modules . '&configure=' . urlencode($module->name) . '&tab_module=' . $module->tab . '&module_name=' . urlencode($module->name),\n            'onclick' => $module->onclick_option && isset($module->onclick_option_content['configure']) ? $module->onclick_option_content['configure'] : '',\n            'title' => '',\n            'text' => $this->translationsTab['Configure'],\n            'cond' => $module->id && isset($module->is_configurable) && $module->is_configurable,\n            'icon' => 'wrench',\n        ];\n\n        $desactive_module = [\n            'href' => $link_admin_modules . '&module_name=' . urlencode($module->name) . '&' . ($module->active ? 'enable=0' : 'enable=1') . '&tab_module=' . $module->tab,\n            'onclick' => $module->active && $module->onclick_option && isset($module->onclick_option_content['desactive']) ? $module->onclick_option_content['desactive'] : '',\n            'title' => Shop::isFeatureActive() ? htmlspecialchars($module->active ? $this->translationsTab['Disable this module'] : $this->translationsTab['Enable this module for all shops']) : '',\n            'text' => $module->active ? $this->translationsTab['Disable'] : $this->translationsTab['Enable'],\n            'cond' => $module->id,\n            'icon' => 'off',\n        ];\n        $link_reset_module = $link_admin_modules . '&module_name=' . urlencode($module->name) . '&reset&tab_module=' . $module->tab;\n\n        $is_reset_ready = false;\n        if (Validate::isModuleName($module->name)) {\n            if (method_exists(Module::getInstanceByName($module->name), 'reset')) {\n                $is_reset_ready = true;\n            }\n        }\n\n        $reset_module = [\n            'href' => $link_reset_module,\n            'onclick' => $module->onclick_option && isset($module->onclick_option_content['reset']) ? $module->onclick_option_content['reset'] : '',\n            'title' => '',\n            'text' => $this->translationsTab['Reset'],\n            'cond' => $module->id && $module->active,\n            'icon' => 'undo',\n            'class' => ($is_reset_ready ? 'reset_ready' : ''),\n        ];\n\n        $delete_module = [\n            'href' => $link_admin_modules . '&delete=' . urlencode($module->name) . '&tab_module=' . $module->tab . '&module_name=' . urlencode($module->name),\n            'onclick' => $module->onclick_option && isset($module->onclick_option_content['delete']) ? $module->onclick_option_content['delete'] : 'return confirm(\\'' . $this->translationsTab['This action will permanently remove the module from the server. Are you sure you want to do this?'] . '\\');',\n            'title' => '',\n            'text' => $this->translationsTab['Delete'],\n            'cond' => true,\n            'icon' => 'trash',\n            'class' => 'text-danger',\n        ];\n\n        $display_mobile = [\n            'href' => $link_admin_modules . '&module_name=' . urlencode($module->name) . '&' . ($module->enable_device & Context::DEVICE_MOBILE ? 'disable_device' : 'enable_device') . '=' . Context::DEVICE_MOBILE . '&tab_module=' . $module->tab,\n            'onclick' => '',\n            'title' => htmlspecialchars($module->enable_device & Context::DEVICE_MOBILE ? $this->translationsTab['Disable on mobiles'] : $this->translationsTab['Display on mobiles']),\n            'text' => $module->enable_device & Context::DEVICE_MOBILE ? $this->translationsTab['Disable on mobiles'] : $this->translationsTab['Display on mobiles'],\n            'cond' => $module->id,\n            'icon' => 'mobile',\n        ];\n\n        $display_tablet = [\n            'href' => $link_admin_modules . '&module_name=' . urlencode($module->name) . '&' . ($module->enable_device & Context::DEVICE_TABLET ? 'disable_device' : 'enable_device') . '=' . Context::DEVICE_TABLET . '&tab_module=' . $module->tab,\n            'onclick' => '',\n            'title' => htmlspecialchars($module->enable_device & Context::DEVICE_TABLET ? $this->translationsTab['Disable on tablets'] : $this->translationsTab['Display on tablets']),\n            'text' => $module->enable_device & Context::DEVICE_TABLET ? $this->translationsTab['Disable on tablets'] : $this->translationsTab['Display on tablets'],\n            'cond' => $module->id,\n            'icon' => 'tablet',\n        ];\n\n        $display_computer = [\n            'href' => $link_admin_modules . '&module_name=' . urlencode($module->name) . '&' . ($module->enable_device & Context::DEVICE_COMPUTER ? 'disable_device' : 'enable_device') . '=' . Context::DEVICE_COMPUTER . '&tab_module=' . $module->tab,\n            'onclick' => '',\n            'title' => htmlspecialchars($module->enable_device & Context::DEVICE_COMPUTER ? $this->translationsTab['Disable on computers'] : $this->translationsTab['Display on computers']),\n            'text' => $module->enable_device & Context::DEVICE_COMPUTER ? $this->translationsTab['Disable on computers'] : $this->translationsTab['Display on computers'],\n            'cond' => $module->id,\n            'icon' => 'desktop',\n        ];\n\n        $install = [\n            'href' => $link_admin_modules . '&install=' . urlencode($module->name) . '&tab_module=' . $module->tab . '&module_name=' . $module->name . '&anchor=' . ucfirst($module->name)\n                . (null !== $back ? '&back=' . urlencode($back) : '') . ($install_source_tracking ? '&source=' . $install_source_tracking : ''),\n            'onclick' => '',\n            'title' => $this->translationsTab['Install'],\n            'text' => $this->translationsTab['Install'],\n            'cond' => $module->id,\n            'icon' => 'plus-sign-alt',\n        ];\n\n        $uninstall = [\n            'href' => $link_admin_modules . '&uninstall=' . urlencode($module->name) . '&tab_module=' . $module->tab . '&module_name=' . $module->name . '&anchor=' . ucfirst($module->name) . (null !== $back ? '&back=' . urlencode($back) : ''),\n            'onclick' => (isset($module->onclick_option_content['uninstall']) ? $module->onclick_option_content['uninstall'] : 'return confirm(\\'' . $this->translationsTab['confirm_uninstall_popup'] . '\\');'),\n            'title' => $this->translationsTab['Uninstall'],\n            'text' => $this->translationsTab['Uninstall'],\n            'cond' => $module->id,\n            'icon' => 'minus-sign-alt',\n        ];\n\n        $remove_from_favorite = [\n            'href' => '#',\n            'class' => 'action_unfavorite toggle_favorite',\n            'onclick' => '',\n            'title' => $this->translationsTab['Remove from Favorites'],\n            'text' => $this->translationsTab['Remove from Favorites'],\n            'cond' => $module->id,\n            'icon' => 'star',\n            'data-value' => '0',\n            'data-module' => $module->name,\n        ];\n\n        $mark_as_favorite = [\n            'href' => '#',\n            'class' => 'action_favorite toggle_favorite',\n            'onclick' => '',\n            'title' => $this->translationsTab['Mark as Favorite'],\n            'text' => $this->translationsTab['Mark as Favorite'],\n            'cond' => $module->id,\n            'icon' => 'star',\n            'data-value' => '1',\n            'data-module' => $module->name,\n        ];\n\n        $update = [\n            'href' => $module->options['update_url'],\n            'onclick' => '',\n            'title' => 'Update it!',\n            'text' => 'Update it!',\n            'icon' => 'refresh',\n            'cond' => $module->id,\n        ];\n\n        $divider = [\n            'href' => '#',\n            'onclick' => '',\n            'title' => 'divider',\n            'text' => 'divider',\n            'cond' => $module->id,\n        ];\n\n        if (isset($module->version_addons) && $module->version_addons) {\n            $modules_options[] = $update;\n        }\n\n        if ($module->active) {\n            $modules_options[] = $configure_module;\n            $modules_options[] = $desactive_module;\n            $modules_options[] = $display_mobile;\n            $modules_options[] = $display_tablet;\n            $modules_options[] = $display_computer;\n        } else {\n            $modules_options[] = $desactive_module;\n            $modules_options[] = $configure_module;\n        }\n\n        $modules_options[] = $reset_module;\n\n        if ($output_type == 'select') {\n            if (!$module->id) {\n                $modules_options[] = $install;\n            } else {\n                $modules_options[] = $uninstall;\n            }\n        } elseif ($output_type == 'array') {\n            if ($module->id) {\n                $modules_options[] = $uninstall;\n            }\n        }\n\n        if (isset($module->preferences, $module->preferences['favorite']) && $module->preferences['favorite'] == 1) {\n            $remove_from_favorite['style'] = '';\n            $mark_as_favorite['style'] = 'display:none;';\n            $modules_options[] = $remove_from_favorite;\n            $modules_options[] = $mark_as_favorite;\n        } else {\n            $mark_as_favorite['style'] = '';\n            $remove_from_favorite['style'] = 'display:none;';\n            $modules_options[] = $remove_from_favorite;\n            $modules_options[] = $mark_as_favorite;\n        }\n\n        if ($module->id == 0) {\n            $install['cond'] = 1;\n            $install['flag_install'] = 1;\n            $modules_options[] = $install;\n        }\n        $modules_options[] = $divider;\n        $modules_options[] = $delete_module;\n\n        $return = '';\n        foreach ($modules_options as $option_name => $option) {\n            if ($option['cond']) {\n                if ($output_type == 'link') {\n                    $return .= '<li><a class=\"' . $option_name . ' action_module';\n                    $return .= '\" href=\"' . $option['href'] . (null !== $back ? '&back=' . urlencode($back) : '') . '\"';\n                    $return .= ' onclick=\"' . $option['onclick'] . '\"  title=\"' . $option['title'] . '\"><i class=\"icon-' . (isset($option['icon']) && $option['icon'] ? $option['icon'] : 'cog') . '\"></i>&nbsp;' . $option['text'] . '</a></li>';\n                } elseif ($output_type == 'array') {\n                    if (!is_array($return)) {\n                        $return = [];\n                    }\n\n                    $html = '<a class=\"';\n\n                    $is_install = isset($option['flag_install']) ? true : false;\n\n                    if (isset($option['class'])) {\n                        $html .= $option['class'];\n                    }\n                    if ($is_install) {\n                        $html .= ' btn btn-success';\n                    }\n                    if (!$is_install && count($return) == 0) {\n                        $html .= ' btn btn-default';\n                    }\n\n                    $html .= '\"';\n\n                    if (isset($option['data-value'])) {\n                        $html .= ' data-value=\"' . $option['data-value'] . '\"';\n                    }\n\n                    if (isset($option['data-module'])) {\n                        $html .= ' data-module=\"' . $option['data-module'] . '\"';\n                    }\n\n                    if (isset($option['style'])) {\n                        $html .= ' style=\"' . $option['style'] . '\"';\n                    }\n\n                    $html .= ' href=\"' . htmlentities($option['href']) . (null !== $back ? '&back=' . urlencode($back) : '') . '\" onclick=\"' . $option['onclick'] . '\"  title=\"' . $option['title'] . '\"><i class=\"icon-' . (isset($option['icon']) && $option['icon'] ? $option['icon'] : 'cog') . '\"></i> ' . $option['text'] . '</a>';\n                    $return[] = $html;\n                } elseif ($output_type == 'select') {\n                    $return .= '<option id=\"' . $option_name . '\" data-href=\"' . htmlentities($option['href']) . (null !== $back ? '&back=' . urlencode($back) : '') . '\" data-onclick=\"' . $option['onclick'] . '\">' . $option['text'] . '</option>';\n                }\n            }\n        }\n\n        if ($output_type == 'select') {\n            $return = '<select id=\"select_' . $module->name . '\">' . $return . '</select>';\n        }\n\n        return $return;\n    }\n\n    public function ajaxProcessGetModuleQuickView()\n    {\n        $modules = Module::getModulesOnDisk();\n\n        foreach ($modules as $module) {\n            if ($module->name == Tools::getValue('module')) {\n                break;\n            }\n        }\n\n        $url = $module->url;\n\n        if (isset($module->type) && ($module->type == 'addonsPartner' || $module->type == 'addonsNative')) {\n            $url = $this->context->link->getAdminLink('AdminModules') . '&install=' . urlencode($module->name) . '&tab_module=' . $module->tab . '&module_name=' . $module->name . '&anchor=' . ucfirst($module->name);\n        }\n\n        $this->context->smarty->assign([\n            'displayName' => $module->displayName,\n            'image' => $module->image,\n            'nb_rates' => (int) $module->nb_rates[0],\n            'avg_rate' => (int) $module->avg_rate[0],\n            'badges' => $module->badges,\n            'compatibility' => $module->compatibility,\n            'description_full' => $module->description_full,\n            'additional_description' => $module->additional_description,\n            'is_addons_partner' => (isset($module->type) && ($module->type == 'addonsPartner' || $module->type == 'addonsNative')),\n            'url' => $url,\n            'price' => $module->price,\n        ]);\n        // Fetch the translations in the right place - they are not defined by our current controller!\n        Context::getContext()->override_controller_name_for_translations = 'AdminModules';\n        $this->smartyOutputContent('controllers/modules/quickview.tpl');\n        die(1);\n    }\n\n    /**\n     * Add an entry to the meta title.\n     *\n     * @param string $entry new entry\n     */\n    public function addMetaTitle($entry)\n    {\n        // Only add entry if the meta title was not forced.\n        if (is_array($this->meta_title)) {\n            $this->meta_title[] = $entry;\n        }\n    }\n\n    /**\n     * Set action.\n     *\n     * @param string $action\n     */\n    public function setAction($action)\n    {\n        $this->action = $action;\n    }\n\n    /**\n     * Set IdObject.\n     *\n     * @param int $id_object\n     */\n    public function setIdObject($id_object)\n    {\n        $this->id_object = (int) $id_object;\n    }\n\n    /**\n     * @return string\n     */\n    public function getTabSlug()\n    {\n        if (empty($this->tabSlug)) {\n            $this->tabSlug = Access::findSlugByIdTab($this->id);\n        }\n\n        return $this->tabSlug;\n    }\n\n    /**\n     * {@inheritdoc}\n     */\n    protected function buildContainer()\n    {\n        return ContainerBuilder::getContainer('admin', _PS_MODE_DEV_);\n    }\n\n    /**\n     * Return the type of authorization on module page.\n     *\n     * @return int(integer)\n     */\n    public function authorizationLevel()\n    {\n        if (\n            Access::isGranted(\n                'ROLE_MOD_TAB_' . strtoupper($this->controller_name) . '_DELETE',\n                $this->context->employee->id_profile\n            )\n        ) {\n            return AdminController::LEVEL_DELETE;\n        } elseif (\n            Access::isGranted(\n                'ROLE_MOD_TAB_' . strtoupper($this->controller_name) . '_CREATE',\n                $this->context->employee->id_profile\n            )\n        ) {\n            return AdminController::LEVEL_ADD;\n        } elseif (\n            Access::isGranted(\n                'ROLE_MOD_TAB_' . strtoupper($this->controller_name) . '_UPDATE',\n                $this->context->employee->id_profile\n            )\n        ) {\n            return AdminController::LEVEL_EDIT;\n        } elseif (\n            Access::isGranted(\n                'ROLE_MOD_TAB_' . strtoupper($this->controller_name) . '_READ',\n                $this->context->employee->id_profile\n            )\n        ) {\n            return AdminController::LEVEL_VIEW;\n        } else {\n            return 0;\n        }\n    }\n\n    /**\n     * Get the url of the first active sub-tab.\n     *\n     * @param array[] $subtabs\n     *\n     * @return string Url, or empty if no active sub-tab\n     */\n    private function getTabLinkFromSubTabs(array $subtabs)\n    {\n        foreach ($subtabs as $tab) {\n            if ($tab['active'] && $tab['enabled']) {\n                return $tab['href'];\n            }\n        }\n\n        return '';\n    }\n\n    /**\n     * Prepare price specifications to display cldr prices in javascript context.\n     *\n     * @param Context $context\n     *\n     * @return array\n     */\n    private function preparePriceSpecifications(Context $context)\n    {\n        /* @var Currency */\n        $currency = $context->currency;\n        /* @var PriceSpecification */\n        $priceSpecification = $context->getCurrentLocale()->getPriceSpecification($currency->iso_code);\n        if (empty($priceSpecification)) {\n            return [];\n        }\n\n        return array_merge(\n            ['symbol' => $priceSpecification->getSymbolsByNumberingSystem(Locale::NUMBERING_SYSTEM_LATIN)->toArray()],\n            $priceSpecification->toArray()\n        );\n    }\n\n    /**\n     * Prepare number specifications to display cldr numbers in javascript context.\n     *\n     * @param Context $context\n     *\n     * @return array\n     */\n    private function prepareNumberSpecifications(Context $context)\n    {\n        /* @var NumberSpecification */\n        $numberSpecification = $context->getCurrentLocale()->getNumberSpecification();\n        if (empty($numberSpecification)) {\n            return [];\n        }\n\n        return array_merge(\n            ['symbol' => $numberSpecification->getSymbolsByNumberingSystem(Locale::NUMBERING_SYSTEM_LATIN)->toArray()],\n            $numberSpecification->toArray()\n        );\n    }\n\n    /**\n     * Set if anonymous is allowed to run this controller\n     *\n     * @param bool $value\n     *\n     * @return bool\n     */\n    protected function setAllowAnonymous($value)\n    {\n        $this->allowAnonymous = (bool) $value;\n    }\n\n    /**\n     * Return if an anonymous is allowed to run this controller\n     *\n     * @return bool\n     */\n    protected function isAnonymousAllowed()\n    {\n        return $this->allowAnonymous;\n    }\n}\n", "<?php\n/**\n * 2007-2020 PrestaShop SA and Contributors\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * https://opensource.org/licenses/OSL-3.0\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@prestashop.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade PrestaShop to newer\n * versions in the future. If you wish to customize PrestaShop for your\n * needs please refer to https://www.prestashop.com for more information.\n *\n * @author    PrestaShop SA <contact@prestashop.com>\n * @copyright 2007-2020 PrestaShop SA and Contributors\n * @license   https://opensource.org/licenses/OSL-3.0 Open Software License (OSL 3.0)\n * International Registered Trademark & Property of PrestaShop SA\n */\nuse PrestaShop\\PrestaShop\\Adapter\\Routing\\AdminLinkBuilder;\nuse PrestaShop\\PrestaShop\\Adapter\\Routing\\LegacyHelperLinkBuilder;\nuse PrestaShop\\PrestaShop\\Adapter\\SymfonyContainer;\nuse PrestaShop\\PrestaShop\\Core\\Routing\\EntityLinkBuilderFactory;\nuse PrestaShop\\PrestaShop\\Core\\Routing\\Exception\\BuilderNotFoundException;\n\n/**\n * @since 1.5.0\n */\nclass HelperListCore extends Helper\n{\n    /** @var int size which is used for lists image thumbnail generation. */\n    const LIST_THUMBNAIL_SIZE = 45;\n\n    /** @var array Cache for query results */\n    protected $_list = [];\n\n    /** @var int Number of results in list */\n    public $listTotal = 0;\n\n    /** @var array WHERE clause determined by filter fields */\n    protected $_filter;\n\n    /** @var array Number of results in list per page (used in select field) */\n    public $_pagination = [20, 50, 100, 300, 1000];\n\n    /** @var int Default number of results in list per page */\n    public $_default_pagination = 50;\n\n    /** @var string ORDER BY clause determined by field/arrows in list header */\n    public $orderBy;\n\n    /** @var string Default ORDER BY clause when $orderBy is not defined */\n    public $_defaultOrderBy = false;\n\n    /** @var array : list of vars for button delete */\n    public $tpl_delete_link_vars = [];\n\n    /** @var string Order way (ASC, DESC) determined by arrows in list header */\n    public $orderWay;\n\n    public $identifier;\n\n    protected $deleted = 0;\n\n    /** @var array $cache_lang use to cache texts in current language */\n    public static $cache_lang = [];\n\n    public $is_cms = false;\n\n    public $position_identifier;\n\n    public $table_id;\n\n    /** @var string */\n    public $title_icon = null;\n\n    /**\n     * @var array Customize list display\n     *\n     * align  : determine value alignment\n     * prefix : displayed before value\n     * suffix : displayed after value\n     * image  : object image\n     * icon   : icon determined by values\n     * active : allow to toggle status\n     */\n    protected $fields_list;\n\n    /** @var bool Content line is clickable if true */\n    public $no_link = false;\n\n    /** @var Smarty_Internal_Template|string */\n    protected $header_tpl = 'list_header.tpl';\n\n    /** @var Smarty_Internal_Template|string */\n    protected $content_tpl = 'list_content.tpl';\n\n    /** @var Smarty_Internal_Template|string */\n    protected $footer_tpl = 'list_footer.tpl';\n\n    /** @var array list of required actions for each list row */\n    public $actions = [];\n\n    /** @var array list of row ids associated with a given action for witch this action have to not be available */\n    public $list_skip_actions = [];\n\n    public $bulk_actions = false;\n    public $force_show_bulk_actions = false;\n    public $specificConfirmDelete = null;\n    public $colorOnBackground;\n\n    /** @var bool If true, activates color on hover */\n    public $row_hover = true;\n\n    /** @var string|null If not null, a title will be added on that list */\n    public $title = null;\n\n    /** @var bool ask for simple header : no filters, no paginations and no sorting */\n    public $simple_header = false;\n\n    public $ajax_params = [];\n\n    public $page;\n\n    /** @var EntityLinkBuilderFactory */\n    private $linkBuilderFactory;\n\n    /**\n     * You can use $controllerMapping to add entity/controller mapping in order to have migrated links\n     * in a legacy list (this requires to have correctly set the _legacy_link in the routing of course)\n     *\n     * exemple: $helper = new HelperList(['cart' => 'AdminCarts']);\n     *\n     * @param array $controllerMapping\n     */\n    public function __construct(array $controllerMapping = [])\n    {\n        $this->base_folder = 'helpers/list/';\n        $this->base_tpl = 'list.tpl';\n\n        $controllerMapping = array_merge([\n            'customer' => 'AdminCustomers',\n            'product' => 'AdminProducts',\n            'order' => 'AdminOrders',\n            'cart' => 'AdminCarts',\n        ], $controllerMapping);\n        $adminLinkBuilder = new AdminLinkBuilder(Context::getContext()->link, $controllerMapping);\n        $this->linkBuilderFactory = new EntityLinkBuilderFactory([\n            $adminLinkBuilder,\n            new LegacyHelperLinkBuilder(),\n        ]);\n\n        parent::__construct();\n    }\n\n    /**\n     * Return an html list given the data to fill it up.\n     *\n     * @param array $list entries to display (rows)\n     * @param array $fields_display fields (cols)\n     *\n     * @return string html\n     */\n    public function generateList($list, $fields_display)\n    {\n        // Append when we get a syntax error in SQL query\n        if ($list === false) {\n            $this->context->controller->warnings[] = Context::getContext()->getTranslator()->trans('Bad SQL query', [], 'Admin.Notifications.Error');\n\n            return false;\n        }\n\n        $this->tpl = $this->createTemplate($this->base_tpl);\n        $this->header_tpl = $this->createTemplate($this->header_tpl);\n        $this->content_tpl = $this->createTemplate($this->content_tpl);\n        $this->footer_tpl = $this->createTemplate($this->footer_tpl);\n\n        $this->_list = $list;\n        $this->fields_list = $fields_display;\n\n        $patternsOrderBy = [\n            '/^([a-z _]*!)/Ui',     // remove a. for example\n            '/^([a-z _]*\\.)/Ui',    // remove a! for example\n            '/`/',                  // remove ` char\n        ];\n        $this->orderBy = preg_replace($patternsOrderBy, '', $this->orderBy);\n\n        $this->orderWay = preg_replace('/^([a-z _]*!)/Ui', '', $this->orderWay);\n\n        $this->tpl->assign([\n            'header' => $this->displayListHeader(), // Display list header (filtering, pagination and column names)\n            'content' => $this->displayListContent(), // Show the content of the table\n            'footer' => $this->displayListFooter(), // Close list table and submit button\n        ]);\n\n        return parent::generate();\n    }\n\n    /**\n     * Fetch the template for action enable.\n     *\n     * @param string $token\n     * @param string $id\n     * @param int $value state enabled or not\n     * @param string $active status\n     * @param int $id_category\n     * @param int $id_product\n     *\n     * @return string\n     */\n    public function displayEnableLink($token, $id, $value, $active, $id_category = null, $id_product = null, $ajax = false)\n    {\n        $tpl_enable = $this->createTemplate('list_action_enable.tpl');\n        $tpl_enable->assign([\n            'ajax' => $ajax,\n            'enabled' => (bool) $value,\n            'url_enable' => $this->currentIndex . '&' . $this->identifier . '=' . $id . '&' . $active . $this->table . ($ajax ? '&action=' . $active . $this->table . '&ajax=' . (int) $ajax : '') .\n                ((int) $id_category && (int) $id_product ? '&id_category=' . (int) $id_category : '') . ($this->page && $this->page > 1 ? '&page=' . (int) $this->page : '') . '&token=' . ($token != null ? $token : $this->token),\n        ]);\n\n        return $tpl_enable->fetch();\n    }\n\n    public function displayListContent()\n    {\n        if (isset($this->fields_list['position'])) {\n            if ($this->position_identifier) {\n                if (isset($this->position_group_identifier)) {\n                    $position_group_identifier = Tools::getIsset($this->position_group_identifier) ? Tools::getValue($this->position_group_identifier) : $this->position_group_identifier;\n                } else {\n                    $position_group_identifier = (int) Tools::getValue('id_' . ($this->is_cms ? 'cms_' : '') . 'category', ($this->is_cms ? '1' : Category::getRootCategory()->id));\n                }\n            } else {\n                $position_group_identifier = Category::getRootCategory()->id;\n            }\n\n            $positions = array_map(function ($elem) { return (int) ($elem['position']); }, $this->_list);\n            sort($positions);\n        }\n\n        // key_to_get is used to display the correct product category or cms category after a position change\n        $identifier = in_array($this->identifier, ['id_category', 'id_cms_category']) ? '_parent' : '';\n        if ($identifier) {\n            $key_to_get = 'id_' . ($this->is_cms ? 'cms_' : '') . 'category' . $identifier;\n        }\n\n        foreach ($this->_list as $index => $tr) {\n            $id = null;\n            if (isset($tr[$this->identifier])) {\n                $id = $tr[$this->identifier];\n            }\n            $name = isset($tr['name']) ? $tr['name'] : null;\n\n            if ($this->shopLinkType) {\n                $this->_list[$index]['short_shop_name'] = Tools::strlen($tr['shop_name']) > 15 ? Tools::substr($tr['shop_name'], 0, 15) . '...' : $tr['shop_name'];\n            }\n\n            $is_first = true;\n            // Check all available actions to add to the current list row\n            foreach ($this->actions as $action) {\n                //Check if the action is available for the current row\n                if (!array_key_exists($action, $this->list_skip_actions) || !in_array($id, $this->list_skip_actions[$action])) {\n                    $method_name = 'display' . ucfirst($action) . 'Link';\n\n                    if (method_exists($this->context->controller, $method_name)) {\n                        $this->_list[$index][$action] = $this->context->controller->$method_name($this->token, $id, $name);\n                    } elseif ($this->module instanceof Module && method_exists($this->module, $method_name)) {\n                        $this->_list[$index][$action] = $this->module->$method_name($this->token, $id, $name);\n                    } elseif (method_exists($this, $method_name)) {\n                        $this->_list[$index][$action] = $this->$method_name($this->token, $id, $name);\n                    }\n                }\n\n                if ($is_first && isset($this->_list[$index][$action])) {\n                    $is_first = false;\n\n                    if (!preg_match('/a\\s*.*class/', $this->_list[$index][$action])) {\n                        $this->_list[$index][$action] = preg_replace(\n                            '/href\\s*=\\s*\\\"([^\\\"]*)\\\"/',\n                            'href=\"$1\" class=\"btn btn-default\"',\n                            $this->_list[$index][$action]\n                        );\n                    } elseif (!preg_match('/a\\s*.*class\\s*=\\s*\\\".*btn.*\\\"/', $this->_list[$index][$action])) {\n                        $this->_list[$index][$action] = preg_replace(\n                            '/a(\\s*.*)class\\s*=\\s*\\\"(.*)\\\"/',\n                            'a $1 class=\"$2 btn btn-default\"',\n                            $this->_list[$index][$action]\n                        );\n                    }\n                }\n            }\n\n            $this->_list[$index]['link'] = in_array('view', $this->actions) ? $this->getViewLink($this->token, $id) : $this->getEditLink($this->token, $id);\n\n            // @todo skip action for bulk actions\n            // $this->_list[$index]['has_bulk_actions'] = true;\n            foreach ($this->fields_list as $key => $params) {\n                $tmp = explode('!', $key);\n                $key = isset($tmp[1]) ? $tmp[1] : $tmp[0];\n\n                if (isset($params['active'])) {\n                    // If method is defined in calling controller, use it instead of the Helper method\n                    if (method_exists($this->context->controller, 'displayEnableLink')) {\n                        $calling_obj = $this->context->controller;\n                    } elseif (isset($this->module) && method_exists($this->module, 'displayEnableLink')) {\n                        $calling_obj = $this->module;\n                    } else {\n                        $calling_obj = $this;\n                    }\n\n                    if (!isset($params['ajax'])) {\n                        $params['ajax'] = false;\n                    }\n                    $this->_list[$index][$key] = $calling_obj->displayEnableLink(\n                        $this->token,\n                        $id,\n                        $tr[$key],\n                        $params['active'],\n                        Tools::getValue('id_category'),\n                        Tools::getValue('id_product'),\n                        $params['ajax']\n                    );\n                } elseif (isset($params['activeVisu'])) {\n                    $this->_list[$index][$key] = (bool) $tr[$key];\n                } elseif (isset($params['position'])) {\n                    $this->_list[$index][$key] = [\n                        'position' => $tr[$key],\n                        'position_url_down' => $this->currentIndex .\n                            (isset($key_to_get) ? '&' . $key_to_get . '=' . (int) $position_group_identifier : '') .\n                            '&' . $this->position_identifier . '=' . $id .\n                            '&way=1&position=' . ((int) $tr['position'] + 1) . '&token=' . $this->token,\n                        'position_url_up' => $this->currentIndex .\n                            (isset($key_to_get) ? '&' . $key_to_get . '=' . (int) $position_group_identifier : '') .\n                            '&' . $this->position_identifier . '=' . $id .\n                            '&way=0&position=' . ((int) $tr['position'] - 1) . '&token=' . $this->token,\n                    ];\n                } elseif (isset($params['image'])) {\n                    // item_id is the product id in a product image context, else it is the image id.\n                    $item_id = isset($params['image_id']) ? $tr[$params['image_id']] : $id;\n                    if ($params['image'] != 'p' || Configuration::get('PS_LEGACY_IMAGES')) {\n                        $path_to_image = _PS_IMG_DIR_ . $params['image'] . '/' . $item_id . (isset($tr['id_image']) ? '-' . (int) $tr['id_image'] : '') . '.' . $this->imageType;\n                    } else {\n                        $path_to_image = _PS_IMG_DIR_ . $params['image'] . '/' . Image::getImgFolderStatic($tr['id_image']) . (int) $tr['id_image'] . '.' . $this->imageType;\n                    }\n                    $this->_list[$index][$key] = ImageManager::thumbnail($path_to_image, $this->table . '_mini_' . $item_id . '_' . $this->context->shop->id . '.' . $this->imageType, self::LIST_THUMBNAIL_SIZE, $this->imageType);\n                } elseif (isset($params['icon'], $tr[$key]) && (isset($params['icon'][$tr[$key]]) || isset($params['icon']['default']))) {\n                    if (!$this->bootstrap) {\n                        if (isset($params['icon'][$tr[$key]]) && is_array($params['icon'][$tr[$key]])) {\n                            $this->_list[$index][$key] = [\n                                'src' => $params['icon'][$tr[$key]]['src'],\n                                'alt' => $params['icon'][$tr[$key]]['alt'],\n                            ];\n                        } else {\n                            $this->_list[$index][$key] = [\n                                'src' => isset($params['icon'][$tr[$key]]) ? $params['icon'][$tr[$key]] : $params['icon']['default'],\n                                'alt' => isset($params['icon'][$tr[$key]]) ? $params['icon'][$tr[$key]] : $params['icon']['default'],\n                            ];\n                        }\n                    } elseif (isset($params['icon'][$tr[$key]])) {\n                        $this->_list[$index][$key] = $params['icon'][$tr[$key]];\n                    }\n                } elseif (isset($params['type']) && $params['type'] == 'float') {\n                    $this->_list[$index][$key] = rtrim(rtrim($tr[$key], '0'), '.');\n                } elseif (isset($tr[$key])) {\n                    $echo = $tr[$key];\n                    if (isset($params['callback'])) {\n                        $callback_obj = (isset($params['callback_object'])) ? $params['callback_object'] : $this->context->controller;\n                        $this->_list[$index][$key] = call_user_func_array([$callback_obj, $params['callback']], [$echo, $tr]);\n                    } else {\n                        $this->_list[$index][$key] = $echo;\n                    }\n                }\n            }\n        }\n\n        $showShopColumn = $this->shopLinkType;\n\n        $isMultiShopActive = Configuration::get('PS_MULTISHOP_FEATURE_ACTIVE');\n\n        $this->content_tpl->assign(array_merge($this->tpl_vars, [\n            'shop_link_type' => $showShopColumn,\n            'multishop_active' => $isMultiShopActive,\n            'name' => isset($name) ? $name : null,\n            'position_identifier' => $this->position_identifier,\n            'identifier' => $this->identifier,\n            'table' => $this->table,\n            'token' => $this->token,\n            'color_on_bg' => $this->colorOnBackground,\n            'position_group_identifier' => isset($position_group_identifier) ? $position_group_identifier : false,\n            'bulk_actions' => $this->bulk_actions,\n            'positions' => isset($positions) ? $positions : null,\n            'order_by' => $this->orderBy,\n            'order_way' => $this->orderWay,\n            'is_cms' => $this->is_cms,\n            'fields_display' => $this->fields_list,\n            'list' => $this->_list,\n            'actions' => $this->actions,\n            'no_link' => $this->no_link,\n            'current_index' => $this->currentIndex,\n            'view' => in_array('view', $this->actions),\n            'edit' => in_array('edit', $this->actions),\n            'has_actions' => !empty($this->actions),\n            'list_skip_actions' => $this->list_skip_actions,\n            'row_hover' => $this->row_hover,\n            'list_id' => isset($this->list_id) ? $this->list_id : $this->table,\n            'checked_boxes' => Tools::getValue((isset($this->list_id) ? $this->list_id : $this->table) . 'Box'),\n        ]));\n\n        return $this->content_tpl->fetch();\n    }\n\n    /**\n     * Display duplicate action link.\n     */\n    public function displayDuplicateLink($token, $id, $name = null)\n    {\n        $tpl = $this->createTemplate('list_action_duplicate.tpl');\n        if (!array_key_exists('Bad SQL query', self::$cache_lang)) {\n            self::$cache_lang['Duplicate'] = Context::getContext()->getTranslator()->trans('Duplicate', [], 'Admin.Actions');\n        }\n\n        if (!array_key_exists('Copy images too?', self::$cache_lang)) {\n            self::$cache_lang['Copy images too?'] = Context::getContext()->getTranslator()->trans('This will copy the images too. If you wish to proceed, click \"Yes\". If not, click \"No\".', [], 'Admin.Catalog.Notification');\n        }\n\n        $duplicate = $this->currentIndex . '&' . $this->identifier . '=' . $id . '&duplicate' . $this->table;\n\n        $confirm = self::$cache_lang['Copy images too?'];\n\n        if (($this->table == 'product') && !Image::hasImages($this->context->language->id, (int) $id)) {\n            $confirm = '';\n        }\n\n        $tpl->assign([\n            'href' => $this->currentIndex . '&' . $this->identifier . '=' . $id . '&view' . $this->table . '&token=' . ($token != null ? $token : $this->token),\n            'action' => self::$cache_lang['Duplicate'],\n            'confirm' => $confirm,\n            'location_ok' => $duplicate . '&token=' . ($token != null ? $token : $this->token),\n            'location_ko' => $duplicate . '&noimage=1&token=' . ($token ? $token : $this->token),\n        ]);\n\n        return $tpl->fetch();\n    }\n\n    /**\n     * Display action show details of a table row\n     * This action need an ajax request with a return like this:\n     *   {\n     *     use_parent_structure: true // If false, data need to be an html\n     *     data:\n     *       [\n     *         {field_name: 'value'}\n     *       ],\n     *     fields_display: // attribute $fields_list of the admin controller\n     *   }\n     * or somethins like this:\n     *   {\n     *     use_parent_structure: false // If false, data need to be an html\n     *     data:\n     *       '<p>My html content</p>',\n     *     fields_display: // attribute $fields_list of the admin controller\n     *   }.\n     */\n    public function displayDetailsLink($token, $id, $name = null)\n    {\n        $tpl = $this->createTemplate('list_action_details.tpl');\n        if (!array_key_exists('Details', self::$cache_lang)) {\n            self::$cache_lang['Details'] = Context::getContext()->getTranslator()->trans('Details', [], 'Admin.Global');\n        }\n\n        $ajax_params = $this->ajax_params;\n        if (!is_array($ajax_params) || !isset($ajax_params['action'])) {\n            $ajax_params['action'] = 'details';\n        }\n\n        $tpl->assign([\n            'id' => $id,\n            'href' => $this->currentIndex . '&' . $this->identifier . '=' . $id . '&details' . $this->table . '&token=' . ($token != null ? $token : $this->token),\n            'controller' => str_replace('Controller', '', get_class($this->context->controller)),\n            'token' => $token != null ? $token : $this->token,\n            'action' => self::$cache_lang['Details'],\n            'params' => $ajax_params,\n            'json_params' => json_encode($ajax_params),\n        ]);\n\n        return $tpl->fetch();\n    }\n\n    /**\n     * Display view action link.\n     */\n    public function displayViewLink($token, $id, $name = null)\n    {\n        $tpl = $this->createTemplate('list_action_view.tpl');\n        if (!array_key_exists('View', self::$cache_lang)) {\n            self::$cache_lang['View'] = Context::getContext()->getTranslator()->trans('View', [], 'Admin.Actions');\n        }\n\n        $href = $this->getViewLink($token, $id);\n        $tpl->assign([\n            'href' => $href,\n            'action' => self::$cache_lang['View'],\n        ]);\n\n        return $tpl->fetch();\n    }\n\n    /**\n     * Display edit action link.\n     */\n    public function displayEditLink($token, $id, $name = null)\n    {\n        $tpl = $this->createTemplate('list_action_edit.tpl');\n        if (!array_key_exists('Edit', self::$cache_lang)) {\n            self::$cache_lang['Edit'] = Context::getContext()->getTranslator()->trans('Edit', [], 'Admin.Actions');\n        }\n\n        $href = $this->getEditLink($token, $id);\n        $tpl->assign([\n            'href' => $href,\n            'action' => self::$cache_lang['Edit'],\n            'id' => $id,\n        ]);\n\n        return $tpl->fetch();\n    }\n\n    /**\n     * Display delete action link.\n     */\n    public function displayDeleteLink($token, $id, $name = null)\n    {\n        $tpl = $this->createTemplate('list_action_delete.tpl');\n\n        if (!array_key_exists('Delete', self::$cache_lang)) {\n            self::$cache_lang['Delete'] = Context::getContext()->getTranslator()->trans('Delete', [], 'Admin.Actions');\n        }\n\n        if (!array_key_exists('DeleteItem', self::$cache_lang)) {\n            self::$cache_lang['DeleteItem'] = Context::getContext()->getTranslator()->trans('Delete selected item?', [], 'Admin.Notifications.Info');\n        }\n\n        if (!array_key_exists('Name', self::$cache_lang)) {\n            self::$cache_lang['Name'] = Context::getContext()->getTranslator()->trans('Name:', [], 'Admin.Global');\n        }\n\n        if (null !== $name) {\n            $name = addcslashes('\\n\\n' . self::$cache_lang['Name'] . ' ' . $name, '\\'');\n        }\n\n        $href = $this->currentIndex . '&' . $this->identifier . '=' . $id . '&delete' . $this->table . '&token=' . ($token != null ? $token : $this->token);\n\n        switch ($this->currentIndex) {\n            case 'index.php?controller=AdminProducts':\n            case 'index.php?tab=AdminProducts':\n                // New architecture modification: temporary behavior to switch between old and new controllers.\n                $pagePreference = SymfonyContainer::getInstance()->get('prestashop.core.admin.page_preference_interface');\n                $redirectLegacy = $pagePreference->getTemporaryShouldUseLegacyPage('product');\n                if (!$redirectLegacy && $this->identifier == 'id_product') {\n                    $href = Context::getContext()->link->getAdminLink('AdminProducts', true, ['id_product' => $id, 'deleteproduct' => 1]);\n                }\n\n                break;\n            default:\n        }\n\n        $data = [\n            $this->identifier => $id,\n            'href' => $href,\n            'action' => self::$cache_lang['Delete'],\n        ];\n\n        if ($this->specificConfirmDelete !== false) {\n            $data['confirm'] = null !== $this->specificConfirmDelete ? '\\r' . $this->specificConfirmDelete : Tools::safeOutput(self::$cache_lang['DeleteItem'] . $name);\n        }\n\n        $tpl->assign(array_merge($this->tpl_delete_link_vars, $data));\n\n        return $tpl->fetch();\n    }\n\n    /**\n     * Display default action link.\n     */\n    public function displayDefaultLink($token, $id, $name = null)\n    {\n        $tpl = $this->createTemplate('list_action_default.tpl');\n        if (!array_key_exists('Default', self::$cache_lang)) {\n            self::$cache_lang['Default'] = Context::getContext()->getTranslator()->trans('Default', [], 'Admin.Global');\n        }\n\n        $tpl->assign([\n            'href' => $this->currentIndex . '&' . $this->identifier . '=' . (int) $id . '&default' . $this->table . '&token=' . ($token != null ? $token : $this->token),\n            'action' => self::$cache_lang['Default'],\n            'name' => $name,\n        ]);\n\n        return $tpl->fetch();\n    }\n\n    /**\n     * Display list header (filtering, pagination and column names).\n     */\n    public function displayListHeader()\n    {\n        if (!isset($this->list_id)) {\n            $this->list_id = $this->table;\n        }\n\n        $id_cat = (int) Tools::getValue('id_' . ($this->is_cms ? 'cms_' : '') . 'category');\n\n        if (!isset($token) || empty($token)) {\n            $token = $this->token;\n        }\n\n        /* Determine total page number */\n        $pagination = $this->_default_pagination;\n        if (in_array((int) Tools::getValue($this->list_id . '_pagination'), $this->_pagination)) {\n            $pagination = (int) Tools::getValue($this->list_id . '_pagination');\n        } elseif (isset($this->context->cookie->{$this->list_id . '_pagination'}) && $this->context->cookie->{$this->list_id . '_pagination'}) {\n            $pagination = $this->context->cookie->{$this->list_id . '_pagination'};\n        }\n\n        $total_pages = max(1, ceil($this->listTotal / $pagination));\n\n        $identifier = Tools::getIsset($this->identifier) ? '&' . $this->identifier . '=' . (int) Tools::getValue($this->identifier) : '';\n        $order = '';\n        if (Tools::getIsset($this->table . 'Orderby')) {\n            $order = '&' . $this->table . 'Orderby=' . urlencode($this->orderBy) . '&' . $this->table . 'Orderway=' . urlencode(strtolower($this->orderWay));\n        }\n\n        $action = $this->currentIndex . $identifier . '&token=' . $token . '#' . $this->list_id;\n\n        /* Determine current page number */\n        $page = (int) Tools::getValue('submitFilter' . $this->list_id);\n\n        if (!$page) {\n            $page = 1;\n        }\n\n        if ($page > $total_pages) {\n            $page = $total_pages;\n        }\n\n        $this->page = (int) $page;\n\n        /* Choose number of results per page */\n        $selected_pagination = Tools::getValue(\n            $this->list_id . '_pagination',\n            isset($this->context->cookie->{$this->list_id . '_pagination'}) ? $this->context->cookie->{$this->list_id . '_pagination'} : $this->_default_pagination\n        );\n\n        if (!isset($this->table_id) && $this->position_identifier && (int) Tools::getValue($this->position_identifier, 1)) {\n            $this->table_id = substr($this->identifier, 3, strlen($this->identifier));\n        }\n\n        if ($this->position_identifier && ($this->orderBy == 'position' && $this->orderWay != 'DESC')) {\n            $table_dnd = true;\n        }\n\n        $prefix = isset($this->controller_name) ? str_replace(['admin', 'controller'], '', Tools::strtolower($this->controller_name)) : '';\n        $ajax = false;\n        foreach ($this->fields_list as $key => $params) {\n            if (!isset($params['type'])) {\n                $params['type'] = 'text';\n            }\n\n            $value_key = $prefix . $this->list_id . 'Filter_' . (array_key_exists('filter_key', $params) ? $params['filter_key'] : $key);\n            if ($key == 'active' && strpos($key, '!') !== false) {\n                $keys = explode('!', $params['filter_key']);\n                $value_key = $keys[1];\n            }\n            $value = Context::getContext()->cookie->{$value_key};\n            if (!$value && Tools::getIsset($value_key)) {\n                $value = Tools::getValue($value_key);\n            }\n\n            switch ($params['type']) {\n                case 'bool':\n                    if (isset($params['ajax']) && $params['ajax']) {\n                        $ajax = true;\n                    }\n\n                    break;\n\n                case 'date':\n                case 'datetime':\n                    if (is_string($value)) {\n                        $value = json_decode($value, true);\n                    }\n                    if (!Validate::isCleanHtml($value[0]) || !Validate::isCleanHtml($value[1])) {\n                        $value = '';\n                    }\n                    $name = $this->list_id . 'Filter_' . (isset($params['filter_key']) ? $params['filter_key'] : $key);\n                    $name_id = str_replace('!', '__', $name);\n\n                    $params['id_date'] = $name_id;\n                    $params['name_date'] = $name;\n\n                    $this->context->controller->addJqueryUI('ui.datepicker');\n\n                    break;\n\n                case 'select':\n                    foreach ($params['list'] as $option_value => $option_display) {\n                        if (isset(Context::getContext()->cookie->{$prefix . $this->list_id . 'Filter_' . $params['filter_key']})\n                            && Context::getContext()->cookie->{$prefix . $this->list_id . 'Filter_' . $params['filter_key']} == $option_value\n                            && Context::getContext()->cookie->{$prefix . $this->list_id . 'Filter_' . $params['filter_key']} != '') {\n                            $this->fields_list[$key]['select'][$option_value]['selected'] = 'selected';\n                        }\n                    }\n\n                    break;\n\n                case 'text':\n                    if (!Validate::isCleanHtml($value)) {\n                        $value = '';\n                    }\n            }\n\n            $params['value'] = $value;\n            $this->fields_list[$key] = $params;\n        }\n\n        $has_value = false;\n        $has_search_field = false;\n\n        foreach ($this->fields_list as $key => $field) {\n            if (isset($field['value']) && $field['value'] !== false && $field['value'] !== '') {\n                if (is_array($field['value']) && trim(implode('', $field['value'])) == '') {\n                    continue;\n                }\n\n                $has_value = true;\n\n                break;\n            }\n            if (!(isset($field['search']) && $field['search'] === false)) {\n                $has_search_field = true;\n            }\n        }\n\n        Context::getContext()->smarty->assign([\n            'page' => $page,\n            'simple_header' => $this->simple_header,\n            'total_pages' => $total_pages,\n            'selected_pagination' => $selected_pagination,\n            'pagination' => $this->_pagination,\n            'list_total' => $this->listTotal,\n            'sql' => isset($this->sql) && $this->sql ? str_replace('\\n', ' ', str_replace('\\r', '', $this->sql)) : false,\n            'token' => $this->token,\n            'table' => $this->table,\n            'bulk_actions' => $this->bulk_actions,\n            'show_toolbar' => $this->show_toolbar,\n            'toolbar_scroll' => $this->toolbar_scroll,\n            'toolbar_btn' => $this->toolbar_btn,\n            'has_bulk_actions' => $this->hasBulkActions($has_value),\n            'filters_has_value' => (bool) $has_value,\n        ]);\n\n        if (null !== $this->title_icon) {\n            Context::getContext()->smarty->assign(['icon' => $this->title_icon]);\n        }\n\n        $isMultiShopActive = Configuration::get('PS_MULTISHOP_FEATURE_ACTIVE');\n\n        $this->header_tpl->assign(array_merge([\n            'ajax' => $ajax,\n            'title' => array_key_exists('title', $this->tpl_vars) ? $this->tpl_vars['title'] : $this->title,\n            'show_filters' => ((count($this->_list) > 1 && $has_search_field) || $has_value),\n            'currentIndex' => $this->currentIndex,\n            'action' => $action,\n            'is_order_position' => $this->position_identifier && $this->orderBy == 'position',\n            'order_way' => $this->orderWay,\n            'order_by' => $this->orderBy,\n            'fields_display' => $this->fields_list,\n            'delete' => in_array('delete', $this->actions),\n            'identifier' => $this->identifier,\n            'id_cat' => $id_cat,\n            'shop_link_type' => $this->shopLinkType,\n            'multishop_active' => $isMultiShopActive,\n            'has_actions' => !empty($this->actions),\n            'table_id' => isset($this->table_id) ? $this->table_id : null,\n            'table_dnd' => isset($table_dnd) ? $table_dnd : null,\n            'name' => isset($name) ? $name : null,\n            'name_id' => isset($name_id) ? $name_id : null,\n            'row_hover' => $this->row_hover,\n            'list_id' => isset($this->list_id) ? $this->list_id : $this->table,\n        ], $this->tpl_vars));\n\n        return $this->header_tpl->fetch();\n    }\n\n    public function hasBulkActions($has_value = false)\n    {\n        if ($this->force_show_bulk_actions) {\n            return true;\n        }\n\n        if (count($this->_list) <= 1 && !$has_value) {\n            return false;\n        }\n\n        if (isset($this->list_skip_actions) && count($this->list_skip_actions)\n            && isset($this->bulk_actions) && is_array($this->bulk_actions) && count($this->bulk_actions)) {\n            foreach ($this->bulk_actions as $action => $data) {\n                if (array_key_exists($action, $this->list_skip_actions)) {\n                    foreach ($this->_list as $key => $row) {\n                        if (!in_array($row[$this->identifier], $this->list_skip_actions[$action])) {\n                            return true;\n                        }\n                    }\n\n                    return false;\n                }\n            }\n        }\n\n        return !empty($this->bulk_actions);\n    }\n\n    /**\n     * Close list table and submit button.\n     */\n    public function displayListFooter()\n    {\n        if (!isset($this->list_id)) {\n            $this->list_id = $this->table;\n        }\n\n        $this->footer_tpl->assign(array_merge($this->tpl_vars, [\n            'current' => $this->currentIndex,\n            'list_id' => $this->list_id,\n        ]));\n\n        return $this->footer_tpl->fetch();\n    }\n\n    /**\n     * @param string|null $token\n     * @param int $id\n     *\n     * @return string\n     *\n     * @throws BuilderNotFoundException\n     * @throws PrestaShopException\n     */\n    protected function getViewLink($token, $id)\n    {\n        $linkBuilder = $this->linkBuilderFactory->getBuilderFor($this->table);\n        $parameters = $this->buildLinkParameters($token, $id);\n\n        return $linkBuilder->getViewLink($this->table, $parameters);\n    }\n\n    /**\n     * @param string|null $token\n     * @param int $id\n     *\n     * @return string\n     *\n     * @throws BuilderNotFoundException\n     * @throws PrestaShopException\n     */\n    protected function getEditLink($token, $id)\n    {\n        $linkBuilder = $this->linkBuilderFactory->getBuilderFor($this->table);\n        $parameters = $this->buildLinkParameters($token, $id);\n\n        return $linkBuilder->getEditLink($this->table, $parameters);\n    }\n\n    /**\n     * @param string|null $token\n     * @param int $id\n     *\n     * @return array\n     */\n    protected function buildLinkParameters($token, $id)\n    {\n        $parameters = [\n            $this->identifier => $id,\n            'current_index' => $this->currentIndex,\n            'token' => $token != null ? $token : $this->token,\n        ];\n        if ($this->page && $this->page > 1) {\n            $parameters['page'] = $this->page;\n        }\n\n        return $parameters;\n    }\n}\n", "<?php\n/**\n * 2007-2020 PrestaShop SA and Contributors\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * https://opensource.org/licenses/OSL-3.0\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@prestashop.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade PrestaShop to newer\n * versions in the future. If you wish to customize PrestaShop for your\n * needs please refer to https://www.prestashop.com for more information.\n *\n * @author    PrestaShop SA <contact@prestashop.com>\n * @copyright 2007-2020 PrestaShop SA and Contributors\n * @license   https://opensource.org/licenses/OSL-3.0 Open Software License (OSL 3.0)\n * International Registered Trademark & Property of PrestaShop SA\n */\n\n/**\n * @property AttributeGroup $object\n */\nclass AdminAttributesGroupsControllerCore extends AdminController\n{\n    public $bootstrap = true;\n    protected $id_attribute;\n    protected $position_identifier = 'id_attribute_group';\n    protected $attribute_name;\n\n    public function __construct()\n    {\n        $this->bootstrap = true;\n        $this->table = 'attribute_group';\n        $this->list_id = 'attribute_group';\n        $this->identifier = 'id_attribute_group';\n        $this->className = 'AttributeGroup';\n        $this->lang = true;\n        $this->_defaultOrderBy = 'position';\n\n        parent::__construct();\n\n        $this->fields_list = [\n            'id_attribute_group' => [\n                'title' => $this->trans('ID', [], 'Admin.Global'),\n                'align' => 'center',\n                'class' => 'fixed-width-xs',\n            ],\n            'name' => [\n                'title' => $this->trans('Name', [], 'Admin.Global'),\n                'filter_key' => 'b!name',\n                'align' => 'left',\n            ],\n            'count_values' => [\n                'title' => $this->trans('Values', [], 'Admin.Catalog.Feature'),\n                'align' => 'center',\n                'class' => 'fixed-width-xs',\n                'orderby' => false,\n                'search' => false,\n            ],\n            'position' => [\n                'title' => $this->trans('Position', [], 'Admin.Global'),\n                'filter_key' => 'a!position',\n                'position' => 'position',\n                'align' => 'center',\n                'class' => 'fixed-width-xs',\n            ],\n        ];\n\n        $this->bulk_actions = [\n            'delete' => [\n                'text' => $this->trans('Delete selected', [], 'Admin.Notifications.Info'),\n                'icon' => 'icon-trash',\n                'confirm' => $this->trans('Delete selected items?', [], 'Admin.Notifications.Info'),\n            ],\n        ];\n        $this->fieldImageSettings = ['name' => 'texture', 'dir' => 'co'];\n\n        $this->image_dir = 'co';\n    }\n\n    /**\n     * AdminController::renderList() override.\n     *\n     * @see AdminController::renderList()\n     */\n    public function renderList()\n    {\n        $this->addRowAction('view');\n        $this->addRowAction('edit');\n        $this->addRowAction('delete');\n\n        return parent::renderList();\n    }\n\n    public function renderView()\n    {\n        if (($id = Tools::getValue('id_attribute_group'))) {\n            $this->table = 'attribute';\n            $this->className = 'Attribute';\n            $this->identifier = 'id_attribute';\n            $this->position_identifier = 'id_attribute';\n            $this->position_group_identifier = 'id_attribute_group';\n            $this->list_id = 'attribute_values';\n            $this->lang = true;\n\n            $this->context->smarty->assign([\n                'current' => self::$currentIndex . '&id_attribute_group=' . (int) $id . '&viewattribute_group',\n            ]);\n\n            if (!Validate::isLoadedObject($obj = new AttributeGroup((int) $id))) {\n                $this->errors[] = $this->trans('An error occurred while updating the status for an object.', [], 'Admin.Catalog.Notification') .\n                    ' <b>' . $this->table . '</b> ' .\n                    $this->trans('(cannot load object)', [], 'Admin.Catalog.Notification');\n\n                return;\n            }\n\n            $this->attribute_name = $obj->name;\n            $this->fields_list = [\n                'id_attribute' => [\n                    'title' => $this->trans('ID', [], 'Admin.Global'),\n                    'align' => 'center',\n                    'class' => 'fixed-width-xs',\n                ],\n                'name' => [\n                    'title' => $this->trans('Value', [], 'Admin.Catalog.Feature'),\n                    'width' => 'auto',\n                    'filter_key' => 'b!name',\n                ],\n            ];\n\n            if ($obj->group_type == 'color') {\n                $this->fields_list['color'] = [\n                    'title' => $this->trans('Color', [], 'Admin.Catalog.Feature'),\n                    'filter_key' => 'a!color',\n                ];\n            }\n\n            $this->fields_list['position'] = [\n                'title' => $this->trans('Position', [], 'Admin.Global'),\n                'filter_key' => 'a!position',\n                'position' => 'position',\n                'class' => 'fixed-width-md',\n            ];\n\n            $this->addRowAction('edit');\n            $this->addRowAction('delete');\n\n            $this->_where = 'AND a.`id_attribute_group` = ' . (int) $id;\n            $this->_orderBy = 'position';\n\n            self::$currentIndex = self::$currentIndex . '&id_attribute_group=' . (int) $id . '&viewattribute_group';\n            $this->processFilter();\n\n            return parent::renderList();\n        }\n    }\n\n    /**\n     * AdminController::renderForm() override.\n     *\n     * @see AdminController::renderForm()\n     */\n    public function renderForm()\n    {\n        $this->table = 'attribute_group';\n        $this->identifier = 'id_attribute_group';\n\n        $group_type = [\n            [\n                'id' => 'select',\n                'name' => $this->trans('Drop-down list', [], 'Admin.Global'),\n            ],\n            [\n                'id' => 'radio',\n                'name' => $this->trans('Radio buttons', [], 'Admin.Global'),\n            ],\n            [\n                'id' => 'color',\n                'name' => $this->trans('Color or texture', [], 'Admin.Catalog.Feature'),\n            ],\n        ];\n\n        $this->fields_form = [\n            'legend' => [\n                'title' => $this->trans('Attributes', [], 'Admin.Catalog.Feature'),\n                'icon' => 'icon-info-sign',\n            ],\n            'input' => [\n                [\n                    'type' => 'text',\n                    'label' => $this->trans('Name', [], 'Admin.Global'),\n                    'name' => 'name',\n                    'lang' => true,\n                    'required' => true,\n                    'col' => '4',\n                    'hint' => $this->trans('Your internal name for this attribute.', [], 'Admin.Catalog.Help') . '&nbsp;' . $this->trans('Invalid characters:', [], 'Admin.Notifications.Info') . ' <>;=#{}',\n                ],\n                [\n                    'type' => 'text',\n                    'label' => $this->trans('Public name', [], 'Admin.Catalog.Feature'),\n                    'name' => 'public_name',\n                    'lang' => true,\n                    'required' => true,\n                    'col' => '4',\n                    'hint' => $this->trans('The public name for this attribute, displayed to the customers.', [], 'Admin.Catalog.Help') . '&nbsp;' . $this->trans('Invalid characters:', [], 'Admin.Notifications.Info') . ' <>;=#{}',\n                ],\n                [\n                    'type' => 'select',\n                    'label' => $this->trans('Attribute type', [], 'Admin.Catalog.Feature'),\n                    'name' => 'group_type',\n                    'required' => true,\n                    'options' => [\n                        'query' => $group_type,\n                        'id' => 'id',\n                        'name' => 'name',\n                    ],\n                    'col' => '2',\n                    'hint' => $this->trans('The way the attribute\\'s values will be presented to the customers in the product\\'s page.', [], 'Admin.Catalog.Help'),\n                ],\n            ],\n        ];\n\n        if (Shop::isFeatureActive()) {\n            $this->fields_form['input'][] = [\n                'type' => 'shop',\n                'label' => $this->trans('Shop association', [], 'Admin.Global'),\n                'name' => 'checkBoxShopAsso',\n            ];\n        }\n\n        $this->fields_form['submit'] = [\n            'title' => $this->trans('Save', [], 'Admin.Actions'),\n        ];\n\n        if (!($obj = $this->loadObject(true))) {\n            return;\n        }\n\n        return parent::renderForm();\n    }\n\n    public function renderFormAttributes()\n    {\n        $attributes_groups = AttributeGroup::getAttributesGroups($this->context->language->id);\n\n        $this->table = 'attribute';\n        $this->identifier = 'id_attribute';\n\n        $this->show_form_cancel_button = true;\n        $this->fields_form = [\n            'legend' => [\n                'title' => $this->trans('Values', [], 'Admin.Global'),\n                'icon' => 'icon-info-sign',\n            ],\n            'input' => [\n                [\n                    'type' => 'select',\n                    'label' => $this->trans('Attribute group', [], 'Admin.Catalog.Feature'),\n                    'name' => 'id_attribute_group',\n                    'required' => true,\n                    'options' => [\n                        'query' => $attributes_groups,\n                        'id' => 'id_attribute_group',\n                        'name' => 'name',\n                    ],\n                    'hint' => $this->trans('Choose the attribute group for this value.', [], 'Admin.Catalog.Help'),\n                ],\n                [\n                    'type' => 'text',\n                    'label' => $this->trans('Value', [], 'Admin.Global'),\n                    'name' => 'name',\n                    'lang' => true,\n                    'required' => true,\n                    'hint' => $this->trans('Invalid characters:', [], 'Admin.Notifications.Info') . ' <>;=#{}',\n                ],\n            ],\n        ];\n\n        if (Shop::isFeatureActive()) {\n            // We get all associated shops for all attribute groups, because we will disable group shops\n            // for attributes that the selected attribute group don't support\n            $sql = 'SELECT id_attribute_group, id_shop FROM ' . _DB_PREFIX_ . 'attribute_group_shop';\n            $associations = [];\n            foreach (Db::getInstance()->executeS($sql) as $row) {\n                $associations[$row['id_attribute_group']][] = $row['id_shop'];\n            }\n\n            $this->fields_form['input'][] = [\n                'type' => 'shop',\n                'label' => $this->trans('Shop association', [], 'Admin.Global'),\n                'name' => 'checkBoxShopAsso',\n                'values' => Shop::getTree(),\n            ];\n        } else {\n            $associations = [];\n        }\n\n        $this->fields_form['shop_associations'] = json_encode($associations);\n\n        $this->fields_form['input'][] = [\n            'type' => 'color',\n            'label' => $this->trans('Color', [], 'Admin.Catalog.Feature'),\n            'name' => 'color',\n            'hint' => $this->trans('Choose a color with the color picker, or enter an HTML color (e.g. \"lightblue\", \"#CC6600\").', [], 'Admin.Catalog.Help'),\n        ];\n\n        $this->fields_form['input'][] = [\n            'type' => 'file',\n            'label' => $this->trans('Texture', [], 'Admin.Catalog.Feature'),\n            'name' => 'texture',\n            'hint' => [\n                $this->trans('Upload an image file containing the color texture from your computer.', [], 'Admin.Catalog.Help'),\n                $this->trans('This will override the HTML color!', [], 'Admin.Catalog.Help'),\n            ],\n        ];\n\n        $this->fields_form['input'][] = [\n            'type' => 'current_texture',\n            'label' => $this->trans('Current texture', [], 'Admin.Catalog.Feature'),\n            'name' => 'current_texture',\n        ];\n\n        $this->fields_form['input'][] = [\n            'type' => 'closediv',\n            'name' => '',\n        ];\n\n        $this->fields_form['submit'] = [\n            'title' => $this->trans('Save', [], 'Admin.Actions'),\n        ];\n\n        $this->fields_form['buttons'] = [\n            'save-and-stay' => [\n                'title' => $this->trans('Save then add another value', [], 'Admin.Catalog.Feature'),\n                'name' => 'submitAdd' . $this->table . 'AndStay',\n                'type' => 'submit',\n                'class' => 'btn btn-default pull-right',\n                'icon' => 'process-icon-save',\n            ],\n        ];\n\n        $this->fields_value['id_attribute_group'] = (int) Tools::getValue('id_attribute_group');\n\n        // Override var of Controller\n        $this->table = 'attribute';\n        $this->className = 'Attribute';\n        $this->identifier = 'id_attribute';\n        $this->lang = true;\n        $this->tpl_folder = 'attributes/';\n\n        // Create object Attribute\n        if (!$obj = new Attribute((int) Tools::getValue($this->identifier))) {\n            return;\n        }\n\n        $str_attributes_groups = '';\n        foreach ($attributes_groups as $attribute_group) {\n            $str_attributes_groups .= '\"' . $attribute_group['id_attribute_group'] . '\" : ' . ($attribute_group['group_type'] == 'color' ? '1' : '0') . ', ';\n        }\n\n        $image = '../img/' . $this->fieldImageSettings['dir'] . '/' . (int) $obj->id . '.jpg';\n\n        $this->tpl_form_vars = [\n            'strAttributesGroups' => $str_attributes_groups,\n            'colorAttributeProperties' => Validate::isLoadedObject($obj) && $obj->isColorAttribute(),\n            'imageTextureExists' => file_exists(_PS_IMG_DIR_ . $this->fieldImageSettings['dir'] . '/' . (int) $obj->id . '.jpg'),\n            'imageTexture' => $image,\n            'imageTextureUrl' => Tools::safeOutput($_SERVER['REQUEST_URI']) . '&deleteImage=1',\n        ];\n\n        return parent::renderForm();\n    }\n\n    /**\n     * AdminController::init() override.\n     *\n     * @see AdminController::init()\n     */\n    public function init()\n    {\n        if (Tools::isSubmit('updateattribute')) {\n            $this->display = 'editAttributes';\n        } elseif (Tools::isSubmit('submitAddattribute')) {\n            $this->display = 'editAttributes';\n        } elseif (Tools::isSubmit('submitAddattribute_group')) {\n            $this->display = 'add';\n        }\n\n        parent::init();\n    }\n\n    /**\n     * Override processAdd to change SaveAndStay button action.\n     *\n     * @see classes/AdminControllerCore::processUpdate()\n     */\n    public function processAdd()\n    {\n        if ($this->table == 'attribute') {\n            /** @var AttributeGroup $object */\n            $object = new $this->className();\n            foreach (Language::getLanguages(false) as $language) {\n                if ($object->isAttribute(\n                    (int) Tools::getValue('id_attribute_group'),\n                    Tools::getValue('name_' . $language['id_lang']),\n                    $language['id_lang']\n                )) {\n                    $this->errors['name_' . $language['id_lang']] = $this->trans(\n                        'The attribute value \"%1$s\" already exist for %2$s language',\n                        [\n                            Tools::getValue('name_' . $language['id_lang']),\n                            $language['name'],\n                        ],\n                        'Admin.Catalog.Notification'\n                    );\n                }\n            }\n\n            if (!empty($this->errors)) {\n                return $object;\n            }\n        }\n\n        $object = parent::processAdd();\n\n        if (Tools::isSubmit('submitAdd' . $this->table . 'AndStay') && !count($this->errors)) {\n            if ($this->display == 'add') {\n                $this->redirect_after = self::$currentIndex . '&' . $this->identifier . '=&conf=3&update' . $this->table . '&token=' . $this->token;\n            } else {\n                $this->redirect_after = self::$currentIndex . '&id_attribute_group=' . (int) Tools::getValue('id_attribute_group') . '&conf=3&update' . $this->table . '&token=' . $this->token;\n            }\n        }\n\n        if (count($this->errors)) {\n            $this->setTypeAttribute();\n        }\n\n        return $object;\n    }\n\n    /**\n     * Override processUpdate to change SaveAndStay button action.\n     *\n     * @see classes/AdminControllerCore::processUpdate()\n     */\n    public function processUpdate()\n    {\n        $object = parent::processUpdate();\n\n        if (Tools::isSubmit('submitAdd' . $this->table . 'AndStay') && !count($this->errors)) {\n            if ($this->display == 'add') {\n                $this->redirect_after = self::$currentIndex . '&' . $this->identifier . '=&conf=3&update' . $this->table . '&token=' . $this->token;\n            } else {\n                $this->redirect_after = self::$currentIndex . '&' . $this->identifier . '=&id_attribute_group=' . (int) Tools::getValue('id_attribute_group') . '&conf=3&update' . $this->table . '&token=' . $this->token;\n            }\n        }\n\n        if (count($this->errors)) {\n            $this->setTypeAttribute();\n        }\n\n        if (Tools::isSubmit('updateattribute') || Tools::isSubmit('deleteattribute') || Tools::isSubmit('submitAddattribute') || Tools::isSubmit('submitBulkdeleteattribute')) {\n            Tools::clearColorListCache();\n        }\n\n        return $object;\n    }\n\n    /**\n     * AdminController::initContent() override.\n     *\n     * @see AdminController::initContent()\n     */\n    public function initContent()\n    {\n        if (Combination::isFeatureActive()) {\n            if ($this->display == 'edit' || $this->display == 'add') {\n                if (!($this->object = $this->loadObject(true))) {\n                    return;\n                }\n                $this->content .= $this->renderForm();\n            } elseif ($this->display == 'editAttributes') {\n                if (!$this->object = new Attribute((int) Tools::getValue('id_attribute'))) {\n                    return;\n                }\n\n                $this->content .= $this->renderFormAttributes();\n            } elseif ($this->display != 'view' && !$this->ajax) {\n                $this->content .= $this->renderList();\n                $this->content .= $this->renderOptions();\n                /* reset all attributes filter */\n                if (!Tools::getValue('submitFilterattribute_group', 0) && !Tools::getIsset('id_attribute_group')) {\n                    $this->processResetFilters('attribute_values');\n                }\n            } elseif ($this->display == 'view' && !$this->ajax) {\n                $this->content = $this->renderView();\n            }\n        } else {\n            $adminPerformanceUrl = $this->context->link->getAdminLink('AdminPerformance');\n            $url = '<a href=\"' . $adminPerformanceUrl . '#featuresDetachables\">' . $this->trans('Performance', [], 'Admin.Global') . '</a>';\n            $this->displayWarning($this->trans('This feature has been disabled. You can activate it here: %link%.', ['%link%' => $url], 'Admin.Catalog.Notification'));\n        }\n\n        $this->context->smarty->assign([\n            'table' => $this->table,\n            'current' => self::$currentIndex,\n            'token' => $this->token,\n            'content' => $this->content,\n        ]);\n    }\n\n    public function initPageHeaderToolbar()\n    {\n        if (Combination::isFeatureActive()) {\n            if (empty($this->display)) {\n                $this->page_header_toolbar_btn['new_attribute_group'] = [\n                    'href' => self::$currentIndex . '&addattribute_group&token=' . $this->token,\n                    'desc' => $this->trans('Add new attribute', [], 'Admin.Catalog.Feature'),\n                    'icon' => 'process-icon-new',\n                ];\n                $this->page_header_toolbar_btn['new_value'] = [\n                    'href' => self::$currentIndex . '&updateattribute&id_attribute_group=' . (int) Tools::getValue('id_attribute_group') . '&token=' . $this->token,\n                    'desc' => $this->trans('Add new value', [], 'Admin.Catalog.Feature'),\n                    'icon' => 'process-icon-new',\n                ];\n            }\n        }\n\n        if ($this->display == 'view') {\n            $this->page_header_toolbar_btn['new_value'] = [\n                'href' => self::$currentIndex . '&updateattribute&id_attribute_group=' . (int) Tools::getValue('id_attribute_group') . '&token=' . $this->token,\n                'desc' => $this->trans('Add new value', [], 'Admin.Catalog.Feature'),\n                'icon' => 'process-icon-new',\n            ];\n        }\n\n        parent::initPageHeaderToolbar();\n    }\n\n    public function initToolbar()\n    {\n        switch ($this->display) {\n            // @todo defining default buttons\n            case 'add':\n            case 'edit':\n            case 'editAttributes':\n                // Default save button - action dynamically handled in javascript\n                $this->toolbar_btn['save'] = [\n                    'href' => '#',\n                    'desc' => $this->trans('Save', [], 'Admin.Actions'),\n                ];\n\n                if ($this->display == 'editAttributes' && !$this->id_attribute) {\n                    $this->toolbar_btn['save-and-stay'] = [\n                        'short' => 'SaveAndStay',\n                        'href' => '#',\n                        'desc' => $this->trans('Save then add another value', [], 'Admin.Catalog.Help'),\n                        'force_desc' => true,\n                    ];\n                }\n\n                $this->toolbar_btn['back'] = [\n                    'href' => $this->context->link->getAdminLink('AdminAttributesGroups'),\n                    'desc' => $this->trans('Back to list', [], 'Admin.Actions'),\n                ];\n\n                break;\n            case 'view':\n                $this->toolbar_btn['newAttributes'] = [\n                    'href' => $this->context->link->getAdminLink('AdminAttributesGroups', true, [], ['updateattribute' => 1, 'id_attribute_group' => (int) Tools::getValue('id_attribute_group')]),\n                    'desc' => $this->trans('Add New Values', [], 'Admin.Catalog.Feature'),\n                    'class' => 'toolbar-new',\n                ];\n\n                $this->toolbar_btn['back'] = [\n                    'href' => $this->context->link->getAdminLink('AdminAttributesGroups'),\n                    'desc' => $this->trans('Back to list', [], 'Admin.Actions'),\n                ];\n\n                break;\n            default: // list\n                $this->toolbar_btn['new'] = [\n                    'href' => $this->context->link->getAdminLink('AdminAttributesGroups', true, [], ['add' . $this->table => 1]),\n                    'desc' => $this->trans('Add New Attributes', [], 'Admin.Catalog.Feature'),\n                ];\n                if ($this->can_import) {\n                    $this->toolbar_btn['import'] = [\n                        'href' => $this->context->link->getAdminLink('AdminImport', true, [], ['import_type' => 'combinations']),\n                        'desc' => $this->trans('Import', [], 'Admin.Actions'),\n                    ];\n                }\n        }\n    }\n\n    public function initToolbarTitle()\n    {\n        $bread_extended = $this->breadcrumbs;\n\n        switch ($this->display) {\n            case 'edit':\n                $bread_extended[] = $this->trans('Edit New Attribute', [], 'Admin.Catalog.Feature');\n\n                break;\n\n            case 'add':\n                $bread_extended[] = $this->trans('Add New Attribute', [], 'Admin.Catalog.Feature');\n\n                break;\n\n            case 'view':\n                if (Tools::getIsset('viewattribute_group')) {\n                    if (($id = Tools::getValue('id_attribute_group'))) {\n                        if (Validate::isLoadedObject($obj = new AttributeGroup((int) $id))) {\n                            $bread_extended[] = $obj->name[$this->context->employee->id_lang];\n                        }\n                    }\n                } else {\n                    $bread_extended[] = $this->attribute_name[$this->context->employee->id_lang];\n                }\n\n                break;\n\n            case 'editAttributes':\n                if ($this->id_attribute) {\n                    if (($id = Tools::getValue('id_attribute_group'))) {\n                        if (Validate::isLoadedObject($obj = new AttributeGroup((int) $id))) {\n                            $bread_extended[] = '<a href=\"' . Context::getContext()->link->getAdminLink('AdminAttributesGroups') . '&id_attribute_group=' . $id . '&viewattribute_group\">' . $obj->name[$this->context->employee->id_lang] . '</a>';\n                        }\n                        if (Validate::isLoadedObject($obj = new Attribute((int) $this->id_attribute))) {\n                            $bread_extended[] = $this->trans(\n                                'Edit: %value%',\n                                [\n                                    '%value%' => $obj->name[$this->context->employee->id_lang],\n                                ],\n                                'Admin.Catalog.Feature'\n                            );\n                        }\n                    } else {\n                        $bread_extended[] = $this->trans('Edit Value', [], 'Admin.Catalog.Feature');\n                    }\n                } else {\n                    $bread_extended[] = $this->trans('Add New Value', [], 'Admin.Catalog.Feature');\n                }\n\n                break;\n        }\n\n        if (count($bread_extended) > 0) {\n            $this->addMetaTitle($bread_extended[count($bread_extended) - 1]);\n        }\n\n        $this->toolbar_title = $bread_extended;\n    }\n\n    public function initProcess()\n    {\n        $this->setTypeAttribute();\n\n        if (Tools::getIsset('viewattribute_group')) {\n            $this->list_id = 'attribute_values';\n\n            if (isset($_POST['submitReset' . $this->list_id])) {\n                $this->processResetFilters();\n            }\n        } else {\n            $this->list_id = 'attribute_group';\n        }\n\n        parent::initProcess();\n\n        if ($this->table == 'attribute') {\n            $this->display = 'editAttributes';\n            $this->id_attribute = (int) Tools::getValue('id_attribute');\n        }\n    }\n\n    protected function setTypeAttribute()\n    {\n        if (Tools::isSubmit('updateattribute') || Tools::isSubmit('deleteattribute') || Tools::isSubmit('submitAddattribute') || Tools::isSubmit('submitBulkdeleteattribute')) {\n            $this->table = 'attribute';\n            $this->className = 'Attribute';\n            $this->identifier = 'id_attribute';\n\n            if ($this->display == 'edit') {\n                $this->display = 'editAttributes';\n            }\n        }\n    }\n\n    public function processPosition()\n    {\n        if (Tools::getIsset('viewattribute_group')) {\n            $object = new Attribute((int) Tools::getValue('id_attribute'));\n            self::$currentIndex = self::$currentIndex . '&viewattribute_group';\n        } else {\n            $object = new AttributeGroup((int) Tools::getValue('id_attribute_group'));\n        }\n\n        if (!Validate::isLoadedObject($object)) {\n            $this->errors[] = $this->trans('An error occurred while updating the status for an object.', [], 'Admin.Notifications.Error') .\n                ' <b>' . $this->table . '</b> ' . $this->trans('(cannot load object)', [], 'Admin.Notifications.Error');\n        } elseif (!$object->updatePosition((int) Tools::getValue('way'), (int) Tools::getValue('position'))) {\n            $this->errors[] = $this->trans('Failed to update the position.', [], 'Admin.Notifications.Error');\n        } else {\n            $id_identifier_str = ($id_identifier = (int) Tools::getValue($this->identifier)) ? '&' . $this->identifier . '=' . $id_identifier : '';\n            $redirect = self::$currentIndex . '&' . $this->table . 'Orderby=position&' . $this->table . 'Orderway=asc&conf=5' . $id_identifier_str . '&token=' . $this->token;\n            $this->redirect_after = $redirect;\n        }\n\n        return $object;\n    }\n\n    /**\n     * Call the right method for creating or updating object.\n     *\n     * @return mixed\n     */\n    public function processSave()\n    {\n        if ($this->display == 'add' || $this->display == 'edit') {\n            $this->identifier = 'id_attribute_group';\n        }\n\n        if (!$this->id_object) {\n            return $this->processAdd();\n        } else {\n            return $this->processUpdate();\n        }\n    }\n\n    public function postProcess()\n    {\n        if (!Combination::isFeatureActive()) {\n            return;\n        }\n\n        if (!Tools::getValue($this->identifier) && Tools::getValue('id_attribute') && !Tools::getValue('attributeOrderby')) {\n            // Override var of Controller\n            $this->table = 'attribute';\n            $this->className = 'Attribute';\n            $this->identifier = 'id_attribute';\n        }\n\n        /* set location with current index */\n        if (Tools::getIsset('id_attribute_group') && Tools::getIsset('viewattribute_group')) {\n            self::$currentIndex = self::$currentIndex . '&id_attribute_group=' . Tools::getValue('id_attribute_group', 0) . '&viewattribute_group';\n        }\n\n        // If it's an attribute, load object Attribute()\n        if (Tools::getValue('updateattribute') || Tools::isSubmit('deleteattribute') || Tools::isSubmit('submitAddattribute')) {\n            if (true !== $this->access('edit')) {\n                $this->errors[] = $this->trans('You do not have permission to edit this.', [], 'Admin.Notifications.Error');\n\n                return;\n            } elseif (!$object = new Attribute((int) Tools::getValue($this->identifier))) {\n                $this->errors[] = $this->trans('An error occurred while updating the status for an object.', [], 'Admin.Notifications.Error') .\n                    ' <b>' . $this->table . '</b> ' .\n                    $this->trans('(cannot load object)', [], 'Admin.Notifications.Error');\n\n                return;\n            }\n\n            if (Tools::getValue('position') !== false && Tools::getValue('id_attribute')) {\n                $_POST['id_attribute_group'] = $object->id_attribute_group;\n                if (!$object->updatePosition((int) Tools::getValue('way'), (int) Tools::getValue('position'))) {\n                    $this->errors[] = $this->trans('Failed to update the position.', [], 'Admin.Notifications.Error');\n                } else {\n                    Tools::redirectAdmin(self::$currentIndex . '&conf=5&token=' . Tools::getAdminTokenLite('AdminAttributesGroups') . '#details_details_' . $object->id_attribute_group);\n                }\n            } elseif (Tools::isSubmit('deleteattribute') && Tools::getValue('id_attribute')) {\n                if (!$object->delete()) {\n                    $this->errors[] = $this->trans('Failed to delete the attribute.', [], 'Admin.Catalog.Notification');\n                } else {\n                    Tools::redirectAdmin(self::$currentIndex . '&conf=1&token=' . Tools::getAdminTokenLite('AdminAttributesGroups'));\n                }\n            } elseif (Tools::isSubmit('submitAddattribute')) {\n                Hook::exec('actionObjectAttributeAddBefore');\n                $this->action = 'save';\n                $id_attribute = (int) Tools::getValue('id_attribute');\n                // Adding last position to the attribute if not exist\n                if ($id_attribute <= 0) {\n                    $sql = 'SELECT `position`+1\n\t\t\t\t\t\t\tFROM `' . _DB_PREFIX_ . 'attribute`\n\t\t\t\t\t\t\tWHERE `id_attribute_group` = ' . (int) Tools::getValue('id_attribute_group') . '\n\t\t\t\t\t\t\tORDER BY position DESC';\n                    // set the position of the new group attribute in $_POST for postProcess() method\n                    $_POST['position'] = Db::getInstance(_PS_USE_SQL_SLAVE_)->getValue($sql);\n                }\n                $_POST['id_parent'] = 0;\n                $this->processSave($this->token);\n            }\n        } else {\n            if (Tools::isSubmit('submitBulkdelete' . $this->table)) {\n                if ($this->access('delete')) {\n                    if (isset($_POST[$this->list_id . 'Box'])) {\n                        /** @var AttributeGroup $object */\n                        $object = new $this->className();\n                        if ($object->deleteSelection($_POST[$this->list_id . 'Box'])) {\n                            AttributeGroup::cleanPositions();\n                            Tools::redirectAdmin(self::$currentIndex . '&conf=2' . '&token=' . $this->token);\n                        }\n                        $this->errors[] = $this->trans('An error occurred while deleting this selection.', [], 'Admin.Notifications.Error');\n                    } else {\n                        $this->errors[] = $this->trans('You must select at least one element to delete.', [], 'Admin.Notifications.Error');\n                    }\n                } else {\n                    $this->errors[] = $this->trans('You do not have permission to delete this.', [], 'Admin.Notifications.Error');\n                }\n                // clean position after delete\n                AttributeGroup::cleanPositions();\n            } elseif (Tools::isSubmit('submitAdd' . $this->table)) {\n                Hook::exec('actionObjectAttributeGroupAddBefore');\n                $id_attribute_group = (int) Tools::getValue('id_attribute_group');\n                // Adding last position to the attribute if not exist\n                if ($id_attribute_group <= 0) {\n                    $sql = 'SELECT `position`+1\n\t\t\t\t\t\t\tFROM `' . _DB_PREFIX_ . 'attribute_group`\n\t\t\t\t\t\t\tORDER BY position DESC';\n                    // set the position of the new group attribute in $_POST for postProcess() method\n                    $_POST['position'] = Db::getInstance(_PS_USE_SQL_SLAVE_)->getValue($sql);\n                }\n                // clean \\n\\r characters\n                foreach ($_POST as $key => $value) {\n                    if (preg_match('/^name_/Ui', $key)) {\n                        $_POST[$key] = str_replace('\\n', '', str_replace('\\r', '', $value));\n                    }\n                }\n                parent::postProcess();\n            } else {\n                parent::postProcess();\n                if (Tools::isSubmit('delete' . $this->table)) {\n                    AttributeGroup::cleanPositions();\n                }\n            }\n        }\n    }\n\n    /**\n     * AdminController::getList() override.\n     *\n     * @see AdminController::getList()\n     *\n     * @param int $id_lang\n     * @param string|null $order_by\n     * @param string|null $order_way\n     * @param int $start\n     * @param int|null $limit\n     * @param int|bool $id_lang_shop\n     *\n     * @throws PrestaShopException\n     */\n    public function getList($id_lang, $order_by = null, $order_way = null, $start = 0, $limit = null, $id_lang_shop = false)\n    {\n        parent::getList($id_lang, $order_by, $order_way, $start, $limit, $id_lang_shop);\n\n        if ($this->display == 'view') {\n            foreach ($this->_list as &$list) {\n                if (file_exists(_PS_IMG_DIR_ . $this->fieldImageSettings['dir'] . '/' . (int) $list['id_attribute'] . '.jpg')) {\n                    if (!isset($list['color']) || !is_array($list['color'])) {\n                        $list['color'] = [];\n                    }\n                    $list['color']['texture'] = '../img/' . $this->fieldImageSettings['dir'] . '/' . (int) $list['id_attribute'] . '.jpg';\n                }\n            }\n        } else {\n            $nb_items = count($this->_list);\n            for ($i = 0; $i < $nb_items; ++$i) {\n                $item = &$this->_list[$i];\n\n                $query = new DbQuery();\n                $query->select('COUNT(a.id_attribute) as count_values');\n                $query->from('attribute', 'a');\n                $query->join(Shop::addSqlAssociation('attribute', 'a'));\n                $query->where('a.id_attribute_group =' . (int) $item['id_attribute_group']);\n                $query->groupBy('attribute_shop.id_shop');\n                $query->orderBy('count_values DESC');\n                $item['count_values'] = (int) Db::getInstance(_PS_USE_SQL_SLAVE_)->getValue($query);\n                unset($query);\n            }\n        }\n    }\n\n    /**\n     * Overrides parent to delete items from sublist.\n     *\n     * @return mixed\n     */\n    public function processBulkDelete()\n    {\n        // If we are deleting attributes instead of attribute_groups\n        if (Tools::getIsset('attributeBox')) {\n            $this->className = 'Attribute';\n            $this->table = 'attribute';\n            $this->boxes = Tools::getValue($this->table . 'Box');\n        }\n\n        $result = parent::processBulkDelete();\n        // Restore vars\n        $this->className = 'AttributeGroup';\n        $this->table = 'attribute_group';\n\n        return $result;\n    }\n\n    /* Modify group attribute position */\n    public function ajaxProcessUpdateGroupsPositions()\n    {\n        $way = (int) Tools::getValue('way');\n        $id_attribute_group = (int) Tools::getValue('id_attribute_group');\n        $positions = Tools::getValue('attribute_group');\n\n        $new_positions = [];\n        foreach ($positions as $v) {\n            if (count(explode('_', $v)) == 4) {\n                $new_positions[] = $v;\n            }\n        }\n\n        foreach ($new_positions as $position => $value) {\n            $pos = explode('_', $value);\n\n            if (isset($pos[2]) && (int) $pos[2] === $id_attribute_group) {\n                if ($group_attribute = new AttributeGroup((int) $pos[2])) {\n                    if (isset($position) && $group_attribute->updatePosition($way, $position)) {\n                        echo 'ok position ' . (int) $position . ' for attribute group ' . (int) $pos[2] . '\\r\\n';\n                    } else {\n                        echo '{\"hasError\" : true, \"errors\" : \"Can not update the ' . (int) $id_attribute_group . ' attribute group to position ' . (int) $position . ' \"}';\n                    }\n                } else {\n                    echo '{\"hasError\" : true, \"errors\" : \"The (' . (int) $id_attribute_group . ') attribute group cannot be loaded.\"}';\n                }\n\n                break;\n            }\n        }\n    }\n\n    /* Modify attribute position */\n    public function ajaxProcessUpdateAttributesPositions()\n    {\n        $way = (int) Tools::getValue('way');\n        $id_attribute = (int) Tools::getValue('id_attribute');\n        $id_attribute_group = (int) Tools::getValue('id_attribute_group');\n        $positions = Tools::getValue('attribute');\n\n        if (is_array($positions)) {\n            foreach ($positions as $position => $value) {\n                $pos = explode('_', $value);\n\n                if ((isset($pos[1], $pos[2])) && (int) $pos[2] === $id_attribute) {\n                    if ($attribute = new Attribute((int) $pos[2])) {\n                        if (isset($position) && $attribute->updatePosition($way, $position)) {\n                            echo 'ok position ' . (int) $position . ' for attribute ' . (int) $pos[2] . '\\r\\n';\n                        } else {\n                            echo '{\"hasError\" : true, \"errors\" : \"Can not update the ' . (int) $id_attribute . ' attribute to position ' . (int) $position . ' \"}';\n                        }\n                    } else {\n                        echo '{\"hasError\" : true, \"errors\" : \"The (' . (int) $id_attribute . ') attribute cannot be loaded\"}';\n                    }\n\n                    break;\n                }\n            }\n        }\n    }\n}\n"], "fixing_code": ["<?php\n/**\n * 2007-2020 PrestaShop SA and Contributors\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * https://opensource.org/licenses/OSL-3.0\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@prestashop.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade PrestaShop to newer\n * versions in the future. If you wish to customize PrestaShop for your\n * needs please refer to https://www.prestashop.com for more information.\n *\n * @author    PrestaShop SA <contact@prestashop.com>\n * @copyright 2007-2020 PrestaShop SA and Contributors\n * @license   https://opensource.org/licenses/OSL-3.0 Open Software License (OSL 3.0)\n * International Registered Trademark & Property of PrestaShop SA\n */\nuse PrestaShop\\PrestaShop\\Adapter\\ContainerBuilder;\nuse PrestaShop\\PrestaShop\\Core\\Feature\\TokenInUrls;\nuse PrestaShop\\PrestaShop\\Core\\Localization\\Locale;\nuse PrestaShop\\PrestaShop\\Core\\Localization\\Specification\\Number as NumberSpecification;\nuse PrestaShop\\PrestaShop\\Core\\Localization\\Specification\\Price as PriceSpecification;\n\nclass AdminControllerCore extends Controller\n{\n    /** @var string */\n    public $path;\n\n    /** @var string */\n    public static $currentIndex;\n\n    /** @var string */\n    public $content;\n\n    /** @var array */\n    public $warnings = [];\n\n    /** @var array */\n    public $informations = [];\n\n    /** @var array */\n    public $confirmations = [];\n\n    /** @var string|false */\n    public $shopShareDatas = false;\n\n    /** @var array */\n    public $_languages = [];\n\n    /** @var int */\n    public $default_form_language;\n\n    /** @var bool */\n    public $allow_employee_form_lang;\n\n    /** @var string */\n    public $layout = 'layout.tpl';\n\n    /** @var bool */\n    public $bootstrap = false;\n\n    /** @var string|array */\n    protected $meta_title = [];\n\n    /** @var string */\n    public $template = 'content.tpl';\n\n    /** @var string Associated table name */\n    public $table = 'configuration';\n\n    /** @var string */\n    public $list_id;\n\n    /** @var string|false Object identifier inside the associated table */\n    protected $identifier = false;\n\n    /** @var string */\n    protected $identifier_name = 'name';\n\n    /** @var string Associated object class name */\n    public $className;\n\n    /** @var array */\n    public $tabAccess;\n\n    /** @var int Tab id */\n    public $id = -1;\n\n    /** @var bool */\n    public $required_database = false;\n\n    /** @var string Security token */\n    public $token;\n\n    /** @var string \"shop\" or \"group_shop\" */\n    public $shopLinkType;\n\n    /** @var string Default ORDER BY clause when $_orderBy is not defined */\n    protected $_defaultOrderBy = false;\n\n    /** @var string */\n    protected $_defaultOrderWay = 'ASC';\n\n    /** @var array */\n    public $tpl_form_vars = [];\n\n    /** @var array */\n    public $tpl_list_vars = [];\n\n    /** @var array */\n    public $tpl_delete_link_vars = [];\n\n    /** @var array */\n    public $tpl_option_vars = [];\n\n    /** @var array */\n    public $tpl_view_vars = [];\n\n    /** @var array */\n    public $tpl_required_fields_vars = [];\n\n    /** @var string|null */\n    public $base_tpl_view = null;\n\n    /** @var string|null */\n    public $base_tpl_form = null;\n\n    /** @var bool If you want more fieldsets in the form */\n    public $multiple_fieldsets = false;\n\n    /** @var array|false */\n    public $fields_value = false;\n\n    /** @var array Errors displayed after post processing */\n    public $errors = [];\n\n    /** @var bool Define if the header of the list contains filter and sorting links or not */\n    protected $list_simple_header;\n\n    /** @var array List to be generated */\n    protected $fields_list;\n\n    /** @var array Modules list filters */\n    protected $filter_modules_list = null;\n\n    /** @var array Modules list filters */\n    protected $modules_list = [];\n\n    /** @var array Edit form to be generated */\n    protected $fields_form;\n\n    /** @var array Override of $fields_form */\n    protected $fields_form_override;\n\n    /** @var string Override form action */\n    protected $submit_action;\n\n    /** @var array List of option forms to be generated */\n    protected $fields_options = [];\n\n    /** @var string */\n    protected $shopLink;\n\n    /** @var string SQL query */\n    protected $_listsql = '';\n\n    /** @var array Cache for query results */\n    protected $_list = [];\n\n    /** @var string MySQL error */\n    protected $_list_error;\n\n    /** @var string|array Toolbar title */\n    protected $toolbar_title;\n\n    /** @var array List of toolbar buttons */\n    protected $toolbar_btn = null;\n\n    /** @var bool Scrolling toolbar */\n    protected $toolbar_scroll = true;\n\n    /** @var bool Set to false to hide toolbar and page title */\n    protected $show_toolbar = true;\n\n    /** @var bool Set to true to show toolbar and page title for options */\n    protected $show_toolbar_options = false;\n\n    /** @var int Number of results in list */\n    protected $_listTotal = 0;\n\n    /** @var bool Automatically join language table if true */\n    public $lang = false;\n\n    /** @var array WHERE clause determined by filter fields */\n    protected $_filter;\n\n    /** @var string */\n    protected $_filterHaving;\n\n    /** @var array Temporary SQL table WHERE clause determined by filter fields */\n    protected $_tmpTableFilter = '';\n\n    /** @var array Number of results in list per page (used in select field) */\n    protected $_pagination = [20, 50, 100, 300, 1000];\n\n    /** @var int Default number of results in list per page */\n    protected $_default_pagination = 50;\n\n    /** @var string ORDER BY clause determined by field/arrows in list header */\n    protected $_orderBy;\n\n    /** @var string Order way (ASC, DESC) determined by arrows in list header */\n    protected $_orderWay;\n\n    /** @var array List of available actions for each list row - default actions are view, edit, delete, duplicate */\n    protected $actions_available = ['view', 'edit', 'duplicate', 'delete'];\n\n    /** @var array List of required actions for each list row */\n    protected $actions = [];\n\n    /** @var array List of row ids associated with a given action for witch this action have to not be available */\n    protected $list_skip_actions = [];\n\n    /** @var bool Don't show header & footer */\n    protected $lite_display = false;\n\n    /** @var bool List content lines are clickable if true */\n    protected $list_no_link = false;\n\n    /** @var bool */\n    protected $allow_export = false;\n\n    /** @var array Cache for translations */\n    public static $cache_lang = [];\n\n    /** @var array Required_fields to display in the Required Fields form */\n    public $required_fields = [];\n\n    /** @var HelperList */\n    protected $helper;\n\n    /** @var bool */\n    private $allowAnonymous = false;\n\n    /** @var int DELETE access level */\n    const LEVEL_DELETE = 4;\n\n    /** @var int ADD access level */\n    const LEVEL_ADD = 3;\n\n    /** @var int EDIT access level */\n    const LEVEL_EDIT = 2;\n\n    /** @var int VIEW access level */\n    const LEVEL_VIEW = 1;\n\n    /**\n     * Actions to execute on multiple selections.\n     *\n     * Usage:\n     *\n     * array(\n     *      'actionName' => array(\n     *      'text' => $this->trans('Message displayed on the submit button (mandatory)'),\n     *      'confirm' => $this->trans('If set, this confirmation message will pop-up (optional)')),\n     *      'anotherAction' => array(...)\n     * );\n     *\n     * If your action is named 'actionName', you need to have a method named bulkactionName() that will be executed when the button is clicked.\n     *\n     * @var array\n     */\n    protected $bulk_actions;\n\n    /** @var array Ids of the rows selected */\n    protected $boxes;\n\n    /** @var string Do not automatically select * anymore but select only what is necessary */\n    protected $explicitSelect = false;\n\n    /** @var string Add fields into data query to display list */\n    protected $_select;\n\n    /** @var string Join tables into data query to display list */\n    protected $_join;\n\n    /** @var string Add conditions into data query to display list */\n    protected $_where;\n\n    /** @var string Group rows into data query to display list */\n    protected $_group;\n\n    /** @var string Having rows into data query to display list */\n    protected $_having;\n\n    /** @var string Use SQL_CALC_FOUND_ROWS / FOUND_ROWS to count the number of records */\n    protected $_use_found_rows = true;\n\n    /** @var bool */\n    protected $is_cms = false;\n\n    /** @var string Identifier to use for changing positions in lists (can be omitted if positions cannot be changed) */\n    protected $position_identifier;\n\n    /** @var string|int */\n    protected $position_group_identifier;\n\n    /** @var bool Table records are not deleted but marked as deleted if set to true */\n    protected $deleted = false;\n\n    /** @var bool Is a list filter set */\n    protected $filter;\n\n    /** @var bool */\n    protected $noLink;\n\n    /** @var bool|null */\n    protected $specificConfirmDelete = null;\n\n    /** @var bool */\n    protected $colorOnBackground;\n\n    /** @var bool If true, activates color on hover */\n    protected $row_hover = true;\n\n    /** @var string Action to perform : 'edit', 'view', 'add', ... */\n    protected $action;\n\n    /** @var string */\n    protected $display;\n\n    /** @var array */\n    protected $tab_modules_list = ['default_list' => [], 'slider_list' => []];\n\n    /** @var string */\n    public $tpl_folder;\n\n    /** @var string */\n    protected $bo_theme;\n\n    /** @var bool Redirect or not after a creation */\n    protected $_redirect = true;\n\n    /** @var array Name and directory where class image are located */\n    public $fieldImageSettings = [];\n\n    /** @var string Image type */\n    public $imageType = 'jpg';\n\n    /** @var ObjectModel Instantiation of the class associated with the AdminController */\n    protected $object;\n\n    /** @var int Current object ID */\n    protected $id_object;\n\n    /** @var string Current controller name without suffix */\n    public $controller_name;\n\n    /** @var int */\n    public $multishop_context = -1;\n\n    /** @var false */\n    public $multishop_context_group = true;\n\n    /** @var array Current breadcrumb position as an array of tab names */\n    protected $breadcrumbs;\n\n    /** @var bool Bootstrap variable */\n    public $show_page_header_toolbar = false;\n\n    /** @var string Bootstrap variable */\n    public $page_header_toolbar_title;\n\n    /** @var array|Traversable Bootstrap variable */\n    public $page_header_toolbar_btn = [];\n\n    /** @var bool Bootstrap variable */\n    public $show_form_cancel_button;\n\n    /** @var string */\n    public $admin_webpath;\n\n    /** @var array */\n    protected $list_natives_modules = [];\n\n    /** @var array */\n    protected $list_partners_modules = [];\n\n    /** @var array */\n    public $modals = [];\n\n    /** @var bool */\n    protected $logged_on_addons = false;\n\n    /** @var bool if logged employee has access to AdminImport */\n    protected $can_import = false;\n\n    /** @var string */\n    protected $tabSlug;\n\n    /** @var int Auth cookie lifetime */\n    const AUTH_COOKIE_LIFETIME = 3600;\n\n    public function __construct($forceControllerName = '', $default_theme_name = 'default')\n    {\n        global $timer_start;\n        $this->timer_start = $timer_start;\n\n        $this->controller_type = 'admin';\n        $this->controller_name = !empty($forceControllerName) ? $forceControllerName : get_class($this);\n        if (strpos($this->controller_name, 'ControllerOverride')) {\n            $this->controller_name = substr($this->controller_name, 0, -18);\n        }\n        if (strpos($this->controller_name, 'Controller')) {\n            $this->controller_name = substr($this->controller_name, 0, -10);\n        }\n        parent::__construct();\n\n        if ($this->multishop_context == -1) {\n            $this->multishop_context = Shop::CONTEXT_ALL | Shop::CONTEXT_GROUP | Shop::CONTEXT_SHOP;\n        }\n\n        if (defined('_PS_BO_ALL_THEMES_DIR_')) {\n            if (defined('_PS_BO_DEFAULT_THEME_') && _PS_BO_DEFAULT_THEME_\n                && @filemtime(_PS_BO_ALL_THEMES_DIR_ . _PS_BO_DEFAULT_THEME_ . DIRECTORY_SEPARATOR . 'template')) {\n                $default_theme_name = _PS_BO_DEFAULT_THEME_;\n            }\n\n            $this->bo_theme = $default_theme_name;\n            if (!@filemtime(_PS_BO_ALL_THEMES_DIR_ . $this->bo_theme . DIRECTORY_SEPARATOR . 'template')) {\n                $this->bo_theme = 'default';\n            }\n\n            $this->context->employee->bo_theme = (\n                Validate::isLoadedObject($this->context->employee)\n                && $this->context->employee->bo_theme\n            ) ? $this->context->employee->bo_theme : $this->bo_theme;\n\n            $this->bo_css = (\n                Validate::isLoadedObject($this->context->employee)\n                && $this->context->employee->bo_css\n            ) ? $this->context->employee->bo_css : 'theme.css';\n            $this->context->employee->bo_css = $this->bo_css;\n\n            $adminThemeCSSFile = _PS_BO_ALL_THEMES_DIR_ . $this->bo_theme . DIRECTORY_SEPARATOR . 'public' . DIRECTORY_SEPARATOR . $this->bo_css;\n\n            if (file_exists($adminThemeCSSFile)) {\n                $this->bo_css = 'theme.css';\n            }\n\n            $this->context->smarty->setTemplateDir([\n                _PS_BO_ALL_THEMES_DIR_ . $this->bo_theme . DIRECTORY_SEPARATOR . 'template',\n                _PS_OVERRIDE_DIR_ . 'controllers' . DIRECTORY_SEPARATOR . 'admin' . DIRECTORY_SEPARATOR . 'templates',\n            ]);\n        }\n\n        $this->id = Tab::getIdFromClassName($this->controller_name);\n        $this->token = Tools::getAdminToken($this->controller_name . (int) $this->id . (int) $this->context->employee->id);\n\n        $this->_conf = [\n            1 => $this->trans('Successful deletion.', [], 'Admin.Notifications.Success'),\n            2 => $this->trans('The selection has been successfully deleted.', [], 'Admin.Notifications.Success'),\n            3 => $this->trans('Successful creation.', [], 'Admin.Notifications.Success'),\n            4 => $this->trans('Successful update.', [], 'Admin.Notifications.Success'),\n            5 => $this->trans('The status has been successfully updated.', [], 'Admin.Notifications.Success'),\n            6 => $this->trans('The settings have been successfully updated.', [], 'Admin.Notifications.Success'),\n            7 => $this->trans('The image was successfully deleted.', [], 'Admin.Notifications.Success'),\n            8 => $this->trans('The module was successfully downloaded.', [], 'Admin.Modules.Notification'),\n            9 => $this->trans('The thumbnails were successfully regenerated.', [], 'Admin.Notifications.Success'),\n            10 => $this->trans('The message was successfully sent to the customer.', [], 'Admin.Orderscustomers.Notification'),\n            11 => $this->trans('Comment successfully added.', [], 'Admin.Notifications.Success'),\n            12 => $this->trans('Module(s) installed successfully.', [], 'Admin.Modules.Notification'),\n            13 => $this->trans('Module(s) uninstalled successfully.', [], 'Admin.Modules.Notification'),\n            14 => $this->trans('The translation was successfully copied.', [], 'Admin.International.Notification'),\n            15 => $this->trans('The translations have been successfully added.', [], 'Admin.International.Notification'),\n            16 => $this->trans('The module transplanted successfully to the hook.', [], 'Admin.Modules.Notification'),\n            17 => $this->trans('The module was successfully removed from the hook.', [], 'Admin.Modules.Notification'),\n            18 => $this->trans('Successful upload.', [], 'Admin.Notifications.Success'),\n            19 => $this->trans('Duplication was completed successfully.', [], 'Admin.Notifications.Success'),\n            20 => $this->trans('The translation was added successfully, but the language has not been created.', [], 'Admin.International.Notification'),\n            21 => $this->trans('Module reset successfully.', [], 'Admin.Modules.Notification'),\n            22 => $this->trans('Module deleted successfully.', [], 'Admin.Modules.Notification'),\n            23 => $this->trans('Localization pack imported successfully.', [], 'Admin.International.Notification'),\n            24 => $this->trans('Localization pack imported successfully.', [], 'Admin.International.Notification'),\n            25 => $this->trans('The selected images have successfully been moved.', [], 'Admin.Notifications.Success'),\n            26 => $this->trans('Your cover image selection has been saved.', [], 'Admin.Notifications.Success'),\n            27 => $this->trans('The image\\'s shop association has been modified.', [], 'Admin.Notifications.Success'),\n            28 => $this->trans('A zone has been assigned to the selection successfully.', [], 'Admin.Notifications.Success'),\n            29 => $this->trans('Successful upgrade.', [], 'Admin.Notifications.Success'),\n            30 => $this->trans('A partial refund was successfully created.', [], 'Admin.Orderscustomers.Notification'),\n            31 => $this->trans('The discount was successfully generated.', [], 'Admin.Catalog.Notification'),\n            32 => $this->trans('Successfully signed in to PrestaShop Addons.', [], 'Admin.Modules.Notification'),\n        ];\n\n        $this->_error = [\n            1 => $this->trans(\n                'The root category of the shop %shop% is not associated with the current shop. You can\\'t access this page. Please change the root category of the shop.',\n                [\n                    '%shop%' => $this->context->shop->name,\n                ],\n                'Admin.Catalog.Notification'\n            ),\n        ];\n\n        if (!$this->identifier) {\n            $this->identifier = 'id_' . $this->table;\n        }\n        if (!$this->_defaultOrderBy) {\n            $this->_defaultOrderBy = $this->identifier;\n        }\n\n        // Fix for homepage\n        if ($this->controller_name == 'AdminDashboard') {\n            $_POST['token'] = $this->token;\n        }\n\n        if (!Shop::isFeatureActive()) {\n            $this->shopLinkType = '';\n        }\n\n        //$this->base_template_folder = _PS_BO_ALL_THEMES_DIR_.$this->bo_theme.'/template';\n        $this->override_folder = Tools::toUnderscoreCase(substr($this->controller_name, 5)) . '/';\n        // Get the name of the folder containing the custom tpl files\n        $this->tpl_folder = Tools::toUnderscoreCase(substr($this->controller_name, 5)) . '/';\n\n        $this->initShopContext();\n\n        if (defined('_PS_ADMIN_DIR_')) {\n            $this->admin_webpath = str_ireplace(_PS_CORE_DIR_, '', _PS_ADMIN_DIR_);\n            $this->admin_webpath = preg_replace('/^' . preg_quote(DIRECTORY_SEPARATOR, '/') . '/', '', $this->admin_webpath);\n        }\n\n        // Check if logged on Addons\n        $this->logged_on_addons = false;\n        if (isset($this->context->cookie->username_addons, $this->context->cookie->password_addons) && !empty($this->context->cookie->username_addons) && !empty($this->context->cookie->password_addons)) {\n            $this->logged_on_addons = true;\n        }\n\n        // Set context mode\n        if (defined('_PS_HOST_MODE_') && _PS_HOST_MODE_) {\n            if (isset($this->context->cookie->is_contributor) && (int) $this->context->cookie->is_contributor === 1) {\n                $this->context->mode = Context::MODE_HOST_CONTRIB;\n            } else {\n                $this->context->mode = Context::MODE_HOST;\n            }\n        } elseif (isset($this->context->cookie->is_contributor) && (int) $this->context->cookie->is_contributor === 1) {\n            $this->context->mode = Context::MODE_STD_CONTRIB;\n        } else {\n            $this->context->mode = Context::MODE_STD;\n        }\n\n        //* Check if logged employee has access to AdminImport controller */\n        $import_access = Profile::getProfileAccess($this->context->employee->id_profile, Tab::getIdFromClassName('AdminImport'));\n        if (is_array($import_access) && isset($import_access['view']) && $import_access['view'] == 1) {\n            $this->can_import = true;\n        }\n\n        $this->context->smarty->assign([\n            'context_mode' => $this->context->mode,\n            'logged_on_addons' => $this->logged_on_addons,\n            'can_import' => $this->can_import,\n        ]);\n    }\n\n    /**\n     * Set breadcrumbs array for the controller page.\n     *\n     * @param int|null $tab_id\n     * @param array|null $tabs\n     */\n    public function initBreadcrumbs($tab_id = null, $tabs = null)\n    {\n        if (!is_array($tabs)) {\n            $tabs = [];\n        }\n\n        if (null === $tab_id) {\n            $tab_id = $this->id;\n        }\n\n        $tabs = Tab::recursiveTab($tab_id, $tabs);\n\n        $dummy = ['name' => '', 'href' => '', 'icon' => ''];\n        $breadcrumbs2 = [\n            'container' => $dummy,\n            'tab' => $dummy,\n            'action' => $dummy,\n        ];\n        if (!empty($tabs[0])) {\n            $this->addMetaTitle($tabs[0]['name']);\n            $breadcrumbs2['tab']['name'] = $tabs[0]['name'];\n            $breadcrumbs2['tab']['href'] = $this->context->link->getTabLink($tabs[0]);\n            if (!isset($tabs[1])) {\n                $breadcrumbs2['tab']['icon'] = 'icon-' . $tabs[0]['class_name'];\n            }\n        }\n        if (!empty($tabs[1])) {\n            $breadcrumbs2['container']['name'] = $tabs[1]['name'];\n            $breadcrumbs2['container']['href'] = $this->context->link->getTabLink($tabs[1]);\n            $breadcrumbs2['container']['icon'] = 'icon-' . $tabs[1]['class_name'];\n        }\n\n        /* content, edit, list, add, details, options, view */\n        switch ($this->display) {\n            case 'add':\n                $breadcrumbs2['action']['name'] = $this->trans('Add');\n                $breadcrumbs2['action']['icon'] = 'icon-plus';\n\n                break;\n            case 'edit':\n                $breadcrumbs2['action']['name'] = $this->trans('Edit');\n                $breadcrumbs2['action']['icon'] = 'icon-pencil';\n\n                break;\n            case '':\n            case 'list':\n                $breadcrumbs2['action']['name'] = $this->trans('List');\n                $breadcrumbs2['action']['icon'] = 'icon-th-list';\n\n                break;\n            case 'details':\n            case 'view':\n                $breadcrumbs2['action']['name'] = $this->trans('View details');\n                $breadcrumbs2['action']['icon'] = 'icon-zoom-in';\n\n                break;\n            case 'options':\n                $breadcrumbs2['action']['name'] = $this->trans('Options');\n                $breadcrumbs2['action']['icon'] = 'icon-cogs';\n\n                break;\n            case 'generator':\n                $breadcrumbs2['action']['name'] = $this->trans('Generator');\n                $breadcrumbs2['action']['icon'] = 'icon-flask';\n\n                break;\n        }\n\n        $this->context->smarty->assign([\n            'breadcrumbs2' => $breadcrumbs2,\n            'quick_access_current_link_name' => Tools::safeOutput($breadcrumbs2['tab']['name'] . (isset($breadcrumbs2['action']) ? ' - ' . $breadcrumbs2['action']['name'] : '')),\n            'quick_access_current_link_icon' => $breadcrumbs2['container']['icon'],\n        ]);\n\n        /* BEGIN - Backward compatibility < 1.6.0.3 */\n        $this->breadcrumbs[] = $tabs[0]['name'];\n        $navigation_pipe = (Configuration::get('PS_NAVIGATION_PIPE') ? Configuration::get('PS_NAVIGATION_PIPE') : '>');\n        $this->context->smarty->assign('navigationPipe', $navigation_pipe);\n        /* END - Backward compatibility < 1.6.0.3 */\n    }\n\n    /**\n     * Set default toolbar_title to admin breadcrumb.\n     */\n    public function initToolbarTitle()\n    {\n        $this->toolbar_title = is_array($this->breadcrumbs) ? array_unique($this->breadcrumbs) : [$this->breadcrumbs];\n\n        switch ($this->display) {\n            case 'edit':\n                $this->toolbar_title[] = $this->trans('Edit');\n                $this->addMetaTitle($this->trans('Edit'));\n\n                break;\n\n            case 'add':\n                $this->toolbar_title[] = $this->trans('Add new');\n                $this->addMetaTitle($this->trans('Add new'));\n\n                break;\n\n            case 'view':\n                $this->toolbar_title[] = $this->trans('View');\n                $this->addMetaTitle($this->trans('View'));\n\n                break;\n        }\n\n        if ($filter = $this->addFiltersToBreadcrumbs()) {\n            $this->toolbar_title[] = $filter;\n        }\n    }\n\n    /**\n     * @return string|void\n     */\n    public function addFiltersToBreadcrumbs()\n    {\n        if ($this->filter && is_array($this->fields_list)) {\n            $filters = [];\n\n            foreach ($this->fields_list as $field => $t) {\n                if (isset($t['filter_key'])) {\n                    $field = $t['filter_key'];\n                }\n\n                if (($val = Tools::getValue($this->table . 'Filter_' . $field)) || $val = $this->context->cookie->{$this->getCookieFilterPrefix() . $this->table . 'Filter_' . $field}) {\n                    if (!is_array($val)) {\n                        $filter_value = '';\n                        if (isset($t['type']) && $t['type'] == 'bool') {\n                            $filter_value = ((bool) $val) ? $this->trans('yes') : $this->trans('no');\n                        } elseif (isset($t['type']) && $t['type'] == 'date' || isset($t['type']) && $t['type'] == 'datetime') {\n                            $date = json_decode($val, true);\n                            if (isset($date[0])) {\n                                $filter_value = $date[0];\n                                if (isset($date[1]) && !empty($date[1])) {\n                                    $filter_value .= ' - ' . $date[1];\n                                }\n                            }\n                        } elseif (is_string($val)) {\n                            $filter_value = htmlspecialchars($val, ENT_QUOTES, 'UTF-8');\n                        }\n                        if (!empty($filter_value)) {\n                            $filters[] = $this->trans('%s: %s', [$t['title'], $filter_value]);\n                        }\n                    } else {\n                        $filter_value = '';\n                        foreach ($val as $v) {\n                            if (is_string($v) && !empty($v)) {\n                                $filter_value .= ' - ' . htmlspecialchars($v, ENT_QUOTES, 'UTF-8');\n                            }\n                        }\n                        $filter_value = ltrim($filter_value, ' -');\n                        if (!empty($filter_value)) {\n                            $filters[] = $this->trans('%s: %s', [$t['title'], $filter_value]);\n                        }\n                    }\n                }\n            }\n\n            if (count($filters)) {\n                return $this->trans('filter by %s', [implode(', ', $filters)]);\n            }\n        }\n    }\n\n    /**\n     * @param string $action\n     * @param bool $disable\n     */\n    public function access($action, $disable = false)\n    {\n        if (empty($this->tabAccess[$action])) {\n            $slugs = [];\n\n            foreach ((array) Access::getAuthorizationFromLegacy($action) as $roleSuffix) {\n                $slugs[] = $this->getTabSlug() . $roleSuffix;\n            }\n\n            $this->tabAccess[$action] = Access::isGranted(\n                $slugs,\n                $this->context->employee->id_profile\n            );\n        }\n\n        return $this->tabAccess[$action];\n    }\n\n    /**\n     * Check rights to view the current tab.\n     *\n     * @param bool $disable\n     *\n     * @return bool\n     */\n    public function viewAccess($disable = false)\n    {\n        return $this->access('view', $disable);\n    }\n\n    /**\n     * Check for security token.\n     *\n     * @return bool\n     */\n    public function checkToken()\n    {\n        if (TokenInUrls::isDisabled() || $this->isAnonymousAllowed()) {\n            return true;\n        }\n\n        $token = Tools::getValue('token');\n        if ($token === $this->token) {\n            return true;\n        }\n\n        if (count($_POST) || !isset($_GET['controller']) || !Validate::isControllerName($_GET['controller']) || !$token) {\n            return false;\n        }\n\n        foreach ($_GET as $key => $value) {\n            if (is_array($value) || !in_array($key, ['controller', 'controllerUri'])) {\n                return false;\n            }\n        }\n\n        $cookie = Context::getContext()->cookie;\n        $whitelist = ['date_add', 'id_lang', 'id_employee', 'email', 'profile', 'passwd', 'remote_addr', 'shopContext', 'collapse_menu', 'checksum'];\n        foreach ($cookie->getAll() as $key => $value) {\n            if (!in_array($key, $whitelist)) {\n                unset($cookie->$key);\n            }\n        }\n\n        $cookie->write();\n\n        return true;\n    }\n\n    /**\n     * Set the filters used for the list display.\n     */\n    protected function getCookieFilterPrefix()\n    {\n        return str_replace(['admin', 'controller'], '', Tools::strtolower(get_class($this)));\n    }\n\n    public function processFilter()\n    {\n        Hook::exec('action' . $this->controller_name . 'ListingFieldsModifier', [\n            'fields' => &$this->fields_list,\n        ]);\n\n        if (!isset($this->list_id)) {\n            $this->list_id = $this->table;\n        }\n\n        $prefix = $this->getCookieFilterPrefix();\n\n        if (isset($this->list_id)) {\n            foreach ($_POST as $key => $value) {\n                if ($value === '') {\n                    unset($this->context->cookie->{$prefix . $key});\n                } elseif (stripos($key, $this->list_id . 'Filter_') === 0) {\n                    $this->context->cookie->{$prefix . $key} = !is_array($value) ? $value : json_encode($value);\n                } elseif (stripos($key, 'submitFilter') === 0) {\n                    $this->context->cookie->$key = !is_array($value) ? $value : json_encode($value);\n                }\n            }\n\n            foreach ($_GET as $key => $value) {\n                if (stripos($key, $this->list_id . 'Filter_') === 0) {\n                    $this->context->cookie->{$prefix . $key} = !is_array($value) ? $value : json_encode($value);\n                } elseif (stripos($key, 'submitFilter') === 0) {\n                    $this->context->cookie->$key = !is_array($value) ? $value : json_encode($value);\n                }\n                if (stripos($key, $this->list_id . 'Orderby') === 0 && Validate::isOrderBy($value)) {\n                    if ($value === '' || $value == $this->_defaultOrderBy) {\n                        unset($this->context->cookie->{$prefix . $key});\n                    } else {\n                        $this->context->cookie->{$prefix . $key} = $value;\n                    }\n                } elseif (stripos($key, $this->list_id . 'Orderway') === 0 && Validate::isOrderWay($value)) {\n                    if ($value === '' || $value == $this->_defaultOrderWay) {\n                        unset($this->context->cookie->{$prefix . $key});\n                    } else {\n                        $this->context->cookie->{$prefix . $key} = $value;\n                    }\n                }\n            }\n        }\n\n        $filters = $this->context->cookie->getFamily($prefix . $this->list_id . 'Filter_');\n        $definition = false;\n        if (isset($this->className) && $this->className) {\n            $definition = ObjectModel::getDefinition($this->className);\n        }\n\n        foreach ($filters as $key => $value) {\n            /* Extracting filters from $_POST on key filter_ */\n            if ($value != null && !strncmp($key, $prefix . $this->list_id . 'Filter_', 7 + Tools::strlen($prefix . $this->list_id))) {\n                $key = Tools::substr($key, 7 + Tools::strlen($prefix . $this->list_id));\n                /* Table alias could be specified using a ! eg. alias!field */\n                $tmp_tab = explode('!', $key);\n                $filter = count($tmp_tab) > 1 ? $tmp_tab[1] : $tmp_tab[0];\n\n                if ($field = $this->filterToField($key, $filter)) {\n                    $type = (array_key_exists('filter_type', $field) ? $field['filter_type'] : (array_key_exists('type', $field) ? $field['type'] : false));\n                    if (($type == 'date' || $type == 'datetime') && is_string($value)) {\n                        $value = json_decode($value, true);\n                    }\n                    $key = isset($tmp_tab[1]) ? $tmp_tab[0] . '.`' . $tmp_tab[1] . '`' : '`' . $tmp_tab[0] . '`';\n\n                    // Assignment by reference\n                    if (array_key_exists('tmpTableFilter', $field)) {\n                        $sql_filter = &$this->_tmpTableFilter;\n                    } elseif (array_key_exists('havingFilter', $field)) {\n                        $sql_filter = &$this->_filterHaving;\n                    } else {\n                        $sql_filter = &$this->_filter;\n                    }\n\n                    /* Only for date filtering (from, to) */\n                    if (is_array($value)) {\n                        if (isset($value[0]) && !empty($value[0])) {\n                            if (!Validate::isDate($value[0])) {\n                                $this->errors[] = $this->trans('The \\'From\\' date format is invalid (YYYY-MM-DD)', [], 'Admin.Notifications.Error');\n                            } else {\n                                $sql_filter .= ' AND ' . pSQL($key) . ' >= \\'' . pSQL(Tools::dateFrom($value[0])) . '\\'';\n                            }\n                        }\n\n                        if (isset($value[1]) && !empty($value[1])) {\n                            if (!Validate::isDate($value[1])) {\n                                $this->errors[] = $this->trans('The \\'To\\' date format is invalid (YYYY-MM-DD)', [], 'Admin.Notifications.Error');\n                            } else {\n                                $sql_filter .= ' AND ' . pSQL($key) . ' <= \\'' . pSQL(Tools::dateTo($value[1])) . '\\'';\n                            }\n                        }\n                    } else {\n                        $sql_filter .= ' AND ';\n                        $check_key = ($key == $this->identifier || $key == '`' . $this->identifier . '`');\n                        $alias = ($definition && !empty($definition['fields'][$filter]['shop'])) ? 'sa' : 'a';\n\n                        if ($type == 'int' || $type == 'bool') {\n                            $sql_filter .= (($check_key || $key == '`active`') ? $alias . '.' : '') . pSQL($key) . ' = ' . (int) $value . ' ';\n                        } elseif ($type == 'decimal') {\n                            $sql_filter .= ($check_key ? $alias . '.' : '') . pSQL($key) . ' = ' . (float) $value . ' ';\n                        } elseif ($type == 'select') {\n                            $sql_filter .= ($check_key ? $alias . '.' : '') . pSQL($key) . ' = \\'' . pSQL($value) . '\\' ';\n                        } elseif ($type == 'price') {\n                            $value = (float) str_replace(',', '.', $value);\n                            $sql_filter .= ($check_key ? $alias . '.' : '') . pSQL($key) . ' = ' . pSQL(trim($value)) . ' ';\n                        } else {\n                            $sql_filter .= ($check_key ? $alias . '.' : '') . pSQL($key) . ' LIKE \\'%' . pSQL(trim($value)) . '%\\' ';\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    /**\n     * @TODO uses redirectAdmin only if !$this->ajax\n     *\n     * @return ObjectModel|bool\n     */\n    public function postProcess()\n    {\n        try {\n            if ($this->ajax) {\n                // from ajax-tab.php\n                $action = Tools::getValue('action');\n                // no need to use displayConf() here\n                if (!empty($action) && method_exists($this, 'ajaxProcess' . Tools::toCamelCase($action))) {\n                    Hook::exec('actionAdmin' . ucfirst($this->action) . 'Before', ['controller' => $this]);\n                    Hook::exec('action' . get_class($this) . ucfirst($this->action) . 'Before', ['controller' => $this]);\n\n                    $return = $this->{'ajaxProcess' . Tools::toCamelCase($action)}();\n\n                    Hook::exec('actionAdmin' . ucfirst($this->action) . 'After', ['controller' => $this, 'return' => $return]);\n                    Hook::exec('action' . get_class($this) . ucfirst($this->action) . 'After', ['controller' => $this, 'return' => $return]);\n\n                    return $return;\n                } elseif (!empty($action) && $this->controller_name == 'AdminModules' && Tools::getIsset('configure')) {\n                    $module_obj = Module::getInstanceByName(Tools::getValue('configure'));\n                    if (Validate::isLoadedObject($module_obj) && method_exists($module_obj, 'ajaxProcess' . $action)) {\n                        return $module_obj->{'ajaxProcess' . $action}();\n                    }\n                } elseif (method_exists($this, 'ajaxProcess')) {\n                    return $this->ajaxProcess();\n                }\n            } else {\n                // Process list filtering\n                if ($this->filter && $this->action != 'reset_filters') {\n                    $this->processFilter();\n                }\n\n                if (isset($_POST) && count($_POST) && (int) Tools::getValue('submitFilter' . $this->list_id) || Tools::isSubmit('submitReset' . $this->list_id)) {\n                    $this->setRedirectAfter(self::$currentIndex . '&token=' . $this->token . (Tools::isSubmit('submitFilter' . $this->list_id) ? '&submitFilter' . $this->list_id . '=' . (int) Tools::getValue('submitFilter' . $this->list_id) : ''));\n                }\n\n                // If the method named after the action exists, call \"before\" hooks, then call action method, then call \"after\" hooks\n                if (!empty($this->action) && method_exists($this, 'process' . ucfirst(Tools::toCamelCase($this->action)))) {\n                    // Hook before action\n                    Hook::exec('actionAdmin' . ucfirst($this->action) . 'Before', ['controller' => $this]);\n                    Hook::exec('action' . get_class($this) . ucfirst($this->action) . 'Before', ['controller' => $this]);\n                    // Call process\n                    $return = $this->{'process' . Tools::toCamelCase($this->action)}();\n\n                    // Hook After Action\n                    Hook::exec('actionAdmin' . ucfirst($this->action) . 'After', ['controller' => $this, 'return' => $return]);\n                    Hook::exec('action' . get_class($this) . ucfirst($this->action) . 'After', ['controller' => $this, 'return' => $return]);\n\n                    return $return;\n                }\n            }\n        } catch (PrestaShopException $e) {\n            $this->errors[] = $e->getMessage();\n        }\n\n        return false;\n    }\n\n    /**\n     * Object Delete images.\n     *\n     * @return ObjectModel|false\n     */\n    public function processDeleteImage()\n    {\n        if (Validate::isLoadedObject($object = $this->loadObject())) {\n            if (($object->deleteImage())) {\n                $redirect = self::$currentIndex . '&update' . $this->table . '&' . $this->identifier . '=' . (int) Tools::getValue($this->identifier) . '&conf=7&token=' . $this->token;\n                if (!$this->ajax) {\n                    $this->redirect_after = $redirect;\n                } else {\n                    $this->content = 'ok';\n                }\n            }\n        }\n        $this->errors[] = $this->trans('An error occurred while attempting to delete the image. (cannot load object).', [], 'Admin.Notifications.Error');\n\n        return $object;\n    }\n\n    /**\n     * @param string $text_delimiter\n     *\n     * @throws PrestaShopException\n     */\n    public function processExport($text_delimiter = '\"')\n    {\n        // clean buffer\n        if (ob_get_level() && ob_get_length() > 0) {\n            ob_clean();\n        }\n        $this->getList($this->context->language->id, null, null, 0, false);\n        if (!count($this->_list)) {\n            return;\n        }\n\n        header('Content-type: text/csv');\n        header('Content-Type: application/force-download; charset=UTF-8');\n        header('Cache-Control: no-store, no-cache');\n        header('Content-disposition: attachment; filename=\"' . $this->table . '_' . date('Y-m-d_His') . '.csv\"');\n\n        $fd = fopen('php://output', 'wb');\n        $headers = [];\n        foreach ($this->fields_list as $key => $datas) {\n            if ('PDF' === $datas['title']) {\n                unset($this->fields_list[$key]);\n            } else {\n                if ('ID' === $datas['title']) {\n                    $headers[] = strtolower(Tools::htmlentitiesDecodeUTF8($datas['title']));\n                } else {\n                    $headers[] = Tools::htmlentitiesDecodeUTF8($datas['title']);\n                }\n            }\n        }\n        fputcsv($fd, $headers, ';', $text_delimiter);\n\n        foreach ($this->_list as $i => $row) {\n            $content = [];\n            $path_to_image = false;\n            foreach ($this->fields_list as $key => $params) {\n                $field_value = isset($row[$key]) ? Tools::htmlentitiesDecodeUTF8(Tools::nl2br($row[$key])) : '';\n                if ($key == 'image') {\n                    if ($params['image'] != 'p' || Configuration::get('PS_LEGACY_IMAGES')) {\n                        $path_to_image = Tools::getShopDomain(true) . _PS_IMG_ . $params['image'] . '/' . $row['id_' . $this->table] . (isset($row['id_image']) ? '-' . (int) $row['id_image'] : '') . '.' . $this->imageType;\n                    } else {\n                        $path_to_image = Tools::getShopDomain(true) . _PS_IMG_ . $params['image'] . '/' . Image::getImgFolderStatic($row['id_image']) . (int) $row['id_image'] . '.' . $this->imageType;\n                    }\n                    if ($path_to_image) {\n                        $field_value = $path_to_image;\n                    }\n                }\n                if (isset($params['callback'])) {\n                    $callback_obj = (isset($params['callback_object'])) ? $params['callback_object'] : $this->context->controller;\n                    if (!preg_match('/<([a-z]+)([^<]+)*(?:>(.*)<\\/\\1>|\\s+\\/>)/ism', call_user_func_array([$callback_obj, $params['callback']], [$field_value, $row]))) {\n                        $field_value = call_user_func_array([$callback_obj, $params['callback']], [$field_value, $row]);\n                    }\n                }\n                $content[] = $field_value;\n            }\n            fputcsv($fd, $content, ';', $text_delimiter);\n        }\n        @fclose($fd);\n        die;\n    }\n\n    /**\n     * Object Delete.\n     *\n     * @return ObjectModel|false\n     *\n     * @throws PrestaShopException\n     */\n    public function processDelete()\n    {\n        if (Validate::isLoadedObject($object = $this->loadObject())) {\n            $res = true;\n            // check if request at least one object with noZeroObject\n            if (isset($object->noZeroObject) && count(call_user_func([$this->className, $object->noZeroObject])) <= 1) {\n                $this->errors[] = $this->trans('You need at least one object.', [], 'Admin.Notifications.Error') .\n                    ' <b>' . $this->table . '</b><br />' .\n                    $this->trans('You cannot delete all of the items.', [], 'Admin.Notifications.Error');\n            } elseif (array_key_exists('delete', $this->list_skip_actions) && in_array($object->id, $this->list_skip_actions['delete'])) { //check if some ids are in list_skip_actions and forbid deletion\n                $this->errors[] = $this->trans('You cannot delete this item.', [], 'Admin.Notifications.Error');\n            } else {\n                if ($this->deleted) {\n                    if (!empty($this->fieldImageSettings)) {\n                        $res = $object->deleteImage();\n                    }\n\n                    if (!$res) {\n                        $this->errors[] = $this->trans('Unable to delete associated images.', [], 'Admin.Notifications.Error');\n                    }\n\n                    $object->deleted = 1;\n                    if ($res = $object->update()) {\n                        $this->redirect_after = self::$currentIndex . '&conf=1&token=' . $this->token;\n                    }\n                } elseif ($res = $object->delete()) {\n                    $this->redirect_after = self::$currentIndex . '&conf=1&token=' . $this->token;\n                }\n                $this->errors[] = $this->trans('An error occurred during deletion.', [], 'Admin.Notifications.Error');\n                if ($res) {\n                    PrestaShopLogger::addLog(\n                        $this->trans('%s deletion', [$this->className]),\n                        1,\n                        null,\n                        $this->className,\n                        (int) $this->object->id,\n                        true,\n                        (int) $this->context->employee->id\n                    );\n                }\n            }\n        } else {\n            $this->errors[] = $this->trans('An error occurred while deleting the object.', [], 'Admin.Notifications.Error') .\n                ' <b>' . $this->table . '</b> ' .\n                $this->trans('(cannot load object)', [], 'Admin.Notifications.Error');\n        }\n\n        return $object;\n    }\n\n    /**\n     * Call the right method for creating or updating object.\n     *\n     * @return ObjectModel|false|void\n     */\n    public function processSave()\n    {\n        if ($this->id_object) {\n            $this->object = $this->loadObject();\n\n            return $this->processUpdate();\n        } else {\n            return $this->processAdd();\n        }\n    }\n\n    /**\n     * Object creation.\n     *\n     * @return ObjectModel|false\n     *\n     * @throws PrestaShopException\n     */\n    public function processAdd()\n    {\n        if (!isset($this->className) || empty($this->className)) {\n            return false;\n        }\n\n        $this->validateRules();\n        if (count($this->errors) <= 0) {\n            $this->object = new $this->className();\n\n            $this->copyFromPost($this->object, $this->table);\n            $this->beforeAdd($this->object);\n            if (method_exists($this->object, 'add') && !$this->object->add()) {\n                $this->errors[] = $this->trans('An error occurred while creating an object.', [], 'Admin.Notifications.Error') .\n                    ' <b>' . $this->table . ' (' . Db::getInstance()->getMsgError() . ')</b>';\n            } elseif (($_POST[$this->identifier] = $this->object->id /* voluntary do affectation here */) && $this->postImage($this->object->id) && !count($this->errors) && $this->_redirect) {\n                PrestaShopLogger::addLog(\n                    $this->trans('%s addition', [$this->className]),\n                    1,\n                    null,\n                    $this->className,\n                    (int) $this->object->id,\n                    true,\n                    (int) $this->context->employee->id\n                );\n                $parent_id = (int) Tools::getValue('id_parent', 1);\n                $this->afterAdd($this->object);\n                $this->updateAssoShop($this->object->id);\n                // Save and stay on same form\n                if (empty($this->redirect_after) && $this->redirect_after !== false && Tools::isSubmit('submitAdd' . $this->table . 'AndStay')) {\n                    $this->redirect_after = self::$currentIndex . '&' . $this->identifier . '=' . $this->object->id . '&conf=3&update' . $this->table . '&token=' . $this->token;\n                }\n                // Save and back to parent\n                if (empty($this->redirect_after) && $this->redirect_after !== false && Tools::isSubmit('submitAdd' . $this->table . 'AndBackToParent')) {\n                    $this->redirect_after = self::$currentIndex . '&' . $this->identifier . '=' . $parent_id . '&conf=3&token=' . $this->token;\n                }\n                // Default behavior (save and back)\n                if (empty($this->redirect_after) && $this->redirect_after !== false) {\n                    $this->redirect_after = self::$currentIndex . ($parent_id ? '&' . $this->identifier . '=' . $this->object->id : '') . '&conf=3&token=' . $this->token;\n                }\n            }\n        }\n\n        $this->errors = array_unique($this->errors);\n        if (!empty($this->errors)) {\n            // if we have errors, we stay on the form instead of going back to the list\n            $this->display = 'edit';\n\n            return false;\n        }\n\n        return $this->object;\n    }\n\n    /**\n     * Object update.\n     *\n     * @return ObjectModel|false|void\n     *\n     * @throws PrestaShopException\n     */\n    public function processUpdate()\n    {\n        /* Checking fields validity */\n        $this->validateRules();\n        if (empty($this->errors)) {\n            $id = (int) Tools::getValue($this->identifier);\n\n            /* Object update */\n            if (isset($id) && !empty($id)) {\n                /** @var ObjectModel $object */\n                $object = new $this->className($id);\n                if (Validate::isLoadedObject($object)) {\n                    /* Specific to objects which must not be deleted */\n                    if ($this->deleted && $this->beforeDelete($object)) {\n                        // Create new one with old objet values\n                        /** @var ObjectModel $object_new */\n                        $object_new = $object->duplicateObject();\n                        if (Validate::isLoadedObject($object_new)) {\n                            // Update old object to deleted\n                            $object->deleted = 1;\n                            $object->update();\n\n                            // Update new object with post values\n                            $this->copyFromPost($object_new, $this->table);\n                            $result = $object_new->update();\n                            if (Validate::isLoadedObject($object_new)) {\n                                $this->afterDelete($object_new, $object->id);\n                            }\n                        }\n                    } else {\n                        $this->copyFromPost($object, $this->table);\n                        $result = $object->update();\n                        $this->afterUpdate($object);\n                    }\n\n                    if ($object->id) {\n                        $this->updateAssoShop($object->id);\n                    }\n\n                    if (!$result) {\n                        $this->errors[] = $this->trans('An error occurred while updating an object.', [], 'Admin.Notifications.Error') .\n                            ' <b>' . $this->table . '</b> (' . Db::getInstance()->getMsgError() . ')';\n                    } elseif ($this->postImage($object->id) && !count($this->errors) && $this->_redirect) {\n                        $parent_id = (int) Tools::getValue('id_parent', 1);\n                        // Specific back redirect\n                        if ($back = Tools::getValue('back')) {\n                            $this->redirect_after = urldecode($back) . '&conf=4';\n                        }\n                        // Save and stay on same form\n                        // @todo on the to following if, we may prefer to avoid override redirect_after previous value\n                        if (Tools::isSubmit('submitAdd' . $this->table . 'AndStay')) {\n                            $this->redirect_after = self::$currentIndex . '&' . $this->identifier . '=' . $object->id . '&conf=4&update' . $this->table . '&token=' . $this->token;\n                        }\n                        // Save and back to parent\n                        if (Tools::isSubmit('submitAdd' . $this->table . 'AndBackToParent')) {\n                            $this->redirect_after = self::$currentIndex . '&' . $this->identifier . '=' . $parent_id . '&conf=4&token=' . $this->token;\n                        }\n\n                        // Default behavior (save and back)\n                        if (empty($this->redirect_after) && $this->redirect_after !== false) {\n                            $this->redirect_after = self::$currentIndex . ($parent_id ? '&' . $this->identifier . '=' . $object->id : '') . '&conf=4&token=' . $this->token;\n                        }\n                    }\n                    PrestaShopLogger::addLog(\n                        $this->trans('%s modification', [$this->className]),\n                        1,\n                        null,\n                        $this->className,\n                        (int) $object->id,\n                        true,\n                        (int) $this->context->employee->id\n                    );\n                } else {\n                    $this->errors[] = $this->trans('An error occurred while updating an object.', [], 'Admin.Notifications.Error') .\n                        ' <b>' . $this->table . '</b> ' . $this->trans('(cannot load object)', [], 'Admin.Notifications.Error');\n                }\n            }\n        }\n        $this->errors = array_unique($this->errors);\n        if (!empty($this->errors)) {\n            // if we have errors, we stay on the form instead of going back to the list\n            $this->display = 'edit';\n\n            return false;\n        }\n\n        if (isset($object)) {\n            return $object;\n        }\n    }\n\n    /**\n     * Change object required fields.\n     *\n     * @return ObjectModel\n     */\n    public function processUpdateFields()\n    {\n        if (!is_array($fields = Tools::getValue('fieldsBox'))) {\n            $fields = [];\n        }\n\n        /** @var $object ObjectModel */\n        $object = new $this->className();\n\n        if (!$object->addFieldsRequiredDatabase($fields)) {\n            $this->errors[] = $this->trans('An error occurred when attempting to update the required fields.', [], 'Admin.Notifications.Error');\n        } else {\n            $this->redirect_after = self::$currentIndex . '&conf=4&token=' . $this->token;\n        }\n\n        return $object;\n    }\n\n    /**\n     * Change object status (active, inactive).\n     *\n     * @return ObjectModel|false\n     *\n     * @throws PrestaShopException\n     */\n    public function processStatus()\n    {\n        if (Validate::isLoadedObject($object = $this->loadObject())) {\n            if ($object->toggleStatus()) {\n                $matches = [];\n                if (preg_match('/[\\?|&]controller=([^&]*)/', (string) $_SERVER['HTTP_REFERER'], $matches) !== false\n                    && strtolower($matches[1]) != strtolower(preg_replace('/controller/i', '', get_class($this)))) {\n                    $this->redirect_after = preg_replace('/[\\?|&]conf=([^&]*)/i', '', (string) $_SERVER['HTTP_REFERER']);\n                } else {\n                    $this->redirect_after = self::$currentIndex . '&token=' . $this->token;\n                }\n\n                $id_category = (($id_category = (int) Tools::getValue('id_category')) && Tools::getValue('id_product')) ? '&id_category=' . $id_category : '';\n\n                $page = (int) Tools::getValue('page');\n                $page = $page > 1 ? '&submitFilter' . $this->table . '=' . (int) $page : '';\n                $this->redirect_after .= '&conf=5' . $id_category . $page;\n            } else {\n                $this->errors[] = $this->trans('An error occurred while updating the status.', [], 'Admin.Notifications.Error');\n            }\n        } else {\n            $this->errors[] = $this->trans('An error occurred while updating the status for an object.', [], 'Admin.Notifications.Error') .\n                ' <b>' . $this->table . '</b> ' .\n                $this->trans('(cannot load object)', [], 'Admin.Notifications.Error');\n        }\n\n        return $object;\n    }\n\n    /**\n     * Change object position.\n     *\n     * @return ObjectModel|false\n     */\n    public function processPosition()\n    {\n        if (!Validate::isLoadedObject($object = $this->loadObject())) {\n            $this->errors[] = $this->trans('An error occurred while updating the status for an object.', [], 'Admin.Notifications.Error') .\n                ' <b>' . $this->table . '</b> ' . $this->trans('(cannot load object)', [], 'Admin.Notifications.Error');\n        } elseif (!$object->updatePosition((int) Tools::getValue('way'), (int) Tools::getValue('position'))) {\n            $this->errors[] = $this->trans('Failed to update the position.', [], 'Admin.Notifications.Error');\n        } else {\n            $id_identifier_str = ($id_identifier = (int) Tools::getValue($this->identifier)) ? '&' . $this->identifier . '=' . $id_identifier : '';\n            $redirect = self::$currentIndex . '&' . $this->table . 'Orderby=position&' . $this->table . 'Orderway=asc&conf=5' . $id_identifier_str . '&token=' . $this->token;\n            $this->redirect_after = $redirect;\n        }\n\n        return $object;\n    }\n\n    /**\n     * Cancel all filters for this tab.\n     *\n     * @param int|null $list_id\n     */\n    public function processResetFilters($list_id = null)\n    {\n        if ($list_id === null) {\n            $list_id = isset($this->list_id) ? $this->list_id : $this->table;\n        }\n\n        $prefix = $this->getCookieOrderByPrefix();\n        $filters = $this->context->cookie->getFamily($prefix . $list_id . 'Filter_');\n        foreach ($filters as $cookie_key => $filter) {\n            if (strncmp($cookie_key, $prefix . $list_id . 'Filter_', 7 + Tools::strlen($prefix . $list_id)) == 0) {\n                $key = substr($cookie_key, 7 + Tools::strlen($prefix . $list_id));\n                if (is_array($this->fields_list) && array_key_exists($key, $this->fields_list)) {\n                    $this->context->cookie->$cookie_key = null;\n                }\n                unset($this->context->cookie->$cookie_key);\n            }\n        }\n\n        if (isset($this->context->cookie->{'submitFilter' . $list_id})) {\n            unset($this->context->cookie->{'submitFilter' . $list_id});\n        }\n        if (isset($this->context->cookie->{$prefix . $list_id . 'Orderby'})) {\n            unset($this->context->cookie->{$prefix . $list_id . 'Orderby'});\n        }\n        if (isset($this->context->cookie->{$prefix . $list_id . 'Orderway'})) {\n            unset($this->context->cookie->{$prefix . $list_id . 'Orderway'});\n        }\n\n        $_POST = [];\n        $this->_filter = false;\n        unset(\n            $this->_filterHaving,\n            $this->_having\n        );\n    }\n\n    /**\n     * Update options and preferences.\n     */\n    protected function processUpdateOptions()\n    {\n        $this->beforeUpdateOptions();\n\n        $languages = Language::getLanguages(false);\n\n        $hide_multishop_checkbox = (Shop::getTotalShops(false, null) < 2) ? true : false;\n        foreach ($this->fields_options as $category_data) {\n            if (!isset($category_data['fields'])) {\n                continue;\n            }\n\n            $fields = $category_data['fields'];\n\n            foreach ($fields as $field => $values) {\n                if (isset($values['type']) && $values['type'] == 'selectLang') {\n                    foreach ($languages as $lang) {\n                        if (Tools::getValue($field . '_' . strtoupper($lang['iso_code']))) {\n                            $fields[$field . '_' . strtoupper($lang['iso_code'])] = [\n                                'type' => 'select',\n                                'cast' => 'strval',\n                                'identifier' => 'mode',\n                                'list' => $values['list'],\n                            ];\n                        }\n                    }\n                }\n            }\n\n            // Validate fields\n            foreach ($fields as $field => $values) {\n                // We don't validate fields with no visibility\n                if (!$hide_multishop_checkbox && Shop::isFeatureActive() && isset($values['visibility']) && $values['visibility'] > Shop::getContext()) {\n                    continue;\n                }\n\n                // Check if field is required\n                if ((!Shop::isFeatureActive() && !empty($values['required']))\n                    || (Shop::isFeatureActive() && isset($_POST['multishopOverrideOption'][$field]) && !empty($values['required']))) {\n                    if (isset($values['type']) && $values['type'] == 'textLang') {\n                        foreach ($languages as $language) {\n                            if (($value = Tools::getValue($field . '_' . $language['id_lang'])) == false && (string) $value != '0') {\n                                $this->errors[] = $this->trans('field %s is required.', [$values['title']], 'Admin.Notifications.Error');\n                            }\n                        }\n                    } elseif (($value = Tools::getValue($field)) == false && (string) $value != '0') {\n                        $this->errors[] = $this->trans('field %s is required.', [$values['title']], 'Admin.Notifications.Error');\n                    }\n                }\n\n                // Check field validator\n                if (isset($values['type']) && $values['type'] == 'textLang') {\n                    foreach ($languages as $language) {\n                        if (Tools::getValue($field . '_' . $language['id_lang']) && isset($values['validation'])) {\n                            $values_validation = $values['validation'];\n                            if (!Validate::$values_validation(Tools::getValue($field . '_' . $language['id_lang']))) {\n                                $this->errors[] = $this->trans('The %s field is invalid.', [$values['title']], 'Admin.Notifications.Error');\n                            }\n                        }\n                    }\n                } elseif (Tools::getValue($field) && isset($values['validation'])) {\n                    $values_validation = $values['validation'];\n                    if (!Validate::$values_validation(Tools::getValue($field))) {\n                        $this->errors[] = $this->trans('The %s field is invalid.', [$values['title']], 'Admin.Notifications.Error');\n                    }\n                }\n\n                // Set default value\n                if (Tools::getValue($field) === false && isset($values['default'])) {\n                    $_POST[$field] = $values['default'];\n                }\n            }\n\n            if (!count($this->errors)) {\n                foreach ($fields as $key => $options) {\n                    if (Shop::isFeatureActive() && isset($options['visibility']) && $options['visibility'] > Shop::getContext()) {\n                        continue;\n                    }\n\n                    if (!$hide_multishop_checkbox && Shop::isFeatureActive() && Shop::getContext() != Shop::CONTEXT_ALL && empty($options['no_multishop_checkbox']) && empty($_POST['multishopOverrideOption'][$key])) {\n                        Configuration::deleteFromContext($key);\n\n                        continue;\n                    }\n\n                    // check if a method updateOptionFieldName is available\n                    $method_name = 'updateOption' . Tools::toCamelCase($key, true);\n                    if (method_exists($this, $method_name)) {\n                        $this->$method_name(Tools::getValue($key));\n                    } elseif (isset($options['type']) && in_array($options['type'], ['textLang', 'textareaLang'])) {\n                        $list = [];\n                        foreach ($languages as $language) {\n                            $key_lang = Tools::getValue($key . '_' . $language['id_lang']);\n                            $val = (isset($options['cast']) ? $options['cast']($key_lang) : $key_lang);\n                            if ($this->validateField($val, $options)) {\n                                if (Validate::isCleanHtml($val)) {\n                                    $list[$language['id_lang']] = $val;\n                                } else {\n                                    $this->errors[] = $this->trans('Cannot add configuration %1$s for %2$s language', [$key, Language::getIsoById((int) $language['id_lang'])], 'Admin.International.Notification');\n                                }\n                            }\n                        }\n                        Configuration::updateValue($key, $list, isset($options['validation']) && $options['validation'] == 'isCleanHtml' ? true : false);\n                    } else {\n                        $val = (isset($options['cast']) ? $options['cast'](Tools::getValue($key)) : Tools::getValue($key));\n                        if ($this->validateField($val, $options)) {\n                            if (Validate::isCleanHtml($val)) {\n                                Configuration::updateValue($key, $val);\n                            } else {\n                                $this->errors[] = $this->trans('Cannot add configuration %s', [$key], 'Admin.Notifications.Error');\n                            }\n                        }\n                    }\n                }\n            }\n        }\n\n        $this->display = 'list';\n        if (empty($this->errors)) {\n            $this->confirmations[] = $this->_conf[6];\n        }\n    }\n\n    public function initPageHeaderToolbar()\n    {\n        if (empty($this->toolbar_title)) {\n            $this->initToolbarTitle();\n        }\n\n        if (!is_array($this->toolbar_title)) {\n            $this->toolbar_title = [$this->toolbar_title];\n        }\n\n        switch ($this->display) {\n            case 'view':\n                // Default cancel button - like old back link\n                $back = Tools::safeOutput(Tools::getValue('back', ''));\n                if (empty($back)) {\n                    $back = self::$currentIndex . '&token=' . $this->token;\n                }\n                if (!Validate::isCleanHtml($back)) {\n                    die(Tools::displayError());\n                }\n                if (!$this->lite_display) {\n                    $this->page_header_toolbar_btn['back'] = [\n                        'href' => $back,\n                        'desc' => $this->trans('Back to list'),\n                    ];\n                }\n                $obj = $this->loadObject(true);\n                if (Validate::isLoadedObject($obj) && isset($obj->{$this->identifier_name}) && !empty($obj->{$this->identifier_name})) {\n                    array_pop($this->toolbar_title);\n                    array_pop($this->meta_title);\n                    $this->toolbar_title[] = is_array($obj->{$this->identifier_name}) ? $obj->{$this->identifier_name}[$this->context->employee->id_lang] : $obj->{$this->identifier_name};\n                    $this->addMetaTitle($this->toolbar_title[count($this->toolbar_title) - 1]);\n                }\n\n                break;\n            case 'edit':\n                $obj = $this->loadObject(true);\n                if (Validate::isLoadedObject($obj) && isset($obj->{$this->identifier_name}) && !empty($obj->{$this->identifier_name})) {\n                    array_pop($this->toolbar_title);\n                    array_pop($this->meta_title);\n                    $this->toolbar_title[] = $this->trans(\n                        'Edit: %s',\n                        [\n                            (is_array($obj->{$this->identifier_name})\n                                && isset($obj->{$this->identifier_name}[$this->context->employee->id_lang])\n                            )\n                                ? $obj->{$this->identifier_name}[$this->context->employee->id_lang]\n                                : $obj->{$this->identifier_name},\n                        ]\n                    );\n                    $this->addMetaTitle($this->toolbar_title[count($this->toolbar_title) - 1]);\n                }\n\n                break;\n        }\n\n        if (is_array($this->page_header_toolbar_btn)\n            && $this->page_header_toolbar_btn instanceof Traversable\n            || count($this->toolbar_title)) {\n            $this->show_page_header_toolbar = true;\n        }\n\n        if (empty($this->page_header_toolbar_title)) {\n            $this->page_header_toolbar_title = $this->toolbar_title[count($this->toolbar_title) - 1];\n        }\n\n        $this->addPageHeaderToolBarModulesListButton();\n\n        $this->context->smarty->assign('help_link', 'https://help.prestashop.com/' . Language::getIsoById($this->context->employee->id_lang) . '/doc/'\n            . Tools::getValue('controller') . '?version=' . _PS_VERSION_ . '&country=' . Language::getIsoById($this->context->employee->id_lang));\n    }\n\n    /**\n     * assign default action in toolbar_btn smarty var, if they are not set.\n     * uses override to specifically add, modify or remove items.\n     */\n    public function initToolbar()\n    {\n        switch ($this->display) {\n            case 'add':\n            case 'edit':\n                // Default save button - action dynamically handled in javascript\n                $this->toolbar_btn['save'] = [\n                    'href' => '#',\n                    'desc' => $this->trans('Save'),\n                ];\n                $back = Tools::safeOutput(Tools::getValue('back', ''));\n                if (empty($back)) {\n                    $back = self::$currentIndex . '&token=' . $this->token;\n                }\n                if (!Validate::isCleanHtml($back)) {\n                    die(Tools::displayError());\n                }\n                if (!$this->lite_display) {\n                    $this->toolbar_btn['cancel'] = [\n                        'href' => $back,\n                        'desc' => $this->trans('Cancel'),\n                    ];\n                }\n\n                break;\n            case 'view':\n                // Default cancel button - like old back link\n                $back = Tools::safeOutput(Tools::getValue('back', ''));\n                if (empty($back)) {\n                    $back = self::$currentIndex . '&token=' . $this->token;\n                }\n                if (!Validate::isCleanHtml($back)) {\n                    die(Tools::displayError());\n                }\n                if (!$this->lite_display) {\n                    $this->toolbar_btn['back'] = [\n                        'href' => $back,\n                        'desc' => $this->trans('Back to list'),\n                    ];\n                }\n\n                break;\n            case 'options':\n                $this->toolbar_btn['save'] = [\n                    'href' => '#',\n                    'desc' => $this->trans('Save'),\n                ];\n\n                break;\n            default:\n                // list\n                $this->toolbar_btn['new'] = [\n                    'href' => self::$currentIndex . '&add' . $this->table . '&token=' . $this->token,\n                    'desc' => $this->trans('Add new'),\n                ];\n                if ($this->allow_export) {\n                    $this->toolbar_btn['export'] = [\n                        'href' => self::$currentIndex . '&export' . $this->table . '&token=' . $this->token,\n                        'desc' => $this->trans('Export'),\n                    ];\n                }\n        }\n        $this->addToolBarModulesListButton();\n    }\n\n    /**\n     * Load class object using identifier in $_GET (if possible)\n     * otherwise return an empty object, or die.\n     *\n     * @param bool $opt Return an empty object if load fail\n     *\n     * @return ObjectModel|false\n     */\n    protected function loadObject($opt = false)\n    {\n        if (!isset($this->className) || empty($this->className)) {\n            return true;\n        }\n\n        $id = (int) Tools::getValue($this->identifier);\n        if ($id && Validate::isUnsignedId($id)) {\n            if (!$this->object) {\n                $this->object = new $this->className($id);\n            }\n            if (Validate::isLoadedObject($this->object)) {\n                return $this->object;\n            }\n            // throw exception\n            $this->errors[] = $this->trans('The object cannot be loaded (or found)', [], 'Admin.Notifications.Error');\n\n            return false;\n        } elseif ($opt) {\n            if (!$this->object) {\n                $this->object = new $this->className();\n            }\n\n            return $this->object;\n        } else {\n            $this->errors[] = $this->trans('The object cannot be loaded (the identifier is missing or invalid)', [], 'Admin.Notifications.Error');\n\n            return false;\n        }\n    }\n\n    /**\n     * Check if the token is valid, else display a warning page.\n     *\n     * @return bool\n     */\n    public function checkAccess()\n    {\n        if (!$this->checkToken()) {\n            // If this is an XSS attempt, then we should only display a simple, secure page\n            // ${1} in the replacement string of the regexp is required,\n            // because the token may begin with a number and mix up with it (e.g. $17)\n            $url = preg_replace('/([&?]token=)[^&]*(&.*)?$/', '${1}' . $this->token . '$2', $_SERVER['REQUEST_URI']);\n            if (false === strpos($url, '?token=') && false === strpos($url, '&token=')) {\n                $url .= '&token=' . $this->token;\n            }\n            if (strpos($url, '?') === false) {\n                $url = str_replace('&token', '?controller=AdminDashboard&token', $url);\n            }\n\n            $this->context->smarty->assign('url', htmlentities($url));\n\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * @param string $key\n     * @param string $filter\n     *\n     * @return array|false\n     */\n    protected function filterToField($key, $filter)\n    {\n        if (!isset($this->fields_list)) {\n            return false;\n        }\n\n        foreach ($this->fields_list as $field) {\n            if (array_key_exists('filter_key', $field) && $field['filter_key'] == $key) {\n                return $field;\n            }\n        }\n        if (array_key_exists($filter, $this->fields_list)) {\n            return $this->fields_list[$filter];\n        }\n\n        return false;\n    }\n\n    public function displayAjax()\n    {\n        if ($this->json) {\n            $this->context->smarty->assign([\n                'json' => true,\n                'status' => $this->status,\n            ]);\n        }\n        $this->layout = 'layout-ajax.tpl';\n        $this->display_header = false;\n        $this->display_header_javascript = false;\n        $this->display_footer = false;\n\n        return $this->display();\n    }\n\n    protected function redirect()\n    {\n        Tools::redirectAdmin($this->redirect_after);\n    }\n\n    /**\n     * @throws Exception\n     * @throws SmartyException\n     */\n    public function display()\n    {\n        $this->context->smarty->assign([\n            'display_header' => $this->display_header,\n            'display_header_javascript' => $this->display_header_javascript,\n            'display_footer' => $this->display_footer,\n            'js_def' => Media::getJsDef(),\n            'toggle_navigation_url' => $this->context->link->getAdminLink('AdminEmployees', true, [], [\n                'action' => 'toggleMenu',\n            ]),\n        ]);\n\n        // Use page title from meta_title if it has been set else from the breadcrumbs array\n        if (!$this->meta_title) {\n            $this->meta_title = $this->toolbar_title;\n        }\n        if (is_array($this->meta_title)) {\n            $this->meta_title = strip_tags(implode(' ' . Configuration::get('PS_NAVIGATION_PIPE') . ' ', $this->meta_title));\n        }\n        $this->context->smarty->assign('meta_title', $this->meta_title);\n\n        $template_dirs = $this->context->smarty->getTemplateDir();\n\n        // Check if header/footer have been overriden\n        $dir = $this->context->smarty->getTemplateDir(0) . 'controllers' . DIRECTORY_SEPARATOR . trim($this->override_folder, '\\\\/') . DIRECTORY_SEPARATOR;\n        $module_list_dir = $this->context->smarty->getTemplateDir(0) . 'helpers' . DIRECTORY_SEPARATOR . 'modules_list' . DIRECTORY_SEPARATOR;\n\n        $header_tpl = file_exists($dir . 'header.tpl') ? $dir . 'header.tpl' : 'header.tpl';\n        $page_header_toolbar = file_exists($dir . 'page_header_toolbar.tpl') ? $dir . 'page_header_toolbar.tpl' : 'page_header_toolbar.tpl';\n        $footer_tpl = file_exists($dir . 'footer.tpl') ? $dir . 'footer.tpl' : 'footer.tpl';\n        $modal_module_list = file_exists($module_list_dir . 'modal.tpl') ? $module_list_dir . 'modal.tpl' : '';\n        $tpl_action = $this->tpl_folder . $this->display . '.tpl';\n\n        // Check if action template has been overridden\n        foreach ($template_dirs as $template_dir) {\n            if (file_exists($template_dir . DIRECTORY_SEPARATOR . $tpl_action) && $this->display != 'view' && $this->display != 'options') {\n                if (method_exists($this, $this->display . Tools::toCamelCase($this->className))) {\n                    $this->{$this->display . Tools::toCamelCase($this->className)}();\n                }\n                $this->context->smarty->assign('content', $this->context->smarty->fetch($tpl_action));\n\n                break;\n            }\n        }\n\n        if (!$this->ajax) {\n            $template = $this->createTemplate($this->template);\n            $page = $template->fetch();\n        } else {\n            $page = $this->content;\n        }\n\n        if ($conf = Tools::getValue('conf')) {\n            $this->context->smarty->assign('conf', $this->json ? json_encode($this->_conf[(int) $conf]) : $this->_conf[(int) $conf]);\n        }\n\n        if ($error = Tools::getValue('error')) {\n            $this->context->smarty->assign('error', $this->json ? json_encode($this->_error[(int) $error]) : $this->_error[(int) $error]);\n        }\n\n        foreach (['errors', 'warnings', 'informations', 'confirmations'] as $type) {\n            if (!is_array($this->$type)) {\n                $this->$type = (array) $this->$type;\n            }\n            $this->context->smarty->assign($type, $this->json ? json_encode(array_unique($this->$type)) : array_unique($this->$type));\n        }\n\n        if ($this->show_page_header_toolbar && !$this->lite_display) {\n            $this->context->smarty->assign(\n                [\n                    'page_header_toolbar' => $this->context->smarty->fetch($page_header_toolbar),\n                ]\n            );\n            if (!empty($modal_module_list)) {\n                $this->context->smarty->assign(\n                    [\n                        'modal_module_list' => $this->context->smarty->fetch($modal_module_list),\n                    ]\n                );\n            }\n        }\n\n        $this->context->smarty->assign('baseAdminUrl', __PS_BASE_URI__ . basename(_PS_ADMIN_DIR_) . '/');\n\n        $this->context->smarty->assign(\n            [\n                'page' => $this->json ? json_encode($page) : $page,\n                'header' => $this->context->smarty->fetch($header_tpl),\n                'footer' => $this->context->smarty->fetch($footer_tpl),\n            ]\n        );\n\n        $this->smartyOutputContent($this->layout);\n    }\n\n    /**\n     * Add a warning message to display at the top of the page.\n     *\n     * @param string $msg\n     */\n    protected function displayWarning($msg)\n    {\n        $this->warnings[] = $msg;\n    }\n\n    /**\n     * Add a info message to display at the top of the page.\n     *\n     * @param string $msg\n     */\n    protected function displayInformation($msg)\n    {\n        $this->informations[] = $msg;\n    }\n\n    /**\n     * Assign smarty variables for the header.\n     */\n    public function initHeader()\n    {\n        header('Cache-Control: no-store, no-cache');\n\n        // Multishop\n        $is_multishop = Shop::isFeatureActive();\n\n        // Quick access\n        if ((int) $this->context->employee->id) {\n            $quick_access = QuickAccess::getQuickAccessesWithToken($this->context->language->id, (int) $this->context->employee->id);\n        }\n\n        $tabs = $this->getTabs();\n        $currentTabLevel = 0;\n        foreach ($tabs as $tab) {\n            $currentTabLevel = isset($tab['current_level']) ? $tab['current_level'] : $currentTabLevel;\n        }\n\n        if (Validate::isLoadedObject($this->context->employee)) {\n            $accesses = Profile::getProfileAccesses($this->context->employee->id_profile, 'class_name');\n            $helperShop = new HelperShop();\n            /* Hooks are voluntary out the initialize array (need those variables already assigned) */\n            $bo_color = empty($this->context->employee->bo_color) ? '#FFFFFF' : $this->context->employee->bo_color;\n            $this->context->smarty->assign([\n                'help_box' => Configuration::get('PS_HELPBOX'),\n                'round_mode' => Configuration::get('PS_PRICE_ROUND_MODE'),\n                'brightness' => Tools::getBrightness($bo_color) < 128 ? 'white' : '#383838',\n                'bo_width' => (int) $this->context->employee->bo_width,\n                'bo_color' => isset($this->context->employee->bo_color) ? Tools::htmlentitiesUTF8($this->context->employee->bo_color) : null,\n                'show_new_orders' => Configuration::get('PS_SHOW_NEW_ORDERS') && isset($accesses['AdminOrders']) && $accesses['AdminOrders']['view'],\n                'show_new_customers' => Configuration::get('PS_SHOW_NEW_CUSTOMERS') && isset($accesses['AdminCustomers']) && $accesses['AdminCustomers']['view'],\n                'show_new_messages' => Configuration::get('PS_SHOW_NEW_MESSAGES') && isset($accesses['AdminCustomerThreads']) && $accesses['AdminCustomerThreads']['view'],\n                'employee' => $this->context->employee,\n                'search_type' => Tools::getValue('bo_search_type'),\n                'bo_query' => Tools::safeOutput(Tools::stripslashes(Tools::getValue('bo_query'))),\n                'quick_access' => empty($quick_access) ? false : $quick_access,\n                'multi_shop' => Shop::isFeatureActive(),\n                'shop_list' => $helperShop->getRenderedShopList(),\n                'current_shop_name' => $helperShop->getCurrentShopName(),\n                'shop' => $this->context->shop,\n                'shop_group' => new ShopGroup((int) Shop::getContextShopGroupID()),\n                'is_multishop' => $is_multishop,\n                'multishop_context' => $this->multishop_context,\n                'default_tab_link' => $this->context->link->getAdminLink(Tab::getClassNameById((int) Context::getContext()->employee->default_tab)),\n                'login_link' => $this->context->link->getAdminLink('AdminLogin'),\n                'logout_link' => $this->context->link->getAdminLink('AdminLogin', true, [], ['logout' => 1]),\n                'collapse_menu' => isset($this->context->cookie->collapse_menu) ? (int) $this->context->cookie->collapse_menu : 0,\n            ]);\n        } else {\n            $this->context->smarty->assign('default_tab_link', $this->context->link->getAdminLink('AdminDashboard'));\n        }\n\n        // Shop::initialize() in config.php may empty $this->context->shop->virtual_uri so using a new shop instance for getBaseUrl()\n        $this->context->shop = new Shop((int) $this->context->shop->id);\n\n        $this->context->smarty->assign([\n            'img_dir' => _PS_IMG_,\n            'iso' => $this->context->language->iso_code,\n            'class_name' => $this->className,\n            'iso_user' => $this->context->language->iso_code,\n            'lang_is_rtl' => $this->context->language->is_rtl,\n            'country_iso_code' => $this->context->country->iso_code,\n            'version' => _PS_VERSION_,\n            'lang_iso' => $this->context->language->iso_code,\n            'full_language_code' => $this->context->language->language_code,\n            'full_cldr_language_code' => $this->context->getCurrentLocale()->getCode(),\n            'link' => $this->context->link,\n            'shop_name' => Configuration::get('PS_SHOP_NAME'),\n            'base_url' => $this->context->shop->getBaseURL(),\n            'current_parent_id' => (int) Tab::getCurrentParentId(),\n            'tabs' => $tabs,\n            'current_tab_level' => $currentTabLevel,\n            'install_dir_exists' => file_exists(_PS_ADMIN_DIR_ . '/../install'),\n            'pic_dir' => _THEME_PROD_PIC_DIR_,\n            'controller_name' => htmlentities(Tools::getValue('controller')),\n            'currentIndex' => self::$currentIndex,\n            'bootstrap' => $this->bootstrap,\n            'default_language' => (int) Configuration::get('PS_LANG_DEFAULT'),\n            'display_addons_connection' => Tab::checkTabRights(Tab::getIdFromClassName('AdminModulesController')),\n        ]);\n    }\n\n    private function getNotificationTip($type)\n    {\n        $tips = [\n            'order' => [\n                $this->trans('Did you check your conversion rate lately?', [], 'Admin.Navigation.Notification'),\n                $this->trans('How about some seasonal discounts?', [], 'Admin.Navigation.Notification'),\n                $this->trans(\n                    'Have you checked your [1][2]abandoned carts[/2][/1]?[3]Your next order could be hiding there!',\n                        [\n                            '[1]' => '<strong>',\n                            '[/1]' => '</strong>',\n                            '[2]' => '<a href=\"' . $this->context->link->getAdminLink('AdminCarts', true, [], ['action' => 'filterOnlyAbandonedCarts']) . '\">',\n                            '[/2]' => '</a>',\n                            '[3]' => '<br>',\n                        ],\n                        'Admin.Navigation.Notification'\n                ),\n            ],\n            'customer' => [\n                $this->trans('Have you sent any acquisition email lately?', [], 'Admin.Navigation.Notification'),\n                $this->trans('Are you active on social media these days?', [], 'Admin.Navigation.Notification'),\n                $this->trans('Have you considered selling on marketplaces?', [], 'Admin.Navigation.Notification'),\n            ],\n            'customer_message' => [\n                $this->trans('That\\'s more time for something else!', [], 'Admin.Navigation.Notification'),\n                $this->trans('No news is good news, isn\\'t it?', [], 'Admin.Navigation.Notification'),\n                $this->trans('Seems like all your customers are happy :)', [], 'Admin.Navigation.Notification'),\n            ],\n        ];\n\n        if (!isset($tips[$type])) {\n            return '';\n        }\n\n        return $tips[$type][array_rand($tips[$type])];\n    }\n\n    private function getTabs($parentId = 0, $level = 0)\n    {\n        $tabs = Tab::getTabs($this->context->language->id, $parentId);\n        $current_id = Tab::getCurrentParentId($this->controller_name ? $this->controller_name : '');\n\n        foreach ($tabs as $index => $tab) {\n            if (!Tab::checkTabRights($tab['id_tab'])\n                || !$tab['enabled']\n                || ($tab['class_name'] == 'AdminStock' && Configuration::get('PS_ADVANCED_STOCK_MANAGEMENT') == 0)\n                || $tab['class_name'] == 'AdminCarrierWizard') {\n                unset($tabs[$index]);\n\n                continue;\n            }\n\n            // tab[class_name] does not contains the \"Controller\" suffix\n            if (($tab['class_name'] . 'Controller' == get_class($this)) || ($current_id == $tab['id_tab']) || $tab['class_name'] == $this->controller_name) {\n                $tabs[$index]['current'] = true;\n                $tabs[$index]['current_level'] = $level;\n            } else {\n                $tabs[$index]['current'] = false;\n            }\n            $tabs[$index]['img'] = null;\n            $tabs[$index]['href'] = $this->context->link->getTabLink($tab);\n            $tabs[$index]['sub_tabs'] = array_values($this->getTabs($tab['id_tab'], $level + 1));\n\n            $subTabHref = $this->getTabLinkFromSubTabs($tabs[$index]['sub_tabs']);\n            if (!empty($subTabHref)) {\n                $tabs[$index]['href'] = $subTabHref;\n            } elseif (0 == $tabs[$index]['id_parent'] && '' == $tabs[$index]['icon']) {\n                unset($tabs[$index]);\n            } elseif (empty($tabs[$index]['icon'])) {\n                $tabs[$index]['icon'] = 'extension';\n            }\n\n            if (array_key_exists($index, $tabs) && array_key_exists('sub_tabs', $tabs[$index])) {\n                foreach ($tabs[$index]['sub_tabs'] as $sub_tab) {\n                    if ((int) $sub_tab['current'] == true) {\n                        $tabs[$index]['current'] = true;\n                        $tabs[$index]['current_level'] = $sub_tab['current_level'];\n                    }\n                }\n            }\n        }\n\n        return $tabs;\n    }\n\n    /**\n     * Declare an action to use for each row in the list.\n     *\n     * @param string $action\n     */\n    public function addRowAction($action)\n    {\n        $action = strtolower($action);\n        $this->actions[] = $action;\n    }\n\n    /**\n     * Add an action to use for each row in the list.\n     *\n     * @param string $action\n     * @param array $list\n     */\n    public function addRowActionSkipList($action, $list)\n    {\n        $action = strtolower($action);\n        $list = (array) $list;\n\n        if (array_key_exists($action, $this->list_skip_actions)) {\n            $this->list_skip_actions[$action] = array_merge($this->list_skip_actions[$action], $list);\n        } else {\n            $this->list_skip_actions[$action] = $list;\n        }\n    }\n\n    /**\n     * Assign smarty variables for all default views, list and form, then call other init functions.\n     */\n    public function initContent()\n    {\n        if (!$this->viewAccess()) {\n            $this->errors[] = $this->trans('You do not have permission to view this.', [], 'Admin.Notifications.Error');\n\n            return;\n        }\n\n        if ($this->display == 'edit' || $this->display == 'add') {\n            if (!$this->loadObject(true)) {\n                return;\n            }\n\n            $this->content .= $this->renderForm();\n        } elseif ($this->display == 'view') {\n            // Some controllers use the view action without an object\n            if ($this->className) {\n                $this->loadObject(true);\n            }\n            $this->content .= $this->renderView();\n        } elseif ($this->display == 'details') {\n            $this->content .= $this->renderDetails();\n        } elseif (!$this->ajax) {\n            // FIXME: Sorry. I'm not very proud of this, but no choice... Please wait sf refactoring to solve this.\n            if (get_class($this) != 'AdminCarriersController') {\n                $this->content .= $this->renderModulesList();\n            }\n            $this->content .= $this->renderKpis();\n            $this->content .= $this->renderList();\n            $this->content .= $this->renderOptions();\n\n            // if we have to display the required fields form\n            if ($this->required_database) {\n                $this->content .= $this->displayRequiredFields();\n            }\n        }\n\n        $this->context->smarty->assign([\n            'content' => $this->content,\n        ]);\n    }\n\n    public function initToolbarFlags()\n    {\n        $this->getLanguages();\n\n        $this->initToolbar();\n        $this->initTabModuleList();\n        $this->initPageHeaderToolbar();\n\n        $this->context->smarty->assign([\n            'maintenance_mode' => !(bool) Configuration::get('PS_SHOP_ENABLE'),\n            'debug_mode' => (bool) _PS_MODE_DEV_,\n            'lite_display' => $this->lite_display,\n            'url_post' => self::$currentIndex . '&token=' . $this->token,\n            'show_page_header_toolbar' => $this->show_page_header_toolbar,\n            'page_header_toolbar_title' => $this->page_header_toolbar_title,\n            'title' => $this->page_header_toolbar_title,\n            'toolbar_btn' => $this->page_header_toolbar_btn,\n            'page_header_toolbar_btn' => $this->page_header_toolbar_btn,\n        ]);\n    }\n\n    /**\n     * Init tab modules list and add button in toolbar.\n     */\n    protected function initTabModuleList()\n    {\n        if (!$this->isFresh(Module::CACHE_FILE_MUST_HAVE_MODULES_LIST, 86400)) {\n            @file_put_contents(_PS_ROOT_DIR_ . Module::CACHE_FILE_MUST_HAVE_MODULES_LIST, Tools::addonsRequest('must-have'));\n        }\n        if (!$this->isFresh(Module::CACHE_FILE_TAB_MODULES_LIST, 604800)) {\n            $this->refresh(Module::CACHE_FILE_TAB_MODULES_LIST, _PS_TAB_MODULE_LIST_URL_);\n        }\n\n        $this->tab_modules_list = Tab::getTabModulesList($this->id);\n\n        if (is_array($this->tab_modules_list['default_list']) && count($this->tab_modules_list['default_list'])) {\n            $this->filter_modules_list = $this->tab_modules_list['default_list'];\n        } elseif (is_array($this->tab_modules_list['slider_list']) && count($this->tab_modules_list['slider_list'])) {\n            $this->addToolBarModulesListButton();\n            $this->addPageHeaderToolBarModulesListButton();\n            $this->context->smarty->assign([\n                'tab_modules_list' => implode(',', $this->tab_modules_list['slider_list']),\n                'admin_module_ajax_url' => $this->context->link->getAdminLink('AdminModules'),\n                'back_tab_modules_list' => $this->context->link->getAdminLink(Tools::getValue('controller')),\n                'tab_modules_open' => (int) Tools::getValue('tab_modules_open'),\n            ]);\n        }\n    }\n\n    protected function addPageHeaderToolBarModulesListButton()\n    {\n        $this->filterTabModuleList();\n\n        if (is_array($this->tab_modules_list['slider_list']) && count($this->tab_modules_list['slider_list'])) {\n            $this->page_header_toolbar_btn['modules-list'] = [\n                'href' => $this->getAdminModulesUrl(),\n                'desc' => $this->trans('Recommended Modules'),\n            ];\n        }\n    }\n\n    protected function addToolBarModulesListButton()\n    {\n        $this->filterTabModuleList();\n\n        if (is_array($this->tab_modules_list['slider_list']) && count($this->tab_modules_list['slider_list'])) {\n            $this->toolbar_btn['modules-list'] = [\n                'href' => $this->getAdminModulesUrl(),\n                'desc' => $this->trans('Recommended Modules'),\n            ];\n        }\n    }\n\n    protected function getAdminModulesUrl()\n    {\n        return $this->context->link->getAdminLink('AdminModulesCatalog');\n    }\n\n    protected function filterTabModuleList()\n    {\n        static $list_is_filtered = null;\n\n        if ($list_is_filtered !== null) {\n            return;\n        }\n\n        if (!$this->isFresh(Module::CACHE_FILE_DEFAULT_COUNTRY_MODULES_LIST, 86400)) {\n            file_put_contents(_PS_ROOT_DIR_ . Module::CACHE_FILE_DEFAULT_COUNTRY_MODULES_LIST, Tools::addonsRequest('native'));\n        }\n\n        if (!$this->isFresh(Module::CACHE_FILE_ALL_COUNTRY_MODULES_LIST, 86400)) {\n            file_put_contents(_PS_ROOT_DIR_ . Module::CACHE_FILE_ALL_COUNTRY_MODULES_LIST, Tools::addonsRequest('native_all'));\n        }\n\n        if (!$this->isFresh(Module::CACHE_FILE_MUST_HAVE_MODULES_LIST, 86400)) {\n            @file_put_contents(_PS_ROOT_DIR_ . Module::CACHE_FILE_MUST_HAVE_MODULES_LIST, Tools::addonsRequest('must-have'));\n        }\n\n        libxml_use_internal_errors(true);\n\n        $country_module_list = file_get_contents(_PS_ROOT_DIR_ . Module::CACHE_FILE_DEFAULT_COUNTRY_MODULES_LIST);\n        $must_have_module_list = file_get_contents(_PS_ROOT_DIR_ . Module::CACHE_FILE_MUST_HAVE_MODULES_LIST);\n        $all_module_list = [];\n\n        if (!empty($country_module_list) && $country_module_list_xml = @simplexml_load_string($country_module_list)) {\n            $country_module_list_array = [];\n            if (is_object($country_module_list_xml->module)) {\n                foreach ($country_module_list_xml->module as $k => $m) {\n                    $all_module_list[] = (string) $m->name;\n                }\n            }\n        } else {\n            foreach (libxml_get_errors() as $error) {\n                $this->errors[] = $this->trans('Error found : %1$s in country_module_list.xml file.', [$error->message], 'Admin.Modules.Notification');\n            }\n        }\n\n        libxml_clear_errors();\n\n        if (!empty($must_have_module_list) && $must_have_module_list_xml = @simplexml_load_string($must_have_module_list)) {\n            $must_have_module_list_array = [];\n            if (is_object($country_module_list_xml->module)) {\n                foreach ($must_have_module_list_xml->module as $l => $mo) {\n                    $all_module_list[] = (string) $mo->name;\n                }\n            }\n        } else {\n            foreach (libxml_get_errors() as $error) {\n                $this->errors[] = $this->trans('Error found : %1$s in must_have_module_list.xml file.', [$error->message], 'Admin.Modules.Notification');\n            }\n        }\n\n        libxml_clear_errors();\n\n        $this->tab_modules_list['slider_list'] = array_intersect($this->tab_modules_list['slider_list'], $all_module_list);\n\n        $list_is_filtered = true;\n    }\n\n    /**\n     * Initialize the invalid doom page of death.\n     */\n    public function initCursedPage()\n    {\n        $this->layout = 'invalid_token.tpl';\n    }\n\n    /**\n     * Assign smarty variables for the footer.\n     */\n    public function initFooter()\n    {\n        //RTL Support\n        //rtl.js overrides inline styles\n        //iso_code.css overrides default fonts for every language (optional)\n        if ($this->context->language->is_rtl) {\n            $this->addJS(_PS_JS_DIR_ . 'rtl.js');\n            $this->addCSS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/css/' . $this->context->language->iso_code . '.css', 'all', false);\n        }\n\n        // We assign js and css files on the last step before display template, because controller can add many js and css files\n        $this->context->smarty->assign('css_files', $this->css_files);\n        $this->context->smarty->assign('js_files', array_unique($this->js_files));\n\n        $this->context->smarty->assign([\n            'ps_version' => _PS_VERSION_,\n            'timer_start' => $this->timer_start,\n            'iso_is_fr' => strtoupper($this->context->language->iso_code) == 'FR',\n            'modals' => $this->renderModal(),\n        ]);\n    }\n\n    /**\n     * @throws Exception\n     * @throws SmartyException\n     */\n    public function initModal()\n    {\n        if ($this->logged_on_addons) {\n            $this->context->smarty->assign([\n                'logged_on_addons' => 1,\n                'username_addons' => $this->context->cookie->username_addons,\n            ]);\n        }\n\n        // Iso needed to generate Addons login\n        $iso_code_caps = strtoupper($this->context->language->iso_code);\n\n        $this->context->smarty->assign([\n            'img_base_path' => __PS_BASE_URI__ . basename(_PS_ADMIN_DIR_) . '/',\n            'check_url_fopen' => (ini_get('allow_url_fopen') ? 'ok' : 'ko'),\n            'check_openssl' => (extension_loaded('openssl') ? 'ok' : 'ko'),\n            'add_permission' => 1,\n            'addons_register_link' => 'https://addons.prestashop.com/' . $this->context->language->iso_code . '/login?'\n                . 'email=' . urlencode($this->context->employee->email)\n                . '&firstname=' . urlencode($this->context->employee->firstname)\n                . '&lastname=' . urlencode($this->context->employee->lastname)\n                . '&website=' . urlencode($this->context->shop->getBaseURL())\n                . '&utm_source=back-office&utm_medium=connect-to-addons'\n                . '&utm_campaign=back-office-' . Tools::strtoupper($this->context->language->iso_code)\n                . '&utm_content=' . (defined('_PS_HOST_MODE_') ? 'cloud' : 'download') . '#createnow',\n            'addons_forgot_password_link' => '//addons.prestashop.com/' . $this->context->language->iso_code . '/forgot-your-password',\n        ]);\n\n        $this->modals[] = [\n            'modal_id' => 'modal_addons_connect',\n            'modal_class' => 'modal-md',\n            'modal_title' => '<i class=\"icon-puzzle-piece\"></i> <a target=\"_blank\" href=\"https://addons.prestashop.com/'\n            . '?utm_source=back-office&utm_medium=modules'\n            . '&utm_campaign=back-office-' . Tools::strtoupper($this->context->language->iso_code)\n            . '&utm_content=' . (defined('_PS_HOST_MODE_') ? 'cloud' : 'download') . '\">PrestaShop Addons</a>',\n            'modal_content' => $this->context->smarty->fetch('controllers/modules/login_addons.tpl'),\n        ];\n    }\n\n    /**\n     * @return string\n     *\n     * @throws Exception\n     * @throws SmartyException\n     */\n    public function renderModal()\n    {\n        $modal_render = '';\n        if (is_array($this->modals) && count($this->modals)) {\n            foreach ($this->modals as $modal) {\n                $this->context->smarty->assign($modal);\n                $modal_render .= $this->context->smarty->fetch('modal.tpl');\n            }\n        }\n\n        return $modal_render;\n    }\n\n    /**\n     * Was used to display a list of recommended modules.\n     *\n     * @param string|bool $tracking_source Source information for URL used by \"Install\" button\n     *\n     * @return string Empty\n     *\n     * @deprecated since 1.7.4.0\n     */\n    public function renderModulesList($tracking_source = false)\n    {\n        return '';\n    }\n\n    /**\n     * Function used to render the list to display for this controller.\n     *\n     * @return string|false\n     *\n     * @throws PrestaShopException\n     */\n    public function renderList()\n    {\n        if (!($this->fields_list && is_array($this->fields_list))) {\n            return false;\n        }\n        $this->getList($this->context->language->id);\n\n        // If list has 'active' field, we automatically create bulk action\n        if (isset($this->fields_list) && is_array($this->fields_list) && array_key_exists('active', $this->fields_list)\n            && !empty($this->fields_list['active'])) {\n            if (!is_array($this->bulk_actions)) {\n                $this->bulk_actions = [];\n            }\n\n            $this->bulk_actions = array_merge([\n                'enableSelection' => [\n                    'text' => $this->trans('Enable selection'),\n                    'icon' => 'icon-power-off text-success',\n                ],\n                'disableSelection' => [\n                    'text' => $this->trans('Disable selection'),\n                    'icon' => 'icon-power-off text-danger',\n                ],\n                'divider' => [\n                    'text' => 'divider',\n                ],\n            ], $this->bulk_actions);\n        }\n\n        $helper = new HelperList();\n\n        // Empty list is ok\n        if (!is_array($this->_list)) {\n            $this->displayWarning($this->trans('Bad SQL query') . '<br />' . htmlspecialchars($this->_list_error));\n\n            return false;\n        }\n\n        $this->setHelperDisplay($helper);\n        $helper->_default_pagination = $this->_default_pagination;\n        $helper->_pagination = $this->_pagination;\n        $helper->tpl_vars = $this->getTemplateListVars();\n        $helper->tpl_delete_link_vars = $this->tpl_delete_link_vars;\n\n        // For compatibility reasons, we have to check standard actions in class attributes\n        foreach ($this->actions_available as $action) {\n            if (!in_array($action, $this->actions) && isset($this->$action) && $this->$action) {\n                $this->actions[] = $action;\n            }\n        }\n\n        $helper->is_cms = $this->is_cms;\n        $helper->sql = $this->_listsql;\n        $list = $helper->generateList($this->_list, $this->fields_list);\n\n        return $list;\n    }\n\n    public function getTemplateListVars()\n    {\n        return $this->tpl_list_vars;\n    }\n\n    /**\n     * Override to render the view page.\n     *\n     * @return string\n     */\n    public function renderView()\n    {\n        $helper = new HelperView($this);\n        $this->setHelperDisplay($helper);\n        $helper->tpl_vars = $this->getTemplateViewVars();\n        if (null !== $this->base_tpl_view) {\n            $helper->base_tpl = $this->base_tpl_view;\n        }\n        $view = $helper->generateView();\n\n        return $view;\n    }\n\n    public function getTemplateViewVars()\n    {\n        return $this->tpl_view_vars;\n    }\n\n    /**\n     * Override to render the view page.\n     *\n     * @return string|false\n     */\n    public function renderDetails()\n    {\n        return $this->renderList();\n    }\n\n    /**\n     * Function used to render the form for this controller.\n     *\n     * @return string\n     *\n     * @throws Exception\n     * @throws SmartyException\n     */\n    public function renderForm()\n    {\n        if (!$this->default_form_language) {\n            $this->getLanguages();\n        }\n\n        if (Tools::getValue('submitFormAjax')) {\n            $this->content .= $this->context->smarty->fetch('form_submit_ajax.tpl');\n        }\n\n        if ($this->fields_form && is_array($this->fields_form)) {\n            if (!$this->multiple_fieldsets) {\n                $this->fields_form = [['form' => $this->fields_form]];\n            }\n\n            // For add a fields via an override of $fields_form, use $fields_form_override\n            if (is_array($this->fields_form_override) && !empty($this->fields_form_override)) {\n                $this->fields_form[0]['form']['input'] = array_merge($this->fields_form[0]['form']['input'], $this->fields_form_override);\n            }\n\n            $fields_value = $this->getFieldsValue($this->object);\n\n            Hook::exec('action' . $this->controller_name . 'FormModifier', [\n                'object' => &$this->object,\n                'fields' => &$this->fields_form,\n                'fields_value' => &$fields_value,\n                'form_vars' => &$this->tpl_form_vars,\n            ]);\n\n            $helper = new HelperForm($this);\n            $this->setHelperDisplay($helper);\n            $helper->fields_value = $fields_value;\n            $helper->submit_action = $this->submit_action;\n            $helper->tpl_vars = $this->getTemplateFormVars();\n            $helper->show_cancel_button = (isset($this->show_form_cancel_button)) ? $this->show_form_cancel_button : ($this->display == 'add' || $this->display == 'edit');\n\n            $back = urldecode(Tools::getValue('back', ''));\n            if (empty($back)) {\n                $back = self::$currentIndex . '&token=' . $this->token;\n            }\n            if (!Validate::isCleanHtml($back)) {\n                die(Tools::displayError());\n            }\n\n            $helper->back_url = $back;\n            null !== $this->base_tpl_form ? $helper->base_tpl = $this->base_tpl_form : '';\n            if ($this->access('view')) {\n                if (Tools::getValue('back')) {\n                    $helper->tpl_vars['back'] = Tools::safeOutput(Tools::getValue('back'));\n                } else {\n                    $helper->tpl_vars['back'] = Tools::safeOutput(Tools::getValue(self::$currentIndex . '&token=' . $this->token));\n                }\n            }\n            $form = $helper->generateForm($this->fields_form);\n\n            return $form;\n        }\n    }\n\n    public function getTemplateFormVars()\n    {\n        return $this->tpl_form_vars;\n    }\n\n    public function renderKpis()\n    {\n    }\n\n    /**\n     * Function used to render the options for this controller.\n     *\n     * @return string\n     */\n    public function renderOptions()\n    {\n        Hook::exec('action' . $this->controller_name . 'OptionsModifier', [\n            'options' => &$this->fields_options,\n            'option_vars' => &$this->tpl_option_vars,\n        ]);\n\n        if ($this->fields_options && is_array($this->fields_options)) {\n            if (isset($this->display) && $this->display != 'options' && $this->display != 'list') {\n                $this->show_toolbar = false;\n            } else {\n                $this->display = 'options';\n            }\n\n            unset($this->toolbar_btn);\n            $this->initToolbar();\n            $helper = new HelperOptions($this);\n            $this->setHelperDisplay($helper);\n            $helper->id = $this->id;\n            $helper->tpl_vars = $this->tpl_option_vars;\n            $options = $helper->generateOptions($this->fields_options);\n\n            return $options;\n        }\n    }\n\n    /**\n     * This function sets various display options for helper list.\n     *\n     * @param Helper $helper\n     */\n    public function setHelperDisplay(Helper $helper)\n    {\n        if (empty($this->toolbar_title)) {\n            $this->initToolbarTitle();\n        }\n        // tocheck\n        if ($this->object && $this->object->id) {\n            $helper->id = $this->object->id;\n        }\n\n        // @todo : move that in Helper\n        $helper->title = is_array($this->toolbar_title) ? implode(' ' . Configuration::get('PS_NAVIGATION_PIPE') . ' ', $this->toolbar_title) : $this->toolbar_title;\n        $helper->toolbar_btn = $this->toolbar_btn;\n        $helper->show_toolbar = $this->show_toolbar;\n        $helper->toolbar_scroll = $this->toolbar_scroll;\n        $helper->override_folder = $this->tpl_folder;\n        $helper->actions = $this->actions;\n        $helper->simple_header = $this->list_simple_header;\n        $helper->bulk_actions = $this->bulk_actions;\n        $helper->currentIndex = self::$currentIndex;\n        $helper->className = $this->className;\n        $helper->table = $this->table;\n        $helper->name_controller = Tools::getValue('controller');\n        $helper->orderBy = $this->_orderBy;\n        $helper->orderWay = $this->_orderWay;\n        $helper->listTotal = $this->_listTotal;\n        $helper->shopLink = $this->shopLink;\n        $helper->shopLinkType = $this->shopLinkType;\n        $helper->identifier = $this->identifier;\n        $helper->token = $this->token;\n        $helper->languages = $this->_languages;\n        $helper->specificConfirmDelete = $this->specificConfirmDelete;\n        $helper->imageType = $this->imageType;\n        $helper->no_link = $this->list_no_link;\n        $helper->colorOnBackground = $this->colorOnBackground;\n        $helper->ajax_params = (isset($this->ajax_params) ? $this->ajax_params : null);\n        $helper->default_form_language = $this->default_form_language;\n        $helper->allow_employee_form_lang = $this->allow_employee_form_lang;\n        $helper->multiple_fieldsets = $this->multiple_fieldsets;\n        $helper->row_hover = $this->row_hover;\n        $helper->position_identifier = $this->position_identifier;\n        $helper->position_group_identifier = $this->position_group_identifier;\n        $helper->controller_name = $this->controller_name;\n        $helper->list_id = isset($this->list_id) ? $this->list_id : $this->table;\n        $helper->bootstrap = $this->bootstrap;\n\n        // For each action, try to add the corresponding skip elements list\n        $helper->list_skip_actions = $this->list_skip_actions;\n\n        $this->helper = $helper;\n    }\n\n    /**\n     * @deprecated 1.6.0\n     */\n    public function setDeprecatedMedia()\n    {\n    }\n\n    public function setMedia($isNewTheme = false)\n    {\n        if ($isNewTheme) {\n            $this->addCSS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/new-theme/public/theme.css', 'all', 1);\n            $this->addJS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/new-theme/public/main.bundle.js');\n            $this->addJqueryPlugin(['chosen']);\n        } else {\n            //Bootstrap\n            $this->addCSS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/css/' . $this->bo_css, 'all', 0);\n            $this->addCSS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/css/vendor/titatoggle-min.css', 'all', 0);\n            $this->addCSS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/public/theme.css', 'all', 0);\n\n            // add Jquery 3 and its migration script\n            $this->addJs(_PS_JS_DIR_ . 'jquery/jquery-3.4.1.min.js');\n            $this->addJs(_PS_JS_DIR_ . 'jquery/jquery-migrate-3.1.0.min.js');\n            // implement $.browser object and live method, that has been removed since jquery 1.9\n            $this->addJs(_PS_JS_DIR_ . 'jquery/jquery.browser-0.1.0.min.js');\n            $this->addJs(_PS_JS_DIR_ . 'jquery/jquery.live-polyfill-1.0.3.min.js');\n\n            $this->addJqueryPlugin(['scrollTo', 'alerts', 'chosen', 'autosize', 'fancybox']);\n            $this->addJqueryPlugin('growl', null, false);\n            $this->addJqueryUI(['ui.slider', 'ui.datepicker']);\n\n            $this->addJS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/js/vendor/bootstrap.min.js');\n            $this->addJS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/js/vendor/modernizr.min.js');\n            $this->addJS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/js/modernizr-loads.js');\n            $this->addJS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/js/vendor/moment-with-langs.min.js');\n            $this->addJS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/public/bundle.js');\n\n            $this->addJS(_PS_JS_DIR_ . 'jquery/plugins/timepicker/jquery-ui-timepicker-addon.js');\n\n            if (!$this->lite_display) {\n                $this->addJS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/js/help.js');\n            }\n\n            if (!Tools::getValue('submitFormAjax')) {\n                $this->addJS(_PS_JS_DIR_ . 'admin/notifications.js');\n            }\n\n            if (defined('_PS_HOST_MODE_') && _PS_HOST_MODE_) {\n                $this->addJS('https://cdn.statuspage.io/se-v2.js');\n\n                Media::addJsDefL('status_operational', $this->trans('Operational'));\n                Media::addJsDefL('status_degraded_performance', $this->trans('Degraded Performance'));\n                Media::addJsDefL('status_partial_outage', $this->trans('Partial Outage'));\n                Media::addJsDefL('status_major_outage', $this->trans('Major Outage'));\n                Media::addJsDef(['host_cluster' => defined('_PS_HOST_CLUSTER_') ? _PS_HOST_CLUSTER_ : 'fr1']);\n            }\n\n            // Specific Admin Theme\n            $this->addCSS(__PS_BASE_URI__ . $this->admin_webpath . '/themes/' . $this->bo_theme . '/css/overrides.css', 'all', PHP_INT_MAX);\n        }\n\n        $this->addJS([\n            _PS_JS_DIR_ . 'admin.js?v=' . _PS_VERSION_, // TODO: SEE IF REMOVABLE\n            __PS_BASE_URI__ . $this->admin_webpath . '/themes/new-theme/public/cldr.bundle.js',\n            _PS_JS_DIR_ . 'tools.js?v=' . _PS_VERSION_,\n            __PS_BASE_URI__ . $this->admin_webpath . '/public/bundle.js',\n        ]);\n\n        Media::addJsDef([\n            'changeFormLanguageUrl' => $this->context->link->getAdminLink(\n                'AdminEmployees',\n                true,\n                [],\n                ['action' => 'formLanguage']\n            ),\n        ]);\n        Media::addJsDef(['host_mode' => (defined('_PS_HOST_MODE_') && _PS_HOST_MODE_)]);\n        Media::addJsDef(['baseDir' => __PS_BASE_URI__]);\n        Media::addJsDef(['baseAdminDir' => __PS_BASE_URI__ . basename(_PS_ADMIN_DIR_) . '/']);\n        Media::addJsDef(['currency' => [\n            'iso_code' => Context::getContext()->currency->iso_code,\n            'sign' => Context::getContext()->currency->sign,\n            'name' => Context::getContext()->currency->name,\n            'format' => Context::getContext()->currency->format,\n        ]]);\n        Media::addJsDef(\n            [\n                'currency_specifications' => $this->preparePriceSpecifications($this->context),\n                'number_specifications' => $this->prepareNumberSpecifications($this->context),\n            ]\n        );\n\n        // Execute Hook AdminController SetMedia\n        Hook::exec('actionAdminControllerSetMedia');\n    }\n\n    /**\n     * Non-static method which uses AdminController::translate().\n     *\n     * @deprecated use Context::getContext()->getTranslator()->trans($id, $parameters, $domain, $locale); instead\n     *\n     * @param string $string Term or expression in english\n     * @param string|null $class Name of the class\n     * @param bool $addslashes If set to true, the return value will pass through addslashes(). Otherwise, stripslashes().\n     * @param bool $htmlentities If set to true(default), the return value will pass through htmlentities($string, ENT_QUOTES, 'utf-8')\n     *\n     * @return string the translation if available, or the english default text\n     */\n    protected function l($string, $class = null, $addslashes = false, $htmlentities = true)\n    {\n        $translated = $this->translator->trans($string);\n        if ($translated !== $string) {\n            return $translated;\n        }\n\n        if ($class === null || $class == 'AdminTab') {\n            $class = substr(get_class($this), 0, -10);\n        } elseif (strtolower(substr($class, -10)) == 'controller') {\n            /* classname has changed, from AdminXXX to AdminXXXController, so we remove 10 characters and we keep same keys */\n            $class = substr($class, 0, -10);\n        }\n\n        return Translate::getAdminTranslation($string, $class, $addslashes, $htmlentities);\n    }\n\n    /**\n     * Init context and dependencies, handles POST and GET.\n     */\n    public function init()\n    {\n        parent::init();\n\n        if (Tools::getValue('ajax')) {\n            $this->ajax = '1';\n        }\n\n        if (null === $this->context->link) {\n            $protocol_link = (Tools::usingSecureMode() && Configuration::get('PS_SSL_ENABLED')) ? 'https://' : 'http://';\n            $protocol_content = (Tools::usingSecureMode() && Configuration::get('PS_SSL_ENABLED')) ? 'https://' : 'http://';\n            $this->context->link = new Link($protocol_link, $protocol_content);\n        }\n\n        if (isset($_GET['logout'])) {\n            $this->context->employee->logout();\n        }\n        if (isset(Context::getContext()->cookie->last_activity)) {\n            if ($this->context->cookie->last_activity + self::AUTH_COOKIE_LIFETIME < time()) {\n                $this->context->employee->logout();\n            } else {\n                $this->context->cookie->last_activity = time();\n            }\n        }\n\n        if (\n            !$this->isAnonymousAllowed()\n            && (\n                $this->controller_name != 'AdminLogin'\n                && (\n                    !isset($this->context->employee)\n                    || !$this->context->employee->isLoggedBack()\n                )\n            )\n        ) {\n            if (isset($this->context->employee)) {\n                $this->context->employee->logout();\n            }\n            $email = false;\n            if (Tools::getValue('email') && Validate::isEmail(Tools::getValue('email'))) {\n                $email = Tools::getValue('email');\n            }\n            Tools::redirectAdmin($this->context->link->getAdminLink('AdminLogin') . ((!isset($_GET['logout']) && $this->controller_name != 'AdminNotFound' && Tools::getValue('controller')) ? '&redirect=' . $this->controller_name : '') . ($email ? '&email=' . $email : ''));\n        }\n\n        // Set current index\n        $current_index = 'index.php' . (($controller = Tools::getValue('controller')) ? '?controller=' . $controller : '');\n        if ($back = Tools::getValue('back')) {\n            $current_index .= '&back=' . urlencode($back);\n        }\n        self::$currentIndex = $current_index;\n\n        if ((int) Tools::getValue('liteDisplaying')) {\n            $this->display_header = false;\n            $this->display_header_javascript = true;\n            $this->display_footer = false;\n            $this->content_only = false;\n            $this->lite_display = true;\n        }\n\n        if ($this->ajax && method_exists($this, 'ajaxPreprocess')) {\n            $this->ajaxPreProcess();\n        }\n\n        $this->context->smarty->assign([\n            'table' => $this->table,\n            'current' => self::$currentIndex,\n            'token' => $this->token,\n            'host_mode' => defined('_PS_HOST_MODE_') ? 1 : 0,\n            'stock_management' => (int) Configuration::get('PS_STOCK_MANAGEMENT'),\n            'no_order_tip' => $this->getNotificationTip('order'),\n            'no_customer_tip' => $this->getNotificationTip('customer'),\n            'no_customer_message_tip' => $this->getNotificationTip('customer_message'),\n        ]);\n\n        if ($this->display_header) {\n            $this->context->smarty->assign('displayBackOfficeHeader', Hook::exec('displayBackOfficeHeader', []));\n        }\n\n        $this->context->smarty->assign([\n            'displayBackOfficeTop' => Hook::exec('displayBackOfficeTop', []),\n            'submit_form_ajax' => (int) Tools::getValue('submitFormAjax'),\n        ]);\n\n        Employee::setLastConnectionDate($this->context->employee->id);\n\n        $this->initProcess();\n        $this->initBreadcrumbs();\n        $this->initModal();\n        $this->initToolbarFlags();\n        $this->initNotifications();\n    }\n\n    /**\n     * Sets the smarty variables and js defs used to show / hide some notifications.\n     */\n    public function initNotifications()\n    {\n        $notificationsSettings = [\n            'show_new_orders' => Configuration::get('PS_SHOW_NEW_ORDERS'),\n            'show_new_customers' => Configuration::get('PS_SHOW_NEW_CUSTOMERS'),\n            'show_new_messages' => Configuration::get('PS_SHOW_NEW_MESSAGES '),\n        ];\n\n        $this->context->smarty->assign($notificationsSettings);\n\n        Media::addJsDef($notificationsSettings);\n    }\n\n    /**\n     * @throws PrestaShopException\n     */\n    public function initShopContext()\n    {\n        // Do not initialize context when the shop is not installed\n        if (defined('PS_INSTALLATION_IN_PROGRESS')) {\n            return;\n        }\n\n        // Change shop context ?\n        if (Shop::isFeatureActive() && Tools::getValue('setShopContext') !== false) {\n            $this->context->cookie->shopContext = Tools::getValue('setShopContext');\n            $url = parse_url($_SERVER['REQUEST_URI']);\n            $query = (isset($url['query'])) ? $url['query'] : '';\n            parse_str($query, $parse_query);\n            unset($parse_query['setShopContext'], $parse_query['conf']);\n            $http_build_query = http_build_query($parse_query, '', '&');\n            $this->redirect_after = $url['path'] . ($http_build_query ? '?' . $http_build_query : '');\n        } elseif (!Shop::isFeatureActive()) {\n            $this->context->cookie->shopContext = 's-' . (int) Configuration::get('PS_SHOP_DEFAULT');\n        } elseif (Shop::getTotalShops(false, null) < 2 && $this->context->employee->isLoggedBack()) {\n            $this->context->cookie->shopContext = 's-' . (int) $this->context->employee->getDefaultShopID();\n        }\n\n        $shop_id = null;\n        Shop::setContext(Shop::CONTEXT_ALL);\n        if ($this->context->cookie->shopContext && $this->context->employee->isLoggedBack()) {\n            $split = explode('-', $this->context->cookie->shopContext);\n            if (count($split) == 2) {\n                if ($split[0] == 'g') {\n                    if ($this->context->employee->hasAuthOnShopGroup((int) $split[1])) {\n                        Shop::setContext(Shop::CONTEXT_GROUP, (int) $split[1]);\n                    } else {\n                        $shop_id = (int) $this->context->employee->getDefaultShopID();\n                        Shop::setContext(Shop::CONTEXT_SHOP, $shop_id);\n                    }\n                } elseif (Shop::getShop($split[1]) && $this->context->employee->hasAuthOnShop($split[1])) {\n                    $shop_id = (int) $split[1];\n                    Shop::setContext(Shop::CONTEXT_SHOP, $shop_id);\n                } else {\n                    $shop_id = (int) $this->context->employee->getDefaultShopID();\n                    Shop::setContext(Shop::CONTEXT_SHOP, $shop_id);\n                }\n            }\n        }\n\n        // Check multishop context and set right context if need\n        if (!($this->multishop_context & Shop::getContext())) {\n            if (Shop::getContext() == Shop::CONTEXT_SHOP && !($this->multishop_context & Shop::CONTEXT_SHOP)) {\n                Shop::setContext(Shop::CONTEXT_GROUP, Shop::getContextShopGroupID());\n            }\n            if (Shop::getContext() == Shop::CONTEXT_GROUP && !($this->multishop_context & Shop::CONTEXT_GROUP)) {\n                Shop::setContext(Shop::CONTEXT_ALL);\n            }\n        }\n\n        // Replace existing shop if necessary\n        if (!$shop_id) {\n            $this->context->shop = new Shop((int) Configuration::get('PS_SHOP_DEFAULT'));\n        } elseif ($this->context->shop->id != $shop_id) {\n            $this->context->shop = new Shop((int) $shop_id);\n        }\n\n        // Replace current default country\n        $this->context->country = new Country((int) Configuration::get('PS_COUNTRY_DEFAULT'));\n        $this->context->currency = new Currency(Configuration::get('PS_CURRENCY_DEFAULT'));\n    }\n\n    /**\n     * Retrieve GET and POST value and translate them to actions.\n     */\n    public function initProcess()\n    {\n        if (!isset($this->list_id)) {\n            $this->list_id = $this->table;\n        }\n\n        // Manage list filtering\n        if (Tools::isSubmit('submitFilter' . $this->list_id)\n            || $this->context->cookie->{'submitFilter' . $this->list_id} !== false\n            || Tools::getValue($this->list_id . 'Orderby')\n            || Tools::getValue($this->list_id . 'Orderway')) {\n            $this->filter = true;\n        }\n\n        $this->id_object = (int) Tools::getValue($this->identifier);\n\n        /* Delete object image */\n        if (isset($_GET['deleteImage'])) {\n            if ($this->access('delete')) {\n                $this->action = 'delete_image';\n            } else {\n                $this->errors[] = $this->trans('You do not have permission to delete this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif (isset($_GET['delete' . $this->table])) {\n            /* Delete object */\n            if ($this->access('delete')) {\n                $this->action = 'delete';\n            } else {\n                $this->errors[] = $this->trans('You do not have permission to delete this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif ((isset($_GET['status' . $this->table]) || isset($_GET['status'])) && Tools::getValue($this->identifier)) {\n            /* Change object statuts (active, inactive) */\n            if ($this->access('edit')) {\n                $this->action = 'status';\n            } else {\n                $this->errors[] = $this->trans('You do not have permission to edit this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif (isset($_GET['position'])) {\n            /* Move an object */\n            if ($this->access('edit') == '1') {\n                $this->action = 'position';\n            } else {\n                $this->errors[] = $this->trans('You do not have permission to edit this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif (Tools::isSubmit('submitAdd' . $this->table)\n                 || Tools::isSubmit('submitAdd' . $this->table . 'AndStay')\n                 || Tools::isSubmit('submitAdd' . $this->table . 'AndPreview')\n                 || Tools::isSubmit('submitAdd' . $this->table . 'AndBackToParent')) {\n            // case 1: updating existing entry\n            if ($this->id_object) {\n                if ($this->access('edit')) {\n                    $this->action = 'save';\n                    if (Tools::isSubmit('submitAdd' . $this->table . 'AndStay')) {\n                        $this->display = 'edit';\n                    } else {\n                        $this->display = 'list';\n                    }\n                } else {\n                    $this->errors[] = $this->trans('You do not have permission to edit this.', [], 'Admin.Notifications.Error');\n                }\n            } else {\n                // case 2: creating new entry\n                if ($this->access('add')) {\n                    $this->action = 'save';\n                    if (Tools::isSubmit('submitAdd' . $this->table . 'AndStay')) {\n                        $this->display = 'edit';\n                    } else {\n                        $this->display = 'list';\n                    }\n                } else {\n                    $this->errors[] = $this->trans('You do not have permission to add this.', [], 'Admin.Notifications.Error');\n                }\n            }\n        } elseif (isset($_GET['add' . $this->table])) {\n            if ($this->access('add')) {\n                $this->action = 'new';\n                $this->display = 'add';\n            } else {\n                $this->errors[] = $this->trans('You do not have permission to add this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif (isset($_GET['update' . $this->table], $_GET[$this->identifier])) {\n            $this->display = 'edit';\n            if (!$this->access('edit')) {\n                $this->errors[] = $this->trans('You do not have permission to edit this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif (isset($_GET['view' . $this->table])) {\n            if ($this->access('view')) {\n                $this->display = 'view';\n                $this->action = 'view';\n            } else {\n                $this->errors[] = $this->trans('You do not have permission to view this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif (isset($_GET['details' . $this->table])) {\n            if ($this->access('view')) {\n                $this->display = 'details';\n                $this->action = 'details';\n            } else {\n                $this->errors[] = $this->trans('You do not have permission to view this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif (isset($_GET['export' . $this->table])) {\n            if ($this->access('view')) {\n                $this->action = 'export';\n            }\n        } elseif (isset($_POST['submitReset' . $this->list_id])) {\n            /* Cancel all filters for this tab */\n            $this->action = 'reset_filters';\n        } elseif (Tools::isSubmit('submitOptions' . $this->table) || Tools::isSubmit('submitOptions')) {\n            /* Submit options list */\n            $this->display = 'options';\n            if ($this->access('edit')) {\n                $this->action = 'update_options';\n            } else {\n                $this->errors[] = $this->trans('You do not have permission to edit this.', [], 'Admin.Notifications.Error');\n            }\n        } elseif (Tools::getValue('action') && method_exists($this, 'process' . ucfirst(Tools::toCamelCase(Tools::getValue('action'))))) {\n            $this->action = Tools::getValue('action');\n        } elseif (Tools::isSubmit('submitFields') && $this->required_database && $this->access('add') && $this->access('delete')) {\n            $this->action = 'update_fields';\n        } elseif (is_array($this->bulk_actions)) {\n            $submit_bulk_actions = array_merge([\n                'enableSelection' => [\n                    'text' => $this->trans('Enable selection'),\n                    'icon' => 'icon-power-off text-success',\n                ],\n                'disableSelection' => [\n                    'text' => $this->trans('Disable selection'),\n                    'icon' => 'icon-power-off text-danger',\n                ],\n            ], $this->bulk_actions);\n            foreach ($submit_bulk_actions as $bulk_action => $params) {\n                if (Tools::isSubmit('submitBulk' . $bulk_action . $this->table) || Tools::isSubmit('submitBulk' . $bulk_action)) {\n                    if ($bulk_action === 'delete') {\n                        if ($this->access('delete')) {\n                            $this->action = 'bulk' . $bulk_action;\n                            $this->boxes = Tools::getValue($this->table . 'Box');\n                            if (empty($this->boxes) && $this->table == 'attribute') {\n                                $this->boxes = Tools::getValue($this->table . '_valuesBox');\n                            }\n                        } else {\n                            $this->errors[] = $this->trans('You do not have permission to delete this.', [], 'Admin.Notifications.Error');\n                        }\n\n                        break;\n                    } elseif ($this->access('edit')) {\n                        $this->action = 'bulk' . $bulk_action;\n                        $this->boxes = Tools::getValue($this->table . 'Box');\n                    } else {\n                        $this->errors[] = $this->trans('You do not have permission to edit this.', [], 'Admin.Notifications.Error');\n                    }\n\n                    break;\n                } elseif (Tools::isSubmit('submitBulk')) {\n                    if ($bulk_action === 'delete') {\n                        if ($this->access('delete')) {\n                            $this->action = 'bulk' . $bulk_action;\n                            $this->boxes = Tools::getValue($this->table . 'Box');\n                        } else {\n                            $this->errors[] = $this->trans('You do not have permission to delete this.', [], 'Admin.Notifications.Error');\n                        }\n\n                        break;\n                    } elseif ($this->access('edit')) {\n                        $this->action = 'bulk' . Tools::getValue('select_submitBulk');\n                        $this->boxes = Tools::getValue($this->table . 'Box');\n                    } else {\n                        $this->errors[] = $this->trans('You do not have permission to edit this.', [], 'Admin.Notifications.Error');\n                    }\n\n                    break;\n                }\n            }\n        } elseif (!empty($this->fields_options) && empty($this->fields_list)) {\n            $this->display = 'options';\n        }\n    }\n\n    /**\n     * Get the current objects' list form the database.\n     *\n     * @param int $id_lang Language used for display\n     * @param string|null $order_by ORDER BY clause\n     * @param string|null $order_way Order way (ASC, DESC)\n     * @param int $start Offset in LIMIT clause\n     * @param int|null $limit Row count in LIMIT clause\n     * @param int|bool $id_lang_shop\n     *\n     * @throws PrestaShopDatabaseException\n     * @throws PrestaShopException\n     */\n    public function getList(\n        $id_lang,\n        $order_by = null,\n        $order_way = null,\n        $start = 0,\n        $limit = null,\n        $id_lang_shop = false\n    ) {\n        Hook::exec('action' . $this->controller_name . 'ListingFieldsModifier', [\n            'select' => &$this->_select,\n            'join' => &$this->_join,\n            'where' => &$this->_where,\n            'group_by' => &$this->_group,\n            'order_by' => &$this->_orderBy,\n            'order_way' => &$this->_orderWay,\n            'fields' => &$this->fields_list,\n        ]);\n\n        if (!isset($this->list_id)) {\n            $this->list_id = $this->table;\n        }\n\n        if (!Validate::isTableOrIdentifier($this->table)) {\n            throw new PrestaShopException(sprintf('Table name %s is invalid:', $this->table));\n        }\n\n        /* Check params validity */\n        if (!is_numeric($start) || !Validate::isUnsignedId($id_lang)) {\n            throw new PrestaShopException('get list params is not valid');\n        }\n\n        $limit = $this->checkSqlLimit($limit);\n\n        /* Determine offset from current page */\n        $start = 0;\n        if ((int) Tools::getValue('submitFilter' . $this->list_id)) {\n            $start = ((int) Tools::getValue('submitFilter' . $this->list_id) - 1) * $limit;\n        } elseif (\n            empty($start)\n            && isset($this->context->cookie->{$this->list_id . '_start'})\n            && Tools::isSubmit('export' . $this->table)\n        ) {\n            $start = $this->context->cookie->{$this->list_id . '_start'};\n        }\n\n        // Either save or reset the offset in the cookie\n        if ($start) {\n            $this->context->cookie->{$this->list_id . '_start'} = $start;\n        } elseif (isset($this->context->cookie->{$this->list_id . '_start'})) {\n            unset($this->context->cookie->{$this->list_id . '_start'});\n        }\n\n        /* Cache */\n        $this->_lang = (int) $id_lang;\n\n        // Add SQL shop restriction\n        $select_shop = '';\n        if ($this->shopLinkType) {\n            $select_shop = ', shop.name as shop_name ';\n        }\n\n        if ($this->multishop_context && Shop::isTableAssociated($this->table) && !empty($this->className)) {\n            if (Shop::getContext() != Shop::CONTEXT_ALL || !$this->context->employee->isSuperAdmin()) {\n                $test_join = !preg_match('#`?' . preg_quote(_DB_PREFIX_ . $this->table . '_shop') . '`? *sa#', $this->_join);\n                if (Shop::isFeatureActive() && $test_join && Shop::isTableAssociated($this->table)) {\n                    $this->_where .= ' AND EXISTS (\n                        SELECT 1\n                        FROM `' . _DB_PREFIX_ . $this->table . '_shop` sa\n                        WHERE a.`' . bqSQL($this->identifier) . '` = sa.`' . bqSQL($this->identifier) . '`\n                         AND sa.id_shop IN (' . implode(', ', Shop::getContextListShopID()) . ')\n                    )';\n                }\n            }\n        }\n\n        $fromClause = $this->getFromClause();\n        $joinClause = $this->getJoinClause($id_lang, $id_lang_shop);\n        $whereClause = $this->getWhereClause();\n        $orderByClause = $this->getOrderByClause($order_by, $order_way);\n\n        $shouldLimitSqlResults = $this->shouldLimitSqlResults($limit);\n\n        do {\n            $this->_listsql = '';\n\n            if ($this->explicitSelect) {\n                foreach ($this->fields_list as $key => $array_value) {\n                    // Add it only if it is not already in $this->_select\n                    if (isset($this->_select) && preg_match('/[\\s]`?' . preg_quote($key, '/') . '`?\\s*,/', $this->_select)) {\n                        continue;\n                    }\n\n                    if (isset($array_value['filter_key'])) {\n                        $this->_listsql .= str_replace('!', '.`', $array_value['filter_key']) . '` AS `' . $key . '`, ';\n                    } elseif ($key == 'id_' . $this->table) {\n                        $this->_listsql .= 'a.`' . bqSQL($key) . '`, ';\n                    } elseif ($key != 'image' && !preg_match('/' . preg_quote($key, '/') . '/i', $this->_select)) {\n                        $this->_listsql .= '`' . bqSQL($key) . '`, ';\n                    }\n                }\n                $this->_listsql = rtrim(trim($this->_listsql), ',');\n            } else {\n                $this->_listsql .= ($this->lang ? 'b.*,' : '') . ' a.*';\n            }\n\n            $this->_listsql .= \"\\n\" . (isset($this->_select) ? ', ' . rtrim($this->_select, ', ') : '') . $select_shop;\n\n            $limitClause = ' ' . (($shouldLimitSqlResults) ? ' LIMIT ' . (int) $start . ', ' . (int) $limit : '');\n\n            if ($this->_use_found_rows || isset($this->_filterHaving) || isset($this->_having)) {\n                $this->_listsql = 'SELECT SQL_CALC_FOUND_ROWS ' . ($this->_tmpTableFilter ? ' * FROM (SELECT ' : '') .\n                    $this->_listsql .\n                    $fromClause .\n                    $joinClause .\n                    $whereClause .\n                    $orderByClause .\n                    $limitClause;\n\n                $list_count = 'SELECT FOUND_ROWS() AS `' . _DB_PREFIX_ . $this->table . '`';\n            } else {\n                $this->_listsql = 'SELECT ' . ($this->_tmpTableFilter ? ' * FROM (SELECT ' : '') .\n                    $this->_listsql .\n                    $fromClause .\n                    $joinClause .\n                    $whereClause .\n                    $orderByClause .\n                    $limitClause;\n\n                $list_count = 'SELECT COUNT(*) AS `' . _DB_PREFIX_ . $this->table . '` ' .\n                    $fromClause .\n                    $joinClause .\n                    $whereClause;\n            }\n\n            $this->_list = Db::getInstance()->executeS($this->_listsql, true, false);\n\n            if ($this->_list === false) {\n                $this->_list_error = Db::getInstance()->getMsgError();\n\n                break;\n            }\n\n            $this->_listTotal = Db::getInstance()->getValue($list_count, false);\n\n            if ($shouldLimitSqlResults) {\n                $start = (int) $start - (int) $limit;\n                if ($start < 0) {\n                    break;\n                }\n            } else {\n                break;\n            }\n        } while (empty($this->_list));\n\n        Hook::exec('action' . $this->controller_name . 'ListingResultsModifier', [\n            'list' => &$this->_list,\n            'list_total' => &$this->_listTotal,\n        ]);\n    }\n\n    /**\n     * @return string\n     */\n    protected function getFromClause()\n    {\n        $sql_table = $this->table == 'order' ? 'orders' : $this->table;\n\n        return \"\\n\" . 'FROM `' . _DB_PREFIX_ . $sql_table . '` a ';\n    }\n\n    /**\n     * @param $id_lang\n     * @param $id_lang_shop\n     *\n     * @return string\n     */\n    protected function getJoinClause($id_lang, $id_lang_shop)\n    {\n        $shopJoinClause = '';\n        if ($this->shopLinkType) {\n            $shopJoinClause = ' LEFT JOIN `' . _DB_PREFIX_ . bqSQL($this->shopLinkType) . '` shop\n                            ON a.`id_' . bqSQL($this->shopLinkType) . '` = shop.`id_' . bqSQL($this->shopLinkType) . '`';\n        }\n\n        return \"\\n\" . $this->getLanguageJoinClause($id_lang, $id_lang_shop) .\n            \"\\n\" . (isset($this->_join) ? $this->_join . ' ' : '') .\n            \"\\n\" . $shopJoinClause;\n    }\n\n    /**\n     * @param $idLang\n     * @param $idLangShop\n     *\n     * @return string\n     */\n    protected function getLanguageJoinClause($idLang, $idLangShop)\n    {\n        $languageJoinClause = '';\n        if ($this->lang) {\n            $languageJoinClause = 'LEFT JOIN `' . _DB_PREFIX_ . bqSQL($this->table) . '_lang` b\n                ON (b.`' . bqSQL($this->identifier) . '` = a.`' . bqSQL($this->identifier) . '` AND b.`id_lang` = ' . (int) $idLang;\n\n            if ($idLangShop) {\n                if (!Shop::isFeatureActive()) {\n                    $languageJoinClause .= ' AND b.`id_shop` = ' . (int) Configuration::get('PS_SHOP_DEFAULT');\n                } elseif (Shop::getContext() == Shop::CONTEXT_SHOP) {\n                    $languageJoinClause .= ' AND b.`id_shop` = ' . (int) $idLangShop;\n                } else {\n                    $languageJoinClause .= ' AND b.`id_shop` = a.id_shop_default';\n                }\n            }\n            $languageJoinClause .= ')';\n        }\n\n        return $languageJoinClause;\n    }\n\n    /**\n     * @return string\n     */\n    protected function getWhereClause()\n    {\n        $whereShop = '';\n        if ($this->shopLinkType) {\n            $whereShop = Shop::addSqlRestriction($this->shopShareDatas, 'a', $this->shopLinkType);\n        }\n        $whereClause = ' WHERE 1 ' . (isset($this->_where) ? $this->_where . ' ' : '') .\n            ($this->deleted ? 'AND a.`deleted` = 0 ' : '') .\n            (isset($this->_filter) ? $this->_filter : '') . $whereShop . \"\\n\" .\n            (isset($this->_group) ? $this->_group . ' ' : '') . \"\\n\" .\n            $this->getHavingClause();\n\n        return $whereClause;\n    }\n\n    /**\n     * @param $orderBy\n     * @param $orderDirection\n     *\n     * @return string\n     */\n    protected function getOrderByClause($orderBy, $orderDirection)\n    {\n        $this->_orderBy = $this->checkOrderBy($orderBy);\n        $this->_orderWay = $this->checkOrderDirection($orderDirection);\n\n        return ' ORDER BY ' . ((str_replace('`', '', $this->_orderBy) == $this->identifier) ? 'a.' : '') .\n            $this->_orderBy . ' ' . $this->_orderWay .\n            ($this->_tmpTableFilter ? ') tmpTable WHERE 1' . $this->_tmpTableFilter : '');\n    }\n\n    /**\n     * @param $orderBy\n     *\n     * @return false|string\n     */\n    protected function checkOrderBy($orderBy)\n    {\n        if (empty($orderBy)) {\n            $prefix = $this->getCookieFilterPrefix();\n\n            if ($this->context->cookie->{$prefix . $this->list_id . 'Orderby'}) {\n                $orderBy = $this->context->cookie->{$prefix . $this->list_id . 'Orderby'};\n            } elseif ($this->_orderBy) {\n                $orderBy = $this->_orderBy;\n            } else {\n                $orderBy = $this->_defaultOrderBy;\n            }\n        }\n\n        /* Check params validity */\n        if (!Validate::isOrderBy($orderBy)) {\n            throw new PrestaShopException('Invalid \"order by\" clause.');\n        }\n\n        if (!isset($this->fields_list[$orderBy]['order_key']) && isset($this->fields_list[$orderBy]['filter_key'])) {\n            $this->fields_list[$orderBy]['order_key'] = $this->fields_list[$orderBy]['filter_key'];\n        }\n\n        if (isset($this->fields_list[$orderBy]['order_key'])) {\n            $orderBy = $this->fields_list[$orderBy]['order_key'];\n        }\n\n        if (preg_match('/[.!]/', $orderBy)) {\n            $orderBySplit = preg_split('/[.!]/', $orderBy);\n            $orderBy = bqSQL($orderBySplit[0]) . '.`' . bqSQL($orderBySplit[1]) . '`';\n        } elseif ($orderBy) {\n            $orderBy = bqSQL($orderBy);\n        }\n\n        return $orderBy;\n    }\n\n    /**\n     * @param $orderDirection\n     *\n     * @return string\n     */\n    protected function checkOrderDirection($orderDirection)\n    {\n        $prefix = $this->getCookieOrderByPrefix();\n        if (empty($orderDirection)) {\n            if ($this->context->cookie->{$prefix . $this->list_id . 'Orderway'}) {\n                $orderDirection = $this->context->cookie->{$prefix . $this->list_id . 'Orderway'};\n            } elseif ($this->_orderWay) {\n                $orderDirection = $this->_orderWay;\n            } else {\n                $orderDirection = $this->_defaultOrderWay;\n            }\n        }\n\n        if (!Validate::isOrderWay($orderDirection)) {\n            throw new PrestaShopException('Invalid order direction.');\n        }\n\n        return pSQL(Tools::strtoupper($orderDirection));\n    }\n\n    /**\n     * @return mixed\n     */\n    protected function getCookieOrderByPrefix()\n    {\n        return str_replace(['admin', 'controller'], '', Tools::strtolower(get_class($this)));\n    }\n\n    /**\n     * @return string\n     */\n    protected function getHavingClause()\n    {\n        $havingClause = '';\n        if (isset($this->_filterHaving) || isset($this->_having)) {\n            $havingClause = ' HAVING ';\n            if (isset($this->_filterHaving)) {\n                $havingClause .= ltrim($this->_filterHaving, ' AND ');\n            }\n            if (isset($this->_having)) {\n                $havingClause .= $this->_having . ' ';\n            }\n        }\n\n        return $havingClause;\n    }\n\n    /**\n     * @param $limit\n     *\n     * @return bool\n     */\n    protected function shouldLimitSqlResults($limit)\n    {\n        return $limit !== false;\n    }\n\n    /**\n     * @param $limit\n     *\n     * @return int\n     */\n    protected function checkSqlLimit($limit)\n    {\n        if (empty($limit)) {\n            if (\n                isset($this->context->cookie->{$this->list_id . '_pagination'}) &&\n                $this->context->cookie->{$this->list_id . '_pagination'}\n            ) {\n                $limit = $this->context->cookie->{$this->list_id . '_pagination'};\n            } else {\n                $limit = $this->_default_pagination;\n            }\n        }\n\n        $limit = (int) Tools::getValue($this->list_id . '_pagination', $limit);\n        if (in_array($limit, $this->_pagination) && $limit != $this->_default_pagination) {\n            $this->context->cookie->{$this->list_id . '_pagination'} = $limit;\n        } else {\n            unset($this->context->cookie->{$this->list_id . '_pagination'});\n        }\n\n        if (!is_numeric($limit)) {\n            throw new PrestaShopException('Invalid limit. It should be a numeric.');\n        }\n\n        return $limit;\n    }\n\n    /**\n     * @param array|string $filter_modules_list\n     * @param string|bool $tracking_source\n     *\n     * @return bool\n     *\n     * @throws PrestaShopException\n     */\n    public function getModulesList($filter_modules_list, $tracking_source = false)\n    {\n        if (!is_array($filter_modules_list) && null !== $filter_modules_list) {\n            $filter_modules_list = [$filter_modules_list];\n        }\n\n        if (null === $filter_modules_list || !count($filter_modules_list)) {\n            return false;\n        } //if there is no modules to display just return false;\n\n        $all_modules = Module::getModulesOnDisk(true);\n        $this->modules_list = [];\n        foreach ($all_modules as $module) {\n            $perm = true;\n            if ($module->id) {\n                $perm &= Module::getPermissionStatic($module->id, 'configure');\n            } else {\n                $id_admin_module = Tab::getIdFromClassName('AdminModules');\n                $access = Profile::getProfileAccess($this->context->employee->id_profile, $id_admin_module);\n                if (!$access['edit']) {\n                    $perm &= false;\n                }\n            }\n\n            if (in_array($module->name, $filter_modules_list) && $perm) {\n                $this->fillModuleData($module, 'array', null, $tracking_source);\n                $this->modules_list[array_search($module->name, $filter_modules_list)] = $module;\n            }\n        }\n        ksort($this->modules_list);\n\n        if (count($this->modules_list)) {\n            return true;\n        }\n\n        return false; //no module found on disk just return false;\n    }\n\n    /**\n     * @return array\n     */\n    public function getLanguages()\n    {\n        $cookie = $this->context->cookie;\n        $this->allow_employee_form_lang = (int) Configuration::get('PS_BO_ALLOW_EMPLOYEE_FORM_LANG');\n        if ($this->allow_employee_form_lang && !$cookie->employee_form_lang) {\n            $cookie->employee_form_lang = (int) Configuration::get('PS_LANG_DEFAULT');\n        }\n\n        $lang_exists = false;\n        $this->_languages = Language::getLanguages(false);\n        foreach ($this->_languages as $lang) {\n            if (isset($cookie->employee_form_lang) && $cookie->employee_form_lang == $lang['id_lang']) {\n                $lang_exists = true;\n            }\n        }\n\n        $this->default_form_language = $lang_exists ? (int) $cookie->employee_form_lang : (int) Configuration::get('PS_LANG_DEFAULT');\n\n        foreach ($this->_languages as $k => $language) {\n            $this->_languages[$k]['is_default'] = (int) ($language['id_lang'] == $this->default_form_language);\n        }\n\n        return $this->_languages;\n    }\n\n    /**\n     * Return the list of fields value.\n     *\n     * @param ObjectModel $obj Object\n     *\n     * @return array\n     */\n    public function getFieldsValue($obj)\n    {\n        foreach ($this->fields_form as $fieldset) {\n            if (isset($fieldset['form']['input'])) {\n                foreach ($fieldset['form']['input'] as $input) {\n                    if (!isset($this->fields_value[$input['name']])) {\n                        if (isset($input['type']) && $input['type'] == 'shop') {\n                            if ($obj->id) {\n                                $result = Shop::getShopById((int) $obj->id, $this->identifier, $this->table);\n                                foreach ($result as $row) {\n                                    $this->fields_value['shop'][$row['id_' . $input['type']]][] = $row['id_shop'];\n                                }\n                            }\n                        } elseif (isset($input['lang']) && $input['lang']) {\n                            foreach ($this->_languages as $language) {\n                                $field_value = $this->getFieldValue($obj, $input['name'], $language['id_lang']);\n                                if (empty($field_value)) {\n                                    if (isset($input['default_value']) && is_array($input['default_value']) && isset($input['default_value'][$language['id_lang']])) {\n                                        $field_value = $input['default_value'][$language['id_lang']];\n                                    } elseif (isset($input['default_value'])) {\n                                        $field_value = $input['default_value'];\n                                    }\n                                }\n                                $this->fields_value[$input['name']][$language['id_lang']] = $field_value;\n                            }\n                        } else {\n                            $field_value = $this->getFieldValue($obj, $input['name']);\n                            if ($field_value === false && isset($input['default_value'])) {\n                                $field_value = $input['default_value'];\n                            }\n                            $this->fields_value[$input['name']] = $field_value;\n                        }\n                    }\n                }\n            }\n        }\n\n        return $this->fields_value;\n    }\n\n    /**\n     * Return field value if possible (both classical and multilingual fields).\n     *\n     * Case 1 : Return value if present in $_POST / $_GET\n     * Case 2 : Return object value\n     *\n     * @param ObjectModel $obj Object\n     * @param string $key Field name\n     * @param int|null $id_lang Language id (optional)\n     *\n     * @return string\n     */\n    public function getFieldValue($obj, $key, $id_lang = null)\n    {\n        if ($id_lang) {\n            $default_value = (isset($obj->id) && $obj->id && isset($obj->{$key}[$id_lang])) ? $obj->{$key}[$id_lang] : false;\n        } else {\n            $default_value = isset($obj->{$key}) ? $obj->{$key} : false;\n        }\n\n        return Tools::getValue($key . ($id_lang ? '_' . $id_lang : ''), $default_value);\n    }\n\n    /**\n     * Manage page display (form, list...).\n     *\n     * @param string|bool $class_name Allow to validate a different class than the current one\n     *\n     * @throws PrestaShopException\n     */\n    public function validateRules($class_name = false)\n    {\n        if (!$class_name) {\n            $class_name = $this->className;\n        }\n\n        /** @var $object ObjectModel */\n        $object = new $class_name();\n\n        if (method_exists($this, 'getValidationRules')) {\n            $definition = $this->getValidationRules();\n        } else {\n            $definition = ObjectModel::getDefinition($class_name);\n        }\n\n        $default_language = new Language((int) Configuration::get('PS_LANG_DEFAULT'));\n        $languages = Language::getLanguages(false);\n\n        foreach ($definition['fields'] as $field => $def) {\n            $skip = [];\n            if (in_array($field, ['passwd', 'no-picture'])) {\n                $skip = ['required'];\n            }\n\n            if (isset($def['lang']) && $def['lang']) {\n                if (isset($def['required']) && $def['required']) {\n                    $value = Tools::getValue($field . '_' . $default_language->id);\n                    // !isset => not exist || \"\" == $value can be === 0 (before, empty $value === 0 returned true)\n                    if (!isset($value) || '' == $value) {\n                        $this->errors[$field . '_' . $default_language->id] = $this->trans(\n                            'The field %field_name% is required at least in %lang%.',\n                            ['%field_name%' => $object->displayFieldName($field, $class_name), '%lang%' => $default_language->name],\n                            'Admin.Notifications.Error'\n                        );\n                    }\n                }\n\n                foreach ($languages as $language) {\n                    $value = Tools::getValue($field . '_' . $language['id_lang']);\n                    if (!empty($value)) {\n                        if (($error = $object->validateField($field, $value, $language['id_lang'], $skip, true)) !== true) {\n                            $this->errors[$field . '_' . $language['id_lang']] = $error;\n                        }\n                    }\n                }\n            } elseif (($error = $object->validateField($field, Tools::getValue($field), null, $skip, true)) !== true) {\n                $this->errors[$field] = $error;\n            }\n        }\n\n        /* Overload this method for custom checking */\n        $this->_childValidation();\n\n        /* Checking for multilingual fields validity */\n        if (isset($rules['validateLang']) && is_array($rules['validateLang'])) {\n            foreach ($rules['validateLang'] as $field_lang => $function) {\n                foreach ($languages as $language) {\n                    if (($value = Tools::getValue($field_lang . '_' . $language['id_lang'])) !== false && !empty($value)) {\n                        if (Tools::strtolower($function) == 'iscleanhtml' && Configuration::get('PS_ALLOW_HTML_IFRAME')) {\n                            $res = Validate::$function($value, true);\n                        } else {\n                            $res = Validate::$function($value);\n                        }\n                        if (!$res) {\n                            $this->errors[$field_lang . '_' . $language['id_lang']] = $this->trans(\n                                'The %field_name% field (%lang%) is invalid.',\n                                ['%field_name%' => call_user_func([$class_name, 'displayFieldName'], $field_lang, $class_name), '%lang%' => $language['name']],\n                                'Admin.Notifications.Error'\n                            );\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    /**\n     * Overload this method for custom checking.\n     */\n    protected function _childValidation()\n    {\n    }\n\n    /**\n     * Display object details.\n     */\n    public function viewDetails()\n    {\n    }\n\n    /**\n     * Called before deletion.\n     *\n     * @param ObjectModel $object Object\n     *\n     * @return bool\n     */\n    protected function beforeDelete($object)\n    {\n        return false;\n    }\n\n    /**\n     * Called before deletion.\n     *\n     * @param ObjectModel $object Object\n     * @param int $old_id\n     *\n     * @return bool\n     */\n    protected function afterDelete($object, $old_id)\n    {\n        return true;\n    }\n\n    /**\n     * @param ObjectModel $object\n     *\n     * @return bool\n     */\n    protected function afterAdd($object)\n    {\n        return true;\n    }\n\n    /**\n     * @param ObjectModel $object\n     *\n     * @return bool\n     */\n    protected function afterUpdate($object)\n    {\n        return true;\n    }\n\n    /**\n     * Check rights to view the current tab.\n     *\n     * @return bool\n     */\n    protected function afterImageUpload()\n    {\n        return true;\n    }\n\n    /**\n     * Copy data values from $_POST to object.\n     *\n     * @param ObjectModel &$object Object\n     * @param string $table Object table\n     */\n    protected function copyFromPost(&$object, $table)\n    {\n        /* Classical fields */\n        foreach ($_POST as $key => $value) {\n            if (array_key_exists($key, $object) && $key != 'id_' . $table) {\n                /* Do not take care of password field if empty */\n                if ($key == 'passwd' && Tools::getValue('id_' . $table) && empty($value)) {\n                    continue;\n                }\n                /* Automatically hash password in MD5 */\n                if ($key == 'passwd' && !empty($value)) {\n                    $value = $this->get('hashing')->hash($value, _COOKIE_KEY_);\n                }\n                $object->{$key} = $value;\n            }\n        }\n\n        /* Multilingual fields */\n        $class_vars = get_class_vars(get_class($object));\n        $fields = [];\n        if (isset($class_vars['definition']['fields'])) {\n            $fields = $class_vars['definition']['fields'];\n        }\n\n        foreach ($fields as $field => $params) {\n            if (array_key_exists('lang', $params) && $params['lang']) {\n                foreach (Language::getIDs(false) as $id_lang) {\n                    if (Tools::isSubmit($field . '_' . (int) $id_lang)) {\n                        $object->{$field}[(int) $id_lang] = Tools::getValue($field . '_' . (int) $id_lang);\n                    }\n                }\n            }\n        }\n    }\n\n    /**\n     * Returns an array with selected shops and type (group or boutique shop).\n     *\n     * @param string $table\n     *\n     * @return array\n     */\n    protected function getSelectedAssoShop($table)\n    {\n        if (!Shop::isFeatureActive() || !Shop::isTableAssociated($table)) {\n            return [];\n        }\n\n        $shops = Shop::getShops(true, null, true);\n        if (count($shops) == 1 && isset($shops[0])) {\n            return [$shops[0], 'shop'];\n        }\n\n        $assos = [];\n        if (Tools::isSubmit('checkBoxShopAsso_' . $table)) {\n            foreach (Tools::getValue('checkBoxShopAsso_' . $table) as $id_shop => $value) {\n                $assos[] = (int) $id_shop;\n            }\n        } elseif (Shop::getTotalShops(false) == 1) {\n            // if we do not have the checkBox multishop, we can have an admin with only one shop and being in multishop\n            $assos[] = (int) Shop::getContextShopID();\n        }\n\n        return $assos;\n    }\n\n    /**\n     * Update the associations of shops.\n     *\n     * @param int $id_object\n     *\n     * @return bool|void\n     *\n     * @throws PrestaShopDatabaseException\n     */\n    protected function updateAssoShop($id_object)\n    {\n        if (!Shop::isFeatureActive()) {\n            return;\n        }\n\n        if (!Shop::isTableAssociated($this->table)) {\n            return;\n        }\n\n        $assos_data = $this->getSelectedAssoShop($this->table);\n\n        // Get list of shop id we want to exclude from asso deletion\n        $exclude_ids = $assos_data;\n        foreach (Db::getInstance()->executeS('SELECT id_shop FROM ' . _DB_PREFIX_ . 'shop') as $row) {\n            if (!$this->context->employee->hasAuthOnShop($row['id_shop'])) {\n                $exclude_ids[] = $row['id_shop'];\n            }\n        }\n        Db::getInstance()->delete($this->table . '_shop', '`' . bqSQL($this->identifier) . '` = ' . (int) $id_object . ($exclude_ids ? ' AND id_shop NOT IN (' . implode(', ', array_map('intval', $exclude_ids)) . ')' : ''));\n\n        $insert = [];\n        foreach ($assos_data as $id_shop) {\n            $insert[] = [\n                $this->identifier => (int) $id_object,\n                'id_shop' => (int) $id_shop,\n            ];\n        }\n\n        return Db::getInstance()->insert($this->table . '_shop', $insert, false, true, Db::INSERT_IGNORE);\n    }\n\n    /**\n     * @param mixed $value\n     * @param array $field\n     *\n     * @return bool\n     */\n    protected function validateField($value, $field)\n    {\n        if (isset($field['validation'])) {\n            $valid_method_exists = method_exists('Validate', $field['validation']);\n            if ((!isset($field['empty']) || !$field['empty'] || (isset($field['empty']) && $field['empty'] && $value)) && $valid_method_exists) {\n                $field_validation = $field['validation'];\n                if (!Validate::$field_validation($value)) {\n                    $this->errors[] = $this->trans('%s: Incorrect value', [$field['title']], 'Admin.Notifications.Error');\n\n                    return false;\n                }\n            }\n        }\n\n        return true;\n    }\n\n    /**\n     * Can be overridden.\n     */\n    public function beforeUpdateOptions()\n    {\n    }\n\n    /**\n     * Overload this method for custom checking.\n     *\n     * @param int $id Object id used for deleting images\n     *\n     * @return bool\n     */\n    protected function postImage($id)\n    {\n        if (isset($this->fieldImageSettings['name'], $this->fieldImageSettings['dir'])) {\n            return $this->uploadImage($id, $this->fieldImageSettings['name'], $this->fieldImageSettings['dir'] . '/');\n        } elseif (!empty($this->fieldImageSettings)) {\n            foreach ($this->fieldImageSettings as $image) {\n                if (isset($image['name'], $image['dir'])) {\n                    $this->uploadImage($id, $image['name'], $image['dir'] . '/');\n                }\n            }\n        }\n\n        return !count($this->errors) ? true : false;\n    }\n\n    /**\n     * @param int $id\n     * @param string $name\n     * @param string $dir\n     * @param string|bool $ext\n     * @param int|null $width\n     * @param int|null $height\n     *\n     * @return bool\n     */\n    protected function uploadImage($id, $name, $dir, $ext = false, $width = null, $height = null)\n    {\n        if (isset($_FILES[$name]['tmp_name']) && !empty($_FILES[$name]['tmp_name'])) {\n            // Delete old image\n            if (Validate::isLoadedObject($object = $this->loadObject())) {\n                $object->deleteImage();\n            } else {\n                return false;\n            }\n\n            // Check image validity\n            $max_size = isset($this->max_image_size) ? $this->max_image_size : 0;\n            if ($error = ImageManager::validateUpload($_FILES[$name], Tools::getMaxUploadSize($max_size))) {\n                $this->errors[] = $error;\n            }\n\n            $tmp_name = tempnam(_PS_TMP_IMG_DIR_, 'PS');\n            if (!$tmp_name) {\n                return false;\n            }\n\n            if (!move_uploaded_file($_FILES[$name]['tmp_name'], $tmp_name)) {\n                return false;\n            }\n\n            // Evaluate the memory required to resize the image: if it's too much, you can't resize it.\n            if (!ImageManager::checkImageMemoryLimit($tmp_name)) {\n                $this->errors[] = $this->trans('Due to memory limit restrictions, this image cannot be loaded. Please increase your memory_limit value via your server\\'s configuration settings.', [], 'Admin.Notifications.Error');\n            }\n\n            // Copy new image\n            if (empty($this->errors) && !ImageManager::resize($tmp_name, _PS_IMG_DIR_ . $dir . $id . '.' . $this->imageType, (int) $width, (int) $height, ($ext ? $ext : $this->imageType))) {\n                $this->errors[] = $this->trans('An error occurred while uploading the image.', [], 'Admin.Notifications.Error');\n            }\n\n            if (count($this->errors)) {\n                return false;\n            }\n            if ($this->afterImageUpload()) {\n                unlink($tmp_name);\n\n                return true;\n            }\n\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * Delete multiple items.\n     *\n     * @return bool true if success\n     */\n    protected function processBulkDelete()\n    {\n        if (is_array($this->boxes) && !empty($this->boxes)) {\n            $object = new $this->className();\n\n            if (isset($object->noZeroObject)) {\n                $objects_count = count(call_user_func([$this->className, $object->noZeroObject]));\n\n                // Check if all object will be deleted\n                if ($objects_count <= 1 || count($this->boxes) == $objects_count) {\n                    $this->errors[] = $this->trans('You need at least one object.', [], 'Admin.Notifications.Error') .\n                        ' <b>' . $this->table . '</b><br />' .\n                        $this->trans('You cannot delete all of the items.', [], 'Admin.Notifications.Error');\n                }\n            } else {\n                $result = true;\n                foreach ($this->boxes as $id) {\n                    /** @var $to_delete ObjectModel */\n                    $to_delete = new $this->className($id);\n                    $delete_ok = true;\n                    if ($this->deleted) {\n                        $to_delete->deleted = 1;\n                        if (!$to_delete->update()) {\n                            $result = false;\n                            $delete_ok = false;\n                        }\n                    } elseif (!$to_delete->delete()) {\n                        $result = false;\n                        $delete_ok = false;\n                    }\n\n                    if ($delete_ok) {\n                        PrestaShopLogger::addLog(\n                            $this->trans('%s deletion', [$this->className]),\n                            1,\n                            null,\n                            $this->className,\n                            (int) $to_delete->id,\n                            true,\n                            (int) $this->context->employee->id\n                        );\n                    } else {\n                        $this->errors[] = $this->trans('Can\\'t delete #%id%', ['%id%' => $id], 'Admin.Notifications.Error');\n                    }\n                }\n                if ($result) {\n                    $this->redirect_after = self::$currentIndex . '&conf=2&token=' . $this->token;\n                }\n                $this->errors[] = $this->trans('An error occurred while deleting this selection.', [], 'Admin.Notifications.Error');\n            }\n        } else {\n            $this->errors[] = $this->trans('You must select at least one element to delete.', [], 'Admin.Notifications.Error');\n        }\n\n        if (isset($result)) {\n            return $result;\n        } else {\n            return false;\n        }\n    }\n\n    protected function ajaxProcessOpenHelp()\n    {\n        $help_class_name = $_GET['controller'];\n        $popup_content = \"<!doctype html>\n        <html>\n            <head>\n                <meta charset='UTF-8'>\n                <title>PrestaShop Help</title>\n                <link href='//help.prestashop.com/css/help.css' rel='stylesheet'>\n                <link href='//fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet'>\n                <script src='\" . _PS_JS_DIR_ . \"jquery/jquery-1.11.0.min.js'></script>\n                <script src='\" . _PS_JS_DIR_ . \"admin.js'></script>\n                <script src='\" . _PS_JS_DIR_ . \"tools.js'></script>\n                <script>\n                    help_class_name='\" . addslashes($help_class_name) . \"';\n                    iso_user = '\" . addslashes($this->context->language->iso_code) . \"'\n                </script>\n                <script src='themes/default/js/help.js'></script>\n                <script>\n                    $(function(){\n                        initHelp();\n                    });\n                </script>\n            </head>\n            <body><div id='help-container' class='help-popup'></div></body>\n        </html>\";\n        die($popup_content);\n    }\n\n    /**\n     * Enable multiple items.\n     *\n     * @return bool true if success\n     */\n    protected function processBulkEnableSelection()\n    {\n        return $this->processBulkStatusSelection(1);\n    }\n\n    /**\n     * Disable multiple items.\n     *\n     * @return bool true if success\n     */\n    protected function processBulkDisableSelection()\n    {\n        return $this->processBulkStatusSelection(0);\n    }\n\n    /**\n     * Toggle status of multiple items.\n     *\n     * @param bool $status\n     *\n     * @return bool true if success\n     *\n     * @throws PrestaShopException\n     */\n    protected function processBulkStatusSelection($status)\n    {\n        $result = true;\n        if (is_array($this->boxes) && !empty($this->boxes)) {\n            foreach ($this->boxes as $id) {\n                /** @var ObjectModel $object */\n                $object = new $this->className((int) $id);\n                $object->active = (int) $status;\n                $result &= $object->update();\n            }\n        }\n\n        return $result;\n    }\n\n    /**\n     * @return bool\n     */\n    protected function processBulkAffectZone()\n    {\n        $result = false;\n        if (is_array($this->boxes) && !empty($this->boxes)) {\n            /** @var Country|State $object */\n            $object = new $this->className();\n            $result = $object->affectZoneToSelection(Tools::getValue($this->table . 'Box'), Tools::getValue('zone_to_affect'));\n\n            if ($result) {\n                $this->redirect_after = self::$currentIndex . '&conf=28&token=' . $this->token;\n            }\n            $this->errors[] = $this->trans('An error occurred while assigning a zone to the selection.', [], 'Admin.Notifications.Error');\n        } else {\n            $this->errors[] = $this->trans('You must select at least one element to assign a new zone.', [], 'Admin.Notifications.Error');\n        }\n\n        return $result;\n    }\n\n    /**\n     * Called before Add.\n     *\n     * @param ObjectModel $object Object\n     *\n     * @return bool\n     */\n    protected function beforeAdd($object)\n    {\n        return true;\n    }\n\n    /**\n     * Prepare the view to display the required fields form.\n     *\n     * @return string|void\n     */\n    public function displayRequiredFields()\n    {\n        if (!$this->access('add') || !$this->access('delete') || !$this->required_database) {\n            return;\n        }\n\n        $helper = new Helper();\n        $helper->currentIndex = self::$currentIndex;\n        $helper->token = $this->token;\n        $helper->override_folder = $this->override_folder;\n\n        return $helper->renderRequiredFields($this->className, $this->identifier, $this->required_fields);\n    }\n\n    /**\n     * Create a template from the override file, else from the base file.\n     *\n     * @param string $tpl_name filename\n     *\n     * @return Smarty_Internal_Template\n     */\n    public function createTemplate($tpl_name)\n    {\n        // Use override tpl if it exists\n        // If view access is denied, we want to use the default template that will be used to display an error\n        if ($this->viewAccess() && $this->override_folder) {\n            if (!Configuration::get('PS_DISABLE_OVERRIDES') && file_exists($this->context->smarty->getTemplateDir(1) . DIRECTORY_SEPARATOR . $this->override_folder . $tpl_name)) {\n                return $this->context->smarty->createTemplate($this->override_folder . $tpl_name, $this->context->smarty);\n            } elseif (file_exists($this->context->smarty->getTemplateDir(0) . 'controllers' . DIRECTORY_SEPARATOR . $this->override_folder . $tpl_name)) {\n                return $this->context->smarty->createTemplate('controllers' . DIRECTORY_SEPARATOR . $this->override_folder . $tpl_name, $this->context->smarty);\n            }\n        }\n\n        return $this->context->smarty->createTemplate($this->context->smarty->getTemplateDir(0) . $tpl_name, $this->context->smarty);\n    }\n\n    /**\n     * Shortcut to set up a json success payload.\n     *\n     * @param string $message Success message\n     */\n    public function jsonConfirmation($message)\n    {\n        $this->json = true;\n        $this->confirmations[] = $message;\n        if ($this->status === '') {\n            $this->status = 'ok';\n        }\n    }\n\n    /**\n     * Shortcut to set up a json error payload.\n     *\n     * @param string $message Error message\n     */\n    public function jsonError($message)\n    {\n        $this->json = true;\n        $this->errors[] = $message;\n        if ($this->status === '') {\n            $this->status = 'error';\n        }\n    }\n\n    /**\n     * @param string $file\n     * @param int $timeout\n     *\n     * @return bool\n     */\n    public function isFresh($file, $timeout = 604800)\n    {\n        if (($time = @filemtime(_PS_ROOT_DIR_ . $file)) && filesize(_PS_ROOT_DIR_ . $file) > 0) {\n            return (time() - $time) < $timeout;\n        }\n\n        return false;\n    }\n\n    /** @var bool */\n    protected static $is_prestashop_up = true;\n\n    /**\n     * @param string $file_to_refresh\n     * @param string $external_file\n     *\n     * @return bool\n     */\n    public function refresh($file_to_refresh, $external_file)\n    {\n        if (self::$is_prestashop_up && $content = Tools::file_get_contents($external_file)) {\n            return (bool) file_put_contents(_PS_ROOT_DIR_ . $file_to_refresh, $content);\n        }\n        self::$is_prestashop_up = false;\n\n        return false;\n    }\n\n    /**\n     * @param Module $module\n     * @param string $output_type\n     * @param string|null $back\n     * @param string|bool $install_source_tracking\n     */\n    public function fillModuleData(&$module, $output_type = 'link', $back = null, $install_source_tracking = false)\n    {\n        /** @var Module $obj */\n        $obj = null;\n        if ($module->onclick_option) {\n            $obj = new $module->name();\n        }\n        // Fill module data\n        $module->logo = '../../img/questionmark.png';\n\n        if (@filemtime(_PS_ROOT_DIR_ . DIRECTORY_SEPARATOR . basename(_PS_MODULE_DIR_) . DIRECTORY_SEPARATOR . $module->name\n            . DIRECTORY_SEPARATOR . 'logo.gif')) {\n            $module->logo = 'logo.gif';\n        }\n        if (@filemtime(_PS_ROOT_DIR_ . DIRECTORY_SEPARATOR . basename(_PS_MODULE_DIR_) . DIRECTORY_SEPARATOR . $module->name\n            . DIRECTORY_SEPARATOR . 'logo.png')) {\n            $module->logo = 'logo.png';\n        }\n\n        $link_admin_modules = $this->context->link->getAdminLink('AdminModules', true);\n\n        $module->options['install_url'] = $link_admin_modules . '&install=' . urlencode($module->name) . '&tab_module=' . $module->tab . '&module_name=' . $module->name\n            . '&anchor=' . ucfirst($module->name) . ($install_source_tracking ? '&source=' . $install_source_tracking : '');\n        $module->options['update_url'] = $link_admin_modules . '&update=' . urlencode($module->name) . '&tab_module=' . $module->tab . '&module_name=' . $module->name . '&anchor=' . ucfirst($module->name);\n        $module->options['uninstall_url'] = $link_admin_modules . '&uninstall=' . urlencode($module->name) . '&tab_module=' . $module->tab . '&module_name=' . $module->name . '&anchor=' . ucfirst($module->name);\n\n        // free modules get their source tracking data here\n        $module->optionsHtml = $this->displayModuleOptions($module, $output_type, $back, $install_source_tracking);\n        // pay modules get their source tracking data here\n        if ($install_source_tracking && isset($module->addons_buy_url)) {\n            $module->addons_buy_url .= ($install_source_tracking ? '&utm_term=' . $install_source_tracking : '');\n        }\n\n        $module->options['uninstall_onclick'] = ((!$module->onclick_option) ?\n            ((empty($module->confirmUninstall)) ? 'return confirm(\\'' . $this->trans('Do you really want to uninstall this module?') . '\\');' : 'return confirm(\\'' . addslashes($module->confirmUninstall) . '\\');') :\n            $obj->onclickOption('uninstall', $module->options['uninstall_url']));\n\n        if ((Tools::getValue('module_name') == $module->name || in_array($module->name, explode('|', Tools::getValue('modules_list')))) && (int) Tools::getValue('conf') > 0) {\n            $module->message = $this->_conf[(int) Tools::getValue('conf')];\n        }\n\n        if ((Tools::getValue('module_name') == $module->name || in_array($module->name, explode('|', Tools::getValue('modules_list')))) && (int) Tools::getValue('conf') > 0) {\n            unset($obj);\n        }\n    }\n\n    /** @var array */\n    protected $translationsTab = [];\n\n    /**\n     * Display modules list.\n     *\n     * @param Module $module\n     * @param string $output_type (link or select)\n     * @param string|null $back\n     * @param string|bool $install_source_tracking\n     *\n     * @return string|array\n     */\n    public function displayModuleOptions($module, $output_type = 'link', $back = null, $install_source_tracking = false)\n    {\n        if (!isset($module->enable_device)) {\n            $module->enable_device = Context::DEVICE_COMPUTER | Context::DEVICE_TABLET | Context::DEVICE_MOBILE;\n        }\n\n        $this->translationsTab['confirm_uninstall_popup'] = (isset($module->confirmUninstall) ? $module->confirmUninstall : $this->trans('Do you really want to uninstall this module?'));\n        if (!isset($this->translationsTab['Disable this module'])) {\n            $this->translationsTab['Disable this module'] = $this->trans('Disable this module');\n            $this->translationsTab['Enable this module for all shops'] = $this->trans('Enable this module for all shops');\n            $this->translationsTab['Disable'] = $this->trans('Disable');\n            $this->translationsTab['Enable'] = $this->trans('Enable');\n            $this->translationsTab['Disable on mobiles'] = $this->trans('Disable on mobiles');\n            $this->translationsTab['Disable on tablets'] = $this->trans('Disable on tablets');\n            $this->translationsTab['Disable on computers'] = $this->trans('Disable on computers');\n            $this->translationsTab['Display on mobiles'] = $this->trans('Display on mobiles');\n            $this->translationsTab['Display on tablets'] = $this->trans('Display on tablets');\n            $this->translationsTab['Display on computers'] = $this->trans('Display on computers');\n            $this->translationsTab['Reset'] = $this->trans('Reset');\n            $this->translationsTab['Configure'] = $this->trans('Configure');\n            $this->translationsTab['Delete'] = $this->trans('Delete');\n            $this->translationsTab['Install'] = $this->trans('Install');\n            $this->translationsTab['Uninstall'] = $this->trans('Uninstall');\n            $this->translationsTab['Would you like to delete the content related to this module ?'] = $this->trans('Would you like to delete the content related to this module ?');\n            $this->translationsTab['This action will permanently remove the module from the server. Are you sure you want to do this?'] = $this->trans('This action will permanently remove the module from the server. Are you sure you want to do this?');\n            $this->translationsTab['Remove from Favorites'] = $this->trans('Remove from Favorites');\n            $this->translationsTab['Mark as Favorite'] = $this->trans('Mark as Favorite');\n        }\n\n        $link_admin_modules = $this->context->link->getAdminLink('AdminModules', true);\n        $modules_options = [];\n\n        $configure_module = [\n            'href' => $link_admin_modules . '&configure=' . urlencode($module->name) . '&tab_module=' . $module->tab . '&module_name=' . urlencode($module->name),\n            'onclick' => $module->onclick_option && isset($module->onclick_option_content['configure']) ? $module->onclick_option_content['configure'] : '',\n            'title' => '',\n            'text' => $this->translationsTab['Configure'],\n            'cond' => $module->id && isset($module->is_configurable) && $module->is_configurable,\n            'icon' => 'wrench',\n        ];\n\n        $desactive_module = [\n            'href' => $link_admin_modules . '&module_name=' . urlencode($module->name) . '&' . ($module->active ? 'enable=0' : 'enable=1') . '&tab_module=' . $module->tab,\n            'onclick' => $module->active && $module->onclick_option && isset($module->onclick_option_content['desactive']) ? $module->onclick_option_content['desactive'] : '',\n            'title' => Shop::isFeatureActive() ? htmlspecialchars($module->active ? $this->translationsTab['Disable this module'] : $this->translationsTab['Enable this module for all shops']) : '',\n            'text' => $module->active ? $this->translationsTab['Disable'] : $this->translationsTab['Enable'],\n            'cond' => $module->id,\n            'icon' => 'off',\n        ];\n        $link_reset_module = $link_admin_modules . '&module_name=' . urlencode($module->name) . '&reset&tab_module=' . $module->tab;\n\n        $is_reset_ready = false;\n        if (Validate::isModuleName($module->name)) {\n            if (method_exists(Module::getInstanceByName($module->name), 'reset')) {\n                $is_reset_ready = true;\n            }\n        }\n\n        $reset_module = [\n            'href' => $link_reset_module,\n            'onclick' => $module->onclick_option && isset($module->onclick_option_content['reset']) ? $module->onclick_option_content['reset'] : '',\n            'title' => '',\n            'text' => $this->translationsTab['Reset'],\n            'cond' => $module->id && $module->active,\n            'icon' => 'undo',\n            'class' => ($is_reset_ready ? 'reset_ready' : ''),\n        ];\n\n        $delete_module = [\n            'href' => $link_admin_modules . '&delete=' . urlencode($module->name) . '&tab_module=' . $module->tab . '&module_name=' . urlencode($module->name),\n            'onclick' => $module->onclick_option && isset($module->onclick_option_content['delete']) ? $module->onclick_option_content['delete'] : 'return confirm(\\'' . $this->translationsTab['This action will permanently remove the module from the server. Are you sure you want to do this?'] . '\\');',\n            'title' => '',\n            'text' => $this->translationsTab['Delete'],\n            'cond' => true,\n            'icon' => 'trash',\n            'class' => 'text-danger',\n        ];\n\n        $display_mobile = [\n            'href' => $link_admin_modules . '&module_name=' . urlencode($module->name) . '&' . ($module->enable_device & Context::DEVICE_MOBILE ? 'disable_device' : 'enable_device') . '=' . Context::DEVICE_MOBILE . '&tab_module=' . $module->tab,\n            'onclick' => '',\n            'title' => htmlspecialchars($module->enable_device & Context::DEVICE_MOBILE ? $this->translationsTab['Disable on mobiles'] : $this->translationsTab['Display on mobiles']),\n            'text' => $module->enable_device & Context::DEVICE_MOBILE ? $this->translationsTab['Disable on mobiles'] : $this->translationsTab['Display on mobiles'],\n            'cond' => $module->id,\n            'icon' => 'mobile',\n        ];\n\n        $display_tablet = [\n            'href' => $link_admin_modules . '&module_name=' . urlencode($module->name) . '&' . ($module->enable_device & Context::DEVICE_TABLET ? 'disable_device' : 'enable_device') . '=' . Context::DEVICE_TABLET . '&tab_module=' . $module->tab,\n            'onclick' => '',\n            'title' => htmlspecialchars($module->enable_device & Context::DEVICE_TABLET ? $this->translationsTab['Disable on tablets'] : $this->translationsTab['Display on tablets']),\n            'text' => $module->enable_device & Context::DEVICE_TABLET ? $this->translationsTab['Disable on tablets'] : $this->translationsTab['Display on tablets'],\n            'cond' => $module->id,\n            'icon' => 'tablet',\n        ];\n\n        $display_computer = [\n            'href' => $link_admin_modules . '&module_name=' . urlencode($module->name) . '&' . ($module->enable_device & Context::DEVICE_COMPUTER ? 'disable_device' : 'enable_device') . '=' . Context::DEVICE_COMPUTER . '&tab_module=' . $module->tab,\n            'onclick' => '',\n            'title' => htmlspecialchars($module->enable_device & Context::DEVICE_COMPUTER ? $this->translationsTab['Disable on computers'] : $this->translationsTab['Display on computers']),\n            'text' => $module->enable_device & Context::DEVICE_COMPUTER ? $this->translationsTab['Disable on computers'] : $this->translationsTab['Display on computers'],\n            'cond' => $module->id,\n            'icon' => 'desktop',\n        ];\n\n        $install = [\n            'href' => $link_admin_modules . '&install=' . urlencode($module->name) . '&tab_module=' . $module->tab . '&module_name=' . $module->name . '&anchor=' . ucfirst($module->name)\n                . (null !== $back ? '&back=' . urlencode($back) : '') . ($install_source_tracking ? '&source=' . $install_source_tracking : ''),\n            'onclick' => '',\n            'title' => $this->translationsTab['Install'],\n            'text' => $this->translationsTab['Install'],\n            'cond' => $module->id,\n            'icon' => 'plus-sign-alt',\n        ];\n\n        $uninstall = [\n            'href' => $link_admin_modules . '&uninstall=' . urlencode($module->name) . '&tab_module=' . $module->tab . '&module_name=' . $module->name . '&anchor=' . ucfirst($module->name) . (null !== $back ? '&back=' . urlencode($back) : ''),\n            'onclick' => (isset($module->onclick_option_content['uninstall']) ? $module->onclick_option_content['uninstall'] : 'return confirm(\\'' . $this->translationsTab['confirm_uninstall_popup'] . '\\');'),\n            'title' => $this->translationsTab['Uninstall'],\n            'text' => $this->translationsTab['Uninstall'],\n            'cond' => $module->id,\n            'icon' => 'minus-sign-alt',\n        ];\n\n        $remove_from_favorite = [\n            'href' => '#',\n            'class' => 'action_unfavorite toggle_favorite',\n            'onclick' => '',\n            'title' => $this->translationsTab['Remove from Favorites'],\n            'text' => $this->translationsTab['Remove from Favorites'],\n            'cond' => $module->id,\n            'icon' => 'star',\n            'data-value' => '0',\n            'data-module' => $module->name,\n        ];\n\n        $mark_as_favorite = [\n            'href' => '#',\n            'class' => 'action_favorite toggle_favorite',\n            'onclick' => '',\n            'title' => $this->translationsTab['Mark as Favorite'],\n            'text' => $this->translationsTab['Mark as Favorite'],\n            'cond' => $module->id,\n            'icon' => 'star',\n            'data-value' => '1',\n            'data-module' => $module->name,\n        ];\n\n        $update = [\n            'href' => $module->options['update_url'],\n            'onclick' => '',\n            'title' => 'Update it!',\n            'text' => 'Update it!',\n            'icon' => 'refresh',\n            'cond' => $module->id,\n        ];\n\n        $divider = [\n            'href' => '#',\n            'onclick' => '',\n            'title' => 'divider',\n            'text' => 'divider',\n            'cond' => $module->id,\n        ];\n\n        if (isset($module->version_addons) && $module->version_addons) {\n            $modules_options[] = $update;\n        }\n\n        if ($module->active) {\n            $modules_options[] = $configure_module;\n            $modules_options[] = $desactive_module;\n            $modules_options[] = $display_mobile;\n            $modules_options[] = $display_tablet;\n            $modules_options[] = $display_computer;\n        } else {\n            $modules_options[] = $desactive_module;\n            $modules_options[] = $configure_module;\n        }\n\n        $modules_options[] = $reset_module;\n\n        if ($output_type == 'select') {\n            if (!$module->id) {\n                $modules_options[] = $install;\n            } else {\n                $modules_options[] = $uninstall;\n            }\n        } elseif ($output_type == 'array') {\n            if ($module->id) {\n                $modules_options[] = $uninstall;\n            }\n        }\n\n        if (isset($module->preferences, $module->preferences['favorite']) && $module->preferences['favorite'] == 1) {\n            $remove_from_favorite['style'] = '';\n            $mark_as_favorite['style'] = 'display:none;';\n            $modules_options[] = $remove_from_favorite;\n            $modules_options[] = $mark_as_favorite;\n        } else {\n            $mark_as_favorite['style'] = '';\n            $remove_from_favorite['style'] = 'display:none;';\n            $modules_options[] = $remove_from_favorite;\n            $modules_options[] = $mark_as_favorite;\n        }\n\n        if ($module->id == 0) {\n            $install['cond'] = 1;\n            $install['flag_install'] = 1;\n            $modules_options[] = $install;\n        }\n        $modules_options[] = $divider;\n        $modules_options[] = $delete_module;\n\n        $return = '';\n        foreach ($modules_options as $option_name => $option) {\n            if ($option['cond']) {\n                if ($output_type == 'link') {\n                    $return .= '<li><a class=\"' . $option_name . ' action_module';\n                    $return .= '\" href=\"' . $option['href'] . (null !== $back ? '&back=' . urlencode($back) : '') . '\"';\n                    $return .= ' onclick=\"' . $option['onclick'] . '\"  title=\"' . $option['title'] . '\"><i class=\"icon-' . (isset($option['icon']) && $option['icon'] ? $option['icon'] : 'cog') . '\"></i>&nbsp;' . $option['text'] . '</a></li>';\n                } elseif ($output_type == 'array') {\n                    if (!is_array($return)) {\n                        $return = [];\n                    }\n\n                    $html = '<a class=\"';\n\n                    $is_install = isset($option['flag_install']) ? true : false;\n\n                    if (isset($option['class'])) {\n                        $html .= $option['class'];\n                    }\n                    if ($is_install) {\n                        $html .= ' btn btn-success';\n                    }\n                    if (!$is_install && count($return) == 0) {\n                        $html .= ' btn btn-default';\n                    }\n\n                    $html .= '\"';\n\n                    if (isset($option['data-value'])) {\n                        $html .= ' data-value=\"' . $option['data-value'] . '\"';\n                    }\n\n                    if (isset($option['data-module'])) {\n                        $html .= ' data-module=\"' . $option['data-module'] . '\"';\n                    }\n\n                    if (isset($option['style'])) {\n                        $html .= ' style=\"' . $option['style'] . '\"';\n                    }\n\n                    $html .= ' href=\"' . htmlentities($option['href']) . (null !== $back ? '&back=' . urlencode($back) : '') . '\" onclick=\"' . $option['onclick'] . '\"  title=\"' . $option['title'] . '\"><i class=\"icon-' . (isset($option['icon']) && $option['icon'] ? $option['icon'] : 'cog') . '\"></i> ' . $option['text'] . '</a>';\n                    $return[] = $html;\n                } elseif ($output_type == 'select') {\n                    $return .= '<option id=\"' . $option_name . '\" data-href=\"' . htmlentities($option['href']) . (null !== $back ? '&back=' . urlencode($back) : '') . '\" data-onclick=\"' . $option['onclick'] . '\">' . $option['text'] . '</option>';\n                }\n            }\n        }\n\n        if ($output_type == 'select') {\n            $return = '<select id=\"select_' . $module->name . '\">' . $return . '</select>';\n        }\n\n        return $return;\n    }\n\n    public function ajaxProcessGetModuleQuickView()\n    {\n        $modules = Module::getModulesOnDisk();\n\n        foreach ($modules as $module) {\n            if ($module->name == Tools::getValue('module')) {\n                break;\n            }\n        }\n\n        $url = $module->url;\n\n        if (isset($module->type) && ($module->type == 'addonsPartner' || $module->type == 'addonsNative')) {\n            $url = $this->context->link->getAdminLink('AdminModules') . '&install=' . urlencode($module->name) . '&tab_module=' . $module->tab . '&module_name=' . $module->name . '&anchor=' . ucfirst($module->name);\n        }\n\n        $this->context->smarty->assign([\n            'displayName' => $module->displayName,\n            'image' => $module->image,\n            'nb_rates' => (int) $module->nb_rates[0],\n            'avg_rate' => (int) $module->avg_rate[0],\n            'badges' => $module->badges,\n            'compatibility' => $module->compatibility,\n            'description_full' => $module->description_full,\n            'additional_description' => $module->additional_description,\n            'is_addons_partner' => (isset($module->type) && ($module->type == 'addonsPartner' || $module->type == 'addonsNative')),\n            'url' => $url,\n            'price' => $module->price,\n        ]);\n        // Fetch the translations in the right place - they are not defined by our current controller!\n        Context::getContext()->override_controller_name_for_translations = 'AdminModules';\n        $this->smartyOutputContent('controllers/modules/quickview.tpl');\n        die(1);\n    }\n\n    /**\n     * Add an entry to the meta title.\n     *\n     * @param string $entry new entry\n     */\n    public function addMetaTitle($entry)\n    {\n        // Only add entry if the meta title was not forced.\n        if (is_array($this->meta_title)) {\n            $this->meta_title[] = $entry;\n        }\n    }\n\n    /**\n     * Set action.\n     *\n     * @param string $action\n     */\n    public function setAction($action)\n    {\n        $this->action = $action;\n    }\n\n    /**\n     * Set IdObject.\n     *\n     * @param int $id_object\n     */\n    public function setIdObject($id_object)\n    {\n        $this->id_object = (int) $id_object;\n    }\n\n    /**\n     * @return string\n     */\n    public function getTabSlug()\n    {\n        if (empty($this->tabSlug)) {\n            $this->tabSlug = Access::findSlugByIdTab($this->id);\n        }\n\n        return $this->tabSlug;\n    }\n\n    /**\n     * {@inheritdoc}\n     */\n    protected function buildContainer()\n    {\n        return ContainerBuilder::getContainer('admin', _PS_MODE_DEV_);\n    }\n\n    /**\n     * Return the type of authorization on module page.\n     *\n     * @return int(integer)\n     */\n    public function authorizationLevel()\n    {\n        if (\n            Access::isGranted(\n                'ROLE_MOD_TAB_' . strtoupper($this->controller_name) . '_DELETE',\n                $this->context->employee->id_profile\n            )\n        ) {\n            return AdminController::LEVEL_DELETE;\n        } elseif (\n            Access::isGranted(\n                'ROLE_MOD_TAB_' . strtoupper($this->controller_name) . '_CREATE',\n                $this->context->employee->id_profile\n            )\n        ) {\n            return AdminController::LEVEL_ADD;\n        } elseif (\n            Access::isGranted(\n                'ROLE_MOD_TAB_' . strtoupper($this->controller_name) . '_UPDATE',\n                $this->context->employee->id_profile\n            )\n        ) {\n            return AdminController::LEVEL_EDIT;\n        } elseif (\n            Access::isGranted(\n                'ROLE_MOD_TAB_' . strtoupper($this->controller_name) . '_READ',\n                $this->context->employee->id_profile\n            )\n        ) {\n            return AdminController::LEVEL_VIEW;\n        } else {\n            return 0;\n        }\n    }\n\n    /**\n     * Get the url of the first active sub-tab.\n     *\n     * @param array[] $subtabs\n     *\n     * @return string Url, or empty if no active sub-tab\n     */\n    private function getTabLinkFromSubTabs(array $subtabs)\n    {\n        foreach ($subtabs as $tab) {\n            if ($tab['active'] && $tab['enabled']) {\n                return $tab['href'];\n            }\n        }\n\n        return '';\n    }\n\n    /**\n     * Prepare price specifications to display cldr prices in javascript context.\n     *\n     * @param Context $context\n     *\n     * @return array\n     */\n    private function preparePriceSpecifications(Context $context)\n    {\n        /* @var Currency */\n        $currency = $context->currency;\n        /* @var PriceSpecification */\n        $priceSpecification = $context->getCurrentLocale()->getPriceSpecification($currency->iso_code);\n        if (empty($priceSpecification)) {\n            return [];\n        }\n\n        return array_merge(\n            ['symbol' => $priceSpecification->getSymbolsByNumberingSystem(Locale::NUMBERING_SYSTEM_LATIN)->toArray()],\n            $priceSpecification->toArray()\n        );\n    }\n\n    /**\n     * Prepare number specifications to display cldr numbers in javascript context.\n     *\n     * @param Context $context\n     *\n     * @return array\n     */\n    private function prepareNumberSpecifications(Context $context)\n    {\n        /* @var NumberSpecification */\n        $numberSpecification = $context->getCurrentLocale()->getNumberSpecification();\n        if (empty($numberSpecification)) {\n            return [];\n        }\n\n        return array_merge(\n            ['symbol' => $numberSpecification->getSymbolsByNumberingSystem(Locale::NUMBERING_SYSTEM_LATIN)->toArray()],\n            $numberSpecification->toArray()\n        );\n    }\n\n    /**\n     * Set if anonymous is allowed to run this controller\n     *\n     * @param bool $value\n     *\n     * @return bool\n     */\n    protected function setAllowAnonymous($value)\n    {\n        $this->allowAnonymous = (bool) $value;\n    }\n\n    /**\n     * Return if an anonymous is allowed to run this controller\n     *\n     * @return bool\n     */\n    protected function isAnonymousAllowed()\n    {\n        return $this->allowAnonymous;\n    }\n}\n", "<?php\n/**\n * 2007-2020 PrestaShop SA and Contributors\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * https://opensource.org/licenses/OSL-3.0\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@prestashop.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade PrestaShop to newer\n * versions in the future. If you wish to customize PrestaShop for your\n * needs please refer to https://www.prestashop.com for more information.\n *\n * @author    PrestaShop SA <contact@prestashop.com>\n * @copyright 2007-2020 PrestaShop SA and Contributors\n * @license   https://opensource.org/licenses/OSL-3.0 Open Software License (OSL 3.0)\n * International Registered Trademark & Property of PrestaShop SA\n */\nuse PrestaShop\\PrestaShop\\Adapter\\Routing\\AdminLinkBuilder;\nuse PrestaShop\\PrestaShop\\Adapter\\Routing\\LegacyHelperLinkBuilder;\nuse PrestaShop\\PrestaShop\\Adapter\\SymfonyContainer;\nuse PrestaShop\\PrestaShop\\Core\\Routing\\EntityLinkBuilderFactory;\nuse PrestaShop\\PrestaShop\\Core\\Routing\\Exception\\BuilderNotFoundException;\n\n/**\n * @since 1.5.0\n */\nclass HelperListCore extends Helper\n{\n    /** @var int size which is used for lists image thumbnail generation. */\n    const LIST_THUMBNAIL_SIZE = 45;\n\n    /** @var array Cache for query results */\n    protected $_list = [];\n\n    /** @var int Number of results in list */\n    public $listTotal = 0;\n\n    /** @var array WHERE clause determined by filter fields */\n    protected $_filter;\n\n    /** @var array Number of results in list per page (used in select field) */\n    public $_pagination = [20, 50, 100, 300, 1000];\n\n    /** @var int Default number of results in list per page */\n    public $_default_pagination = 50;\n\n    /** @var string ORDER BY clause determined by field/arrows in list header */\n    public $orderBy;\n\n    /** @var string Default ORDER BY clause when $orderBy is not defined */\n    public $_defaultOrderBy = false;\n\n    /** @var array : list of vars for button delete */\n    public $tpl_delete_link_vars = [];\n\n    /** @var string Order way (ASC, DESC) determined by arrows in list header */\n    public $orderWay;\n\n    public $identifier;\n\n    protected $deleted = 0;\n\n    /** @var array $cache_lang use to cache texts in current language */\n    public static $cache_lang = [];\n\n    public $is_cms = false;\n\n    public $position_identifier;\n\n    public $table_id;\n\n    /** @var string */\n    public $title_icon = null;\n\n    /**\n     * @var array Customize list display\n     *\n     * align  : determine value alignment\n     * prefix : displayed before value\n     * suffix : displayed after value\n     * image  : object image\n     * icon   : icon determined by values\n     * active : allow to toggle status\n     */\n    protected $fields_list;\n\n    /** @var bool Content line is clickable if true */\n    public $no_link = false;\n\n    /** @var Smarty_Internal_Template|string */\n    protected $header_tpl = 'list_header.tpl';\n\n    /** @var Smarty_Internal_Template|string */\n    protected $content_tpl = 'list_content.tpl';\n\n    /** @var Smarty_Internal_Template|string */\n    protected $footer_tpl = 'list_footer.tpl';\n\n    /** @var array list of required actions for each list row */\n    public $actions = [];\n\n    /** @var array list of row ids associated with a given action for witch this action have to not be available */\n    public $list_skip_actions = [];\n\n    public $bulk_actions = false;\n    public $force_show_bulk_actions = false;\n    public $specificConfirmDelete = null;\n    public $colorOnBackground;\n\n    /** @var bool If true, activates color on hover */\n    public $row_hover = true;\n\n    /** @var string|null If not null, a title will be added on that list */\n    public $title = null;\n\n    /** @var bool ask for simple header : no filters, no paginations and no sorting */\n    public $simple_header = false;\n\n    public $ajax_params = [];\n\n    public $page;\n\n    /** @var EntityLinkBuilderFactory */\n    private $linkBuilderFactory;\n\n    /**\n     * You can use $controllerMapping to add entity/controller mapping in order to have migrated links\n     * in a legacy list (this requires to have correctly set the _legacy_link in the routing of course)\n     *\n     * exemple: $helper = new HelperList(['cart' => 'AdminCarts']);\n     *\n     * @param array $controllerMapping\n     */\n    public function __construct(array $controllerMapping = [])\n    {\n        $this->base_folder = 'helpers/list/';\n        $this->base_tpl = 'list.tpl';\n\n        $controllerMapping = array_merge([\n            'customer' => 'AdminCustomers',\n            'product' => 'AdminProducts',\n            'order' => 'AdminOrders',\n            'cart' => 'AdminCarts',\n        ], $controllerMapping);\n        $adminLinkBuilder = new AdminLinkBuilder(Context::getContext()->link, $controllerMapping);\n        $this->linkBuilderFactory = new EntityLinkBuilderFactory([\n            $adminLinkBuilder,\n            new LegacyHelperLinkBuilder(),\n        ]);\n\n        parent::__construct();\n    }\n\n    /**\n     * Return an html list given the data to fill it up.\n     *\n     * @param array $list entries to display (rows)\n     * @param array $fields_display fields (cols)\n     *\n     * @return string html\n     */\n    public function generateList($list, $fields_display)\n    {\n        // Append when we get a syntax error in SQL query\n        if ($list === false) {\n            $this->context->controller->warnings[] = Context::getContext()->getTranslator()->trans('Bad SQL query', [], 'Admin.Notifications.Error');\n\n            return false;\n        }\n\n        $this->tpl = $this->createTemplate($this->base_tpl);\n        $this->header_tpl = $this->createTemplate($this->header_tpl);\n        $this->content_tpl = $this->createTemplate($this->content_tpl);\n        $this->footer_tpl = $this->createTemplate($this->footer_tpl);\n\n        $this->_list = $list;\n        $this->fields_list = $fields_display;\n\n        $patternsOrderBy = [\n            '/^([a-z _]*!)/Ui',     // remove a. for example\n            '/^([a-z _]*\\.)/Ui',    // remove a! for example\n            '/`/',                  // remove ` char\n        ];\n        $this->orderBy = preg_replace($patternsOrderBy, '', $this->orderBy);\n\n        $this->orderWay = preg_replace('/^([a-z _]*!)/Ui', '', $this->orderWay);\n\n        $this->tpl->assign([\n            'header' => $this->displayListHeader(), // Display list header (filtering, pagination and column names)\n            'content' => $this->displayListContent(), // Show the content of the table\n            'footer' => $this->displayListFooter(), // Close list table and submit button\n        ]);\n\n        return parent::generate();\n    }\n\n    /**\n     * Fetch the template for action enable.\n     *\n     * @param string $token\n     * @param string $id\n     * @param int $value state enabled or not\n     * @param string $active status\n     * @param int $id_category\n     * @param int $id_product\n     *\n     * @return string\n     */\n    public function displayEnableLink($token, $id, $value, $active, $id_category = null, $id_product = null, $ajax = false)\n    {\n        $tpl_enable = $this->createTemplate('list_action_enable.tpl');\n        $tpl_enable->assign([\n            'ajax' => $ajax,\n            'enabled' => (bool) $value,\n            'url_enable' => $this->currentIndex . '&' . $this->identifier . '=' . $id . '&' . $active . $this->table . ($ajax ? '&action=' . $active . $this->table . '&ajax=' . (int) $ajax : '') .\n                ((int) $id_category && (int) $id_product ? '&id_category=' . (int) $id_category : '') . ($this->page && $this->page > 1 ? '&page=' . (int) $this->page : '') . '&token=' . ($token != null ? $token : $this->token),\n        ]);\n\n        return $tpl_enable->fetch();\n    }\n\n    public function displayListContent()\n    {\n        if (isset($this->fields_list['position'])) {\n            if ($this->position_identifier) {\n                if (isset($this->position_group_identifier)) {\n                    $position_group_identifier = Tools::getIsset($this->position_group_identifier) ? (int) Tools::getValue($this->position_group_identifier) : $this->position_group_identifier;\n                } else {\n                    $position_group_identifier = (int) Tools::getValue('id_' . ($this->is_cms ? 'cms_' : '') . 'category', ($this->is_cms ? '1' : Category::getRootCategory()->id));\n                }\n            } else {\n                $position_group_identifier = Category::getRootCategory()->id;\n            }\n\n            $positions = array_map(function ($elem) { return (int) ($elem['position']); }, $this->_list);\n            sort($positions);\n        }\n\n        // key_to_get is used to display the correct product category or cms category after a position change\n        $identifier = in_array($this->identifier, ['id_category', 'id_cms_category']) ? '_parent' : '';\n        if ($identifier) {\n            $key_to_get = 'id_' . ($this->is_cms ? 'cms_' : '') . 'category' . $identifier;\n        }\n\n        foreach ($this->_list as $index => $tr) {\n            $id = null;\n            if (isset($tr[$this->identifier])) {\n                $id = $tr[$this->identifier];\n            }\n            $name = isset($tr['name']) ? $tr['name'] : null;\n\n            if ($this->shopLinkType) {\n                $this->_list[$index]['short_shop_name'] = Tools::strlen($tr['shop_name']) > 15 ? Tools::substr($tr['shop_name'], 0, 15) . '...' : $tr['shop_name'];\n            }\n\n            $is_first = true;\n            // Check all available actions to add to the current list row\n            foreach ($this->actions as $action) {\n                //Check if the action is available for the current row\n                if (!array_key_exists($action, $this->list_skip_actions) || !in_array($id, $this->list_skip_actions[$action])) {\n                    $method_name = 'display' . ucfirst($action) . 'Link';\n\n                    if (method_exists($this->context->controller, $method_name)) {\n                        $this->_list[$index][$action] = $this->context->controller->$method_name($this->token, $id, $name);\n                    } elseif ($this->module instanceof Module && method_exists($this->module, $method_name)) {\n                        $this->_list[$index][$action] = $this->module->$method_name($this->token, $id, $name);\n                    } elseif (method_exists($this, $method_name)) {\n                        $this->_list[$index][$action] = $this->$method_name($this->token, $id, $name);\n                    }\n                }\n\n                if ($is_first && isset($this->_list[$index][$action])) {\n                    $is_first = false;\n\n                    if (!preg_match('/a\\s*.*class/', $this->_list[$index][$action])) {\n                        $this->_list[$index][$action] = preg_replace(\n                            '/href\\s*=\\s*\\\"([^\\\"]*)\\\"/',\n                            'href=\"$1\" class=\"btn btn-default\"',\n                            $this->_list[$index][$action]\n                        );\n                    } elseif (!preg_match('/a\\s*.*class\\s*=\\s*\\\".*btn.*\\\"/', $this->_list[$index][$action])) {\n                        $this->_list[$index][$action] = preg_replace(\n                            '/a(\\s*.*)class\\s*=\\s*\\\"(.*)\\\"/',\n                            'a $1 class=\"$2 btn btn-default\"',\n                            $this->_list[$index][$action]\n                        );\n                    }\n                }\n            }\n\n            $this->_list[$index]['link'] = in_array('view', $this->actions) ? $this->getViewLink($this->token, $id) : $this->getEditLink($this->token, $id);\n\n            // @todo skip action for bulk actions\n            // $this->_list[$index]['has_bulk_actions'] = true;\n            foreach ($this->fields_list as $key => $params) {\n                $tmp = explode('!', $key);\n                $key = isset($tmp[1]) ? $tmp[1] : $tmp[0];\n\n                if (isset($params['active'])) {\n                    // If method is defined in calling controller, use it instead of the Helper method\n                    if (method_exists($this->context->controller, 'displayEnableLink')) {\n                        $calling_obj = $this->context->controller;\n                    } elseif (isset($this->module) && method_exists($this->module, 'displayEnableLink')) {\n                        $calling_obj = $this->module;\n                    } else {\n                        $calling_obj = $this;\n                    }\n\n                    if (!isset($params['ajax'])) {\n                        $params['ajax'] = false;\n                    }\n                    $this->_list[$index][$key] = $calling_obj->displayEnableLink(\n                        $this->token,\n                        $id,\n                        $tr[$key],\n                        $params['active'],\n                        Tools::getValue('id_category'),\n                        Tools::getValue('id_product'),\n                        $params['ajax']\n                    );\n                } elseif (isset($params['activeVisu'])) {\n                    $this->_list[$index][$key] = (bool) $tr[$key];\n                } elseif (isset($params['position'])) {\n                    $this->_list[$index][$key] = [\n                        'position' => $tr[$key],\n                        'position_url_down' => $this->currentIndex .\n                            (isset($key_to_get) ? '&' . $key_to_get . '=' . (int) $position_group_identifier : '') .\n                            '&' . $this->position_identifier . '=' . $id .\n                            '&way=1&position=' . ((int) $tr['position'] + 1) . '&token=' . $this->token,\n                        'position_url_up' => $this->currentIndex .\n                            (isset($key_to_get) ? '&' . $key_to_get . '=' . (int) $position_group_identifier : '') .\n                            '&' . $this->position_identifier . '=' . $id .\n                            '&way=0&position=' . ((int) $tr['position'] - 1) . '&token=' . $this->token,\n                    ];\n                } elseif (isset($params['image'])) {\n                    // item_id is the product id in a product image context, else it is the image id.\n                    $item_id = isset($params['image_id']) ? $tr[$params['image_id']] : $id;\n                    if ($params['image'] != 'p' || Configuration::get('PS_LEGACY_IMAGES')) {\n                        $path_to_image = _PS_IMG_DIR_ . $params['image'] . '/' . $item_id . (isset($tr['id_image']) ? '-' . (int) $tr['id_image'] : '') . '.' . $this->imageType;\n                    } else {\n                        $path_to_image = _PS_IMG_DIR_ . $params['image'] . '/' . Image::getImgFolderStatic($tr['id_image']) . (int) $tr['id_image'] . '.' . $this->imageType;\n                    }\n                    $this->_list[$index][$key] = ImageManager::thumbnail($path_to_image, $this->table . '_mini_' . $item_id . '_' . $this->context->shop->id . '.' . $this->imageType, self::LIST_THUMBNAIL_SIZE, $this->imageType);\n                } elseif (isset($params['icon'], $tr[$key]) && (isset($params['icon'][$tr[$key]]) || isset($params['icon']['default']))) {\n                    if (!$this->bootstrap) {\n                        if (isset($params['icon'][$tr[$key]]) && is_array($params['icon'][$tr[$key]])) {\n                            $this->_list[$index][$key] = [\n                                'src' => $params['icon'][$tr[$key]]['src'],\n                                'alt' => $params['icon'][$tr[$key]]['alt'],\n                            ];\n                        } else {\n                            $this->_list[$index][$key] = [\n                                'src' => isset($params['icon'][$tr[$key]]) ? $params['icon'][$tr[$key]] : $params['icon']['default'],\n                                'alt' => isset($params['icon'][$tr[$key]]) ? $params['icon'][$tr[$key]] : $params['icon']['default'],\n                            ];\n                        }\n                    } elseif (isset($params['icon'][$tr[$key]])) {\n                        $this->_list[$index][$key] = $params['icon'][$tr[$key]];\n                    }\n                } elseif (isset($params['type']) && $params['type'] == 'float') {\n                    $this->_list[$index][$key] = rtrim(rtrim($tr[$key], '0'), '.');\n                } elseif (isset($tr[$key])) {\n                    $echo = $tr[$key];\n                    if (isset($params['callback'])) {\n                        $callback_obj = (isset($params['callback_object'])) ? $params['callback_object'] : $this->context->controller;\n                        $this->_list[$index][$key] = call_user_func_array([$callback_obj, $params['callback']], [$echo, $tr]);\n                    } else {\n                        $this->_list[$index][$key] = $echo;\n                    }\n                }\n            }\n        }\n\n        $showShopColumn = $this->shopLinkType;\n\n        $isMultiShopActive = Configuration::get('PS_MULTISHOP_FEATURE_ACTIVE');\n\n        $this->content_tpl->assign(array_merge($this->tpl_vars, [\n            'shop_link_type' => $showShopColumn,\n            'multishop_active' => $isMultiShopActive,\n            'name' => isset($name) ? $name : null,\n            'position_identifier' => $this->position_identifier,\n            'identifier' => $this->identifier,\n            'table' => $this->table,\n            'token' => $this->token,\n            'color_on_bg' => $this->colorOnBackground,\n            'position_group_identifier' => isset($position_group_identifier) ? $position_group_identifier : false,\n            'bulk_actions' => $this->bulk_actions,\n            'positions' => isset($positions) ? $positions : null,\n            'order_by' => $this->orderBy,\n            'order_way' => $this->orderWay,\n            'is_cms' => $this->is_cms,\n            'fields_display' => $this->fields_list,\n            'list' => $this->_list,\n            'actions' => $this->actions,\n            'no_link' => $this->no_link,\n            'current_index' => $this->currentIndex,\n            'view' => in_array('view', $this->actions),\n            'edit' => in_array('edit', $this->actions),\n            'has_actions' => !empty($this->actions),\n            'list_skip_actions' => $this->list_skip_actions,\n            'row_hover' => $this->row_hover,\n            'list_id' => isset($this->list_id) ? $this->list_id : $this->table,\n            'checked_boxes' => Tools::getValue((isset($this->list_id) ? $this->list_id : $this->table) . 'Box'),\n        ]));\n\n        return $this->content_tpl->fetch();\n    }\n\n    /**\n     * Display duplicate action link.\n     */\n    public function displayDuplicateLink($token, $id, $name = null)\n    {\n        $tpl = $this->createTemplate('list_action_duplicate.tpl');\n        if (!array_key_exists('Bad SQL query', self::$cache_lang)) {\n            self::$cache_lang['Duplicate'] = Context::getContext()->getTranslator()->trans('Duplicate', [], 'Admin.Actions');\n        }\n\n        if (!array_key_exists('Copy images too?', self::$cache_lang)) {\n            self::$cache_lang['Copy images too?'] = Context::getContext()->getTranslator()->trans('This will copy the images too. If you wish to proceed, click \"Yes\". If not, click \"No\".', [], 'Admin.Catalog.Notification');\n        }\n\n        $duplicate = $this->currentIndex . '&' . $this->identifier . '=' . $id . '&duplicate' . $this->table;\n\n        $confirm = self::$cache_lang['Copy images too?'];\n\n        if (($this->table == 'product') && !Image::hasImages($this->context->language->id, (int) $id)) {\n            $confirm = '';\n        }\n\n        $tpl->assign([\n            'href' => $this->currentIndex . '&' . $this->identifier . '=' . $id . '&view' . $this->table . '&token=' . ($token != null ? $token : $this->token),\n            'action' => self::$cache_lang['Duplicate'],\n            'confirm' => $confirm,\n            'location_ok' => $duplicate . '&token=' . ($token != null ? $token : $this->token),\n            'location_ko' => $duplicate . '&noimage=1&token=' . ($token ? $token : $this->token),\n        ]);\n\n        return $tpl->fetch();\n    }\n\n    /**\n     * Display action show details of a table row\n     * This action need an ajax request with a return like this:\n     *   {\n     *     use_parent_structure: true // If false, data need to be an html\n     *     data:\n     *       [\n     *         {field_name: 'value'}\n     *       ],\n     *     fields_display: // attribute $fields_list of the admin controller\n     *   }\n     * or somethins like this:\n     *   {\n     *     use_parent_structure: false // If false, data need to be an html\n     *     data:\n     *       '<p>My html content</p>',\n     *     fields_display: // attribute $fields_list of the admin controller\n     *   }.\n     */\n    public function displayDetailsLink($token, $id, $name = null)\n    {\n        $tpl = $this->createTemplate('list_action_details.tpl');\n        if (!array_key_exists('Details', self::$cache_lang)) {\n            self::$cache_lang['Details'] = Context::getContext()->getTranslator()->trans('Details', [], 'Admin.Global');\n        }\n\n        $ajax_params = $this->ajax_params;\n        if (!is_array($ajax_params) || !isset($ajax_params['action'])) {\n            $ajax_params['action'] = 'details';\n        }\n\n        $tpl->assign([\n            'id' => $id,\n            'href' => $this->currentIndex . '&' . $this->identifier . '=' . $id . '&details' . $this->table . '&token=' . ($token != null ? $token : $this->token),\n            'controller' => str_replace('Controller', '', get_class($this->context->controller)),\n            'token' => $token != null ? $token : $this->token,\n            'action' => self::$cache_lang['Details'],\n            'params' => $ajax_params,\n            'json_params' => json_encode($ajax_params),\n        ]);\n\n        return $tpl->fetch();\n    }\n\n    /**\n     * Display view action link.\n     */\n    public function displayViewLink($token, $id, $name = null)\n    {\n        $tpl = $this->createTemplate('list_action_view.tpl');\n        if (!array_key_exists('View', self::$cache_lang)) {\n            self::$cache_lang['View'] = Context::getContext()->getTranslator()->trans('View', [], 'Admin.Actions');\n        }\n\n        $href = $this->getViewLink($token, $id);\n        $tpl->assign([\n            'href' => $href,\n            'action' => self::$cache_lang['View'],\n        ]);\n\n        return $tpl->fetch();\n    }\n\n    /**\n     * Display edit action link.\n     */\n    public function displayEditLink($token, $id, $name = null)\n    {\n        $tpl = $this->createTemplate('list_action_edit.tpl');\n        if (!array_key_exists('Edit', self::$cache_lang)) {\n            self::$cache_lang['Edit'] = Context::getContext()->getTranslator()->trans('Edit', [], 'Admin.Actions');\n        }\n\n        $href = $this->getEditLink($token, $id);\n        $tpl->assign([\n            'href' => $href,\n            'action' => self::$cache_lang['Edit'],\n            'id' => $id,\n        ]);\n\n        return $tpl->fetch();\n    }\n\n    /**\n     * Display delete action link.\n     */\n    public function displayDeleteLink($token, $id, $name = null)\n    {\n        $tpl = $this->createTemplate('list_action_delete.tpl');\n\n        if (!array_key_exists('Delete', self::$cache_lang)) {\n            self::$cache_lang['Delete'] = Context::getContext()->getTranslator()->trans('Delete', [], 'Admin.Actions');\n        }\n\n        if (!array_key_exists('DeleteItem', self::$cache_lang)) {\n            self::$cache_lang['DeleteItem'] = Context::getContext()->getTranslator()->trans('Delete selected item?', [], 'Admin.Notifications.Info');\n        }\n\n        if (!array_key_exists('Name', self::$cache_lang)) {\n            self::$cache_lang['Name'] = Context::getContext()->getTranslator()->trans('Name:', [], 'Admin.Global');\n        }\n\n        if (null !== $name) {\n            $name = addcslashes('\\n\\n' . self::$cache_lang['Name'] . ' ' . $name, '\\'');\n        }\n\n        $href = $this->currentIndex . '&' . $this->identifier . '=' . $id . '&delete' . $this->table . '&token=' . ($token != null ? $token : $this->token);\n\n        switch ($this->currentIndex) {\n            case 'index.php?controller=AdminProducts':\n            case 'index.php?tab=AdminProducts':\n                // New architecture modification: temporary behavior to switch between old and new controllers.\n                $pagePreference = SymfonyContainer::getInstance()->get('prestashop.core.admin.page_preference_interface');\n                $redirectLegacy = $pagePreference->getTemporaryShouldUseLegacyPage('product');\n                if (!$redirectLegacy && $this->identifier == 'id_product') {\n                    $href = Context::getContext()->link->getAdminLink('AdminProducts', true, ['id_product' => $id, 'deleteproduct' => 1]);\n                }\n\n                break;\n            default:\n        }\n\n        $data = [\n            $this->identifier => $id,\n            'href' => $href,\n            'action' => self::$cache_lang['Delete'],\n        ];\n\n        if ($this->specificConfirmDelete !== false) {\n            $data['confirm'] = null !== $this->specificConfirmDelete ? '\\r' . $this->specificConfirmDelete : Tools::safeOutput(self::$cache_lang['DeleteItem'] . $name);\n        }\n\n        $tpl->assign(array_merge($this->tpl_delete_link_vars, $data));\n\n        return $tpl->fetch();\n    }\n\n    /**\n     * Display default action link.\n     */\n    public function displayDefaultLink($token, $id, $name = null)\n    {\n        $tpl = $this->createTemplate('list_action_default.tpl');\n        if (!array_key_exists('Default', self::$cache_lang)) {\n            self::$cache_lang['Default'] = Context::getContext()->getTranslator()->trans('Default', [], 'Admin.Global');\n        }\n\n        $tpl->assign([\n            'href' => $this->currentIndex . '&' . $this->identifier . '=' . (int) $id . '&default' . $this->table . '&token=' . ($token != null ? $token : $this->token),\n            'action' => self::$cache_lang['Default'],\n            'name' => $name,\n        ]);\n\n        return $tpl->fetch();\n    }\n\n    /**\n     * Display list header (filtering, pagination and column names).\n     */\n    public function displayListHeader()\n    {\n        if (!isset($this->list_id)) {\n            $this->list_id = $this->table;\n        }\n\n        $id_cat = (int) Tools::getValue('id_' . ($this->is_cms ? 'cms_' : '') . 'category');\n\n        if (!isset($token) || empty($token)) {\n            $token = $this->token;\n        }\n\n        /* Determine total page number */\n        $pagination = $this->_default_pagination;\n        if (in_array((int) Tools::getValue($this->list_id . '_pagination'), $this->_pagination)) {\n            $pagination = (int) Tools::getValue($this->list_id . '_pagination');\n        } elseif (isset($this->context->cookie->{$this->list_id . '_pagination'}) && $this->context->cookie->{$this->list_id . '_pagination'}) {\n            $pagination = $this->context->cookie->{$this->list_id . '_pagination'};\n        }\n\n        $total_pages = max(1, ceil($this->listTotal / $pagination));\n\n        $identifier = Tools::getIsset($this->identifier) ? '&' . $this->identifier . '=' . (int) Tools::getValue($this->identifier) : '';\n        $order = '';\n        if (Tools::getIsset($this->table . 'Orderby')) {\n            $order = '&' . $this->table . 'Orderby=' . urlencode($this->orderBy) . '&' . $this->table . 'Orderway=' . urlencode(strtolower($this->orderWay));\n        }\n\n        $action = $this->currentIndex . $identifier . '&token=' . $token . '#' . $this->list_id;\n\n        /* Determine current page number */\n        $page = (int) Tools::getValue('submitFilter' . $this->list_id);\n\n        if (!$page) {\n            $page = 1;\n        }\n\n        if ($page > $total_pages) {\n            $page = $total_pages;\n        }\n\n        $this->page = (int) $page;\n\n        /* Choose number of results per page */\n        $selected_pagination = Tools::getValue(\n            $this->list_id . '_pagination',\n            isset($this->context->cookie->{$this->list_id . '_pagination'}) ? $this->context->cookie->{$this->list_id . '_pagination'} : $this->_default_pagination\n        );\n\n        if (!isset($this->table_id) && $this->position_identifier && (int) Tools::getValue($this->position_identifier, 1)) {\n            $this->table_id = substr($this->identifier, 3, strlen($this->identifier));\n        }\n\n        if ($this->position_identifier && ($this->orderBy == 'position' && $this->orderWay != 'DESC')) {\n            $table_dnd = true;\n        }\n\n        $prefix = isset($this->controller_name) ? str_replace(['admin', 'controller'], '', Tools::strtolower($this->controller_name)) : '';\n        $ajax = false;\n        foreach ($this->fields_list as $key => $params) {\n            if (!isset($params['type'])) {\n                $params['type'] = 'text';\n            }\n\n            $value_key = $prefix . $this->list_id . 'Filter_' . (array_key_exists('filter_key', $params) ? $params['filter_key'] : $key);\n            if ($key == 'active' && strpos($key, '!') !== false) {\n                $keys = explode('!', $params['filter_key']);\n                $value_key = $keys[1];\n            }\n            $value = Context::getContext()->cookie->{$value_key};\n            if (!$value && Tools::getIsset($value_key)) {\n                $value = Tools::getValue($value_key);\n            }\n\n            switch ($params['type']) {\n                case 'bool':\n                    if (isset($params['ajax']) && $params['ajax']) {\n                        $ajax = true;\n                    }\n\n                    break;\n\n                case 'date':\n                case 'datetime':\n                    if (is_string($value)) {\n                        $value = json_decode($value, true);\n                    }\n                    if (!Validate::isCleanHtml($value[0]) || !Validate::isCleanHtml($value[1])) {\n                        $value = '';\n                    }\n                    $name = $this->list_id . 'Filter_' . (isset($params['filter_key']) ? $params['filter_key'] : $key);\n                    $name_id = str_replace('!', '__', $name);\n\n                    $params['id_date'] = $name_id;\n                    $params['name_date'] = $name;\n\n                    $this->context->controller->addJqueryUI('ui.datepicker');\n\n                    break;\n\n                case 'select':\n                    foreach ($params['list'] as $option_value => $option_display) {\n                        if (isset(Context::getContext()->cookie->{$prefix . $this->list_id . 'Filter_' . $params['filter_key']})\n                            && Context::getContext()->cookie->{$prefix . $this->list_id . 'Filter_' . $params['filter_key']} == $option_value\n                            && Context::getContext()->cookie->{$prefix . $this->list_id . 'Filter_' . $params['filter_key']} != '') {\n                            $this->fields_list[$key]['select'][$option_value]['selected'] = 'selected';\n                        }\n                    }\n\n                    break;\n\n                case 'text':\n                    if (!Validate::isCleanHtml($value)) {\n                        $value = '';\n                    }\n            }\n\n            $params['value'] = $value;\n            $this->fields_list[$key] = $params;\n        }\n\n        $has_value = false;\n        $has_search_field = false;\n\n        foreach ($this->fields_list as $key => $field) {\n            if (isset($field['value']) && $field['value'] !== false && $field['value'] !== '') {\n                if (is_array($field['value']) && trim(implode('', $field['value'])) == '') {\n                    continue;\n                }\n\n                $has_value = true;\n\n                break;\n            }\n            if (!(isset($field['search']) && $field['search'] === false)) {\n                $has_search_field = true;\n            }\n        }\n\n        Context::getContext()->smarty->assign([\n            'page' => $page,\n            'simple_header' => $this->simple_header,\n            'total_pages' => $total_pages,\n            'selected_pagination' => $selected_pagination,\n            'pagination' => $this->_pagination,\n            'list_total' => $this->listTotal,\n            'sql' => isset($this->sql) && $this->sql ? str_replace('\\n', ' ', str_replace('\\r', '', $this->sql)) : false,\n            'token' => $this->token,\n            'table' => $this->table,\n            'bulk_actions' => $this->bulk_actions,\n            'show_toolbar' => $this->show_toolbar,\n            'toolbar_scroll' => $this->toolbar_scroll,\n            'toolbar_btn' => $this->toolbar_btn,\n            'has_bulk_actions' => $this->hasBulkActions($has_value),\n            'filters_has_value' => (bool) $has_value,\n        ]);\n\n        if (null !== $this->title_icon) {\n            Context::getContext()->smarty->assign(['icon' => $this->title_icon]);\n        }\n\n        $isMultiShopActive = Configuration::get('PS_MULTISHOP_FEATURE_ACTIVE');\n\n        $this->header_tpl->assign(array_merge([\n            'ajax' => $ajax,\n            'title' => array_key_exists('title', $this->tpl_vars) ? $this->tpl_vars['title'] : $this->title,\n            'show_filters' => ((count($this->_list) > 1 && $has_search_field) || $has_value),\n            'currentIndex' => $this->currentIndex,\n            'action' => $action,\n            'is_order_position' => $this->position_identifier && $this->orderBy == 'position',\n            'order_way' => $this->orderWay,\n            'order_by' => $this->orderBy,\n            'fields_display' => $this->fields_list,\n            'delete' => in_array('delete', $this->actions),\n            'identifier' => $this->identifier,\n            'id_cat' => $id_cat,\n            'shop_link_type' => $this->shopLinkType,\n            'multishop_active' => $isMultiShopActive,\n            'has_actions' => !empty($this->actions),\n            'table_id' => isset($this->table_id) ? $this->table_id : null,\n            'table_dnd' => isset($table_dnd) ? $table_dnd : null,\n            'name' => isset($name) ? $name : null,\n            'name_id' => isset($name_id) ? $name_id : null,\n            'row_hover' => $this->row_hover,\n            'list_id' => isset($this->list_id) ? $this->list_id : $this->table,\n        ], $this->tpl_vars));\n\n        return $this->header_tpl->fetch();\n    }\n\n    public function hasBulkActions($has_value = false)\n    {\n        if ($this->force_show_bulk_actions) {\n            return true;\n        }\n\n        if (count($this->_list) <= 1 && !$has_value) {\n            return false;\n        }\n\n        if (isset($this->list_skip_actions) && count($this->list_skip_actions)\n            && isset($this->bulk_actions) && is_array($this->bulk_actions) && count($this->bulk_actions)) {\n            foreach ($this->bulk_actions as $action => $data) {\n                if (array_key_exists($action, $this->list_skip_actions)) {\n                    foreach ($this->_list as $key => $row) {\n                        if (!in_array($row[$this->identifier], $this->list_skip_actions[$action])) {\n                            return true;\n                        }\n                    }\n\n                    return false;\n                }\n            }\n        }\n\n        return !empty($this->bulk_actions);\n    }\n\n    /**\n     * Close list table and submit button.\n     */\n    public function displayListFooter()\n    {\n        if (!isset($this->list_id)) {\n            $this->list_id = $this->table;\n        }\n\n        $this->footer_tpl->assign(array_merge($this->tpl_vars, [\n            'current' => $this->currentIndex,\n            'list_id' => $this->list_id,\n        ]));\n\n        return $this->footer_tpl->fetch();\n    }\n\n    /**\n     * @param string|null $token\n     * @param int $id\n     *\n     * @return string\n     *\n     * @throws BuilderNotFoundException\n     * @throws PrestaShopException\n     */\n    protected function getViewLink($token, $id)\n    {\n        $linkBuilder = $this->linkBuilderFactory->getBuilderFor($this->table);\n        $parameters = $this->buildLinkParameters($token, $id);\n\n        return $linkBuilder->getViewLink($this->table, $parameters);\n    }\n\n    /**\n     * @param string|null $token\n     * @param int $id\n     *\n     * @return string\n     *\n     * @throws BuilderNotFoundException\n     * @throws PrestaShopException\n     */\n    protected function getEditLink($token, $id)\n    {\n        $linkBuilder = $this->linkBuilderFactory->getBuilderFor($this->table);\n        $parameters = $this->buildLinkParameters($token, $id);\n\n        return $linkBuilder->getEditLink($this->table, $parameters);\n    }\n\n    /**\n     * @param string|null $token\n     * @param int $id\n     *\n     * @return array\n     */\n    protected function buildLinkParameters($token, $id)\n    {\n        $parameters = [\n            $this->identifier => $id,\n            'current_index' => $this->currentIndex,\n            'token' => $token != null ? $token : $this->token,\n        ];\n        if ($this->page && $this->page > 1) {\n            $parameters['page'] = $this->page;\n        }\n\n        return $parameters;\n    }\n}\n", "<?php\n/**\n * 2007-2020 PrestaShop SA and Contributors\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * https://opensource.org/licenses/OSL-3.0\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@prestashop.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade PrestaShop to newer\n * versions in the future. If you wish to customize PrestaShop for your\n * needs please refer to https://www.prestashop.com for more information.\n *\n * @author    PrestaShop SA <contact@prestashop.com>\n * @copyright 2007-2020 PrestaShop SA and Contributors\n * @license   https://opensource.org/licenses/OSL-3.0 Open Software License (OSL 3.0)\n * International Registered Trademark & Property of PrestaShop SA\n */\n\n/**\n * @property AttributeGroup $object\n */\nclass AdminAttributesGroupsControllerCore extends AdminController\n{\n    public $bootstrap = true;\n    protected $id_attribute;\n    protected $position_identifier = 'id_attribute_group';\n    protected $attribute_name;\n\n    public function __construct()\n    {\n        $this->bootstrap = true;\n        $this->table = 'attribute_group';\n        $this->list_id = 'attribute_group';\n        $this->identifier = 'id_attribute_group';\n        $this->className = 'AttributeGroup';\n        $this->lang = true;\n        $this->_defaultOrderBy = 'position';\n\n        parent::__construct();\n\n        $this->fields_list = [\n            'id_attribute_group' => [\n                'title' => $this->trans('ID', [], 'Admin.Global'),\n                'align' => 'center',\n                'class' => 'fixed-width-xs',\n            ],\n            'name' => [\n                'title' => $this->trans('Name', [], 'Admin.Global'),\n                'filter_key' => 'b!name',\n                'align' => 'left',\n            ],\n            'count_values' => [\n                'title' => $this->trans('Values', [], 'Admin.Catalog.Feature'),\n                'align' => 'center',\n                'class' => 'fixed-width-xs',\n                'orderby' => false,\n                'search' => false,\n            ],\n            'position' => [\n                'title' => $this->trans('Position', [], 'Admin.Global'),\n                'filter_key' => 'a!position',\n                'position' => 'position',\n                'align' => 'center',\n                'class' => 'fixed-width-xs',\n            ],\n        ];\n\n        $this->bulk_actions = [\n            'delete' => [\n                'text' => $this->trans('Delete selected', [], 'Admin.Notifications.Info'),\n                'icon' => 'icon-trash',\n                'confirm' => $this->trans('Delete selected items?', [], 'Admin.Notifications.Info'),\n            ],\n        ];\n        $this->fieldImageSettings = ['name' => 'texture', 'dir' => 'co'];\n\n        $this->image_dir = 'co';\n    }\n\n    /**\n     * AdminController::renderList() override.\n     *\n     * @see AdminController::renderList()\n     */\n    public function renderList()\n    {\n        $this->addRowAction('view');\n        $this->addRowAction('edit');\n        $this->addRowAction('delete');\n\n        return parent::renderList();\n    }\n\n    public function renderView()\n    {\n        if (($id = (int) Tools::getValue('id_attribute_group'))) {\n            $this->table = 'attribute';\n            $this->className = 'Attribute';\n            $this->identifier = 'id_attribute';\n            $this->position_identifier = 'id_attribute';\n            $this->position_group_identifier = 'id_attribute_group';\n            $this->list_id = 'attribute_values';\n            $this->lang = true;\n\n            $this->context->smarty->assign([\n                'current' => self::$currentIndex . '&id_attribute_group=' . (int) $id . '&viewattribute_group',\n            ]);\n\n            if (!Validate::isLoadedObject($obj = new AttributeGroup((int) $id))) {\n                $this->errors[] = $this->trans('An error occurred while updating the status for an object.', [], 'Admin.Catalog.Notification') .\n                    ' <b>' . $this->table . '</b> ' .\n                    $this->trans('(cannot load object)', [], 'Admin.Catalog.Notification');\n\n                return;\n            }\n\n            $this->attribute_name = $obj->name;\n            $this->fields_list = [\n                'id_attribute' => [\n                    'title' => $this->trans('ID', [], 'Admin.Global'),\n                    'align' => 'center',\n                    'class' => 'fixed-width-xs',\n                ],\n                'name' => [\n                    'title' => $this->trans('Value', [], 'Admin.Catalog.Feature'),\n                    'width' => 'auto',\n                    'filter_key' => 'b!name',\n                ],\n            ];\n\n            if ($obj->group_type == 'color') {\n                $this->fields_list['color'] = [\n                    'title' => $this->trans('Color', [], 'Admin.Catalog.Feature'),\n                    'filter_key' => 'a!color',\n                ];\n            }\n\n            $this->fields_list['position'] = [\n                'title' => $this->trans('Position', [], 'Admin.Global'),\n                'filter_key' => 'a!position',\n                'position' => 'position',\n                'class' => 'fixed-width-md',\n            ];\n\n            $this->addRowAction('edit');\n            $this->addRowAction('delete');\n\n            $this->_where = 'AND a.`id_attribute_group` = ' . (int) $id;\n            $this->_orderBy = 'position';\n\n            self::$currentIndex = self::$currentIndex . '&id_attribute_group=' . (int) $id . '&viewattribute_group';\n            $this->processFilter();\n\n            return parent::renderList();\n        }\n    }\n\n    /**\n     * AdminController::renderForm() override.\n     *\n     * @see AdminController::renderForm()\n     */\n    public function renderForm()\n    {\n        $this->table = 'attribute_group';\n        $this->identifier = 'id_attribute_group';\n\n        $group_type = [\n            [\n                'id' => 'select',\n                'name' => $this->trans('Drop-down list', [], 'Admin.Global'),\n            ],\n            [\n                'id' => 'radio',\n                'name' => $this->trans('Radio buttons', [], 'Admin.Global'),\n            ],\n            [\n                'id' => 'color',\n                'name' => $this->trans('Color or texture', [], 'Admin.Catalog.Feature'),\n            ],\n        ];\n\n        $this->fields_form = [\n            'legend' => [\n                'title' => $this->trans('Attributes', [], 'Admin.Catalog.Feature'),\n                'icon' => 'icon-info-sign',\n            ],\n            'input' => [\n                [\n                    'type' => 'text',\n                    'label' => $this->trans('Name', [], 'Admin.Global'),\n                    'name' => 'name',\n                    'lang' => true,\n                    'required' => true,\n                    'col' => '4',\n                    'hint' => $this->trans('Your internal name for this attribute.', [], 'Admin.Catalog.Help') . '&nbsp;' . $this->trans('Invalid characters:', [], 'Admin.Notifications.Info') . ' <>;=#{}',\n                ],\n                [\n                    'type' => 'text',\n                    'label' => $this->trans('Public name', [], 'Admin.Catalog.Feature'),\n                    'name' => 'public_name',\n                    'lang' => true,\n                    'required' => true,\n                    'col' => '4',\n                    'hint' => $this->trans('The public name for this attribute, displayed to the customers.', [], 'Admin.Catalog.Help') . '&nbsp;' . $this->trans('Invalid characters:', [], 'Admin.Notifications.Info') . ' <>;=#{}',\n                ],\n                [\n                    'type' => 'select',\n                    'label' => $this->trans('Attribute type', [], 'Admin.Catalog.Feature'),\n                    'name' => 'group_type',\n                    'required' => true,\n                    'options' => [\n                        'query' => $group_type,\n                        'id' => 'id',\n                        'name' => 'name',\n                    ],\n                    'col' => '2',\n                    'hint' => $this->trans('The way the attribute\\'s values will be presented to the customers in the product\\'s page.', [], 'Admin.Catalog.Help'),\n                ],\n            ],\n        ];\n\n        if (Shop::isFeatureActive()) {\n            $this->fields_form['input'][] = [\n                'type' => 'shop',\n                'label' => $this->trans('Shop association', [], 'Admin.Global'),\n                'name' => 'checkBoxShopAsso',\n            ];\n        }\n\n        $this->fields_form['submit'] = [\n            'title' => $this->trans('Save', [], 'Admin.Actions'),\n        ];\n\n        if (!($obj = $this->loadObject(true))) {\n            return;\n        }\n\n        return parent::renderForm();\n    }\n\n    public function renderFormAttributes()\n    {\n        $attributes_groups = AttributeGroup::getAttributesGroups($this->context->language->id);\n\n        $this->table = 'attribute';\n        $this->identifier = 'id_attribute';\n\n        $this->show_form_cancel_button = true;\n        $this->fields_form = [\n            'legend' => [\n                'title' => $this->trans('Values', [], 'Admin.Global'),\n                'icon' => 'icon-info-sign',\n            ],\n            'input' => [\n                [\n                    'type' => 'select',\n                    'label' => $this->trans('Attribute group', [], 'Admin.Catalog.Feature'),\n                    'name' => 'id_attribute_group',\n                    'required' => true,\n                    'options' => [\n                        'query' => $attributes_groups,\n                        'id' => 'id_attribute_group',\n                        'name' => 'name',\n                    ],\n                    'hint' => $this->trans('Choose the attribute group for this value.', [], 'Admin.Catalog.Help'),\n                ],\n                [\n                    'type' => 'text',\n                    'label' => $this->trans('Value', [], 'Admin.Global'),\n                    'name' => 'name',\n                    'lang' => true,\n                    'required' => true,\n                    'hint' => $this->trans('Invalid characters:', [], 'Admin.Notifications.Info') . ' <>;=#{}',\n                ],\n            ],\n        ];\n\n        if (Shop::isFeatureActive()) {\n            // We get all associated shops for all attribute groups, because we will disable group shops\n            // for attributes that the selected attribute group don't support\n            $sql = 'SELECT id_attribute_group, id_shop FROM ' . _DB_PREFIX_ . 'attribute_group_shop';\n            $associations = [];\n            foreach (Db::getInstance()->executeS($sql) as $row) {\n                $associations[$row['id_attribute_group']][] = $row['id_shop'];\n            }\n\n            $this->fields_form['input'][] = [\n                'type' => 'shop',\n                'label' => $this->trans('Shop association', [], 'Admin.Global'),\n                'name' => 'checkBoxShopAsso',\n                'values' => Shop::getTree(),\n            ];\n        } else {\n            $associations = [];\n        }\n\n        $this->fields_form['shop_associations'] = json_encode($associations);\n\n        $this->fields_form['input'][] = [\n            'type' => 'color',\n            'label' => $this->trans('Color', [], 'Admin.Catalog.Feature'),\n            'name' => 'color',\n            'hint' => $this->trans('Choose a color with the color picker, or enter an HTML color (e.g. \"lightblue\", \"#CC6600\").', [], 'Admin.Catalog.Help'),\n        ];\n\n        $this->fields_form['input'][] = [\n            'type' => 'file',\n            'label' => $this->trans('Texture', [], 'Admin.Catalog.Feature'),\n            'name' => 'texture',\n            'hint' => [\n                $this->trans('Upload an image file containing the color texture from your computer.', [], 'Admin.Catalog.Help'),\n                $this->trans('This will override the HTML color!', [], 'Admin.Catalog.Help'),\n            ],\n        ];\n\n        $this->fields_form['input'][] = [\n            'type' => 'current_texture',\n            'label' => $this->trans('Current texture', [], 'Admin.Catalog.Feature'),\n            'name' => 'current_texture',\n        ];\n\n        $this->fields_form['input'][] = [\n            'type' => 'closediv',\n            'name' => '',\n        ];\n\n        $this->fields_form['submit'] = [\n            'title' => $this->trans('Save', [], 'Admin.Actions'),\n        ];\n\n        $this->fields_form['buttons'] = [\n            'save-and-stay' => [\n                'title' => $this->trans('Save then add another value', [], 'Admin.Catalog.Feature'),\n                'name' => 'submitAdd' . $this->table . 'AndStay',\n                'type' => 'submit',\n                'class' => 'btn btn-default pull-right',\n                'icon' => 'process-icon-save',\n            ],\n        ];\n\n        $this->fields_value['id_attribute_group'] = (int) Tools::getValue('id_attribute_group');\n\n        // Override var of Controller\n        $this->table = 'attribute';\n        $this->className = 'Attribute';\n        $this->identifier = 'id_attribute';\n        $this->lang = true;\n        $this->tpl_folder = 'attributes/';\n\n        // Create object Attribute\n        if (!$obj = new Attribute((int) Tools::getValue($this->identifier))) {\n            return;\n        }\n\n        $str_attributes_groups = '';\n        foreach ($attributes_groups as $attribute_group) {\n            $str_attributes_groups .= '\"' . $attribute_group['id_attribute_group'] . '\" : ' . ($attribute_group['group_type'] == 'color' ? '1' : '0') . ', ';\n        }\n\n        $image = '../img/' . $this->fieldImageSettings['dir'] . '/' . (int) $obj->id . '.jpg';\n\n        $this->tpl_form_vars = [\n            'strAttributesGroups' => $str_attributes_groups,\n            'colorAttributeProperties' => Validate::isLoadedObject($obj) && $obj->isColorAttribute(),\n            'imageTextureExists' => file_exists(_PS_IMG_DIR_ . $this->fieldImageSettings['dir'] . '/' . (int) $obj->id . '.jpg'),\n            'imageTexture' => $image,\n            'imageTextureUrl' => Tools::safeOutput($_SERVER['REQUEST_URI']) . '&deleteImage=1',\n        ];\n\n        return parent::renderForm();\n    }\n\n    /**\n     * AdminController::init() override.\n     *\n     * @see AdminController::init()\n     */\n    public function init()\n    {\n        if (Tools::isSubmit('updateattribute')) {\n            $this->display = 'editAttributes';\n        } elseif (Tools::isSubmit('submitAddattribute')) {\n            $this->display = 'editAttributes';\n        } elseif (Tools::isSubmit('submitAddattribute_group')) {\n            $this->display = 'add';\n        }\n\n        parent::init();\n    }\n\n    /**\n     * Override processAdd to change SaveAndStay button action.\n     *\n     * @see classes/AdminControllerCore::processUpdate()\n     */\n    public function processAdd()\n    {\n        if ($this->table == 'attribute') {\n            /** @var AttributeGroup $object */\n            $object = new $this->className();\n            foreach (Language::getLanguages(false) as $language) {\n                if ($object->isAttribute(\n                    (int) Tools::getValue('id_attribute_group'),\n                    Tools::getValue('name_' . $language['id_lang']),\n                    $language['id_lang']\n                )) {\n                    $this->errors['name_' . $language['id_lang']] = $this->trans(\n                        'The attribute value \"%1$s\" already exist for %2$s language',\n                        [\n                            Tools::getValue('name_' . $language['id_lang']),\n                            $language['name'],\n                        ],\n                        'Admin.Catalog.Notification'\n                    );\n                }\n            }\n\n            if (!empty($this->errors)) {\n                return $object;\n            }\n        }\n\n        $object = parent::processAdd();\n\n        if (Tools::isSubmit('submitAdd' . $this->table . 'AndStay') && !count($this->errors)) {\n            if ($this->display == 'add') {\n                $this->redirect_after = self::$currentIndex . '&' . $this->identifier . '=&conf=3&update' . $this->table . '&token=' . $this->token;\n            } else {\n                $this->redirect_after = self::$currentIndex . '&id_attribute_group=' . (int) Tools::getValue('id_attribute_group') . '&conf=3&update' . $this->table . '&token=' . $this->token;\n            }\n        }\n\n        if (count($this->errors)) {\n            $this->setTypeAttribute();\n        }\n\n        return $object;\n    }\n\n    /**\n     * Override processUpdate to change SaveAndStay button action.\n     *\n     * @see classes/AdminControllerCore::processUpdate()\n     */\n    public function processUpdate()\n    {\n        $object = parent::processUpdate();\n\n        if (Tools::isSubmit('submitAdd' . $this->table . 'AndStay') && !count($this->errors)) {\n            if ($this->display == 'add') {\n                $this->redirect_after = self::$currentIndex . '&' . $this->identifier . '=&conf=3&update' . $this->table . '&token=' . $this->token;\n            } else {\n                $this->redirect_after = self::$currentIndex . '&' . $this->identifier . '=&id_attribute_group=' . (int) Tools::getValue('id_attribute_group') . '&conf=3&update' . $this->table . '&token=' . $this->token;\n            }\n        }\n\n        if (count($this->errors)) {\n            $this->setTypeAttribute();\n        }\n\n        if (Tools::isSubmit('updateattribute') || Tools::isSubmit('deleteattribute') || Tools::isSubmit('submitAddattribute') || Tools::isSubmit('submitBulkdeleteattribute')) {\n            Tools::clearColorListCache();\n        }\n\n        return $object;\n    }\n\n    /**\n     * AdminController::initContent() override.\n     *\n     * @see AdminController::initContent()\n     */\n    public function initContent()\n    {\n        if (Combination::isFeatureActive()) {\n            if ($this->display == 'edit' || $this->display == 'add') {\n                if (!($this->object = $this->loadObject(true))) {\n                    return;\n                }\n                $this->content .= $this->renderForm();\n            } elseif ($this->display == 'editAttributes') {\n                if (!$this->object = new Attribute((int) Tools::getValue('id_attribute'))) {\n                    return;\n                }\n\n                $this->content .= $this->renderFormAttributes();\n            } elseif ($this->display != 'view' && !$this->ajax) {\n                $this->content .= $this->renderList();\n                $this->content .= $this->renderOptions();\n                /* reset all attributes filter */\n                if (!Tools::getValue('submitFilterattribute_group', 0) && !Tools::getIsset('id_attribute_group')) {\n                    $this->processResetFilters('attribute_values');\n                }\n            } elseif ($this->display == 'view' && !$this->ajax) {\n                $this->content = $this->renderView();\n            }\n        } else {\n            $adminPerformanceUrl = $this->context->link->getAdminLink('AdminPerformance');\n            $url = '<a href=\"' . $adminPerformanceUrl . '#featuresDetachables\">' . $this->trans('Performance', [], 'Admin.Global') . '</a>';\n            $this->displayWarning($this->trans('This feature has been disabled. You can activate it here: %link%.', ['%link%' => $url], 'Admin.Catalog.Notification'));\n        }\n\n        $this->context->smarty->assign([\n            'table' => $this->table,\n            'current' => self::$currentIndex,\n            'token' => $this->token,\n            'content' => $this->content,\n        ]);\n    }\n\n    public function initPageHeaderToolbar()\n    {\n        if (Combination::isFeatureActive()) {\n            if (empty($this->display)) {\n                $this->page_header_toolbar_btn['new_attribute_group'] = [\n                    'href' => self::$currentIndex . '&addattribute_group&token=' . $this->token,\n                    'desc' => $this->trans('Add new attribute', [], 'Admin.Catalog.Feature'),\n                    'icon' => 'process-icon-new',\n                ];\n                $this->page_header_toolbar_btn['new_value'] = [\n                    'href' => self::$currentIndex . '&updateattribute&id_attribute_group=' . (int) Tools::getValue('id_attribute_group') . '&token=' . $this->token,\n                    'desc' => $this->trans('Add new value', [], 'Admin.Catalog.Feature'),\n                    'icon' => 'process-icon-new',\n                ];\n            }\n        }\n\n        if ($this->display == 'view') {\n            $this->page_header_toolbar_btn['new_value'] = [\n                'href' => self::$currentIndex . '&updateattribute&id_attribute_group=' . (int) Tools::getValue('id_attribute_group') . '&token=' . $this->token,\n                'desc' => $this->trans('Add new value', [], 'Admin.Catalog.Feature'),\n                'icon' => 'process-icon-new',\n            ];\n        }\n\n        parent::initPageHeaderToolbar();\n    }\n\n    public function initToolbar()\n    {\n        switch ($this->display) {\n            // @todo defining default buttons\n            case 'add':\n            case 'edit':\n            case 'editAttributes':\n                // Default save button - action dynamically handled in javascript\n                $this->toolbar_btn['save'] = [\n                    'href' => '#',\n                    'desc' => $this->trans('Save', [], 'Admin.Actions'),\n                ];\n\n                if ($this->display == 'editAttributes' && !$this->id_attribute) {\n                    $this->toolbar_btn['save-and-stay'] = [\n                        'short' => 'SaveAndStay',\n                        'href' => '#',\n                        'desc' => $this->trans('Save then add another value', [], 'Admin.Catalog.Help'),\n                        'force_desc' => true,\n                    ];\n                }\n\n                $this->toolbar_btn['back'] = [\n                    'href' => $this->context->link->getAdminLink('AdminAttributesGroups'),\n                    'desc' => $this->trans('Back to list', [], 'Admin.Actions'),\n                ];\n\n                break;\n            case 'view':\n                $this->toolbar_btn['newAttributes'] = [\n                    'href' => $this->context->link->getAdminLink('AdminAttributesGroups', true, [], ['updateattribute' => 1, 'id_attribute_group' => (int) Tools::getValue('id_attribute_group')]),\n                    'desc' => $this->trans('Add New Values', [], 'Admin.Catalog.Feature'),\n                    'class' => 'toolbar-new',\n                ];\n\n                $this->toolbar_btn['back'] = [\n                    'href' => $this->context->link->getAdminLink('AdminAttributesGroups'),\n                    'desc' => $this->trans('Back to list', [], 'Admin.Actions'),\n                ];\n\n                break;\n            default: // list\n                $this->toolbar_btn['new'] = [\n                    'href' => $this->context->link->getAdminLink('AdminAttributesGroups', true, [], ['add' . $this->table => 1]),\n                    'desc' => $this->trans('Add New Attributes', [], 'Admin.Catalog.Feature'),\n                ];\n                if ($this->can_import) {\n                    $this->toolbar_btn['import'] = [\n                        'href' => $this->context->link->getAdminLink('AdminImport', true, [], ['import_type' => 'combinations']),\n                        'desc' => $this->trans('Import', [], 'Admin.Actions'),\n                    ];\n                }\n        }\n    }\n\n    public function initToolbarTitle()\n    {\n        $bread_extended = $this->breadcrumbs;\n\n        switch ($this->display) {\n            case 'edit':\n                $bread_extended[] = $this->trans('Edit New Attribute', [], 'Admin.Catalog.Feature');\n\n                break;\n\n            case 'add':\n                $bread_extended[] = $this->trans('Add New Attribute', [], 'Admin.Catalog.Feature');\n\n                break;\n\n            case 'view':\n                if (Tools::getIsset('viewattribute_group')) {\n                    if (($id = (int) Tools::getValue('id_attribute_group'))) {\n                        if (Validate::isLoadedObject($obj = new AttributeGroup((int) $id))) {\n                            $bread_extended[] = $obj->name[$this->context->employee->id_lang];\n                        }\n                    }\n                } else {\n                    $bread_extended[] = $this->attribute_name[$this->context->employee->id_lang];\n                }\n\n                break;\n\n            case 'editAttributes':\n                if ($this->id_attribute) {\n                    if (($id = (int) Tools::getValue('id_attribute_group'))) {\n                        if (Validate::isLoadedObject($obj = new AttributeGroup((int) $id))) {\n                            $bread_extended[] = '<a href=\"' . Context::getContext()->link->getAdminLink('AdminAttributesGroups') . '&id_attribute_group=' . $id . '&viewattribute_group\">' . $obj->name[$this->context->employee->id_lang] . '</a>';\n                        }\n                        if (Validate::isLoadedObject($obj = new Attribute((int) $this->id_attribute))) {\n                            $bread_extended[] = $this->trans(\n                                'Edit: %value%',\n                                [\n                                    '%value%' => $obj->name[$this->context->employee->id_lang],\n                                ],\n                                'Admin.Catalog.Feature'\n                            );\n                        }\n                    } else {\n                        $bread_extended[] = $this->trans('Edit Value', [], 'Admin.Catalog.Feature');\n                    }\n                } else {\n                    $bread_extended[] = $this->trans('Add New Value', [], 'Admin.Catalog.Feature');\n                }\n\n                break;\n        }\n\n        if (count($bread_extended) > 0) {\n            $this->addMetaTitle($bread_extended[count($bread_extended) - 1]);\n        }\n\n        $this->toolbar_title = $bread_extended;\n    }\n\n    public function initProcess()\n    {\n        $this->setTypeAttribute();\n\n        if (Tools::getIsset('viewattribute_group')) {\n            $this->list_id = 'attribute_values';\n\n            if (isset($_POST['submitReset' . $this->list_id])) {\n                $this->processResetFilters();\n            }\n        } else {\n            $this->list_id = 'attribute_group';\n        }\n\n        parent::initProcess();\n\n        if ($this->table == 'attribute') {\n            $this->display = 'editAttributes';\n            $this->id_attribute = (int) Tools::getValue('id_attribute');\n        }\n    }\n\n    protected function setTypeAttribute()\n    {\n        if (Tools::isSubmit('updateattribute') || Tools::isSubmit('deleteattribute') || Tools::isSubmit('submitAddattribute') || Tools::isSubmit('submitBulkdeleteattribute')) {\n            $this->table = 'attribute';\n            $this->className = 'Attribute';\n            $this->identifier = 'id_attribute';\n\n            if ($this->display == 'edit') {\n                $this->display = 'editAttributes';\n            }\n        }\n    }\n\n    public function processPosition()\n    {\n        if (Tools::getIsset('viewattribute_group')) {\n            $object = new Attribute((int) Tools::getValue('id_attribute'));\n            self::$currentIndex = self::$currentIndex . '&viewattribute_group';\n        } else {\n            $object = new AttributeGroup((int) Tools::getValue('id_attribute_group'));\n        }\n\n        if (!Validate::isLoadedObject($object)) {\n            $this->errors[] = $this->trans('An error occurred while updating the status for an object.', [], 'Admin.Notifications.Error') .\n                ' <b>' . $this->table . '</b> ' . $this->trans('(cannot load object)', [], 'Admin.Notifications.Error');\n        } elseif (!$object->updatePosition((int) Tools::getValue('way'), (int) Tools::getValue('position'))) {\n            $this->errors[] = $this->trans('Failed to update the position.', [], 'Admin.Notifications.Error');\n        } else {\n            $id_identifier_str = ($id_identifier = (int) Tools::getValue($this->identifier)) ? '&' . $this->identifier . '=' . $id_identifier : '';\n            $redirect = self::$currentIndex . '&' . $this->table . 'Orderby=position&' . $this->table . 'Orderway=asc&conf=5' . $id_identifier_str . '&token=' . $this->token;\n            $this->redirect_after = $redirect;\n        }\n\n        return $object;\n    }\n\n    /**\n     * Call the right method for creating or updating object.\n     *\n     * @return mixed\n     */\n    public function processSave()\n    {\n        if ($this->display == 'add' || $this->display == 'edit') {\n            $this->identifier = 'id_attribute_group';\n        }\n\n        if (!$this->id_object) {\n            return $this->processAdd();\n        } else {\n            return $this->processUpdate();\n        }\n    }\n\n    public function postProcess()\n    {\n        if (!Combination::isFeatureActive()) {\n            return;\n        }\n\n        if (!Tools::getValue($this->identifier) && (int) Tools::getValue('id_attribute') && !Tools::getValue('attributeOrderby')) {\n            // Override var of Controller\n            $this->table = 'attribute';\n            $this->className = 'Attribute';\n            $this->identifier = 'id_attribute';\n        }\n\n        /* set location with current index */\n        if (Tools::getIsset('id_attribute_group') && Tools::getIsset('viewattribute_group')) {\n            self::$currentIndex = self::$currentIndex . '&id_attribute_group=' . (int) Tools::getValue('id_attribute_group', 0) . '&viewattribute_group';\n        }\n\n        // If it's an attribute, load object Attribute()\n        if (Tools::getValue('updateattribute') || Tools::isSubmit('deleteattribute') || Tools::isSubmit('submitAddattribute')) {\n            if (true !== $this->access('edit')) {\n                $this->errors[] = $this->trans('You do not have permission to edit this.', [], 'Admin.Notifications.Error');\n\n                return;\n            } elseif (!$object = new Attribute((int) Tools::getValue($this->identifier))) {\n                $this->errors[] = $this->trans('An error occurred while updating the status for an object.', [], 'Admin.Notifications.Error') .\n                    ' <b>' . $this->table . '</b> ' .\n                    $this->trans('(cannot load object)', [], 'Admin.Notifications.Error');\n\n                return;\n            }\n\n            if (Tools::getValue('position') !== false && Tools::getValue('id_attribute')) {\n                $_POST['id_attribute_group'] = $object->id_attribute_group;\n                if (!$object->updatePosition((int) Tools::getValue('way'), (int) Tools::getValue('position'))) {\n                    $this->errors[] = $this->trans('Failed to update the position.', [], 'Admin.Notifications.Error');\n                } else {\n                    Tools::redirectAdmin(self::$currentIndex . '&conf=5&token=' . Tools::getAdminTokenLite('AdminAttributesGroups') . '#details_details_' . $object->id_attribute_group);\n                }\n            } elseif (Tools::isSubmit('deleteattribute') && Tools::getValue('id_attribute')) {\n                if (!$object->delete()) {\n                    $this->errors[] = $this->trans('Failed to delete the attribute.', [], 'Admin.Catalog.Notification');\n                } else {\n                    Tools::redirectAdmin(self::$currentIndex . '&conf=1&token=' . Tools::getAdminTokenLite('AdminAttributesGroups'));\n                }\n            } elseif (Tools::isSubmit('submitAddattribute')) {\n                Hook::exec('actionObjectAttributeAddBefore');\n                $this->action = 'save';\n                $id_attribute = (int) Tools::getValue('id_attribute');\n                // Adding last position to the attribute if not exist\n                if ($id_attribute <= 0) {\n                    $sql = 'SELECT `position`+1\n\t\t\t\t\t\t\tFROM `' . _DB_PREFIX_ . 'attribute`\n\t\t\t\t\t\t\tWHERE `id_attribute_group` = ' . (int) Tools::getValue('id_attribute_group') . '\n\t\t\t\t\t\t\tORDER BY position DESC';\n                    // set the position of the new group attribute in $_POST for postProcess() method\n                    $_POST['position'] = Db::getInstance(_PS_USE_SQL_SLAVE_)->getValue($sql);\n                }\n                $_POST['id_parent'] = 0;\n                $this->processSave($this->token);\n            }\n        } else {\n            if (Tools::isSubmit('submitBulkdelete' . $this->table)) {\n                if ($this->access('delete')) {\n                    if (isset($_POST[$this->list_id . 'Box'])) {\n                        /** @var AttributeGroup $object */\n                        $object = new $this->className();\n                        if ($object->deleteSelection($_POST[$this->list_id . 'Box'])) {\n                            AttributeGroup::cleanPositions();\n                            Tools::redirectAdmin(self::$currentIndex . '&conf=2' . '&token=' . $this->token);\n                        }\n                        $this->errors[] = $this->trans('An error occurred while deleting this selection.', [], 'Admin.Notifications.Error');\n                    } else {\n                        $this->errors[] = $this->trans('You must select at least one element to delete.', [], 'Admin.Notifications.Error');\n                    }\n                } else {\n                    $this->errors[] = $this->trans('You do not have permission to delete this.', [], 'Admin.Notifications.Error');\n                }\n                // clean position after delete\n                AttributeGroup::cleanPositions();\n            } elseif (Tools::isSubmit('submitAdd' . $this->table)) {\n                Hook::exec('actionObjectAttributeGroupAddBefore');\n                $id_attribute_group = (int) Tools::getValue('id_attribute_group');\n                // Adding last position to the attribute if not exist\n                if ($id_attribute_group <= 0) {\n                    $sql = 'SELECT `position`+1\n\t\t\t\t\t\t\tFROM `' . _DB_PREFIX_ . 'attribute_group`\n\t\t\t\t\t\t\tORDER BY position DESC';\n                    // set the position of the new group attribute in $_POST for postProcess() method\n                    $_POST['position'] = Db::getInstance(_PS_USE_SQL_SLAVE_)->getValue($sql);\n                }\n                // clean \\n\\r characters\n                foreach ($_POST as $key => $value) {\n                    if (preg_match('/^name_/Ui', $key)) {\n                        $_POST[$key] = str_replace('\\n', '', str_replace('\\r', '', $value));\n                    }\n                }\n                parent::postProcess();\n            } else {\n                parent::postProcess();\n                if (Tools::isSubmit('delete' . $this->table)) {\n                    AttributeGroup::cleanPositions();\n                }\n            }\n        }\n    }\n\n    /**\n     * AdminController::getList() override.\n     *\n     * @see AdminController::getList()\n     *\n     * @param int $id_lang\n     * @param string|null $order_by\n     * @param string|null $order_way\n     * @param int $start\n     * @param int|null $limit\n     * @param int|bool $id_lang_shop\n     *\n     * @throws PrestaShopException\n     */\n    public function getList($id_lang, $order_by = null, $order_way = null, $start = 0, $limit = null, $id_lang_shop = false)\n    {\n        parent::getList($id_lang, $order_by, $order_way, $start, $limit, $id_lang_shop);\n\n        if ($this->display == 'view') {\n            foreach ($this->_list as &$list) {\n                if (file_exists(_PS_IMG_DIR_ . $this->fieldImageSettings['dir'] . '/' . (int) $list['id_attribute'] . '.jpg')) {\n                    if (!isset($list['color']) || !is_array($list['color'])) {\n                        $list['color'] = [];\n                    }\n                    $list['color']['texture'] = '../img/' . $this->fieldImageSettings['dir'] . '/' . (int) $list['id_attribute'] . '.jpg';\n                }\n            }\n        } else {\n            $nb_items = count($this->_list);\n            for ($i = 0; $i < $nb_items; ++$i) {\n                $item = &$this->_list[$i];\n\n                $query = new DbQuery();\n                $query->select('COUNT(a.id_attribute) as count_values');\n                $query->from('attribute', 'a');\n                $query->join(Shop::addSqlAssociation('attribute', 'a'));\n                $query->where('a.id_attribute_group =' . (int) $item['id_attribute_group']);\n                $query->groupBy('attribute_shop.id_shop');\n                $query->orderBy('count_values DESC');\n                $item['count_values'] = (int) Db::getInstance(_PS_USE_SQL_SLAVE_)->getValue($query);\n                unset($query);\n            }\n        }\n    }\n\n    /**\n     * Overrides parent to delete items from sublist.\n     *\n     * @return mixed\n     */\n    public function processBulkDelete()\n    {\n        // If we are deleting attributes instead of attribute_groups\n        if (Tools::getIsset('attributeBox')) {\n            $this->className = 'Attribute';\n            $this->table = 'attribute';\n            $this->boxes = Tools::getValue($this->table . 'Box');\n        }\n\n        $result = parent::processBulkDelete();\n        // Restore vars\n        $this->className = 'AttributeGroup';\n        $this->table = 'attribute_group';\n\n        return $result;\n    }\n\n    /* Modify group attribute position */\n    public function ajaxProcessUpdateGroupsPositions()\n    {\n        $way = (int) Tools::getValue('way');\n        $id_attribute_group = (int) Tools::getValue('id_attribute_group');\n        $positions = Tools::getValue('attribute_group');\n\n        $new_positions = [];\n        foreach ($positions as $v) {\n            if (count(explode('_', $v)) == 4) {\n                $new_positions[] = $v;\n            }\n        }\n\n        foreach ($new_positions as $position => $value) {\n            $pos = explode('_', $value);\n\n            if (isset($pos[2]) && (int) $pos[2] === $id_attribute_group) {\n                if ($group_attribute = new AttributeGroup((int) $pos[2])) {\n                    if (isset($position) && $group_attribute->updatePosition($way, $position)) {\n                        echo 'ok position ' . (int) $position . ' for attribute group ' . (int) $pos[2] . '\\r\\n';\n                    } else {\n                        echo '{\"hasError\" : true, \"errors\" : \"Can not update the ' . (int) $id_attribute_group . ' attribute group to position ' . (int) $position . ' \"}';\n                    }\n                } else {\n                    echo '{\"hasError\" : true, \"errors\" : \"The (' . (int) $id_attribute_group . ') attribute group cannot be loaded.\"}';\n                }\n\n                break;\n            }\n        }\n    }\n\n    /* Modify attribute position */\n    public function ajaxProcessUpdateAttributesPositions()\n    {\n        $way = (int) Tools::getValue('way');\n        $id_attribute = (int) Tools::getValue('id_attribute');\n        $id_attribute_group = (int) Tools::getValue('id_attribute_group');\n        $positions = Tools::getValue('attribute');\n\n        if (is_array($positions)) {\n            foreach ($positions as $position => $value) {\n                $pos = explode('_', $value);\n\n                if ((isset($pos[1], $pos[2])) && (int) $pos[2] === $id_attribute) {\n                    if ($attribute = new Attribute((int) $pos[2])) {\n                        if (isset($position) && $attribute->updatePosition($way, $position)) {\n                            echo 'ok position ' . (int) $position . ' for attribute ' . (int) $pos[2] . '\\r\\n';\n                        } else {\n                            echo '{\"hasError\" : true, \"errors\" : \"Can not update the ' . (int) $id_attribute . ' attribute to position ' . (int) $position . ' \"}';\n                        }\n                    } else {\n                        echo '{\"hasError\" : true, \"errors\" : \"The (' . (int) $id_attribute . ') attribute cannot be loaded\"}';\n                    }\n\n                    break;\n                }\n            }\n        }\n    }\n}\n"], "filenames": ["classes/controller/AdminController.php", "classes/helper/HelperList.php", "controllers/admin/AdminAttributesGroupsController.php"], "buggy_code_start_loc": [1012, 235, 104], "buggy_code_end_loc": [1013, 236, 755], "fixing_code_start_loc": [1012, 235, 104], "fixing_code_end_loc": [1013, 236, 755], "type": "CWE-79", "message": "In PrestaShop between versions 1.7.6.1 and 1.7.6.5, there is a reflected XSS on AdminAttributesGroups page. The problem is patched in 1.7.6.5.", "other": {"cve": {"id": "CVE-2020-5265", "sourceIdentifier": "security-advisories@github.com", "published": "2020-04-20T17:15:15.350", "lastModified": "2020-04-23T19:10:31.340", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In PrestaShop between versions 1.7.6.1 and 1.7.6.5, there is a reflected XSS on AdminAttributesGroups page. The problem is patched in 1.7.6.5."}, {"lang": "es", "value": "En PrestaShop entre las versiones 1.7.6.1 y 1.7.6.5, hay  una vulnerabilidad de tipo XSS reflejado en la p\u00e1gina AdminAttributesGroups. El problema est\u00e1 corregido  en la versi\u00f3n 1.7.6.5."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:H/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "HIGH", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 4.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 1.3, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}, {"source": "security-advisories@github.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:prestashop:prestashop:*:*:*:*:*:*:*:*", "versionStartExcluding": "1.7.6.1", "versionEndExcluding": "1.7.6.5", "matchCriteriaId": "11E90591-68C5-457C-97CE-88B3EA9146A2"}]}]}], "references": [{"url": "https://github.com/PrestaShop/PrestaShop/commit/622ba66ffdbf48b399875003e00bc34d8a3ef712", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/PrestaShop/PrestaShop/security/advisories/GHSA-7fmr-5vcc-329j", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/PrestaShop/PrestaShop/commit/622ba66ffdbf48b399875003e00bc34d8a3ef712"}}