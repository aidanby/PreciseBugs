{"buggy_code": ["<?php\n$extendedFromHtml = '';\nif (!empty($cluster['GalaxyCluster']['extended_from'])) {\n    $element = $this->element('genericElements/IndexTable/Fields/links', array(\n        'url' => $baseurl . '/galaxy_clusters/view/',\n        'row' => $cluster,\n        'field' => array(\n            'data_path' => 'GalaxyCluster.extended_from.GalaxyCluster.id',\n            'title' => sprintf(__('%s (version: %s)'), $cluster['GalaxyCluster']['extended_from']['GalaxyCluster']['value'], $cluster['GalaxyCluster']['extends_version'])\n        ),\n    ));\n    $extendedFromHtml = sprintf('<ul><li>%s</li></ul>', $element);\n}\nif ($newVersionAvailable) {\n    $extendedFromHtml .= sprintf('<div class=\"alert alert-warning\">%s</div>', sprintf(__('New version available! <a href=\"%s\">Update cluster to version <b>%s</b></a>'),\n        '/galaxy_clusters/updateCluster/' . $cluster['GalaxyCluster']['id'],\n        h($cluster['GalaxyCluster']['extended_from']['GalaxyCluster']['version'])\n    ));\n}\n\n$extendedByHtml = '';\n$extendByLinks = array();\nforeach ($cluster['GalaxyCluster']['extended_by'] as $extendCluster) {\n    $element = $this->element('genericElements/IndexTable/Fields/links', array(\n        'url' => '/galaxy_clusters/view/',\n        'row' => $extendCluster,\n        'field' => array(\n            'data_path' => 'GalaxyCluster.id',\n            'title' => sprintf(__('%s (parent version: %s)'), $extendCluster['GalaxyCluster']['value'], $extendCluster['GalaxyCluster']['extends_version'])\n        ),\n    ));\n    $extendByLinks[] = sprintf('<li>%s</li>', $element);\n}\nif (!empty($extendByLinks)) {\n    $extendedByHtml = sprintf('<ul>%s</ul>', implode('', $extendByLinks));\n}\n\n$description = $this->Markdown->cleanup($cluster['GalaxyCluster']['description']);\n\n$table_data = array();\n$table_data[] = array('key' => __('Cluster ID'), 'value' => $cluster['GalaxyCluster']['id']);\n$table_data[] = array('key' => __('Name'), 'value' => $cluster['GalaxyCluster']['value']);\n$table_data[] = array('key' => __('Parent Galaxy'), 'value' => $cluster['GalaxyCluster']['Galaxy']['name'] ? $cluster['GalaxyCluster']['Galaxy']['name'] : $cluster['GalaxyCluster']['Galaxy']['type']);\n$table_data[] = array('key' => __('Description'), 'value' => $description, 'value_class' => 'md');\nif (!$cluster['GalaxyCluster']['default']) {\n    $table_data[] = [\n        'key' => __('Published'),\n        'boolean' => $cluster['GalaxyCluster']['published'],\n        'class' => !$cluster['GalaxyCluster']['published'] ? 'background-red bold' : ''\n    ];\n}\n$table_data[] = array('key' => __('Default'), 'boolean' => $cluster['GalaxyCluster']['default'], 'class' => 'black');\n$table_data[] = array('key' => __('Version'), 'value' => $cluster['GalaxyCluster']['version']);\n$table_data[] = array('key' => __('UUID'), 'value' => $cluster['GalaxyCluster']['uuid'], 'value_class' => 'quickSelect');\n$table_data[] = array('key' => __('Collection UUID'), 'value' => $cluster['GalaxyCluster']['collection_uuid'], 'value_class' => 'quickSelect');\n$table_data[] = array(\n    'key' => __('Source'),\n    'html' => filter_var($cluster['GalaxyCluster']['source'], FILTER_VALIDATE_URL) ?\n        '<a href=\"' . $cluster['GalaxyCluster']['source'] . '\" rel=\"noreferrer noopener\">' . h($cluster['GalaxyCluster']['source']) :\n        h($cluster['GalaxyCluster']['source']),\n);\n$table_data[] = array('key' => __('Authors'), 'value' => !empty($cluster['GalaxyCluster']['authors']) ? implode(', ', $cluster['GalaxyCluster']['authors']) : __('N/A'));\n$table_data[] = array('key' => __('Distribution'), 'element' => 'genericElements/IndexTable/Fields/distribution_levels', 'element_params' => array(\n    'row' => $cluster['GalaxyCluster'],\n    'field' => array('data_path' => 'distribution')\n));\n$table_data[] = array(\n    'key' => __('Owner Organisation'),\n    'html' => $this->OrgImg->getOrgImg(array('name' => $cluster['GalaxyCluster']['Org']['name'], 'id' => $cluster['GalaxyCluster']['Org']['id'], 'size' => 18), true),\n);\n$table_data[] = array(\n    'key' => __('Creator Organisation'),\n    'html' => $this->OrgImg->getOrgImg(array('name' => $cluster['GalaxyCluster']['Orgc']['name'], 'id' => $cluster['GalaxyCluster']['Orgc']['id'], 'size' => 18), true),\n);\n$table_data[] = array('key' => __('Connector tag'), 'value' => $cluster['GalaxyCluster']['tag_name']);\n$table_data[] = array('key' => __('Events'), 'html' => isset($cluster['GalaxyCluster']['tag_count']) ?\n                    sprintf('<a href=\"%s\">%s</a>',\n                        sprintf('%s/events/index/searchtag:%s', $baseurl, h($cluster['GalaxyCluster']['tag_id'])),\n                        __n('%s event', '%s events', $cluster['GalaxyCluster']['tag_count'], h($cluster['GalaxyCluster']['tag_count']))\n                    ):\n                    '<span>0</span>'\n                );\nif (!empty($extendedFromHtml)) {\n    $table_data[] = array('key' => __('Forked From'), 'html' => $extendedFromHtml);\n}\nif (!empty($extendedByHtml)) {\n    $table_data[] = array('key' => __('Forked By'), 'html' => $extendedByHtml);\n}\n?>\n<div class='view'>\n    <div class=\"row-fluid\">\n        <div class=\"span8\">\n            <h2>\n                <?= sprintf('%s :: %s', h($cluster['GalaxyCluster']['Galaxy']['name']), h($cluster['GalaxyCluster']['value'])); ?>\n            </h2>\n            <?php echo $this->element('genericElements/viewMetaTable', array('table_data' => $table_data)); ?>\n        </div>\n    </div>\n    <div class=\"row-fuild\">\n        <div id=\"matrix_container\"></div>\n    </div>\n    <div class=\"row-fuild\">\n        <div id=\"relations_container\"></div>\n    </div>\n    <?php\n        if (!empty(Configure::read('Plugin.CyCat_enable'))) {\n            $titleHTML = __('CyCat Relationships');\n            $titleHTML .= sprintf('<a href=\"%s\" onclick=\"event.stopPropagation()\" title=\"%s\" target=\"_blank\"><img src=\"%s\" style=\"height: 2.5em\"/></a>',\n                'https://cycat.org/',\n                __('CyCAT or the CYbersecurity Resource CATalogue aims at mapping and documenting, in a single formalism and catalogue all the available cybersecurity tools, rules, playbooks, processes and controls.'),\n                $baseurl . '/img/CyCat.ico'\n            );\n            echo $this->element('/genericElements/accordion', [\n                'title' => 'CyCat Relationships',\n                'titleHTML' => $titleHTML,\n                'url' => '/galaxy_clusters/viewCyCatRelations/' . $cluster['GalaxyCluster']['id']\n            ]);\n        }\n    ?>\n    <div id=\"elements_content\"></div>\n</div>\n<?= $this->element('genericElements/assetLoader', array(\n    'js' => array(\n        'markdown-it',\n    ),\n));\n?>\n<script type=\"text/javascript\">\n$(function () {\n    $.get(\"<?= $baseurl ?>/galaxy_elements/index/<?php echo $cluster['GalaxyCluster']['id']; ?>\", function(data) {\n        $(\"#elements_content\").html(data);\n    });\n    $.get(\"<?= $baseurl ?>/galaxy_clusters/viewGalaxyMatrix/<?php echo $cluster['GalaxyCluster']['id']; ?>\", function(data) {\n        $(\"#matrix_container\").html(data);\n    });\n    $.get(\"<?= $baseurl ?>/galaxy_clusters/viewRelations/<?php echo $cluster['GalaxyCluster']['id']; ?>\", function(data) {\n        $(\"#relations_container\").html(data);\n    });\n});\n\nmd = window.markdownit('default');\nmd.disable(['image'])\nvar $md = $('.md');\n$md.html(md.render($md.text()));\n</script>\n<?= $this->element('/genericElements/SideMenu/side_menu', array('menuList' => 'galaxies', 'menuItem' => 'view_cluster'));\n"], "fixing_code": ["<?php\n$extendedFromHtml = '';\nif (!empty($cluster['GalaxyCluster']['extended_from'])) {\n    $element = $this->element('genericElements/IndexTable/Fields/links', array(\n        'url' => $baseurl . '/galaxy_clusters/view/',\n        'row' => $cluster,\n        'field' => array(\n            'data_path' => 'GalaxyCluster.extended_from.GalaxyCluster.id',\n            'title' => sprintf(__('%s (version: %s)'), $cluster['GalaxyCluster']['extended_from']['GalaxyCluster']['value'], $cluster['GalaxyCluster']['extends_version'])\n        ),\n    ));\n    $extendedFromHtml = sprintf('<ul><li>%s</li></ul>', $element);\n}\nif ($newVersionAvailable) {\n    $extendedFromHtml .= sprintf('<div class=\"alert alert-warning\">%s</div>', sprintf(__('New version available! <a href=\"%s\">Update cluster to version <b>%s</b></a>'),\n        '/galaxy_clusters/updateCluster/' . $cluster['GalaxyCluster']['id'],\n        h($cluster['GalaxyCluster']['extended_from']['GalaxyCluster']['version'])\n    ));\n}\n\n$extendedByHtml = '';\n$extendByLinks = array();\nforeach ($cluster['GalaxyCluster']['extended_by'] as $extendCluster) {\n    $element = $this->element('genericElements/IndexTable/Fields/links', array(\n        'url' => '/galaxy_clusters/view/',\n        'row' => $extendCluster,\n        'field' => array(\n            'data_path' => 'GalaxyCluster.id',\n            'title' => sprintf(__('%s (parent version: %s)'), $extendCluster['GalaxyCluster']['value'], $extendCluster['GalaxyCluster']['extends_version'])\n        ),\n    ));\n    $extendByLinks[] = sprintf('<li>%s</li>', $element);\n}\nif (!empty($extendByLinks)) {\n    $extendedByHtml = sprintf('<ul>%s</ul>', implode('', $extendByLinks));\n}\n\n$description = $this->Markdown->cleanup($cluster['GalaxyCluster']['description']);\n\n$table_data = array();\n$table_data[] = array('key' => __('Cluster ID'), 'value' => $cluster['GalaxyCluster']['id']);\n$table_data[] = array('key' => __('Name'), 'value' => $cluster['GalaxyCluster']['value']);\n$table_data[] = array('key' => __('Parent Galaxy'), 'value' => $cluster['GalaxyCluster']['Galaxy']['name'] ? $cluster['GalaxyCluster']['Galaxy']['name'] : $cluster['GalaxyCluster']['Galaxy']['type']);\n$table_data[] = array('key' => __('Description'), 'value' => $description, 'value_class' => 'md');\nif (!$cluster['GalaxyCluster']['default']) {\n    $table_data[] = [\n        'key' => __('Published'),\n        'boolean' => $cluster['GalaxyCluster']['published'],\n        'class' => !$cluster['GalaxyCluster']['published'] ? 'background-red bold' : ''\n    ];\n}\n$table_data[] = array('key' => __('Default'), 'boolean' => $cluster['GalaxyCluster']['default'], 'class' => 'black');\n$table_data[] = array('key' => __('Version'), 'value' => $cluster['GalaxyCluster']['version']);\n$table_data[] = array('key' => __('UUID'), 'value' => $cluster['GalaxyCluster']['uuid'], 'value_class' => 'quickSelect');\n$table_data[] = array('key' => __('Collection UUID'), 'value' => $cluster['GalaxyCluster']['collection_uuid'], 'value_class' => 'quickSelect');\n$table_data[] = array(\n    'key' => __('Source'),\n    'html' => filter_var($cluster['GalaxyCluster']['source'], FILTER_VALIDATE_URL) ?\n        '<a href=\"' . h($cluster['GalaxyCluster']['source']) . '\" rel=\"noreferrer noopener\">' . h($cluster['GalaxyCluster']['source']) :\n        h($cluster['GalaxyCluster']['source']),\n);\n$table_data[] = array('key' => __('Authors'), 'value' => !empty($cluster['GalaxyCluster']['authors']) ? implode(', ', $cluster['GalaxyCluster']['authors']) : __('N/A'));\n$table_data[] = array('key' => __('Distribution'), 'element' => 'genericElements/IndexTable/Fields/distribution_levels', 'element_params' => array(\n    'row' => $cluster['GalaxyCluster'],\n    'field' => array('data_path' => 'distribution')\n));\n$table_data[] = array(\n    'key' => __('Owner Organisation'),\n    'html' => $this->OrgImg->getOrgImg(array('name' => $cluster['GalaxyCluster']['Org']['name'], 'id' => $cluster['GalaxyCluster']['Org']['id'], 'size' => 18), true),\n);\n$table_data[] = array(\n    'key' => __('Creator Organisation'),\n    'html' => $this->OrgImg->getOrgImg(array('name' => $cluster['GalaxyCluster']['Orgc']['name'], 'id' => $cluster['GalaxyCluster']['Orgc']['id'], 'size' => 18), true),\n);\n$table_data[] = array('key' => __('Connector tag'), 'value' => $cluster['GalaxyCluster']['tag_name']);\n$table_data[] = array('key' => __('Events'), 'html' => isset($cluster['GalaxyCluster']['tag_count']) ?\n                    sprintf('<a href=\"%s\">%s</a>',\n                        sprintf('%s/events/index/searchtag:%s', $baseurl, h($cluster['GalaxyCluster']['tag_id'])),\n                        __n('%s event', '%s events', $cluster['GalaxyCluster']['tag_count'], h($cluster['GalaxyCluster']['tag_count']))\n                    ):\n                    '<span>0</span>'\n                );\nif (!empty($extendedFromHtml)) {\n    $table_data[] = array('key' => __('Forked From'), 'html' => $extendedFromHtml);\n}\nif (!empty($extendedByHtml)) {\n    $table_data[] = array('key' => __('Forked By'), 'html' => $extendedByHtml);\n}\n?>\n<div class='view'>\n    <div class=\"row-fluid\">\n        <div class=\"span8\">\n            <h2>\n                <?= sprintf('%s :: %s', h($cluster['GalaxyCluster']['Galaxy']['name']), h($cluster['GalaxyCluster']['value'])); ?>\n            </h2>\n            <?php echo $this->element('genericElements/viewMetaTable', array('table_data' => $table_data)); ?>\n        </div>\n    </div>\n    <div class=\"row-fuild\">\n        <div id=\"matrix_container\"></div>\n    </div>\n    <div class=\"row-fuild\">\n        <div id=\"relations_container\"></div>\n    </div>\n    <?php\n        if (!empty(Configure::read('Plugin.CyCat_enable'))) {\n            $titleHTML = __('CyCat Relationships');\n            $titleHTML .= sprintf('<a href=\"%s\" onclick=\"event.stopPropagation()\" title=\"%s\" target=\"_blank\"><img src=\"%s\" style=\"height: 2.5em\"/></a>',\n                'https://cycat.org/',\n                __('CyCAT or the CYbersecurity Resource CATalogue aims at mapping and documenting, in a single formalism and catalogue all the available cybersecurity tools, rules, playbooks, processes and controls.'),\n                $baseurl . '/img/CyCat.ico'\n            );\n            echo $this->element('/genericElements/accordion', [\n                'title' => 'CyCat Relationships',\n                'titleHTML' => $titleHTML,\n                'url' => '/galaxy_clusters/viewCyCatRelations/' . $cluster['GalaxyCluster']['id']\n            ]);\n        }\n    ?>\n    <div id=\"elements_content\"></div>\n</div>\n<?= $this->element('genericElements/assetLoader', array(\n    'js' => array(\n        'markdown-it',\n    ),\n));\n?>\n<script type=\"text/javascript\">\n$(function () {\n    $.get(\"<?= $baseurl ?>/galaxy_elements/index/<?php echo $cluster['GalaxyCluster']['id']; ?>\", function(data) {\n        $(\"#elements_content\").html(data);\n    });\n    $.get(\"<?= $baseurl ?>/galaxy_clusters/viewGalaxyMatrix/<?php echo $cluster['GalaxyCluster']['id']; ?>\", function(data) {\n        $(\"#matrix_container\").html(data);\n    });\n    $.get(\"<?= $baseurl ?>/galaxy_clusters/viewRelations/<?php echo $cluster['GalaxyCluster']['id']; ?>\", function(data) {\n        $(\"#relations_container\").html(data);\n    });\n});\n\nmd = window.markdownit('default');\nmd.disable(['image'])\nvar $md = $('.md');\n$md.html(md.render($md.text()));\n</script>\n<?= $this->element('/genericElements/SideMenu/side_menu', array('menuList' => 'galaxies', 'menuItem' => 'view_cluster'));\n"], "filenames": ["app/View/GalaxyClusters/view.ctp"], "buggy_code_start_loc": [59], "buggy_code_end_loc": [60], "fixing_code_start_loc": [59], "fixing_code_end_loc": [60], "type": "CWE-79", "message": "An issue was discovered in MISP before 2.4.158. There is stored XSS in the galaxy clusters.", "other": {"cve": {"id": "CVE-2022-29530", "sourceIdentifier": "cve@mitre.org", "published": "2022-04-20T23:15:08.513", "lastModified": "2022-04-27T03:57:27.483", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "An issue was discovered in MISP before 2.4.158. There is stored XSS in the galaxy clusters."}, {"lang": "es", "value": "Se ha detectado un problema en MISP versiones anteriores a 2.4.158. Se presenta una vulnerabilidad de tipo XSS almacenado en los clusters de galaxias"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 3.5}, "baseSeverity": "LOW", "exploitabilityScore": 6.8, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:misp:misp:*:*:*:*:*:*:*:*", "versionEndExcluding": "2.4.158", "matchCriteriaId": "C6216C19-9CB8-451D-AC18-0D849429EE09"}]}]}], "references": [{"url": "https://github.com/MISP/MISP/commit/107e271d78c255d658ce998285fe6f6c4f291b41", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/MISP/MISP/compare/v2.4.157...v2.4.158", "source": "cve@mitre.org", "tags": ["Release Notes", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/MISP/MISP/commit/107e271d78c255d658ce998285fe6f6c4f291b41"}}