{"buggy_code": ["package route\n\nimport (\n\t\"net/http\"\n\n\t\"github.com/IceWhaleTech/CasaOS-Common/utils/logger\"\n\t\"github.com/IceWhaleTech/CasaOS-Gateway/service\"\n\t\"go.uber.org/zap\"\n)\n\ntype GatewayRoute struct {\n\tmanagement *service.Management\n}\n\nfunc NewGatewayRoute(management *service.Management) *GatewayRoute {\n\treturn &GatewayRoute{\n\t\tmanagement: management,\n\t}\n}\n\nfunc (g *GatewayRoute) GetRoute() *http.ServeMux {\n\tgatewayMux := http.NewServeMux()\n\tgatewayMux.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) {\n\t\tif r.URL.Path == \"/ping\" {\n\t\t\tw.WriteHeader(http.StatusOK)\n\t\t\tif _, err := w.Write([]byte(\"pong from gateway service\")); err != nil {\n\t\t\t\tlogger.Error(\"Failed to `pong` in resposne to `ping`\", zap.Any(\"error\", err))\n\t\t\t}\n\t\t\treturn\n\t\t}\n\n\t\tproxy := g.management.GetProxy(r.URL.Path)\n\n\t\tif proxy == nil {\n\t\t\tw.WriteHeader(http.StatusNotFound)\n\t\t\treturn\n\t\t}\n\n\t\tproxy.ServeHTTP(w, r)\n\t})\n\n\treturn gatewayMux\n}\n"], "fixing_code": ["package route\n\nimport (\n\t\"net/http\"\n\t\"strings\"\n\n\t\"github.com/IceWhaleTech/CasaOS-Common/utils/logger\"\n\t\"github.com/IceWhaleTech/CasaOS-Gateway/service\"\n\t\"go.uber.org/zap\"\n)\n\ntype GatewayRoute struct {\n\tmanagement *service.Management\n}\n\nfunc NewGatewayRoute(management *service.Management) *GatewayRoute {\n\treturn &GatewayRoute{\n\t\tmanagement: management,\n\t}\n}\n\n// the function is to ensure the request source IP is correct.\nfunc rewriteRequestSourceIP(r *http.Request) {\n\t// we may receive two kinds of requests. a request from reverse proxy. a request from client.\n\n\t// in reverse proxy, X-Forwarded-For will like\n\t// `X-Forwarded-For:[192.168.6.102]`(normal)\n\t// `X-Forwarded-For:[::1, 192.168.6.102]`(hacked) Note: the ::1 is inject by attacker.\n\t// `X-Forwarded-For:[::1]`(normal or hacked) local request. But it from browser have JWT. So we can and need to verify it\n\t// `X-Forwarded-For:[::1,::1]`(normal or hacked) attacker can build the request to bypass the verification.\n\t// But in the case. the remoteAddress should be the real ip. So we can use remoteAddress to verify it.\n\n\tipList := strings.Split(r.Header.Get(\"X-Forwarded-For\"), \",\")\n\n\tr.Header.Del(\"X-Forwarded-For\")\n\tr.Header.Del(\"X-Real-IP\")\n\n\t// Note: the X-Forwarded-For depend the correct config from reverse proxy.\n\t// otherwise the X-Forwarded-For may be empty.\n\tremoteIP := r.RemoteAddr[:strings.LastIndex(r.RemoteAddr, \":\")]\n\tif len(ipList) > 0 && (remoteIP == \"127.0.0.1\" || remoteIP == \"::1\") {\n\t\t// to process the request from reverse proxy\n\n\t\t// in reverse proxy, X-Forwarded-For will container multiple IPs.\n\t\t// if the request is from reverse proxy, the r.RemoteAddr will be 127.0.0.1.\n\t\t// So we need get ip from X-Forwarded-For\n\t\tr.Header.Add(\"X-Forwarded-For\", ipList[len(ipList)-1])\n\t}\n\t// to process the request from client.\n\t// the gateway will add the X-Forwarded-For to request header.\n\t// So we didn't need to add it.\n}\n\nfunc (g *GatewayRoute) GetRoute() *http.ServeMux {\n\tgatewayMux := http.NewServeMux()\n\tgatewayMux.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) {\n\t\tif r.URL.Path == \"/ping\" {\n\t\t\tw.WriteHeader(http.StatusOK)\n\t\t\tif _, err := w.Write([]byte(\"pong from gateway service\")); err != nil {\n\t\t\t\tlogger.Error(\"Failed to `pong` in resposne to `ping`\", zap.Any(\"error\", err))\n\t\t\t}\n\t\t\treturn\n\t\t}\n\n\t\tproxy := g.management.GetProxy(r.URL.Path)\n\n\t\tif proxy == nil {\n\t\t\tw.WriteHeader(http.StatusNotFound)\n\t\t\treturn\n\t\t}\n\n\t\t// to fix https://github.com/IceWhaleTech/CasaOS/security/advisories/GHSA-32h8-rgcj-2g3c#event-102885\n\t\t// API V1 and V2 both read ip from request header. So the fix is effective for v1 and v2.\n\t\trewriteRequestSourceIP(r)\n\n\t\tproxy.ServeHTTP(w, r)\n\t})\n\n\treturn gatewayMux\n}\n"], "filenames": ["route/gateway_route.go"], "buggy_code_start_loc": [4], "buggy_code_end_loc": [38], "fixing_code_start_loc": [5], "fixing_code_end_loc": [76], "type": "CWE-306", "message": "CasaOS is an open-source Personal Cloud system. Due to a lack of IP address verification an unauthenticated attackers can execute arbitrary commands as `root` on CasaOS instances. The problem was addressed by improving the detection of client IP addresses in `391dd7f`. This patch is part of CasaOS 0.4.4. Users should upgrade to CasaOS 0.4.4. If they can't, they should temporarily restrict access to CasaOS to untrusted users, for instance by not exposing it publicly. ", "other": {"cve": {"id": "CVE-2023-37265", "sourceIdentifier": "security-advisories@github.com", "published": "2023-07-17T21:15:09.653", "lastModified": "2023-07-31T13:05:33.253", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "CasaOS is an open-source Personal Cloud system. Due to a lack of IP address verification an unauthenticated attackers can execute arbitrary commands as `root` on CasaOS instances. The problem was addressed by improving the detection of client IP addresses in `391dd7f`. This patch is part of CasaOS 0.4.4. Users should upgrade to CasaOS 0.4.4. If they can't, they should temporarily restrict access to CasaOS to untrusted users, for instance by not exposing it publicly. "}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.8, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.9, "impactScore": 5.9}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.8, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.9, "impactScore": 5.9}]}, "weaknesses": [{"source": "security-advisories@github.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-306"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:o:icewhale:casaos:*:*:*:*:*:*:*:*", "versionEndExcluding": "0.4.4", "matchCriteriaId": "D7FF418A-FDDC-4509-9AD3-F9B087F66947"}, {"vulnerable": true, "criteria": "cpe:2.3:o:icewhale:casaos:0.4.4:alpha1:*:*:*:*:*:*", "matchCriteriaId": "1CA71A7C-94AB-4774-8A49-7831035517A8"}, {"vulnerable": true, "criteria": "cpe:2.3:o:icewhale:casaos:0.4.4:alpha2:*:*:*:*:*:*", "matchCriteriaId": "340723DC-DE14-4796-8072-B9FB387F1F4A"}, {"vulnerable": true, "criteria": "cpe:2.3:o:icewhale:casaos:0.4.4:alpha3:*:*:*:*:*:*", "matchCriteriaId": "5A5D708C-8701-4CCF-AD03-EEAFAE3D5331"}, {"vulnerable": true, "criteria": "cpe:2.3:o:icewhale:casaos:0.4.4:alpha4:*:*:*:*:*:*", "matchCriteriaId": "5355136E-1258-4F19-9965-06690BE0CEBC"}, {"vulnerable": true, "criteria": "cpe:2.3:o:icewhale:casaos:0.4.4:alpha5:*:*:*:*:*:*", "matchCriteriaId": "163AC265-9DE2-4730-A49F-B5897C3018CF"}]}]}, {"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:icewhale:casaos-gateway:*:*:*:*:*:*:*:*", "versionEndExcluding": "0.4.4", "matchCriteriaId": "2EDB1082-0776-45F9-A24F-879373624849"}, {"vulnerable": true, "criteria": "cpe:2.3:a:icewhale:casaos-gateway:0.4.4:alpha1:*:*:*:*:*:*", "matchCriteriaId": "01185172-4FAA-427B-B092-FDD7AA88477E"}]}]}], "references": [{"url": "https://github.com/IceWhaleTech/CasaOS-Gateway/commit/391dd7f0f239020c46bf057cfa25f82031fc15f7", "source": "security-advisories@github.com", "tags": ["Patch"]}, {"url": "https://github.com/IceWhaleTech/CasaOS-Gateway/security/advisories/GHSA-vjh7-5r6x-xh6g", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/IceWhaleTech/CasaOS-Gateway/commit/391dd7f0f239020c46bf057cfa25f82031fc15f7"}}