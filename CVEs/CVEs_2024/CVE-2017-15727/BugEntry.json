{"buggy_code": ["<?php\n/**\n * Select an attachment and save it.\n *\n * PHP Version 5.5\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @author    Anatoliy Belsky <ab@php.net>\n * @copyright 2002-2017 phpMyFAQ\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      http://www.phpmyfaq.de\n * @since     2002-09-17\n */\ndefine('PMF_ROOT_DIR', dirname(__DIR__));\n\n//\n// Define the named constant used as a check by any included PHP file\n//\ndefine('IS_VALID_PHPMYFAQ', null);\n\n//\n// Bootstrapping\n//\nrequire PMF_ROOT_DIR.'/inc/Bootstrap.php';\n\n/*\n * Initialize attachment factory\n */\nPMF_Attachment_Factory::init(\n    $faqConfig->get('records.attachmentsStorageType'),\n    $faqConfig->get('records.defaultAttachmentEncKey'),\n    $faqConfig->get('records.enableAttachmentEncryption')\n);\n\n$currentSave = PMF_Filter::filterInput(INPUT_POST, 'save', FILTER_SANITIZE_STRING);\n$currentAction = PMF_Filter::filterInput(INPUT_GET, 'action', FILTER_SANITIZE_STRING);\n$currentToken = PMF_Filter::filterInput(INPUT_POST, 'csrf', FILTER_SANITIZE_STRING);\n\n$Language = new PMF_Language($faqConfig);\n$LANGCODE = $Language->setLanguage($faqConfig->get('main.languageDetection'), $faqConfig->get('main.language'));\n\nrequire_once PMF_ROOT_DIR.'/lang/language_en.php';\n\nif (isset($LANGCODE) && PMF_Language::isASupportedLanguage($LANGCODE)) {\n    require_once PMF_ROOT_DIR.'/lang/language_'.$LANGCODE.'.php';\n} else {\n    $LANGCODE = 'en';\n}\n\n$auth = false;\n$user = PMF_User_CurrentUser::getFromCookie($faqConfig);\nif (!$user instanceof PMF_User_CurrentUser) {\n    $user = PMF_User_CurrentUser::getFromSession($faqConfig);\n}\nif ($user) {\n    $auth = true;\n} else {\n    $error = $PMF_LANG['ad_auth_sess'];\n    $user = null;\n    unset($user);\n}\n\nif (is_null($currentAction) || !is_null($currentSave)) {\n?>\n<!DOCTYPE html>\n<!--[if IE 9 ]> <html lang=\"<?php echo $PMF_LANG['metaLanguage']; ?>\" class=\"no-js ie9\"> <![endif]-->\n<!--[if (gt IE 9)|!(IE)]><!--> <html lang=\"<?php echo $PMF_LANG['metaLanguage']; ?>\" class=\"no-js\"> <!--<![endif]-->\n<head>\n    <meta charset=\"utf-8\">\n\n    <title><?php echo $faqConfig->get('main.titleFAQ') ?> - powered by phpMyFAQ</title>\n    <base href=\"<?php echo $faqConfig->getDefaultUrl() ?>admin/\" />\n\n    <meta name=\"description\" content=\"Only Chuck Norris can divide by zero.\">\n    <meta name=\"author\" content=\"phpMyFAQ Team\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <meta name=\"application-name\" content=\"phpMyFAQ <?php echo $faqConfig->get('main.currentVersion') ?>\">\n    <meta name=\"publisher\" content=\"phpMyFAQ Team\">\n\n    <link rel=\"stylesheet\" href=\"assets/css/style.css?v=1\">\n\n    <script src=\"../assets/js/modernizr.min.js\"></script>\n    <script src=\"../assets/js/phpmyfaq.min.js\"></script>\n\n    <link rel=\"shortcut icon\" href=\"../assets/template/<?php echo PMF_Template::getTplSetName() ?>/favicon.ico\">\n</head>\n<body class=\"attachments\">\n\n<?php\n\n}\nif (is_null($currentAction) && $auth && $user->perm->checkRight($user->getUserId(), 'addattachment')) {\n    $recordId = filter_input(INPUT_GET, 'record_id',   FILTER_VALIDATE_INT);\n    $recordLang = filter_input(INPUT_GET, 'record_lang', FILTER_SANITIZE_STRING);\n    ?>\n        <form action=\"attachment.php?action=save\" enctype=\"multipart/form-data\" method=\"post\" accept-charset=\"utf-8\">\n            <fieldset>\n            <legend>\n                <?php echo $PMF_LANG['ad_att_addto'].' '.$PMF_LANG['ad_att_addto_2'] ?>\n                (max <?php echo round($faqConfig->get('records.maxAttachmentSize') / pow(1024, 2), 2) ?> MB)\n            </legend>\n                <input type=\"hidden\" name=\"MAX_FILE_SIZE\" value=\"<?php echo $faqConfig->get('records.maxAttachmentSize') ?>\">\n                <input type=\"hidden\" name=\"record_id\" value=\"<?php echo $recordId ?>\">\n                <input type=\"hidden\" name=\"record_lang\" value=\"<?php echo $recordLang ?>\">\n                <input type=\"hidden\" name=\"save\" value=\"TRUE\">\n                <input type=\"hidden\" name=\"csrf\" value=\"<?php echo $user->getCsrfTokenFromSession() ?>\">\n                <?php echo $PMF_LANG['ad_att_att'] ?>\n\n                <input name=\"userfile\" type=\"file\" id=\"fileUpload\">\n                <button class=\"btn btn-primary\" type=\"submit\">\n                    <?php echo $PMF_LANG['ad_att_butt'] ?>\n                </button>\n                <?php echo $PMF_LANG['msgAttachmentsFilesize'] ?>: <output id=\"filesize\"></output>\n            </fieldset>\n        </form>\n<?php\n\n}\n\nif (!isset($_SESSION['phpmyfaq_csrf_token']) || $_SESSION['phpmyfaq_csrf_token'] !== $currentToken) {\n    $auth = false;\n}\n\nif (!is_null($currentAction) && $auth && !$user->perm->checkRight($user->getUserId(), 'addattachment')) {\n    echo $PMF_LANG['err_NotAuth'];\n}\n\nif (!is_null($currentSave) && $currentSave == true && $auth &&\n    $user->perm->checkRight($user->getUserId(), 'addattachment')) {\n    $recordId = filter_input(INPUT_POST, 'record_id',   FILTER_VALIDATE_INT);\n    $recordLang = filter_input(INPUT_POST, 'record_lang', FILTER_SANITIZE_STRING);\n    ?>\n<p>\n    <strong><?php echo $PMF_LANG['ad_att_addto'].' '.$PMF_LANG['ad_att_addto_2'] ?></strong>\n</p>\n<?php\n    if (is_uploaded_file($_FILES['userfile']['tmp_name']) && !($_FILES['userfile']['size'] > $faqConfig->get('records.maxAttachmentSize'))) {\n        $att = PMF_Attachment_Factory::create();\n        $att->setRecordId($recordId);\n        $att->setRecordLang($recordLang);\n\n        /*\n         * To add user defined key\n         * $att->setKey($somekey, false);\n         */\n        try {\n            $uploaded = $att->save($_FILES['userfile']['tmp_name'], $_FILES['userfile']['name']);\n\n            if ($uploaded) {\n                echo '<p>'.$PMF_LANG['ad_att_suc'].'</p>';\n            } else {\n                throw new Exception();\n            }\n        } catch (Exception $e) {\n            $att->delete();\n            echo '<p>'.$PMF_LANG['ad_att_fail'].'</p>';\n        }\n\n        printf(\n            '<p class=\"text-center\"><a href=\"#\" onclick=\"addAttachmentLink(%d, \\'%s\\', %d, \\'%s\\');\">%s</a></p>',\n            $att->getId(),\n            $att->getFilename(),\n            $recordId,\n            $recordLang,\n            $PMF_LANG['ad_att_close']\n        );\n    } else {\n        printf(\n            '<p>%s</p>',\n            sprintf(\n                $PMF_LANG['ad_attach_4'],\n                round($faqConfig->get('records.maxAttachmentSize') / pow(1024, 2), 2)\n            )\n        );\n\n        printf(\n            '<p class=\"text-center\"><a href=\"javascript:;\" onclick=\"closeWindow();\">%s</a></p>',\n            $PMF_LANG['ad_att_close']\n        );\n    }\n}\nif (!is_null($currentSave) && $currentSave == true && $auth &&\n    !$user->perm->checkRight($user->getUserId(), 'addattachment')) {\n    echo $PMF_LANG['err_NotAuth'];\n}\n\n$faqConfig->getDb()->close();\n?>\n<script src=\"assets/js/uploadcheck.js\"></script>\n</body>\n</html>"], "fixing_code": ["<?php\n/**\n * Select an attachment and save it.\n *\n * PHP Version 5.5\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @author    Anatoliy Belsky <ab@php.net>\n * @copyright 2002-2017 phpMyFAQ\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      http://www.phpmyfaq.de\n * @since     2002-09-17\n */\ndefine('PMF_ROOT_DIR', dirname(__DIR__));\n\n//\n// Define the named constant used as a check by any included PHP file\n//\ndefine('IS_VALID_PHPMYFAQ', null);\n\n//\n// Bootstrapping\n//\nrequire PMF_ROOT_DIR.'/inc/Bootstrap.php';\n\n/*\n * Initialize attachment factory\n */\nPMF_Attachment_Factory::init(\n    $faqConfig->get('records.attachmentsStorageType'),\n    $faqConfig->get('records.defaultAttachmentEncKey'),\n    $faqConfig->get('records.enableAttachmentEncryption')\n);\n\n$currentSave = PMF_Filter::filterInput(INPUT_POST, 'save', FILTER_SANITIZE_STRING);\n$currentAction = PMF_Filter::filterInput(INPUT_GET, 'action', FILTER_SANITIZE_STRING);\n$currentToken = PMF_Filter::filterInput(INPUT_POST, 'csrf', FILTER_SANITIZE_STRING);\n\n$Language = new PMF_Language($faqConfig);\n$LANGCODE = $Language->setLanguage($faqConfig->get('main.languageDetection'), $faqConfig->get('main.language'));\n\nrequire_once PMF_ROOT_DIR.'/lang/language_en.php';\n\nif (isset($LANGCODE) && PMF_Language::isASupportedLanguage($LANGCODE)) {\n    require_once PMF_ROOT_DIR.'/lang/language_'.$LANGCODE.'.php';\n} else {\n    $LANGCODE = 'en';\n}\n\n$auth = false;\n$user = PMF_User_CurrentUser::getFromCookie($faqConfig);\nif (!$user instanceof PMF_User_CurrentUser) {\n    $user = PMF_User_CurrentUser::getFromSession($faqConfig);\n}\nif ($user) {\n    $auth = true;\n} else {\n    $error = $PMF_LANG['ad_auth_sess'];\n    $user = null;\n    unset($user);\n}\n\nif (is_null($currentAction) || !is_null($currentSave)) {\n?>\n<!DOCTYPE html>\n<!--[if IE 9 ]> <html lang=\"<?php echo $PMF_LANG['metaLanguage']; ?>\" class=\"no-js ie9\"> <![endif]-->\n<!--[if (gt IE 9)|!(IE)]><!--> <html lang=\"<?php echo $PMF_LANG['metaLanguage']; ?>\" class=\"no-js\"> <!--<![endif]-->\n<head>\n    <meta charset=\"utf-8\">\n\n    <title><?php echo $faqConfig->get('main.titleFAQ') ?> - powered by phpMyFAQ</title>\n    <base href=\"<?php echo $faqConfig->getDefaultUrl() ?>admin/\" />\n\n    <meta name=\"description\" content=\"Only Chuck Norris can divide by zero.\">\n    <meta name=\"author\" content=\"phpMyFAQ Team\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <meta name=\"application-name\" content=\"phpMyFAQ <?php echo $faqConfig->get('main.currentVersion') ?>\">\n    <meta name=\"publisher\" content=\"phpMyFAQ Team\">\n\n    <link rel=\"stylesheet\" href=\"assets/css/style.css?v=1\">\n\n    <script src=\"../assets/js/modernizr.min.js\"></script>\n    <script src=\"../assets/js/phpmyfaq.min.js\"></script>\n\n    <link rel=\"shortcut icon\" href=\"../assets/template/<?php echo PMF_Template::getTplSetName() ?>/favicon.ico\">\n</head>\n<body class=\"attachments\">\n\n<?php\n\n}\nif (is_null($currentAction) && $auth && $user->perm->checkRight($user->getUserId(), 'addattachment')) {\n    $recordId = filter_input(INPUT_GET, 'record_id',   FILTER_VALIDATE_INT);\n    $recordLang = filter_input(INPUT_GET, 'record_lang', FILTER_SANITIZE_STRING);\n    ?>\n        <form action=\"attachment.php?action=save\" enctype=\"multipart/form-data\" method=\"post\" accept-charset=\"utf-8\">\n            <fieldset>\n            <legend>\n                <?php echo $PMF_LANG['ad_att_addto'].' '.$PMF_LANG['ad_att_addto_2'] ?>\n                (max <?php echo round($faqConfig->get('records.maxAttachmentSize') / pow(1024, 2), 2) ?> MB)\n            </legend>\n                <input type=\"hidden\" name=\"MAX_FILE_SIZE\" value=\"<?php echo $faqConfig->get('records.maxAttachmentSize') ?>\">\n                <input type=\"hidden\" name=\"record_id\" value=\"<?php echo $recordId ?>\">\n                <input type=\"hidden\" name=\"record_lang\" value=\"<?php echo $recordLang ?>\">\n                <input type=\"hidden\" name=\"save\" value=\"TRUE\">\n                <input type=\"hidden\" name=\"csrf\" value=\"<?php echo $user->getCsrfTokenFromSession() ?>\">\n                <?php echo $PMF_LANG['ad_att_att'] ?>\n\n                <input name=\"userfile\" type=\"file\" id=\"fileUpload\">\n                <button class=\"btn btn-primary\" type=\"submit\">\n                    <?php echo $PMF_LANG['ad_att_butt'] ?>\n                </button>\n                <?php echo $PMF_LANG['msgAttachmentsFilesize'] ?>: <output id=\"filesize\"></output>\n            </fieldset>\n        </form>\n<?php\n\n}\n\nif (!isset($_SESSION['phpmyfaq_csrf_token']) || $_SESSION['phpmyfaq_csrf_token'] !== $currentToken) {\n    $auth = false;\n}\n\nif (!is_null($currentAction) && $auth && !$user->perm->checkRight($user->getUserId(), 'addattachment')) {\n    echo $PMF_LANG['err_NotAuth'];\n}\n\nif (!is_null($currentSave) && $currentSave == true && $auth &&\n    $user->perm->checkRight($user->getUserId(), 'addattachment')) {\n    $recordId = filter_input(INPUT_POST, 'record_id',   FILTER_VALIDATE_INT);\n    $recordLang = filter_input(INPUT_POST, 'record_lang', FILTER_SANITIZE_STRING);\n    ?>\n<p>\n    <strong><?php echo $PMF_LANG['ad_att_addto'].' '.$PMF_LANG['ad_att_addto_2'] ?></strong>\n</p>\n<?php\n    if (\n        is_uploaded_file($_FILES['userfile']['tmp_name']) &&\n        !($_FILES['userfile']['size'] > $faqConfig->get('records.maxAttachmentSize')) &&\n        $_FILES['userfile']['type'] !== \"text/html\"\n    ) {\n        $att = PMF_Attachment_Factory::create();\n        $att->setRecordId($recordId);\n        $att->setRecordLang($recordLang);\n\n        /*\n         * To add user defined key\n         * $att->setKey($somekey, false);\n         */\n        try {\n            $uploaded = $att->save($_FILES['userfile']['tmp_name'], $_FILES['userfile']['name']);\n\n            if ($uploaded) {\n                echo '<p>'.$PMF_LANG['ad_att_suc'].'</p>';\n            } else {\n                throw new Exception();\n            }\n        } catch (Exception $e) {\n            $att->delete();\n            echo '<p>'.$PMF_LANG['ad_att_fail'].'</p>';\n        }\n\n        printf(\n            '<p class=\"text-center\"><a href=\"#\" onclick=\"addAttachmentLink(%d, \\'%s\\', %d, \\'%s\\');\">%s</a></p>',\n            $att->getId(),\n            $att->getFilename(),\n            $recordId,\n            $recordLang,\n            $PMF_LANG['ad_att_close']\n        );\n    } else {\n        printf(\n            '<p>%s</p>',\n            sprintf(\n                $PMF_LANG['ad_attach_4'],\n                round($faqConfig->get('records.maxAttachmentSize') / pow(1024, 2), 2)\n            )\n        );\n\n        printf(\n            '<p class=\"text-center\"><a href=\"javascript:;\" onclick=\"closeWindow();\">%s</a></p>',\n            $PMF_LANG['ad_att_close']\n        );\n    }\n}\nif (!is_null($currentSave) && $currentSave == true && $auth &&\n    !$user->perm->checkRight($user->getUserId(), 'addattachment')) {\n    echo $PMF_LANG['err_NotAuth'];\n}\n\n$faqConfig->getDb()->close();\n?>\n<script src=\"assets/js/uploadcheck.js\"></script>\n</body>\n</html>"], "filenames": ["phpmyfaq/admin/attachment.php"], "buggy_code_start_loc": [142], "buggy_code_end_loc": [143], "fixing_code_start_loc": [142], "fixing_code_end_loc": [147], "type": "CWE-79", "message": "In phpMyFAQ before 2.9.9, there is Stored Cross-site Scripting (XSS) via an HTML attachment.", "other": {"cve": {"id": "CVE-2017-15727", "sourceIdentifier": "cve@mitre.org", "published": "2017-10-22T18:29:00.310", "lastModified": "2019-03-14T14:03:48.077", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In phpMyFAQ before 2.9.9, there is Stored Cross-site Scripting (XSS) via an HTML attachment."}, {"lang": "es", "value": "En phpMyFAQ en versiones anteriores a la 2.9.9 hay Cross-Site Scripting (XSS) persistente mediante un adjunto HTML."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 3.5}, "baseSeverity": "LOW", "exploitabilityScore": 6.8, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:phpmyfaq:phpmyfaq:*:*:*:*:*:*:*:*", "versionEndIncluding": "2.9.8", "matchCriteriaId": "1D0B1C07-83F7-4DB0-976C-51483D7DF516"}]}]}], "references": [{"url": "https://github.com/thorsten/phpMyFAQ/commit/5c3e4f96ff0ef6b91a3f0aa64eb28197c5cf5435", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://www.exploit-db.com/exploits/43063/", "source": "cve@mitre.org", "tags": ["Exploit", "Third Party Advisory", "VDB Entry"]}]}, "github_commit_url": "https://github.com/thorsten/phpMyFAQ/commit/5c3e4f96ff0ef6b91a3f0aa64eb28197c5cf5435"}}