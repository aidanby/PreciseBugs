{"buggy_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2008-2019\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n*/\n\n//includes\n\trequire_once \"root.php\";\n\trequire_once \"resources/require.php\";\n\trequire_once \"resources/check_auth.php\";\n\n//check permissions\n\tif (permission_exists('contact_view')) {\n\t\t//access granted\n\t}\n\telse {\n\t\techo \"access denied\";\n\t\texit;\n\t}\n\n//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n//action add or update\n\tif (is_uuid($_REQUEST[\"id\"])) {\n\t\t$action = \"update\";\n\t\t$contact_uuid = $_REQUEST[\"id\"];\n\t}\n\telse {\n\t\t$action = \"add\";\n\t}\n\n//get http post variables and set them to php variables\n\tif (count($_POST) > 0) {\n\t\t$user_uuid = $_POST[\"user_uuid\"];\n\t\t$group_uuid = $_POST['group_uuid'];\n\t\t$contact_type = $_POST[\"contact_type\"];\n\t\t$contact_organization = $_POST[\"contact_organization\"];\n\t\t$contact_name_prefix = $_POST[\"contact_name_prefix\"];\n\t\t$contact_name_given = $_POST[\"contact_name_given\"];\n\t\t$contact_name_middle = $_POST[\"contact_name_middle\"];\n\t\t$contact_name_family = $_POST[\"contact_name_family\"];\n\t\t$contact_name_suffix = $_POST[\"contact_name_suffix\"];\n\t\t$contact_nickname = $_POST[\"contact_nickname\"];\n\t\t$contact_title = $_POST[\"contact_title\"];\n\t\t$contact_category = $_POST[\"contact_category\"];\n\t\t$contact_role = $_POST[\"contact_role\"];\n\t\t$contact_time_zone = $_POST[\"contact_time_zone\"];\n\t\t$contact_note = $_POST[\"contact_note\"];\n\t}\n\n//process the form data\n\tif (count($_POST) > 0 && strlen($_POST[\"persistformvar\"]) == 0) {\n\n\t\t//set the uuid\n\t\t\tif ($action == \"update\") {\n\t\t\t\t$contact_uuid = $_POST[\"contact_uuid\"];\n\t\t\t}\n\n\t\t//check for all required data\n\t\t\t$msg = '';\n\t\t\t//if (strlen($contact_type) == 0) { $msg .= $text['message-required'].$text['label-contact_type'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_organization) == 0) { $msg .= $text['message-required'].$text['label-contact_organization'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_name_prefix) == 0) { $msg .= $text['message-required'].$text['label-contact_name_prefix'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_name_given) == 0) { $msg .= $text['message-required'].$text['label-contact_name_given'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_name_middle) == 0) { $msg .= $text['message-required'].$text['label-contact_name_middle'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_name_family) == 0) { $msg .= $text['message-required'].$text['label-contact_name_family'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_name_suffix) == 0) { $msg .= $text['message-required'].$text['label-contact_name_suffix'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_nickname) == 0) { $msg .= $text['message-required'].$text['label-contact_nickname'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_title) == 0) { $msg .= $text['message-required'].$text['label-contact_title'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_role) == 0) { $msg .= $text['message-required'].$text['label-contact_role'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_time_zone) == 0) { $msg .= $text['message-required'].$text['label-contact_time_zone'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_note) == 0) { $msg .= $text['message-required'].$text['label-contact_note'].\"<br>\\n\"; }\n\t\t\tif (strlen($msg) > 0 && strlen($_POST[\"persistformvar\"]) == 0) {\n\t\t\t\trequire_once \"resources/header.php\";\n\t\t\t\trequire_once \"resources/persist_form_var.php\";\n\t\t\t\techo \"<div align='center'>\\n\";\n\t\t\t\techo \"<table><tr><td>\\n\";\n\t\t\t\techo $msg.\"<br />\";\n\t\t\t\techo \"</td></tr></table>\\n\";\n\t\t\t\tpersistformvar($_POST);\n\t\t\t\techo \"</div>\\n\";\n\t\t\t\trequire_once \"resources/footer.php\";\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t//add or update the database\n\t\t\tif ($_POST[\"persistformvar\"] != \"true\") {\n\n\t\t\t\t//add the contact\n\t\t\t\t\tif ($action == \"add\" && permission_exists('contact_add')) {\n\t\t\t\t\t\t$contact_uuid = uuid();\n\t\t\t\t\t\t$array['contacts'][0]['contact_uuid'] = $contact_uuid;\n\n\t\t\t\t\t\tmessage::add($text['message-add']);\n\t\t\t\t\t\t$location = \"contact_edit.php?id=\".$contact_uuid;\n\t\t\t\t\t}\n\n\t\t\t\t//update the contact\n\t\t\t\t\tif ($action == \"update\" && permission_exists('contact_edit')) {\n\t\t\t\t\t\t$array['contacts'][0]['contact_uuid'] = $contact_uuid;\n\n\t\t\t\t\t\tmessage::add($text['message-update']);\n\t\t\t\t\t\t$location = \"contact_edit.php?id=\".escape($contact_uuid);\n\t\t\t\t\t}\n\n\t\t\t\t//create array\n\t\t\t\t\tif (is_array($array) && @sizeof($array) != 0) {\n\t\t\t\t\t\t$array['contacts'][0]['domain_uuid'] = $_SESSION['domain_uuid'];\n\t\t\t\t\t\t$array['contacts'][0]['contact_type'] = $contact_type;\n\t\t\t\t\t\t$array['contacts'][0]['contact_organization'] = $contact_organization;\n\t\t\t\t\t\t$array['contacts'][0]['contact_name_prefix'] = $contact_name_prefix;\n\t\t\t\t\t\t$array['contacts'][0]['contact_name_given'] = $contact_name_given;\n\t\t\t\t\t\t$array['contacts'][0]['contact_name_middle'] = $contact_name_middle;\n\t\t\t\t\t\t$array['contacts'][0]['contact_name_family'] = $contact_name_family;\n\t\t\t\t\t\t$array['contacts'][0]['contact_name_suffix'] = $contact_name_suffix;\n\t\t\t\t\t\t$array['contacts'][0]['contact_nickname'] = $contact_nickname;\n\t\t\t\t\t\t$array['contacts'][0]['contact_title'] = $contact_title;\n\t\t\t\t\t\t$array['contacts'][0]['contact_category'] = $contact_category;\n\t\t\t\t\t\t$array['contacts'][0]['contact_role'] = $contact_role;\n\t\t\t\t\t\t$array['contacts'][0]['contact_time_zone'] = $contact_time_zone;\n\t\t\t\t\t\t$array['contacts'][0]['contact_note'] = $contact_note;\n\t\t\t\t\t\t$array['contacts'][0]['last_mod_date'] = 'now()';\n\t\t\t\t\t\t$array['contacts'][0]['last_mod_user'] = $_SESSION['username'];\n\n\t\t\t\t\t\t$p = new permissions;\n\t\t\t\t\t}\n\n\t\t\t\t//assign the contact to the user that added the contact\n\t\t\t\t\tif ($action == \"add\" && !permission_exists('contact_user_add')) {\n\t\t\t\t\t\t$user_uuid = $_SESSION[\"user_uuid\"];\n\t\t\t\t\t}\n\n\t\t\t\t//add user to contact users table\n\t\t\t\t\tif (is_uuid($user_uuid) && (permission_exists('contact_user_add') || $action == \"add\")) {\n\t\t\t\t\t\t$contact_user_uuid = uuid();\n\t\t\t\t\t\t$array['contact_users'][0]['domain_uuid'] = $domain_uuid;\n\t\t\t\t\t\t$array['contact_users'][0]['contact_user_uuid'] = $contact_user_uuid;\n\t\t\t\t\t\t$array['contact_users'][0]['contact_uuid'] = $contact_uuid;\n\t\t\t\t\t\t$array['contact_users'][0]['user_uuid'] = $user_uuid;\n\n\t\t\t\t\t\t$p->add('contact_user_add', 'temp');\n\t\t\t\t\t}\n\n\t\t\t\t//assign the contact to the group\n\t\t\t\t\tif (is_uuid($group_uuid) && permission_exists('contact_group_add')) {\n\t\t\t\t\t\t$contact_group_uuid = uuid();\n\t\t\t\t\t\t$array['contact_group'][0]['contact_group_uuid'] = $contact_group_uuid;\n\t\t\t\t\t\t$array['contact_group'][0]['domain_uuid'] = $domain_uuid;\n\t\t\t\t\t\t$array['contact_group'][0]['contact_uuid'] = $contact_uuid;\n\t\t\t\t\t\t$array['contact_group'][0]['group_uuid'] = $group_uuid;\n\n\t\t\t\t\t\t$p->add('contact_group_add', 'temp');\n\t\t\t\t\t}\n\n\t\t\t\t//execute\n\t\t\t\t\tif (is_array($array) && @sizeof($array) != 0) {\n\t\t\t\t\t\t$database = new database;\n\t\t\t\t\t\t$database->app_name = 'contacts';\n\t\t\t\t\t\t$database->app_uuid = '04481e0e-a478-c559-adad-52bd4174574c';\n\t\t\t\t\t\t$database->save($array);\n\t\t\t\t\t\tunset($array);\n\n\t\t\t\t\t\t$p->delete('contact_user_add', 'temp');\n\t\t\t\t\t\t$p->delete('contact_group_add', 'temp');\n\t\t\t\t\t}\n\n\t\t\t\t//handle redirect\n\t\t\t\t\tif ($_POST['submit'] == $text['button-add']) {\n\t\t\t\t\t\t$location = \"contact_edit.php?id=\".escape($contact_uuid);\n\t\t\t\t\t}\n\n\t\t\t\t//redirect the browser\n\t\t\t\t\theader(\"Location: \".$location);\n\t\t\t\t\texit;\n\n\t\t\t}\n\t}\n\n//pre-populate the form\n\tif (count($_GET) > 0 && $_POST[\"persistformvar\"] != \"true\") {\n\t\t$contact_uuid = $_GET[\"id\"];\n\t\t$sql = \"select * from v_contacts \";\n\t\t$sql .= \"where domain_uuid = :domain_uuid \";\n\t\t$sql .= \"and contact_uuid = :contact_uuid \";\n\t\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t\t$parameters['contact_uuid'] = $contact_uuid;\n\t\t$database = new database;\n\t\t$row = $database->select($sql, $parameters, 'row');\n\t\tif (is_array($row) && @sizeof($row) != 0) {\n\t\t\t$contact_type = $row[\"contact_type\"];\n\t\t\t$contact_organization = $row[\"contact_organization\"];\n\t\t\t$contact_name_prefix = $row[\"contact_name_prefix\"];\n\t\t\t$contact_name_given = $row[\"contact_name_given\"];\n\t\t\t$contact_name_middle = $row[\"contact_name_middle\"];\n\t\t\t$contact_name_family = $row[\"contact_name_family\"];\n\t\t\t$contact_name_suffix = $row[\"contact_name_suffix\"];\n\t\t\t$contact_nickname = $row[\"contact_nickname\"];\n\t\t\t$contact_title = $row[\"contact_title\"];\n\t\t\t$contact_category = $row[\"contact_category\"];\n\t\t\t$contact_role = $row[\"contact_role\"];\n\t\t\t$contact_time_zone = $row[\"contact_time_zone\"];\n\t\t\t$contact_note = $row[\"contact_note\"];\n\t\t}\n\t\tunset($sql, $parameters, $row);\n\t}\n\n//get the users array\n\t$sql = \"select * from v_users \";\n\t$sql .= \"where domain_uuid = :domain_uuid \";\n\t$sql .= \"order by username asc \";\n\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t$database = new database;\n\t$users = $database->select($sql, $parameters, 'all');\n\tunset($sql, $parameters);\n\n//determine if contact assigned to a user\n\tif (is_array($users) && sizeof($users) != 0) {\n\t\tforeach($users as $user) {\n\t\t\tif ($user['contact_uuid'] == $contact_uuid) {\n\t\t\t\t$contact_user_uuid = $user['user_uuid'];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n//get the users assigned to this contact\n\t$sql = \"select u.username, u.user_uuid, a.contact_user_uuid from v_contacts as c, v_users as u, v_contact_users as a \";\n\t$sql .= \"where c.contact_uuid = :contact_uuid \";\n\t$sql .= \"and c.domain_uuid = :domain_uuid \";\n\t$sql .= \"and u.user_uuid = a.user_uuid \";\n\t$sql .= \"and c.contact_uuid = a.contact_uuid \";\n\t$sql .= \"order by u.username asc \";\n\t$parameters['contact_uuid'] = $contact_uuid;\n\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t$database = new database;\n\t$contact_users = $database->select($sql, $parameters, 'all');\n\tunset($sql, $parameters);\n\n//show the header\n\trequire_once \"resources/header.php\";\n\tif ($action == \"update\") {\n\t\t$document['title'] = $text['title-contact-edit'];\n\t}\n\telse if ($action == \"add\") {\n\t\t$document['title'] = $text['title-contact-add'];\n\t}\n\n//set the mode\n\tif (isset($_SESSION['theme']['qr_image']['text'])) {\n\t\tif (strlen($_SESSION['theme']['qr_image']['text']) == 0) {\n\t\t\t$mode = '4';\n\t\t}\n\t\telse {\n\t\t\t$mode = '0';\n\t\t}\n\t}\n\telse {\n\t\t$mode = '4';\n\t}\n\n//qr code generation\n\t$_GET['type'] = \"text\";\n\t$qr_vcard = true;\n\tinclude \"contacts_vcard.php\";\n\techo \"<input type='hidden' id='qr_vcard' value=\\\"\".$qr_vcard.\"\\\">\";\n\techo \"<style>\";\n\techo \"\t#qr_code_container {\";\n\techo \"\t\tz-index: 999999; \";\n\techo \"\t\tposition: absolute; \";\n\techo \"\t\tleft: 0px; \";\n\techo \"\t\ttop: 0px; \";\n\techo \"\t\tright: 0px; \";\n\techo \"\t\tbottom: 0px; \";\n\techo \"\t\ttext-align: center; \";\n\techo \"\t\tvertical-align: middle;\";\n\techo \"\t}\";\n\techo \"\t#qr_code {\";\n\techo \"\t\tdisplay: block; \";\n\techo \"\t\twidth: 650px; \";\n\techo \"\t\theight: 650px; \";\n\techo \"\t\t-webkit-box-shadow: 0px 1px 20px #888; \";\n\techo \"\t\t-moz-box-shadow: 0px 1px 20px #888; \";\n\techo \"\t\tbox-shadow: 0px 1px 20px #888;\";\n\techo \"\t}\";\n\techo \"</style>\";\n\techo \"<script src='\".PROJECT_PATH.\"/resources/jquery/jquery.qrcode-0.8.0.min.js'></script>\";\n\techo \"<script language='JavaScript' type='text/javascript'>\";\n\techo \"\t$(document).ready(function() {\";\n\techo \"\t\t$(window).load(function() {\";\n\techo \"\t\t\t$('#qr_code').qrcode({ \";\n\techo \"\t\t\t\trender: 'canvas', \";\n\techo \"\t\t\t\tminVersion: 6, \";\n\techo \"\t\t\t\tmaxVersion: 40, \";\n\techo \"\t\t\t\tecLevel: 'H', \";\n\techo \"\t\t\t\tsize: 650, \";\n\techo \"\t\t\t\tradius: 0.2, \";\n\techo \"\t\t\t\tquiet: 6, \";\n\techo \"\t\t\t\tbackground: '#fff', \";\n\techo \"\t\t\t\tmode: \".$mode.\", \";\n\techo \"\t\t\t\tmSize: 0.2, \";\n\techo \"\t\t\t\tmPosX: 0.5, \";\n\techo \"\t\t\t\tmPosY: 0.5, \";\n\techo \"\t\t\t\timage: $('#img-buffer')[0], \";\n\techo \"\t\t\t\ttext: document.getElementById('qr_vcard').value \";\n\techo \"\t\t\t});\";\n\techo \"\t\t});\";\n\techo \"\t});\";\n\techo \"</script>\";\n\tif (isset($_SESSION['theme']['qr_image'])) {\n\t\techo \"<img id='img-buffer' src='\".$_SESSION[\"theme\"][\"qr_image\"][\"text\"].\"' style='display: none;'>\";\n\t}\n\telse {\n\t\techo \"<img id='img-buffer' src='\".PROJECT_PATH.\"/themes/\".$_SESSION[\"domain\"][\"template\"][\"name\"].\"/images/qr_code.png' style='display: none;'>\";\n\t}\n\n//show the content\n\techo \"<form method='post' name='frm' action=''>\\n\";\n\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\techo \"<tr>\\n\";\n\techo \"<td valign='top' align='left' width='30%' nowrap='nowrap'><b>\";\n\tswitch ($action) {\n\t\tcase \"add\": echo $text['header-contact-add']; break;\n\t\tcase \"update\": echo $text['header-contact-edit']; break;\n\t}\n\techo \"</b></td>\\n\";\n\techo \"<td valign='top' width='70%' align='right'>\\n\";\n\techo \"\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='contacts.php?\".$_GET[\"query_string\"].\"'\\\" value='\".$text['button-back'].\"'>\\n\";\n\tif ($action == \"update\") {\n\t\tif (permission_exists('contact_time_add')) {\n\t\t\t//detect timer state (and start time)\n\t\t\t$sql = \"select \";\n\t\t\t$sql .= \"time_start \";\n\t\t\t$sql .= \"from v_contact_times \";\n\t\t\t$sql .= \"where domain_uuid = :domain_uuid \";\n\t\t\t$sql .= \"and user_uuid = :user_uuid \";\n\t\t\t$sql .= \"and contact_uuid = :contact_uuid \";\n\t\t\t$sql .= \"and time_start is not null \";\n\t\t\t$sql .= \"and time_stop is null \";\n\t\t\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t\t\t$parameters['user_uuid'] = $_SESSION['user']['user_uuid'];\n\t\t\t$parameters['contact_uuid'] = $contact_uuid;\n\t\t\t$database = new database;\n\t\t\t$time_start = $database->select($sql, $parameters, 'column');\n\t\t\t$btn_mod = $time_start != '' ? \"style='background-color: #3693df; background-image: none;'\" : null;\n\t\t\tunset($sql, $parameters);\n\t\t\techo \"\t<input type='button' class='btn' \".$btn_mod.\" alt='\".$text['button-timer'].\"' \".($time_start != '' ? \"title='\".escape($time_start).\"'\" : null).\" onclick=\\\"window.open('contact_timer.php?domain_uuid=\".escape($domain_uuid).\"&contact_uuid=\".escape($contact_uuid).\"','contact_time_\".escape($contact_uuid).\"','width=300, height=375, top=30, left='+(screen.width - 350)+', menubar=no, scrollbars=no, status=no, toolbar=no, resizable=no');\\\" value='\".$text['button-timer'].\"'>\\n\";\n\t\t}\n\t\techo \"\t<input type='button' class='btn' name='' alt='\".$text['button-qr_code'].\"' onclick=\\\"$('#qr_code_container').fadeIn(400);\\\" value='\".$text['button-qr_code'].\"'>\\n\";\n\t\techo \"\t<input type='button' class='btn' name='' alt='\".$text['button-vcard'].\"' onclick=\\\"window.location='contacts_vcard.php?id=\".escape($contact_uuid).\"&type=download'\\\" value='\".$text['button-vcard'].\"'>\\n\";\n\t}\n\tif ($action == \"update\" && is_dir($_SERVER[\"DOCUMENT_ROOT\"].PROJECT_PATH.'/app/invoices')) {\n\t\techo \"\t<input type='button' class='btn' name='' alt='\".$text['button-invoices'].\"' onclick=\\\"window.location='\".PROJECT_PATH.\"/app/invoices/invoices.php?id=\".escape($contact_uuid).\"'\\\" value='\".$text['button-invoices'].\"'>\\n\";\n\t}\n\tif ($action == \"update\" && is_dir($_SERVER[\"DOCUMENT_ROOT\"].PROJECT_PATH.'/app/certificates')) {\n\t\techo \"\t<input type='button' class='btn' name='' alt='\".$text['button-certificate'].\"' onclick=\\\"window.location='\".PROJECT_PATH.\"/app/certificates/index.php?name=\".urlencode(escape($contact_name_given).\" \".escape($contact_name_family)).\"'\\\" value='\".$text['button-certificate'].\"'>\\n\";\n\t}\n\tif ($action == \"update\" && permission_exists('user_edit') && is_uuid($contact_user_uuid)) {\n\t\techo \"\t<input type='button' class='btn' name='' alt='\".$text['button-user'].\"' onclick=\\\"window.location='\".PROJECT_PATH.\"/core/users/user_edit.php?id=\".$contact_user_uuid.\"'\\\" value='\".$text['button-user'].\"'>\\n\";\n\t}\n\techo \"\t<input type='submit' name='submit' class='btn' value='\".$text['button-save'].\"'>\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\techo \"<tr>\\n\";\n\techo \"<td align=\\\"left\\\" colspan='2'>\\n\";\n\tswitch ($action) {\n\t\tcase \"add\" :\techo $text['description-contact-add'];\tbreak;\n\t\tcase \"update\" :\techo $text['description-contact-edit'];\tbreak;\n\t}\n\techo \"<br /><br />\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\techo \"</table>\\n\";\n\n\techo \"<table border='0' cellpadding='0' cellspacing='0' width='100%'>\\n\";\n\techo \"<tr>\\n\";\n\techo \"<td width='40%' valign='top' align='left' nowrap='nowrap'>\\n\";\n\n\t\techo \"<table border='0' cellpadding='0' cellspacing='0' width='100%'>\\n\";\n\t\techo \"<tr>\\n\";\n\t\techo \"<td width='30%' class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_type'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\tif (is_array($_SESSION[\"contact\"][\"type\"])) {\n\t\t\tsort($_SESSION[\"contact\"][\"type\"]);\n\t\t\techo \"\t<select class='formfld' name='contact_type'>\\n\";\n\t\t\techo \"\t\t<option value=''></option>\\n\";\n\t\t\tforeach($_SESSION[\"contact\"][\"type\"] as $row) {\n\t\t\t\techo \"\t<option value='\".escape($row).\"' \".(($row == $contact_type) ? \"selected='selected'\" : null).\">\".escape($row).\"</option>\\n\";\n\t\t\t}\n\t\t\techo \"\t</select>\\n\";\n\t\t}\n\t\telse {\n\t\t\techo \"\t<select class='formfld' name='contact_type'>\\n\";\n\t\t\techo \"\t\t<option value=''></option>\\n\";\n\t\t\techo \"\t\t<option value='customer' \".(($contact_type == \"customer\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_customer'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='contractor' \".(($contact_type == \"contractor\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_contractor'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='friend' \".(($contact_type == \"friend\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_friend'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='lead' \".(($contact_type == \"lead\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_lead'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='member' \".(($contact_type == \"member\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_member'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='family' \".(($contact_type == \"family\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_family'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='subscriber' \".(($contact_type == \"subscriber\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_subscriber'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='supplier' \".(($contact_type == \"supplier\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_supplier'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='provider' \".(($contact_type == \"provider\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_provider'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='user' \".(($contact_type == \"user\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_user'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='volunteer' \".(($contact_type == \"volunteer\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_volunteer'].\"</option>\\n\";\n\t\t\techo \"\t</select>\\n\";\n\t\t}\n//\t\techo \"<br />\\n\";\n//\t\techo $text['description-contact_type'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_organization'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input class='formfld' type='text' name='contact_organization' maxlength='255' value=\\\"\".escape($contact_organization).\"\\\">\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_organization'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_name_prefix'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input class='formfld' type='text' name='contact_name_prefix' maxlength='255' value=\\\"\".escape($contact_name_prefix).\"\\\">\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_name_prefix'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_name_given'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input class='formfld' type='text' name='contact_name_given' maxlength='255' value=\\\"\".escape($contact_name_given).\"\\\">\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_name_given'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_name_middle'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input class='formfld' type='text' name='contact_name_middle' maxlength='255' value=\\\"\".escape($contact_name_middle).\"\\\">\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_name_middle'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_name_family'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input class='formfld' type='text' name='contact_name_family' maxlength='255' value=\\\"\".escape($contact_name_family).\"\\\">\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_name_family'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_name_suffix'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input class='formfld' type='text' name='contact_name_suffix' maxlength='255' value=\\\"\".escape($contact_name_suffix).\"\\\">\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_name_suffix'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_nickname'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input class='formfld' type='text' name='contact_nickname' maxlength='255' value=\\\"\".escape($contact_nickname).\"\\\">\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_nickname'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_title'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\tif (is_array($_SESSION[\"contact\"][\"title\"])) {\n\t\t\tsort($_SESSION[\"contact\"][\"title\"]);\n\t\t\techo \"\t<select class='formfld' name='contact_title'>\\n\";\n\t\t\techo \"\t<option value=''></option>\\n\";\n\t\t\tforeach($_SESSION[\"contact\"][\"title\"] as $row) {\n\t\t\t\techo \"\t<option value='\".escape($row).\"' \".(($row == $contact_title) ? \"selected='selected'\" : null).\">\".escape($row).\"</option>\\n\";\n\t\t\t}\n\t\t\techo \"\t</select>\\n\";\n\t\t}\n\t\telse {\n\t\t\techo \"\t<input class='formfld' type='text' name='contact_title' maxlength='255' value=\\\"\".escape($contact_title).\"\\\">\\n\";\n\t\t}\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_title'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_category'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\tif (is_array($_SESSION[\"contact\"][\"category\"])) {\n\t\t\tsort($_SESSION[\"contact\"][\"category\"]);\n\t\t\techo \"\t<select class='formfld' name='contact_category'>\\n\";\n\t\t\techo \"\t<option value=''></option>\\n\";\n\t\t\tforeach($_SESSION[\"contact\"][\"category\"] as $row) {\n\t\t\t\techo \"\t<option value='\".escape($row).\"' \".(($row == $contact_category) ? \"selected='selected'\" : null).\">\".escape($row).\"</option>\\n\";\n\t\t\t}\n\t\t\techo \"\t</select>\\n\";\n\t\t}\n\t\telse {\n\t\t\techo \"\t<input class='formfld' type='text' name='contact_category' maxlength='255' value=\\\"\".escape($contact_category).\"\\\">\\n\";\n\t\t}\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_category'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_role'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\tif (is_array($_SESSION[\"contact\"][\"role\"])) {\n\t\t\tsort($_SESSION[\"contact\"][\"role\"]);\n\t\t\techo \"\t<select class='formfld' name='contact_role'>\\n\";\n\t\t\techo \"\t<option value=''></option>\\n\";\n\t\t\tforeach($_SESSION[\"contact\"][\"role\"] as $row) {\n\t\t\t\techo \"\t<option value='\".escape($row).\"' \".(($row == $contact_role) ? \"selected='selected'\" : null).\">\".escape($row).\"</option>\\n\";\n\t\t\t}\n\t\t\techo \"\t</select>\\n\";\n\t\t}\n\t\telse {\n\t\t\techo \"\t<input class='formfld' type='text' name='contact_role' maxlength='255' value=\\\"\".escape($contact_role).\"\\\">\\n\";\n\t\t}\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_role'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_time_zone'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input class='formfld' type='text' name='contact_time_zone' maxlength='255' value=\\\"\".escape($contact_time_zone).\"\\\">\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_time_zone'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\tif (permission_exists('contact_user_edit')) {\n\t\t\techo \"\t<tr>\";\n\t\t\techo \"\t\t<td class='vncell' valign='top'>\".$text['label-users'].\"</td>\";\n\t\t\techo \"\t\t<td class='vtable' align='left'>\";\n\t\t\tif ($action == \"update\") {\n\t\t\t\techo \"\t\t\t<table border='0' style='width : 235px;'>\\n\";\n\t\t\t\tforeach($contact_users as $field) {\n\t\t\t\t\techo \"\t\t\t<tr>\\n\";\n\t\t\t\t\techo \"\t\t\t\t<td class='vtable'>\".escape($field['username']).\"</td>\\n\";\n\t\t\t\t\techo \"\t\t\t\t<td style='width: 25px;' align='right'>\\n\";\n\t\t\t\t\tif (permission_exists('contact_user_delete')) {\n\t\t\t\t\t\techo \"\t\t\t\t\t<a href='contact_user_delete.php?id=\".escape($field['contact_user_uuid']).\"&contact_uuid=\".escape($contact_uuid).\"' alt='delete' onclick=\\\"return confirm(\".$text['confirm-delete'].\")\\\">$v_link_label_delete</a>\\n\";\n\t\t\t\t\t}\n\t\t\t\t\techo \"\t\t\t\t</td>\\n\";\n\t\t\t\t\techo \"\t\t\t</tr>\\n\";\n\t\t\t\t}\n\t\t\t\techo \"\t\t\t</table>\\n\";\n\t\t\t}\n\t\t\techo \"\t\t\t<br />\\n\";\n\t\t\tif (permission_exists('contact_user_add')) {\n\t\t\t\techo \"\t\t\t<select name=\\\"user_uuid\\\" class='formfld' style='width: auto;'>\\n\";\n\t\t\t\techo \"\t\t\t<option value=\\\"\\\"></option>\\n\";\n\t\t\t\tforeach($users as $field) {\n\t\t\t\t\techo \"\t\t\t<option value='\".escape($field['user_uuid']).\"'>\".escape($field['username']).\"</option>\\n\";\n\t\t\t\t}\n\t\t\t\techo \"\t\t\t</select>\";\n\t\t\t\tif ($action == \"update\") {\n\t\t\t\t\techo \"\t\t\t<input type=\\\"submit\\\" class='btn' value=\\\"\".$text['button-add'].\"\\\">\\n\";\n\t\t\t\t}\n\t\t\t\tunset($users);\n\t\t\t\techo \"\t\t\t<br>\\n\";\n\t\t\t\techo \"\t\t\t\".$text['description-users'].\"\\n\";\n\t\t\t}\n\t\t\techo \"\t\t</td>\";\n\t\t\techo \"\t</tr>\";\n\t\t}\n\n\t\tif (permission_exists('contact_group_view')) {\n\t\t\techo \"<tr>\";\n\t\t\techo \"\t<td width='30%' class='vncell' valign='top'>\".$text['label-groups'].\"</td>\";\n\t\t\techo \"\t<td width='70%' class='vtable'>\";\n\t\t\t$sql = \"select \";\n\t\t\t$sql .= \"g.*, \";\n\t\t\t$sql .= \"cg.contact_group_uuid \";\n\t\t\t$sql .= \"from \";\n\t\t\t$sql .= \"v_groups as g, \";\n\t\t\t$sql .= \"v_contact_groups as cg \";\n\t\t\t$sql .= \"where \";\n\t\t\t$sql .= \"cg.group_uuid = g.group_uuid \";\n\t\t\t$sql .= \"and cg.domain_uuid = :domain_uuid \";\n\t\t\t$sql .= \"and cg.contact_uuid = :contact_uuid \";\n\t\t\t$sql .= \"and cg.group_uuid <> :group_uuid \";\n\t\t\t$sql .= \"order by g.group_name asc \";\n\t\t\t$parameters['domain_uuid'] = $domain_uuid;\n\t\t\t$parameters['contact_uuid'] = $contact_uuid;\n\t\t\t$parameters['group_uuid'] = $_SESSION[\"user_uuid\"];\n\t\t\t$database = new database;\n\t\t\t$result = $database->select($sql, $parameters, 'all');\n\t\t\tif (is_array($result) && @sizeof($result) != 0) {\n\t\t\t\techo \"\t<table width='52%'>\\n\";\n\t\t\t\tforeach($result as $field) {\n\t\t\t\t\tif (strlen($field['group_name']) > 0) {\n\t\t\t\t\t\techo \"<tr>\\n\";\n\t\t\t\t\t\techo \"\t<td class='vtable'>\".$field['group_name'].\"</td>\\n\";\n\t\t\t\t\t\techo \"\t<td>\\n\";\n\t\t\t\t\t\tif (permission_exists('contact_group_delete') || if_group(\"superadmin\")) {\n\t\t\t\t\t\t\techo \"\t<a href='contact_group_delete.php?id=\".escape($field['contact_group_uuid']).\"&contact_uuid=\".escape($contact_uuid).\"' alt='\".$text['button-delete'].\"' onclick=\\\"return confirm('\".$text['confirm-delete'].\"')\\\">$v_link_label_delete</a>\\n\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\techo \"\t</td>\\n\";\n\t\t\t\t\t\techo \"</tr>\\n\";\n\t\t\t\t\t\t$assigned_groups[] = $field['group_uuid'];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\techo \"\t</table>\\n\";\n\t\t\t\techo \"\t<br />\\n\";\n\t\t\t}\n\t\t\tunset($sql, $parameters, $result, $field);\n\n\t\t\tif (permission_exists('contact_group_add') || if_group(\"superadmin\")) {\n\t\t\t\t$sql = \"select * from v_groups \";\n\t\t\t\t$sql .= \"where domain_uuid = :domain_uuid \";\n\t\t\t\t$sql .= \"or domain_uuid is null \";\n\t\t\t\tif (is_array($assigned_groups) && @sizeof($assigned_groups) != 0) {\n\t\t\t\t\tforeach ($assigned_groups as $index => $assigned_group) {\n\t\t\t\t\t\t$sql_where_and[] = \"group_uuid <> :group_uuid_\".$index.\" \";\n\t\t\t\t\t\t$parameters['group_uuid_'.$index] = $assigned_group;\n\t\t\t\t\t}\n\t\t\t\t\tif (is_array($sql_where_and) && @sizeof($sql_where_and) != 0) {\n\t\t\t\t\t\t$sql .= \"and \".implode(' and ', $sql_where_and).\" \";\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t$sql .= \"order by group_name asc \";\n\t\t\t\t$parameters['domain_uuid'] = $domain_uuid;\n\t\t\t\t$database = new database;\n\t\t\t\t$result = $database->select($sql, $parameters, 'all');\n\t\t\t\tunset($sql, $sql_where_and, $index, $parameters, $assigned_groups, $assigned_group);\n\n\t\t\t\tif (is_array($result) && @sizeof($result) != 0) {\n\t\t\t\t\techo \"\t<select name='group_uuid' class='formfld' style='width: auto; margin-right: 3px;'>\\n\";\n\t\t\t\t\techo \"\t\t<option value=''></option>\\n\";\n\t\t\t\t\tforeach($result as $field) {\n\t\t\t\t\t\tif ($field['group_name'] == \"superadmin\" && !if_group(\"superadmin\")) { continue; }\t//only show superadmin group to superadmins\n\t\t\t\t\t\tif ($field['group_name'] == \"admin\" && (!if_group(\"superadmin\") && !if_group(\"admin\"))) { continue; }\t//only show admin group to admins\n\t\t\t\t\t\techo \"<option value='\".escape($field['group_uuid']).\"'>\".escape($field['group_name']).\"</option>\\n\";\n\t\t\t\t\t}\n\t\t\t\t\techo \"\t</select>\";\n\n\t\t\t\t\tif ($action == \"update\") {\n\t\t\t\t\t\techo \"\t<input type='submit' name='submit' class='btn' value=\\\"\".$text['button-add'].\"\\\">\\n\";\n\t\t\t\t\t}\n\t\t\t\t\techo \"<br>\";\n\t\t\t\t}\n\t\t\t\tunset($result, $field);\n\t\t\t}\n\n\t\t\techo \"\t\t\".$text['description-groups'].\"\\n\";\n\n\t\t\techo \"\t</td>\";\n\t\t\techo \"</tr>\";\n\t\t}\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td width='30%' class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_note'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td width='70%' class='vtable' align='left'>\\n\";\n\t\techo \"  <textarea class='formfld' style='width: 100%; height: 80px;' name='contact_note'>\".escape($contact_note).\"</textarea>\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_note'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\t\techo \"\t<tr>\\n\";\n\t\techo \"\t\t<td colspan='2' align='right'>\\n\";\n\t\tif ($action == \"update\") {\n\t\t\techo \"\t\t\t\t<input type='hidden' name='contact_uuid' value='\".escape($contact_uuid).\"'>\\n\";\n\t\t}\n\t\techo \"\t\t\t<br>\";\n\t\techo \"\t\t\t<input type='submit' name='submit' class='btn' value='\".$text['button-save'].\"'>\\n\";\n\t\techo \"\t\t</td>\\n\";\n\t\techo \"\t</tr>\";\n\n\t\techo \"</table>\";\n\n\techo \"</td>\\n\";\n\n\tif ($action == \"update\") {\n\t\techo \"<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>\";\n\t\techo \"<td width='60%' valign='top'>\\n\";\n\t\t//echo \"\t<img src='contacts_vcard.php?id=$contact_uuid&type=image' width='90%'><br /><br />\\n\";\n\t\tif (permission_exists('contact_phone_view')) { require \"contact_phones.php\"; }\n\t\tif (permission_exists('contact_address_view')) { require \"contact_addresses.php\"; }\n\t\tif (permission_exists('contact_email_view')) { require \"contact_emails.php\"; }\n\t\tif (permission_exists('contact_url_view')) { require \"contact_urls.php\"; }\n\t\tif (permission_exists('contact_extension_view')) { require \"contact_extensions.php\"; }\n\t\tif (permission_exists('contact_relation_view')) { require \"contact_relations.php\"; }\n\t\tif (permission_exists('contact_note_view')) { require \"contact_notes.php\"; }\n\t\tif (permission_exists('contact_time_view')) { require \"contact_times.php\"; }\n\t\tif (permission_exists('contact_setting_view')) { require \"contact_settings.php\"; }\n\t\tif (permission_exists('contact_attachment_view')) { require \"contact_attachments.php\"; }\n\t\techo \"</td>\\n\";\n\t}\n\n\techo \"</tr>\\n\";\n\techo \"</table>\\n\";\n\techo \"<br><br>\";\n\techo \"</form>\";\n\n//include the footer\n\trequire_once \"resources/footer.php\";\n\n?>\n"], "fixing_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2008-2019\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n*/\n\n//includes\n\trequire_once \"root.php\";\n\trequire_once \"resources/require.php\";\n\trequire_once \"resources/check_auth.php\";\n\n//check permissions\n\tif (permission_exists('contact_view')) {\n\t\t//access granted\n\t}\n\telse {\n\t\techo \"access denied\";\n\t\texit;\n\t}\n\n//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n//action add or update\n\tif (is_uuid($_REQUEST[\"id\"])) {\n\t\t$action = \"update\";\n\t\t$contact_uuid = $_REQUEST[\"id\"];\n\t}\n\telse {\n\t\t$action = \"add\";\n\t}\n\n//get http post variables and set them to php variables\n\tif (count($_POST) > 0) {\n\t\t$user_uuid = $_POST[\"user_uuid\"];\n\t\t$group_uuid = $_POST['group_uuid'];\n\t\t$contact_type = $_POST[\"contact_type\"];\n\t\t$contact_organization = $_POST[\"contact_organization\"];\n\t\t$contact_name_prefix = $_POST[\"contact_name_prefix\"];\n\t\t$contact_name_given = $_POST[\"contact_name_given\"];\n\t\t$contact_name_middle = $_POST[\"contact_name_middle\"];\n\t\t$contact_name_family = $_POST[\"contact_name_family\"];\n\t\t$contact_name_suffix = $_POST[\"contact_name_suffix\"];\n\t\t$contact_nickname = $_POST[\"contact_nickname\"];\n\t\t$contact_title = $_POST[\"contact_title\"];\n\t\t$contact_category = $_POST[\"contact_category\"];\n\t\t$contact_role = $_POST[\"contact_role\"];\n\t\t$contact_time_zone = $_POST[\"contact_time_zone\"];\n\t\t$contact_note = $_POST[\"contact_note\"];\n\t}\n\n//process the form data\n\tif (count($_POST) > 0 && strlen($_POST[\"persistformvar\"]) == 0) {\n\n\t\t//set the uuid\n\t\t\tif ($action == \"update\") {\n\t\t\t\t$contact_uuid = $_POST[\"contact_uuid\"];\n\t\t\t}\n\n\t\t//check for all required data\n\t\t\t$msg = '';\n\t\t\t//if (strlen($contact_type) == 0) { $msg .= $text['message-required'].$text['label-contact_type'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_organization) == 0) { $msg .= $text['message-required'].$text['label-contact_organization'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_name_prefix) == 0) { $msg .= $text['message-required'].$text['label-contact_name_prefix'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_name_given) == 0) { $msg .= $text['message-required'].$text['label-contact_name_given'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_name_middle) == 0) { $msg .= $text['message-required'].$text['label-contact_name_middle'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_name_family) == 0) { $msg .= $text['message-required'].$text['label-contact_name_family'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_name_suffix) == 0) { $msg .= $text['message-required'].$text['label-contact_name_suffix'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_nickname) == 0) { $msg .= $text['message-required'].$text['label-contact_nickname'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_title) == 0) { $msg .= $text['message-required'].$text['label-contact_title'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_role) == 0) { $msg .= $text['message-required'].$text['label-contact_role'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_time_zone) == 0) { $msg .= $text['message-required'].$text['label-contact_time_zone'].\"<br>\\n\"; }\n\t\t\t//if (strlen($contact_note) == 0) { $msg .= $text['message-required'].$text['label-contact_note'].\"<br>\\n\"; }\n\t\t\tif (strlen($msg) > 0 && strlen($_POST[\"persistformvar\"]) == 0) {\n\t\t\t\trequire_once \"resources/header.php\";\n\t\t\t\trequire_once \"resources/persist_form_var.php\";\n\t\t\t\techo \"<div align='center'>\\n\";\n\t\t\t\techo \"<table><tr><td>\\n\";\n\t\t\t\techo $msg.\"<br />\";\n\t\t\t\techo \"</td></tr></table>\\n\";\n\t\t\t\tpersistformvar($_POST);\n\t\t\t\techo \"</div>\\n\";\n\t\t\t\trequire_once \"resources/footer.php\";\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t//add or update the database\n\t\t\tif ($_POST[\"persistformvar\"] != \"true\") {\n\n\t\t\t\t//add the contact\n\t\t\t\t\tif ($action == \"add\" && permission_exists('contact_add')) {\n\t\t\t\t\t\t$contact_uuid = uuid();\n\t\t\t\t\t\t$array['contacts'][0]['contact_uuid'] = $contact_uuid;\n\n\t\t\t\t\t\tmessage::add($text['message-add']);\n\t\t\t\t\t\t$location = \"contact_edit.php?id=\".$contact_uuid;\n\t\t\t\t\t}\n\n\t\t\t\t//update the contact\n\t\t\t\t\tif ($action == \"update\" && permission_exists('contact_edit')) {\n\t\t\t\t\t\t$array['contacts'][0]['contact_uuid'] = $contact_uuid;\n\n\t\t\t\t\t\tmessage::add($text['message-update']);\n\t\t\t\t\t\t$location = \"contact_edit.php?id=\".escape($contact_uuid);\n\t\t\t\t\t}\n\n\t\t\t\t//create array\n\t\t\t\t\tif (is_array($array) && @sizeof($array) != 0) {\n\t\t\t\t\t\t$array['contacts'][0]['domain_uuid'] = $_SESSION['domain_uuid'];\n\t\t\t\t\t\t$array['contacts'][0]['contact_type'] = $contact_type;\n\t\t\t\t\t\t$array['contacts'][0]['contact_organization'] = $contact_organization;\n\t\t\t\t\t\t$array['contacts'][0]['contact_name_prefix'] = $contact_name_prefix;\n\t\t\t\t\t\t$array['contacts'][0]['contact_name_given'] = $contact_name_given;\n\t\t\t\t\t\t$array['contacts'][0]['contact_name_middle'] = $contact_name_middle;\n\t\t\t\t\t\t$array['contacts'][0]['contact_name_family'] = $contact_name_family;\n\t\t\t\t\t\t$array['contacts'][0]['contact_name_suffix'] = $contact_name_suffix;\n\t\t\t\t\t\t$array['contacts'][0]['contact_nickname'] = $contact_nickname;\n\t\t\t\t\t\t$array['contacts'][0]['contact_title'] = $contact_title;\n\t\t\t\t\t\t$array['contacts'][0]['contact_category'] = $contact_category;\n\t\t\t\t\t\t$array['contacts'][0]['contact_role'] = $contact_role;\n\t\t\t\t\t\t$array['contacts'][0]['contact_time_zone'] = $contact_time_zone;\n\t\t\t\t\t\t$array['contacts'][0]['contact_note'] = $contact_note;\n\t\t\t\t\t\t$array['contacts'][0]['last_mod_date'] = 'now()';\n\t\t\t\t\t\t$array['contacts'][0]['last_mod_user'] = $_SESSION['username'];\n\n\t\t\t\t\t\t$p = new permissions;\n\t\t\t\t\t}\n\n\t\t\t\t//assign the contact to the user that added the contact\n\t\t\t\t\tif ($action == \"add\" && !permission_exists('contact_user_add')) {\n\t\t\t\t\t\t$user_uuid = $_SESSION[\"user_uuid\"];\n\t\t\t\t\t}\n\n\t\t\t\t//add user to contact users table\n\t\t\t\t\tif (is_uuid($user_uuid) && (permission_exists('contact_user_add') || $action == \"add\")) {\n\t\t\t\t\t\t$contact_user_uuid = uuid();\n\t\t\t\t\t\t$array['contact_users'][0]['domain_uuid'] = $domain_uuid;\n\t\t\t\t\t\t$array['contact_users'][0]['contact_user_uuid'] = $contact_user_uuid;\n\t\t\t\t\t\t$array['contact_users'][0]['contact_uuid'] = $contact_uuid;\n\t\t\t\t\t\t$array['contact_users'][0]['user_uuid'] = $user_uuid;\n\n\t\t\t\t\t\t$p->add('contact_user_add', 'temp');\n\t\t\t\t\t}\n\n\t\t\t\t//assign the contact to the group\n\t\t\t\t\tif (is_uuid($group_uuid) && permission_exists('contact_group_add')) {\n\t\t\t\t\t\t$contact_group_uuid = uuid();\n\t\t\t\t\t\t$array['contact_group'][0]['contact_group_uuid'] = $contact_group_uuid;\n\t\t\t\t\t\t$array['contact_group'][0]['domain_uuid'] = $domain_uuid;\n\t\t\t\t\t\t$array['contact_group'][0]['contact_uuid'] = $contact_uuid;\n\t\t\t\t\t\t$array['contact_group'][0]['group_uuid'] = $group_uuid;\n\n\t\t\t\t\t\t$p->add('contact_group_add', 'temp');\n\t\t\t\t\t}\n\n\t\t\t\t//execute\n\t\t\t\t\tif (is_array($array) && @sizeof($array) != 0) {\n\t\t\t\t\t\t$database = new database;\n\t\t\t\t\t\t$database->app_name = 'contacts';\n\t\t\t\t\t\t$database->app_uuid = '04481e0e-a478-c559-adad-52bd4174574c';\n\t\t\t\t\t\t$database->save($array);\n\t\t\t\t\t\tunset($array);\n\n\t\t\t\t\t\t$p->delete('contact_user_add', 'temp');\n\t\t\t\t\t\t$p->delete('contact_group_add', 'temp');\n\t\t\t\t\t}\n\n\t\t\t\t//handle redirect\n\t\t\t\t\tif ($_POST['submit'] == $text['button-add']) {\n\t\t\t\t\t\t$location = \"contact_edit.php?id=\".escape($contact_uuid);\n\t\t\t\t\t}\n\n\t\t\t\t//redirect the browser\n\t\t\t\t\theader(\"Location: \".$location);\n\t\t\t\t\texit;\n\n\t\t\t}\n\t}\n\n//pre-populate the form\n\tif (count($_GET) > 0 && $_POST[\"persistformvar\"] != \"true\") {\n\t\t$contact_uuid = $_GET[\"id\"];\n\t\t$sql = \"select * from v_contacts \";\n\t\t$sql .= \"where domain_uuid = :domain_uuid \";\n\t\t$sql .= \"and contact_uuid = :contact_uuid \";\n\t\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t\t$parameters['contact_uuid'] = $contact_uuid;\n\t\t$database = new database;\n\t\t$row = $database->select($sql, $parameters, 'row');\n\t\tif (is_array($row) && @sizeof($row) != 0) {\n\t\t\t$contact_type = $row[\"contact_type\"];\n\t\t\t$contact_organization = $row[\"contact_organization\"];\n\t\t\t$contact_name_prefix = $row[\"contact_name_prefix\"];\n\t\t\t$contact_name_given = $row[\"contact_name_given\"];\n\t\t\t$contact_name_middle = $row[\"contact_name_middle\"];\n\t\t\t$contact_name_family = $row[\"contact_name_family\"];\n\t\t\t$contact_name_suffix = $row[\"contact_name_suffix\"];\n\t\t\t$contact_nickname = $row[\"contact_nickname\"];\n\t\t\t$contact_title = $row[\"contact_title\"];\n\t\t\t$contact_category = $row[\"contact_category\"];\n\t\t\t$contact_role = $row[\"contact_role\"];\n\t\t\t$contact_time_zone = $row[\"contact_time_zone\"];\n\t\t\t$contact_note = $row[\"contact_note\"];\n\t\t}\n\t\tunset($sql, $parameters, $row);\n\t}\n\n//get the users array\n\t$sql = \"select * from v_users \";\n\t$sql .= \"where domain_uuid = :domain_uuid \";\n\t$sql .= \"order by username asc \";\n\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t$database = new database;\n\t$users = $database->select($sql, $parameters, 'all');\n\tunset($sql, $parameters);\n\n//determine if contact assigned to a user\n\tif (is_array($users) && sizeof($users) != 0) {\n\t\tforeach($users as $user) {\n\t\t\tif ($user['contact_uuid'] == $contact_uuid) {\n\t\t\t\t$contact_user_uuid = $user['user_uuid'];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n//get the users assigned to this contact\n\t$sql = \"select u.username, u.user_uuid, a.contact_user_uuid from v_contacts as c, v_users as u, v_contact_users as a \";\n\t$sql .= \"where c.contact_uuid = :contact_uuid \";\n\t$sql .= \"and c.domain_uuid = :domain_uuid \";\n\t$sql .= \"and u.user_uuid = a.user_uuid \";\n\t$sql .= \"and c.contact_uuid = a.contact_uuid \";\n\t$sql .= \"order by u.username asc \";\n\t$parameters['contact_uuid'] = $contact_uuid;\n\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t$database = new database;\n\t$contact_users = $database->select($sql, $parameters, 'all');\n\tunset($sql, $parameters);\n\n//show the header\n\trequire_once \"resources/header.php\";\n\tif ($action == \"update\") {\n\t\t$document['title'] = $text['title-contact-edit'];\n\t}\n\telse if ($action == \"add\") {\n\t\t$document['title'] = $text['title-contact-add'];\n\t}\n\n//set the mode\n\tif (isset($_SESSION['theme']['qr_image']['text'])) {\n\t\tif (strlen($_SESSION['theme']['qr_image']['text']) == 0) {\n\t\t\t$mode = '4';\n\t\t}\n\t\telse {\n\t\t\t$mode = '0';\n\t\t}\n\t}\n\telse {\n\t\t$mode = '4';\n\t}\n\n//qr code generation\n\t$_GET['type'] = \"text\";\n\t$qr_vcard = true;\n\tinclude \"contacts_vcard.php\";\n\techo \"<input type='hidden' id='qr_vcard' value=\\\"\".$qr_vcard.\"\\\">\";\n\techo \"<style>\";\n\techo \"\t#qr_code_container {\";\n\techo \"\t\tz-index: 999999; \";\n\techo \"\t\tposition: absolute; \";\n\techo \"\t\tleft: 0px; \";\n\techo \"\t\ttop: 0px; \";\n\techo \"\t\tright: 0px; \";\n\techo \"\t\tbottom: 0px; \";\n\techo \"\t\ttext-align: center; \";\n\techo \"\t\tvertical-align: middle;\";\n\techo \"\t}\";\n\techo \"\t#qr_code {\";\n\techo \"\t\tdisplay: block; \";\n\techo \"\t\twidth: 650px; \";\n\techo \"\t\theight: 650px; \";\n\techo \"\t\t-webkit-box-shadow: 0px 1px 20px #888; \";\n\techo \"\t\t-moz-box-shadow: 0px 1px 20px #888; \";\n\techo \"\t\tbox-shadow: 0px 1px 20px #888;\";\n\techo \"\t}\";\n\techo \"</style>\";\n\techo \"<script src='\".PROJECT_PATH.\"/resources/jquery/jquery.qrcode-0.8.0.min.js'></script>\";\n\techo \"<script language='JavaScript' type='text/javascript'>\";\n\techo \"\t$(document).ready(function() {\";\n\techo \"\t\t$(window).load(function() {\";\n\techo \"\t\t\t$('#qr_code').qrcode({ \";\n\techo \"\t\t\t\trender: 'canvas', \";\n\techo \"\t\t\t\tminVersion: 6, \";\n\techo \"\t\t\t\tmaxVersion: 40, \";\n\techo \"\t\t\t\tecLevel: 'H', \";\n\techo \"\t\t\t\tsize: 650, \";\n\techo \"\t\t\t\tradius: 0.2, \";\n\techo \"\t\t\t\tquiet: 6, \";\n\techo \"\t\t\t\tbackground: '#fff', \";\n\techo \"\t\t\t\tmode: \".$mode.\", \";\n\techo \"\t\t\t\tmSize: 0.2, \";\n\techo \"\t\t\t\tmPosX: 0.5, \";\n\techo \"\t\t\t\tmPosY: 0.5, \";\n\techo \"\t\t\t\timage: $('#img-buffer')[0], \";\n\techo \"\t\t\t\ttext: document.getElementById('qr_vcard').value \";\n\techo \"\t\t\t});\";\n\techo \"\t\t});\";\n\techo \"\t});\";\n\techo \"</script>\";\n\tif (isset($_SESSION['theme']['qr_image'])) {\n\t\techo \"<img id='img-buffer' src='\".$_SESSION[\"theme\"][\"qr_image\"][\"text\"].\"' style='display: none;'>\";\n\t}\n\telse {\n\t\techo \"<img id='img-buffer' src='\".PROJECT_PATH.\"/themes/\".$_SESSION[\"domain\"][\"template\"][\"name\"].\"/images/qr_code.png' style='display: none;'>\";\n\t}\n\n//show the content\n\techo \"<form method='post' name='frm' action=''>\\n\";\n\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\techo \"<tr>\\n\";\n\techo \"<td valign='top' align='left' width='30%' nowrap='nowrap'><b>\";\n\tswitch ($action) {\n\t\tcase \"add\": echo $text['header-contact-add']; break;\n\t\tcase \"update\": echo $text['header-contact-edit']; break;\n\t}\n\techo \"</b></td>\\n\";\n\techo \"<td valign='top' width='70%' align='right'>\\n\";\n\techo \"\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='contacts.php'\\\" value='\".$text['button-back'].\"'>\\n\";\n\tif ($action == \"update\") {\n\t\tif (permission_exists('contact_time_add')) {\n\t\t\t//detect timer state (and start time)\n\t\t\t$sql = \"select \";\n\t\t\t$sql .= \"time_start \";\n\t\t\t$sql .= \"from v_contact_times \";\n\t\t\t$sql .= \"where domain_uuid = :domain_uuid \";\n\t\t\t$sql .= \"and user_uuid = :user_uuid \";\n\t\t\t$sql .= \"and contact_uuid = :contact_uuid \";\n\t\t\t$sql .= \"and time_start is not null \";\n\t\t\t$sql .= \"and time_stop is null \";\n\t\t\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t\t\t$parameters['user_uuid'] = $_SESSION['user']['user_uuid'];\n\t\t\t$parameters['contact_uuid'] = $contact_uuid;\n\t\t\t$database = new database;\n\t\t\t$time_start = $database->select($sql, $parameters, 'column');\n\t\t\t$btn_mod = $time_start != '' ? \"style='background-color: #3693df; background-image: none;'\" : null;\n\t\t\tunset($sql, $parameters);\n\t\t\techo \"\t<input type='button' class='btn' \".$btn_mod.\" alt='\".$text['button-timer'].\"' \".($time_start != '' ? \"title='\".escape($time_start).\"'\" : null).\" onclick=\\\"window.open('contact_timer.php?domain_uuid=\".escape($domain_uuid).\"&contact_uuid=\".escape($contact_uuid).\"','contact_time_\".escape($contact_uuid).\"','width=300, height=375, top=30, left='+(screen.width - 350)+', menubar=no, scrollbars=no, status=no, toolbar=no, resizable=no');\\\" value='\".$text['button-timer'].\"'>\\n\";\n\t\t}\n\t\techo \"\t<input type='button' class='btn' name='' alt='\".$text['button-qr_code'].\"' onclick=\\\"$('#qr_code_container').fadeIn(400);\\\" value='\".$text['button-qr_code'].\"'>\\n\";\n\t\techo \"\t<input type='button' class='btn' name='' alt='\".$text['button-vcard'].\"' onclick=\\\"window.location='contacts_vcard.php?id=\".escape($contact_uuid).\"&type=download'\\\" value='\".$text['button-vcard'].\"'>\\n\";\n\t}\n\tif ($action == \"update\" && is_dir($_SERVER[\"DOCUMENT_ROOT\"].PROJECT_PATH.'/app/invoices')) {\n\t\techo \"\t<input type='button' class='btn' name='' alt='\".$text['button-invoices'].\"' onclick=\\\"window.location='\".PROJECT_PATH.\"/app/invoices/invoices.php?id=\".escape($contact_uuid).\"'\\\" value='\".$text['button-invoices'].\"'>\\n\";\n\t}\n\tif ($action == \"update\" && is_dir($_SERVER[\"DOCUMENT_ROOT\"].PROJECT_PATH.'/app/certificates')) {\n\t\techo \"\t<input type='button' class='btn' name='' alt='\".$text['button-certificate'].\"' onclick=\\\"window.location='\".PROJECT_PATH.\"/app/certificates/index.php?name=\".urlencode(escape($contact_name_given).\" \".escape($contact_name_family)).\"'\\\" value='\".$text['button-certificate'].\"'>\\n\";\n\t}\n\tif ($action == \"update\" && permission_exists('user_edit') && is_uuid($contact_user_uuid)) {\n\t\techo \"\t<input type='button' class='btn' name='' alt='\".$text['button-user'].\"' onclick=\\\"window.location='\".PROJECT_PATH.\"/core/users/user_edit.php?id=\".$contact_user_uuid.\"'\\\" value='\".$text['button-user'].\"'>\\n\";\n\t}\n\techo \"\t<input type='submit' name='submit' class='btn' value='\".$text['button-save'].\"'>\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\techo \"<tr>\\n\";\n\techo \"<td align=\\\"left\\\" colspan='2'>\\n\";\n\tswitch ($action) {\n\t\tcase \"add\" :\techo $text['description-contact-add'];\tbreak;\n\t\tcase \"update\" :\techo $text['description-contact-edit'];\tbreak;\n\t}\n\techo \"<br /><br />\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\techo \"</table>\\n\";\n\n\techo \"<table border='0' cellpadding='0' cellspacing='0' width='100%'>\\n\";\n\techo \"<tr>\\n\";\n\techo \"<td width='40%' valign='top' align='left' nowrap='nowrap'>\\n\";\n\n\t\techo \"<table border='0' cellpadding='0' cellspacing='0' width='100%'>\\n\";\n\t\techo \"<tr>\\n\";\n\t\techo \"<td width='30%' class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_type'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\tif (is_array($_SESSION[\"contact\"][\"type\"])) {\n\t\t\tsort($_SESSION[\"contact\"][\"type\"]);\n\t\t\techo \"\t<select class='formfld' name='contact_type'>\\n\";\n\t\t\techo \"\t\t<option value=''></option>\\n\";\n\t\t\tforeach($_SESSION[\"contact\"][\"type\"] as $row) {\n\t\t\t\techo \"\t<option value='\".escape($row).\"' \".(($row == $contact_type) ? \"selected='selected'\" : null).\">\".escape($row).\"</option>\\n\";\n\t\t\t}\n\t\t\techo \"\t</select>\\n\";\n\t\t}\n\t\telse {\n\t\t\techo \"\t<select class='formfld' name='contact_type'>\\n\";\n\t\t\techo \"\t\t<option value=''></option>\\n\";\n\t\t\techo \"\t\t<option value='customer' \".(($contact_type == \"customer\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_customer'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='contractor' \".(($contact_type == \"contractor\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_contractor'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='friend' \".(($contact_type == \"friend\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_friend'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='lead' \".(($contact_type == \"lead\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_lead'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='member' \".(($contact_type == \"member\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_member'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='family' \".(($contact_type == \"family\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_family'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='subscriber' \".(($contact_type == \"subscriber\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_subscriber'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='supplier' \".(($contact_type == \"supplier\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_supplier'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='provider' \".(($contact_type == \"provider\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_provider'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='user' \".(($contact_type == \"user\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_user'].\"</option>\\n\";\n\t\t\techo \"\t\t<option value='volunteer' \".(($contact_type == \"volunteer\") ? \"selected='selected'\" : null).\">\".$text['option-contact_type_volunteer'].\"</option>\\n\";\n\t\t\techo \"\t</select>\\n\";\n\t\t}\n//\t\techo \"<br />\\n\";\n//\t\techo $text['description-contact_type'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_organization'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input class='formfld' type='text' name='contact_organization' maxlength='255' value=\\\"\".escape($contact_organization).\"\\\">\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_organization'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_name_prefix'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input class='formfld' type='text' name='contact_name_prefix' maxlength='255' value=\\\"\".escape($contact_name_prefix).\"\\\">\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_name_prefix'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_name_given'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input class='formfld' type='text' name='contact_name_given' maxlength='255' value=\\\"\".escape($contact_name_given).\"\\\">\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_name_given'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_name_middle'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input class='formfld' type='text' name='contact_name_middle' maxlength='255' value=\\\"\".escape($contact_name_middle).\"\\\">\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_name_middle'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_name_family'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input class='formfld' type='text' name='contact_name_family' maxlength='255' value=\\\"\".escape($contact_name_family).\"\\\">\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_name_family'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_name_suffix'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input class='formfld' type='text' name='contact_name_suffix' maxlength='255' value=\\\"\".escape($contact_name_suffix).\"\\\">\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_name_suffix'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_nickname'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input class='formfld' type='text' name='contact_nickname' maxlength='255' value=\\\"\".escape($contact_nickname).\"\\\">\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_nickname'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_title'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\tif (is_array($_SESSION[\"contact\"][\"title\"])) {\n\t\t\tsort($_SESSION[\"contact\"][\"title\"]);\n\t\t\techo \"\t<select class='formfld' name='contact_title'>\\n\";\n\t\t\techo \"\t<option value=''></option>\\n\";\n\t\t\tforeach($_SESSION[\"contact\"][\"title\"] as $row) {\n\t\t\t\techo \"\t<option value='\".escape($row).\"' \".(($row == $contact_title) ? \"selected='selected'\" : null).\">\".escape($row).\"</option>\\n\";\n\t\t\t}\n\t\t\techo \"\t</select>\\n\";\n\t\t}\n\t\telse {\n\t\t\techo \"\t<input class='formfld' type='text' name='contact_title' maxlength='255' value=\\\"\".escape($contact_title).\"\\\">\\n\";\n\t\t}\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_title'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_category'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\tif (is_array($_SESSION[\"contact\"][\"category\"])) {\n\t\t\tsort($_SESSION[\"contact\"][\"category\"]);\n\t\t\techo \"\t<select class='formfld' name='contact_category'>\\n\";\n\t\t\techo \"\t<option value=''></option>\\n\";\n\t\t\tforeach($_SESSION[\"contact\"][\"category\"] as $row) {\n\t\t\t\techo \"\t<option value='\".escape($row).\"' \".(($row == $contact_category) ? \"selected='selected'\" : null).\">\".escape($row).\"</option>\\n\";\n\t\t\t}\n\t\t\techo \"\t</select>\\n\";\n\t\t}\n\t\telse {\n\t\t\techo \"\t<input class='formfld' type='text' name='contact_category' maxlength='255' value=\\\"\".escape($contact_category).\"\\\">\\n\";\n\t\t}\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_category'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_role'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\tif (is_array($_SESSION[\"contact\"][\"role\"])) {\n\t\t\tsort($_SESSION[\"contact\"][\"role\"]);\n\t\t\techo \"\t<select class='formfld' name='contact_role'>\\n\";\n\t\t\techo \"\t<option value=''></option>\\n\";\n\t\t\tforeach($_SESSION[\"contact\"][\"role\"] as $row) {\n\t\t\t\techo \"\t<option value='\".escape($row).\"' \".(($row == $contact_role) ? \"selected='selected'\" : null).\">\".escape($row).\"</option>\\n\";\n\t\t\t}\n\t\t\techo \"\t</select>\\n\";\n\t\t}\n\t\telse {\n\t\t\techo \"\t<input class='formfld' type='text' name='contact_role' maxlength='255' value=\\\"\".escape($contact_role).\"\\\">\\n\";\n\t\t}\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_role'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_time_zone'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input class='formfld' type='text' name='contact_time_zone' maxlength='255' value=\\\"\".escape($contact_time_zone).\"\\\">\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_time_zone'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\tif (permission_exists('contact_user_edit')) {\n\t\t\techo \"\t<tr>\";\n\t\t\techo \"\t\t<td class='vncell' valign='top'>\".$text['label-users'].\"</td>\";\n\t\t\techo \"\t\t<td class='vtable' align='left'>\";\n\t\t\tif ($action == \"update\") {\n\t\t\t\techo \"\t\t\t<table border='0' style='width : 235px;'>\\n\";\n\t\t\t\tforeach($contact_users as $field) {\n\t\t\t\t\techo \"\t\t\t<tr>\\n\";\n\t\t\t\t\techo \"\t\t\t\t<td class='vtable'>\".escape($field['username']).\"</td>\\n\";\n\t\t\t\t\techo \"\t\t\t\t<td style='width: 25px;' align='right'>\\n\";\n\t\t\t\t\tif (permission_exists('contact_user_delete')) {\n\t\t\t\t\t\techo \"\t\t\t\t\t<a href='contact_user_delete.php?id=\".escape($field['contact_user_uuid']).\"&contact_uuid=\".escape($contact_uuid).\"' alt='delete' onclick=\\\"return confirm(\".$text['confirm-delete'].\")\\\">$v_link_label_delete</a>\\n\";\n\t\t\t\t\t}\n\t\t\t\t\techo \"\t\t\t\t</td>\\n\";\n\t\t\t\t\techo \"\t\t\t</tr>\\n\";\n\t\t\t\t}\n\t\t\t\techo \"\t\t\t</table>\\n\";\n\t\t\t}\n\t\t\techo \"\t\t\t<br />\\n\";\n\t\t\tif (permission_exists('contact_user_add')) {\n\t\t\t\techo \"\t\t\t<select name=\\\"user_uuid\\\" class='formfld' style='width: auto;'>\\n\";\n\t\t\t\techo \"\t\t\t<option value=\\\"\\\"></option>\\n\";\n\t\t\t\tforeach($users as $field) {\n\t\t\t\t\techo \"\t\t\t<option value='\".escape($field['user_uuid']).\"'>\".escape($field['username']).\"</option>\\n\";\n\t\t\t\t}\n\t\t\t\techo \"\t\t\t</select>\";\n\t\t\t\tif ($action == \"update\") {\n\t\t\t\t\techo \"\t\t\t<input type=\\\"submit\\\" class='btn' value=\\\"\".$text['button-add'].\"\\\">\\n\";\n\t\t\t\t}\n\t\t\t\tunset($users);\n\t\t\t\techo \"\t\t\t<br>\\n\";\n\t\t\t\techo \"\t\t\t\".$text['description-users'].\"\\n\";\n\t\t\t}\n\t\t\techo \"\t\t</td>\";\n\t\t\techo \"\t</tr>\";\n\t\t}\n\n\t\tif (permission_exists('contact_group_view')) {\n\t\t\techo \"<tr>\";\n\t\t\techo \"\t<td width='30%' class='vncell' valign='top'>\".$text['label-groups'].\"</td>\";\n\t\t\techo \"\t<td width='70%' class='vtable'>\";\n\t\t\t$sql = \"select \";\n\t\t\t$sql .= \"g.*, \";\n\t\t\t$sql .= \"cg.contact_group_uuid \";\n\t\t\t$sql .= \"from \";\n\t\t\t$sql .= \"v_groups as g, \";\n\t\t\t$sql .= \"v_contact_groups as cg \";\n\t\t\t$sql .= \"where \";\n\t\t\t$sql .= \"cg.group_uuid = g.group_uuid \";\n\t\t\t$sql .= \"and cg.domain_uuid = :domain_uuid \";\n\t\t\t$sql .= \"and cg.contact_uuid = :contact_uuid \";\n\t\t\t$sql .= \"and cg.group_uuid <> :group_uuid \";\n\t\t\t$sql .= \"order by g.group_name asc \";\n\t\t\t$parameters['domain_uuid'] = $domain_uuid;\n\t\t\t$parameters['contact_uuid'] = $contact_uuid;\n\t\t\t$parameters['group_uuid'] = $_SESSION[\"user_uuid\"];\n\t\t\t$database = new database;\n\t\t\t$result = $database->select($sql, $parameters, 'all');\n\t\t\tif (is_array($result) && @sizeof($result) != 0) {\n\t\t\t\techo \"\t<table width='52%'>\\n\";\n\t\t\t\tforeach($result as $field) {\n\t\t\t\t\tif (strlen($field['group_name']) > 0) {\n\t\t\t\t\t\techo \"<tr>\\n\";\n\t\t\t\t\t\techo \"\t<td class='vtable'>\".$field['group_name'].\"</td>\\n\";\n\t\t\t\t\t\techo \"\t<td>\\n\";\n\t\t\t\t\t\tif (permission_exists('contact_group_delete') || if_group(\"superadmin\")) {\n\t\t\t\t\t\t\techo \"\t<a href='contact_group_delete.php?id=\".escape($field['contact_group_uuid']).\"&contact_uuid=\".escape($contact_uuid).\"' alt='\".$text['button-delete'].\"' onclick=\\\"return confirm('\".$text['confirm-delete'].\"')\\\">$v_link_label_delete</a>\\n\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\techo \"\t</td>\\n\";\n\t\t\t\t\t\techo \"</tr>\\n\";\n\t\t\t\t\t\t$assigned_groups[] = $field['group_uuid'];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\techo \"\t</table>\\n\";\n\t\t\t\techo \"\t<br />\\n\";\n\t\t\t}\n\t\t\tunset($sql, $parameters, $result, $field);\n\n\t\t\tif (permission_exists('contact_group_add') || if_group(\"superadmin\")) {\n\t\t\t\t$sql = \"select * from v_groups \";\n\t\t\t\t$sql .= \"where domain_uuid = :domain_uuid \";\n\t\t\t\t$sql .= \"or domain_uuid is null \";\n\t\t\t\tif (is_array($assigned_groups) && @sizeof($assigned_groups) != 0) {\n\t\t\t\t\tforeach ($assigned_groups as $index => $assigned_group) {\n\t\t\t\t\t\t$sql_where_and[] = \"group_uuid <> :group_uuid_\".$index.\" \";\n\t\t\t\t\t\t$parameters['group_uuid_'.$index] = $assigned_group;\n\t\t\t\t\t}\n\t\t\t\t\tif (is_array($sql_where_and) && @sizeof($sql_where_and) != 0) {\n\t\t\t\t\t\t$sql .= \"and \".implode(' and ', $sql_where_and).\" \";\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t$sql .= \"order by group_name asc \";\n\t\t\t\t$parameters['domain_uuid'] = $domain_uuid;\n\t\t\t\t$database = new database;\n\t\t\t\t$result = $database->select($sql, $parameters, 'all');\n\t\t\t\tunset($sql, $sql_where_and, $index, $parameters, $assigned_groups, $assigned_group);\n\n\t\t\t\tif (is_array($result) && @sizeof($result) != 0) {\n\t\t\t\t\techo \"\t<select name='group_uuid' class='formfld' style='width: auto; margin-right: 3px;'>\\n\";\n\t\t\t\t\techo \"\t\t<option value=''></option>\\n\";\n\t\t\t\t\tforeach($result as $field) {\n\t\t\t\t\t\tif ($field['group_name'] == \"superadmin\" && !if_group(\"superadmin\")) { continue; }\t//only show superadmin group to superadmins\n\t\t\t\t\t\tif ($field['group_name'] == \"admin\" && (!if_group(\"superadmin\") && !if_group(\"admin\"))) { continue; }\t//only show admin group to admins\n\t\t\t\t\t\techo \"<option value='\".escape($field['group_uuid']).\"'>\".escape($field['group_name']).\"</option>\\n\";\n\t\t\t\t\t}\n\t\t\t\t\techo \"\t</select>\";\n\n\t\t\t\t\tif ($action == \"update\") {\n\t\t\t\t\t\techo \"\t<input type='submit' name='submit' class='btn' value=\\\"\".$text['button-add'].\"\\\">\\n\";\n\t\t\t\t\t}\n\t\t\t\t\techo \"<br>\";\n\t\t\t\t}\n\t\t\t\tunset($result, $field);\n\t\t\t}\n\n\t\t\techo \"\t\t\".$text['description-groups'].\"\\n\";\n\n\t\t\techo \"\t</td>\";\n\t\t\techo \"</tr>\";\n\t\t}\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td width='30%' class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\n\t\techo \"\t\".$text['label-contact_note'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td width='70%' class='vtable' align='left'>\\n\";\n\t\techo \"  <textarea class='formfld' style='width: 100%; height: 80px;' name='contact_note'>\".escape($contact_note).\"</textarea>\\n\";\n// \t\techo \"<br />\\n\";\n// \t\techo $text['description-contact_note'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\t\techo \"\t<tr>\\n\";\n\t\techo \"\t\t<td colspan='2' align='right'>\\n\";\n\t\tif ($action == \"update\") {\n\t\t\techo \"\t\t\t\t<input type='hidden' name='contact_uuid' value='\".escape($contact_uuid).\"'>\\n\";\n\t\t}\n\t\techo \"\t\t\t<br>\";\n\t\techo \"\t\t\t<input type='submit' name='submit' class='btn' value='\".$text['button-save'].\"'>\\n\";\n\t\techo \"\t\t</td>\\n\";\n\t\techo \"\t</tr>\";\n\n\t\techo \"</table>\";\n\n\techo \"</td>\\n\";\n\n\tif ($action == \"update\") {\n\t\techo \"<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>\";\n\t\techo \"<td width='60%' valign='top'>\\n\";\n\t\t//echo \"\t<img src='contacts_vcard.php?id=$contact_uuid&type=image' width='90%'><br /><br />\\n\";\n\t\tif (permission_exists('contact_phone_view')) { require \"contact_phones.php\"; }\n\t\tif (permission_exists('contact_address_view')) { require \"contact_addresses.php\"; }\n\t\tif (permission_exists('contact_email_view')) { require \"contact_emails.php\"; }\n\t\tif (permission_exists('contact_url_view')) { require \"contact_urls.php\"; }\n\t\tif (permission_exists('contact_extension_view')) { require \"contact_extensions.php\"; }\n\t\tif (permission_exists('contact_relation_view')) { require \"contact_relations.php\"; }\n\t\tif (permission_exists('contact_note_view')) { require \"contact_notes.php\"; }\n\t\tif (permission_exists('contact_time_view')) { require \"contact_times.php\"; }\n\t\tif (permission_exists('contact_setting_view')) { require \"contact_settings.php\"; }\n\t\tif (permission_exists('contact_attachment_view')) { require \"contact_attachments.php\"; }\n\t\techo \"</td>\\n\";\n\t}\n\n\techo \"</tr>\\n\";\n\techo \"</table>\\n\";\n\techo \"<br><br>\";\n\techo \"</form>\";\n\n//include the footer\n\trequire_once \"resources/footer.php\";\n\n?>\n"], "filenames": ["app/contacts/contact_edit.php"], "buggy_code_start_loc": [349], "buggy_code_end_loc": [350], "fixing_code_start_loc": [349], "fixing_code_end_loc": [350], "type": "CWE-79", "message": "In FusionPBX up to 4.5.7, the file app\\contacts\\contact_edit.php uses an unsanitized \"query_string\" variable coming from the URL, which is reflected in HTML, leading to XSS.", "other": {"cve": {"id": "CVE-2019-16973", "sourceIdentifier": "cve@mitre.org", "published": "2019-10-22T22:15:10.603", "lastModified": "2023-02-03T21:50:52.990", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In FusionPBX up to 4.5.7, the file app\\contacts\\contact_edit.php uses an unsanitized \"query_string\" variable coming from the URL, which is reflected in HTML, leading to XSS."}, {"lang": "es", "value": "En FusionPBX versiones hasta 4.5.7, el archivo app\\contacts\\contact_edit.php utiliza una variable \"query_string\" no saneada proveniente de la URL, que es reflejada en HTML, conllevando a una vulnerabilidad de tipo XSS."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:fusionpbx:fusionpbx:*:*:*:*:*:*:*:*", "versionEndIncluding": "4.5.7", "matchCriteriaId": "A5A0C1F9-8032-46C6-8DD4-DB91FACF7330"}]}]}], "references": [{"url": "https://github.com/fusionpbx/fusionpbx/commit/cc820b2eb12a3b7070afdcb7f977f70a1d49ce49", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://resp3ctblog.wordpress.com/2019/10/19/fusionpbx-xss-6/", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/fusionpbx/fusionpbx/commit/cc820b2eb12a3b7070afdcb7f977f70a1d49ce49"}}