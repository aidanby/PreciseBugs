{"buggy_code": ["<?php\n\n##################################################\n#\n# Copyright (c) 2004-2016 OIC Group, Inc.\n#\n# This file is part of Exponent\n#\n# Exponent is free software; you can redistribute\n# it and/or modify it under the terms of the GNU\n# General Public License as published by the Free\n# Software Foundation; either version 2 of the\n# License, or (at your option) any later version.\n#\n# GPL: http://www.gnu.org/licenses/gpl.txt\n#\n##################################################\n\n/**\n * @subpackage Controllers\n * @package Modules\n */\n\nclass pixidouController extends expController {\n//    public $cacheDir = \"framework/modules/pixidou/images/\";\n\tpublic $cacheDir = \"tmp/pixidou/\";\n    public $requires_login = array(\n        'editor',\n        'exitEditor'\n    );\n\n    static function displayname() { return gt(\"Pixidou Image Editor\"); }\n    static function description() { return gt(\"Add and manage Exponent Files\"); }\n    static function author() { return \"Phillip Ball - OIC Group, Inc\"; }\n\n    static function hasSources()\n    {\n        return false;\n    }\n\n    function editor() {\n        global $user;\n        \n        $file = new expFile($this->params['id']);\n        \n        $canSaveOg = $user->id==$file->poster || $user->is_admin ? 1 : 0 ;\n\t    if (file_exists(BASE.$file->directory.$file->filename)) {\n\t\t\t$file->copyToDirectory(BASE.$this->cacheDir);\n\t\t\tassign_to_template(array(\n                'image'=>$file,\n                'update'=>$this->params['update'],\n                'saveog'=>$canSaveOg\n            ));\n\t    } else {\n\t\t    flash('error',gt('The file').' \"'.BASE.$file->directory.$file->filename.'\" '.gt('does not exist on the server.'));\n\t\t    redirect_to(array(\"controller\"=>'file',\"action\"=>'picker',\"ajax_action\"=>1,\"update\"=>$this->params['update'],\"filter\"=>$this->params['filter']));\n\t    }\n    }\n    \n    public function exitEditor() {\n\n        //eDebug($this->params,true);\n        switch ($this->params['exitType']) {\n            case 'saveAsCopy':\n                $oldimage = new expFile($this->params['fid']);                \n                $copyname = expFile::resolveDuplicateFilename($oldimage->path); \n                copy(BASE.$this->cacheDir.\"/\".$this->params['cpi'],$oldimage->directory.$copyname); //copy the edited file over to the files dir\n                $newFile = new expFile(array(\"filename\"=>$copyname)); //construct a new expFile\n                $newFile->directory = $oldimage->directory;\n                $newFile->title = $oldimage->title;\n                $newFile->shared = $oldimage->shared;\n                $newFile->mimetype = $oldimage->mimetype;\n                $newFile->posted = time();\n                $newFile->filesize = filesize(BASE.$this->cacheDir.\"/\".$this->params['cpi']);\n                $resized = getimagesize(BASE.$this->cacheDir.\"/\".$this->params['cpi']);\n                $newFile->image_width = $resized[0];\n                $newFile->image_height = $resized[1];\n                $newFile->alt = $oldimage->alt;\n                $newFile->is_image = $oldimage->is_image;\n                $newFile->save(); //Save it to the database\n\n                break;\n            case 'saveAsIs':\n                //eDebug($this->params,true);\n                $oldimage = new expFile($this->params['fid']);\n                $resized = getimagesize(BASE.$this->cacheDir.\"/\".$this->params['cpi']);\n                $oldimage->image_width = $resized[0];\n                $oldimage->image_height = $resized[1];\n                $oldimage->save();\n                copy(BASE.$this->cacheDir.\"/\".$this->params['cpi'],$oldimage->directory.$oldimage->filename); //copy the edited file over to the files dir\n                break;\n            \n            default:\n                # code...\n                break;\n        }\n        // proper file types to look for\n        $types = array(\".jpg\",\".gif\",\".png\");\n        \n        //Pixidou images directory, the editor's cache\n        $cachedir = BASE.$this->cacheDir;\n        \n        if (is_dir($cachedir) && is_readable($cachedir) ) {\n            $dh = opendir($cachedir);\n            while (($tmpfile = readdir($dh)) !== false) {\n                if (in_array(substr($tmpfile,-4,4),$types)) {\n                    $filename = $cachedir.$tmpfile;\n                    unlink($filename);\n                }\n            }\n        }\n        \n        redirect_to(array(\"controller\"=>'file',\"action\"=>'picker',\"ajax_action\"=>1,\"update\"=>$this->params['update'],\"filter\"=>$this->params['filter']));\n    }\n    \n}\n\n?>"], "fixing_code": ["<?php\n\n##################################################\n#\n# Copyright (c) 2004-2016 OIC Group, Inc.\n#\n# This file is part of Exponent\n#\n# Exponent is free software; you can redistribute\n# it and/or modify it under the terms of the GNU\n# General Public License as published by the Free\n# Software Foundation; either version 2 of the\n# License, or (at your option) any later version.\n#\n# GPL: http://www.gnu.org/licenses/gpl.txt\n#\n##################################################\n\n/**\n * @subpackage Controllers\n * @package Modules\n */\n\nclass pixidouController extends expController {\n//    public $cacheDir = \"framework/modules/pixidou/images/\";\n\tpublic $cacheDir = \"tmp/pixidou/\";\n    public $requires_login = array(\n        'editor',\n        'exitEditor'\n    );\n\n    static function displayname() { return gt(\"Pixidou Image Editor\"); }\n    static function description() { return gt(\"Add and manage Exponent Files\"); }\n    static function author() { return \"Phillip Ball - OIC Group, Inc\"; }\n\n    static function hasSources()\n    {\n        return false;\n    }\n\n    function editor() {\n        global $user;\n        \n        $file = new expFile($this->params['id']);\n        \n        $canSaveOg = $user->id==$file->poster || $user->is_admin ? 1 : 0 ;\n\t    if (file_exists(BASE.$file->directory.$file->filename)) {\n\t\t\t$file->copyToDirectory(BASE.$this->cacheDir);\n\t\t\tassign_to_template(array(\n                'image'=>$file,\n                'update'=>$this->params['update'],\n                'saveog'=>$canSaveOg\n            ));\n\t    } else {\n\t\t    flash('error',gt('The file').' \"'.BASE.$file->directory.$file->filename.'\" '.gt('does not exist on the server.'));\n\t\t    redirect_to(array(\"controller\"=>'file',\"action\"=>'picker',\"ajax_action\"=>1,\"update\"=>$this->params['update'],\"filter\"=>$this->params['filter']));\n\t    }\n    }\n    \n    public function exitEditor() {\n        // clean up parameters\n        $this->params['fid'] = intval($this->params['fid']);\n        if (!empty($this->params['cpi']) && strpos($this->params['cpi'], '..') !== false) {\n            $this->params['exitType'] = 'error';\n        }\n        switch ($this->params['exitType']) {\n            case 'saveAsCopy':\n                $oldimage = new expFile($this->params['fid']);                \n                $copyname = expFile::resolveDuplicateFilename($oldimage->path); \n                copy(BASE.$this->cacheDir.\"/\".$this->params['cpi'],$oldimage->directory.$copyname); //copy the edited file over to the files dir\n                $newFile = new expFile(array(\"filename\"=>$copyname)); //construct a new expFile\n                $newFile->directory = $oldimage->directory;\n                $newFile->title = $oldimage->title;\n                $newFile->shared = $oldimage->shared;\n                $newFile->mimetype = $oldimage->mimetype;\n                $newFile->posted = time();\n                $newFile->filesize = filesize(BASE.$this->cacheDir.\"/\".$this->params['cpi']);\n                $resized = getimagesize(BASE.$this->cacheDir.\"/\".$this->params['cpi']);\n                $newFile->image_width = $resized[0];\n                $newFile->image_height = $resized[1];\n                $newFile->alt = $oldimage->alt;\n                $newFile->is_image = $oldimage->is_image;\n                $newFile->save(); //Save it to the database\n\n                break;\n            case 'saveAsIs':\n                //eDebug($this->params,true);\n                $oldimage = new expFile($this->params['fid']);\n                $resized = getimagesize(BASE.$this->cacheDir.\"/\".$this->params['cpi']);\n                $oldimage->image_width = $resized[0];\n                $oldimage->image_height = $resized[1];\n                $oldimage->save();\n                copy(BASE.$this->cacheDir.\"/\".$this->params['cpi'],$oldimage->directory.$oldimage->filename); //copy the edited file over to the files dir\n                break;\n            \n            default:\n                # code...\n                break;\n        }\n        // proper file types to look for\n        $types = array(\".jpg\",\".gif\",\".png\");\n        \n        //Pixidou images directory, the editor's cache\n        $cachedir = BASE.$this->cacheDir;\n        \n        if (is_dir($cachedir) && is_readable($cachedir) ) {\n            $dh = opendir($cachedir);\n            while (($tmpfile = readdir($dh)) !== false) {\n                if (in_array(substr($tmpfile,-4,4),$types)) {\n                    $filename = $cachedir.$tmpfile;\n                    unlink($filename);\n                }\n            }\n        }\n        \n        redirect_to(array(\"controller\"=>'file',\"action\"=>'picker',\"ajax_action\"=>1,\"update\"=>$this->params['update'],\"filter\"=>$this->params['filter']));\n    }\n    \n}\n\n?>"], "filenames": ["framework/modules/pixidou/controllers/pixidouController.php"], "buggy_code_start_loc": [61], "buggy_code_end_loc": [63], "fixing_code_start_loc": [61], "fixing_code_end_loc": [66], "type": "CWE-434", "message": "The Pixidou Image Editor in Exponent CMS prior to v2.3.9 patch 2 could be used to upload a malicious file to any folder on the site via a cpi directory traversal.", "other": {"cve": {"id": "CVE-2016-7452", "sourceIdentifier": "cve@mitre.org", "published": "2016-11-03T10:59:07.543", "lastModified": "2018-02-27T02:29:00.393", "vulnStatus": "Modified", "descriptions": [{"lang": "en", "value": "The Pixidou Image Editor in Exponent CMS prior to v2.3.9 patch 2 could be used to upload a malicious file to any folder on the site via a cpi directory traversal."}, {"lang": "es", "value": "El Pixidou Image Editor en Exponent CMS anterior a v2.3.9 patch 2 puede ser usado para subir un archivo malicioso a cualquier carpeta en el sitio a trav\u00e9s de un salto de directorio cpi."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "HIGH", "availabilityImpact": "NONE", "baseScore": 7.5, "baseSeverity": "HIGH"}, "exploitabilityScore": 3.9, "impactScore": 3.6}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 5.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 10.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-434"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:exponentcms:exponent_cms:*:*:*:*:*:*:*:*", "versionEndIncluding": "2.3.9", "matchCriteriaId": "C723D5FF-CEE4-461B-911F-E760A7BF1805"}]}]}], "references": [{"url": "http://www.securityfocus.com/bid/93045", "source": "cve@mitre.org", "tags": ["Third Party Advisory", "VDB Entry"]}, {"url": "https://github.com/exponentcms/exponent-cms/commit/c1092f167cc6c78dc8bf9bf149946c5219413df3", "source": "cve@mitre.org", "tags": ["Issue Tracking", "Patch"]}, {"url": "https://github.com/exponentcms/exponent-cms/releases/tag/v2.4.0", "source": "cve@mitre.org"}]}, "github_commit_url": "https://github.com/exponentcms/exponent-cms/commit/c1092f167cc6c78dc8bf9bf149946c5219413df3"}}