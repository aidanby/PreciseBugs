{"buggy_code": ["<?php\n/**\n* Created by PhpStorm.\n * User: Bojidar\n* Date: 10/7/2020\n* Time: 5:50 PM\n*/\n\nuse Illuminate\\Support\\Facades\\App;\nuse Illuminate\\Support\\Facades\\Route;\n\nRoute::get('api/users/export_my_data', function (\\Illuminate\\Http\\Request $request) {\n\n    if (!is_logged()) {\n        return array('error' => 'You must be logged');\n    }\n\n    $userId = (int) $request->all()['user_id'];\n\n    $allowToExport = false;\n    if ($userId == user_id()) {\n        $allowToExport = true;\n    } else if (is_admin()) {\n        $allowToExport = true;\n    }\n\n    if ($allowToExport == false) {\n        return array('error' => 'You are now allowed to export this information.');\n    }\n\n    $exportFromTables = [];\n    $prefix = mw()->database_manager->get_prefix();\n    $tablesList = mw()->database_manager->get_tables_list(true);\n    foreach ($tablesList as $table) {\n        $table = str_replace($prefix, false, $table);\n        $columns  = Schema::getColumnListing($table);\n        if (in_array('created_by', $columns)) {\n            $exportFromTables[] = $table;\n        }\n    }\n\n    $exportData = [];\n    foreach ($exportFromTables as $exportFromTable) {\n        $getData = \\Illuminate\\Support\\Facades\\DB::table($exportFromTable)->where('created_by', $userId)->get();\n        if (!empty($getData)) {\n            $exportData[$exportFromTable] = $getData->toArray();\n        }\n    }\n\n    $json = new \\MicroweberPackages\\Export\\Formats\\JsonExport($exportData);\n    $getJson = $json->start();\n\n    if (isset($getJson['files'][0]['filepath'])) {\n        return response()->download($getJson['files'][0]['filepath'])->deleteFileAfterSend(true);\n    }\n\n})->name('api.users.export_my_data');\n\n// Admin web\nRoute::prefix(ADMIN_PREFIX)->middleware(['admin'])->namespace('\\MicroweberPackages\\User\\Http\\Controllers')->group(function () {\n    Route::get('login', 'UserLoginController@index')->name('admin.login')->middleware(['allowed_ips']);\n});\n\n\n\n// OLD API SAVE USER\nRoute::post('api/save_user', function (Request $request) {\n    if (!defined('MW_API_CALL')) {\n        define('MW_API_CALL', true);\n    }\n    if(!is_logged()){\n        App::abort(403, 'Unauthorized action.');\n    }\n    $input = Input::all();\n    return save_user($input);\n})->middleware(['api']);\n\nRoute::post('api/delete_user', function (Request $request) {\n    if (!defined('MW_API_CALL')) {\n        define('MW_API_CALL', true);\n    }\n    if(!is_admin()){\n        App::abort(403, 'Unauthorized action.');\n    }\n    $input = Input::all();\n    return delete_user($input);\n})->middleware(['api']);\n\nRoute::name('api.user.')->prefix('api/user')->middleware(['public.api'])->namespace('\\MicroweberPackages\\User\\Http\\Controllers')->group(function () {\n\n    Route::post('login', 'UserLoginController@login')->name('login')->middleware(['allowed_ips','throttle:60,1']);\n    Route::any('logout', 'UserLoginController@logout')->name('logout');\n    Route::post('register', 'UserRegisterController@register')->name('register')->middleware(['allowed_ips']);\n\n    Route::post('/forgot-password', 'UserForgotPasswordController@send')->name('password.email');\n    Route::post('/reset-password', 'UserForgotPasswordController@update')->name('password.update');\n\n    Route::post('/profile-update', 'UserProfileController@update')->name('profile.update');\n\n});\n\nRoute::name('api.')\n    ->prefix('api')\n    ->middleware(['api'])\n    ->namespace('\\MicroweberPackages\\User\\Http\\Controllers\\Api')\n    ->group(function () {\n        Route::apiResource('user', 'UserApiController');\n    });\n", "<?php\n/**\n * Created by PhpStorm.\n * User: Bojidar\n * Date: 10/5/2020\n * Time: 1:45 PM\n */\n\nuse Illuminate\\Support\\Facades\\Route;\n\n\n// Public user\n\n// route moved to src/MicroweberPackages/App/routes/web.php  because if bug\n// Route::get('login', '\\MicroweberPackages\\User\\Http\\Controllers\\UserLoginController@loginForm')->name('login');\n\n\nRoute::name('admin.')\n    ->prefix('admin')\n    ->middleware(['admin'])\n    ->namespace('\\MicroweberPackages\\User\\Http\\Controllers\\Admin')\n    ->group(function () {\n        Route::resource('user', 'UserController');\n    });\n\nRoute::namespace('\\MicroweberPackages\\User\\Http\\Controllers')->middleware(['web'])->group(function () {\n\n    Route::get('email/verify/{id}/{hash}', 'UserVerifyController@verify')->name('verification.verify')\n        ->middleware([\\MicroweberPackages\\User\\Http\\Middleware\\UserValidateEmailSignature::class]);\n\n    Route::get('email/verify-resend/{id}/{hash}', 'UserVerifyController@showResendForm')->name('verification.resend');\n    Route::post('email/verify-resend/{id}/{hash}', 'UserVerifyController@sendVerifyEmail')->name('verification.send');\n\n    Route::get('/forgot-password', 'UserForgotPasswordController@showForgotForm')->name('password.request');\n    Route::post('/forgot-password', 'UserForgotPasswordController@send')->name('password.email');\n\n    Route::get('/reset-password/{token}', 'UserForgotPasswordController@showResetForm')->name('password.reset');\n    Route::post('/reset-password', 'UserForgotPasswordController@update')->name('password.update');\n});\n\n\n"], "fixing_code": ["<?php\n/**\n* Created by PhpStorm.\n * User: Bojidar\n* Date: 10/7/2020\n* Time: 5:50 PM\n*/\n\nuse Illuminate\\Support\\Facades\\App;\nuse Illuminate\\Support\\Facades\\Route;\n\nRoute::get('api/users/export_my_data', function (\\Illuminate\\Http\\Request $request) {\n\n    if (!is_logged()) {\n        return array('error' => 'You must be logged');\n    }\n\n    $userId = (int) $request->all()['user_id'];\n\n    $allowToExport = false;\n    if ($userId == user_id()) {\n        $allowToExport = true;\n    } else if (is_admin()) {\n        $allowToExport = true;\n    }\n\n    if ($allowToExport == false) {\n        return array('error' => 'You are now allowed to export this information.');\n    }\n\n    $exportFromTables = [];\n    $prefix = mw()->database_manager->get_prefix();\n    $tablesList = mw()->database_manager->get_tables_list(true);\n    foreach ($tablesList as $table) {\n        $table = str_replace($prefix, false, $table);\n        $columns  = Schema::getColumnListing($table);\n        if (in_array('created_by', $columns)) {\n            $exportFromTables[] = $table;\n        }\n    }\n\n    $exportData = [];\n    foreach ($exportFromTables as $exportFromTable) {\n        $getData = \\Illuminate\\Support\\Facades\\DB::table($exportFromTable)->where('created_by', $userId)->get();\n        if (!empty($getData)) {\n            $exportData[$exportFromTable] = $getData->toArray();\n        }\n    }\n\n    $json = new \\MicroweberPackages\\Export\\Formats\\JsonExport($exportData);\n    $getJson = $json->start();\n\n    if (isset($getJson['files'][0]['filepath'])) {\n        return response()->download($getJson['files'][0]['filepath'])->deleteFileAfterSend(true);\n    }\n\n})->name('api.users.export_my_data');\n\n// Admin web\nRoute::prefix(ADMIN_PREFIX)->middleware(['admin'])->namespace('\\MicroweberPackages\\User\\Http\\Controllers')->group(function () {\n    Route::get('login', 'UserLoginController@index')->name('admin.login')->middleware(['allowed_ips']);\n});\n\n\n\n// OLD API SAVE USER\nRoute::post('api/save_user', function (Request $request) {\n    if (!defined('MW_API_CALL')) {\n        define('MW_API_CALL', true);\n    }\n    if(!is_logged()){\n        App::abort(403, 'Unauthorized action.');\n    }\n    $input = Input::all();\n    return save_user($input);\n})->middleware(['api']);\n\nRoute::post('api/delete_user', function (Request $request) {\n    if (!defined('MW_API_CALL')) {\n        define('MW_API_CALL', true);\n    }\n    if(!is_admin()){\n        App::abort(403, 'Unauthorized action.');\n    }\n    $input = Input::all();\n    return delete_user($input);\n})->middleware(['api']);\n\nRoute::name('api.user.')\n    ->prefix('api/user')\n    ->middleware([\n        'public.api',\n      //  \\MicroweberPackages\\App\\Http\\Middleware\\VerifyCsrfToken::class,\n        \\MicroweberPackages\\App\\Http\\Middleware\\XSS::class\n    ])\n    ->namespace('\\MicroweberPackages\\User\\Http\\Controllers')\n    ->group(function () {\n\n    Route::post('login', 'UserLoginController@login')->name('login')->middleware(['allowed_ips','throttle:60,1']);\n    Route::any('logout', 'UserLoginController@logout')->name('logout');\n    Route::post('register', 'UserRegisterController@register')->name('register')->middleware(['allowed_ips']);\n\n    Route::post('/forgot-password', 'UserForgotPasswordController@send')->name('password.email');\n    Route::post('/reset-password', 'UserForgotPasswordController@update')->name('password.update');\n\n    Route::post('/profile-update', 'UserProfileController@update')->name('profile.update');\n\n});\n\nRoute::name('api.')\n    ->prefix('api')\n    ->middleware([\n        'api',\n      //  \\MicroweberPackages\\App\\Http\\Middleware\\VerifyCsrfToken::class,\n        \\MicroweberPackages\\App\\Http\\Middleware\\XSS::class\n    ])\n    ->namespace('\\MicroweberPackages\\User\\Http\\Controllers\\Api')\n    ->group(function () {\n        Route::apiResource('user', 'UserApiController');\n    });\n", "<?php\n/**\n * Created by PhpStorm.\n * User: Bojidar\n * Date: 10/5/2020\n * Time: 1:45 PM\n */\n\nuse Illuminate\\Support\\Facades\\Route;\n\n\n// Public user\n\n// route moved to src/MicroweberPackages/App/routes/web.php  because if bug\n// Route::get('login', '\\MicroweberPackages\\User\\Http\\Controllers\\UserLoginController@loginForm')->name('login');\n\n\nRoute::name('admin.')\n    ->prefix('admin')\n    ->middleware([\n        'admin',\n       // \\MicroweberPackages\\App\\Http\\Middleware\\VerifyCsrfToken::class,\n        \\MicroweberPackages\\App\\Http\\Middleware\\XSS::class\n    ])\n    ->namespace('\\MicroweberPackages\\User\\Http\\Controllers\\Admin')\n    ->group(function () {\n        Route::resource('user', 'UserController');\n    });\n\nRoute::namespace('\\MicroweberPackages\\User\\Http\\Controllers')->middleware(['web'])->group(function () {\n\n    Route::get('email/verify/{id}/{hash}', 'UserVerifyController@verify')->name('verification.verify')\n        ->middleware([\\MicroweberPackages\\User\\Http\\Middleware\\UserValidateEmailSignature::class]);\n\n    Route::get('email/verify-resend/{id}/{hash}', 'UserVerifyController@showResendForm')->name('verification.resend');\n    Route::post('email/verify-resend/{id}/{hash}', 'UserVerifyController@sendVerifyEmail')->name('verification.send');\n\n    Route::get('/forgot-password', 'UserForgotPasswordController@showForgotForm')->name('password.request');\n    Route::post('/forgot-password', 'UserForgotPasswordController@send')->name('password.email');\n\n    Route::get('/reset-password/{token}', 'UserForgotPasswordController@showResetForm')->name('password.reset');\n    Route::post('/reset-password', 'UserForgotPasswordController@update')->name('password.update');\n});\n\n\n"], "filenames": ["src/MicroweberPackages/User/routes/api.php", "src/MicroweberPackages/User/routes/web.php"], "buggy_code_start_loc": [89, 20], "buggy_code_end_loc": [105, 21], "fixing_code_start_loc": [89, 20], "fixing_code_end_loc": [117, 25], "type": "CWE-79", "message": "Cross-site Scripting (XSS) - Stored in Packagist microweber/microweber prior to 1.2.11.", "other": {"cve": {"id": "CVE-2022-0506", "sourceIdentifier": "security@huntr.dev", "published": "2022-02-08T09:15:08.573", "lastModified": "2022-02-11T17:12:03.373", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Cross-site Scripting (XSS) - Stored in Packagist microweber/microweber prior to 1.2.11."}, {"lang": "es", "value": "Una vulnerabilidad de tipo Cross-site Scripting (XSS) - Almacenado en Packagist microweber/microweber versiones anteriores a 1.2.11"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:L/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:H", "attackVector": "LOCAL", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 7.7, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.5, "impactScore": 5.2}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 3.5}, "baseSeverity": "LOW", "exploitabilityScore": 6.8, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "security@huntr.dev", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:microweber:microweber:*:*:*:*:*:*:*:*", "versionEndExcluding": "1.2.11", "matchCriteriaId": "52D59B39-B1A3-45D1-B4C4-65BEF86F2D85"}]}]}], "references": [{"url": "https://github.com/microweber/microweber/commit/05d55f2befb1b25375ca5371875ff535d6cc5f70", "source": "security@huntr.dev", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://huntr.dev/bounties/0a5ec24c-343e-4cc4-b27b-2beb19a1c35f", "source": "security@huntr.dev", "tags": ["Exploit", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/microweber/microweber/commit/05d55f2befb1b25375ca5371875ff535d6cc5f70"}}