{"buggy_code": ["<?php\n\n/**\n * Pimcore\n *\n * This source file is available under two different licenses:\n * - GNU General Public License version 3 (GPLv3)\n * - Pimcore Commercial License (PCL)\n * Full copyright and license information is available in\n * LICENSE.md which is distributed with this source code.\n *\n *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)\n *  @license    http://www.pimcore.org/license     GPLv3 and PCL\n */\n\nnamespace CustomerManagementFrameworkBundle\\Controller\\Admin;\n\nuse CustomerManagementFrameworkBundle\\Controller\\Admin;\nuse CustomerManagementFrameworkBundle\\CustomerList\\SearchHelper;\nuse CustomerManagementFrameworkBundle\\DuplicatesIndex\\DuplicatesIndexInterface;\nuse Pimcore\\Model\\DataObject\\AbstractObject;\nuse Pimcore\\Model\\DataObject\\Service;\nuse Symfony\\Component\\HttpFoundation\\JsonResponse;\nuse Symfony\\Component\\HttpFoundation\\Request;\nuse Symfony\\Component\\HttpFoundation\\Response;\nuse Symfony\\Component\\Routing\\Annotation\\Route;\n\n/**\n * @Route(\"/duplicates\")\n */\nclass DuplicatesController extends Admin\n{\n    public function init()\n    {\n        AbstractObject::setHideUnpublished(true);\n    }\n\n    /**\n     * @Route(\"/list\")\n     *\n     * @throws \\Exception\n     */\n    public function listAction(Request $request, DuplicatesIndexInterface $duplicatesIndex): Response\n    {\n        // fetch all filters\n        $filters = $request->get('filter', []);\n        // check if filters exist\n        $customerList = null;\n        if (!empty($filters)) {\n            // build customer listing\n            $customerList = $this->getSearchHelper()->getCustomerProvider()->getList();\n            $idField = Service::getVersionDependentDatabaseColumnName('id');\n            $customerList\n                ->setOrderKey($idField)\n                ->setOrder('ASC');\n\n            /** @noinspection PhpUnhandledExceptionInspection */\n            $this->getSearchHelper()->addListingFilters($customerList, $filters, $this->getPimcoreUser());\n        }\n\n        $paginator = $duplicatesIndex->getPotentialDuplicates(\n            $request->get('page', 1),\n            50,\n            $request->get('declined'),\n            $customerList\n        );\n\n        return $this->render(\n            '@PimcoreCustomerManagementFramework/admin/duplicates/list.html.twig',\n            [\n                'paginator' => $paginator,\n                'paginationVariables' => $paginator->getPaginationData(),\n                'duplicates' => $paginator->getItems(),\n                'duplicatesView' => \\Pimcore::getContainer()->get('cmf.customer_duplicates_view'),\n                'searchBarFields' => $this->getSearchHelper()->getConfiguredSearchBarFields(),\n                'filters' => $filters,\n            ]\n        );\n    }\n\n    /**\n     * @Route(\"/decline/{id}\")\n     */\n    public function declineAction(Request $request): JsonResponse\n    {\n        try {\n            \\Pimcore::getContainer()->get('cmf.customer_duplicates_index')->declinePotentialDuplicate(\n                $request->get('id')\n            );\n\n            return new JsonResponse(['success' => true]);\n        } catch (\\Exception $e) {\n            return new JsonResponse(['success' => false, 'msg' => $e->getMessage()]);\n        }\n    }\n\n    protected function getSearchHelper(): SearchHelper\n    {\n        return \\Pimcore::getContainer()->get(SearchHelper::class);\n    }\n}\n"], "fixing_code": ["<?php\n\n/**\n * Pimcore\n *\n * This source file is available under two different licenses:\n * - GNU General Public License version 3 (GPLv3)\n * - Pimcore Commercial License (PCL)\n * Full copyright and license information is available in\n * LICENSE.md which is distributed with this source code.\n *\n *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)\n *  @license    http://www.pimcore.org/license     GPLv3 and PCL\n */\n\nnamespace CustomerManagementFrameworkBundle\\Controller\\Admin;\n\nuse CustomerManagementFrameworkBundle\\Controller\\Admin;\nuse CustomerManagementFrameworkBundle\\CustomerList\\SearchHelper;\nuse CustomerManagementFrameworkBundle\\DuplicatesIndex\\DuplicatesIndexInterface;\nuse Pimcore\\Model\\DataObject\\AbstractObject;\nuse Pimcore\\Model\\DataObject\\Service;\nuse Symfony\\Component\\HttpFoundation\\JsonResponse;\nuse Symfony\\Component\\HttpFoundation\\Request;\nuse Symfony\\Component\\HttpFoundation\\Response;\nuse Symfony\\Component\\HttpKernel\\Event\\ControllerEvent;\nuse Symfony\\Component\\Routing\\Annotation\\Route;\n\n/**\n * @Route(\"/duplicates\")\n */\nclass DuplicatesController extends Admin\n{\n    public function init()\n    {\n        AbstractObject::setHideUnpublished(true);\n    }\n\n    public function onKernelControllerEvent(ControllerEvent $event): void\n    {\n        parent::onKernelControllerEvent($event);\n        $this->checkPermission('plugin_cmf_perm_customerview');\n    }\n\n    /**\n     * @Route(\"/list\")\n     *\n     * @throws \\Exception\n     */\n    public function listAction(Request $request, DuplicatesIndexInterface $duplicatesIndex): Response\n    {\n        // fetch all filters\n        $filters = $request->get('filter', []);\n        // check if filters exist\n        $customerList = null;\n        if (!empty($filters)) {\n            // build customer listing\n            $customerList = $this->getSearchHelper()->getCustomerProvider()->getList();\n            $idField = Service::getVersionDependentDatabaseColumnName('id');\n            $customerList\n                ->setOrderKey($idField)\n                ->setOrder('ASC');\n\n            /** @noinspection PhpUnhandledExceptionInspection */\n            $this->getSearchHelper()->addListingFilters($customerList, $filters, $this->getPimcoreUser());\n        }\n\n        $paginator = $duplicatesIndex->getPotentialDuplicates(\n            $request->get('page', 1),\n            50,\n            $request->get('declined'),\n            $customerList\n        );\n\n        return $this->render(\n            '@PimcoreCustomerManagementFramework/admin/duplicates/list.html.twig',\n            [\n                'paginator' => $paginator,\n                'paginationVariables' => $paginator->getPaginationData(),\n                'duplicates' => $paginator->getItems(),\n                'duplicatesView' => \\Pimcore::getContainer()->get('cmf.customer_duplicates_view'),\n                'searchBarFields' => $this->getSearchHelper()->getConfiguredSearchBarFields(),\n                'filters' => $filters,\n            ]\n        );\n    }\n\n    /**\n     * @Route(\"/decline/{id}\")\n     */\n    public function declineAction(Request $request): JsonResponse\n    {\n        try {\n            \\Pimcore::getContainer()->get('cmf.customer_duplicates_index')->declinePotentialDuplicate(\n                $request->get('id')\n            );\n\n            return new JsonResponse(['success' => true]);\n        } catch (\\Exception $e) {\n            return new JsonResponse(['success' => false, 'msg' => $e->getMessage()]);\n        }\n    }\n\n    protected function getSearchHelper(): SearchHelper\n    {\n        return \\Pimcore::getContainer()->get(SearchHelper::class);\n    }\n}\n"], "filenames": ["src/Controller/Admin/DuplicatesController.php"], "buggy_code_start_loc": [25], "buggy_code_end_loc": [35], "fixing_code_start_loc": [26], "fixing_code_end_loc": [43], "type": "CWE-284", "message": "The Customer Management Framework (CMF) for Pimcore adds functionality for customer data management, segmentation, personalization and marketing automation. An authenticated and unauthorized user can access the list of potential duplicate users and see their data. Permissions are enforced when reaching the `/admin/customermanagementframework/duplicates/list` endpoint allowing an authenticated user without the permissions to access the endpoint and query the data available there. Unauthorized user(s) can access PII data from customers. This vulnerability has been patched in version 4.0.6.\n", "other": {"cve": {"id": "CVE-2024-21666", "sourceIdentifier": "security-advisories@github.com", "published": "2024-01-11T01:15:45.623", "lastModified": "2024-01-18T13:20:45.647", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "The Customer Management Framework (CMF) for Pimcore adds functionality for customer data management, segmentation, personalization and marketing automation. An authenticated and unauthorized user can access the list of potential duplicate users and see their data. Permissions are enforced when reaching the `/admin/customermanagementframework/duplicates/list` endpoint allowing an authenticated user without the permissions to access the endpoint and query the data available there. Unauthorized user(s) can access PII data from customers. This vulnerability has been patched in version 4.0.6.\n"}, {"lang": "es", "value": "Customer Management Framework (CMF) para Pimcore agrega funcionalidad para la gesti\u00f3n de datos de clientes, segmentaci\u00f3n, personalizaci\u00f3n y automatizaci\u00f3n de marketing. Un usuario autenticado y no autorizado puede acceder a la lista de posibles usuarios duplicados y ver sus datos. Los permisos se aplican al llegar al endpoint `/admin/customermanagementframework/duplicates/list`, lo que permite a un usuario autenticado sin permisos acceder al endpoint y consultar los datos disponibles all\u00ed. Los usuarios no autorizados pueden acceder a los datos PII de los clientes. Esta vulnerabilidad ha sido parcheada en la versi\u00f3n 4.0.6."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 6.5, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 3.6}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 6.5, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 3.6}]}, "weaknesses": [{"source": "security-advisories@github.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-284"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:pimcore:customer_management_framework:*:*:*:*:*:pimcore:*:*", "versionEndExcluding": "4.0.6", "matchCriteriaId": "09473711-86C6-485C-B865-015EEF9172BE"}]}]}], "references": [{"url": "https://github.com/pimcore/customer-data-framework/blob/b4af625ef327c58d05ef7cdf145fa749d2d4195e/src/Controller/Admin/DuplicatesController.php#L43", "source": "security-advisories@github.com", "tags": ["Issue Tracking"]}, {"url": "https://github.com/pimcore/customer-data-framework/commit/c33c0048390ef0cf98b801d46a81d0762243baa6", "source": "security-advisories@github.com", "tags": ["Patch"]}, {"url": "https://github.com/pimcore/customer-data-framework/security/advisories/GHSA-c38c-c8mh-vq68", "source": "security-advisories@github.com", "tags": ["Exploit", "Patch", "Vendor Advisory"]}]}, "github_commit_url": "https://github.com/pimcore/customer-data-framework/commit/c33c0048390ef0cf98b801d46a81d0762243baa6"}}