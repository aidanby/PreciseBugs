{"buggy_code": ["<?php\n$err = array();\n\nfunction print_done_fail($label, $bool) {\n\techo \"<li>\", $label . ' <strong style=\"color :' . (($bool) ? 'green;\">DONE' : 'red;\">FAILED') . '</strong><br />', \"</li>\\n\";\n}\n\nfunction config_exist() {\n\treturn file_exists(CONFIG_DIR);\n}\n\nfunction cache_exist() {\n\treturn file_exists(CACHE_FILE);\n}\n\nfunction check_write($num = 2) {\n\t$ok = @io_write_file(SETUPTEMP_FILE, $num);\n\treturn $ok;\n}\n\nfunction remove_checkfile() {\n\t$ok = @fs_delete(SETUPTEMP_FILE);\n\treturn $ok;\n}\n\nfunction setupid() {\n\tglobal $setupid;\n\tif (isset($_POST ['setupid'])) {\n\t\t$setupid = $_POST ['setupid'];\n\t} else {\n\t\t$setupid = system_generate_id(BLOG_BASEURL . $_SERVER ['HTTP_HOST']);\n\t}\n\n\treturn $setupid;\n}\n\nfunction getstep(&$id) {\n\tglobal $err;\n\n\t$STEPS = array(\n\t\t'locked',\n\t\t'step1',\n\t\t'step2',\n\t\t'step3'\n\t);\n\t$MAXST = count($STEPS) - 1;\n\n\t$i = 0;\n\n\t$setupid = null;\n\n\tif (!file_exists(LOCKFILE)) {\n\n\t\t$setupid = setupid();\n\n\t\tif (!$setupid)\n\t\t\tdie('Setup is running');\n\n\t\tif (!file_exists(SETUPTEMP_FILE)) {\n\t\t\tif (empty($_POST))\n\t\t\t\t$i = 0;\n\t\t\telse\n\t\t\t\t$i = 1;\n\t\t} else {\n\t\t\t$x = explode(',', io_load_file(SETUPTEMP_FILE));\n\t\t\tif ($x [0] != $setupid)\n\t\t\t\tdie('Setup is running: if you are the owner, you can delete ' . SETUPTEMP_FILE . ' to restart');\n\t\t\t$i = intval($x [1]);\n\t\t}\n\n\t\t@include (\"./setup/lib/{$STEPS[$i]}.lib.php\");\n\t\tif (!function_exists('check_step')) :\n\n\t\t\tfunction check_step() {\n\t\t\t\treturn true;\n\t\t\t}\n\t\tendif;\n\n\t\tif (check_step()) {\n\t\t\t++$i;\n\t\t\tif ($i >= $MAXST) {\n\t\t\t\tfs_delete(SETUPTEMP_FILE);\n\t\t\t\tio_write_file(LOCKFILE, \"locked\");\n\t\t\t} else {\n\t\t\t\tif ($i > 0 && !@io_write_file(SETUPTEMP_FILE, \"$setupid,$i\")) {\n\t\t\t\t\t$err [] = 'Write error';\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t$id = $STEPS [$i];\n\n\treturn $i;\n}\n\nfunction validate() {\n\tif (!ctype_alnum($_POST ['fpuser']))\n\t\t$err [] = \"{$_POST['fpuser']} is not a valid username. \n\t\tUsername must be alphanumeric and should not contain spaces.\";\n\n\tif (strlen(trim(($_POST ['fppwd']))) < 6)\n\t\t$err [] = \"Password must contain at least 6 non-space characters\";\n\n\tif (($_POST ['fppwd']) != ($_POST ['fppwd2']))\n\t\t$err [] = \"Passwords did not match\";\n\n\tif (!(preg_match('!@.*@|\\.\\.|\\,|\\;!', $_POST ['email']) || preg_match('!^.+\\@(\\[?)[a-zA-Z0-9\\.\\-]+\\.([a-zA-Z]{2,4}|[0-9]{1,3})(\\]?)$!', $_POST ['email'])))\n\t\t$err [] = \"{$_POST['email']} is not a valid email address\";\n\n\t$www = $_POST ['www'];\n\tif (!(preg_match('!^http(s)?://[\\w-]+\\.[\\w-]+(\\S+)?$!i', $www) || preg_match('!^http(s)?://localhost!', $www)))\n\t\t$err [] = \"$www is not a valid URL\";\n\tif ($www && $www [strlen($www) - 1] != '/')\n\t\t$www .= '/';\n\n\tglobal $fp_config;\n\n\t$fp_config ['general'] ['author'] = $user ['userid'] = $_POST ['fpuser'];\n\t$user ['password'] = $_POST ['fppwd'];\n\n\t$fp_config ['general'] ['www'] = $user ['www'] = $www;\n\t$fp_config ['general'] ['email'] = $user ['email'] = $_POST ['email'];\n\n\tif (isset($err)) {\n\t\t$GLOBALS ['err'] = $err;\n\t\treturn false;\n\t}\n\n\t$fp_config ['general'] ['blogid'] = system_generate_id(BLOG_ROOT . $user ['www'] . $user ['email'] . $user ['userid']);\n\n\tconfig_save();\n\n\tsystem_hashsalt_save();\n\n\tuser_add($user);\n\n\treturn true;\n}\n\nfunction print_err() {\n\tglobal $err;\n\tif (isset($err)) {\n\t\techo \"<p><big>Error!</big> \n\t\tThe following errors have been encountered processing the form:</p><ul>\";\n\t\tforeach ($err as $val) {\n\t\t\techo \"<li>$val</li>\";\n\t\t}\n\t\techo \"</ul>\";\n\t}\n}\n\n?>\n"], "fixing_code": ["<?php\n$err = array();\n\nfunction print_done_fail($label, $bool) {\n\techo \"<li>\", $label . ' <strong style=\"color :' . (($bool) ? 'green;\">DONE' : 'red;\">FAILED') . '</strong><br />', \"</li>\\n\";\n}\n\nfunction config_exist() {\n\treturn file_exists(CONFIG_DIR);\n}\n\nfunction cache_exist() {\n\treturn file_exists(CACHE_FILE);\n}\n\nfunction check_write($num = 2) {\n\t$ok = @io_write_file(SETUPTEMP_FILE, $num);\n\treturn $ok;\n}\n\nfunction remove_checkfile() {\n\t$ok = @fs_delete(SETUPTEMP_FILE);\n\treturn $ok;\n}\n\nfunction setupid() {\n\tglobal $setupid;\n\tif (isset($_POST ['setupid'])) {\n\t\t$setupid = $_POST ['setupid'];\n\t} else {\n\t\t$setupid = system_generate_id(BLOG_BASEURL . $_SERVER ['HTTP_HOST']);\n\t}\n\n\treturn $setupid;\n}\n\nfunction getstep(&$id) {\n\tglobal $err;\n\n\t$STEPS = array(\n\t\t'locked',\n\t\t'step1',\n\t\t'step2',\n\t\t'step3'\n\t);\n\t$MAXST = count($STEPS) - 1;\n\n\t$i = 0;\n\n\t$setupid = null;\n\n\tif (!file_exists(LOCKFILE)) {\n\n\t\t$setupid = setupid();\n\n\t\tif (!$setupid)\n\t\t\tdie('Setup is running');\n\n\t\tif (!file_exists(SETUPTEMP_FILE)) {\n\t\t\tif (empty($_POST))\n\t\t\t\t$i = 0;\n\t\t\telse\n\t\t\t\t$i = 1;\n\t\t} else {\n\t\t\t$x = explode(',', io_load_file(SETUPTEMP_FILE));\n\t\t\tif ($x [0] != $setupid)\n\t\t\t\tdie('Setup is running: if you are the owner, you can delete ' . SETUPTEMP_FILE . ' to restart');\n\t\t\t$i = intval($x [1]);\n\t\t}\n\n\t\t@include (\"./setup/lib/{$STEPS[$i]}.lib.php\");\n\t\tif (!function_exists('check_step')) :\n\n\t\t\tfunction check_step() {\n\t\t\t\treturn true;\n\t\t\t}\n\t\tendif;\n\n\t\tif (check_step()) {\n\t\t\t++$i;\n\t\t\tif ($i >= $MAXST) {\n\t\t\t\tfs_delete(SETUPTEMP_FILE);\n\t\t\t\tio_write_file(LOCKFILE, \"locked\");\n\t\t\t} else {\n\t\t\t\tif ($i > 0 && !@io_write_file(SETUPTEMP_FILE, \"$setupid,$i\")) {\n\t\t\t\t\t$err [] = 'Write error';\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t$id = $STEPS [$i];\n\n\treturn $i;\n}\n\nfunction validate() {\n\t$fpuser = strip_tags($_POST ['fpuser']);\n\t$fppwd = $_POST ['fppwd'];\n\t$fppwd2 = $_POST ['fppwd2'];\n\t$email = strip_tags($_POST ['email']);\n\t$www = strip_tags($_POST ['www']);\n\tif (!ctype_alnum($fpuser)) {\n\t\t$err [] = $fpuser . \" is not a valid username. \n\t\tUsername must be alphanumeric and should not contain spaces.\";\n\t}\n\tif (strlen(trim(($fppwd))) < 6) {\n\t\t$err [] = \"Password must contain at least 6 non-space characters\";\n\t}\n\tif (($fppwd) != ($fppwd2)) {\n\t\t$err [] = \"Passwords did not match\";\n\t}\n\tif (!(preg_match('!@.*@|\\.\\.|\\,|\\;!', $email) || preg_match('!^.+\\@(\\[?)[a-zA-Z0-9\\.\\-]+\\.([a-zA-Z]{2,4}|[0-9]{1,3})(\\]?)$!', $email))) {\n\t\t$err [] = $email . \" is not a valid email address\";\n\t}\n\tif (!(preg_match('!^http(s)?://[\\w-]+\\.[\\w-]+(\\S+)?$!i', $www) || preg_match('!^http(s)?://localhost!', $www)))\n\t\t$err [] = $www . \" is not a valid URL\";\n\tif ($www && $www [strlen($www) - 1] != '/') {\n\t\t$www .= '/';\n\t}\n\n\tglobal $fp_config;\n\n\t$fp_config ['general'] ['author'] = $user ['userid'] = $fpuser;\n\t$user ['password'] = $fppwd;\n\n\t$fp_config ['general'] ['www'] = $user ['www'] = $www;\n\t$fp_config ['general'] ['email'] = $user ['email'] = $email;\n\n\tif (isset($err)) {\n\t\t$GLOBALS ['err'] = $err;\n\t\treturn false;\n\t}\n\n\t$fp_config ['general'] ['blogid'] = system_generate_id(BLOG_ROOT . $user ['www'] . $user ['email'] . $user ['userid']);\n\n\tconfig_save();\n\n\tsystem_hashsalt_save();\n\n\tuser_add($user);\n\n\treturn true;\n}\n\nfunction print_err() {\n\tglobal $err;\n\tif (isset($err)) {\n\t\techo \"<p><big>Error!</big> \n\t\tThe following errors have been encountered processing the form:</p><ul>\";\n\t\tforeach ($err as $val) {\n\t\t\techo \"<li>$val</li>\";\n\t\t}\n\t\techo \"</ul>\";\n\t}\n}\n\n?>\n"], "filenames": ["setup/lib/main.lib.php"], "buggy_code_start_loc": [98], "buggy_code_end_loc": [124], "fixing_code_start_loc": [98], "fixing_code_end_loc": [129], "type": "CWE-79", "message": "Cross-site Scripting (XSS) - Reflected in GitHub repository flatpressblog/flatpress prior to 1.3.", "other": {"cve": {"id": "CVE-2023-1106", "sourceIdentifier": "security@huntr.dev", "published": "2023-03-02T02:15:41.977", "lastModified": "2023-03-03T18:57:31.980", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Cross-site Scripting (XSS) - Reflected in GitHub repository flatpressblog/flatpress prior to 1.3."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 3.9, "impactScore": 1.4}]}, "weaknesses": [{"source": "security@huntr.dev", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:flatpress:flatpress:*:*:*:*:*:*:*:*", "versionEndExcluding": "1.3", "matchCriteriaId": "2C1FD291-99DD-40F3-96DB-D79CA8279692"}]}]}], "references": [{"url": "https://github.com/flatpressblog/flatpress/commit/5f23b4c2eac294cc0ba5e541f83a6f8a26f9fed1", "source": "security@huntr.dev", "tags": ["Patch"]}, {"url": "https://huntr.dev/bounties/1288ec00-f69d-4b84-abce-efc9a97941a0", "source": "security@huntr.dev", "tags": ["Exploit", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/flatpressblog/flatpress/commit/5f23b4c2eac294cc0ba5e541f83a6f8a26f9fed1"}}