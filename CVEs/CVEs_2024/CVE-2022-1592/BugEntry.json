{"buggy_code": ["# Change Log\nAll notable changes to this project will be documented in this file.\nThis project adheres to [Semantic Versioning](http://semver.org/).\n\nAbout changelog [here](https://keepachangelog.com/en/1.0.0/)\n\n## []\n### Added\n- Demo cancer case gets loaded together with demo RD case in demo instance\n- Parse REVEL_score alongside REVEL_rankscore from csq field and display it on SNV variant page\n- Rank score results now show the ranking range\n- cDNA and protein changes displayed on institute causatives pages\n- Optional SESSION_TIMEOUT_MINUTES configuration in app config files\n- Script to convert old OMIM case format (list of integers) to new format (list of dictionaries)\n- Additional check for user logged in status before serving alignment files\n- Download .cgh files from cancer samples table on cancer case page\n### Changed\n- Verify user before redirecting to IGV alignments and sashimi plots\n- Build case IGV tracks starting from case and variant objects instead of passing all params in a form\n- Unfreeze Werkzeug lib since Flask_login v.0.6 with bugfix has been released\n- Sort gene panels by name (panelS and variant page)\n- Removed unused `server.blueprints.alignviewers.unindexed_remote_static` endpoint\n- User sessions to check files served by `server.blueprints.alignviewers.remote_static` endpoint\n- Moved Beacon-related functions to a dedicated app extension\n- Audit Filter now also loads filter displaying the variants for it\n### Fixed\n- Handle `attachment_filename` parameter renamed to `download_name` when Flask 2.2 will be released\n- Removed cursor timeout param in cases find adapter function to avoid many code warnings\n- Removed stream argument deprecation warning in tests\n- Handle `no intervals found` warning in load_region test\n- Beacon remove variants\n\n## [4.51]\n### Added\n- Config file containing codecov settings for pull requests\n- Add an IGV.js direct link button from case page\n- Security policy file\n- Hide/shade compound variants based on rank score on variantS from filter\n- Chromograph legend documentation direct link\n### Changed\n- Updated deprecated Codecov GitHub action to v.2\n- Simplified code of scout/adapter/mongo/variant\n- Update IGV.js to v2.11.2\n- Show summary number of variant gene panels on general report if more than 3\n### Fixed\n- Marrvel link for variants in genome build 38 (using liftover to build 37)\n- Remove flags from codecov config file\n- Fixed filter bug with high negative SPIDEX scores\n- Renamed IARC TP53 button to to `TP53 Database`, modified also link since IARC has been moved to the US NCI: `https://tp53.isb-cgc.org/`\n- Parsing new format of OMIM case info when exporting patients to Matchmaker\n- Remove flask-debugtoolbar lib dependency that is using deprecated code and causes app to crash after new release of Jinja2 (3.1)\n- Variant page crashing for cases with old OMIM terms structure (a list of integers instead of dictionary)\n- Variant page crashing when creating MARRVEL link for cases with no genome build\n- SpliceAI documentation link\n- Fix deprecated `safe_str_cmp` import from `werkzeug.security` by freezing Werkzeug lib to v2.0 until Flask_login v.0.6 with bugfix is released\n- List gene names densely in general report for SVs that contain more than 3 genes\n- Show transcript ids on refseq genes on hg19 in IGV.js, using refgene source\n- Display correct number of genes in general report for SVs that contain more than 32 genes\n- Broken Google login after new major release of `lepture/authlib`\n- Fix frequency and callers display on case general report\n\n## [4.50.1]\n### Fixed\n- Show matching causative STR_repid for legacy str variants (pre Stranger hgnc_id)\n\n## [4.50]\n### Added\n- Individual-specific OMIM terms\n- OMIM disease descriptions in ClinVar submission form\n- Add a toggle for melter rerun monitoring of cases\n- Add a config option to show the rerun monitoring toggle\n- Add a cli option to export cases with rerun monitoring enabled\n- Add a link to STRipy for STR variants; shallow for ARX and HOXA13\n- Hide by default variants only present in unaffected individuals in variants filters\n- OMIM terms in general case report\n- Individual-level info on OMIM and HPO terms in general case report\n- PanelApp gene link among the external links on variant page\n- Dashboard case filters fields help\n- Filter cases by OMIM terms in cases and dashboard pages\n### Fixed\n- A malformed panel id request would crash with exception: now gives user warning flash with redirect\n- Link to HPO resource file hosted on `http://purl.obolibrary.org`\n- Gene search form when gene exists only in build 38\n- Fixed odd redirect error and poor error message on missing column for gene panel csv upload\n- Typo in parse variant transcripts function\n- Modified keys name used to parse local observations (archived) frequencies to reflect change in MIP keys naming\n- Better error handling for partly broken/timed out chanjo reports\n- Broken javascript code when case Chromograph data is malformed\n- Broader space for case synopsis in general report\n- Show partial causatives on causatives and matching causatives panels\n- Partial causative assignment in cases with no OMIM or HPO terms\n- Partial causative OMIM select options in variant page\n### Changed\n- Slightly smaller and improved layout of content in case PDF report\n- Relabel more cancer variant pages somatic for navigation\n- Unify caseS nav links\n- Removed unused `add_compounds` param from variant controllers function\n- Changed default hg19 genome for IGV.js to legacy hg19_1kg_decoy to fix a few problematic loci\n- Reduce code complexity (parse/ensembl.py)\n- Silence certain fields in ClinVar export if prioritised ones exist (chrom-start-end if hgvs exist)\n- Made phenotype non-mandatory when marking a variant as partial causative\n- Only one phenotype condition type (OMIM or HPO) per variant is used in ClinVar submissions\n- ClinVar submission variant condition prefers OMIM over HPO if available\n- Use lighter version of gene objects in Omim MongoDB adapter, panels controllers, panels views and institute controllers\n- Gene-variants table size is now adaptive\n- Remove unused file upload on gene-variants page\n\n## [4.49]\n### Fixed\n- Pydantic model types for genome_build, madeline_info, peddy_ped_check and peddy_sex_check, rank_model_version and sv_rank_model_version\n- Replace `MatchMaker` with `Matchmaker` in all places visible by a user\n- Save diagnosis labels along with OMIM terms in Matchmaker Exchange submission objects\n- `libegl-mesa0_21.0.3-0ubuntu0.3~20.04.5_amd64.deb` lib not found by GitHub actions Docker build\n- Remove unused `chromograph_image_files` and `chromograph_prefixes` keys saved when creating or updating an RD case\n- Search managed variants by description and with ignore case\n### Changed\n- Introduced page margins on exported PDF reports\n- Smaller gene fonts in downloaded HPO genes PDF reports\n- Reintroduced gene coverage data in the PDF-exported general report of rare-disease cases\n- Check for existence of case report files before creating sidebar links\n- Better description of HPO and OMIM terms for patients submitted to Matchmaker Exchange\n- Remove null non-mandatory key/values when updating a case\n- Freeze WTForms<3 due to several form input rendering changes\n\n## [4.48.1]\n### Fixed\n- General case PDF report for recent cases with no pedigree\n\n## [4.48]\n### Added\n- Option to cancel a request for research variants in case page\n### Changed\n- Update igv.js to v2.10.5\n- Updated example of a case delivery report\n- Unfreeze cyvcf2\n- Builder images used in Scout Dockerfiles\n- Crash report email subject gives host name\n- Export general case report to PDF using PDFKit instead of WeasyPrint\n- Do not include coverage report in PDF case report since they might have different orientation\n- Export cancer cases's \"Coverage and QC report\" to PDF using PDFKit instead of Weasyprint\n- Updated cancer \"Coverage and QC report\" example\n- Keep portrait orientation in PDF delivery report\n- Export delivery report to PDF using PDFKit instead of Weasyprint\n- PDF export of clinical and research HPO panels using PDFKit instead of Weasyprint\n- Export gene panel report to PDF using PDFKit\n- Removed WeasyPrint lib dependency\n\n### Fixed\n- Reintroduced missing links to Swegen and Beacon and dbSNP in RD variant page, summary section\n- Demo delivery report orientation to fit new columns\n- Missing delivery report in demo case\n- Cast MNVs to SNV for test\n- Export verified variants from all institutes when user is admin\n- Cancer coverage and QC report not found for demo cancer case\n- Pull request template instructions on how to deploy to test server\n- PDF Delivery report not showing Swedac logo\n- Fix code typos\n- Disable codefactor raised by ESLint for javascript functions located on another file\n- Loading spinner stuck after downloading a PDF gene panel report\n- IGV browser crashing when file system with alignment files is not mounted\n\n## [4.47]\n### Added\n- Added CADD, GnomAD and genotype calls to variantS export\n### Changed\n- Pull request template, to illustrate how to deploy pull request branches on cg-vm1 stage server\n### Fixed\n- Compiled Docker image contains a patched version (v4.9) of chanjo-report\n\n## [4.46.1]\n### Fixed\n- Downloading of files generated within the app container (MT-report, verified variants, pedigrees, ..)\n\n## [4.46]\n### Added\n- Created a Dockefile to be used to serve the dockerized app in production\n- Modified the code to collect database params specified as env vars\n- Created a GitHub action that pushes the Dockerfile-server image to Docker Hub (scout-server-stage) every time a PR is opened\n- Created a GitHub action that pushes the Dockerfile-server image to Docker Hub (scout-server) every time a new release is created\n- Reassign MatchMaker Exchange submission to another user when a Scout user is deleted\n- Expose public API JSON gene panels endpoint, primarily to enable automated rerun checking for updates\n- Add utils for dictionary type\n- Filter institute cases using multiple HPO terms\n- Vulture GitHub action to identify and remove unused variables and imports\n### Changed\n- Updated the python config file documentation in admin guide\n- Case configuration parsing now uses Pydantic for improved typechecking and config handling\n- Removed test matrices to speed up automatic testing of PRs\n- Switch from Coveralls to Codecov to handle CI test coverage\n- Speed-up CI tests by caching installation of libs and splitting tests into randomized groups using pytest-test-groups\n- Improved LDAP login documentation\n- Use lib flask-ldapconn instead of flask_ldap3_login> to handle ldap authentication\n- Updated Managed variant documentation in user guide\n- Fix and simplify creating and editing of gene panels\n- Simplified gene variants search code\n- Increased the height of the genes track in the IGV viewer\n### Fixed\n- Validate uploaded managed variant file lines, warning the user.\n- Exporting validated variants with missing \"genes\" database key\n- No results returned when searching for gene variants using a phenotype term\n- Variants filtering by gene symbols file\n- Make gene HGNC symbols field mandatory in gene variants page and run search only on form submit\n- Make sure collaborator gene variants are still visible, even if HPO filter is used\n\n## [4.45]\n### Added\n### Changed\n- Start Scout also when loqusdbapi is not reachable\n- Clearer definition of manual standard and custom inheritance models in gene panels\n- Allow searching multiple chromosomes in filters\n### Fixed\n- Gene panel crashing on edit action\n\n## [4.44]\n### Added\n### Changed\n- Display Gene track beneath each sample track when displaying splice junctions in igv browser\n- Check outdated gene symbols and update with aliases for both RD and cancer variantS\n### Fixed\n- Added query input check and fixed the Genes API endpoint to return a json formatted error when request is malformed\n- Typo in ACMG BP6 tooltip\n\n## [4.43.1]\n### Added\n- Added database index for OMIM disease term genes\n### Changed\n### Fixed\n- Do not drop HPO terms collection when updating HPO terms via the command line\n- Do not drop disease (OMIM) terms collection when updating diseases via the command line\n\n## [4.43]\n### Added\n- Specify which collection(s) update/build indexes for\n### Fixed\n- Do not drop genes and transcripts collections when updating genes via the command line\n\n## [4.42.1]\n### Added\n### Changed\n### Fixed\n- Freeze PyMongo lib to version<4.0 to keep supporting previous MongoDB versions\n- Speed up gene panels creation and update by collecting only light gene info from database\n- Avoid case page crash on Phenomizer queries timeout\n\n## [4.42]\n### Added\n- Choose custom pinned variants to submit to MatchMaker Exchange\n- Submit structural variant as genes to the MatchMaker Exchange\n- Added function for maintainers and admins to remove gene panels\n- Admins can restore deleted gene panels\n- A development docker-compose file illustrating the scout/chanjo-report integration\n- Show AD on variants view for cancer SV (tumor and normal)\n- Cancer SV variants filter AD, AF (tumor and normal)\n- Hiding the variants score column also from cancer SVs, as for the SNVs\n### Changed\n- Enforce same case _id and display_name when updating a case\n- Enforce same individual ids, display names and affected status when updating a case\n- Improved documentation for connecting to loqusdb instances (including loqusdbapi)\n- Display and download HPO gene panels' gene symbols in italics\n- A faster-built and lighter Docker image\n- Reduce complexity of `panels` endpoint moving some code to the panels controllers\n- Update requirements to use flask-ldap3-login>=0.9.17 instead of freezing WTForm\n### Fixed\n- Use of deprecated TextField after the upgrade of WTF to v3.0\n- Freeze to WTForms to version < 3\n- Remove the extra files (bed files and madeline.svg) introduced by mistake\n- Cli command loading demo data in docker-compose when case custom images exist and is None\n- Increased MongoDB connection serverSelectionTimeoutMS parameter to 30K (default value according to MongoDB documentation)\n- Better differentiate old obs counts 0 vs N/A\n- Broken cancer variants page when default gene panel was deleted\n- Typo in tx_overview function in variant controllers file\n- Fixed loqusdbapi SV search URL\n- SV variants filtering using Decipher criterion\n- Removing old gene panels that don't contain the `maintainer` key.\n\n## [4.41.1]\n### Fixed\n- General reports crash for variant annotations with same variant on other cases\n\n## [4.41]\n### Added\n- Extended the instructions for running the Scout Docker image (web app and cli).\n- Enabled inclusion of custom images to STR variant view\n### Fixed\n- General case report sorting comments for variants with None genetic models\n- Do not crash but redirect to variants page with error when a variant is not found for a case\n- UCSC links coordinates for SV variants with start chromosome different than end chromosome\n- Human readable variants name in case page for variants having start chromosome different from end chromosome\n- Avoid always loading all transcripts when checking gene symbol: introduce gene captions\n- Slow queries for evaluated variants on e.g. case page - use events instead\n### Changed\n- Rearrange variant page again, moving severity predictions down.\n- More reactive layout width steps on variant page\n\n## [4.40.1]\n### Added\n### Fixed\n- Variants dismissed with inconsistent inheritance pattern can again be shown in general case report\n- General report page for variants with genes=None\n- General report crashing when variants have no panels\n- Added other missing keys to case and variant dictionaries passed to general report\n### Changed\n\n## [4.40]\n### Added\n- A .cff citation file\n- Phenotype search API endpoint\n- Added pagination to phenotype API\n- Extend case search to include internal MongoDB id\n- Support for connecting to a MongoDB replica set (.py config files)\n- Support for connecting to a MongoDB replica set (.yaml config files)\n### Fixed\n- Command to load the OMIM gene panel (`scout load panel --omim`)\n- Unify style of pinned and causative variants' badges on case page\n- Removed automatic spaces after punctuation in comments\n- Remove the hardcoded number of total individuals from the variant's old observations panel\n- Send delete requests to a connected Beacon using the DELETE method\n- Layout of the SNV and SV variant page - move frequency up\n### Changed\n- Stop updating database indexes after loading exons via command line\n- Display validation status badge also for not Sanger-sequenced variants\n- Moved Frequencies, Severity and Local observations panels up in RD variants page\n- Enabled Flask CORS to communicate CORS status to js apps\n- Moved the code preparing the transcripts overview to the backend\n- Refactored and filtered json data used in general case report\n- Changed the database used in docker-compose file to use the official MongoDB v4.4 image\n- Modified the Python (3.6, 3.8) and MongoDB (3.2, 4.4, 5.0) versions used in testing matrices (GitHub actions)\n- Capitalize case search terms on institute and dashboard pages\n\n\n## [4.39]\n### Added\n- COSMIC IDs collected from CSQ field named `COSMIC`\n### Fixed\n- Link to other causative variants on variant page\n- Allow multiple COSMIC links for a cancer variant\n- Fix floating text in severity box #2808\n- Fixed MitoMap and HmtVar links for hg38 cases\n- Do not open new browser tabs when downloading files\n- Selectable IGV tracks on variant page\n- Missing splice junctions button on variant page\n- Refactor variantS representative gene selection, and use it also for cancer variant summary\n### Changed\n- Improve Javascript performance for displaying Chromograph images\n- Make ClinVar classification more evident in cancer variant page\n\n## [4.38]\n### Added\n- Option to hide Alamut button in the app config file\n### Fixed\n- Library deprecation warning fixed (insert is deprecated. Use insert_one or insert_many instead)\n- Update genes command will not trigger an update of database indices any more\n- Missing resources in temporary downloading directory when updating genes using the command line\n- Restore previous variant ACMG classification in a scrollable div\n- Loading spinner not stopping after downloading PDF case reports and variant list export\n- Add extra Alamut links higher up on variant pages\n- Improve UX for phenotypes in case page\n- Filter and export of STR variants\n- Update look of variants page navigation buttons\n### Changed\n\n## [4.37]\n### Added\n- Highlight and show version number for RefSeq MANE transcripts.\n- Added integration to a rerunner service for toggling reanalysis with updated pedigree information\n- SpliceAI display and parsing from VEP CSQ\n- Display matching tiered variants for cancer variants\n- Display a loading icon (spinner) until the page loads completely\n- Display filter badges in cancer variants list\n- Update genes from pre-downloaded file resources\n- On login, OS, browser version and screen size are saved anonymously to understand how users are using Scout\n- API returning institutes data for a given user: `/api/v1/institutes`\n- API returning case data for a given institute: `/api/v1/institutes/<institute_id>/cases`\n- Added GMS and Lund university hospital logos to login page\n- Made display of Swedac logo configurable\n- Support for displaying custom images in case view\n- Individual-specific HPO terms\n- Optional alamut_key in institute settings for Alamut Plus software\n- Case report API endpoint\n- Tooltip in case explaining that genes with genome build different than case genome build will not be added to dynamic HPO panel.\n- Add DeepVariant as a caller\n### Fixed\n- Updated IGV to v2.8.5 to solve missing gene labels on some zoom levels\n- Demo cancer case config file to load somatic SNVs and SVs only.\n- Expand list of refseq trancripts in ClinVar submission form\n- Renamed `All SNVs and INDELs` institute sidebar element to `Search SNVs and INDELs` and fixed its style.\n- Add missing parameters to case load-config documentation\n- Allow creating/editing gene panels and dynamic gene panels with genes present in genome build 38\n- Bugfix broken Pytests\n- Bulk dismissing variants error due to key conversion from string to integer\n- Fix typo in index documentation\n- Fixed crash in institute settings page if \"collaborators\" key is not set in database\n- Don't stop Scout execution if LoqusDB call fails and print stacktrace to log\n- Bug when case contains custom images with value `None`\n- Bug introduced when fixing another bug in Scout-LoqusDB interaction\n- Loading of OMIM diagnoses in Scout demo instance\n- Remove the docker-compose with chanjo integration because it doesn't work yet.\n- Fixed standard docker-compose with scout demo data and database\n- Clinical variant assessments not present for pinned and causative variants on case page.\n- MatchMaker matching one node at the time only\n- Remove link from previously tiered variants badge in cancer variants page\n- Typo in gene cell on cancer variants page\n- Managed variants filter form\n### Changed\n- Better naming for variants buttons on cancer track (somatic, germline). Also show cancer research button if available.\n- Load case with missing panels in config files, but show warning.\n- Changing the (Female, Male) symbols to (F/M) letters in individuals_table and case-sma.\n- Print stacktrace if case load command fails\n- Added sort icon and a pointer to the cursor to all tables with sortable fields\n- Moved variant, gene and panel info from the basic pane to summary panel for all variants.\n- Renamed `Basics` panel to `Classify` on variant page.\n- Revamped `Basics` panel to a panel dedicated to classify variants\n- Revamped the summary panel to be more compact.\n- Added dedicated template for cancer variants\n- Removed Gene models, Gene annotations and Conservation panels for cancer variants\n- Reorganized the orders of panels for variant and cancer variant views\n- Added dedicated variant quality panel and removed relevant panes\n- A more compact case page\n- Removed OMIM genes panel\n- Make genes panel, pinned variants panel, causative variants panel and ClinVar panel scrollable on case page\n- Update to Scilifelab's 2020 logo\n- Update Gens URL to support Gens v2.0 format\n- Refactor tests for parsing case configurations\n- Updated links to HPO downloadable resources\n- Managed variants filtering defaults to all variant categories\n- Changing the (Kind) drop-down according to (Category) drop-down in Managed variant add variant\n- Moved Gens button to individuals table\n- Check resource files availability before starting updating OMIM diagnoses\n- Fix typo in `SHOW_OBSERVED_VARIANT_ARCHIVE` config param\n\n## [4.36]\n### Added\n- Parse and save splice junction tracks from case config file\n- Tooltip in observations panel, explaining that case variants with no link might be old variants, not uploaded after a case rerun\n### Fixed\n- Warning on overwriting variants with same position was no longer shown\n- Increase the height of the dropdowns to 425px\n- More indices for the case table as it grows, specifically for causatives queries\n- Splice junction tracks not centered over variant genes\n- Total number of research variants count\n- Update variants stats in case documents every time new variants are loaded\n- Bug in flashing warning messages when filtering variants\n### Changed\n- Clearer warning messages for genes and gene/gene-panels searches in variants filters\n\n## [4.35]\n### Added\n- A new index for hgnc_symbol in the hgnc_gene collection\n- A Pedigree panel in STR page\n- Display Tier I and II variants in case view causatives card for cancer cases\n### Fixed\n- Send partial file data to igv.js when visualizing sashimi plots with splice junction tracks\n- Research variants filtering by gene\n- Do not attempt to populate annotations for not loaded pinned/causatives\n- Add max-height to all dropdowns in filters\n### Changed\n- Switch off non-clinical gene warnings when filtering research variants\n- Don't display OMIM disease card in case view for cancer cases\n- Refactored Individuals and Causative card in case view for cancer cases\n- Update and style STR case report\n\n## [4.34]\n### Added\n- Saved filter lock and unlock\n- Filters can optionally be marked audited, logging the filter name, user and date on the case events and general report.\n- Added `ClinVar hits` and `Cosmic hits` in cancer SNVs filters\n- Added `ClinVar hits` to variants filter (rare disease track)\n- Load cancer demo case in docker-compose files (default and demo file)\n- Inclusive-language check using [woke](https://github.com/get-woke/woke) github action\n- Add link to HmtVar for mitochondrial variants (if VCF is annotated with HmtNote)\n- Grey background for dismissed compounds in variants list and variant page\n- Pin badge for pinned compounds in variants list and variant page\n- Support LoqusDB REST API queries\n- Add a docker-compose-matchmaker under scout/containers/development to test matchmaker locally\n- Script to investigate consequences of symbol search bug\n- Added GATK to list of SV and cancer SV callers\n### Fixed\n- Make MitoMap link work for hg38 again\n- Export Variants feature crashing when one of the variants has no primary transcripts\n- Redirect to last visited variantS page when dismissing variants from variants list\n- Improved matching of SVs Loqus occurrences in other cases\n- Remove padding from the list inside (Matching causatives from other cases) panel\n- Pass None to get_app function in CLI base since passing script_info to app factory functions was deprecated in Flask 2.0\n- Fixed failing tests due to Flask update to version 2.0\n- Speed up user events view\n- Causative view sort out of memory error\n- Use hgnc_id for gene filter query\n- Typo in case controllers displaying an error every time a patient is matched against external MatchMaker nodes\n- Do not crash while attempting an update for variant documents that are too big (> 16 MB)\n- Old STR causatives (and other variants) may not have HGNC symbols - fix sort lambda\n- Check if gene_obj has primary_transcript before trying to access it\n- Warn if a gene manually searched is in a clinical panel with an outdated name when filtering variants\n- ChrPos split js not needed on STR page yet\n### Changed\n- Remove parsing of case `genome_version`, since it's not used anywhere downstream\n- Introduce deprecation warning for Loqus configs that are not dictionaries\n- SV clinical filter no longer filters out sub 100 nt variants\n- Count cases in LoqusDB by variant type\n- Commit pulse repo badge temporarily set to weekly\n- Sort ClinVar submissions objects by ascending \"Last evaluated\" date\n- Refactored the MatchMaker integration as an extension\n- Replaced some sensitive words as suggested by woke linter\n- Documentation for load-configuration rewritten.\n- Add styles to MatchMaker matches table\n- More detailed info on the data shared in MatchMaker submission form\n\n## [4.33.1]\n### Fixed\n- Include markdown for release autodeploy docs\n- Use standard inheritance model in ClinVar (https://ftp.ncbi.nlm.nih.gov/pub/GTR/standard_terms/Mode_of_inheritance.txt)\n- Fix issue crash with variants that have been unflagged causative not being available in other causatives\n### Added\n### Changed\n\n## [4.33]\n### Fixed\n- Command line crashing when updating an individual not found in database\n- Dashboard page crashing when filters return no data\n- Cancer variants filter by chromosome\n- /api/v1/genes now searches for genes in all genome builds by default\n- Upgraded igv.js to version 2.8.1 (Fixed Unparsable bed record error)\n### Added\n- Autodeploy docs on release\n- Documentation for updating case individuals tracks\n- Filter cases and dashboard stats by analysis track\n### Changed\n- Changed from deprecated db update method\n- Pre-selected fields to run queries with in dashboard page\n- Do not filter by any institute when first accessing the dashboard\n- Removed OMIM panel in case view for cancer cases\n- Display Tier I and II variants in case view causatives panel for cancer cases\n- Refactored Individuals and Causative panels in case view for cancer cases\n\n## [4.32.1]\n### Fixed\n- iSort lint check only\n### Changed\n- Institute cases page crashing when a case has track:Null\n### Added\n\n## [4.32]\n### Added\n- Load and show MITOMAP associated diseases from VCF (INFO field: MitomapAssociatedDiseases, via HmtNote)\n- Show variant allele frequencies for mitochondrial variants (GRCh38 cases)\n- Extend \"public\" json API with diseases (OMIM) and phenotypes (HPO)\n- HPO gene list download now has option for clinical and non-clinical genes\n- Display gene splice junctions data in sashimi plots\n- Update case individuals with splice junctions tracks\n- Simple Docker compose for development with local build\n- Make Phenomodels subpanels collapsible\n- User side documentation of cytogenomics features (Gens, Chromograph, vcf2cytosure, rhocall)\n- iSort GitHub Action\n- Support LoqusDB REST API queries\n### Fixed\n- Show other causative once, even if several events point to it\n- Filtering variants by mitochondrial chromosome for cases with genome build=38\n- HPO gene search button triggers any warnings for clinical / non-existing genes also on first search\n- Fixed a bug in variants pages caused by MT variants without alt_frequency\n- Tests for CADD score parsing function\n- Fixed the look of IGV settings on SNV variant page\n- Cases analyzed once shown as `rerun`\n- Missing case track on case re-upload\n- Fixed severity rank for SO term \"regulatory region ablation\"\n### Changed\n- Refactor according to CodeFactor - mostly reuse of duplicated code\n- Phenomodels language adjustment\n- Open variants in a new window (from variants page)\n- Open overlapping and compound variants in a new window (from variant page)\n- gnomAD link points to gnomAD v.3 (build GRCh38) for mitochondrial variants.\n- Display only number of affected genes for dismissed SVs in general report\n- Chromosome build check when populating the variants filter chromosome selection\n- Display mitochondrial and rare diseases coverage report in cases with missing 'rare' track\n\n## [4.31.1]\n### Added\n### Changed\n- Remove mitochondrial and coverage report from cancer cases sidebar\n### Fixed\n- ClinVar page when dbSNP id is None\n\n## [4.31]\n### Added\n- gnomAD annotation field in admin guide\n- Export also dynamic panel genes not associated to an HPO term when downloading the HPO panel\n- Primary HGNC transcript info in variant export files\n- Show variant quality (QUAL field from vcf) in the variant summary\n- Load/update PDF gene fusion reports (clinical and research) generated with Arriba\n- Support new MANE annotations from VEP (both MANE Select and MANE Plus Clinical)\n- Display on case activity the event of a user resetting all dismissed variants\n- Support gnomAD population frequencies for mitochondrial variants\n- Anchor links in Casedata ClinVar panels to redirect after renaming individuals\n### Fixed\n- Replace old docs link www.clinicalgenomics.se/scout with new https://clinical-genomics.github.io/scout\n- Page formatting issues whenever case and variant comments contain extremely long strings with no spaces\n- Chromograph images can be one column and have scrollbar. Removed legacy code.\n- Column labels for ClinVar case submission\n- Page crashing looking for LoqusDB observation when variant doesn't exist\n- Missing inheritance models and custom inheritance models on newly created gene panels\n- Accept only numbers in managed variants filter as position and end coordinates\n- SNP id format and links in Variant page, ClinVar submission form and general report\n- Case groups tooltip triggered only when mouse is on the panel header\n### Changed\n- A more compact case groups panel\n- Added landscape orientation CSS style to cancer coverage and QC demo report\n- Improve user documentation to create and save new gene panels\n- Removed option to use space as separator when uploading gene panels\n- Separating the columns of standard and custom inheritance models in gene panels\n- Improved ClinVar instructions for users using non-English Excel\n\n## [4.30.2]\n### Added\n### Fixed\n- Use VEP RefSeq ID if RefSeq list is empty in RefSeq transcripts overview\n- Bug creating variant links for variants with no end_chrom\n### Changed\n\n## [4.30.1]\n### Added\n### Fixed\n- Cryptography dependency fixed to use version < 3.4\n### Changed\n\n## [4.30]\n### Added\n- Introduced a `reset dismiss variant` verb\n- Button to reset all dismissed variants for a case\n- Add black border to Chromograph ideograms\n- Show ClinVar annotations on variantS page\n- Added integration with GENS, copy number visualization tool\n- Added a VUS label to the manual classification variant tags\n- Add additional information to SNV verification emails\n- Tooltips documenting manual annotations from default panels\n- Case groups now show bam files from all cases on align view\n### Fixed\n- Center initial igv view on variant start with SNV/indels\n- Don't set initial igv view to negative coordinates\n- Display of GQ for SV and STR\n- Parsing of AD and related info for STRs\n- LoqusDB field in institute settings accepts only existing Loqus instances\n- Fix DECIPHER link to work after DECIPHER migrated to GRCh38\n- Removed visibility window param from igv.js genes track\n- Updated HPO download URL\n- Patch HPO download test correctly\n- Reference size on STR hover not needed (also wrong)\n- Introduced genome build check (allowed values: 37, 38, \"37\", \"38\") on case load\n- Improve case searching by assignee full name\n- Populating the LoqusDB select in institute settings\n### Changed\n- Cancer variants table header (pop freq etc)\n- Only admin users can modify LoqusDB instance in Institute settings\n- Style of case synopsis, variants and case comments\n- Switched to igv.js 2.7.5\n- Do not choke if case is missing research variants when research requested\n- Count cases in LoqusDB by variant type\n- Introduce deprecation warning for Loqus configs that are not dictionaries\n- Improve create new gene panel form validation\n- Make XM- transcripts less visible if they don't overlap with transcript refseq_id in variant page\n- Color of gene panels and comments panels on cases and variant pages\n- Do not choke if case is missing research variants when reserch requested\n\n## [4.29.1]\n### Added\n### Fixed\n- Always load STR variants regardless of RankScore threshold (hotfix)\n### Changed\n\n## [4.29]\n### Added\n- Added a page about migrating potentially breaking changes to the documentation\n- markdown_include in development requirements file\n- STR variants filter\n- Display source, Z-score, inheritance pattern for STR annotations from Stranger (>0.6.1) if available\n- Coverage and quality report to cancer view\n### Fixed\n- ACMG classification page crashing when trying to visualize a classification that was removed\n- Pretty print HGVS on gene variants (URL-decode VEP)\n- Broken or missing link in the documentation\n- Multiple gene names in ClinVar submission form\n- Inheritance model select field in ClinVar submission\n- IGV.js >2.7.0 has an issue with the gene track zoom levels - temp freeze at 2.7.0\n- Revert CORS-anywhere and introduce a local http proxy for cloud tracks\n### Changed\n\n## [4.28]\n### Added\n- Chromograph integration for displaying PNGs in case-page\n- Add VAF to cancer case general report, and remove some of its unused fields\n- Variants filter compatible with genome browser location strings\n- Support for custom public igv tracks stored on the cloud\n- Add tests to increase testing coverage\n- Update case variants count after deleting variants\n- Update IGV.js to latest (v2.7.4)\n- Bypass igv.js CORS check using `https://github.com/Rob--W/cors-anywhere`\n- Documentation on default and custom IGV.js tracks (admin docs)\n- Lock phenomodels so they're editable by admins only\n- Small case group assessment sharing\n- Tutorial and files for deploying app on containers (Kubernetes pods)\n- Canonical transcript and protein change of canonical transcript in exported variants excel sheet\n- Support for Font Awesome version 6\n- Submit to Beacon from case page sidebar\n- Hide dismissed variants in variants pages and variants export function\n- Systemd service files and instruction to deploy Scout using podman\n### Fixed\n- Bugfix: unused `chromgraph_prefix |tojson` removed\n- Freeze coloredlogs temporarily\n- Marrvel link\n- Don't show TP53 link for silent or synonymous changes\n- OMIM gene field accepts any custom number as OMIM gene\n- Fix Pytest single quote vs double quote string\n- Bug in gene variants search by similar cases and no similar case is found\n- Delete unused file `userpanel.py`\n- Primary transcripts in variant overview and general report\n- Google OAuth2 login setup in README file\n- Redirect to 'missing file'-icon if configured Chromograph file is missing\n- Javascript error in case page\n- Fix compound matching during variant loading for hg38\n- Cancer variants view containing variants dismissed with cancer-specific reasons\n- Zoom to SV variant length was missing IGV contig select\n- Tooltips on case page when case has no default gene panels\n### Changed\n- Save case variants count in case document and not in sessions\n- Style of gene panels multiselect on case page\n- Collapse/expand main HPO checkboxes in phenomodel preview\n- Replaced GQ (Genotype quality) with VAF (Variant allele frequency) in cancer variants GT table\n- Allow loading of cancer cases with no tumor_purity field\n- Truncate cDNA and protein changes in case report if longer than 20 characters\n\n\n## [4.27]\n### Added\n- Exclude one or more variant categories when running variants delete command\n### Fixed\n### Changed\n\n## [4.26.1]\n### Added\n### Fixed\n- Links with 1-letter aa codes crash on frameshift etc\n### Changed\n\n## [4.26]\n### Added\n- Extend the delete variants command to print analysis date, track, institute, status and research status\n- Delete variants by type of analysis (wgs|wes|panel)\n- Links to cBioPortal, MutanTP53, IARC TP53, OncoKB, MyCancerGenome, CIViC\n### Fixed\n- Deleted variants count\n### Changed\n- Print output of variants delete command as a tab separated table\n\n## [4.25]\n### Added\n- Command line function to remove variants from one or all cases\n### Fixed\n- Parse SMN None calls to None rather than False\n\n## [4.24.1]\n### Fixed\n- Install requirements.txt via setup file\n\n## [4.24]\n### Added\n- Institute-level phenotype models with sub-panels containing HPO and OMIM terms\n- Runnable Docker demo\n- Docker image build and push github action\n- Makefile with shortcuts to docker commands\n- Parse and save synopsis, phenotype and cohort terms from config files upon case upload\n### Fixed\n- Update dismissed variant status when variant dismissed key is missing\n- Breakpoint two IGV button now shows correct chromosome when different from bp1\n- Missing font lib in Docker image causing the PDF report download page to crash\n- Sentieon Manta calls lack Somaticscore - load anyway\n- ClinVar submissions crashing due to pinned variants that are not loaded\n- Point ExAC pLI score to new gnomad server address\n- Bug uploading cases missing phenotype terms in config file\n- STRs loaded but not shown on browser page\n- Bug when using adapter.variant.get_causatives with case_id without causatives\n- Problem with fetching \"solved\" from scout export cases cli\n- Better serialising of datetime and bson.ObjectId\n- Added `volumes` folder to .gitignore\n### Changed\n- Make matching causative and managed variants foldable on case page\n- Remove calls to PyMongo functions marked as deprecated in backend and frontend(as of version 3.7).\n- Improved `scout update individual` command\n- Export dynamic phenotypes with ordered gene lists as PDF\n\n\n## [4.23]\n### Added\n- Save custom IGV track settings\n- Show a flash message with clear info about non-valid genes when gene panel creation fails\n- CNV report link in cancer case side navigation\n- Return to comment section after editing, deleting or submitting a comment\n- Managed variants\n- MT vs 14 chromosome mean coverage stats if Scout is connected to Chanjo\n### Fixed\n- missing `vcf_cancer_sv` and `vcf_cancer_sv_research` to manual.\n- Split ClinVar multiple clnsig values (slash-separated) and strip them of underscore for annotations without accession number\n- Timeout of `All SNVs and INDELs` page when no valid gene is provided in the search\n- Round CADD (MIPv9)\n- Missing default panel value\n- Invisible other causatives lines when other causatives lack gene symbols\n### Changed\n- Do not freeze mkdocs-material to version 4.6.1\n- Remove pre-commit dependency\n\n## [4.22]\n### Added\n- Editable cases comments\n- Editable variants comments\n### Fixed\n- Empty variant activity panel\n- STRs variants popover\n- Split new ClinVar multiple significance terms for a variant\n- Edit the selected comment, not the latest\n### Changed\n- Updated RELEASE docs.\n- Pinned variants card style on the case page\n- Merged `scout export exons` and `scout view exons` commands\n\n\n## [4.21.2]\n### Added\n### Fixed\n- Do not pre-filter research variants by (case-default) gene panels\n- Show OMIM disease tooltip reliably\n### Changed\n\n## [4.21.1]\n### Added\n### Fixed\n- Small change to Pop Freq column in variants ang gene panels to avoid strange text shrinking on small screens\n- Direct use of HPO list for Clinical HPO SNV (and cancer SNV) filtering\n- PDF coverage report redirecting to login page\n### Changed\n- Remove the option to dismiss single variants from all variants pages\n- Bulk dismiss SNVs, SVs and cancer SNVs from variants pages\n\n## [4.21]\n### Added\n- Support to configure LoqusDB per institute\n- Highlight causative variants in the variants list\n- Add tests. Mostly regarding building internal datatypes.\n- Remove leading and trailing whitespaces from panel_name and display_name when panel is created\n- Mark MANE transcript in list of transcripts in \"Transcript overview\" on variant page\n- Show default panel name in case sidebar\n- Previous buttons for variants pagination\n- Adds a gh action that checks that the changelog is updated\n- Adds a gh action that deploys new releases automatically to pypi\n- Warn users if case default panels are outdated\n- Define institute-specific gene panels for filtering in institute settings\n- Use institute-specific gene panels in variants filtering\n- Show somatic VAF for pinned and causative variants on case page\n\n### Fixed\n- Report pages redirect to login instead of crashing when session expires\n- Variants filter loading in cancer variants page\n- User, Causative and Cases tables not scaling to full page\n- Improved docs for an initial production setup\n- Compatibility with latest version of Black\n- Fixed tests for Click>7\n- Clinical filter required an extra click to Filter to return variants\n- Restore pagination and shrink badges in the variants page tables\n- Removing a user from the command line now inactivates the case only if user is last assignee and case is active\n- Bugfix, LoqusDB per institute feature crashed when institute id was empty string\n- Bugfix, LoqusDB calls where missing case count\n- filter removal and upload for filters deleted from another page/other user\n- Visualize outdated gene panels info in a popover instead of a tooltip in case page side panel\n\n### Changed\n- Highlight color on normal STRs in the variants table from green to blue\n- Display breakpoints coordinates in verification emails only for structural variants\n\n\n## [4.20]\n### Added\n- Display number of filtered variants vs number of total variants in variants page\n- Search case by HPO terms\n- Dismiss variant column in the variants tables\n- Black and pre-commit packages to dev requirements\n\n### Fixed\n- Bug occurring when rerun is requested twice\n- Peddy info fields in the demo config file\n- Added load config safety check for multiple alignment files for one individual\n- Formatting of cancer variants table\n- Missing Score in SV variants table\n\n### Changed\n- Updated the documentation on how to create a new software release\n- Genome build-aware cytobands coordinates\n- Styling update of the Matchmaker card\n- Select search type in case search form\n\n\n## [4.19]\n\n### Added\n- Show internal ID for case\n- Add internal ID for downloaded CGH files\n- Export dynamic HPO gene list from case page\n- Remove users as case assignees when their account is deleted\n- Keep variants filters panel expanded when filters have been used\n\n### Fixed\n- Handle the ProxyFix ModuleNotFoundError when Werkzeug installed version is >1.0\n- General report formatting issues whenever case and variant comments contain extremely long strings with no spaces\n\n### Changed\n- Created an institute wrapper page that contains list of cases, causatives, SNVs & Indels, user list, shared data and institute settings\n- Display case name instead of case ID on clinVar submissions\n- Changed icon of sample update in clinVar submissions\n\n\n## [4.18]\n\n### Added\n- Filter cancer variants on cytoband coordinates\n- Show dismiss reasons in a badge with hover for clinical variants\n- Show an ellipsis if 10 cases or more to display with loqusdb matches\n- A new blog post for version 4.17\n- Tooltip to better describe Tumor and Normal columns in cancer variants\n- Filter cancer SNVs and SVs by chromosome coordinates\n- Default export of `Assertion method citation` to clinVar variants submission file\n- Button to export up to 500 cancer variants, filtered or not\n- Rename samples of a clinVar submission file\n\n### Fixed\n- Apply default gene panel on return to cancer variantS from variant view\n- Revert to certificate checking when asking for Chanjo reports\n- `scout download everything` command failing while downloading HPO terms\n\n### Changed\n- Turn tumor and normal allelic fraction to decimal numbers in tumor variants page\n- Moved clinVar submissions code to the institutes blueprints\n- Changed name of clinVar export files to FILENAME.Variant.csv and FILENAME.CaseData.csv\n- Switched Google login libraries from Flask-OAuthlib to Authlib\n\n\n## [4.17.1]\n\n### Fixed\n- Load cytobands for cases with chromosome build not \"37\" or \"38\"\n\n\n## [4.17]\n\n### Added\n- COSMIC badge shown in cancer variants\n- Default gene-panel in non-cancer structural view in url\n- Filter SNVs and SVs by cytoband coordinates\n- Filter cancer SNV variants by alt allele frequency in tumor\n- Correct genome build in UCSC link from structural variant page\n\n\n\n### Fixed\n- Bug in clinVar form when variant has no gene\n- Bug when sharing cases with the same institute twice\n- Page crashing when removing causative variant tag\n- Do not default to GATK caller when no caller info is provided for cancer SNVs\n\n\n## [4.16.1]\n\n### Fixed\n- Fix the fix for handling of delivery reports for rerun cases\n\n## [4.16]\n\n### Added\n- Adds possibility to add \"lims_id\" to cases. Currently only stored in database, not shown anywhere\n- Adds verification comment box to SVs (previously only available for small variants)\n- Scrollable pedigree panel\n\n### Fixed\n- Error caused by changes in WTForm (new release 2.3.x)\n- Bug in OMIM case page form, causing the page to crash when a string was provided instead of a numerical OMIM id\n- Fix Alamut link to work properly on hg38\n- Better handling of delivery reports for rerun cases\n- Small CodeFactor style issues: matchmaker results counting, a couple of incomplete tests and safer external xml\n- Fix an issue with Phenomizer introduced by CodeFactor style changes\n\n### Changed\n- Updated the version of igv.js to 2.5.4\n\n## [4.15.1]\n\n### Added\n- Display gene names in ClinVar submissions page\n- Links to Varsome in variant transcripts table\n\n### Fixed\n- Small fixes to ClinVar submission form\n- Gene panel page crash when old panel has no maintainers\n\n## [4.15]\n\n### Added\n- Clinvar CNVs IGV track\n- Gene panels can have maintainers\n- Keep variant actions (dismissed, manual rank, mosaic, acmg, comments) upon variant re-upload\n- Keep variant actions also on full case re-upload\n\n### Fixed\n- Fix the link to Ensembl for SV variants when genome build 38.\n- Arrange information in columns on variant page\n- Fix so that new cosmic identifier (COSV) is also acceptable #1304\n- Fixed COSMIC tag in INFO (outside of CSQ) to be parses as well with `&` splitter.\n- COSMIC stub URL changed to https://cancer.sanger.ac.uk/cosmic/search?q= instead.\n- Updated to a version of IGV where bigBed tracks are visualized correctly\n- Clinvar submission files are named according to the content (variant_data and case_data)\n- Always show causatives from other cases in case overview\n- Correct disease associations for gene symbol aliases that exist as separate genes\n- Re-add \"custom annotations\" for SV variants\n- The override ClinVar P/LP add-in in the Clinical Filter failed for new CSQ strings\n\n### Changed\n- Runs all CI checks in github actions\n\n## [4.14.1]\n\n### Fixed\n- Error when variant found in loqusdb is not loaded for other case\n\n## [4.14]\n\n### Added\n- Use github actions to run tests\n- Adds CLI command to update individual alignments path\n- Update HPO terms using downloaded definitions files\n- Option to use alternative flask config when running `scout serve`\n- Requirement to use loqusdb >= 2.5 if integrated\n\n### Fixed\n- Do not display Pedigree panel in cancer view\n- Do not rely on internet connection and services available when running CI tests\n- Variant loading assumes GATK if no caller set given and GATK filter status is seen in FILTER\n- Pass genome build param all the way in order to get the right gene mappings for cases with build 38\n- Parse correctly variants with zero frequency values\n- Continue even if there are problems to create a region vcf\n- STR and cancer variant navigation back to variants pages could fail\n\n### Changed\n- Improved code that sends requests to the external APIs\n- Updates ranges for user ranks to fit todays usage\n- Run coveralls on github actions instead of travis\n- Run pip checks on github actions instead of coveralls\n- For hg38 cases, change gnomAD link to point to version 3.0 (which is hg38 based)\n- Show pinned or causative STR variants a bit more human readable\n\n## [4.13.1]\n\n### Added\n### Fixed\n- Typo that caused not all clinvar conflicting interpretations to be loaded no matter what\n- Parse and retrieve clinvar annotations from VEP-annotated (VEP 97+) CSQ VCF field\n- Variant clinvar significance shown as `not provided` whenever is `Uncertain significance`\n- Phenomizer query crashing when case has no HPO terms assigned\n- Fixed a bug affecting `All SNVs and INDELs` page when variants don't have canonical transcript\n- Add gene name or id in cancer variant view\n\n### Changed\n- Cancer Variant view changed \"Variant:Transcript:Exon:HGVS\" to \"Gene:Transcript:Exon:HGVS\"\n\n## [4.13]\n\n### Added\n- ClinVar SNVs track in IGV\n- Add SMA view with SMN Copy Number data\n- Easier to assign OMIM diagnoses from case page\n- OMIM terms and specific OMIM term page\n\n### Fixed\n- Bug when adding a new gene to a panel\n- Restored missing recent delivery reports\n- Fixed style and links to other reports in case side panel\n- Deleting cases using display_name and institute not deleting its variants\n- Fixed bug that caused coordinates filter to override other filters\n- Fixed a problem with finding some INS in loqusdb\n- Layout on SV page when local observations without cases are present\n- Make scout compatible with the new HPO definition files from `http://compbio.charite.de/jenkins/`\n- General report visualization error when SNVs display names are very long\n\n\n### Changed\n\n\n## [4.12.4]\n\n### Fixed\n- Layout on SV page when local observations without cases are present\n\n## [4.12.3]\n\n### Fixed\n- Case report when causative or pinned SVs have non null allele frequencies\n\n## [4.12.2]\n\n### Fixed\n- SV variant links now take you to the SV variant page again\n- Cancer variant view has cleaner table data entries for \"N/A\" data\n- Pinned variant case level display hotfix for cancer and str - more on this later\n- Cancer variants show correct alt/ref reads mirroring alt frequency now\n- Always load all clinical STR variants even if a region load is attempted - index may be missing\n- Same case repetition in variant local observations\n\n## [4.12.1]\n\n### Fixed\n- Bug in variant.gene when gene has no HGVS description\n\n\n## [4.12]\n\n### Added\n- Accepts `alignment_path` in load config to pass bam/cram files\n- Display all phenotypes on variant page\n- Display hgvs coordinates on pinned and causatives\n- Clear panel pending changes\n- Adds option to setup the database with static files\n- Adds cli command to download the resources from CLI that scout needs\n- Adds test files for merged somatic SV and CNV; as well as merged SNV, and INDEL part of #1279\n- Allows for upload of OMIM-AUTO gene panel from static files without api-key\n\n### Fixed\n- Cancer case HPO panel variants link\n- Fix so that some drop downs have correct size\n- First IGV button in str variants page\n- Cancer case activates on SNV variants\n- Cases activate when STR variants are viewed\n- Always calculate code coverage\n- Pinned/Classification/comments in all types of variants pages\n- Null values for panel's custom_inheritance_models\n- Discrepancy between the manual disease transcripts and those in database in gene-edit page\n- ACMG classification not showing for some causatives\n- Fix bug which caused IGV.js to use hg19 reference files for hg38 data\n- Bug when multiple bam files sources with non-null values are available\n\n\n### Changed\n- Renamed `requests` file to `scout_requests`\n- Cancer variant view shows two, instead of four, decimals for allele and normal\n\n\n## [4.11.1]\n\n### Fixed\n- Institute settings page\n- Link institute settings to sharing institutes choices\n\n## [4.11.0]\n\n### Added\n- Display locus name on STR variant page\n- Alternative key `GNOMADAF_popmax` for Gnomad popmax allele frequency\n- Automatic suggestions on how to improve the code on Pull Requests\n- Parse GERP, phastCons and phyloP annotations from vep annotated CSQ fields\n- Avoid flickering comment popovers in variant list\n- Parse REVEL score from vep annotated CSQ fields\n- Allow users to modify general institute settings\n- Optionally format code automatically on commit\n- Adds command to backup vital parts `scout export database`\n- Parsing and displaying cancer SV variants from Manta annotated VCF files\n- Dismiss cancer snv variants with cancer-specific options\n- Add IGV.js UPD, RHO and TIDDIT coverage wig tracks.\n\n\n### Fixed\n- Slightly darker page background\n- Fixed an issued with parsed conservation values from CSQ\n- Clinvar submissions accessible to all users of an institute\n- Header toolbar when on Clinvar page now shows institute name correctly\n- Case should not always inactivate upon update\n- Show dismissed snv cancer variants as grey on the cancer variants page\n- Improved style of mappability link and local observations on variant page\n- Convert all the GET requests to the igv view to POST request\n- Error when updating gene panels using a file containing BOM chars\n- Add/replace gene radio button not working in gene panels\n\n\n## [4.10.1]\n\n### Fixed\n- Fixed issue with opening research variants\n- Problem with coveralls not called by Travis CI\n- Handle Biomart service down in tests\n\n\n## [4.10.0]\n\n### Added\n- Rank score model in causatives page\n- Exportable HPO terms from phenotypes page\n- AMP guideline tiers for cancer variants\n- Adds scroll for the transcript tab\n- Added CLI option to query cases on time since case event was added\n- Shadow clinical assessments also on research variants display\n- Support for CRAM alignment files\n- Improved str variants view : sorting by locus, grouped by allele.\n- Delivery report PDF export\n- New mosaicism tag option\n- Add or modify individuals' age or tissue type from case page\n- Display GC and allele depth in causatives table.\n- Included primary reference transcript in general report\n- Included partial causative variants in general report\n- Remove dependency of loqusdb by utilising the CLI\n\n### Fixed\n- Fixed update OMIM command bug due to change in the header of the genemap2 file\n- Removed Mosaic Tag from Cancer variants\n- Fixes issue with unaligned table headers that comes with hidden Datatables\n- Layout in general report PDF export\n- Fixed issue on the case statistics view. The validation bars didn't show up when all institutes were selected. Now they do.\n- Fixed missing path import by importing pathlib.Path\n- Handle index inconsistencies in the update index functions\n- Fixed layout problems\n\n\n## [4.9.0]\n\n### Added\n- Improved MatchMaker pages, including visible patient contacts email address\n- New badges for the github repo\n- Links to [GENEMANIA](genemania.org)\n- Sort gene panel list on case view.\n- More automatic tests\n- Allow loading of custom annotations in VCF using the SCOUT_CUSTOM info tag.\n\n### Fixed\n- Fix error when a gene is added to an empty dynamic gene panel\n- Fix crash when attempting to add genes on incorrect format to dynamic gene panel\n- Manual rank variant tags could be saved in a \"Select a tag\"-state, a problem in the variants view.\n- Same case evaluations are no longer shown as gray previous evaluations on the variants page\n- Stay on research pages, even if reset, next first buttons are pressed..\n- Overlapping variants will now be visible on variant page again\n- Fix missing classification comments and links in evaluations page\n- All prioritized cases are shown on cases page\n\n\n## [4.8.3]\n\n### Added\n\n### Fixed\n- Bug when ordering sanger\n- Improved scrolling over long list of genes/transcripts\n\n\n## [4.8.2]\n\n### Added\n\n### Fixed\n- Avoid opening extra tab for coverage report\n- Fixed a problem when rank model version was saved as floats and not strings\n- Fixed a problem with displaying dismiss variant reasons on the general report\n- Disable load and delete filter buttons if there are no saved filters\n- Fix problem with missing verifications\n- Remove duplicate users and merge their data and activity\n\n\n## [4.8.1]\n\n### Added\n\n### Fixed\n- Prevent login fail for users with id defined by ObjectId and not email\n- Prevent the app from crashing with `AttributeError: 'NoneType' object has no attribute 'message'`\n\n\n## [4.8.0]\n\n### Added\n- Updated Scout to use Bootstrap 4.3\n- New looks for Scout\n- Improved dashboard using Chart.js\n- Ask before inactivating a case where last assigned user leaves it\n- Genes can be manually added to the dynamic gene list directly on the case page\n- Dynamic gene panels can optionally be used with clinical filter, instead of default gene panel\n- Dynamic gene panels get link out to chanjo-report for coverage report\n- Load all clinvar variants with clinvar Pathogenic, Likely Pathogenic and Conflicting pathogenic\n- Show transcripts with exon numbers for structural variants\n- Case sort order can now be toggled between ascending and descending.\n- Variants can be marked as partial causative if phenotype is available for case.\n- Show a frequency tooltip hover for SV-variants.\n- Added support for LDAP login system\n- Search snv and structural variants by chromosomal coordinates\n- Structural variants can be marked as partial causative if phenotype is available for case.\n- Show normal and pathologic limits for STRs in the STR variants view.\n- Institute level persistent variant filter settings that can be retrieved and used.\n- export causative variants to Excel\n- Add support for ROH, WIG and chromosome PNGs in case-view\n\n### Fixed\n- Fixed missing import for variants with comments\n- Instructions on how to build docs\n- Keep sanger order + verification when updating/reloading variants\n- Fixed and moved broken filter actions (HPO gene panel and reset filter)\n- Fixed string conversion to number\n- UCSC links for structural variants are now separated per breakpoint (and whole variant where applicable)\n- Reintroduced missing coverage report\n- Fixed a bug preventing loading samples using the command line\n- Better inheritance models customization for genes in gene panels\n- STR variant page back to list button now does its one job.\n- Allows to setup scout without a omim api key\n- Fixed error causing \"favicon not found\" flash messages\n- Removed flask --version from base cli\n- Request rerun no longer changes case status. Active or archived cases inactivate on upload.\n- Fixed missing tooltip on the cancer variants page\n- Fixed weird Rank cell in variants page\n- Next and first buttons order swap\n- Added pagination (and POST capability) to cancer variants.\n- Improves loading speed for variant page\n- Problem with updating variant rank when no variants\n- Improved Clinvar submission form\n- General report crashing when dismissed variant has no valid dismiss code\n- Also show collaborative case variants on the All variants view.\n- Improved phenotype search using dataTables.js on phenotypes page\n- Search and delete users with `email` instead of `_id`\n- Fixed css styles so that multiselect options will all fit one column\n\n\n## [4.7.3]\n\n### Added\n- RankScore can be used with VCFs for vcf_cancer files\n\n### Fixed\n- Fix issue with STR view next page button not doing its one job.\n\n### Deleted\n- Removed pileup as a bam viewing option. This is replaced by IGV\n\n\n## [4.7.2]\n\n### Added\n- Show earlier ACMG classification in the variant list\n\n### Fixed\n- Fixed igv search not working due to igv.js dist 2.2.17\n- Fixed searches for cases with a gene with variants pinned or marked causative.\n- Load variant pages faster after fixing other causatives query\n- Fixed mitochondrial report bug for variants without genes\n\n## [4.7.1]\n\n### Added\n\n### Fixed\n- Fixed bug on genes page\n\n\n## [4.7.0]\n\n### Added\n- Export genes and gene panels in build GRCh38\n- Search for cases with variants pinned or marked causative in a given gene.\n- Search for cases phenotypically similar to a case also from WUI.\n- Case variant searches can be limited to similar cases, matching HPO-terms,\n  phenogroups and cohorts.\n- De-archive reruns and flag them as 'inactive' if archived\n- Sort cases by analysis_date, track or status\n- Display cases in the following order: prioritized, active, inactive, archived, solved\n- Assign case to user when user activates it or asks for rerun\n- Case becomes inactive when it has no assignees\n- Fetch refseq version from entrez and use it in clinvar form\n- Load and export of exons for all genes, independent on refseq\n- Documentation for loading/updating exons\n- Showing SV variant annotations: SV cgh frequencies, gnomad-SV, local SV frequencies\n- Showing transcripts mapping score in segmental duplications\n- Handle requests to Ensembl Rest API\n- Handle requests to Ensembl Rest Biomart\n- STR variants view now displays GT and IGV link.\n- Description field for gene panels\n- Export exons in build 37 and 38 using the command line\n\n### Fixed\n- Fixes of and induced by build tests\n- Fixed bug affecting variant observations in other cases\n- Fixed a bug that showed wrong gene coverage in general panel PDF export\n- MT report only shows variants occurring in the specific individual of the excel sheet\n- Disable SSL certifcate verification in requests to chanjo\n- Updates how intervaltree and pymongo is used to void deprecated functions\n- Increased size of IGV sample tracks\n- Optimized tests\n\n\n## [4.6.1]\n\n### Added\n\n### Fixed\n- Missing 'father' and 'mother' keys when parsing single individual cases\n\n\n## [4.6.0]\n\n### Added\n- Description of Scout branching model in CONTRIBUTING doc\n- Causatives in alphabetical order, display ACMG classification and filter by gene.\n- Added 'external' to the list of analysis type options\n- Adds functionality to display \"Tissue type\". Passed via load config.\n- Update to IGV 2.\n\n### Fixed\n- Fixed alignment visualization and vcf2cytosure availability for demo case samples\n- Fixed 3 bugs affecting SV pages visualization\n- Reintroduced the --version cli option\n- Fixed variants query by panel (hpo panel + gene panel).\n- Downloaded MT report contains excel files with individuals' display name\n- Refactored code in parsing of config files.\n\n\n## [4.5.1]\n\n### Added\n\n### Fixed\n- update requirement to use PyYaml version >= 5.1\n- Safer code when loading config params in cli base\n\n\n## [4.5.0]\n\n### Added\n- Search for similar cases from scout view CLI\n- Scout cli is now invoked from the app object and works under the app context\n\n### Fixed\n- PyYaml dependency fixed to use version >= 5.1\n\n\n## [4.4.1]\n\n### Added\n- Display SV rank model version when available\n\n### Fixed\n- Fixed upload of delivery report via API\n\n\n## [4.4.0]\n\n### Added\n- Displaying more info on the Causatives page and hiding those not causative at the case level\n- Add a comment text field to Sanger order request form, allowing a message to be included in the email\n- MatchMaker Exchange integration\n- List cases with empty synopsis, missing HPO terms and phenotype groups.\n- Search for cases with open research list, or a given case status (active, inactive, archived)\n\n### Fixed\n- Variant query builder split into several functions\n- Fixed delivery report load bug\n\n\n## [4.3.3]\n\n### Added\n- Different individual table for cancer cases\n\n### Fixed\n- Dashboard collects validated variants from verification events instead of using 'sanger' field\n- Cases shared with collaborators are visible again in cases page\n- Force users to select a real institute to share cases with (actionbar select fix)\n\n\n## [4.3.2]\n\n### Added\n- Dashboard data can be filtered using filters available in cases page\n- Causatives for each institute are displayed on a dedicated page\n- SNVs and and SVs are searchable across cases by gene and rank score\n- A more complete report with validated variants is downloadable from dashboard\n\n### Fixed\n- Clinsig filter is fixed so clinsig numerical values are returned\n- Split multi clinsig string values in different elements of clinsig array\n- Regex to search in multi clinsig string values or multi revstat string values\n- It works to upload vcf files with no variants now\n- Combined Pileup and IGV alignments for SVs having variant start and stop on the same chromosome\n\n\n## [4.3.1]\n\n### Added\n- Show calls from all callers even if call is not available\n- Instructions to install cairo and pango libs from WeasyPrint page\n- Display cases with number of variants from CLI\n- Only display cases with number of variants above certain treshold. (Also CLI)\n- Export of verified variants by CLI or from the dashboard\n- Extend case level queries with default panels, cohorts and phenotype groups.\n- Slice dashboard statistics display using case level queries\n- Add a view where all variants for an institute can be searched across cases, filtering on gene and rank score. Allows searching research variants for cases that have research open.\n\n### Fixed\n- Fixed code to extract variant conservation (gerp, phyloP, phastCons)\n- Visualization of PDF-exported gene panels\n- Reintroduced the exon/intron number in variant verification email\n- Sex and affected status is correctly displayed on general report\n- Force number validation in SV filter by size\n- Display ensembl transcripts when no refseq exists\n\n\n## [4.3.0]\n\n### Added\n- Mosaicism tag on variants\n- Show and filter on SweGen frequency for SVs\n- Show annotations for STR variants\n- Show all transcripts in verification email\n- Added mitochondrial export\n- Adds alternative to search for SVs shorter that the given length\n- Look for 'bcftools' in the `set` field of VCFs\n- Display digenic inheritance from OMIM\n- Displays what refseq transcript that is primary in hgnc\n\n### Fixed\n\n- Archived panels displays the correct date (not retroactive change)\n- Fixed problem with waiting times in gene panel exports\n- Clinvar fiter not working with human readable clinsig values\n\n## [4.2.2]\n\n### Fixed\n- Fixed gene panel create/modify from CSV file utf-8 decoding error\n- Updating genes in gene panels now supports edit comments and entry version\n- Gene panel export timeout error\n\n## [4.2.1]\n\n### Fixed\n- Re-introduced gene name(s) in verification email subject\n- Better PDF rendering for excluded variants in report\n- Problem to access old case when `is_default` did not exist on a panel\n\n\n## [4.2.0]\n\n### Added\n- New index on variant_id for events\n- Display overlapping compounds on variants view\n\n### Fixed\n- Fixed broken clinical filter\n\n\n## [4.1.4]\n\n### Added\n- Download of filtered SVs\n\n### Fixed\n- Fixed broken download of filtered variants\n- Fixed visualization issue in gene panel PDF export\n- Fixed bug when updating gene names in variant controller\n\n\n## [4.1.3]\n\n### Fixed\n- Displays all primary transcripts\n\n\n## [4.1.2]\n\n### Added\n- Option add/replace when updating a panel via CSV file\n- More flexible versioning of the gene panels\n- Printing coverage report on the bottom of the pdf case report\n- Variant verification option for SVs\n- Logs uri without pwd when connecting\n- Disease-causing transcripts in case report\n- Thicker lines in case report\n- Supports HPO search for cases, both terms or if described in synopsis\n- Adds sanger information to dashboard\n\n### Fixed\n- Use db name instead of **auth** as default for authentication\n- Fixes so that reports can be generated even with many variants\n- Fixed sanger validation popup to show individual variants queried by user and institute.\n- Fixed problem with setting up scout\n- Fixes problem when exac file is not available through broad ftp\n- Fetch transcripts for correct build in `adapter.hgnc_gene`\n\n## [4.1.1]\n- Fix problem with institute authentication flash message in utils\n- Fix problem with comments\n- Fix problem with ensembl link\n\n\n## [4.1.0]\n\n### Added\n- OMIM phenotypes to case report\n- Command to download all panel app gene panels `scout load panel --panel-app`\n- Links to genenames.org and omim on gene page\n- Popup on gene at variants page with gene information\n- reset sanger status to \"Not validated\" for pinned variants\n- highlight cases with variants to be evaluated by Sanger on the cases page\n- option to point to local reference files to the genome viewer pileup.js. Documented in `docs.admin-guide.server`\n- option to export single variants in `scout export variants`\n- option to load a multiqc report together with a case(add line in load config)\n- added a view for searching HPO terms. It is accessed from the top left corner menu\n- Updates the variants view for cancer variants. Adds a small cancer specific filter for known variants\n- Adds hgvs information on cancer variants page\n- Adds option to update phenotype groups from CLI\n\n### Fixed\n- Improved Clinvar to submit variants from different cases. Fixed HPO terms in casedata according to feedback\n- Fixed broken link to case page from Sanger modal in cases view\n- Now only cases with non empty lists of causative variants are returned in `adapter.case(has_causatives=True)`\n- Can handle Tumor only samples\n- Long lists of HGNC symbols are now possible. This was previously difficult with manual, uploaded or by HPO search when changing filter settings due to GET request limitations. Relevant pages now use POST requests. Adds the dynamic HPO panel as a selection on the gene panel dropdown.\n- Variant filter defaults to default panels also on SV and Cancer variants pages.\n\n## [4.0.0]\n\n### WARNING ###\n\nThis is a major version update and will require that the backend of pre releases is updated.\nRun commands:\n\n```\n$scout update genes\n$scout update hpo\n```\n\n- Created a Clinvar submission tool, to speed up Clinvar submission of SNVs and SVs\n- Added an analysis report page (html and PDF format) containing phenotype, gene panels and variants that are relevant to solve a case.\n\n### Fixed\n- Optimized evaluated variants to speed up creation of case report\n- Moved igv and pileup viewer under a common folder\n- Fixed MT alignment view pileup.js\n- Fixed coordinates for SVs with start chromosome different from end chromosome\n- Global comments shown across cases and institutes. Case-specific variant comments are shown only for that specific case.\n- Links to clinvar submitted variants at the cases level\n- Adapts clinvar parsing to new format\n- Fixed problem in `scout update user` when the user object had no roles\n- Makes pileup.js use online genome resources when viewing alignments. Now any instance of Scout can make use of this functionality.\n- Fix ensembl link for structural variants\n- Works even when cases does not have `'madeline_info'`\n- Parses Polyphen in correct way again\n- Fix problem with parsing gnomad from VEP\n\n### Added\n- Added a PDF export function for gene panels\n- Added a \"Filter and export\" button to export custom-filtered SNVs to CSV file\n- Dismiss SVs\n- Added IGV alignments viewer\n- Read delivery report path from case config or CLI command\n- Filter for spidex scores\n- All HPO terms are now added and fetched from the correct source (https://github.com/obophenotype/human-phenotype-ontology/blob/master/hp.obo)\n- New command `scout update hpo`\n- New command `scout update genes` will fetch all the latest information about genes and update them\n- Load **all** variants found on chromosome **MT**\n- Adds choice in cases overview do show as many cases as user like\n\n### Removed\n- pileup.min.js and pileup css are imported from a remote web location now\n- All source files for HPO information, this is instead fetched directly from source\n- All source files for gene information, this is instead fetched directly from source\n\n## [3.0.0]\n### Fixed\n- hide pedigree panel unless it exists\n\n## [1.5.1] - 2016-07-27\n### Fixed\n- look for both \".bam.bai\" and \".bai\" extensions\n\n## [1.4.0] - 2016-03-22\n### Added\n- support for local frequency through loqusdb\n- bunch of other stuff\n\n## [1.3.0] - 2016-02-19\n### Fixed\n- Update query-phenomizer and add username/password\n\n### Changed\n- Update the way a case is checked for rerun-status\n\n### Added\n- Add new button to mark a case as \"checked\"\n- Link to clinical variants _without_ 1000G annotation\n\n## [1.2.2] - 2016-02-18\n### Fixed\n- avoid filtering out variants lacking ExAC and 1000G annotations\n\n## [1.1.3] - 2015-10-01\n### Fixed\n- persist (clinical) filter when clicking load more\n- fix #154 by robustly setting clinical filter func. terms\n\n## [1.1.2] - 2015-09-07\n### Fixed\n- avoid replacing coverage report with none\n- update SO terms, refactored\n\n## [1.1.1] - 2015-08-20\n### Fixed\n- fetch case based on collaborator status (not owner)\n\n## [1.1.0] - 2015-05-29\n### Added\n- link(s) to SNPedia based on RS-numbers\n- new Jinja filter to \"humanize\" decimal numbers\n- show gene panels in variant view\n- new Jinja filter for decoding URL encoding\n- add indicator to variants in list that have comments\n- add variant number threshold and rank score threshold to load function\n- add event methods to mongo adapter\n- add tests for models\n- show badge \"old\" if comment was written for a previous analysis\n\n### Changed\n- show cDNA change in transcript summary unless variant is exonic\n- moved compounds table further up the page\n- show dates for case uploads in ISO format\n- moved variant comments higher up on page\n- updated documentation for pages\n- read in coverage report as blob in database and serve directly\n- change ``OmimPhenotype`` to ``PhenotypeTerm``\n- reorganize models sub-package\n- move events (and comments) to separate collection\n- only display prev/next links for the research list\n- include variant type in breadcrumbs e.g. \"Clinical variants\"\n\n### Removed\n- drop dependency on moment.js\n\n### Fixed\n- show the same level of detail for all frequencies on all pages\n- properly decode URL encoded symbols in amino acid/cDNA change strings\n- fixed issue with wipe permissions in MongoDB\n- include default gene lists in \"variants\" link in breadcrumbs\n\n## [1.0.2] - 2015-05-20\n### Changed\n- update case fetching function\n\n### Fixed\n- handle multiple cases with same id\n\n## [1.0.1] - 2015-04-28\n### Fixed\n- Fix building URL parameters in cases list Vue component\n\n## [1.0.0] - 2015-04-12\nCodename: Sara Lund\n\n![Release 1.0](artwork/releases/release-1-0.jpg)\n\n### Added\n- Add email logging for unexpected errors\n- New command line tool for deleting case\n\n### Changed\n- Much improved logging overall\n- Updated documentation/usage guide\n- Removed non-working IGV link\n\n### Fixed\n- Show sample display name in GT call\n- Various small bug fixes\n- Make it easier to hover over popups\n\n## [0.0.2-rc1] - 2015-03-04\n### Added\n- add protein table for each variant\n- add many more external links\n- add coverage reports as PDFs\n\n### Changed\n- incorporate user feedback updates\n- big refactor of load scripts\n\n## [0.0.2-rc2] - 2015-03-04\n### Changes\n- add gene table with gene description\n- reorganize inheritance models box\n\n### Fixed\n- avoid overwriting gene list on \"research\" load\n- fix various bugs in external links\n\n## [0.0.2-rc3] - 2015-03-05\n### Added\n- Activity log feed to variant view\n- Adds protein change strings to ODM and Sanger email\n\n### Changed\n- Extract activity log component to macro\n\n### Fixes\n- Make Ensembl transcript links use archive website\n", "# -*- coding: utf-8 -*-\nimport logging\nimport os.path\n\nfrom flask import flash, session\nfrom flask_login import current_user\n\nfrom scout.constants import CASE_SPECIFIC_TRACKS, HUMAN_REFERENCE, IGV_TRACKS\nfrom scout.server.extensions import cloud_tracks, store\nfrom scout.server.utils import case_append_alignments, institute_and_case\nfrom scout.utils.ensembl_rest_clients import EnsemblRestApiClient\n\nLOG = logging.getLogger(__name__)\nCUSTOM_TRACK_NAMES = [\"Genes\", \"ClinVar\", \"ClinVar CNVs\"]\n\n\ndef set_session_tracks(display_obj):\n    \"\"\"Save igv tracks as a session object. This way it's easy to verify that a user is requesting one of these files from remote_static view endpoint\n\n    Args:\n        display_obj(dict): A display object containing case name, list of genes, lucus and tracks\n    \"\"\"\n    session_tracks = list(display_obj.get(\"reference_track\", {}).values())\n    for key, track_items in display_obj.items():\n        if key not in [\"tracks\", \"custom_tracks\", \"sample_tracks\"]:\n            continue\n        for track_item in track_items:\n            session_tracks += list(track_item.values())\n\n    session[\"igv_tracks\"] = session_tracks\n\n\ndef make_igv_tracks(case_obj, variant_id, chrom=None, start=None, stop=None):\n    \"\"\"Create a dictionary containing the required tracks for displaying IGV tracks for case or a group of cases\n\n    Args:\n        institute_id(str): institute _id\n        case_obj(scout.models.Case)\n        variant_id(str): _id of a variant\n        chrom(str/None): requested chromosome [1-22], X, Y, [M-MT]\n        start(int/None): start of the genomic interval to be displayed\n        stop(int/None): stop of the genomic interval to be displayed\n\n    Returns:\n        display_obj(dict): A display object containing case name, list of genes, lucus and tracks\n    \"\"\"\n    display_obj = {}\n    variant_obj = store.variant(document_id=variant_id)\n\n    if variant_obj:\n        # Set display locus\n        start = start or variant_obj[\"position\"]\n        stop = stop or variant_obj[\"end\"]\n\n        chromosome = chrom or variant_obj.get(\"chromosome\")\n        chromosome = chromosome.replace(\"MT\", \"M\")\n        display_obj[\"locus\"] = \"chr{0}:{1}-{2}\".format(chromosome, start, stop)\n    else:\n        chromosome = \"All\"\n\n    # Set genome build for displaying alignments:\n    if \"38\" in str(case_obj.get(\"genome_build\", \"37\")) or chromosome == \"M\":\n        build = \"38\"\n    else:\n        build = \"37\"\n\n    # Set general tracks (Genes, Clinvar and ClinVar SNVs are shown according to user preferences)\n    set_common_tracks(display_obj, build)\n\n    # Build tracks for main case and all connected cases (cases grouped with main case)\n    grouped_cases = []\n    for group in case_obj.get(\"group\", []):\n        group_cases = list(store.cases(group=group))\n        for case in group_cases:\n            case_append_alignments(case)  # Add track data to connected case dictionary\n            grouped_cases.append(case)\n\n    if not grouped_cases:  # Display case individuals tracks only\n        case_append_alignments(case_obj)  # Add track data to main case dictionary\n        grouped_cases.append(case_obj)\n\n    # Set up bam/cram alignments for case group samples:\n    set_sample_tracks(display_obj, grouped_cases, chromosome)\n\n    # When chrom != MT, set up case-specific tracks (might be present according to the pipeline)\n    if chrom != \"M\":\n        set_case_specific_tracks(display_obj, case_obj)\n\n    # Set up custom cloud public tracks, if available\n    set_cloud_public_tracks(display_obj, build)\n\n    display_obj[\"display_center_guide\"] = True\n\n    return display_obj\n\n\ndef make_sashimi_tracks(case_obj, variant_id):\n    \"\"\"Create a dictionary containing the required tracks for a splice junction plot\n\n    Args:\n        case_obj(scout.models.Case)\n        variant_id(str) _id of a variant\n    Returns:\n        display_obj(dict): A display object containing case name, list of genes, lucus and tracks\n    \"\"\"\n    build = \"38\"  # This feature is only available for RNA tracks in build 38\n\n    variant_obj = store.variant(document_id=variant_id)\n\n    # Initialize locus coordinates it with variant coordinates so it won't crash if variant gene(s) no longer exist in database\n    locus_start_coords = []\n    locus_end_coords = []\n\n    # Check if variant coordinates are in genome build 38\n    # Otherwise do variant coords liftover\n    if build not in str(case_obj.get(\"genome_build\")):\n        client = EnsemblRestApiClient()\n        mapped_coords = client.liftover(\n            case_obj.get(\"genome_build\"),\n            variant_obj.get(\"chromosome\"),\n            variant_obj.get(\"position\"),\n            variant_obj.get(\"end\"),\n        )\n        if mapped_coords:\n            mapped_start = mapped_coords[0][\"mapped\"].get(\"start\")\n            mapped_end = mapped_coords[0][\"mapped\"].get(\"end\") or mapped_start\n            locus_start_coords.append(mapped_start)\n            locus_end_coords.append(mapped_end)\n\n    # Use original coordinates only genome build was already 38 or liftover didn't work\n    if not locus_start_coords:\n        locus_start_coords.append(variant_obj.get(\"position\"))\n    if not locus_end_coords:\n        locus_end_coords.append(variant_obj.get(\"end\"))\n\n    # Collect locus coordinates. Take into account that variant can hit multiple genes\n    variant_genes_ids = [gene[\"hgnc_id\"] for gene in variant_obj.get(\"genes\", [])]\n    for gene_id in variant_genes_ids:\n        gene_caption = store.hgnc_gene_caption(hgnc_identifier=gene_id, build=build)\n        if gene_caption is None:\n            continue\n        locus_start_coords.append(gene_caption[\"start\"])\n        locus_end_coords.append(gene_caption[\"end\"])\n\n    locus_start = min(locus_start_coords)\n    locus_end = max(locus_end_coords)\n\n    locus = f\"{variant_obj['chromosome']}:{locus_start}-{locus_end}\"  # Locus will span all genes the variant falls into\n    display_obj = {\"locus\": locus, \"tracks\": []}\n\n    # Add Genes and reference tracks to display object\n    set_common_tracks(display_obj, build)\n\n    # Populate tracks for each individual with splice junction track data\n    for ind in case_obj.get(\"individuals\", []):\n        if not all([ind.get(\"splice_junctions_bed\"), ind.get(\"rna_coverage_bigwig\")]):\n            continue\n\n        coverage_wig = ind[\"rna_coverage_bigwig\"]\n        splicej_bed = ind[\"splice_junctions_bed\"]\n        splicej_bed_index = f\"{splicej_bed}.tbi\" if os.path.isfile(f\"{splicej_bed}.tbi\") else None\n        if splicej_bed_index is None:\n            flash(f\"Missing bed file index for individual {ind['display_name']}\")\n\n        track = {\n            \"name\": ind[\"display_name\"],\n            \"coverage_wig\": coverage_wig,\n            \"splicej_bed\": splicej_bed,\n            \"splicej_bed_index\": splicej_bed_index,\n        }\n        display_obj[\"tracks\"].append(track)\n\n    display_obj[\"case\"] = case_obj[\"display_name\"]\n\n    return display_obj\n\n\ndef set_tracks(name, file_list):\n    \"\"\"Return a dict according to IGV track format.\"\"\"\n    track_list = []\n    for track in file_list:\n        track_list.append({\"name\": name, \"url\": track, \"min\": 0.0, \"max\": 30.0})\n    return track_list\n\n\ndef set_common_tracks(display_obj, build):\n    \"\"\"Set up tracks common to all cases (Genes, ClinVar ClinVar CNVs) according to user preferences\n\n    Args:\n        display_obj(dict) dictionary containing all tracks info\n        build(string) \"37\" or \"38\"\n    \"\"\"\n    user_obj = store.user(email=current_user.email)\n\n    # Set up IGV tracks that are common for all cases:\n    display_obj[\"reference_track\"] = HUMAN_REFERENCE[build]  # Human reference is always present\n\n    # if user settings for igv tracks exist -> use these settings, otherwise display all tracks\n    custom_tracks_names = user_obj.get(\"igv_tracks\") or CUSTOM_TRACK_NAMES\n\n    display_obj[\"custom_tracks\"] = []\n    for track in IGV_TRACKS[build]:\n        # if track is selected, add it to track display object\n        if track[\"name\"] in custom_tracks_names:\n            display_obj[\"custom_tracks\"].append(track)\n\n\ndef set_sample_tracks(display_obj, case_groups, chromosome):\n    \"\"\"Set up individual-specific alignment tracks (bam/cram files)\n\n    Args:\n        display_obj(dict): dictionary containing all tracks info\n        case_groups(list): a list of case dictionaries\n        chromosome(str) [1-22],X,Y,M or \"All\"\n    \"\"\"\n    sample_tracks = []\n\n    track_items = \"mt_bams\" if chromosome == \"M\" else \"bam_files\"\n    track_index_items = \"mt_bais\" if track_items == \"mt_bams\" else \"bai_files\"\n\n    # Loop over a group of cases and add tracks for every individual of of every case\n    for case in case_groups:\n        if None in [\n            case.get(\"sample_names\"),\n            case.get(track_items),\n            case.get(track_index_items),\n        ]:\n            case[\"sample_tracks\"] = []\n            return\n\n        for count, sample in enumerate(case.get(\"sample_names\")):\n            sample_tracks.append(\n                {\n                    \"name\": sample,\n                    \"url\": case[track_items][count],\n                    \"indexURL\": case[track_index_items][count],\n                    \"format\": case[track_items][count].split(\".\")[-1],  # \"bam\" or \"cram\"\n                    \"height\": 700,\n                }\n            )\n        display_obj[\"sample_tracks\"] = sample_tracks\n\n\ndef set_case_specific_tracks(display_obj, case_obj):\n    \"\"\"Set up tracks from files that might be present or not at the case level\n        (rhocall files, tiddit coverage files, upd regions and sites files)\n    Args:\n        display_obj(dict) dictionary containing all tracks info\n        form(dict) flask request form dictionary\n    \"\"\"\n    for track, label in CASE_SPECIFIC_TRACKS.items():\n        if case_obj.get(track) is None:\n            continue\n        track_info = set_tracks(label, case_obj.get(track).split(\",\"))\n        display_obj[track] = track_info\n\n\ndef set_cloud_public_tracks(display_obj, build):\n    \"\"\"Set up custom public tracks stored in a cloud bucket, according to the user preferences\n\n    Args:\n        display_obj(dict) dictionary containing all tracks info\n        build(string) \"37\" or \"38\"\n    \"\"\"\n    user_obj = store.user(email=current_user.email)\n    custom_tracks_names = user_obj.get(\"igv_tracks\")\n\n    cloud_public_tracks = []\n    if hasattr(cloud_tracks, \"public_tracks\"):\n        build_tracks = cloud_tracks.public_tracks.get(build, [])\n        for track in build_tracks:\n            # Do not display track if user doesn't want to see it\n            if custom_tracks_names and track[\"name\"] not in custom_tracks_names:\n                continue\n            cloud_public_tracks.append(track)\n    if cloud_public_tracks:\n        display_obj[\"cloud_public_tracks\"] = cloud_public_tracks\n", "# -*- coding: utf-8 -*-\nimport logging\n\nimport requests\nfrom flask import (\n    Blueprint,\n    Response,\n    abort,\n    copy_current_request_context,\n    render_template,\n    request,\n    session,\n)\nfrom flask_login import current_user\n\nfrom scout.server.extensions import store\nfrom scout.server.utils import institute_and_case\n\nfrom . import controllers\nfrom .partial import send_file_partial\n\nalignviewers_bp = Blueprint(\n    \"alignviewers\",\n    __name__,\n    template_folder=\"templates\",\n    static_folder=\"static\",\n    static_url_path=\"/alignviewers/static\",\n)\n\nLOG = logging.getLogger(__name__)\n\n\n@alignviewers_bp.route(\"/remote/cors/<path:remote_url>\", methods=[\"OPTIONS\", \"GET\"])\ndef remote_cors(remote_url):\n    \"\"\"Proxy a remote URL.\n    Useful to e.g. eliminate CORS issues when the remote site does not\n        communicate CORS headers well, as in cloud tracks on figshare for IGV.js.\n\n    Based on code from answers to this thread:\n        https://stackoverflow.com/questions/6656363/proxying-to-another-web-service-with-flask/\n    \"\"\"\n    resp = requests.request(\n        method=request.method,\n        url=remote_url,\n        headers={key: value for (key, value) in request.headers if key != \"Host\"},\n        data=request.get_data(),\n        cookies=request.cookies,\n        allow_redirects=True,\n    )\n\n    excluded_headers = [\n        \"content-encoding\",\n        \"content-length\",\n        \"transfer-encoding\",\n        \"connection\",\n    ]\n    headers = [\n        (name, value)\n        for (name, value) in resp.raw.headers.items()\n        if name.lower() not in excluded_headers\n    ]\n\n    response = Response(resp.content, resp.status_code, headers)\n    return response\n\n\n@alignviewers_bp.route(\"/remote/static\", methods=[\"OPTIONS\", \"GET\"])\ndef remote_static():\n    \"\"\"Stream *large* static files with special requirements.\"\"\"\n    file_path = request.args.get(\"file\") or \".\"\n\n    # Check that user is logged in or that file extension is valid\n    if current_user.is_authenticated is False or file_path not in session.get(\"igv_tracks\", []):\n        LOG.warning(f\"{file_path} not in {session.get('igv_tracks', [])}\")\n        return abort(403)\n\n    range_header = request.headers.get(\"Range\", None)\n    if not range_header and (file_path.endswith(\".bam\") or file_path.endswith(\".cram\")):\n        return abort(500)\n\n    new_resp = send_file_partial(file_path)\n    return new_resp\n\n\n@alignviewers_bp.route(\n    \"/<institute_id>/<case_name>/<variant_id>/igv-splice-junctions\", methods=[\"GET\"]\n)\ndef sashimi_igv(institute_id, case_name, variant_id):\n    \"\"\"Visualize splice junctions on igv.js sashimi-like viewer for one or more individuals of a case.\n    wiki: https://github.com/igvteam/igv.js/wiki/Splice-Junctions\n    \"\"\"\n    _, case_obj = institute_and_case(\n        store, institute_id, case_name\n    )  # This function takes care of checking if user is authorized to see resource\n\n    display_obj = controllers.make_sashimi_tracks(case_obj, variant_id)\n    controllers.set_session_tracks(display_obj)\n\n    response = Response(render_template(\"alignviewers/igv_sashimi_viewer.html\", **display_obj))\n\n    @response.call_on_close\n    @copy_current_request_context\n    def clear_session_tracks():\n        session.pop(\"igv_tracks\", None)  # clean up igv session tracks\n\n    return response\n\n\n@alignviewers_bp.route(\"/<institute_id>/<case_name>/igv\", methods=[\"GET\"])  # from case page\n@alignviewers_bp.route(\n    \"/<institute_id>/<case_name>/<variant_id>/igv\", methods=[\"GET\"]\n)  # from SNV and STR variant page\n@alignviewers_bp.route(\n    \"/<institute_id>/<case_name>/<variant_id>/<chrom>/<start>/<stop>/igv\", methods=[\"GET\"]\n)  # from SV variant page, where you have to pass breakpoints coordinates\ndef igv(institute_id, case_name, variant_id=None, chrom=None, start=None, stop=None):\n    \"\"\"Visualize BAM alignments using igv.js (https://github.com/igvteam/igv.js)\n\n    Args:\n        institute_id(str): _id of an institute\n        case_name(str): dislay_name of a case\n        variant_id(str/None): variant _id or None\n        chrom(str/None): requested chromosome [1-22], X, Y, [M-MT]\n        start(int/None): start of the genomic interval to be displayed\n        stop(int/None): stop of the genomic interval to be displayed\n\n    Returns:\n        a string, corresponging to the HTML rendering of the IGV alignments page\n    \"\"\"\n    _, case_obj = institute_and_case(\n        store, institute_id, case_name\n    )  # This function takes care of checking if user is authorized to see resource\n\n    display_obj = controllers.make_igv_tracks(case_obj, variant_id, chrom, start, stop)\n    controllers.set_session_tracks(display_obj)\n\n    response = Response(render_template(\"alignviewers/igv_viewer.html\", **display_obj))\n\n    @response.call_on_close\n    @copy_current_request_context\n    def clear_session_tracks():\n        session.pop(\"igv_tracks\", None)  # clean up igv session tracks\n\n    return response\n", "# -*- coding: utf-8 -*-\nimport requests\nfrom flask import session, url_for\n\nfrom scout.server.extensions import store\n\n\ndef test_remote_static_no_auth(app):\n    \"\"\"Test endpoint that serves alignment files as non-logged user\"\"\"\n    # GIVEN a running demo app\n    with app.test_client() as client:\n        # GIVEN that user is not logged in\n        resp = client.get(\n            url_for(\n                \"alignviewers.remote_static\",\n                file=\"../demo/ACC5963A1_lanes_1234_star_sorted_sj_filtered_sorted.bed.gz\",\n            )\n        )\n        # THEN endpoint should return forbidden (403)\n        assert resp.status_code == 403\n\n\ndef test_test_remote_static_not_in_session(app):\n    \"\"\"Test endpoint that serves alignment files that are not saved in the session\"\"\"\n\n    # GIVEN a running demo app\n    with app.test_client() as client:\n        # GIVEN that user is \u00dflogged in\n        client.get(url_for(\"auto_login\"))\n        # If requested file doesn't have a valid extension\n        resp = client.get(\n            url_for(\n                \"alignviewers.remote_static\",\n                file=\"config.py\",\n            )\n        )\n        # THEN endpoint should return forbidden (403)\n        assert resp.status_code == 403\n\n\ndef test_remote_static(app):\n    \"\"\"Test endpoint that serves files as a logged user\"\"\"\n    # GIVEN a file on disk\n    file = \"../demo/ACC5963A1_lanes_1234_star_sorted_sj_filtered_sorted.bed.gz\"\n\n    # GIVEN a running demo app\n    with app.test_client() as client:\n        # GIVEN that user is logged in\n        client.get(url_for(\"auto_login\"))\n        with client.session_transaction() as session:\n            # GIVEN that resource file exists in user session\n            session[\"igv_tracks\"] = [file]\n\n        # THEN the resource should be available to the user\n        resp = client.get(\n            url_for(\n                \"alignviewers.remote_static\",\n                file=file,\n            )\n        )\n        assert resp.status_code == 200\n\n\ndef test_remote_cors(app):\n    \"\"\"Test endpoint that serves as a proxy to the actual remote track on the cloud\"\"\"\n    cloud_track_url = \"http://google.com\"\n\n    # GIVEN an initialized app\n    # GIVEN a valid user and institute\n    with app.test_client() as client:\n        # GIVEN that the user could be logged in\n        resp = client.get(url_for(\"auto_login\"))\n        assert resp.status_code == 200\n\n        # WHEN the remote cors endpoint is invoked with an url\n        resp = client.get(url_for(\"alignviewers.remote_cors\", remote_url=cloud_track_url))\n        # THEN it should return success response\n        assert resp.status_code == 200\n\n\ndef test_igv_not_authorized(app, user_obj, case_obj, variant_obj):\n    \"\"\"Test view requests and produces igv alignments, when the user dosn't have access to the case\"\"\"\n\n    # GIVEN a user that is not an admin nor has access to demo case:\n    store.user_collection.find_one_and_update(\n        {\"_id\": user_obj[\"_id\"]},\n        {\"$set\": {\"roles\": [], \"institutes\": []}},\n    )\n\n    # GIVEN an initialized app\n    with app.test_client() as client:\n\n        # GIVEN that the user is logged in\n        client.get(url_for(\"auto_login\"))\n\n        # WHEN the igv endpoint is invoked with the right parameters\n        resp = client.get(\n            url_for(\n                \"alignviewers.igv\",\n                institute_id=case_obj[\"owner\"],\n                case_name=case_obj[\"display_name\"],\n                variant_id=variant_obj[\"_id\"],\n            )\n        )\n\n        # THEN the response should be \"not authorized\" (403)\n        assert resp.status_code == 403\n\n\ndef test_igv_authorized(app, user_obj, case_obj, variant_obj):\n    \"\"\"Test view requests and produces igv alignments, when the user has access to the case\"\"\"\n\n    # GIVEN an initialized app\n    with app.test_client() as client:\n\n        # GIVEN that the user is logged in\n        client.get(url_for(\"auto_login\"))\n\n        # WHEN the igv endpoint is invoked with the right parameters\n        resp = client.get(\n            url_for(\n                \"alignviewers.igv\",\n                institute_id=case_obj[\"owner\"],\n                case_name=case_obj[\"display_name\"],\n                variant_id=variant_obj[\"_id\"],\n            )\n        )\n\n        # THEN the response should be a valid HTML page\n        assert resp.status_code == 200\n        # AND when the reponse is closed case IGV tracks should be removed from session\n        resp.close()\n        assert session.get(\"igv_tracks\") is None\n"], "fixing_code": ["# Change Log\nAll notable changes to this project will be documented in this file.\nThis project adheres to [Semantic Versioning](http://semver.org/).\n\nAbout changelog [here](https://keepachangelog.com/en/1.0.0/)\n\n## []\n### Added\n- Demo cancer case gets loaded together with demo RD case in demo instance\n- Parse REVEL_score alongside REVEL_rankscore from csq field and display it on SNV variant page\n- Rank score results now show the ranking range\n- cDNA and protein changes displayed on institute causatives pages\n- Optional SESSION_TIMEOUT_MINUTES configuration in app config files\n- Script to convert old OMIM case format (list of integers) to new format (list of dictionaries)\n- Additional check for user logged in status before serving alignment files\n- Download .cgh files from cancer samples table on cancer case page\n### Changed\n- Verify user before redirecting to IGV alignments and sashimi plots\n- Build case IGV tracks starting from case and variant objects instead of passing all params in a form\n- Unfreeze Werkzeug lib since Flask_login v.0.6 with bugfix has been released\n- Sort gene panels by name (panelS and variant page)\n- Removed unused `server.blueprints.alignviewers.unindexed_remote_static` endpoint\n- User sessions to check files served by `server.blueprints.alignviewers.remote_static` endpoint\n- Moved Beacon-related functions to a dedicated app extension\n- Audit Filter now also loads filter displaying the variants for it\n### Fixed\n- Handle `attachment_filename` parameter renamed to `download_name` when Flask 2.2 will be released\n- Removed cursor timeout param in cases find adapter function to avoid many code warnings\n- Removed stream argument deprecation warning in tests\n- Handle `no intervals found` warning in load_region test\n- Beacon remove variants\n- Protect remote_cors function in alignviewers view from Server-Side Request Forgery (SSRF)\n\n## [4.51]\n### Added\n- Config file containing codecov settings for pull requests\n- Add an IGV.js direct link button from case page\n- Security policy file\n- Hide/shade compound variants based on rank score on variantS from filter\n- Chromograph legend documentation direct link\n### Changed\n- Updated deprecated Codecov GitHub action to v.2\n- Simplified code of scout/adapter/mongo/variant\n- Update IGV.js to v2.11.2\n- Show summary number of variant gene panels on general report if more than 3\n### Fixed\n- Marrvel link for variants in genome build 38 (using liftover to build 37)\n- Remove flags from codecov config file\n- Fixed filter bug with high negative SPIDEX scores\n- Renamed IARC TP53 button to to `TP53 Database`, modified also link since IARC has been moved to the US NCI: `https://tp53.isb-cgc.org/`\n- Parsing new format of OMIM case info when exporting patients to Matchmaker\n- Remove flask-debugtoolbar lib dependency that is using deprecated code and causes app to crash after new release of Jinja2 (3.1)\n- Variant page crashing for cases with old OMIM terms structure (a list of integers instead of dictionary)\n- Variant page crashing when creating MARRVEL link for cases with no genome build\n- SpliceAI documentation link\n- Fix deprecated `safe_str_cmp` import from `werkzeug.security` by freezing Werkzeug lib to v2.0 until Flask_login v.0.6 with bugfix is released\n- List gene names densely in general report for SVs that contain more than 3 genes\n- Show transcript ids on refseq genes on hg19 in IGV.js, using refgene source\n- Display correct number of genes in general report for SVs that contain more than 32 genes\n- Broken Google login after new major release of `lepture/authlib`\n- Fix frequency and callers display on case general report\n\n## [4.50.1]\n### Fixed\n- Show matching causative STR_repid for legacy str variants (pre Stranger hgnc_id)\n\n## [4.50]\n### Added\n- Individual-specific OMIM terms\n- OMIM disease descriptions in ClinVar submission form\n- Add a toggle for melter rerun monitoring of cases\n- Add a config option to show the rerun monitoring toggle\n- Add a cli option to export cases with rerun monitoring enabled\n- Add a link to STRipy for STR variants; shallow for ARX and HOXA13\n- Hide by default variants only present in unaffected individuals in variants filters\n- OMIM terms in general case report\n- Individual-level info on OMIM and HPO terms in general case report\n- PanelApp gene link among the external links on variant page\n- Dashboard case filters fields help\n- Filter cases by OMIM terms in cases and dashboard pages\n### Fixed\n- A malformed panel id request would crash with exception: now gives user warning flash with redirect\n- Link to HPO resource file hosted on `http://purl.obolibrary.org`\n- Gene search form when gene exists only in build 38\n- Fixed odd redirect error and poor error message on missing column for gene panel csv upload\n- Typo in parse variant transcripts function\n- Modified keys name used to parse local observations (archived) frequencies to reflect change in MIP keys naming\n- Better error handling for partly broken/timed out chanjo reports\n- Broken javascript code when case Chromograph data is malformed\n- Broader space for case synopsis in general report\n- Show partial causatives on causatives and matching causatives panels\n- Partial causative assignment in cases with no OMIM or HPO terms\n- Partial causative OMIM select options in variant page\n### Changed\n- Slightly smaller and improved layout of content in case PDF report\n- Relabel more cancer variant pages somatic for navigation\n- Unify caseS nav links\n- Removed unused `add_compounds` param from variant controllers function\n- Changed default hg19 genome for IGV.js to legacy hg19_1kg_decoy to fix a few problematic loci\n- Reduce code complexity (parse/ensembl.py)\n- Silence certain fields in ClinVar export if prioritised ones exist (chrom-start-end if hgvs exist)\n- Made phenotype non-mandatory when marking a variant as partial causative\n- Only one phenotype condition type (OMIM or HPO) per variant is used in ClinVar submissions\n- ClinVar submission variant condition prefers OMIM over HPO if available\n- Use lighter version of gene objects in Omim MongoDB adapter, panels controllers, panels views and institute controllers\n- Gene-variants table size is now adaptive\n- Remove unused file upload on gene-variants page\n\n## [4.49]\n### Fixed\n- Pydantic model types for genome_build, madeline_info, peddy_ped_check and peddy_sex_check, rank_model_version and sv_rank_model_version\n- Replace `MatchMaker` with `Matchmaker` in all places visible by a user\n- Save diagnosis labels along with OMIM terms in Matchmaker Exchange submission objects\n- `libegl-mesa0_21.0.3-0ubuntu0.3~20.04.5_amd64.deb` lib not found by GitHub actions Docker build\n- Remove unused `chromograph_image_files` and `chromograph_prefixes` keys saved when creating or updating an RD case\n- Search managed variants by description and with ignore case\n### Changed\n- Introduced page margins on exported PDF reports\n- Smaller gene fonts in downloaded HPO genes PDF reports\n- Reintroduced gene coverage data in the PDF-exported general report of rare-disease cases\n- Check for existence of case report files before creating sidebar links\n- Better description of HPO and OMIM terms for patients submitted to Matchmaker Exchange\n- Remove null non-mandatory key/values when updating a case\n- Freeze WTForms<3 due to several form input rendering changes\n\n## [4.48.1]\n### Fixed\n- General case PDF report for recent cases with no pedigree\n\n## [4.48]\n### Added\n- Option to cancel a request for research variants in case page\n### Changed\n- Update igv.js to v2.10.5\n- Updated example of a case delivery report\n- Unfreeze cyvcf2\n- Builder images used in Scout Dockerfiles\n- Crash report email subject gives host name\n- Export general case report to PDF using PDFKit instead of WeasyPrint\n- Do not include coverage report in PDF case report since they might have different orientation\n- Export cancer cases's \"Coverage and QC report\" to PDF using PDFKit instead of Weasyprint\n- Updated cancer \"Coverage and QC report\" example\n- Keep portrait orientation in PDF delivery report\n- Export delivery report to PDF using PDFKit instead of Weasyprint\n- PDF export of clinical and research HPO panels using PDFKit instead of Weasyprint\n- Export gene panel report to PDF using PDFKit\n- Removed WeasyPrint lib dependency\n\n### Fixed\n- Reintroduced missing links to Swegen and Beacon and dbSNP in RD variant page, summary section\n- Demo delivery report orientation to fit new columns\n- Missing delivery report in demo case\n- Cast MNVs to SNV for test\n- Export verified variants from all institutes when user is admin\n- Cancer coverage and QC report not found for demo cancer case\n- Pull request template instructions on how to deploy to test server\n- PDF Delivery report not showing Swedac logo\n- Fix code typos\n- Disable codefactor raised by ESLint for javascript functions located on another file\n- Loading spinner stuck after downloading a PDF gene panel report\n- IGV browser crashing when file system with alignment files is not mounted\n\n## [4.47]\n### Added\n- Added CADD, GnomAD and genotype calls to variantS export\n### Changed\n- Pull request template, to illustrate how to deploy pull request branches on cg-vm1 stage server\n### Fixed\n- Compiled Docker image contains a patched version (v4.9) of chanjo-report\n\n## [4.46.1]\n### Fixed\n- Downloading of files generated within the app container (MT-report, verified variants, pedigrees, ..)\n\n## [4.46]\n### Added\n- Created a Dockefile to be used to serve the dockerized app in production\n- Modified the code to collect database params specified as env vars\n- Created a GitHub action that pushes the Dockerfile-server image to Docker Hub (scout-server-stage) every time a PR is opened\n- Created a GitHub action that pushes the Dockerfile-server image to Docker Hub (scout-server) every time a new release is created\n- Reassign MatchMaker Exchange submission to another user when a Scout user is deleted\n- Expose public API JSON gene panels endpoint, primarily to enable automated rerun checking for updates\n- Add utils for dictionary type\n- Filter institute cases using multiple HPO terms\n- Vulture GitHub action to identify and remove unused variables and imports\n### Changed\n- Updated the python config file documentation in admin guide\n- Case configuration parsing now uses Pydantic for improved typechecking and config handling\n- Removed test matrices to speed up automatic testing of PRs\n- Switch from Coveralls to Codecov to handle CI test coverage\n- Speed-up CI tests by caching installation of libs and splitting tests into randomized groups using pytest-test-groups\n- Improved LDAP login documentation\n- Use lib flask-ldapconn instead of flask_ldap3_login> to handle ldap authentication\n- Updated Managed variant documentation in user guide\n- Fix and simplify creating and editing of gene panels\n- Simplified gene variants search code\n- Increased the height of the genes track in the IGV viewer\n### Fixed\n- Validate uploaded managed variant file lines, warning the user.\n- Exporting validated variants with missing \"genes\" database key\n- No results returned when searching for gene variants using a phenotype term\n- Variants filtering by gene symbols file\n- Make gene HGNC symbols field mandatory in gene variants page and run search only on form submit\n- Make sure collaborator gene variants are still visible, even if HPO filter is used\n\n## [4.45]\n### Added\n### Changed\n- Start Scout also when loqusdbapi is not reachable\n- Clearer definition of manual standard and custom inheritance models in gene panels\n- Allow searching multiple chromosomes in filters\n### Fixed\n- Gene panel crashing on edit action\n\n## [4.44]\n### Added\n### Changed\n- Display Gene track beneath each sample track when displaying splice junctions in igv browser\n- Check outdated gene symbols and update with aliases for both RD and cancer variantS\n### Fixed\n- Added query input check and fixed the Genes API endpoint to return a json formatted error when request is malformed\n- Typo in ACMG BP6 tooltip\n\n## [4.43.1]\n### Added\n- Added database index for OMIM disease term genes\n### Changed\n### Fixed\n- Do not drop HPO terms collection when updating HPO terms via the command line\n- Do not drop disease (OMIM) terms collection when updating diseases via the command line\n\n## [4.43]\n### Added\n- Specify which collection(s) update/build indexes for\n### Fixed\n- Do not drop genes and transcripts collections when updating genes via the command line\n\n## [4.42.1]\n### Added\n### Changed\n### Fixed\n- Freeze PyMongo lib to version<4.0 to keep supporting previous MongoDB versions\n- Speed up gene panels creation and update by collecting only light gene info from database\n- Avoid case page crash on Phenomizer queries timeout\n\n## [4.42]\n### Added\n- Choose custom pinned variants to submit to MatchMaker Exchange\n- Submit structural variant as genes to the MatchMaker Exchange\n- Added function for maintainers and admins to remove gene panels\n- Admins can restore deleted gene panels\n- A development docker-compose file illustrating the scout/chanjo-report integration\n- Show AD on variants view for cancer SV (tumor and normal)\n- Cancer SV variants filter AD, AF (tumor and normal)\n- Hiding the variants score column also from cancer SVs, as for the SNVs\n### Changed\n- Enforce same case _id and display_name when updating a case\n- Enforce same individual ids, display names and affected status when updating a case\n- Improved documentation for connecting to loqusdb instances (including loqusdbapi)\n- Display and download HPO gene panels' gene symbols in italics\n- A faster-built and lighter Docker image\n- Reduce complexity of `panels` endpoint moving some code to the panels controllers\n- Update requirements to use flask-ldap3-login>=0.9.17 instead of freezing WTForm\n### Fixed\n- Use of deprecated TextField after the upgrade of WTF to v3.0\n- Freeze to WTForms to version < 3\n- Remove the extra files (bed files and madeline.svg) introduced by mistake\n- Cli command loading demo data in docker-compose when case custom images exist and is None\n- Increased MongoDB connection serverSelectionTimeoutMS parameter to 30K (default value according to MongoDB documentation)\n- Better differentiate old obs counts 0 vs N/A\n- Broken cancer variants page when default gene panel was deleted\n- Typo in tx_overview function in variant controllers file\n- Fixed loqusdbapi SV search URL\n- SV variants filtering using Decipher criterion\n- Removing old gene panels that don't contain the `maintainer` key.\n\n## [4.41.1]\n### Fixed\n- General reports crash for variant annotations with same variant on other cases\n\n## [4.41]\n### Added\n- Extended the instructions for running the Scout Docker image (web app and cli).\n- Enabled inclusion of custom images to STR variant view\n### Fixed\n- General case report sorting comments for variants with None genetic models\n- Do not crash but redirect to variants page with error when a variant is not found for a case\n- UCSC links coordinates for SV variants with start chromosome different than end chromosome\n- Human readable variants name in case page for variants having start chromosome different from end chromosome\n- Avoid always loading all transcripts when checking gene symbol: introduce gene captions\n- Slow queries for evaluated variants on e.g. case page - use events instead\n### Changed\n- Rearrange variant page again, moving severity predictions down.\n- More reactive layout width steps on variant page\n\n## [4.40.1]\n### Added\n### Fixed\n- Variants dismissed with inconsistent inheritance pattern can again be shown in general case report\n- General report page for variants with genes=None\n- General report crashing when variants have no panels\n- Added other missing keys to case and variant dictionaries passed to general report\n### Changed\n\n## [4.40]\n### Added\n- A .cff citation file\n- Phenotype search API endpoint\n- Added pagination to phenotype API\n- Extend case search to include internal MongoDB id\n- Support for connecting to a MongoDB replica set (.py config files)\n- Support for connecting to a MongoDB replica set (.yaml config files)\n### Fixed\n- Command to load the OMIM gene panel (`scout load panel --omim`)\n- Unify style of pinned and causative variants' badges on case page\n- Removed automatic spaces after punctuation in comments\n- Remove the hardcoded number of total individuals from the variant's old observations panel\n- Send delete requests to a connected Beacon using the DELETE method\n- Layout of the SNV and SV variant page - move frequency up\n### Changed\n- Stop updating database indexes after loading exons via command line\n- Display validation status badge also for not Sanger-sequenced variants\n- Moved Frequencies, Severity and Local observations panels up in RD variants page\n- Enabled Flask CORS to communicate CORS status to js apps\n- Moved the code preparing the transcripts overview to the backend\n- Refactored and filtered json data used in general case report\n- Changed the database used in docker-compose file to use the official MongoDB v4.4 image\n- Modified the Python (3.6, 3.8) and MongoDB (3.2, 4.4, 5.0) versions used in testing matrices (GitHub actions)\n- Capitalize case search terms on institute and dashboard pages\n\n\n## [4.39]\n### Added\n- COSMIC IDs collected from CSQ field named `COSMIC`\n### Fixed\n- Link to other causative variants on variant page\n- Allow multiple COSMIC links for a cancer variant\n- Fix floating text in severity box #2808\n- Fixed MitoMap and HmtVar links for hg38 cases\n- Do not open new browser tabs when downloading files\n- Selectable IGV tracks on variant page\n- Missing splice junctions button on variant page\n- Refactor variantS representative gene selection, and use it also for cancer variant summary\n### Changed\n- Improve Javascript performance for displaying Chromograph images\n- Make ClinVar classification more evident in cancer variant page\n\n## [4.38]\n### Added\n- Option to hide Alamut button in the app config file\n### Fixed\n- Library deprecation warning fixed (insert is deprecated. Use insert_one or insert_many instead)\n- Update genes command will not trigger an update of database indices any more\n- Missing resources in temporary downloading directory when updating genes using the command line\n- Restore previous variant ACMG classification in a scrollable div\n- Loading spinner not stopping after downloading PDF case reports and variant list export\n- Add extra Alamut links higher up on variant pages\n- Improve UX for phenotypes in case page\n- Filter and export of STR variants\n- Update look of variants page navigation buttons\n### Changed\n\n## [4.37]\n### Added\n- Highlight and show version number for RefSeq MANE transcripts.\n- Added integration to a rerunner service for toggling reanalysis with updated pedigree information\n- SpliceAI display and parsing from VEP CSQ\n- Display matching tiered variants for cancer variants\n- Display a loading icon (spinner) until the page loads completely\n- Display filter badges in cancer variants list\n- Update genes from pre-downloaded file resources\n- On login, OS, browser version and screen size are saved anonymously to understand how users are using Scout\n- API returning institutes data for a given user: `/api/v1/institutes`\n- API returning case data for a given institute: `/api/v1/institutes/<institute_id>/cases`\n- Added GMS and Lund university hospital logos to login page\n- Made display of Swedac logo configurable\n- Support for displaying custom images in case view\n- Individual-specific HPO terms\n- Optional alamut_key in institute settings for Alamut Plus software\n- Case report API endpoint\n- Tooltip in case explaining that genes with genome build different than case genome build will not be added to dynamic HPO panel.\n- Add DeepVariant as a caller\n### Fixed\n- Updated IGV to v2.8.5 to solve missing gene labels on some zoom levels\n- Demo cancer case config file to load somatic SNVs and SVs only.\n- Expand list of refseq trancripts in ClinVar submission form\n- Renamed `All SNVs and INDELs` institute sidebar element to `Search SNVs and INDELs` and fixed its style.\n- Add missing parameters to case load-config documentation\n- Allow creating/editing gene panels and dynamic gene panels with genes present in genome build 38\n- Bugfix broken Pytests\n- Bulk dismissing variants error due to key conversion from string to integer\n- Fix typo in index documentation\n- Fixed crash in institute settings page if \"collaborators\" key is not set in database\n- Don't stop Scout execution if LoqusDB call fails and print stacktrace to log\n- Bug when case contains custom images with value `None`\n- Bug introduced when fixing another bug in Scout-LoqusDB interaction\n- Loading of OMIM diagnoses in Scout demo instance\n- Remove the docker-compose with chanjo integration because it doesn't work yet.\n- Fixed standard docker-compose with scout demo data and database\n- Clinical variant assessments not present for pinned and causative variants on case page.\n- MatchMaker matching one node at the time only\n- Remove link from previously tiered variants badge in cancer variants page\n- Typo in gene cell on cancer variants page\n- Managed variants filter form\n### Changed\n- Better naming for variants buttons on cancer track (somatic, germline). Also show cancer research button if available.\n- Load case with missing panels in config files, but show warning.\n- Changing the (Female, Male) symbols to (F/M) letters in individuals_table and case-sma.\n- Print stacktrace if case load command fails\n- Added sort icon and a pointer to the cursor to all tables with sortable fields\n- Moved variant, gene and panel info from the basic pane to summary panel for all variants.\n- Renamed `Basics` panel to `Classify` on variant page.\n- Revamped `Basics` panel to a panel dedicated to classify variants\n- Revamped the summary panel to be more compact.\n- Added dedicated template for cancer variants\n- Removed Gene models, Gene annotations and Conservation panels for cancer variants\n- Reorganized the orders of panels for variant and cancer variant views\n- Added dedicated variant quality panel and removed relevant panes\n- A more compact case page\n- Removed OMIM genes panel\n- Make genes panel, pinned variants panel, causative variants panel and ClinVar panel scrollable on case page\n- Update to Scilifelab's 2020 logo\n- Update Gens URL to support Gens v2.0 format\n- Refactor tests for parsing case configurations\n- Updated links to HPO downloadable resources\n- Managed variants filtering defaults to all variant categories\n- Changing the (Kind) drop-down according to (Category) drop-down in Managed variant add variant\n- Moved Gens button to individuals table\n- Check resource files availability before starting updating OMIM diagnoses\n- Fix typo in `SHOW_OBSERVED_VARIANT_ARCHIVE` config param\n\n## [4.36]\n### Added\n- Parse and save splice junction tracks from case config file\n- Tooltip in observations panel, explaining that case variants with no link might be old variants, not uploaded after a case rerun\n### Fixed\n- Warning on overwriting variants with same position was no longer shown\n- Increase the height of the dropdowns to 425px\n- More indices for the case table as it grows, specifically for causatives queries\n- Splice junction tracks not centered over variant genes\n- Total number of research variants count\n- Update variants stats in case documents every time new variants are loaded\n- Bug in flashing warning messages when filtering variants\n### Changed\n- Clearer warning messages for genes and gene/gene-panels searches in variants filters\n\n## [4.35]\n### Added\n- A new index for hgnc_symbol in the hgnc_gene collection\n- A Pedigree panel in STR page\n- Display Tier I and II variants in case view causatives card for cancer cases\n### Fixed\n- Send partial file data to igv.js when visualizing sashimi plots with splice junction tracks\n- Research variants filtering by gene\n- Do not attempt to populate annotations for not loaded pinned/causatives\n- Add max-height to all dropdowns in filters\n### Changed\n- Switch off non-clinical gene warnings when filtering research variants\n- Don't display OMIM disease card in case view for cancer cases\n- Refactored Individuals and Causative card in case view for cancer cases\n- Update and style STR case report\n\n## [4.34]\n### Added\n- Saved filter lock and unlock\n- Filters can optionally be marked audited, logging the filter name, user and date on the case events and general report.\n- Added `ClinVar hits` and `Cosmic hits` in cancer SNVs filters\n- Added `ClinVar hits` to variants filter (rare disease track)\n- Load cancer demo case in docker-compose files (default and demo file)\n- Inclusive-language check using [woke](https://github.com/get-woke/woke) github action\n- Add link to HmtVar for mitochondrial variants (if VCF is annotated with HmtNote)\n- Grey background for dismissed compounds in variants list and variant page\n- Pin badge for pinned compounds in variants list and variant page\n- Support LoqusDB REST API queries\n- Add a docker-compose-matchmaker under scout/containers/development to test matchmaker locally\n- Script to investigate consequences of symbol search bug\n- Added GATK to list of SV and cancer SV callers\n### Fixed\n- Make MitoMap link work for hg38 again\n- Export Variants feature crashing when one of the variants has no primary transcripts\n- Redirect to last visited variantS page when dismissing variants from variants list\n- Improved matching of SVs Loqus occurrences in other cases\n- Remove padding from the list inside (Matching causatives from other cases) panel\n- Pass None to get_app function in CLI base since passing script_info to app factory functions was deprecated in Flask 2.0\n- Fixed failing tests due to Flask update to version 2.0\n- Speed up user events view\n- Causative view sort out of memory error\n- Use hgnc_id for gene filter query\n- Typo in case controllers displaying an error every time a patient is matched against external MatchMaker nodes\n- Do not crash while attempting an update for variant documents that are too big (> 16 MB)\n- Old STR causatives (and other variants) may not have HGNC symbols - fix sort lambda\n- Check if gene_obj has primary_transcript before trying to access it\n- Warn if a gene manually searched is in a clinical panel with an outdated name when filtering variants\n- ChrPos split js not needed on STR page yet\n### Changed\n- Remove parsing of case `genome_version`, since it's not used anywhere downstream\n- Introduce deprecation warning for Loqus configs that are not dictionaries\n- SV clinical filter no longer filters out sub 100 nt variants\n- Count cases in LoqusDB by variant type\n- Commit pulse repo badge temporarily set to weekly\n- Sort ClinVar submissions objects by ascending \"Last evaluated\" date\n- Refactored the MatchMaker integration as an extension\n- Replaced some sensitive words as suggested by woke linter\n- Documentation for load-configuration rewritten.\n- Add styles to MatchMaker matches table\n- More detailed info on the data shared in MatchMaker submission form\n\n## [4.33.1]\n### Fixed\n- Include markdown for release autodeploy docs\n- Use standard inheritance model in ClinVar (https://ftp.ncbi.nlm.nih.gov/pub/GTR/standard_terms/Mode_of_inheritance.txt)\n- Fix issue crash with variants that have been unflagged causative not being available in other causatives\n### Added\n### Changed\n\n## [4.33]\n### Fixed\n- Command line crashing when updating an individual not found in database\n- Dashboard page crashing when filters return no data\n- Cancer variants filter by chromosome\n- /api/v1/genes now searches for genes in all genome builds by default\n- Upgraded igv.js to version 2.8.1 (Fixed Unparsable bed record error)\n### Added\n- Autodeploy docs on release\n- Documentation for updating case individuals tracks\n- Filter cases and dashboard stats by analysis track\n### Changed\n- Changed from deprecated db update method\n- Pre-selected fields to run queries with in dashboard page\n- Do not filter by any institute when first accessing the dashboard\n- Removed OMIM panel in case view for cancer cases\n- Display Tier I and II variants in case view causatives panel for cancer cases\n- Refactored Individuals and Causative panels in case view for cancer cases\n\n## [4.32.1]\n### Fixed\n- iSort lint check only\n### Changed\n- Institute cases page crashing when a case has track:Null\n### Added\n\n## [4.32]\n### Added\n- Load and show MITOMAP associated diseases from VCF (INFO field: MitomapAssociatedDiseases, via HmtNote)\n- Show variant allele frequencies for mitochondrial variants (GRCh38 cases)\n- Extend \"public\" json API with diseases (OMIM) and phenotypes (HPO)\n- HPO gene list download now has option for clinical and non-clinical genes\n- Display gene splice junctions data in sashimi plots\n- Update case individuals with splice junctions tracks\n- Simple Docker compose for development with local build\n- Make Phenomodels subpanels collapsible\n- User side documentation of cytogenomics features (Gens, Chromograph, vcf2cytosure, rhocall)\n- iSort GitHub Action\n- Support LoqusDB REST API queries\n### Fixed\n- Show other causative once, even if several events point to it\n- Filtering variants by mitochondrial chromosome for cases with genome build=38\n- HPO gene search button triggers any warnings for clinical / non-existing genes also on first search\n- Fixed a bug in variants pages caused by MT variants without alt_frequency\n- Tests for CADD score parsing function\n- Fixed the look of IGV settings on SNV variant page\n- Cases analyzed once shown as `rerun`\n- Missing case track on case re-upload\n- Fixed severity rank for SO term \"regulatory region ablation\"\n### Changed\n- Refactor according to CodeFactor - mostly reuse of duplicated code\n- Phenomodels language adjustment\n- Open variants in a new window (from variants page)\n- Open overlapping and compound variants in a new window (from variant page)\n- gnomAD link points to gnomAD v.3 (build GRCh38) for mitochondrial variants.\n- Display only number of affected genes for dismissed SVs in general report\n- Chromosome build check when populating the variants filter chromosome selection\n- Display mitochondrial and rare diseases coverage report in cases with missing 'rare' track\n\n## [4.31.1]\n### Added\n### Changed\n- Remove mitochondrial and coverage report from cancer cases sidebar\n### Fixed\n- ClinVar page when dbSNP id is None\n\n## [4.31]\n### Added\n- gnomAD annotation field in admin guide\n- Export also dynamic panel genes not associated to an HPO term when downloading the HPO panel\n- Primary HGNC transcript info in variant export files\n- Show variant quality (QUAL field from vcf) in the variant summary\n- Load/update PDF gene fusion reports (clinical and research) generated with Arriba\n- Support new MANE annotations from VEP (both MANE Select and MANE Plus Clinical)\n- Display on case activity the event of a user resetting all dismissed variants\n- Support gnomAD population frequencies for mitochondrial variants\n- Anchor links in Casedata ClinVar panels to redirect after renaming individuals\n### Fixed\n- Replace old docs link www.clinicalgenomics.se/scout with new https://clinical-genomics.github.io/scout\n- Page formatting issues whenever case and variant comments contain extremely long strings with no spaces\n- Chromograph images can be one column and have scrollbar. Removed legacy code.\n- Column labels for ClinVar case submission\n- Page crashing looking for LoqusDB observation when variant doesn't exist\n- Missing inheritance models and custom inheritance models on newly created gene panels\n- Accept only numbers in managed variants filter as position and end coordinates\n- SNP id format and links in Variant page, ClinVar submission form and general report\n- Case groups tooltip triggered only when mouse is on the panel header\n### Changed\n- A more compact case groups panel\n- Added landscape orientation CSS style to cancer coverage and QC demo report\n- Improve user documentation to create and save new gene panels\n- Removed option to use space as separator when uploading gene panels\n- Separating the columns of standard and custom inheritance models in gene panels\n- Improved ClinVar instructions for users using non-English Excel\n\n## [4.30.2]\n### Added\n### Fixed\n- Use VEP RefSeq ID if RefSeq list is empty in RefSeq transcripts overview\n- Bug creating variant links for variants with no end_chrom\n### Changed\n\n## [4.30.1]\n### Added\n### Fixed\n- Cryptography dependency fixed to use version < 3.4\n### Changed\n\n## [4.30]\n### Added\n- Introduced a `reset dismiss variant` verb\n- Button to reset all dismissed variants for a case\n- Add black border to Chromograph ideograms\n- Show ClinVar annotations on variantS page\n- Added integration with GENS, copy number visualization tool\n- Added a VUS label to the manual classification variant tags\n- Add additional information to SNV verification emails\n- Tooltips documenting manual annotations from default panels\n- Case groups now show bam files from all cases on align view\n### Fixed\n- Center initial igv view on variant start with SNV/indels\n- Don't set initial igv view to negative coordinates\n- Display of GQ for SV and STR\n- Parsing of AD and related info for STRs\n- LoqusDB field in institute settings accepts only existing Loqus instances\n- Fix DECIPHER link to work after DECIPHER migrated to GRCh38\n- Removed visibility window param from igv.js genes track\n- Updated HPO download URL\n- Patch HPO download test correctly\n- Reference size on STR hover not needed (also wrong)\n- Introduced genome build check (allowed values: 37, 38, \"37\", \"38\") on case load\n- Improve case searching by assignee full name\n- Populating the LoqusDB select in institute settings\n### Changed\n- Cancer variants table header (pop freq etc)\n- Only admin users can modify LoqusDB instance in Institute settings\n- Style of case synopsis, variants and case comments\n- Switched to igv.js 2.7.5\n- Do not choke if case is missing research variants when research requested\n- Count cases in LoqusDB by variant type\n- Introduce deprecation warning for Loqus configs that are not dictionaries\n- Improve create new gene panel form validation\n- Make XM- transcripts less visible if they don't overlap with transcript refseq_id in variant page\n- Color of gene panels and comments panels on cases and variant pages\n- Do not choke if case is missing research variants when reserch requested\n\n## [4.29.1]\n### Added\n### Fixed\n- Always load STR variants regardless of RankScore threshold (hotfix)\n### Changed\n\n## [4.29]\n### Added\n- Added a page about migrating potentially breaking changes to the documentation\n- markdown_include in development requirements file\n- STR variants filter\n- Display source, Z-score, inheritance pattern for STR annotations from Stranger (>0.6.1) if available\n- Coverage and quality report to cancer view\n### Fixed\n- ACMG classification page crashing when trying to visualize a classification that was removed\n- Pretty print HGVS on gene variants (URL-decode VEP)\n- Broken or missing link in the documentation\n- Multiple gene names in ClinVar submission form\n- Inheritance model select field in ClinVar submission\n- IGV.js >2.7.0 has an issue with the gene track zoom levels - temp freeze at 2.7.0\n- Revert CORS-anywhere and introduce a local http proxy for cloud tracks\n### Changed\n\n## [4.28]\n### Added\n- Chromograph integration for displaying PNGs in case-page\n- Add VAF to cancer case general report, and remove some of its unused fields\n- Variants filter compatible with genome browser location strings\n- Support for custom public igv tracks stored on the cloud\n- Add tests to increase testing coverage\n- Update case variants count after deleting variants\n- Update IGV.js to latest (v2.7.4)\n- Bypass igv.js CORS check using `https://github.com/Rob--W/cors-anywhere`\n- Documentation on default and custom IGV.js tracks (admin docs)\n- Lock phenomodels so they're editable by admins only\n- Small case group assessment sharing\n- Tutorial and files for deploying app on containers (Kubernetes pods)\n- Canonical transcript and protein change of canonical transcript in exported variants excel sheet\n- Support for Font Awesome version 6\n- Submit to Beacon from case page sidebar\n- Hide dismissed variants in variants pages and variants export function\n- Systemd service files and instruction to deploy Scout using podman\n### Fixed\n- Bugfix: unused `chromgraph_prefix |tojson` removed\n- Freeze coloredlogs temporarily\n- Marrvel link\n- Don't show TP53 link for silent or synonymous changes\n- OMIM gene field accepts any custom number as OMIM gene\n- Fix Pytest single quote vs double quote string\n- Bug in gene variants search by similar cases and no similar case is found\n- Delete unused file `userpanel.py`\n- Primary transcripts in variant overview and general report\n- Google OAuth2 login setup in README file\n- Redirect to 'missing file'-icon if configured Chromograph file is missing\n- Javascript error in case page\n- Fix compound matching during variant loading for hg38\n- Cancer variants view containing variants dismissed with cancer-specific reasons\n- Zoom to SV variant length was missing IGV contig select\n- Tooltips on case page when case has no default gene panels\n### Changed\n- Save case variants count in case document and not in sessions\n- Style of gene panels multiselect on case page\n- Collapse/expand main HPO checkboxes in phenomodel preview\n- Replaced GQ (Genotype quality) with VAF (Variant allele frequency) in cancer variants GT table\n- Allow loading of cancer cases with no tumor_purity field\n- Truncate cDNA and protein changes in case report if longer than 20 characters\n\n\n## [4.27]\n### Added\n- Exclude one or more variant categories when running variants delete command\n### Fixed\n### Changed\n\n## [4.26.1]\n### Added\n### Fixed\n- Links with 1-letter aa codes crash on frameshift etc\n### Changed\n\n## [4.26]\n### Added\n- Extend the delete variants command to print analysis date, track, institute, status and research status\n- Delete variants by type of analysis (wgs|wes|panel)\n- Links to cBioPortal, MutanTP53, IARC TP53, OncoKB, MyCancerGenome, CIViC\n### Fixed\n- Deleted variants count\n### Changed\n- Print output of variants delete command as a tab separated table\n\n## [4.25]\n### Added\n- Command line function to remove variants from one or all cases\n### Fixed\n- Parse SMN None calls to None rather than False\n\n## [4.24.1]\n### Fixed\n- Install requirements.txt via setup file\n\n## [4.24]\n### Added\n- Institute-level phenotype models with sub-panels containing HPO and OMIM terms\n- Runnable Docker demo\n- Docker image build and push github action\n- Makefile with shortcuts to docker commands\n- Parse and save synopsis, phenotype and cohort terms from config files upon case upload\n### Fixed\n- Update dismissed variant status when variant dismissed key is missing\n- Breakpoint two IGV button now shows correct chromosome when different from bp1\n- Missing font lib in Docker image causing the PDF report download page to crash\n- Sentieon Manta calls lack Somaticscore - load anyway\n- ClinVar submissions crashing due to pinned variants that are not loaded\n- Point ExAC pLI score to new gnomad server address\n- Bug uploading cases missing phenotype terms in config file\n- STRs loaded but not shown on browser page\n- Bug when using adapter.variant.get_causatives with case_id without causatives\n- Problem with fetching \"solved\" from scout export cases cli\n- Better serialising of datetime and bson.ObjectId\n- Added `volumes` folder to .gitignore\n### Changed\n- Make matching causative and managed variants foldable on case page\n- Remove calls to PyMongo functions marked as deprecated in backend and frontend(as of version 3.7).\n- Improved `scout update individual` command\n- Export dynamic phenotypes with ordered gene lists as PDF\n\n\n## [4.23]\n### Added\n- Save custom IGV track settings\n- Show a flash message with clear info about non-valid genes when gene panel creation fails\n- CNV report link in cancer case side navigation\n- Return to comment section after editing, deleting or submitting a comment\n- Managed variants\n- MT vs 14 chromosome mean coverage stats if Scout is connected to Chanjo\n### Fixed\n- missing `vcf_cancer_sv` and `vcf_cancer_sv_research` to manual.\n- Split ClinVar multiple clnsig values (slash-separated) and strip them of underscore for annotations without accession number\n- Timeout of `All SNVs and INDELs` page when no valid gene is provided in the search\n- Round CADD (MIPv9)\n- Missing default panel value\n- Invisible other causatives lines when other causatives lack gene symbols\n### Changed\n- Do not freeze mkdocs-material to version 4.6.1\n- Remove pre-commit dependency\n\n## [4.22]\n### Added\n- Editable cases comments\n- Editable variants comments\n### Fixed\n- Empty variant activity panel\n- STRs variants popover\n- Split new ClinVar multiple significance terms for a variant\n- Edit the selected comment, not the latest\n### Changed\n- Updated RELEASE docs.\n- Pinned variants card style on the case page\n- Merged `scout export exons` and `scout view exons` commands\n\n\n## [4.21.2]\n### Added\n### Fixed\n- Do not pre-filter research variants by (case-default) gene panels\n- Show OMIM disease tooltip reliably\n### Changed\n\n## [4.21.1]\n### Added\n### Fixed\n- Small change to Pop Freq column in variants ang gene panels to avoid strange text shrinking on small screens\n- Direct use of HPO list for Clinical HPO SNV (and cancer SNV) filtering\n- PDF coverage report redirecting to login page\n### Changed\n- Remove the option to dismiss single variants from all variants pages\n- Bulk dismiss SNVs, SVs and cancer SNVs from variants pages\n\n## [4.21]\n### Added\n- Support to configure LoqusDB per institute\n- Highlight causative variants in the variants list\n- Add tests. Mostly regarding building internal datatypes.\n- Remove leading and trailing whitespaces from panel_name and display_name when panel is created\n- Mark MANE transcript in list of transcripts in \"Transcript overview\" on variant page\n- Show default panel name in case sidebar\n- Previous buttons for variants pagination\n- Adds a gh action that checks that the changelog is updated\n- Adds a gh action that deploys new releases automatically to pypi\n- Warn users if case default panels are outdated\n- Define institute-specific gene panels for filtering in institute settings\n- Use institute-specific gene panels in variants filtering\n- Show somatic VAF for pinned and causative variants on case page\n\n### Fixed\n- Report pages redirect to login instead of crashing when session expires\n- Variants filter loading in cancer variants page\n- User, Causative and Cases tables not scaling to full page\n- Improved docs for an initial production setup\n- Compatibility with latest version of Black\n- Fixed tests for Click>7\n- Clinical filter required an extra click to Filter to return variants\n- Restore pagination and shrink badges in the variants page tables\n- Removing a user from the command line now inactivates the case only if user is last assignee and case is active\n- Bugfix, LoqusDB per institute feature crashed when institute id was empty string\n- Bugfix, LoqusDB calls where missing case count\n- filter removal and upload for filters deleted from another page/other user\n- Visualize outdated gene panels info in a popover instead of a tooltip in case page side panel\n\n### Changed\n- Highlight color on normal STRs in the variants table from green to blue\n- Display breakpoints coordinates in verification emails only for structural variants\n\n\n## [4.20]\n### Added\n- Display number of filtered variants vs number of total variants in variants page\n- Search case by HPO terms\n- Dismiss variant column in the variants tables\n- Black and pre-commit packages to dev requirements\n\n### Fixed\n- Bug occurring when rerun is requested twice\n- Peddy info fields in the demo config file\n- Added load config safety check for multiple alignment files for one individual\n- Formatting of cancer variants table\n- Missing Score in SV variants table\n\n### Changed\n- Updated the documentation on how to create a new software release\n- Genome build-aware cytobands coordinates\n- Styling update of the Matchmaker card\n- Select search type in case search form\n\n\n## [4.19]\n\n### Added\n- Show internal ID for case\n- Add internal ID for downloaded CGH files\n- Export dynamic HPO gene list from case page\n- Remove users as case assignees when their account is deleted\n- Keep variants filters panel expanded when filters have been used\n\n### Fixed\n- Handle the ProxyFix ModuleNotFoundError when Werkzeug installed version is >1.0\n- General report formatting issues whenever case and variant comments contain extremely long strings with no spaces\n\n### Changed\n- Created an institute wrapper page that contains list of cases, causatives, SNVs & Indels, user list, shared data and institute settings\n- Display case name instead of case ID on clinVar submissions\n- Changed icon of sample update in clinVar submissions\n\n\n## [4.18]\n\n### Added\n- Filter cancer variants on cytoband coordinates\n- Show dismiss reasons in a badge with hover for clinical variants\n- Show an ellipsis if 10 cases or more to display with loqusdb matches\n- A new blog post for version 4.17\n- Tooltip to better describe Tumor and Normal columns in cancer variants\n- Filter cancer SNVs and SVs by chromosome coordinates\n- Default export of `Assertion method citation` to clinVar variants submission file\n- Button to export up to 500 cancer variants, filtered or not\n- Rename samples of a clinVar submission file\n\n### Fixed\n- Apply default gene panel on return to cancer variantS from variant view\n- Revert to certificate checking when asking for Chanjo reports\n- `scout download everything` command failing while downloading HPO terms\n\n### Changed\n- Turn tumor and normal allelic fraction to decimal numbers in tumor variants page\n- Moved clinVar submissions code to the institutes blueprints\n- Changed name of clinVar export files to FILENAME.Variant.csv and FILENAME.CaseData.csv\n- Switched Google login libraries from Flask-OAuthlib to Authlib\n\n\n## [4.17.1]\n\n### Fixed\n- Load cytobands for cases with chromosome build not \"37\" or \"38\"\n\n\n## [4.17]\n\n### Added\n- COSMIC badge shown in cancer variants\n- Default gene-panel in non-cancer structural view in url\n- Filter SNVs and SVs by cytoband coordinates\n- Filter cancer SNV variants by alt allele frequency in tumor\n- Correct genome build in UCSC link from structural variant page\n\n\n\n### Fixed\n- Bug in clinVar form when variant has no gene\n- Bug when sharing cases with the same institute twice\n- Page crashing when removing causative variant tag\n- Do not default to GATK caller when no caller info is provided for cancer SNVs\n\n\n## [4.16.1]\n\n### Fixed\n- Fix the fix for handling of delivery reports for rerun cases\n\n## [4.16]\n\n### Added\n- Adds possibility to add \"lims_id\" to cases. Currently only stored in database, not shown anywhere\n- Adds verification comment box to SVs (previously only available for small variants)\n- Scrollable pedigree panel\n\n### Fixed\n- Error caused by changes in WTForm (new release 2.3.x)\n- Bug in OMIM case page form, causing the page to crash when a string was provided instead of a numerical OMIM id\n- Fix Alamut link to work properly on hg38\n- Better handling of delivery reports for rerun cases\n- Small CodeFactor style issues: matchmaker results counting, a couple of incomplete tests and safer external xml\n- Fix an issue with Phenomizer introduced by CodeFactor style changes\n\n### Changed\n- Updated the version of igv.js to 2.5.4\n\n## [4.15.1]\n\n### Added\n- Display gene names in ClinVar submissions page\n- Links to Varsome in variant transcripts table\n\n### Fixed\n- Small fixes to ClinVar submission form\n- Gene panel page crash when old panel has no maintainers\n\n## [4.15]\n\n### Added\n- Clinvar CNVs IGV track\n- Gene panels can have maintainers\n- Keep variant actions (dismissed, manual rank, mosaic, acmg, comments) upon variant re-upload\n- Keep variant actions also on full case re-upload\n\n### Fixed\n- Fix the link to Ensembl for SV variants when genome build 38.\n- Arrange information in columns on variant page\n- Fix so that new cosmic identifier (COSV) is also acceptable #1304\n- Fixed COSMIC tag in INFO (outside of CSQ) to be parses as well with `&` splitter.\n- COSMIC stub URL changed to https://cancer.sanger.ac.uk/cosmic/search?q= instead.\n- Updated to a version of IGV where bigBed tracks are visualized correctly\n- Clinvar submission files are named according to the content (variant_data and case_data)\n- Always show causatives from other cases in case overview\n- Correct disease associations for gene symbol aliases that exist as separate genes\n- Re-add \"custom annotations\" for SV variants\n- The override ClinVar P/LP add-in in the Clinical Filter failed for new CSQ strings\n\n### Changed\n- Runs all CI checks in github actions\n\n## [4.14.1]\n\n### Fixed\n- Error when variant found in loqusdb is not loaded for other case\n\n## [4.14]\n\n### Added\n- Use github actions to run tests\n- Adds CLI command to update individual alignments path\n- Update HPO terms using downloaded definitions files\n- Option to use alternative flask config when running `scout serve`\n- Requirement to use loqusdb >= 2.5 if integrated\n\n### Fixed\n- Do not display Pedigree panel in cancer view\n- Do not rely on internet connection and services available when running CI tests\n- Variant loading assumes GATK if no caller set given and GATK filter status is seen in FILTER\n- Pass genome build param all the way in order to get the right gene mappings for cases with build 38\n- Parse correctly variants with zero frequency values\n- Continue even if there are problems to create a region vcf\n- STR and cancer variant navigation back to variants pages could fail\n\n### Changed\n- Improved code that sends requests to the external APIs\n- Updates ranges for user ranks to fit todays usage\n- Run coveralls on github actions instead of travis\n- Run pip checks on github actions instead of coveralls\n- For hg38 cases, change gnomAD link to point to version 3.0 (which is hg38 based)\n- Show pinned or causative STR variants a bit more human readable\n\n## [4.13.1]\n\n### Added\n### Fixed\n- Typo that caused not all clinvar conflicting interpretations to be loaded no matter what\n- Parse and retrieve clinvar annotations from VEP-annotated (VEP 97+) CSQ VCF field\n- Variant clinvar significance shown as `not provided` whenever is `Uncertain significance`\n- Phenomizer query crashing when case has no HPO terms assigned\n- Fixed a bug affecting `All SNVs and INDELs` page when variants don't have canonical transcript\n- Add gene name or id in cancer variant view\n\n### Changed\n- Cancer Variant view changed \"Variant:Transcript:Exon:HGVS\" to \"Gene:Transcript:Exon:HGVS\"\n\n## [4.13]\n\n### Added\n- ClinVar SNVs track in IGV\n- Add SMA view with SMN Copy Number data\n- Easier to assign OMIM diagnoses from case page\n- OMIM terms and specific OMIM term page\n\n### Fixed\n- Bug when adding a new gene to a panel\n- Restored missing recent delivery reports\n- Fixed style and links to other reports in case side panel\n- Deleting cases using display_name and institute not deleting its variants\n- Fixed bug that caused coordinates filter to override other filters\n- Fixed a problem with finding some INS in loqusdb\n- Layout on SV page when local observations without cases are present\n- Make scout compatible with the new HPO definition files from `http://compbio.charite.de/jenkins/`\n- General report visualization error when SNVs display names are very long\n\n\n### Changed\n\n\n## [4.12.4]\n\n### Fixed\n- Layout on SV page when local observations without cases are present\n\n## [4.12.3]\n\n### Fixed\n- Case report when causative or pinned SVs have non null allele frequencies\n\n## [4.12.2]\n\n### Fixed\n- SV variant links now take you to the SV variant page again\n- Cancer variant view has cleaner table data entries for \"N/A\" data\n- Pinned variant case level display hotfix for cancer and str - more on this later\n- Cancer variants show correct alt/ref reads mirroring alt frequency now\n- Always load all clinical STR variants even if a region load is attempted - index may be missing\n- Same case repetition in variant local observations\n\n## [4.12.1]\n\n### Fixed\n- Bug in variant.gene when gene has no HGVS description\n\n\n## [4.12]\n\n### Added\n- Accepts `alignment_path` in load config to pass bam/cram files\n- Display all phenotypes on variant page\n- Display hgvs coordinates on pinned and causatives\n- Clear panel pending changes\n- Adds option to setup the database with static files\n- Adds cli command to download the resources from CLI that scout needs\n- Adds test files for merged somatic SV and CNV; as well as merged SNV, and INDEL part of #1279\n- Allows for upload of OMIM-AUTO gene panel from static files without api-key\n\n### Fixed\n- Cancer case HPO panel variants link\n- Fix so that some drop downs have correct size\n- First IGV button in str variants page\n- Cancer case activates on SNV variants\n- Cases activate when STR variants are viewed\n- Always calculate code coverage\n- Pinned/Classification/comments in all types of variants pages\n- Null values for panel's custom_inheritance_models\n- Discrepancy between the manual disease transcripts and those in database in gene-edit page\n- ACMG classification not showing for some causatives\n- Fix bug which caused IGV.js to use hg19 reference files for hg38 data\n- Bug when multiple bam files sources with non-null values are available\n\n\n### Changed\n- Renamed `requests` file to `scout_requests`\n- Cancer variant view shows two, instead of four, decimals for allele and normal\n\n\n## [4.11.1]\n\n### Fixed\n- Institute settings page\n- Link institute settings to sharing institutes choices\n\n## [4.11.0]\n\n### Added\n- Display locus name on STR variant page\n- Alternative key `GNOMADAF_popmax` for Gnomad popmax allele frequency\n- Automatic suggestions on how to improve the code on Pull Requests\n- Parse GERP, phastCons and phyloP annotations from vep annotated CSQ fields\n- Avoid flickering comment popovers in variant list\n- Parse REVEL score from vep annotated CSQ fields\n- Allow users to modify general institute settings\n- Optionally format code automatically on commit\n- Adds command to backup vital parts `scout export database`\n- Parsing and displaying cancer SV variants from Manta annotated VCF files\n- Dismiss cancer snv variants with cancer-specific options\n- Add IGV.js UPD, RHO and TIDDIT coverage wig tracks.\n\n\n### Fixed\n- Slightly darker page background\n- Fixed an issued with parsed conservation values from CSQ\n- Clinvar submissions accessible to all users of an institute\n- Header toolbar when on Clinvar page now shows institute name correctly\n- Case should not always inactivate upon update\n- Show dismissed snv cancer variants as grey on the cancer variants page\n- Improved style of mappability link and local observations on variant page\n- Convert all the GET requests to the igv view to POST request\n- Error when updating gene panels using a file containing BOM chars\n- Add/replace gene radio button not working in gene panels\n\n\n## [4.10.1]\n\n### Fixed\n- Fixed issue with opening research variants\n- Problem with coveralls not called by Travis CI\n- Handle Biomart service down in tests\n\n\n## [4.10.0]\n\n### Added\n- Rank score model in causatives page\n- Exportable HPO terms from phenotypes page\n- AMP guideline tiers for cancer variants\n- Adds scroll for the transcript tab\n- Added CLI option to query cases on time since case event was added\n- Shadow clinical assessments also on research variants display\n- Support for CRAM alignment files\n- Improved str variants view : sorting by locus, grouped by allele.\n- Delivery report PDF export\n- New mosaicism tag option\n- Add or modify individuals' age or tissue type from case page\n- Display GC and allele depth in causatives table.\n- Included primary reference transcript in general report\n- Included partial causative variants in general report\n- Remove dependency of loqusdb by utilising the CLI\n\n### Fixed\n- Fixed update OMIM command bug due to change in the header of the genemap2 file\n- Removed Mosaic Tag from Cancer variants\n- Fixes issue with unaligned table headers that comes with hidden Datatables\n- Layout in general report PDF export\n- Fixed issue on the case statistics view. The validation bars didn't show up when all institutes were selected. Now they do.\n- Fixed missing path import by importing pathlib.Path\n- Handle index inconsistencies in the update index functions\n- Fixed layout problems\n\n\n## [4.9.0]\n\n### Added\n- Improved MatchMaker pages, including visible patient contacts email address\n- New badges for the github repo\n- Links to [GENEMANIA](genemania.org)\n- Sort gene panel list on case view.\n- More automatic tests\n- Allow loading of custom annotations in VCF using the SCOUT_CUSTOM info tag.\n\n### Fixed\n- Fix error when a gene is added to an empty dynamic gene panel\n- Fix crash when attempting to add genes on incorrect format to dynamic gene panel\n- Manual rank variant tags could be saved in a \"Select a tag\"-state, a problem in the variants view.\n- Same case evaluations are no longer shown as gray previous evaluations on the variants page\n- Stay on research pages, even if reset, next first buttons are pressed..\n- Overlapping variants will now be visible on variant page again\n- Fix missing classification comments and links in evaluations page\n- All prioritized cases are shown on cases page\n\n\n## [4.8.3]\n\n### Added\n\n### Fixed\n- Bug when ordering sanger\n- Improved scrolling over long list of genes/transcripts\n\n\n## [4.8.2]\n\n### Added\n\n### Fixed\n- Avoid opening extra tab for coverage report\n- Fixed a problem when rank model version was saved as floats and not strings\n- Fixed a problem with displaying dismiss variant reasons on the general report\n- Disable load and delete filter buttons if there are no saved filters\n- Fix problem with missing verifications\n- Remove duplicate users and merge their data and activity\n\n\n## [4.8.1]\n\n### Added\n\n### Fixed\n- Prevent login fail for users with id defined by ObjectId and not email\n- Prevent the app from crashing with `AttributeError: 'NoneType' object has no attribute 'message'`\n\n\n## [4.8.0]\n\n### Added\n- Updated Scout to use Bootstrap 4.3\n- New looks for Scout\n- Improved dashboard using Chart.js\n- Ask before inactivating a case where last assigned user leaves it\n- Genes can be manually added to the dynamic gene list directly on the case page\n- Dynamic gene panels can optionally be used with clinical filter, instead of default gene panel\n- Dynamic gene panels get link out to chanjo-report for coverage report\n- Load all clinvar variants with clinvar Pathogenic, Likely Pathogenic and Conflicting pathogenic\n- Show transcripts with exon numbers for structural variants\n- Case sort order can now be toggled between ascending and descending.\n- Variants can be marked as partial causative if phenotype is available for case.\n- Show a frequency tooltip hover for SV-variants.\n- Added support for LDAP login system\n- Search snv and structural variants by chromosomal coordinates\n- Structural variants can be marked as partial causative if phenotype is available for case.\n- Show normal and pathologic limits for STRs in the STR variants view.\n- Institute level persistent variant filter settings that can be retrieved and used.\n- export causative variants to Excel\n- Add support for ROH, WIG and chromosome PNGs in case-view\n\n### Fixed\n- Fixed missing import for variants with comments\n- Instructions on how to build docs\n- Keep sanger order + verification when updating/reloading variants\n- Fixed and moved broken filter actions (HPO gene panel and reset filter)\n- Fixed string conversion to number\n- UCSC links for structural variants are now separated per breakpoint (and whole variant where applicable)\n- Reintroduced missing coverage report\n- Fixed a bug preventing loading samples using the command line\n- Better inheritance models customization for genes in gene panels\n- STR variant page back to list button now does its one job.\n- Allows to setup scout without a omim api key\n- Fixed error causing \"favicon not found\" flash messages\n- Removed flask --version from base cli\n- Request rerun no longer changes case status. Active or archived cases inactivate on upload.\n- Fixed missing tooltip on the cancer variants page\n- Fixed weird Rank cell in variants page\n- Next and first buttons order swap\n- Added pagination (and POST capability) to cancer variants.\n- Improves loading speed for variant page\n- Problem with updating variant rank when no variants\n- Improved Clinvar submission form\n- General report crashing when dismissed variant has no valid dismiss code\n- Also show collaborative case variants on the All variants view.\n- Improved phenotype search using dataTables.js on phenotypes page\n- Search and delete users with `email` instead of `_id`\n- Fixed css styles so that multiselect options will all fit one column\n\n\n## [4.7.3]\n\n### Added\n- RankScore can be used with VCFs for vcf_cancer files\n\n### Fixed\n- Fix issue with STR view next page button not doing its one job.\n\n### Deleted\n- Removed pileup as a bam viewing option. This is replaced by IGV\n\n\n## [4.7.2]\n\n### Added\n- Show earlier ACMG classification in the variant list\n\n### Fixed\n- Fixed igv search not working due to igv.js dist 2.2.17\n- Fixed searches for cases with a gene with variants pinned or marked causative.\n- Load variant pages faster after fixing other causatives query\n- Fixed mitochondrial report bug for variants without genes\n\n## [4.7.1]\n\n### Added\n\n### Fixed\n- Fixed bug on genes page\n\n\n## [4.7.0]\n\n### Added\n- Export genes and gene panels in build GRCh38\n- Search for cases with variants pinned or marked causative in a given gene.\n- Search for cases phenotypically similar to a case also from WUI.\n- Case variant searches can be limited to similar cases, matching HPO-terms,\n  phenogroups and cohorts.\n- De-archive reruns and flag them as 'inactive' if archived\n- Sort cases by analysis_date, track or status\n- Display cases in the following order: prioritized, active, inactive, archived, solved\n- Assign case to user when user activates it or asks for rerun\n- Case becomes inactive when it has no assignees\n- Fetch refseq version from entrez and use it in clinvar form\n- Load and export of exons for all genes, independent on refseq\n- Documentation for loading/updating exons\n- Showing SV variant annotations: SV cgh frequencies, gnomad-SV, local SV frequencies\n- Showing transcripts mapping score in segmental duplications\n- Handle requests to Ensembl Rest API\n- Handle requests to Ensembl Rest Biomart\n- STR variants view now displays GT and IGV link.\n- Description field for gene panels\n- Export exons in build 37 and 38 using the command line\n\n### Fixed\n- Fixes of and induced by build tests\n- Fixed bug affecting variant observations in other cases\n- Fixed a bug that showed wrong gene coverage in general panel PDF export\n- MT report only shows variants occurring in the specific individual of the excel sheet\n- Disable SSL certifcate verification in requests to chanjo\n- Updates how intervaltree and pymongo is used to void deprecated functions\n- Increased size of IGV sample tracks\n- Optimized tests\n\n\n## [4.6.1]\n\n### Added\n\n### Fixed\n- Missing 'father' and 'mother' keys when parsing single individual cases\n\n\n## [4.6.0]\n\n### Added\n- Description of Scout branching model in CONTRIBUTING doc\n- Causatives in alphabetical order, display ACMG classification and filter by gene.\n- Added 'external' to the list of analysis type options\n- Adds functionality to display \"Tissue type\". Passed via load config.\n- Update to IGV 2.\n\n### Fixed\n- Fixed alignment visualization and vcf2cytosure availability for demo case samples\n- Fixed 3 bugs affecting SV pages visualization\n- Reintroduced the --version cli option\n- Fixed variants query by panel (hpo panel + gene panel).\n- Downloaded MT report contains excel files with individuals' display name\n- Refactored code in parsing of config files.\n\n\n## [4.5.1]\n\n### Added\n\n### Fixed\n- update requirement to use PyYaml version >= 5.1\n- Safer code when loading config params in cli base\n\n\n## [4.5.0]\n\n### Added\n- Search for similar cases from scout view CLI\n- Scout cli is now invoked from the app object and works under the app context\n\n### Fixed\n- PyYaml dependency fixed to use version >= 5.1\n\n\n## [4.4.1]\n\n### Added\n- Display SV rank model version when available\n\n### Fixed\n- Fixed upload of delivery report via API\n\n\n## [4.4.0]\n\n### Added\n- Displaying more info on the Causatives page and hiding those not causative at the case level\n- Add a comment text field to Sanger order request form, allowing a message to be included in the email\n- MatchMaker Exchange integration\n- List cases with empty synopsis, missing HPO terms and phenotype groups.\n- Search for cases with open research list, or a given case status (active, inactive, archived)\n\n### Fixed\n- Variant query builder split into several functions\n- Fixed delivery report load bug\n\n\n## [4.3.3]\n\n### Added\n- Different individual table for cancer cases\n\n### Fixed\n- Dashboard collects validated variants from verification events instead of using 'sanger' field\n- Cases shared with collaborators are visible again in cases page\n- Force users to select a real institute to share cases with (actionbar select fix)\n\n\n## [4.3.2]\n\n### Added\n- Dashboard data can be filtered using filters available in cases page\n- Causatives for each institute are displayed on a dedicated page\n- SNVs and and SVs are searchable across cases by gene and rank score\n- A more complete report with validated variants is downloadable from dashboard\n\n### Fixed\n- Clinsig filter is fixed so clinsig numerical values are returned\n- Split multi clinsig string values in different elements of clinsig array\n- Regex to search in multi clinsig string values or multi revstat string values\n- It works to upload vcf files with no variants now\n- Combined Pileup and IGV alignments for SVs having variant start and stop on the same chromosome\n\n\n## [4.3.1]\n\n### Added\n- Show calls from all callers even if call is not available\n- Instructions to install cairo and pango libs from WeasyPrint page\n- Display cases with number of variants from CLI\n- Only display cases with number of variants above certain treshold. (Also CLI)\n- Export of verified variants by CLI or from the dashboard\n- Extend case level queries with default panels, cohorts and phenotype groups.\n- Slice dashboard statistics display using case level queries\n- Add a view where all variants for an institute can be searched across cases, filtering on gene and rank score. Allows searching research variants for cases that have research open.\n\n### Fixed\n- Fixed code to extract variant conservation (gerp, phyloP, phastCons)\n- Visualization of PDF-exported gene panels\n- Reintroduced the exon/intron number in variant verification email\n- Sex and affected status is correctly displayed on general report\n- Force number validation in SV filter by size\n- Display ensembl transcripts when no refseq exists\n\n\n## [4.3.0]\n\n### Added\n- Mosaicism tag on variants\n- Show and filter on SweGen frequency for SVs\n- Show annotations for STR variants\n- Show all transcripts in verification email\n- Added mitochondrial export\n- Adds alternative to search for SVs shorter that the given length\n- Look for 'bcftools' in the `set` field of VCFs\n- Display digenic inheritance from OMIM\n- Displays what refseq transcript that is primary in hgnc\n\n### Fixed\n\n- Archived panels displays the correct date (not retroactive change)\n- Fixed problem with waiting times in gene panel exports\n- Clinvar fiter not working with human readable clinsig values\n\n## [4.2.2]\n\n### Fixed\n- Fixed gene panel create/modify from CSV file utf-8 decoding error\n- Updating genes in gene panels now supports edit comments and entry version\n- Gene panel export timeout error\n\n## [4.2.1]\n\n### Fixed\n- Re-introduced gene name(s) in verification email subject\n- Better PDF rendering for excluded variants in report\n- Problem to access old case when `is_default` did not exist on a panel\n\n\n## [4.2.0]\n\n### Added\n- New index on variant_id for events\n- Display overlapping compounds on variants view\n\n### Fixed\n- Fixed broken clinical filter\n\n\n## [4.1.4]\n\n### Added\n- Download of filtered SVs\n\n### Fixed\n- Fixed broken download of filtered variants\n- Fixed visualization issue in gene panel PDF export\n- Fixed bug when updating gene names in variant controller\n\n\n## [4.1.3]\n\n### Fixed\n- Displays all primary transcripts\n\n\n## [4.1.2]\n\n### Added\n- Option add/replace when updating a panel via CSV file\n- More flexible versioning of the gene panels\n- Printing coverage report on the bottom of the pdf case report\n- Variant verification option for SVs\n- Logs uri without pwd when connecting\n- Disease-causing transcripts in case report\n- Thicker lines in case report\n- Supports HPO search for cases, both terms or if described in synopsis\n- Adds sanger information to dashboard\n\n### Fixed\n- Use db name instead of **auth** as default for authentication\n- Fixes so that reports can be generated even with many variants\n- Fixed sanger validation popup to show individual variants queried by user and institute.\n- Fixed problem with setting up scout\n- Fixes problem when exac file is not available through broad ftp\n- Fetch transcripts for correct build in `adapter.hgnc_gene`\n\n## [4.1.1]\n- Fix problem with institute authentication flash message in utils\n- Fix problem with comments\n- Fix problem with ensembl link\n\n\n## [4.1.0]\n\n### Added\n- OMIM phenotypes to case report\n- Command to download all panel app gene panels `scout load panel --panel-app`\n- Links to genenames.org and omim on gene page\n- Popup on gene at variants page with gene information\n- reset sanger status to \"Not validated\" for pinned variants\n- highlight cases with variants to be evaluated by Sanger on the cases page\n- option to point to local reference files to the genome viewer pileup.js. Documented in `docs.admin-guide.server`\n- option to export single variants in `scout export variants`\n- option to load a multiqc report together with a case(add line in load config)\n- added a view for searching HPO terms. It is accessed from the top left corner menu\n- Updates the variants view for cancer variants. Adds a small cancer specific filter for known variants\n- Adds hgvs information on cancer variants page\n- Adds option to update phenotype groups from CLI\n\n### Fixed\n- Improved Clinvar to submit variants from different cases. Fixed HPO terms in casedata according to feedback\n- Fixed broken link to case page from Sanger modal in cases view\n- Now only cases with non empty lists of causative variants are returned in `adapter.case(has_causatives=True)`\n- Can handle Tumor only samples\n- Long lists of HGNC symbols are now possible. This was previously difficult with manual, uploaded or by HPO search when changing filter settings due to GET request limitations. Relevant pages now use POST requests. Adds the dynamic HPO panel as a selection on the gene panel dropdown.\n- Variant filter defaults to default panels also on SV and Cancer variants pages.\n\n## [4.0.0]\n\n### WARNING ###\n\nThis is a major version update and will require that the backend of pre releases is updated.\nRun commands:\n\n```\n$scout update genes\n$scout update hpo\n```\n\n- Created a Clinvar submission tool, to speed up Clinvar submission of SNVs and SVs\n- Added an analysis report page (html and PDF format) containing phenotype, gene panels and variants that are relevant to solve a case.\n\n### Fixed\n- Optimized evaluated variants to speed up creation of case report\n- Moved igv and pileup viewer under a common folder\n- Fixed MT alignment view pileup.js\n- Fixed coordinates for SVs with start chromosome different from end chromosome\n- Global comments shown across cases and institutes. Case-specific variant comments are shown only for that specific case.\n- Links to clinvar submitted variants at the cases level\n- Adapts clinvar parsing to new format\n- Fixed problem in `scout update user` when the user object had no roles\n- Makes pileup.js use online genome resources when viewing alignments. Now any instance of Scout can make use of this functionality.\n- Fix ensembl link for structural variants\n- Works even when cases does not have `'madeline_info'`\n- Parses Polyphen in correct way again\n- Fix problem with parsing gnomad from VEP\n\n### Added\n- Added a PDF export function for gene panels\n- Added a \"Filter and export\" button to export custom-filtered SNVs to CSV file\n- Dismiss SVs\n- Added IGV alignments viewer\n- Read delivery report path from case config or CLI command\n- Filter for spidex scores\n- All HPO terms are now added and fetched from the correct source (https://github.com/obophenotype/human-phenotype-ontology/blob/master/hp.obo)\n- New command `scout update hpo`\n- New command `scout update genes` will fetch all the latest information about genes and update them\n- Load **all** variants found on chromosome **MT**\n- Adds choice in cases overview do show as many cases as user like\n\n### Removed\n- pileup.min.js and pileup css are imported from a remote web location now\n- All source files for HPO information, this is instead fetched directly from source\n- All source files for gene information, this is instead fetched directly from source\n\n## [3.0.0]\n### Fixed\n- hide pedigree panel unless it exists\n\n## [1.5.1] - 2016-07-27\n### Fixed\n- look for both \".bam.bai\" and \".bai\" extensions\n\n## [1.4.0] - 2016-03-22\n### Added\n- support for local frequency through loqusdb\n- bunch of other stuff\n\n## [1.3.0] - 2016-02-19\n### Fixed\n- Update query-phenomizer and add username/password\n\n### Changed\n- Update the way a case is checked for rerun-status\n\n### Added\n- Add new button to mark a case as \"checked\"\n- Link to clinical variants _without_ 1000G annotation\n\n## [1.2.2] - 2016-02-18\n### Fixed\n- avoid filtering out variants lacking ExAC and 1000G annotations\n\n## [1.1.3] - 2015-10-01\n### Fixed\n- persist (clinical) filter when clicking load more\n- fix #154 by robustly setting clinical filter func. terms\n\n## [1.1.2] - 2015-09-07\n### Fixed\n- avoid replacing coverage report with none\n- update SO terms, refactored\n\n## [1.1.1] - 2015-08-20\n### Fixed\n- fetch case based on collaborator status (not owner)\n\n## [1.1.0] - 2015-05-29\n### Added\n- link(s) to SNPedia based on RS-numbers\n- new Jinja filter to \"humanize\" decimal numbers\n- show gene panels in variant view\n- new Jinja filter for decoding URL encoding\n- add indicator to variants in list that have comments\n- add variant number threshold and rank score threshold to load function\n- add event methods to mongo adapter\n- add tests for models\n- show badge \"old\" if comment was written for a previous analysis\n\n### Changed\n- show cDNA change in transcript summary unless variant is exonic\n- moved compounds table further up the page\n- show dates for case uploads in ISO format\n- moved variant comments higher up on page\n- updated documentation for pages\n- read in coverage report as blob in database and serve directly\n- change ``OmimPhenotype`` to ``PhenotypeTerm``\n- reorganize models sub-package\n- move events (and comments) to separate collection\n- only display prev/next links for the research list\n- include variant type in breadcrumbs e.g. \"Clinical variants\"\n\n### Removed\n- drop dependency on moment.js\n\n### Fixed\n- show the same level of detail for all frequencies on all pages\n- properly decode URL encoded symbols in amino acid/cDNA change strings\n- fixed issue with wipe permissions in MongoDB\n- include default gene lists in \"variants\" link in breadcrumbs\n\n## [1.0.2] - 2015-05-20\n### Changed\n- update case fetching function\n\n### Fixed\n- handle multiple cases with same id\n\n## [1.0.1] - 2015-04-28\n### Fixed\n- Fix building URL parameters in cases list Vue component\n\n## [1.0.0] - 2015-04-12\nCodename: Sara Lund\n\n![Release 1.0](artwork/releases/release-1-0.jpg)\n\n### Added\n- Add email logging for unexpected errors\n- New command line tool for deleting case\n\n### Changed\n- Much improved logging overall\n- Updated documentation/usage guide\n- Removed non-working IGV link\n\n### Fixed\n- Show sample display name in GT call\n- Various small bug fixes\n- Make it easier to hover over popups\n\n## [0.0.2-rc1] - 2015-03-04\n### Added\n- add protein table for each variant\n- add many more external links\n- add coverage reports as PDFs\n\n### Changed\n- incorporate user feedback updates\n- big refactor of load scripts\n\n## [0.0.2-rc2] - 2015-03-04\n### Changes\n- add gene table with gene description\n- reorganize inheritance models box\n\n### Fixed\n- avoid overwriting gene list on \"research\" load\n- fix various bugs in external links\n\n## [0.0.2-rc3] - 2015-03-05\n### Added\n- Activity log feed to variant view\n- Adds protein change strings to ODM and Sanger email\n\n### Changed\n- Extract activity log component to macro\n\n### Fixes\n- Make Ensembl transcript links use archive website\n", "# -*- coding: utf-8 -*-\nimport logging\nimport os.path\n\nfrom flask import flash, session\nfrom flask_login import current_user\n\nfrom scout.constants import CASE_SPECIFIC_TRACKS, HUMAN_REFERENCE, IGV_TRACKS\nfrom scout.server.extensions import cloud_tracks, store\nfrom scout.server.utils import case_append_alignments, institute_and_case\nfrom scout.utils.ensembl_rest_clients import EnsemblRestApiClient\n\nLOG = logging.getLogger(__name__)\nCUSTOM_TRACK_NAMES = [\"Genes\", \"ClinVar\", \"ClinVar CNVs\"]\n\n\ndef check_session_tracks(resource):\n    \"\"\"Make sure that a user requesting a resource is authenticated and resource is in session IGV tracks\n\n    Args:\n        resource(str): a resource on the server or on a remote URL\n\n    Returns\n        True is user has access to resource else False\n    \"\"\"\n    # Check that user is logged in or that file extension is valid\n    if current_user.is_authenticated is False:\n        LOG.warning(\"Unauthenticated user requesting resource via remote_static\")\n        return False\n    if resource not in session.get(\"igv_tracks\", []):\n        LOG.warning(f\"{resource} not in {session.get('igv_tracks', [])}\")\n        return False\n    return True\n\n\ndef set_session_tracks(display_obj):\n    \"\"\"Save igv tracks as a session object. This way it's easy to verify that a user is requesting one of these files from remote_static view endpoint\n\n    Args:\n        display_obj(dict): A display object containing case name, list of genes, lucus and tracks\n    \"\"\"\n    session_tracks = list(display_obj.get(\"reference_track\", {}).values())\n    for key, track_items in display_obj.items():\n        if key not in [\"tracks\", \"custom_tracks\", \"sample_tracks\", \"cloud_public_tracks\"]:\n            continue\n        for track_item in track_items:\n            session_tracks += list(track_item.values())\n\n    session[\"igv_tracks\"] = session_tracks\n\n\ndef make_igv_tracks(case_obj, variant_id, chrom=None, start=None, stop=None):\n    \"\"\"Create a dictionary containing the required tracks for displaying IGV tracks for case or a group of cases\n\n    Args:\n        institute_id(str): institute _id\n        case_obj(scout.models.Case)\n        variant_id(str): _id of a variant\n        chrom(str/None): requested chromosome [1-22], X, Y, [M-MT]\n        start(int/None): start of the genomic interval to be displayed\n        stop(int/None): stop of the genomic interval to be displayed\n\n    Returns:\n        display_obj(dict): A display object containing case name, list of genes, lucus and tracks\n    \"\"\"\n    display_obj = {}\n    variant_obj = store.variant(document_id=variant_id)\n\n    if variant_obj:\n        # Set display locus\n        start = start or variant_obj[\"position\"]\n        stop = stop or variant_obj[\"end\"]\n\n        chromosome = chrom or variant_obj.get(\"chromosome\")\n        chromosome = chromosome.replace(\"MT\", \"M\")\n        display_obj[\"locus\"] = \"chr{0}:{1}-{2}\".format(chromosome, start, stop)\n    else:\n        chromosome = \"All\"\n\n    # Set genome build for displaying alignments:\n    if \"38\" in str(case_obj.get(\"genome_build\", \"37\")) or chromosome == \"M\":\n        build = \"38\"\n    else:\n        build = \"37\"\n\n    # Set general tracks (Genes, Clinvar and ClinVar SNVs are shown according to user preferences)\n    set_common_tracks(display_obj, build)\n\n    # Build tracks for main case and all connected cases (cases grouped with main case)\n    grouped_cases = []\n    for group in case_obj.get(\"group\", []):\n        group_cases = list(store.cases(group=group))\n        for case in group_cases:\n            case_append_alignments(case)  # Add track data to connected case dictionary\n            grouped_cases.append(case)\n\n    if not grouped_cases:  # Display case individuals tracks only\n        case_append_alignments(case_obj)  # Add track data to main case dictionary\n        grouped_cases.append(case_obj)\n\n    # Set up bam/cram alignments for case group samples:\n    set_sample_tracks(display_obj, grouped_cases, chromosome)\n\n    # When chrom != MT, set up case-specific tracks (might be present according to the pipeline)\n    if chrom != \"M\":\n        set_case_specific_tracks(display_obj, case_obj)\n\n    # Set up custom cloud public tracks, if available\n    set_cloud_public_tracks(display_obj, build)\n\n    display_obj[\"display_center_guide\"] = True\n\n    return display_obj\n\n\ndef make_sashimi_tracks(case_obj, variant_id):\n    \"\"\"Create a dictionary containing the required tracks for a splice junction plot\n\n    Args:\n        case_obj(scout.models.Case)\n        variant_id(str) _id of a variant\n    Returns:\n        display_obj(dict): A display object containing case name, list of genes, lucus and tracks\n    \"\"\"\n    build = \"38\"  # This feature is only available for RNA tracks in build 38\n\n    variant_obj = store.variant(document_id=variant_id)\n\n    # Initialize locus coordinates it with variant coordinates so it won't crash if variant gene(s) no longer exist in database\n    locus_start_coords = []\n    locus_end_coords = []\n\n    # Check if variant coordinates are in genome build 38\n    # Otherwise do variant coords liftover\n    if build not in str(case_obj.get(\"genome_build\")):\n        client = EnsemblRestApiClient()\n        mapped_coords = client.liftover(\n            case_obj.get(\"genome_build\"),\n            variant_obj.get(\"chromosome\"),\n            variant_obj.get(\"position\"),\n            variant_obj.get(\"end\"),\n        )\n        if mapped_coords:\n            mapped_start = mapped_coords[0][\"mapped\"].get(\"start\")\n            mapped_end = mapped_coords[0][\"mapped\"].get(\"end\") or mapped_start\n            locus_start_coords.append(mapped_start)\n            locus_end_coords.append(mapped_end)\n\n    # Use original coordinates only genome build was already 38 or liftover didn't work\n    if not locus_start_coords:\n        locus_start_coords.append(variant_obj.get(\"position\"))\n    if not locus_end_coords:\n        locus_end_coords.append(variant_obj.get(\"end\"))\n\n    # Collect locus coordinates. Take into account that variant can hit multiple genes\n    variant_genes_ids = [gene[\"hgnc_id\"] for gene in variant_obj.get(\"genes\", [])]\n    for gene_id in variant_genes_ids:\n        gene_caption = store.hgnc_gene_caption(hgnc_identifier=gene_id, build=build)\n        if gene_caption is None:\n            continue\n        locus_start_coords.append(gene_caption[\"start\"])\n        locus_end_coords.append(gene_caption[\"end\"])\n\n    locus_start = min(locus_start_coords)\n    locus_end = max(locus_end_coords)\n\n    locus = f\"{variant_obj['chromosome']}:{locus_start}-{locus_end}\"  # Locus will span all genes the variant falls into\n    display_obj = {\"locus\": locus, \"tracks\": []}\n\n    # Add Genes and reference tracks to display object\n    set_common_tracks(display_obj, build)\n\n    # Populate tracks for each individual with splice junction track data\n    for ind in case_obj.get(\"individuals\", []):\n        if not all([ind.get(\"splice_junctions_bed\"), ind.get(\"rna_coverage_bigwig\")]):\n            continue\n\n        coverage_wig = ind[\"rna_coverage_bigwig\"]\n        splicej_bed = ind[\"splice_junctions_bed\"]\n        splicej_bed_index = f\"{splicej_bed}.tbi\" if os.path.isfile(f\"{splicej_bed}.tbi\") else None\n        if splicej_bed_index is None:\n            flash(f\"Missing bed file index for individual {ind['display_name']}\")\n\n        track = {\n            \"name\": ind[\"display_name\"],\n            \"coverage_wig\": coverage_wig,\n            \"splicej_bed\": splicej_bed,\n            \"splicej_bed_index\": splicej_bed_index,\n        }\n        display_obj[\"tracks\"].append(track)\n\n    display_obj[\"case\"] = case_obj[\"display_name\"]\n\n    return display_obj\n\n\ndef set_tracks(name, file_list):\n    \"\"\"Return a dict according to IGV track format.\"\"\"\n    track_list = []\n    for track in file_list:\n        track_list.append({\"name\": name, \"url\": track, \"min\": 0.0, \"max\": 30.0})\n    return track_list\n\n\ndef set_common_tracks(display_obj, build):\n    \"\"\"Set up tracks common to all cases (Genes, ClinVar ClinVar CNVs) according to user preferences\n\n    Args:\n        display_obj(dict) dictionary containing all tracks info\n        build(string) \"37\" or \"38\"\n    \"\"\"\n    user_obj = store.user(email=current_user.email)\n\n    # Set up IGV tracks that are common for all cases:\n    display_obj[\"reference_track\"] = HUMAN_REFERENCE[build]  # Human reference is always present\n\n    # if user settings for igv tracks exist -> use these settings, otherwise display all tracks\n    custom_tracks_names = user_obj.get(\"igv_tracks\") or CUSTOM_TRACK_NAMES\n\n    display_obj[\"custom_tracks\"] = []\n    for track in IGV_TRACKS[build]:\n        # if track is selected, add it to track display object\n        if track[\"name\"] in custom_tracks_names:\n            display_obj[\"custom_tracks\"].append(track)\n\n\ndef set_sample_tracks(display_obj, case_groups, chromosome):\n    \"\"\"Set up individual-specific alignment tracks (bam/cram files)\n\n    Args:\n        display_obj(dict): dictionary containing all tracks info\n        case_groups(list): a list of case dictionaries\n        chromosome(str) [1-22],X,Y,M or \"All\"\n    \"\"\"\n    sample_tracks = []\n\n    track_items = \"mt_bams\" if chromosome == \"M\" else \"bam_files\"\n    track_index_items = \"mt_bais\" if track_items == \"mt_bams\" else \"bai_files\"\n\n    # Loop over a group of cases and add tracks for every individual of of every case\n    for case in case_groups:\n        if None in [\n            case.get(\"sample_names\"),\n            case.get(track_items),\n            case.get(track_index_items),\n        ]:\n            case[\"sample_tracks\"] = []\n            return\n\n        for count, sample in enumerate(case.get(\"sample_names\")):\n            sample_tracks.append(\n                {\n                    \"name\": sample,\n                    \"url\": case[track_items][count],\n                    \"indexURL\": case[track_index_items][count],\n                    \"format\": case[track_items][count].split(\".\")[-1],  # \"bam\" or \"cram\"\n                    \"height\": 700,\n                }\n            )\n        display_obj[\"sample_tracks\"] = sample_tracks\n\n\ndef set_case_specific_tracks(display_obj, case_obj):\n    \"\"\"Set up tracks from files that might be present or not at the case level\n        (rhocall files, tiddit coverage files, upd regions and sites files)\n    Args:\n        display_obj(dict) dictionary containing all tracks info\n        form(dict) flask request form dictionary\n    \"\"\"\n    for track, label in CASE_SPECIFIC_TRACKS.items():\n        if case_obj.get(track) is None:\n            continue\n        track_info = set_tracks(label, case_obj.get(track).split(\",\"))\n        display_obj[track] = track_info\n\n\ndef set_cloud_public_tracks(display_obj, build):\n    \"\"\"Set up custom public tracks stored in a cloud bucket, according to the user preferences\n\n    Args:\n        display_obj(dict) dictionary containing all tracks info\n        build(string) \"37\" or \"38\"\n    \"\"\"\n    user_obj = store.user(email=current_user.email)\n    custom_tracks_names = user_obj.get(\"igv_tracks\")\n\n    cloud_public_tracks = []\n    if hasattr(cloud_tracks, \"public_tracks\"):\n        build_tracks = cloud_tracks.public_tracks.get(build, [])\n        for track in build_tracks:\n            # Do not display track if user doesn't want to see it\n            if custom_tracks_names and track[\"name\"] not in custom_tracks_names:\n                continue\n            cloud_public_tracks.append(track)\n    if cloud_public_tracks:\n        display_obj[\"cloud_public_tracks\"] = cloud_public_tracks\n", "# -*- coding: utf-8 -*-\nimport logging\n\nimport requests\nfrom flask import (\n    Blueprint,\n    Response,\n    abort,\n    copy_current_request_context,\n    render_template,\n    request,\n    session,\n)\nfrom flask_login import current_user\n\nfrom scout.server.extensions import store\nfrom scout.server.utils import institute_and_case\n\nfrom . import controllers\nfrom .partial import send_file_partial\n\nalignviewers_bp = Blueprint(\n    \"alignviewers\",\n    __name__,\n    template_folder=\"templates\",\n    static_folder=\"static\",\n    static_url_path=\"/alignviewers/static\",\n)\n\nLOG = logging.getLogger(__name__)\n\n\n@alignviewers_bp.route(\"/remote/cors/<path:remote_url>\", methods=[\"OPTIONS\", \"GET\"])\ndef remote_cors(remote_url):\n    \"\"\"Proxy a remote URL.\n    Useful to e.g. eliminate CORS issues when the remote site does not\n        communicate CORS headers well, as in cloud tracks on figshare for IGV.js.\n\n    Based on code from answers to this thread:\n        https://stackoverflow.com/questions/6656363/proxying-to-another-web-service-with-flask/\n    \"\"\"\n    # Check that user is logged in or that file extension is valid\n    if controllers.check_session_tracks(remote_url) is False:\n        return abort(403)\n\n    resp = requests.request(\n        method=request.method,\n        url=remote_url,\n        headers={key: value for (key, value) in request.headers if key != \"Host\"},\n        data=request.get_data(),\n        cookies=request.cookies,\n        allow_redirects=True,\n    )\n\n    excluded_headers = [\n        \"content-encoding\",\n        \"content-length\",\n        \"transfer-encoding\",\n        \"connection\",\n    ]\n    headers = [\n        (name, value)\n        for (name, value) in resp.raw.headers.items()\n        if name.lower() not in excluded_headers\n    ]\n\n    response = Response(resp.content, resp.status_code, headers)\n    return response\n\n\n@alignviewers_bp.route(\"/remote/static\", methods=[\"OPTIONS\", \"GET\"])\ndef remote_static():\n    \"\"\"Stream *large* static files with special requirements.\"\"\"\n    file_path = request.args.get(\"file\") or \".\"\n\n    # Check that user is logged in or that file extension is valid\n    if controllers.check_session_tracks(file_path) is False:\n        return abort(403)\n\n    range_header = request.headers.get(\"Range\", None)\n    if not range_header and (file_path.endswith(\".bam\") or file_path.endswith(\".cram\")):\n        return abort(500)\n\n    new_resp = send_file_partial(file_path)\n    return new_resp\n\n\n@alignviewers_bp.route(\n    \"/<institute_id>/<case_name>/<variant_id>/igv-splice-junctions\", methods=[\"GET\"]\n)\ndef sashimi_igv(institute_id, case_name, variant_id):\n    \"\"\"Visualize splice junctions on igv.js sashimi-like viewer for one or more individuals of a case.\n    wiki: https://github.com/igvteam/igv.js/wiki/Splice-Junctions\n    \"\"\"\n    _, case_obj = institute_and_case(\n        store, institute_id, case_name\n    )  # This function takes care of checking if user is authorized to see resource\n\n    display_obj = controllers.make_sashimi_tracks(case_obj, variant_id)\n    controllers.set_session_tracks(display_obj)\n\n    response = Response(render_template(\"alignviewers/igv_sashimi_viewer.html\", **display_obj))\n\n    @response.call_on_close\n    @copy_current_request_context\n    def clear_session_tracks():\n        session.pop(\"igv_tracks\", None)  # clean up igv session tracks\n\n    return response\n\n\n@alignviewers_bp.route(\"/<institute_id>/<case_name>/igv\", methods=[\"GET\"])  # from case page\n@alignviewers_bp.route(\n    \"/<institute_id>/<case_name>/<variant_id>/igv\", methods=[\"GET\"]\n)  # from SNV and STR variant page\n@alignviewers_bp.route(\n    \"/<institute_id>/<case_name>/<variant_id>/<chrom>/<start>/<stop>/igv\", methods=[\"GET\"]\n)  # from SV variant page, where you have to pass breakpoints coordinates\ndef igv(institute_id, case_name, variant_id=None, chrom=None, start=None, stop=None):\n    \"\"\"Visualize BAM alignments using igv.js (https://github.com/igvteam/igv.js)\n\n    Args:\n        institute_id(str): _id of an institute\n        case_name(str): dislay_name of a case\n        variant_id(str/None): variant _id or None\n        chrom(str/None): requested chromosome [1-22], X, Y, [M-MT]\n        start(int/None): start of the genomic interval to be displayed\n        stop(int/None): stop of the genomic interval to be displayed\n\n    Returns:\n        a string, corresponging to the HTML rendering of the IGV alignments page\n    \"\"\"\n    _, case_obj = institute_and_case(\n        store, institute_id, case_name\n    )  # This function takes care of checking if user is authorized to see resource\n\n    display_obj = controllers.make_igv_tracks(case_obj, variant_id, chrom, start, stop)\n    controllers.set_session_tracks(display_obj)\n\n    response = Response(render_template(\"alignviewers/igv_viewer.html\", **display_obj))\n\n    @response.call_on_close\n    @copy_current_request_context\n    def clear_session_tracks():\n        session.pop(\"igv_tracks\", None)  # clean up igv session tracks\n\n    return response\n", "# -*- coding: utf-8 -*-\nimport requests\nfrom flask import session, url_for\n\nfrom scout.server.extensions import store\n\n\ndef test_remote_static_no_auth(app):\n    \"\"\"Test endpoint that serves alignment files as non-logged user\"\"\"\n    # GIVEN a running demo app\n    with app.test_client() as client:\n        # GIVEN that user is not logged in\n        resp = client.get(\n            url_for(\n                \"alignviewers.remote_static\",\n                file=\"../demo/ACC5963A1_lanes_1234_star_sorted_sj_filtered_sorted.bed.gz\",\n            )\n        )\n        # THEN endpoint should return forbidden (403)\n        assert resp.status_code == 403\n\n\ndef test_test_remote_static_not_in_session(app):\n    \"\"\"Test endpoint that serves alignment files that are not saved in the session\"\"\"\n\n    # GIVEN a running demo app\n    with app.test_client() as client:\n        # GIVEN that user is \u00dflogged in\n        client.get(url_for(\"auto_login\"))\n        # If requested file doesn't have a valid extension\n        resp = client.get(\n            url_for(\n                \"alignviewers.remote_static\",\n                file=\"config.py\",\n            )\n        )\n        # THEN endpoint should return forbidden (403)\n        assert resp.status_code == 403\n\n\ndef test_remote_static(app):\n    \"\"\"Test endpoint that serves files as a logged user\"\"\"\n    # GIVEN a file on disk\n    file = \"../demo/ACC5963A1_lanes_1234_star_sorted_sj_filtered_sorted.bed.gz\"\n\n    # GIVEN a running demo app\n    with app.test_client() as client:\n        # GIVEN that user is logged in\n        client.get(url_for(\"auto_login\"))\n\n        # GIVEN that resource file exists in user session\n        with client.session_transaction() as session:\n            session[\"igv_tracks\"] = [file]\n\n        # THEN the resource should be available to the user\n        resp = client.get(\n            url_for(\n                \"alignviewers.remote_static\",\n                file=file,\n            )\n        )\n        assert resp.status_code == 200\n\n\ndef test_remote_cors_wrong_resource(app):\n    \"\"\"Test endpoint that serves as a proxy to the actual remote track on the cloud\"\"\"\n    # GIVEN a resource not present in session[\"igv_tracks\"]\n    an_url = \"http://google.com\"\n\n    # GIVEN a running demo app\n    with app.test_client() as client:\n        # GIVEN that the user could be logged in\n        resp = client.get(url_for(\"auto_login\"))\n\n        # WHEN the remote cors endpoint is invoked with an url\n        resp = client.get(url_for(\"alignviewers.remote_cors\", remote_url=an_url))\n\n        # THEN it should return forbidden (403)\n        assert resp.status_code == 403\n\n\ndef test_remote_cors(app):\n    \"\"\"Test endpoint that serves as a proxy to the actual remote track on the cloud\"\"\"\n    # GIVEN an igv track on the cloud\n    cloud_track_url = \"https://s3-eu-west-1.amazonaws.com/pfigshare-u-files/25777460/GRCh37.variant_call.clinical.pathogenic_or_likely_pathogenic.vcf.gz.tbi\"\n\n    # GIVEN a running demo app\n    with app.test_client() as client:\n        # GIVEN that the user could be logged in\n        resp = client.get(url_for(\"auto_login\"))\n\n        # GIVEN that resource url exists in user session\n        with client.session_transaction() as session:\n            session[\"igv_tracks\"] = [cloud_track_url]\n\n        # WHEN the remote cors endpoint is invoked with cloud_track_url\n        resp = client.get(url_for(\"alignviewers.remote_cors\", remote_url=cloud_track_url))\n\n        # THEN response should be successful\n        assert resp.status_code == 200\n\n\ndef test_igv_not_authorized(app, user_obj, case_obj, variant_obj):\n    \"\"\"Test view requests and produces igv alignments, when the user dosn't have access to the case\"\"\"\n\n    # GIVEN a user that is not an admin nor has access to demo case:\n    store.user_collection.find_one_and_update(\n        {\"_id\": user_obj[\"_id\"]},\n        {\"$set\": {\"roles\": [], \"institutes\": []}},\n    )\n\n    # GIVEN an initialized app\n    with app.test_client() as client:\n\n        # GIVEN that the user is logged in\n        client.get(url_for(\"auto_login\"))\n\n        # WHEN the igv endpoint is invoked with the right parameters\n        resp = client.get(\n            url_for(\n                \"alignviewers.igv\",\n                institute_id=case_obj[\"owner\"],\n                case_name=case_obj[\"display_name\"],\n                variant_id=variant_obj[\"_id\"],\n            )\n        )\n\n        # THEN the response should be \"not authorized\" (403)\n        assert resp.status_code == 403\n\n\ndef test_igv_authorized(app, user_obj, case_obj, variant_obj):\n    \"\"\"Test view requests and produces igv alignments, when the user has access to the case\"\"\"\n\n    # GIVEN an initialized app\n    with app.test_client() as client:\n\n        # GIVEN that the user is logged in\n        client.get(url_for(\"auto_login\"))\n\n        # WHEN the igv endpoint is invoked with the right parameters\n        resp = client.get(\n            url_for(\n                \"alignviewers.igv\",\n                institute_id=case_obj[\"owner\"],\n                case_name=case_obj[\"display_name\"],\n                variant_id=variant_obj[\"_id\"],\n            )\n        )\n\n        # THEN the response should be a valid HTML page\n        assert resp.status_code == 200\n        # AND when the reponse is closed case IGV tracks should be removed from session\n        resp.close()\n        assert session.get(\"igv_tracks\") is None\n"], "filenames": ["CHANGELOG.md", "scout/server/blueprints/alignviewers/controllers.py", "scout/server/blueprints/alignviewers/views.py", "tests/server/blueprints/alignviewers/test_alignviewers_views.py"], "buggy_code_start_loc": [31, 16, 41, 49], "buggy_code_end_loc": [31, 26, 75, 78], "fixing_code_start_loc": [32, 17, 42, 50], "fixing_code_end_loc": [33, 45, 78, 100], "type": "CWE-918", "message": "Server-Side Request Forgery in scout in GitHub repository clinical-genomics/scout prior to v4.42. An attacker could make the application perform arbitrary requests to fishing steal cookie, request to private area, or lead to xss...", "other": {"cve": {"id": "CVE-2022-1592", "sourceIdentifier": "security@huntr.dev", "published": "2022-05-05T11:15:08.117", "lastModified": "2022-05-12T20:28:29.810", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Server-Side Request Forgery in scout in GitHub repository clinical-genomics/scout prior to v4.42. An attacker could make the application perform arbitrary requests to fishing steal cookie, request to private area, or lead to xss..."}, {"lang": "es", "value": "Una vulnerabilidad de tipo Server-Side Request Forgery en scout en el repositorio de GitHub clinical-genomics/scout versiones anteriores a v4.42. Un atacante podr\u00eda hacer que la aplicaci\u00f3n llevara a cabo peticiones arbitrarias para pescar robar la cookie, petici\u00f3n al \u00e1rea privada, o llevar a un ataque de tipo xss..."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 8.2, "baseSeverity": "HIGH"}, "exploitabilityScore": 3.9, "impactScore": 4.2}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:L", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "LOW", "baseScore": 9.4, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.9, "impactScore": 5.5}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:N/C:P/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 6.4}, "baseSeverity": "MEDIUM", "exploitabilityScore": 10.0, "impactScore": 4.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-918"}]}, {"source": "security@huntr.dev", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-918"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:clinical-genomics:scout:*:*:*:*:*:*:*:*", "versionEndExcluding": "4.42", "matchCriteriaId": "81B0088E-EEFE-4123-87FE-CDE182D1A5B2"}]}]}], "references": [{"url": "https://github.com/clinical-genomics/scout/commit/b0ef15f4737d0c801154c1991b52ff5cab4f5c83", "source": "security@huntr.dev", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://huntr.dev/bounties/352b39da-0f2e-415a-9793-5480cae8bd27", "source": "security@huntr.dev", "tags": ["Exploit", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/clinical-genomics/scout/commit/b0ef15f4737d0c801154c1991b52ff5cab4f5c83"}}