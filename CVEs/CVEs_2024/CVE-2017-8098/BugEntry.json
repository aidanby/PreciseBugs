{"buggy_code": ["<?php\r\n/*\r\n * e107 website system\r\n *\r\n * Copyright (C) 2008-2015 e107 Inc (e107.org)\r\n * Released under the terms and conditions of the\r\n * GNU General Public License (http://www.gnu.org/licenses/gpl.txt)\r\n *\r\n * Administration Area - Front page\r\n *\r\n*/\r\n\r\n/**\r\n *\te107 Front page administration\r\n *\r\n *\t@package\te107\r\n *\t@subpackage\tadmin\r\n *\t@version \t$Id$;\r\n */\r\n\r\nrequire_once ('../class2.php');\r\nif(! getperms('G'))\r\n{\r\n\te107::redirect('admin');\r\n\texit();\r\n}\r\n\r\ne107::coreLan('frontpage', true);\r\n\r\n$e_sub_cat = 'frontpage';\r\nrequire_once ('auth.php');\r\n\r\n$mes = e107::getMessage();\r\n\r\n$frontPref = e107::pref('core');              \t\t \t// Get prefs\r\n\r\n// Get list of possible options for front page\r\n$front_page['news'] = array('page' => 'news.php', 'title' => ADLAN_0); // TODO Move to e107_plugins/news\r\n\r\n$front_page['wmessage'] = array('page' => 'index.php', 'title' => ADLAN_28, 'diz'=>'index.php');\r\n\r\nif($sql->db_Select('page', 'page_id, page_title', \"menu_name=''\")) // TODO Move to e107_plugins/page\r\n{\r\n\t$front_page['custom']['title'] = FRTLAN_30;\r\n\twhile($row = $sql->db_Fetch())\r\n\t{\r\n\t\t$front_page['custom']['page'][] = array('page' => 'page.php?'.$row['page_id'], 'title' => $row['page_title']);\r\n\t}\r\n}\r\n\r\n// Now let any plugins add to the options - must append to the $front_page array as above\r\n\r\n\r\n\t//v2.x spec. ----------\r\n\t$new = e107::getAddonConfig('e_frontpage');\r\n\tforeach($new as $k=>$v)\r\n\t{\r\n\t\t$front_page[$k] = $v;\r\n\t}\r\n\r\n\t// v1.x spec.---------------\r\n\tif(!empty($frontPref['e_frontpage_list']))\r\n\t{\r\n\t\tforeach($frontPref['e_frontpage_list'] as $val)\r\n\t\t{\r\n\t\t\tif(is_readable(e_PLUGIN.$val.'/e_frontpage.php'))\r\n\t\t\t{\r\n\t\t\t\trequire_once (e_PLUGIN.$val.'/e_frontpage.php');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\r\n\r\n// Make sure links relative to SITEURL\r\nforeach($front_page as &$front_value)\r\n{\r\n\tif(is_array($front_value['page']))\r\n\t{ // Its a URL with multiple options\r\n\t\tforeach($front_value['page'] as &$multipage)\r\n\t\t{\r\n\t\t\t$multipage = str_replace(e_HTTP, '', $multipage);\r\n\t\t\t//if (substr($multipage, 0, 1) != '/') $multipage = '/'.$multipage;\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$front_value = str_replace(e_HTTP, '', $front_value);\r\n\t\t//if (substr($front_value, 0, 1) != '/') $front_value = '/'.$front_value;\r\n\t}\r\n}\r\n\r\n// print_a($front_page);\r\n\r\n\r\n// Now sort out list of rules for display (based on $pref data to start with)\r\n$gotpub = FALSE;\r\nif(is_array($frontPref['frontpage']))\r\n{\r\n\t$i = 1;\r\n\tforeach($frontPref['frontpage'] as $class => $val)\r\n\t{\r\n\t\tif($class == 'all')\r\n\t\t{\r\n\t\t\t$class = e_UC_PUBLIC;\r\n\t\t\t$gotpub = TRUE;\r\n\t\t}\r\n\t\tif($val)\r\n\t\t{ // Only add non-null pages\r\n\t\t\t$fp_settings[$i] = array('order' => $i, 'class' => $class, 'page' => $val, 'force' => varset($frontPref['frontpage_force'][$class], ''));\r\n\t\t\t$i ++;\r\n\t\t}\r\n\t}\r\n}\r\nelse\r\n{ // Legacy stuff to convert\r\n\t$fp_settings = array();\r\n\t$fp_settings[] = array('order' => 0, 'class' => e_UC_PUBLIC, 'page' => varset($frontPref['frontpage'], 'news.php'), 'force' => '');\r\n}\r\n\r\nif(!$gotpub)\r\n{ // Need a 'default' setting - usually 'all'\r\n\t$fp_settings[] = array('order' => $i, 'class' => e_UC_PUBLIC, 'page' => (isset($frontPref['frontpage']['all']) ? $frontPref['frontpage']['all'] : 'news.php'), 'force' => '');\r\n}\r\n\r\n$fp_update_prefs = FALSE;\r\n\r\n\r\n/*\r\nFollowing code replaced - values not passed on image clicks with Firefox\r\nif(isset($_POST['fp_inc']))\r\n{\r\n\t$mv = intval($_POST['fp_inc']);\r\n\techo \"Increment: {$mv}<br />\";\r\n\tif(($mv > 1) && ($mv <= count($fp_settings)))\r\n\t{\r\n\t\t$temp = $fp_settings[$mv - 1];\r\n\t\t$fp_settings[$mv - 1] = $fp_settings[$mv];\r\n\t\t$fp_settings[$mv] = $temp;\r\n\t\t$fp_update_prefs = TRUE;\r\n\t\tfrontpage_adminlog('01', 'Inc '.$mv);\r\n\t}\r\n}\r\nelseif(isset($_POST['fp_dec']))\r\n{\r\n\t$mv = intval($_POST['fp_dec']);\r\n\techo \"Decrement: {$mv}<br />\";\r\n\tif(($mv > 0) && ($mv < count($fp_settings)))\r\n\t{\r\n\t\t$temp = $fp_settings[$mv + 1];\r\n\t\t$fp_settings[$mv + 1] = $fp_settings[$mv];\r\n\t\t$fp_settings[$mv] = $temp;\r\n\t\t$fp_update_prefs = TRUE;\r\n\t\tfrontpage_adminlog('01', 'Dec '.$mv);\r\n\t}\r\n}\r\n*/\r\n\r\nif (isset($_POST))\r\n{\r\n\r\n\t// avoid endless loop.\r\n\tif($_POST['frontpage'] == 'other' && (trim($_POST['frontpage_other']) == 'index.php' || trim($_POST['frontpage_other']) == '{e_BASE}index.php'))\r\n\t{\r\n\t\t$_POST['frontpage'] = 'wmessage';\r\n\t\t$_POST['frontpage_other'] = '';\r\n\t}\r\n\r\n\r\n\tforeach ($_POST as $k => $v)\r\n\t{\r\n\t\t$incDec = substr($k, 0, 6);\r\n\t\t$idNum = substr($k, 6);\r\n\t\tif ($incDec == 'fp_inc')\r\n\t\t{\r\n\t\t\t$mv = intval($idNum);\r\n\t\t\tif(($mv > 1) && ($mv <= count($fp_settings)))\r\n\t\t\t{\r\n\t\t\t\t$temp = $fp_settings[$mv - 1];\r\n\t\t\t\t$fp_settings[$mv - 1] = $fp_settings[$mv];\r\n\t\t\t\t$fp_settings[$mv] = $temp;\r\n\t\t\t\t$fp_update_prefs = TRUE;\r\n\t\t\t\tfrontpage_adminlog('01', 'Inc '.$mv);\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\telseif ($incDec == 'fp_dec')\r\n\t\t{\r\n\t\t\t$mv = intval($idNum);\r\n\t\t\tif(($mv > 0) && ($mv < count($fp_settings)))\r\n\t\t\t{\r\n\t\t\t\t$temp = $fp_settings[$mv + 1];\r\n\t\t\t\t$fp_settings[$mv + 1] = $fp_settings[$mv];\r\n\t\t\t\t$fp_settings[$mv] = $temp;\r\n\t\t\t\t$fp_update_prefs = TRUE;\r\n\t\t\t\tfrontpage_adminlog('01', 'Dec '.$mv);\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n\r\n\r\n// Edit an existing rule\r\nif(isset($_POST['fp_edit_rule']))\r\n{\r\n\t$_POST['type'] = (isset($_POST['edit']['all'])) ? 'all_users' : 'user_class';\r\n\t$_POST['class'] = key($_POST['edit']);\r\n}\r\n\r\n// Cancel Edit\r\n\r\n\r\nif(isset($_POST['fp_save_new']))\r\n{ // Add or edit an existing rule here.\r\n\t// fp_order - zero for a new rule, non-zero if editing an existing rule\r\n\t// class - user class for rule\r\n\t// frontpage - radio button option indicating type of page (for home page)\r\n\t// frontpage_multipage[] - the other information for custom pages and similar - array index matches value of 'frontpage' when selected\r\n\t// frontpage_other - URL for 'other' home page\r\n\t// fp_force_page - radio button option indicating type of page (for post-login page)\r\n\t// fp_force_page_multipage[] - the other information for custom pages and similar - array index matches value of 'frontpage' when selected\r\n\t// fp_force_page_other - URL for forced post-login 'other' page\r\n\r\n\r\n\tif($_POST['frontpage'] == 'other')\r\n\t{\r\n\t\t$_POST['frontpage_other'] = trim($tp->toForm($_POST['frontpage_other']));\r\n\t\t$frontpage_value = $_POST['frontpage_other'] ? $_POST['frontpage_other'] : 'news.php';\r\n\t}\r\n\telse\r\n\t{\r\n\t\tif(is_array($front_page[$_POST['frontpage']]['page']))\r\n\t\t{\r\n\t\t\t$frontpage_value = $front_page[$_POST['frontpage']]['page'][$_POST['frontpage_multipage'][$_POST['frontpage']]]['page'];\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$frontpage_value = $front_page[$_POST['frontpage']]['page'];\r\n\t\t}\r\n\t}\r\n\r\n\tif($_POST['fp_force_page'] == 'other')\r\n\t{\r\n\t\t$_POST['fp_force_page_other'] = trim($tp->toForm($_POST['fp_force_page_other']));\r\n\t\t$forcepage_value = $_POST['fp_force_page_other']; // A null value is allowable here\r\n\t}\r\n\telse\r\n\t{\r\n\t\tif(is_array($front_page[$_POST['fp_force_page']]['page']))\r\n\t\t{\r\n\t\t\t$forcepage_value = $front_page[$_POST['fp_force_page']]['page'][$_POST['fp_force_page_multipage'][$_POST['fp_force_page']]]['page'];\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$forcepage_value = $front_page[$_POST['fp_force_page']]['page'];\r\n\t\t}\r\n\t}\r\n\r\n\t$temp = array('order' => intval($_POST['fp_order']), 'class' => $_POST['class'], 'page' => $frontpage_value, 'force' => trim($forcepage_value));\r\n\r\n\tif($temp['order'] == 0) // New index to add\r\n\t{\r\n\t\t$ind = 0;\r\n\t\tfor($i = 1; $i <= count($fp_settings); $i ++)\r\n\t\t{\r\n\t\t\tif($fp_settings[$i]['class'] == $temp['class'])\r\n\t\t\t\t$ind = $i;\r\n\t\t}\r\n\r\n\t\tif($ind)\r\n\t\t{\r\n\t\t\t$mes->addDebug(print_a($fp_settings,true));\r\n\t\t\t$mes->addError(FRTLAN_56.\" \".$ind);\r\n\t\t\tunset($fp_settings[$ind]); // Knock out duplicate definition for class\r\n\t\t}\r\n\r\n\t\tarray_unshift($fp_settings, $temp); // Deliberately add twice\r\n\t\tarray_unshift($fp_settings, $temp); // ....because re-indexed from zero\r\n\t\tunset($fp_settings[0]); // Then knock out index zero\r\n\t\t$fp_update_prefs = TRUE;\r\n\t\tfrontpage_adminlog('02', \"class => {$_POST['class']},[!br!]page => {$frontpage_value},[!br!]force => {$forcepage_value}\");\r\n\t}\r\n\telseif(array_key_exists($temp['order'], $fp_settings))\r\n\t{\r\n\t\t$fp_settings[$temp['order']] = $temp;\r\n\t\t$fp_update_prefs = TRUE;\r\n\t\tfrontpage_adminlog('03', \"posn => {$temp},[!br!]class => {$_POST['class']},[!br!]page => {$frontpage_value},[!br!]force => {$forcepage_value}\");\r\n\t}\r\n\telse\r\n\t{ // Someone playing games\r\n\t\t$mes->addError(FRTLAN_57);\r\n\t}\r\n}\r\n\r\nif(isset($_POST['fp_delete_rule']))\r\n{\r\n\tif(isset($fp_settings[key($_POST['fp_delete_rule'])]))\r\n\t{\r\n\t\t$rule_no = key($_POST['fp_delete_rule']);\r\n\t\t$array_size = count($fp_settings);\r\n\t\tfrontpage_adminlog('04', \"Rule {$rule_no},[!br!]class => {$fp_settings[$rule_no]['class']},[!br!]page => {$fp_settings[$rule_no]['page']},[!br!]force => {$fp_settings[$rule_no]['force']}\");\r\n\t\tunset($fp_settings[$rule_no]);\r\n\t\twhile($rule_no < $array_size)\r\n\t\t{ // Move up and renumber any entries after the deleted rule\r\n\t\t\t$fp_settings[$rule_no] = $fp_settings[$rule_no + 1];\r\n\t\t\t$rule_no ++;\r\n\t\t\tunset($fp_settings[$rule_no]);\r\n\t\t}\r\n\t\t$fp_update_prefs = TRUE;\r\n\t}\r\n}\r\n\r\nif($fp_update_prefs)\r\n{ // Save the two arrays\r\n\t$fp_list = array();\r\n\t$fp_force = array();\r\n\tfor($i = 1; $i <= count($fp_settings); $i ++)\r\n\t{\r\n\t\t$fp_list[$fp_settings[$i]['class']] = $fp_settings[$i]['page'];\r\n\t\t$fp_force[$fp_settings[$i]['class']] = $fp_settings[$i]['force'];\r\n\t}\r\n\r\n\t$corePrefs = e107::getConfig('core');\t\t\t\t// Core Prefs Object.\r\n\t$corePrefs->set('frontpage', $fp_list);\r\n\t$corePrefs->set('frontpage_force', $fp_force);\r\n\t$result = $corePrefs->save(FALSE, TRUE);\r\n\t$mes->addDebug(\"<h4>Home</h4>\".print_a($fp_list, true));\r\n\t$mes->addDebug(\"<h4>Post-Login</h4>\".print_a($fp_force, true));\r\n}\r\n\r\n\r\n\r\n\r\n// All updates complete now - latest data is in the $fp_settings, $fp_list and $fp_force arrays\r\n$fp = new frontpage($front_page);\r\n\r\n\r\n\r\n\r\n\r\nclass frontpage\r\n{\r\n\tprotected\t$frm;\r\n\tprotected\t$frontPage = array();\t\t// List of options for front page\r\n\r\n\tpublic function __construct($fp)\r\n\t{\r\n\t\t$this->frm = e107::getForm();\r\n\t\t$this->frontPage = $fp;\r\n\t\t\r\n\t\t$ns = e107::getRender();\r\n\t\t$mes = e107::getMessage();\r\n\t\t\r\n\t\tglobal $fp_settings;\r\n\t\t\r\n\t\t\r\n\t\tif(vartrue($_GET['mode']) == 'create')\r\n\t\t{\r\n\t\t\t$text = $this->edit_rule(array('order' => 0, 'class' => e_UC_PUBLIC, 'page' => 'news.php', 'force' => FALSE)); // Display edit form as well\r\n\t\t//\t$text .= $this->select_class($fp_settings, FALSE);\r\n\t\t\t$ns->tablerender(FRTLAN_PAGE_TITLE.SEP.FRTLAN_42, $text);\r\n\t\t}\r\n\t\telseif(vartrue($_GET['id']))\r\n\t\t{\r\n\t\t\t$key = intval($_GET['id']);\r\n\t\t\t$text = $this->edit_rule($fp_settings[$key]); // Display edit form as well\r\n\t\t//\t$text .= $this->select_class($fp_settings, FALSE);\r\n\t\t\t$ns->tablerender(FRTLAN_PAGE_TITLE.SEP.FRTLAN_46, $text);\r\n\t\t}\r\n\t\telse\r\n\t\t{ // Just show existing rules\r\n\t\t\t$ns->tablerender(FRTLAN_PAGE_TITLE.SEP.FRTLAN_13, $mes->render().$this->select_class($fp_settings, TRUE));\r\n\t\t}\r\n\t\t\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\t *\tShow a list of existing rules, with edit/delete/move buttons, and optional button to add a new rule\r\n\t *\r\n\t *\t@param boolean $show_button - show the 'Add new rule' button if true\r\n\t *\r\n\t *\t@return string text for display\r\n\t */\r\n\tfunction select_class(&$fp_settings, $show_button = TRUE)\r\n\t{\r\n\t\t$frm = e107::getForm();\r\n\t\t// List of current settings\r\n\t\t$show_legend = $show_button ? \" class='e-hideme'\" : '';\r\n\t\t$text = \"\r\n\t\t<form method='post' action='\".e_SELF.\"'>\r\n\t\t\t<fieldset id='frontpage-settings'>\r\n\t\t\t\t<legend{$show_legend}>\".FRTLAN_13.\"</legend>\r\n\r\n\t\t\t\t<table class='table adminlist'>\r\n\t\t\t\t\t<colgroup>\r\n\t\t\t\t\t\t<col style='width:  5%' />\r\n\t\t\t\t\t\t<col style='width: 25%' />\r\n\t\t\t\t\t\t<col style='width: 30%' />\r\n\t\t\t\t\t\t<col style='width: 25%' />\r\n\t\t\t\t\t\t<col style='width: 15%' />\r\n\t\t\t\t\t</colgroup>\r\n\t\t\t\t\t<thead>\r\n\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t<th class='first left'>\".LAN_ORDER.\"</th>\r\n\t\t\t\t\t\t\t<th>\".LAN_USERCLASS.\"</th>\r\n\t\t\t\t\t\t\t<th>\".FRTLAN_49.\"</th>\r\n\t\t\t\t\t\t\t<th>\".FRTLAN_35.\"</th>\r\n\t\t\t\t\t\t\t<th class='center last'>\".LAN_OPTIONS.\"</th>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t</thead>\r\n\t\t\t\t\t<tbody>\";\r\n\r\n\t\tforeach($fp_settings as $order => $current_value)\r\n\t\t{\r\n\t\t\t$title = e107::getUserClass()->getName($current_value['class']);\r\n\t\t\t$text .= \"\r\n\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t<td class='left'>\".$order.\"</td>\r\n\t\t\t\t\t\t<td>\".$title.\"</td>\r\n\t\t\t\t\t\t<td>\".$this->lookup_path($current_value['page']).\"</td>\r\n\t\t\t\t\t\t<td>\".$this->lookup_path($current_value['force']).\"</td>\r\n\t\t\t\t\t\t<td class='center options last'>\r\n\t\t\t\t\t\t<div class='btn-group'>\";\r\n\r\n\t\t\t\t\t//\t\t\".$frm->admin_button('fp_inc',$order,'up',ADMIN_UP_ICON).\"\r\n\t\t\t\t\t//\t\t\".$frm->admin_button('fp_dec',$order,'down',ADMIN_DOWN_ICON).\"\r\n\r\n\t\t\t\t\t\t$text .= \"\r\n\t\t\t\t\t\t\t<a class='btn btn-default' title='\".LAN_EDIT.\"' href='\".e_SELF.\"?id=\".$order.\"' >\".ADMIN_EDIT_ICON.\"</a>\r\n\t\t\t\t\t\t\t\".$frm->admin_button('fp_delete_rule['.$order.']',$order,'',ADMIN_DELETE_ICON).\"\t\t\t\t\t\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</td>\r\n\t\t\t\t\t</tr>\";\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t}\r\n\t\t$text .= \"\r\n\t\t \t\t</tbody>\r\n\t\t \t</table>\";\r\n\r\n\t\tif($show_button)\r\n\t\t{\r\n\t\t\t$text .= \"\r\n\t\t\t\t<div class='buttons-bar center'>\r\n\t\t\t\t\t <a href='\".e_SELF.\"?mode=create' class='btn btn-success'>\".FRTLAN_42.\"</a>\r\n\t\t\t\t</div>\";\r\n\t\t}\r\n\r\n\t\t$text .= \"\r\n\t\t\t</fieldset>\r\n\t\t\t</form>\";\r\n\r\n\t\treturn $text;\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\t *\tDisplay form to add/edit rules\r\n\t *\r\n\t *\t@param array $rule_info - initial data (must be preset if new rule)\r\n\t *\r\n\t *\t@return string - text for display\r\n\t */\r\n\tfunction edit_rule($rule_info)\r\n\t{\r\n\t\t$is_other_home = TRUE;\r\n\t\t$is_other_force = TRUE;\r\n\t\t//$force_checked = $rule_info['force'] ? \" checked='checked'\" : '';\r\n\t\t$text_tmp_1 = '';\r\n\t\t$text_tmp_2 = '';\r\n\t\tforeach($this->frontPage as $front_key => $front_value)\r\n\t\t{\r\n\t\t\t//$type_selected = FALSE;\r\n\r\n\t\t\t$text_tmp_1 .= \"\r\n\t\t\t<tr>\r\n\t\t\t\t\".$this->show_front_val('frontpage', $front_key, $front_value, $is_other_home, $rule_info['page']).\"\r\n\t\t\t</tr>\r\n\t\t  \t\";\r\n\r\n\t\t\t$text_tmp_2 .= \"\r\n\t\t\t<tr>\r\n\t\t\t\t\".$this->show_front_val('fp_force_page', $front_key, $front_value, $is_other_force, $rule_info['force']).\"\r\n\t\t\t</tr>\r\n\t\t  \t\";\r\n\r\n\t\t}\r\n\r\n// <legend class='e-hideme'>\".($rule_info['order'] ? FRTLAN_46 : FRTLAN_42).\"</legend>\r\n\r\n\t\t$text = \"\r\n\t\t<form method='post' action='\".e_SELF.\"'>\";\r\n\t\t\r\n\t\t$text .= '<ul class=\"nav nav-tabs\" id=\"myTabs\">\r\n\t\t\t<li class=\"active\"><a data-toggle=\"tab\" href=\"#home\">'.FRTLAN_49.'</a></li>\r\n\t\t\t<li><a data-toggle=\"tab\" href=\"#postlogin\">'.FRTLAN_35.'</a></li>\r\n\t\t\t</ul>\r\n\t\t\t ';\r\n\t\t\t\r\n\t\t\t$text .= \"\r\n\t\t\t<div class='tab-content'>\t\r\n\t\t\t\t<div class='tab-pane active' id='home'>\r\n\t\t\t\t\t<table class='table adminform'>\r\n\t\t\t\t\t\t<colgroup>\r\n\t\t\t\t\t\t\t<col style='width: 20%' />\r\n\t\t\t\t\t\t\t<col style='width: 80%' />\r\n\t\t\t\t\t\t</colgroup>\r\n\t\t\t\t\t\t<tbody>\r\n\t\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t<td>Selection</td>\r\n\t\t\t\t\t\t\t<td>\r\n\t\t\t\t\t\t\t\t<table class='table table-striped table-bordered'>\r\n\t\t\t\t\t\t\t\t\t<colgroup>\r\n\t\t\t\t\t\t\t\t\t\t<col style='width: 20%' />\r\n\t\t\t\t\t\t\t\t\t\t<col style='width: 80%' />\r\n\t\t\t\t\t\t\t\t\t</colgroup>\r\n\t\t\t\t\t\t\t\t\t\".$text_tmp_1.\"\r\n\t\t\t\t\t\t\t\t\t\".$this->add_other('frontpage', $is_other_home, $rule_info['page']).\"\r\n\t\t\t\t\t\t\t\t</table>\r\n\t\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t\t</tr>\r\n\r\n\t\t\t\t\t\t</tbody>\r\n\t\t\t\t\t</table>\r\n\t\t\t\t</div>\r\n\t\t\t\t\r\n\t\t\t\t<div class='tab-pane' id='postlogin'>\r\n\t\t\t\t\t<table class='table adminform'>\r\n\t\t\t\t\t\t<colgroup>\r\n\t\t\t\t\t\t\t<col style='width: 20%' />\r\n\t\t\t\t\t\t\t<col style='width: 80%' />\r\n\t\t\t\t\t\t</colgroup>\r\n\t\t\t\t\t\t<tbody><tr>\r\n\t\t\t\t\t\t\t<td></td>\r\n\t\t\t\t\t\t\t<td>\r\n\t\t\t\t\t\t\t\t<table class='table table-striped table-bordered'>\r\n\t\t\t\t\t\t\t\t<colgroup>\r\n\t\t\t\t\t\t\t\t\t<col style='width: 20%' />\r\n\t\t\t\t\t\t\t\t\t<col style='width: 80%' />\r\n\t\t\t\t\t\t\t\t</colgroup>\r\n\t\t\t\t\t\t\t\t\".$text_tmp_2.\"\r\n\t\t\t\t\t\t\t\t\".$this->add_other('fp_force_page', $is_other_force, $rule_info['force']).\"\r\n\t\t\t\t\t\t\t\t</table>\r\n\t\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t\t</tr>\r\n\r\n\t\t\t\t\t\t</tbody>\r\n\t\t\t\t\t</table>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<table class='table adminform'>\r\n\t\t\t\t<colgroup>\r\n\t\t\t\t\t<col style='width: 20%' />\r\n\t\t\t\t\t<col style='width: 80%' />\r\n\t\t\t\t</colgroup>\r\n\t\t\t\t<tr>\r\n\t\t\t\t\t<td>\".FRTLAN_43.\"</td>\r\n\t\t\t\t\t<td>\".e107::getUserClass()->uc_dropdown('class', $rule_info['class'], 'public,guest,member,admin,main,classes').\"</td>\r\n\t\t\t\t</tr>\r\n\t\t\t\t<tr>\r\n\t\t\t\t\t<td>\".LAN_ORDER.\"</td>\r\n\t\t\t\t\t<td>\".$this->frm->number('fp_order', $rule_info['order'], 3, 'min=0').\"</td>\r\n\t\t\t\t</tr>\r\n\t\t\t</table>\r\n\t\t\t\r\n\t\t\t\t<div class='buttons-bar center form-inline'>\r\n\r\n\t\t\t\t\t\".$this->frm->admin_button('fp_save_new', LAN_UPDATE, 'update').\"\r\n\t\t\t\t\t\".$this->frm->admin_button('fp_cancel', LAN_CANCEL, 'cancel').\"\r\n\t\t\t\t</div>\r\n\t\t\t\r\n\t\t</form>\r\n\t\t\";\r\n\t\treturn $text;\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\t *\tGiven a path string related to a choice, returns the 'type' (title) for it\r\n\t *\r\n\t *\t@param string $path\r\n\t *\r\n\t *\t@return string - title of option\r\n\t */\r\n\tfunction lookup_path($path)\r\n\t{\r\n\t\tforeach($this->frontPage as $front_value)\r\n\t\t{\r\n\t\t\tif(is_array($front_value['page']))\r\n\t\t\t{ // Its a URL with multiple options\r\n\t\t\t\tforeach($front_value['page'] as $multipage)\r\n\t\t\t\t{\r\n\t\t\t\t\tif($path == $multipage['page'])\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t//\t\t\t  return $front_value['title'].\":\".$path;\r\n\t\t\t\t\t\treturn $front_value['title'].\":\".$multipage['title'];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif($path == $front_value['page'])\r\n\t\t\t\t{\r\n\t\t\t\t\treturn $front_value['title'];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(strlen($path))\r\n\t\t\treturn FRTLAN_51.\":\".$path; // 'Other'\r\n\t\telse\r\n\t\t\treturn LAN_NONE; // 'None'\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\t *\tShow the selection options for a possible target of a rule\r\n\t *\r\n\t *\t@param string $ob_name - name of the radio button which selects this element \r\n\t *\t@param string $front_key \r\n\t *\t@param array|string $front_value - array of choices, or a single value\r\n\t *\t@param boolean $is_other - passed by reference - set if some other option is selected\r\n\t *\t@param string $current_setting - current value\r\n\t *\r\n\t *\t@return string - text for display\r\n\t */\r\n\tfunction show_front_val($ob_name, $front_key, $front_value, &$is_other, $current_setting)\r\n\t{\r\n\t\t$type_selected = FALSE;\r\n\t\t$text = '';\r\n\r\n\t\t// First, work out if the selection os one of these options\r\n\t\tif (is_array($front_value['page']))\r\n\t\t{ // Its a URL with multiple options\r\n\t\t\tforeach($front_value['page'] as $multipage)\r\n\t\t\t{\r\n\t\t\t\tif($current_setting == $multipage['page'])\r\n\t\t\t\t{\r\n\t\t\t\t\t$type_selected = TRUE;\r\n\t\t\t\t\t$is_other = FALSE;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tif($current_setting == $front_value['page'])\r\n\t\t\t{\r\n\t\t\t\t$type_selected = TRUE;\r\n\t\t\t\t$is_other = FALSE;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Now generate the display text - two table cells worth\r\n\t\tif (is_array($front_value['page']))\r\n\t\t{ // Multiple options for same page name\r\n\t\t\t$text .= \"\r\n\t\t\t\t<td>\r\n\t\t\t\t\t\".$this->frm->radio($ob_name, $front_key, $type_selected, array('label'=>$front_value['title'])).\"\r\n\t\t\t\t</td>\r\n\t\t\t\t<td>\r\n\t\t\t\";\r\n\t\t\t$text .= $this->frm->select_open($ob_name.'_multipage['.$front_key.']', 'size=xxlarge');\r\n\t\t\tforeach($front_value['page'] as $multipage_key => $multipage_value)\r\n\t\t\t{\r\n\t\t\t\t$text .= \"\\n\".$this->frm->option($multipage_value['title'], $multipage_key, ($current_setting == $multipage_value['page'])).\"\\n\";\r\n\t\t\t}\r\n\t\t\t$text .= $this->frm->select_close();\r\n\r\n\r\n\t\t\t$text .= \"</td>\";\r\n\t\t}\r\n\t\telse\r\n\t\t{ // Single option for URL\r\n\t\t\t$text .= \"\r\n\t\t\t\t<td>\r\n\t\t\t\t\t\".$this->frm->radio($ob_name, $front_key, $type_selected, array('label'=>$front_value['title'])).\"\r\n\r\n\t\t\t\t</td>\r\n\t\t\t\t<td>\".vartrue($front_value['diz'],\"&nbsp;\").\"</td>\";\r\n\t\t}\r\n\t\treturn $text;\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\t *\tProvide the text for an 'other' option - a text box for URL entry\r\n\t *\r\n\t *\t@param string $ob_name - name of the radio button which selects this element \r\n\t *\t@param string $front_key \r\n\t *\t@param string $curval - current 'selected' value\r\n\t *\t@param string $cur_page - probably the secondary (e.g. custom page) value for any option that has one\r\n\t *\r\n\t *\t@return string - text for display\r\n\t */\r\n\tfunction add_other($ob_name, $cur_val, $cur_page)\r\n\t{\r\n\t\t$label = ($cur_val) ? LAN_CUSTOM_URL_DISABLED : LAN_CUSTOM_URL;\r\n\t\t\r\n\t  \treturn  \"\r\n\t\t\t<td>\".$this->frm->radio($ob_name, 'other', $cur_val, array('label'=> $label)).\"</td>\r\n\t\t\t<td>\".$this->frm->text($ob_name.'_other', ($cur_val ? $cur_page : ''), 150, \"size=xxlarge&id={$ob_name}-other-txt\").\"</td>\r\n\t\t\";\r\n\t}\r\n}\r\n\r\nrequire_once(e_ADMIN.'footer.php');\r\n\r\n/**\r\n *\tLog event to admin log\r\n *\r\n *\t@param string $msg_num - exactly two numeric characters corresponding to a log message\r\n *\t@param string $woffle - information for the body of the log entre\r\n *\r\n *\t@return none\r\n */\r\nfunction frontpage_adminlog($msg_num = '00', $woffle = '')\r\n{\r\n\te107::getAdminLog()->log_event('FRONTPG_'.$msg_num, $woffle, E_LOG_INFORMATIVE, '');\r\n}\r\n\r\n\r\nfunction frontpage_adminmenu() \r\n{\r\n\r\n\t$action = vartrue($_GET['mode'],'main');\r\n\t\r\n\t$var['main']['text'] = LAN_MANAGE;\r\n\t$var['main']['link'] = e_SELF;\r\n\t$var['create']['text'] = LAN_CREATE;\r\n\t$var['create']['link'] = e_SELF.\"?mode=create\";\r\n\r\n\t\t$icon  = e107::getParser()->toIcon('e-frontpage-24');\r\n\t\t$caption = $icon.\"<span>\".FRTLAN_PAGE_TITLE.\"</span>\";\r\n\r\n\r\n\tshow_admin_menu($caption, $action, $var);\r\n}\r\n\r\n\r\n?>", "<?php\n/*\n * e107 website system\n *\n * Copyright (C) 2008-2013 e107 Inc (e107.org)\n * Released under the terms and conditions of the\n * GNU General Public License (http://www.gnu.org/licenses/gpl.txt)\n *\n * Administration Area - Meta Tags\n *\n *\n*/\nrequire_once(\"../class2.php\");\n\nif (!getperms(\"T\")) \n{\n\te107::redirect('admin');\n\texit;\n}\n\ne107::coreLan('meta', true);\n\n$e_sub_cat = 'meta';\nrequire_once(\"auth.php\");\n\n$mes = e107::getMessage();\n$frm = e107::getForm();\n$ns = e107::getRender();\n\nif (isset($_POST['metasubmit']))\n{\n\t$tmp = $pref['meta_tag'];\n\t$langs = explode(\",\",e_LANLIST);\n\tforeach($langs as $lan)\n\t{\n\t\t$meta_tag[$lan] = $tmp[$lan];\n\t\t$meta_diz[$lan] = $pref['meta_description'][$lan];\n\t\t$meta_keywords[$lan] = $pref['meta_keywords'][$lan];\n\t\t$meta_copyright[$lan] = $pref['meta_copyright'][$lan];\n\t\t$meta_author[$lan] = $pref['meta_author'][$lan];\n\t}\n\n\t$meta_tag[e_LANGUAGE] = strip_if_magic(chop($_POST['meta']));\n\t$meta_diz[e_LANGUAGE] = strip_if_magic(chop($_POST['meta_description']));\n\t$meta_keywords[e_LANGUAGE] = strip_if_magic(chop($_POST['meta_keywords']));\n\t$meta_copyright[e_LANGUAGE] = strip_if_magic(chop($_POST['meta_copyright']));\n\t$meta_author[e_LANGUAGE] = strip_if_magic(chop($_POST['meta_author']));\n\n    $pref['meta_news_summary'] = intval($_POST['meta_news_summary']);\n\t$pref['meta_tag'] = $meta_tag;\n\t$pref['meta_description'] = $meta_diz;\n\t$pref['meta_keywords'] = $meta_keywords;\n\t$pref['meta_copyright'] = $meta_copyright;\n\t$pref['meta_author'] = $meta_author;\n\n   /*\n    if($pref['meta_tag'][e_LANGUAGE] == \"\"){\n        unset($meta_tag[e_LANGUAGE]);\n    }*/\n\n\te107::getLog()->add('META_01', 'meta_news_summary=>'.$pref['meta_news_summary'].'[!br!]'.e_LANGUAGE, E_LOG_INFORMATIVE, '');\n\tsave_prefs();\n}\n\n$meta \t\t\t= vartrue($pref['meta_tag']);\n$meta_diz \t\t= vartrue($pref['meta_description']);\n$meta_keywords \t= vartrue($pref['meta_keywords']);\n$meta_copyright = vartrue($pref['meta_copyright']);\n$meta_author \t= vartrue($pref['meta_author']);\n\n\n$text = \"\n\t<form method='post' action='\".e_SELF.\"' id='dataform'>\n\t\t<fieldset id='core-meta-settings'>\n\t\t\t<legend class='e-hideme'>\".METLAN_00.\" (\".e_LANGUAGE.\")\".\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".LAN_DESCRIPTION.\"</td>\n\t\t\t\t\t\t<td>\";\n\t\t\t\t\t\t$text .= $frm->textarea('meta_description',$tp->toForm($meta_diz[e_LANGUAGE]),3,80, array('size'=>'xxlarge'));\n\t\t\t\t\t//\t$text .= \"<textarea class='tbox textarea e-autoheight' id='meta_description' name='meta_description' cols='70' rows='4'>\".$tp->toForm(varset($meta_diz[e_LANGUAGE])).\"</textarea>\";\n\t\t\t\t\t\t$text .= \"</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".LAN_KEYWORDS.\"</td>\n\t\t\t\t\t\t<td>\";\n\t\t\t\t\t\t$text .= $frm->tags('meta_keywords',$tp->toForm($meta_keywords[e_LANGUAGE]));\n\t\t\t\t\t//\t$text .= \"<textarea class='tbox textarea e-autoheight' id='meta_keywords' name='meta_keywords' cols='70' rows='4'>\".$tp->toForm(varset($meta_keywords[e_LANGUAGE])).\"</textarea>\";\n\t\t\t\t\t\t\n\t\t\t\t\t\t$text .= \"</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".LAN_COPYRIGHT.\"</td>\n\t\t\t\t\t\t<td><input class='tbox form-control input-xxlarge' size='70' type='text' name='meta_copyright' value=\\\"\".$meta_copyright[e_LANGUAGE].\"\\\" /></td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".LAN_AUTHOR.\"</td>\n\t\t\t\t\t\t<td><input class='tbox form-control input-xxlarge' size='70' type='text' name='meta_author' value=\\\"\".$meta_author[e_LANGUAGE].\"\\\" /></td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".METLAN_1.\"</td>\n\t\t\t\t\t\t<td>\";\n\t\t\t\t\t\t$text .= $frm->textarea('meta',str_replace(\"<\",\"&lt;\",$tp->toForm($meta[e_LANGUAGE])),5,100,'size=block-level');\n\t\t\t\t\t\t\n\t\t\t\t\t\t$text .= \"<span class='field-help'>\".METLAN_2.\"</span>\";\n\t\t\t\t\t\t\n\t\t\t\t//\t\t$text .= \"<textarea class='tbox textarea e-autoheight' id='meta' name='meta' cols='70' rows='10' onselect='storeCaret(this);' onclick='storeCaret(this);' onkeyup='storeCaret(this);'>\".str_replace(\"<\",\"&lt;\",$tp->toForm(varset($meta[e_LANGUAGE]))).\"</textarea><span class='field-help'>\".METLAN_2.\"</span>\";\n\t\t\t\t\t\t\n\t\t\t\t\t\t$text .= \"</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".METLAN_3.\"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t<div class='auto-toggle-area autocheck'>\".\n\t\t\t\t\t\t\t\t$frm->checkbox('meta_news_summary',1, varset($pref['meta_news_summary'])).\"\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t<div class='buttons-bar center'>\".\n\t\t\t\t$frm->admin_button('metasubmit','no-value','update', LAN_UPDATE).\"\n\t\t\t</div>\n\t\t</fieldset>\n\t</form>\n\";\n\n$ns->tablerender(METLAN_00.\" (\".e_LANGUAGE.\")\", $mes->render().$text);\n\nrequire_once(\"footer.php\");\n\n?>", "<?php\n/*\n * e107 website system\n *\n * Copyright (C) 2008-2013 e107 Inc (e107.org)\n * Released under the terms and conditions of the\n * GNU General Public License (http://www.gnu.org/licenses/gpl.txt)\n *\n * Plugin administration area\n *\n */\n\nrequire_once(\"../class2.php\");\n\nif(!getperms(\"Z\"))\n{\n\te107::redirect('admin');\n\texit;\n}\n\ne107::coreLan('plugin', true);\n\n$e_sub_cat = 'plug_manage';\n\ndefine('PLUGIN_SHOW_REFRESH', FALSE);\ndefine('PLUGIN_SCAN_INTERVAL', !empty($_SERVER['E_DEV']) ? 0 : 360);\ndefine(\"ADMIN_GITSYNC_ICON\", e107::getParser()->toGlyph('fa-refresh', array('size'=>'2x', 'fw'=>1)));\n\n\nglobal $user_pref;\n/*\n\nif(!deftrue('e_DEBUG_PLUGMANAGER'))\n{\n\trequire_once(e_HANDLER.'plugin_class.php');\n\trequire_once(e_HANDLER.'file_class.php');\n\t$plugin = new e107plugin;\n\t$pman = new pluginManager;\n\n\tdefine(\"e_PAGETITLE\",ADLAN_98.\" - \".$pman->pagetitle);\n}\n*/\n\nif(isset($_POST['uninstall_cancel']))\n{\n\theader(\"location:\".e_SELF);\n\texit;\t\t\n}\n\n\n// Experimental rewrite for v2.1.5 ----------------------\n\n\n\n\nclass plugman_adminArea extends e_admin_dispatcher\n{\n\n\tprotected $modes = array(\n\n\t\t'installed'\t=> array(\n\t\t\t'controller' \t=> 'plugin_ui',\n\t\t\t'path' \t\t\t=> null,\n\t\t\t'ui' \t\t\t=> 'plugin_form_ui',\n\t\t\t'uipath' \t\t=> null\n\t\t),\n\t\t'avail'\t=> array(\n\t\t\t'controller' \t=> 'plugin_ui',\n\t\t\t'path' \t\t\t=> null,\n\t\t\t'ui' \t\t\t=> 'plugin_form_ui',\n\t\t\t'uipath' \t\t=> null\n\t\t),\n\t\t'online'\t=> array(\n\t\t\t'controller' \t=> 'plugin_online_ui',\n\t\t\t'path' \t\t\t=> null,\n\t\t\t'ui' \t\t\t=> 'plugin_form_ui',\n\t\t\t'uipath' \t\t=> null\n\t\t),\n\t\t'create'\t=> array(\n\t\t\t'controller' \t=> 'plugin_ui',\n\t\t\t'path' \t\t\t=> null,\n\t\t\t'ui' \t\t\t=> 'plugin_form_ui',\n\t\t\t'uipath' \t\t=> null\n\t\t),\n\n\t);\n\n\n\tprotected $adminMenu = array(\n\n\t\t'installed/list'\t\t=> array('caption'=> EPL_ADLAN_22, 'perm' => 'Z'),\n\t\t'avail/list'\t\t\t=> array('caption'=> EPL_ADLAN_23, 'perm' => 'Z'),\n\t\t'online/list'\t\t\t=> array('caption'=> EPL_ADLAN_220, 'perm' => 'Z'),\n\t\t'avail/upload'\t\t\t=> array('caption'=>EPL_ADLAN_38, 'perm' => '0'),\n\t\t'create/build'          =>  array('caption'=>EPL_ADLAN_114, 'perm' => '0'),\n\n\t//\t'main/create'\t\t=> array('caption'=> LAN_CREATE, 'perm' => 'P'),\n\n\t\t// 'main/custom'\t\t=> array('caption'=> 'Custom Page', 'perm' => 'P')\n\t);\n\n\n\tprotected $defaultMode = 'installed';\n\n\n\tprotected $adminMenuAliases = array(\n\t\t'installed/uninstall'\t=> 'installed/list'\n\n\t);\n\n\tprotected $adminMenuIcon = 'e-plugmanager-24';\n\n\tfunction init()\n\t{\n\n\t\t$mode = $this->getRequest()->getMode();\n\t\t$action = $this->getRequest()->getAction();\n\n\t\tif($mode === 'online' && $action === 'download')\n\t\t{\n\t\t\tdefine('e_IFRAME', true);\n\t\t}\n\t}\n\n\n\tpublic static function getPluginManagerFields()\n\t{\n\n\t\treturn array(\n\t\t\t\t'checkboxes'         => array('title' => '', 'type' => null, 'data' => null, 'width' => '5%', 'thclass' => 'center', 'forced' => '1', 'class' => 'center', 'toggle' => 'e-multiselect',),\n\t\t        'plugin_id'          => array('title' => LAN_ID, 'data' => 'int', 'width' => '5%', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\t\t\t\t'plugin_icon'        => array('title' => LAN_ICON, 'type' => 'icon', 'data' => false, \"width\" => \"5%\", 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\t\t        'plugin_name'        => array('title' => LAN_TITLE, 'type' => 'text', 'data' => 'str', 'width' => 'auto', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\t\t        'plugin_version'     => array('title' => LAN_VERSION, 'type' => 'text', 'data' => false, 'width' => 'auto', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\t\t\t\t'plugin_date'       => array('title' => LAN_RELEASED, 'type' => 'text', 'data' => false,  \"width\" => \"8%\", 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\t\t\t    'plugin_category'    => array('title' => LAN_CATEGORY, 'type' => 'dropdown', 'data' => 'str', 'width' => 'auto', 'batch' => true, 'filter' => true, 'inline' => true, 'help' => '', 'readParms' => '', 'writeParms' => array(), 'class' => 'left', 'thclass' => 'left',),\n\n\t\t\t\t'plugin_author'      => array('title' => LAN_AUTHOR, 'type' => 'text', 'data' => false, 'width' => 'auto', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\t\t\t\t\"plugin_license\"\t => array(\"title\" => \"License\", \t 'nolist'=>false,'data'=>false,\t \"type\"=>\"text\", \"width\" => \"5%\", \"thclass\" => \"left\"),\n  \t\t\t\t'plugin_compatible'  => array('title' => EPL_ADLAN_13, 'type' => 'method', 'data' => false, 'width' => 'auto', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'center', 'thclass' => 'center',),\n\t\t\t\t'plugin_description' => array('title' => LAN_DESCRIPTION, 'type' => 'textarea', 'data' => false, 'width' => 'auto', 'help' => '', 'readParms' => 'expand=1&truncate=180&bb=1', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\n\t\t\t\t'plugin_path'        => array('title' => LAN_PATH, 'type' => 'text', 'data' => 'str', 'width' => 'auto', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\t\t        'plugin_installflag' => array('title' => EPL_ADLAN_22, 'type' => 'boolean', 'data' => 'int', 'width' => 'auto', 'filter' => false, 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'center', 'thclass' => 'center',),\n\t\t        'plugin_addons'      => array('title' => LAN_ADDONS, 'type' => 'method', 'data' => 'str', 'width' => 'auto', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\t\t         'options'            => array('title' => LAN_OPTIONS, 'type' => 'method', 'data' => null, 'width' => '10%', 'thclass' => 'center last', 'class' => 'center last', 'forced' => '1',),\n\t\t);\n\n\n\t}\n\n\n\n\n\tprotected $menuTitle = ADLAN_98;\n}\n\n\n\n\n\nclass plugin_ui extends e_admin_ui\n{\n\n\t\tprotected $pluginTitle\t\t= ADLAN_98;\n\t\tprotected $pluginName\t\t= 'core';\n\t//\tprotected $eventName\t\t= 'plugman-plugin'; // remove comment to enable event triggers in admin.\n\t\tprotected $table\t\t\t= 'plugin';\n\t\tprotected $pid\t\t\t\t= 'plugin_id';\n\t\tprotected $perPage\t\t\t= 10;\n\t\tprotected $batchDelete\t\t= false;\n\t\tprotected $batchExport     = false;\n\t\tprotected $batchCopy\t\t= false;\n\t//\tprotected $sortField\t\t= 'somefield_order';\n\t//\tprotected $orderStep\t\t= 10;\n\t//\tprotected $tabs\t\t\t\t= array('Tabl 1','Tab 2'); // Use 'tab'=>0  OR 'tab'=>1 in the $fields below to enable.\n\n\t\tprotected $listQry      \t= \"SELECT * FROM `#plugin` WHERE plugin_installflag = 1 AND plugin_category != 'menu' \"; // Example Custom Query. LEFT JOINS allowed. Should be without any Order or Limit.\n\n\t\tprotected $listOrder\t\t= 'plugin_path ASC';\n\n\t\tprotected $fields = array();\n\n\t\tprotected $fieldpref = array('plugin_icon', 'plugin_name', 'plugin_version', 'plugin_description', 'plugin_compatible', 'plugin_released','plugin_author', 'plugin_category','plugin_installflag');\n\n\n\t//\tprotected $preftabs        = array('General', 'Other' );\n\t\tprotected $prefs = array(\n\t\t);\n\n\t\t// Ideal way to set field data.\n\n\t\tpublic function __construct($request, $response, $params = array())\n\t\t{\n\t\t\t$this->fields = plugman_adminArea::getPluginManagerFields();\n\t\t\t$this->fields['plugin_category']['writeParms']['optArray'] = e107::getPlug()->getCategoryList(); // array('plugin_category_0','plugin_category_1', 'plugin_category_2'); // Example Drop-down array.\n\n\t\t\tunset($this->fields['plugin_category']['writeParms']['optArray']['menu']);\n\t\t\tunset($this->fields['plugin_category']['writeParms']['optArray']['about']);\n\n\t\t\tparent:: __construct($request, $response, $params);\n\n\t\t}\n\n\n\t\tpublic function init()\n\t\t{\n\n\t\t\tif(!e_QUERY)\n\t\t\t{\n\t\t\t\te107::getPlug()->clearCache();\n\t\t\t}\n\n\n\n\t\t\tif($this->getMode()=== 'avail')\n\t\t\t{\n\t\t\t\t$this->listQry  = \"SELECT * FROM `#plugin` WHERE plugin_installflag = 0 AND plugin_category != 'menu'  \";\n\t\t\t}\n\n\t\t\t// Set drop-down values (if any).\n\n\t\t}\n\n\t\t// Modify the list data.\n        public function ListObserver()\n        {\n            parent::ListObserver();\n\n\t        $this->setPlugData();\n        }\n\n\t\tprivate function setPlugData()\n\t\t{\n\t\t\t   $tree = $this->getTreeModel();\n\n\t\t\t\t$plg = e107::getPlug();\n\n\t            foreach ($tree->getTree() as $id => $model)\n\t            {\n\t\t\t\t\t$path = $model->get('plugin_path');\n\n\t\t\t\t\t$plg->load($path);\n\n\t\t            $model->set('plugin_name',$plg->getName());\n\t\t            $model->set('plugin_date',$plg->getDate());\n\t\t            $model->set('plugin_author',$plg->getAuthor());\n\t\t            $model->set('plugin_compatible',$plg->getCompat());\n\t\t            $model->set('plugin_admin_url',$plg->getAdminUrl());\n\t\t            $model->set('plugin_admin_caption', $plg->getAdminCaption());\n\t\t            $model->set('plugin_description',$plg->getDescription());\n\t\t            $model->set('plugin_version_file',$plg->getVersion());\n\t\t            $model->set('plugin_install_required',$plg->getInstallRequired());\n\t                $model->set('plugin_icon',$plg->getIcon(32, 'path'));\n\n\t            }\n\n\t\t}\n\n\n\t\tpublic function ListAjaxObserver()\n\t\t{\n\n\t\t\t$this->getTreeModel()->setParam('db_query', $this->_modifyListQry(false, false, 0, false, $this->listQry))->load();\n\n\t\t\t$this->setPlugData();\n\t\t}\n\n        private function pluginProcessUpload()\n        {\n\t\t\tif (!$_POST['ac'] == md5(ADMINPWCHANGE))\n\t\t\t{\n\t\t\t\texit;\n\t\t\t}\n\n\t\t\t$fl = e107::getFile();\n\t\t\t$data = $fl->getUploaded(e_TEMP);\n\t\t\t$mes = e107::getMessage();\n\n\t\t\tif(empty($data[0]['error']))\n\t\t\t{\n\t\t\t\tif($fl->unzipArchive($data[0]['name'],'plugin'))\n\t\t\t\t{\n\t\t\t\t\t$mes->addSuccess(EPL_ADLAN_43);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$mes->addError(EPL_ADLAN_97);\n\t\t\t\t}\n\t\t\t}\n\n\n\t\t\t//echo $mes->render();\n\n\t\t\treturn true;\n\n\t     }\n\n\n\n\t\tfunction renderHelp()\n\t\t{\n\t\t\t$plg = e107::getPlug();\n\t\t\tif(!$list = $plg->getUpgradableList())\n\t\t\t{\n\t\t\t\treturn null;\n\t\t\t}\n\n\n\t\t\t$text = \"<ul class='media-list'>\";\n\t\t\tforeach($list as $path=>$ver)\n\t\t\t{\n\t\t\t\t$plg->load($path);\n\t\t\t\t$url = e_ADMIN.\"plugin.php?mode=installed&action=upgrade&id=\".$path;\n\t\t\t\t$text .= \"<li class='media'>\n\t\t\t\t<div class='media-left'>\n\t\t\t\t\t<a href='\".$url.\"'>\".$plg->getIcon(32).\"</a>\n\t\t\t\t\t</div><div class='media-body'><a href='\".$url.\"'>\".$plg->getName().\"</a></div></li>\";\n\n\t\t\t}\n\t\t\t$text .= \"</ul>\";\n\n\n\n\n\t\t\treturn array('caption'=>\"Updates to be Installed\", 'text'=>$text);\n\n\t\t}\n\n\t\t// Action Pages.\n\n\n\n\n\n\t\tfunction installPage()\n\t\t{\n\t\t\t$id = $this->getId();\n\n\t\t\t$text = e107::getPlugin()->install($id);\n\n\t\t\t$log = e107::getAdminLog();\n\n\t\t\tif ($text === FALSE)\n\t\t\t{\n\t\t\t\te107::getMessage()->add(EPL_ADLAN_99, E_MESSAGE_ERROR);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t//$plugin->save_addon_prefs('update');\n\t\t\t//\t$info = $plugin->getinfo($this->id);  //FIXME use e107::getPlug();\n\n\t\t\t//\t$name = deftrue($info['plugin_name'],$info['plugin_name']). \" v\".$info['plugin_version']. \"({e_PLUGIN}\".$info['plugin_path'].\")\";\n\n\t\t\t//\t$log->log_event('PLUGMAN_01', $name, E_LOG_INFORMATIVE, '');\n\n\t\t\t\te107::getMessage()->add($text, E_MESSAGE_SUCCESS);\n\t\t\t}\n\n\n\t\t\t$this->redirectAction('list');\n\t\t}\n\n\n\t\tfunction buildPage()\n\t\t{\n\t\t\t$pc = new pluginBuilder;\n\t\t\t$ret = $pc->run();\n\n\t\t\tif(is_array($ret))\n\t\t\t{\n\t\t\t\t$this->addTitle($ret['caption']);\n\t\t\t\treturn $ret['text'];\n\t\t\t}\n\n\t\t\treturn $ret;\n\t\t}\n\n\n\n\n\t\tfunction uninstallPage()\n\t\t{\n\t\t\t$id = $this->getId();\n\n\t\t\tif(empty($_POST['uninstall_confirm']))\n\t\t\t{\n\n\t\t\t\t$plug_vars = e107::getPlug()->load($id)->getMeta();\n\n\t\t\t\t$name = e107::getPlug()->getName();\n\t\t\t\t$this->addTitle(EPL_ADLAN_63);\n\t\t\t\t$this->addTitle($name);\n\n\t\t\t\treturn $this->pluginConfirmUninstall($plug_vars);\n\t\t\t}\n\n\t\t\t$post = e107::getParser()->filter($_POST);\n\n\n\n\t\t//\t$id = e107::getPlugin\n\n\t\t\t$text = e107::getPlugin()->uninstall($id, $post);\n\n\t\t\te107::getMessage()->add($text, E_MESSAGE_SUCCESS);\n\t\t\t$log = e107::getPlugin()->getLog();\n\t\t\te107::getDebug()->log($log);\n\n\t\t\t$this->redirectAction('list');\n\t\t}\n\n\n\n\t\tfunction repairPage()\n\t\t{\n\t\t\t$id = $this->getId();\n\n\t\t\tif(!e107::isInstalled($id))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\te107::getSingleton('e107plugin')->refresh($id);\n\t\t\te107::getLog()->add('PLUGMAN_04', $id, E_LOG_INFORMATIVE, '');\n\n\t\t\t$this->redirectAction('list');\n\t\t}\n\n\n\t\tfunction pullPage()\n\t\t{\n\t\t\t$id = $this->getId();\n\n\t\t\tif(!e107::isInstalled($id))\n\t\t\t{\n\t\t\t\t$this->redirectAction('list');\n\t\t\t}\n\n\n\t\t\t$return = e107::getFile()->gitPull($id, 'plugin');\n\t\t\te107::getMessage()->addSuccess($return);\n\t\t\te107::getPlugin()->refresh($id);\n\n\t\t\t$this->redirectAction('list');\n\t\t}\n\n\n\t\tfunction upgradePage()\n\t\t{\n\t\t\t$this->pluginUpgrade();\n\t\t}\n\n\n\n\t\tfunction uploadPage()\n\t\t{\n\n\t\t\tglobal $plugin;\n\t\t    $frm = e107::getForm();\n\t\t\tif(!empty($_POST['upload']))\n\t\t\t{\n\t            $this->pluginProcessUpload();\n\n\t\t\t\t$this->redirectAction('list');\n\t\t\t}\n\n\n\n\t\t//TODO 'install' checkbox in plugin upload form. (as it is for theme upload)\n\n\t\t/* plugin upload form */\n\n\t\t\tif(!is_writable(e_PLUGIN))\n\t\t\t{\n\t\t\t   \t$text = EPL_ADLAN_44;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t  // Get largest allowable file upload\n\t\t\t  require_once(e_HANDLER.'upload_handler.php');\n\t\t\t  $max_file_size = get_user_max_upload();\n\n\t\t\t  $text = \"\n\t\t\t\t<form enctype='multipart/form-data' method='post' action='\".e_SELF.\"'>\n                <table class='table adminform'>\n                \t<colgroup>\n                \t\t<col class='col-label' />\n                \t\t<col class='col-control' />\n                \t</colgroup>\n\t\t\t\t<tr>\n\t\t\t\t<td>\".EPL_ADLAN_37.\"</td>\n\t\t\t\t<td>\n\t\t\t\t<input type='hidden' name='MAX_FILE_SIZE' value='{$max_file_size}' />\n\t\t\t\t<input type='hidden' name='ac' value='\".md5(ADMINPWCHANGE).\"' />\n\t\t\t\t<input class='tbox' type='file' name='file_userfile[]' size='50' />\n\t\t\t\t</td>\n                </tr>\n\t\t\t\t</table>\n\n\t\t\t\t<div class='center buttons-bar'>\";\n                $text .= $frm->admin_button('upload', EPL_ADLAN_38, 'submit', EPL_ADLAN_38);\n\n\t\t\t\t$text .= \"\n\t\t\t\t</div>\n\n\t\t\t\t</form>\\n\";\n\t\t\t}\n\n\n\t\t\treturn $text;\n            e107::getRender()->tablerender(ADLAN_98.SEP.EPL_ADLAN_38, $text);\n\n\n\t\t}\n\n\t\tprivate function pluginUpgrade()\n\t\t{\n\t\t\t$pref \t\t= e107::getPref();\n\t\t\t$admin_log \t= e107::getAdminLog();\n\t\t\t$plugin \t= e107::getPlugin();\n\n\t\t    $sql \t\t= e107::getDb();\n\t        $mes \t\t= e107::getMessage();\n\n\t        $id         = $this->getId();\n\n\t\t\t$plug \t\t= e107::getPlug()->load($id)->getMeta();\n\n\t\t\t$text = '';\n\n\t\t\t$_path = e_PLUGIN.$id.'/';\n\t\t\tif(file_exists($_path.'plugin.xml'))\n\t\t\t{\n\t\t\t\t$plugin->install_plugin_xml($id, 'upgrade');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$eplug_folder = null;\n\t\t\t\t$upgrade_alter_tables = null;\n\t\t\t\t$upgrade_add_prefs = null;\n\t\t\t\t$upgrade_remove_prefs = null;\n\t\t\t\t$upgrade_add_array_pref = null;\n\t\t\t\t$upgrade_remove_array_pref = null;\n\t\t\t\t$eplug_version = null;\n\n\n\n\t\t\t\tinclude(e_PLUGIN.$plug['plugin_path'].'/plugin.php');\n\n\t\t\t\t$text = '';\n\n\t\t\t\t$func = $eplug_folder.'_upgrade';\n\t\t\t\tif (function_exists($func))\n\t\t\t\t{\n\t\t\t\t\t$text .= call_user_func($func);\n\t\t\t\t}\n\n\t\t\t\tif (is_array($upgrade_alter_tables))\n\t\t\t\t{\n\t\t\t\t\t$result = $plugin->manage_tables('upgrade', $upgrade_alter_tables);\n\t\t\t\t\tif (true !== $result)\n\t\t\t\t\t{\n\t\t\t\t\t\t//$text .= EPL_ADLAN_9.'<br />';\n\t\t\t\t\t\t$mes->addWarning(EPL_ADLAN_9)\n\t\t\t\t\t\t\t->addDebug($result);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$text .= EPL_ADLAN_7.\"<br />\";\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (is_array($upgrade_add_prefs))\n\t\t\t\t{\n\t\t\t\t\t$plugin->manage_prefs('add', $upgrade_add_prefs);\n\t\t\t\t\t$text .= EPL_ADLAN_8.'<br />';\n\t\t\t\t}\n\n\t\t\t\tif (is_array($upgrade_remove_prefs))\n\t\t\t\t{\n\t\t\t\t\t$plugin->manage_prefs('remove', $upgrade_remove_prefs);\n\t\t\t\t}\n\n\t\t\t\tif (is_array($upgrade_add_array_pref))\n\t\t\t\t{\n\t\t\t\t\tforeach($upgrade_add_array_pref as $key => $val)\n\t\t\t\t\t{\n\t\t\t\t\t\t$plugin->manage_plugin_prefs('add', $key, $eplug_folder, $val);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (is_array($upgrade_remove_array_pref))\n\t\t\t\t{\n\t\t\t\t\tforeach($upgrade_remove_array_pref as $key => $val)\n\t\t\t\t\t{\n\t\t\t\t\t\t$plugin->manage_plugin_prefs('remove', $key, $eplug_folder, $val);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t$plugin->manage_search('upgrade', $eplug_folder);\n\t\t\t\t$plugin->manage_notify('upgrade', $eplug_folder);\n\n\t\t\t\t$eplug_addons = $plugin -> getAddons($eplug_folder);\n\n\t\t\t\t$info = $plugin->getinfo($this->id);\n\n\t\t\t\t$name = deftrue($info['plugin_name'],$info['plugin_name']). \" v\".$eplug_version. \"({e_PLUGIN}\".$info['plugin_path'].\")\";\n\n\t\t\t\te107::getLog()->add('PLUGMAN_02', $name, E_LOG_INFORMATIVE, '');\n\t\t\t\t$text .= (isset($eplug_upgrade_done)) ? '<br />'.$eplug_upgrade_done : \"<br />\".LAN_UPGRADE_SUCCESSFUL;\n\t\t\t\t$sql->update('plugin', \"plugin_version ='{$eplug_version}', plugin_addons='{$eplug_addons}' WHERE plugin_id='$this->id' \");\n\t\t\t\t$pref['plug_installed'][$plug['plugin_path']] = $eplug_version; \t\t\t// Update the version\n\n\t\t\t\te107::getConfig('core')->setPref($pref);\n\t\t\t\t$plugin->rebuildUrlConfig();\n\t\t\t\te107::getConfig('core')->save();\n\t\t\t}\n\n\n\t\t\t$mes->addSuccess($text);\n\t\t\t$plugin->save_addon_prefs('update');\n\n\t\t\t$this->redirectAction('list');\n\t   }\n\n\n\n\n\t\tprivate function pluginConfirmUninstall($plug_vars)\n\t\t{\n\t\t\tglobal $plugin;\n\n\t\t\t$frm \t= e107::getForm();\n\t\t\t$tp \t= e107::getParser();\n\t\t\t$mes \t= e107::getMessage();\n\n\n\t\t\t$path = $plug_vars['folder'];\n\t\t//\t$plug = $plugin->getinfo($this->id);\n\n\t\t\tif(!e107::isInstalled($path))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t$userclasses = '';\n\t\t\t$eufields = '';\n\t\t\tif (isset($plug_vars['userClasses']))\n\t\t\t{\n\t\t\t\tif (isset($plug_vars['userclass']['@attributes']))\n\t\t\t\t{\n\t\t\t\t\t$plug_vars['userclass'][0]['@attributes'] = $plug_vars['userclass']['@attributes'];\n\t\t\t\t\tunset($plug_vars['userclass']['@attributes']);\n\t\t\t\t}\n\t\t\t\t$spacer = '';\n\t\t\t\tforeach ($plug_vars['userClasses']['class'] as $uc)\n\t\t\t\t{\n\t\t\t\t\t$userclasses .= $spacer.$uc['@attributes']['name'].' - '.$uc['@attributes']['description'];\n\t\t\t\t\t$spacer = '<br />';\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (isset($plug_vars['extendedFields']))\n\t\t\t{\n\t\t\t\tif (isset($plug_vars['extendedFields']['@attributes']))\n\t\t\t\t{\n\t\t\t\t\t$plug_vars['extendedField'][0]['@attributes'] = $plug_vars['extendedField']['@attributes'];\n\t\t\t\t\tunset($plug_vars['extendedField']['@attributes']);\n\t\t\t\t}\n\t\t\t\t$spacer = '';\n\t\t\t\tforeach ($plug_vars['extendedFields']['field'] as $eu)\n\t\t\t\t{\n\t\t\t\t\t$eufields .= $spacer.'plugin_'.$plug_vars['folder'].'_'.$eu['@attributes']['name'];\n\t\t\t\t\t$spacer = '<br />';\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif(is_writable(e_PLUGIN.$path))\n\t\t\t{\n\t\t\t\t$del_text = $frm->select('delete_files','yesno',0);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$del_text = \"\n\t\t\t\t\".EPL_ADLAN_53.\"\n\t\t\t\t<input type='hidden' name='delete_files' value='0' />\n\t\t\t\t\";\n\t\t\t}\n\n\t\t\t$text = \"\n\t\t\t<form action='\".e_SELF.\"?\".e_QUERY.\"' method='post'>\n\t\t\t<fieldset id='core-plugin-confirmUninstall'>\n\t\t\t<legend>\".EPL_ADLAN_54.\" \".$tp->toHtml($plug_vars['@attributes']['name'], \"\", \"defs,emotes_off, no_make_clickable\").\"</legend>\n            <table class='table adminform'>\n            \t<colgroup>\n            \t\t<col class='col-label' />\n            \t\t<col class='col-control' />\n            \t</colgroup>\n \t\t\t<tr>\n\t\t\t\t<td>\".EPL_ADLAN_55.\"</td>\n\t\t\t\t<td>\".LAN_YES.\"</td>\n\t\t\t</tr>\";\n\n\t\t\t$opts = array();\n\n\t\t\t$opts['delete_tables'] = array(\n\t\t\t\t\t'label'\t\t\t=> EPL_ADLAN_57,\n\t\t\t\t\t'helpText'\t\t=> EPL_ADLAN_58,\n\t\t\t\t\t'itemList'\t\t=> array(1=>LAN_YES,0=>LAN_NO),\n\t\t\t\t\t'itemDefault' \t=> 1\n\t\t\t);\n\n\t\t\tif ($userclasses)\n\t\t\t{\n\t\t\t\t$opts['delete_userclasses'] = array(\n\t\t\t\t\t'label'\t\t\t=> EPL_ADLAN_78,\n\t\t\t\t\t'preview'\t\t=> $userclasses,\n\t\t\t\t\t'helpText'\t\t=> EPL_ADLAN_79,\n\t\t\t\t\t'itemList'\t\t=> array(1=>LAN_YES,0=>LAN_NO),\n\t\t\t\t\t'itemDefault' \t=> 1\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif ($eufields)\n\t\t\t{\n\t\t\t\t$opts['delete_xfields'] = array(\n\t\t\t\t\t'label'\t\t\t=> EPL_ADLAN_80,\n\t\t\t\t\t'preview'\t\t=> $eufields,\n\t\t\t\t\t'helpText'\t\t=> EPL_ADLAN_79,\n\t\t\t\t\t'itemList'\t\t=> array(1=>LAN_YES,0=>LAN_NO),\n\t\t\t\t\t'itemDefault' \t=> 0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t$med = e107::getMedia();\n\t\t\t$icons = $med->listIcons(e_PLUGIN.$path);\n\n\t\t\t$iconText = '';\n\n\t\t\tif(count($icons)>0)\n\t\t\t{\n\t\t\t\tforeach($icons as $key=>$val)\n\t\t\t\t{\n\t\t\t\t\t$iconText .= \"<img src='\".$tp->replaceConstants($val).\"' alt='' />\";\n\t\t\t\t}\n\n\t\t\t\t$iconText = '<div class=\"icon-pool-preview\">'.$iconText.'</div>';\n\n\t\t\t\t$opts['delete_ipool'] = array(\n\t\t\t\t\t'label'\t\t\t=> EPL_ADLAN_231,\n\t\t\t\t\t'preview'\t\t=> $iconText,\n\t\t\t\t\t'helpText'\t\t=> EPL_ADLAN_79,\n\t\t\t\t\t'itemList'\t\t=> array(1=>LAN_YES,0=>LAN_NO),\n\t\t\t\t\t'itemDefault' \t=> 1\n\t\t\t\t);\n\n\n\t\t\t}\n\n\n\n\t\t\tif(is_readable(e_PLUGIN.$path.\"/\".$path.\"_setup.php\"))\n\t\t\t{\n\t\t\t\tinclude_once(e_PLUGIN.$path.\"/\".$path.\"_setup.php\");\n\n\n\t\t\t\t$mes->add(\"Loading \".e_PLUGIN.$path.\"/\".$path.\"_setup.php\", E_MESSAGE_DEBUG);\n\n\t\t\t\t$class_name = $path.\"_setup\";\n\n\t\t\t\tif(class_exists($class_name))\n\t\t\t\t{\n\t\t\t\t\t$obj = new $class_name;\n\t\t\t\t\tif(method_exists($obj,'uninstall_options'))\n\t\t\t\t\t{\n\t\t\t\t\t\t$arr = call_user_func(array($obj,'uninstall_options'), $this);\n\t\t\t\t\t\tforeach($arr as $key=>$val)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$newkey = $path.\"_\".$key;\n\t\t\t\t\t\t\t$opts[$newkey] = $val;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tforeach($opts as $key=>$val)\n\t\t\t{\n\t\t\t\t$text .= \"<tr>\\n<td class='top'>\".$tp->toHTML($val['label'],FALSE,'TITLE');\n\t\t\t\t$text .= varset($val['preview']) ? \"<div class='indent'>\".$val['preview'].\"</div>\" : \"\";\n\t\t\t\t$text .= \"</td>\\n<td>\".$frm->select($key,$val['itemList'],$val['itemDefault']);\n\t\t\t\t$text .= varset($val['helpText']) ? \"<div class='field-help'>\".$val['helpText'].\"</div>\" : \"\";\n\t\t\t\t$text .= \"</td>\\n</tr>\\n\";\n\t\t\t}\n\n\n\t\t\t$text .=\"<tr>\n\t\t\t<td>\".EPL_ADLAN_59.\"</td>\n\t\t\t<td>{$del_text}\n\t\t\t<div class='field-help'>\".EPL_ADLAN_60.\"</div>\n\t\t\t</td>\n\t\t\t</tr>\n\t\t\t</table>\n\t\t\t<div class='buttons-bar center'>\";\n\n\t\t\t$text .= $frm->admin_button('uninstall_confirm',EPL_ADLAN_3,'submit');\n\t\t\t$text .= $frm->admin_button('uninstall_cancel',EPL_ADLAN_62,'cancel');\n\n\t\t\t/*\n\t\t\t$text .= \"<input class='btn' type='submit' name='uninstall_confirm' value=\\\"\".EPL_ADLAN_3.\"\\\" />&nbsp;&nbsp;\n\t\t\t<input class='btn' type='submit' name='uninstall_cancel' value='\".EPL_ADLAN_62.\"' onclick=\\\"location.href='\".e_SELF.\"'; return false;\\\"/>\";\n\t\t\t*/\n             //   $frm->admin_button($name, $value, $action = 'submit', $label = '', $options = array());\n\n\t\t\t$text .= \"</div>\n\t\t\t</fieldset>\n\t\t\t</form>\n\t\t\t\";\n\n\t\t\treturn $text;\n\t\t\te107::getRender()->tablerender(EPL_ADLAN_63.SEP.$tp->toHtml($plug_vars['@attributes']['name'], \"\", \"defs,emotes_off, no_make_clickable\"),$mes->render(). $text);\n\n\t\t}\n\t/*\n\t\t// optional - a custom page.\n\t\tpublic function customPage()\n\t\t{\n\t\t\t$text = 'Hello World!';\n\t\t\t$otherField  = $this->getController()->getFieldVar('other_field_name');\n\t\t\treturn $text;\n\n\t\t}\n\t*/\n\n}\n\n\n\nclass plugin_form_ui extends e_admin_form_ui\n{\n\n\n\t// Custom Method/Function\n\tfunction plugin_compatible($curVal,$mode)\n\t{\n\t\t$frm = e107::getForm();\n\n\t\tswitch($mode)\n\t\t{\n\t\t\tcase 'read': // List Page\n\n\t\t\t\tif(intval($curVal) > 1)\n\t\t\t\t{\n\t\t\t\t\treturn \"<span class='label label-warning'>\".$curVal.\"</span>\";\n\t\t\t\t}\n\n\t\t\t\treturn $curVal;\n\t\t\tbreak;\n\n\t\t\tcase 'write': // Edit Page\n\t\t\t\treturn $frm->text('plugin_name',$curVal, 255, 'size=large');\n\t\t\tbreak;\n\n\t\t\tcase 'filter':\n\t\t\tcase 'batch':\n\t\t\t\treturn  array();\n\t\t\tbreak;\n\t\t}\n\t}\n\n\n\t// Custom Method/Function\n\tfunction plugin_addons($curVal,$mode)\n\t{\n\t\t$frm = e107::getForm();\n\n\t\tswitch($mode)\n\t\t{\n\t\t\tcase 'read': // List Page\n\t\t\t\treturn $curVal;\n\t\t\tbreak;\n\n\t\t\tcase 'write': // Edit Page\n\t\t\t\treturn $frm->text('plugin_addons',$curVal, 255, 'size=large');\n\t\t\tbreak;\n\n\t\t\tcase 'filter':\n\t\t\tcase 'batch':\n\t\t\t\treturn  array();\n\t\t\tbreak;\n\t\t}\n\t}\n\n\n\tfunction options($val, $curVal)\n\t{\n\n\t\t$tp = e107::getParser();\n\n\t\t$var = $this->getController()->getListModel()->getData();\n\n\t\t$mode = $this->getController()->getMode();\n\n\n\t//\te107::getDebug()->log($var);\n\n\t\t$_path = e_PLUGIN . $var['plugin_path'] . '/';\n\n\t\tif($var['plugin_admin_url'] && $var['plugin_installflag'] == true)\n\t\t{\n\n\t\t\t$conf_title = !empty($var['plugin_admin_caption']) ? $var['plugin_admin_caption'] : LAN_CONFIGURE . ' ' . $tp->toHTML($var['plugin_name'], \"\", \"defs,emotes_off, no_make_clickable\");\n\t\t\t$plugin_config_icon = \"<a class='btn btn-default' title='{$conf_title}' href='\" . $var['plugin_admin_url'] . \"' >\" . ADMIN_CONFIGURE_ICON . \"</a>\";\n\t\t}\n\n\t\t$text = \"<div class='btn-group'>\";\n\t\t$text .= vartrue($plugin_config_icon);\n\n\t\tif($var['plugin_install_required'] == true)\n\t\t{\n\n\t\t\tif($var['plugin_installflag'])\n\t\t\t{\n\t\t\t\t$text .= ($var['plugin_installflag'] ? \"<a class='btn btn-default' href=\\\"\" . e_SELF . \"?mode=\".$mode.\"&action=uninstall&id={$var['plugin_path']}\\\" title='\" . EPL_ADLAN_1 . \"'  >\" . ADMIN_UNINSTALLPLUGIN_ICON . \"</a>\" : \"<a class='btn' href=\\\"\" . e_SELF . \"?install.{$var['plugin_id']}\\\" title='\" . EPL_ADLAN_0 . \"' >\" . ADMIN_INSTALLPLUGIN_ICON . \"</a>\");\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$text .= \"<a class='btn btn-default' href=\\\"\" . e_SELF . \"?mode=installed&action=install&id={$var['plugin_path']}\\\" title='\" . EPL_ADLAN_0 . \"' >\" . ADMIN_INSTALLPLUGIN_ICON . \"</a>\";\n\t\t\t}\n\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif($var['menuName'])\n\t\t\t{\n\t\t\t//\t$text .= EPL_NOINSTALL . str_replace(\"..\", \"\", e_PLUGIN . $var['plugin_path']) . \"/ \" . EPL_DIRECTORY;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t//\t$text .= EPL_NOINSTALL_1 . str_replace(\"..\", \"\", e_PLUGIN . $var['plugin_path']) . \"/ \" . EPL_DIRECTORY;\n\t\t\t\tif($var['plugin_installflag'] == false)\n\t\t\t\t{\n\t\t\t//\t\te107::getDb()->delete('plugin', \"plugin_installflag=0 AND (plugin_path='{$var['plugin_path']}' OR plugin_path='{$var['plugin_path']}/' )  \");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif($var['plugin_version'] != $var['plugin_version_file'] && $var['plugin_installflag'])\n\t\t{\n\t\t\t$text .= \"<a class='btn btn-default' href='\" . e_SELF . \"?mode=\".$mode.\"&action=upgrade&id={$var['plugin_path']}' title=\\\"\" . EPL_UPGRADE . \" v\" . $var['plugin_version'] . \"\\\" >\" . ADMIN_UPGRADEPLUGIN_ICON . \"</a>\";\n\t\t}\n\n\t\tif($var['plugin_installflag'] && e_DEBUG == true)\n\t\t{\n\t\t\t$text .= \"<a class='btn btn-default' href='\" . e_SELF . \"?mode=\".$mode.\"&action=repair&id={$var['plugin_path']}' title='\" . LAN_REPAIR_PLUGIN_SETTINGS . \"'> \" . ADMIN_REPAIRPLUGIN_ICON . \"</a>\";\n\t\t}\n\n\t\tif($var['plugin_installflag'] && is_dir($_path . \".git\"))\n\t\t{\n\t\t\t$text .= \"<a class='plugin-manager btn btn-default' href='\" . e_SELF . \"?mode=\".$mode.\"&action=pull&id={$var['plugin_path']}' title='\" . LAN_SYNC_WITH_GIT_REPO . \"'> \" . ADMIN_GITSYNC_ICON . \"</a>\";\n\t\t}\n\n\n\t\t$text .= \"</div>\t\";\n\n\t\treturn $text;\n\t}\n\n}\n\n\n\n\n\n\n\nclass plugin_online_ui extends e_admin_ui\n{\n\n\t\tprotected $pluginTitle\t\t=  ADLAN_98;\n\t\tprotected $pluginName\t\t= 'core';\n\t//\tprotected $eventName\t\t= 'plugman-plugin'; // remove comment to enable event triggers in admin.\n\t\tprotected $table\t\t\t= false;\n\t\tprotected $pid\t\t\t\t= '';\n\t\tprotected $perPage\t\t\t= 10;\n\t\tprotected $batchDelete\t\t= true;\n\t\tprotected $batchExport     = true;\n\t\tprotected $batchCopy\t\t= true;\n\t//\tprotected $sortField\t\t= 'somefield_order';\n\t//\tprotected $orderStep\t\t= 10;\n\t//\tprotected $tabs\t\t\t\t= array('Tabl 1','Tab 2'); // Use 'tab'=>0  OR 'tab'=>1 in the $fields below to enable.\n\n\t//\tprotected $listQry      \t= \"SELECT * FROM `#tableName` WHERE field != '' \"; // Example Custom Query. LEFT JOINS allowed. Should be without any Order or Limit.\n\n\t\tprotected $listOrder\t\t= '';\n\n\t\tprotected $fields \t\t= array ();\n\n\t\tprotected $fieldpref = array('plugin_icon', 'plugin_name', 'plugin_version', 'plugin_license', 'plugin_description', 'plugin_compatible', 'plugin_released','plugin_author', 'plugin_category','plugin_installflag');\n\n\n\t//\tprotected $preftabs        = array('General', 'Other' );\n\t\tprotected $prefs = array(\n\t\t);\n\n\t\tprotected $mp = null;\n\n\n\t\tpublic function __construct($request, $response, $params = array())\n\t\t{\n\n\t\t\t$this->fields = plugman_adminArea::getPluginManagerFields();\n\t\t\t$this->fields['plugin_category']['writeParms']['optArray'] = e107::getPlug()->getCategoryList(); // array('plugin_category_0','plugin_category_1', 'plugin_category_2'); // Example Drop-down array.\n\t\t\t$this->fields[\"plugin_license\"]['nolist'] = false;\n\t\t\tparent:: __construct($request, $response, $params);\n\n\t\t}\n\n\n\t\tpublic function init()\n\t\t{\n\t\t\trequire_once(e_HANDLER.'e_marketplace.php');\n\t\t}\n\n\t\tfunction pluginCheck($force=false)\n\t\t{\n\t\t\tif(!PLUGIN_SCAN_INTERVAL)\n\t\t\t{\n\t\t\t\te107::getPlugin()->update_plugins_table('update');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif((time() > vartrue($_SESSION['nextPluginFolderScan'],0)) || $force == true)\n\t\t\t{\n\t\t\t\te107::getPlugin()->update_plugins_table('update');\n\t\t\t}\n\n\t\t\t$_SESSION['nextPluginFolderScan'] = time() + PLUGIN_SCAN_INTERVAL;\n\t\t\t//echo \"TIME = \".$_SESSION['nextPluginFolderScan'];\n\n\t    }\n\n\t\t// Modal Download.\n\t\tpublic function downloadPage()\n\t\t{\n\n\t\t\t$frm = e107::getForm();\n\t\t\t$mes = e107::getMessage();\n\t\t\t$tp = e107::getParser();\n\n\t\t//\tprint_a($_GET);\n\n\t\t\t$string =  base64_decode($_GET['src']);\n\t\t\tparse_str($string, $data);\n\n\t\t\tif(deftrue('e_DEBUG_MARKETPLACE'))\n\t\t\t{\n\t\t\t\techo \"<b>DEBUG MODE ACTIVE (no downloading)</b><br />\";\n\t\t\t\techo '$_GET[src]: ';\n\t\t\t\tprint_a($_GET);\n\n\t\t\t\techo 'base64 decoded and parsed as $data:';\n\t\t\t\tprint_a($data);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t$pluginFolder = !empty($data['plugin_folder']) ? $tp->filter($data['plugin_folder']) : '';\n\t\t\t$pluginUrl = !empty($data['plugin_url']) ? $tp->filter($data['plugin_url']) : '';\n\t\t\t$pluginID = !empty($data['plugin_id']) ? $tp->filter($data['plugin_id']) : '';\n\t\t\t$pluginMode = !empty($data['plugin_mode']) ? $tp->filter($data['plugin_mode']) : '';\n\n\t\t\tif(!empty($data['plugin_price']))\n\t\t\t{\n\t\t\t\te107::getRedirect()->go($pluginUrl);\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\t$mp = $this->getMarketplace();\n\t\t//\t$mp->generateAuthKey($e107SiteUsername, $e107SiteUserpass);\n\n\n\n\t\t\t// Server flush useless. It's ajax ready state 4, we can't flush (sadly) before that (at least not for all browsers)\n\t\t    $mes->addSuccess(EPL_ADLAN_94);\n\n\t\t\tif($mp->download($pluginID, $pluginMode, 'plugin'))\n\t\t\t{\n\t\t\t\t$this -> pluginCheck(true); // rescan the plugin directory\n\t\t\t\t$text = e107::getPlugin()->install($pluginFolder);\n\n\t\t\t\t$mes->addInfo($text);\n\t\t\t\techo $mes->render('default', 'success');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t// Unable to continue\n\t\t\t\techo $mes->addError(EPL_ADLAN_95)->render('default', 'error');\n\t\t\t}\n\n\t\t\techo $mes->render('default', 'debug');\n\t\t\treturn null;\n\n\n\n\t\t}\n\n        public function ListObserver()\n        {\n      //    parent::ListObserver();\n\n\t        $this->setPlugData();\n        }\n\n\n\n\t\t/**\n\t\t * @return e_marketplace|null\n\t\t */\n\t\tpublic function getMarketplace()\n\t\t{\n\t\t\tif(null === $this->mp)\n\t\t\t{\n\t\t\t\t$this->mp = new e_marketplace(); // autodetect the best method\n\t\t\t}\n\n\t\t\treturn $this->mp;\n\t\t}\n\n\n\n\t\tprivate function compatibilityLabel($val='')\n\t\t{\n\t\t\t$badge = (vartrue($val) > 1.9) ? \"<span class='label label-warning'>\".EPL_ADLAN_88.\"</span>\" : '1.x';\n\t\t\treturn $badge;\n\t\t}\n\n\n\n\tfunction options($data)\n\t{\n\n\t//\tprint_a($data);\n\n\t\t/*\n\t\tif(!e107::getFile()->hasAuthKey())\n\t\t{\n\t\t//\treturn \"<a href='\".e_SELF.\"' class='btn btn-primary e-modal' >Download and Install</a>\";\n\n\t\t}\n\t\t*/\n\t\tif($data['plugin_installflag'])\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\n\n\t\t//$url = e_SELF.\"?src=\".base64_encode($d);\n\t//\t$url = e_SELF.'?action=download&amp;src='.base64_encode($d);//$url.'&amp;action=download';\n\t\t$id = 'plug_'.$data['plugin_id'];\n\t\t//<button type='button' data-target='{$id}' data-loading='\".e_IMAGE.\"/generic/loading_32.gif' class='btn btn-primary e-ajax middle' value='Download and Install' data-src='\".$url.\"' ><span>Download and Install</span></button>\n\t\t$modalCaption = (!empty($data['plugin_price'])) ? EPL_ADLAN_92.\" \".$data['plugin_name'].\" \".$data['plugin_version'] : EPL_ADLAN_230.\" \".$data['plugin_name'].\" \".$data['plugin_version'];\n\n\t\t$srcData = array(\n\t\t\t'plugin_id'     => $data['plugin_id'],\n\t\t\t'plugin_folder' => $data['plugin_folder'],\n\t\t\t'plugin_price'  => $data['plugin_price'],\n\t\t\t'plugin_mode'   => $data['plugin_mode'],\n\t\t\t'plugin_url'    => $data['plugin_url'],\n\t\t);\n\n\n\t\t$url = $this->getMarketplace()->getDownloadModal('plugin',  $srcData);\n\n\n\t//\t$d = http_build_query($srcData,false,'&');\n\t//\t$url = e_SELF.'?mode=download&src='.base64_encode($d);\n\t\t$dicon = '<a title=\"'.EPL_ADLAN_237.'\" class=\"e-modal btn btn-default\" href=\"'.$url.'\" rel=\"external\" data-loading=\"'.e_IMAGE.'/generic/loading_32.gif\"  data-cache=\"false\" data-modal-caption=\"'.$modalCaption.'\"  target=\"_blank\" >'.ADMIN_INSTALLPLUGIN_ICON.'</a>';\n\n\t\t/*\n\n\t\t// DEBUGGER .\n\t\t$base64 = base64_encode($d);\n\t\t$tmp = base64_decode($base64);\n\t\tparse_str($tmp, $data);\n\n\t//  XXX Suhosin has a 512 char limit for $_GET strings.\n\t\te107::getDebug()->log($data['plugin_name'].' : '.strlen($base64).\"<br />\".print_a($data,true)); //FIXME - enable when needed to debug.\n\t\t*/\n\n\t\t// Temporary Pop-up version.\n\t//\t$dicon = '<a class=\"e-modal\" href=\"'.$data['plugin_url'].'\" rel=\"external\" data-modal-caption=\"'.$data['plugin_name'].\" \".$data['plugin_version'].'\"  target=\"_blank\" ><img class=\"top\" src=\"'.e_IMAGE_ABS.'icons/download_32.png\" alt=\"\"  /></a>';\n\n\t//\t$dicon = \"<a data-toggle='modal' data-modal-caption=\\\"Downloading \".$data['plugin_name'].\" \".$data['plugin_version'].\"\\\" href='{$url}' data-cache='false' data-target='#uiModal' title='\".$LAN_DOWNLOAD.\"' ><img class='top' src='\".e_IMAGE_ABS.\"icons/download_32.png' alt=''  /></a> \";\n\n\t\treturn \"<div id='{$id}' class='center' >\n\t\t{$dicon}\n\t\t</div>\";\n\t}\n\n\t\tprivate function setPlugData()\n\t\t{\n\n\t\t\t//\t$this->setTreeModel();\n\n\t\t\t/*   $tree = $this->getTreeModel();\n\n\t\t\t\t$plg = e107::getPlug();\n\n\t            foreach ($tree->getTree() as $id => $model)\n\t            {\n\t\t\t\t\t$path = $model->get('plugin_path');\n\n\t\t\t\t\t$plg->load($path);\n\n\t\t            $model->set('plugin_name',$plg->getName());\n\t\t            $model->set('plugin_date',$plg->getDate());\n\t\t            $model->set('plugin_author',$plg->getAuthor());\n\t\t            $model->set('plugin_compatible',$plg->getCompat());\n\t\t            $model->set('plugin_admin_url',$plg->getAdminUrl());\n\t\t            $model->set('plugin_description',$plg->getDescription());\n\t\t            $model->set('plugin_version_file',$plg->getVersion());\n\t\t            $model->set('plugin_install_required',$plg->getInstallRequired());\n\t                $model->set('plugin_icon',$plg->getIcon(32, 'path'));\n\n\t            }*/\n\n\t\t}\n\n\n\t\tpublic function listPage()\n\t\t{\n\n\n\t\t\tglobal $plugin, $e107SiteUsername, $e107SiteUserpass;\n\t\t\t$tp = e107::getParser();\n\t\t\t$frm = $this->getUI();\n\n\t\t\t$caption\t= EPL_ADLAN_89;\n\n\t\t\t$e107 = e107::getInstance();\n\t\t\t$xml = e107::getXml();\n\t\t\t$mes = e107::getMessage();\n\n\t\t//\t$mes->addWarning(\"Some older plugins may produce unpredictable results.\");\n\t\t\t// check for cURL\n\t\t\tif(!function_exists('curl_init'))\n\t\t\t{\n\t\t\t\t$mes->addWarning(EPL_ADLAN_90);\n\t\t\t}\n\n\t\t\t//TODO use admin_ui including filter capabilities by sending search queries back to the xml script.\n\t\t\t$from = isset($_GET['frm']) ? intval($_GET['frm']) : 0;\n\t\t\t$srch = preg_replace('/[^\\w]/','', vartrue($_GET['srch']));\n\n\n\t\t\t$mp = $this->getMarketplace();\n\n\t\t\t// auth\n\t\t\t$mp->generateAuthKey($e107SiteUsername, $e107SiteUserpass);\n\n\t\t\t// do the request, retrieve and parse data\n\t\t\t$xdata = $mp->call('getList', array(\n\t\t\t\t'type' => 'plugin',\n\t\t\t\t'params' => array('limit' => 10, 'search' => $srch, 'from' => $from)\n\t\t\t));\n\t\t\t$total = $xdata['params']['count'];\n\n\t\t\t// OLD BIT OF CODE ------------------------------->\n\t\t/*\n\t\t//\t$file = SITEURLBASE.e_PLUGIN_ABS.\"release/release.php\";  // temporary testing\n\t\t\t$file = \"http://e107.org/feed?type=plugin&frm=\".$from.\"&srch=\".$srch.\"&limit=10\";\n\n\t\t\t$xml->setOptArrayTags('plugin'); // make sure 'plugin' tag always returns an array\n\t\t\t$xdata = $xml->loadXMLfile($file,'advanced');\n\n\t\t\t$total = $xdata['@attributes']['total'];\n\n\t\t\techo 'file='.$file;\n\t\t//\tprint_a($xdata);\n\n\t\t\t$xdata['data'] = $xdata['plugin'];\n\t\t\t*/\n\t\t\t// OLD BIT OF CODE END ------------------------------->\n\n\n\t// print_a($xdata);\n\n\t\t\t$c = 1;\n\t\t\tforeach($xdata['data'] as $row)\n\t\t\t{\n\t\t\t\t//$row = $r['@attributes'];\n\n\t\t\t\t//\tprint_a($row);\n\n\t\t\t\t\t$badge \t\t= $this->compatibilityLabel($row['compatibility']);;\n\t\t\t\t\t$featured \t= ($row['featured']== 1) ? \" <span class='label label-info'>\".EPL_ADLAN_91.\"</span>\" : '';\n\t\t\t\t\t$price \t\t= (!empty($row['price'])) ? \"<span class='label label-primary'>\".$row['price'].\" \".$row['currency'].\"</span>\" : \"<span class='label label-success'>\".EPL_ADLAN_93.\"</span>\";\n\n\t\t\t\t\t$data[] = array(\n\t\t\t\t\t\t'plugin_id'\t\t\t\t=> $row['params']['id'],\n\t\t\t\t\t\t'plugin_mode'\t\t\t=> $row['params']['mode'],\n\t\t\t\t\t\t'plugin_icon'\t\t\t=> vartrue($row['icon'],'e-plugins-32'),\n\t\t\t\t\t\t'plugin_name'\t\t\t=> stripslashes($row['name']),\n\t\t\t\t\t\t'plugin_featured'\t\t=> $featured,\n\t\t\t\t\t\t'plugin_sef'\t\t\t=> '',\n\t\t\t\t\t\t'plugin_folder'\t\t\t=> $row['folder'],\n\t\t\t\t\t\t'plugin_date'\t\t\t=> vartrue($row['date']),\n\t\t\t\t\t\t'plugin_category'\t\t=> vartrue($row['category'], 'n/a'),\n\t\t\t\t\t\t'plugin_author'\t\t\t=> vartrue($row['author']),\n\t\t\t\t\t\t'plugin_version'\t\t=> $row['version'],\n\t\t\t\t\t\t'plugin_description'\t=> nl2br(vartrue($row['description'])),\n\t\t\t\t\t\t'plugin_compatible'\t\t=> $badge,\n\n\t\t\t\t\t\t'plugin_website'\t\t=> vartrue($row['authorUrl']),\n\t\t\t\t\t\t'plugin_url'\t\t\t=> $row['urlView'],\n\t\t\t\t\t\t'plugin_notes'\t\t\t=> '',\n\t\t\t\t\t\t'plugin_price'\t\t\t=> $row['price'],\n\t\t\t\t\t\t'plugin_license'\t\t=> $price,\n\t\t\t\t\t\t'plugin_installflag'    => e107::isInstalled($row['folder'])\n\t\t\t\t\t);\n\n\t\t\t\t$c++;\n\t\t\t}\n\n\t\t\t$fieldList = $this->fields;\n\t\t\tunset($fieldList['checkboxes']);\n\n\t\t\t$text = \"\n\t\t\t\t<form class='form-search form-inline' action='\".e_SELF.\"?\".e_QUERY.\"' id='core-plugin-list-form' method='get'>\n\t\t\t\t<div id='admin-ui-list-filter' class='e-search '>\".$frm->search('srch', $srch, 'go', $filterName, $filterArray, $filterVal).$frm->hidden('mode','online').\"\n\t\t\t\t</div>\n\t\t\t\t</form>\n\n\t\t\t\t<form action='\".e_SELF.\"?\".e_QUERY.\"' id='core-plugin-list-form' method='post'>\n\t\t\t\t\t<fieldset class='e-filter' id='core-plugin-list'>\n\t\t\t\t\t\t<legend class='e-hideme'>\".$caption.\"</legend>\n\n\n\n\n\n\t\t\t\t\t\t<table id=core-plugin-list' class='table adminlist table-striped'>\n\t\t\t\t\t\t\t\".$frm->colGroup($fieldList,$this->fieldpref).\n\t\t\t\t\t\t\t$frm->thead($fieldList,$this->fieldpref).\"\n\t\t\t\t\t\t\t<tbody>\n\t\t\t\";\n\n\n\n\n\t\t\tforeach($data as $key=>$val\t)\n\t\t\t{\n\t\t\t//\tprint_a($val);\n\t\t\t\t$text .= \"<tr>\";\n\n\t\t\t\tforeach($this->fields as $v=>$foo)\n\t\t\t\t{\n\t\t\t\t\tif(!in_array($v,$this->fieldpref) || $v == 'checkboxes')\n\t\t\t\t\t{\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\t$_value = $val[$v];\n\t\t\t\t\tif($v == 'plugin_name') $_value .= $val['plugin_featured'];\n\t\t\t\t\t// echo '<br />v='.$v;\n\t\t\t\t\t$text .= \"<td style='height: 40px' class='\".vartrue($this->fields[$v]['class'],'left').\"'>\".$frm->renderValue($v, $_value, $this->fields[$v], $key).\"</td>\\n\";\n\t\t\t\t}\n\t\t\t\t$text .= \"<td class='center'>\".$this->options($val).\"</td>\";\n\t\t\t\t$text .= \"</tr>\";\n\n\t\t\t}\n\n\n\t\t\t$text .= \"\n\t\t\t\t\t\t\t</tbody>\n\t\t\t\t\t\t</table>\";\n\t\t\t$text .= \"\n\t\t\t\t\t</fieldset>\n\t\t\t\t</form>\n\t\t\t\";\n\n\t\t\t$amount = 30;\n\n\n\t\t\tif($total > $amount)\n\t\t\t{\n\t\t\t\t$parms = $total.\",\".$amount.\",\".$from.\",\".e_SELF.'?mode=online&amp;action=list&amp;frm=[FROM]';\n\n\t\t\t\tif(!empty($srch))\n\t\t\t\t{\n\t\t\t\t\t$parms .= '&amp;srch='.$srch;\n\t\t\t\t}\n\n\t\t\t\t$text .= \"<div class='control-group form-inline input-inline' style='text-align:center;margin-top:10px'>\".$tp->parseTemplate(\"{NEXTPREV=$parms}\",TRUE).\"</div>\";\n\t\t\t}\n\n\t\t\treturn $text;\n\n\t\t}\n\n\n\n\n\t\t// ------- Customize Create --------\n\n\t\tpublic function beforeCreate($new_data,$old_data)\n\t\t{\n\t\t\treturn $new_data;\n\t\t}\n\n\t\tpublic function afterCreate($new_data, $old_data, $id)\n\t\t{\n\t\t\t// do something\n\t\t}\n\n\t\tpublic function onCreateError($new_data, $old_data)\n\t\t{\n\t\t\t// do something\n\t\t}\n\n\n\t\t// ------- Customize Update --------\n\n\t\tpublic function beforeUpdate($new_data, $old_data, $id)\n\t\t{\n\t\t\treturn $new_data;\n\t\t}\n\n\t\tpublic function afterUpdate($new_data, $old_data, $id)\n\t\t{\n\t\t\t// do something\n\t\t}\n\n\t\tpublic function onUpdateError($new_data, $old_data, $id)\n\t\t{\n\t\t\t// do something\n\t\t}\n\n\n\t/*\n\t\t// optional - a custom page.\n\t\tpublic function customPage()\n\t\t{\n\t\t\t$text = 'Hello World!';\n\t\t\t$otherField  = $this->getController()->getFieldVar('other_field_name');\n\t\t\treturn $text;\n\n\t\t}\n\t*/\n\n}\n\n\n\nclass plugin_form_online_ui extends e_admin_form_ui\n{\n\n\n\t// Custom Method/Function\n\tfunction plugin_name($curVal,$mode)\n\t{\n\t\t$frm = e107::getForm();\n\n\t\tswitch($mode)\n\t\t{\n\t\t\tcase 'read': // List Page\n\t\t\t\treturn $curVal;\n\t\t\tbreak;\n\n\t\t\tcase 'write': // Edit Page\n\t\t\t\treturn $frm->text('plugin_name',$curVal, 255, 'size=large');\n\t\t\tbreak;\n\n\t\t\tcase 'filter':\n\t\t\tcase 'batch':\n\t\t\t\treturn  array();\n\t\t\tbreak;\n\t\t}\n\t}\n\n\n\t// Custom Method/Function\n\tfunction plugin_addons($curVal,$mode)\n\t{\n\t\t$frm = e107::getForm();\n\n\t\tswitch($mode)\n\t\t{\n\t\t\tcase 'read': // List Page\n\t\t\t\treturn $curVal;\n\t\t\tbreak;\n\n\t\t\tcase 'write': // Edit Page\n\t\t\t\treturn $frm->text('plugin_addons',$curVal, 255, 'size=large');\n\t\t\tbreak;\n\n\t\t\tcase 'filter':\n\t\t\tcase 'batch':\n\t\t\t\treturn  array();\n\t\t\tbreak;\n\t\t}\n\t}\n\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n//if(deftrue('e_DEBUG_PLUGMANAGER'))\n{\n\tnew plugman_adminArea();\n\trequire_once(e_ADMIN.\"auth.php\");\n\te107::getAdminUI()->runPage();\n\trequire_once(e_ADMIN.\"footer.php\");\n\texit;\n\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n// --------------------------------------\n\n/*\nclass pluginmanager_form extends e_form\n{\n\t\n\tvar $plug;\n\tvar $plug_vars;\n\t\t\n\t//FIXME _ there's a problem with calling this. \n\tfunction plugin_website($parms, $value, $id, $attributes)\n\t{\n\t\treturn (varset($plugURL, false)) ? \"<a href='{$plugURL}' title='{$plugURL}' >\".ADMIN_URL_ICON.\"</a>\" : \"\";\t\n\t\t\n\t}\n\t\n\t\n\tfunction options($val, $curVal)\n\t{\n\t\t\n\t\t$tp = e107::getParser();\n\t\t\n\t\t$_path = e_PLUGIN.$this->plug['plugin_path'].'/';\n\t\t\n\t\t$icon_src = (isset($this->plug_vars['plugin_php']) ? e_PLUGIN : $_path).$this->plug_vars['administration']['icon'];\n\t\t$plugin_icon = $this->plug_vars['administration']['icon'] ? \"<img src='{$icon_src}' alt='' class='icon S32' />\" : $tp->toGlyph('e-cat_plugins-32');\n   \t\t$conf_file = \"#\";\n\t\t$conf_title = \"\";\n\t\t\n\t\tif ($this->plug_vars['administration']['configFile'] && $this->plug['plugin_installflag'] == true)\n\t\t{\n\t\t\t$conf_file = e_PLUGIN. $this->plug['plugin_path'].'/'.$this->plug_vars['administration']['configFile'];\n\t\t\t$conf_title = LAN_CONFIGURE.' '.$tp->toHTML($this->plug_vars['@attributes']['name'], \"\", \"defs,emotes_off, no_make_clickable\");\n\t\t\t$plugin_icon = \"<a title='{$conf_title}' href='{$conf_file}' >\".$plugin_icon.\"</a>\";\n\t\t\t$plugin_config_icon = \"<a class='btn btn-default' title='{$conf_title}' href='{$conf_file}' >\".ADMIN_CONFIGURE_ICON.\"</a>\";\n\t\t}\n\t\t\t\t\n\t\t$text = \"<div class='btn-group'>\";\n\t\t\n\t\t$text .= vartrue($plugin_config_icon);\n\t\t\n\t\tif ($this->plug_vars['@attributes']['installRequired'])\n\t\t{\n\t\t\t\n\t\t\tif ($this->plug['plugin_installflag'])\n\t\t\t{\n\t\t  \t\t$text .= ($this->plug['plugin_installflag'] ? \"<a class='btn btn-default' href=\\\"\".e_SELF.\"?uninstall.{$this->plug['plugin_id']}\\\" title='\".EPL_ADLAN_1.\"'  >\".ADMIN_UNINSTALLPLUGIN_ICON.\"</a>\" : \"<a class='btn' href=\\\"\".e_SELF.\"?install.{$this->plug['plugin_id']}\\\" title='\".EPL_ADLAN_0.\"' >\".ADMIN_INSTALLPLUGIN_ICON.\"</a>\");\n                           //   $text .= ($this->plug['plugin_installflag'] ? \"<button type='button' class='delete' value='no-value' onclick=\\\"location.href='\".e_SELF.\"?uninstall.{$this->plug['plugin_id']}'\\\"><span>\".EPL_ADLAN_1.\"</span></button>\" : \"<button type='button' class='update' value='no-value' onclick=\\\"location.href='\".e_SELF.\"?install.{$this->plug['plugin_id']}'\\\"><span>\".EPL_ADLAN_0.\"</span></button>\");\n\t\t\t\tif (e_DEBUG && !vartrue($this->plug_vars['plugin_php']))\n\t\t\t\t{\n\t\t\t//\t\t$text .= \"<br /><br /><input type='button' class='btn btn-default button' onclick=\\\"location.href='\".e_SELF.\"?refresh.{$this->plug['plugin_id']}'\\\" title='\".'Refresh plugin settings'.\"' value='\".'Refresh plugin settings'.\"' /> \";\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t  //\t$text .=  \"<input type='button' class='btn' onclick=\\\"location.href='\".e_SELF.\"?install.{$this->plug['plugin_id']}'\\\" title='\".EPL_ADLAN_0.\"' value='\".EPL_ADLAN_0.\"' />\";\n\t\t\t  //\t$text .= \"<button type='button' class='update' value='no-value' onclick=\\\"location.href='\".e_SELF.\"?install.{$this->plug['plugin_id']}'\\\"><span>\".EPL_ADLAN_0.\"</span></button>\";\n\t           \t$text .= \"<a class='btn btn-default' href=\\\"\".e_SELF.\"?install.{$this->plug['plugin_id']}\\\" title='\".EPL_ADLAN_0.\"' >\".ADMIN_INSTALLPLUGIN_ICON.\"</a>\";\n\t\t\t}\n\t\t\t\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif ($this->plug_vars['menuName'])\n\t\t\t{\n\t\t\t\t$text .= EPL_NOINSTALL.str_replace(\"..\", \"\", e_PLUGIN.$this->plug['plugin_path']).\"/ \".EPL_DIRECTORY;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$text .= EPL_NOINSTALL_1.str_replace(\"..\", \"\", e_PLUGIN.$this->plug['plugin_path']).\"/ \".EPL_DIRECTORY;\n\t\t\t\tif($this->plug['plugin_installflag'] == false)\n\t\t\t\t{\t\t\t\t\t\n\t\t\t\t\te107::getDb()->delete('plugin', \"plugin_installflag=0 AND (plugin_path='{$this->plug['plugin_path']}' OR plugin_path='{$this->plug['plugin_path']}/' )  \");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif ($this->plug['plugin_version'] != $this->plug_vars['@attributes']['version'] && $this->plug['plugin_installflag'])\n\t\t{\n\t\t  //\t$text .= \"<br /><input type='button' class='btn' onclick=\\\"location.href='\".e_SELF.\"?upgrade.{$this->plug['plugin_id']}'\\\" title='\".EPL_UPGRADE.\" to v\".$this->plug_vars['@attributes']['version'].\"' value='\".EPL_UPGRADE.\"' />\";\n\t\t    e107::getMessage()->addInfo(\"<b>\".$tp->toHtml($this->plug['plugin_name'],false,'TITLE').\"</b> is ready to be upgraded. (see below)\"); // TODO LAN\n\t\t\t$text .= \"<a class='btn btn-default' href='\".e_SELF.\"?upgrade.{$this->plug['plugin_id']}' title=\\\"\".EPL_UPGRADE.\" v\".$this->plug_vars['@attributes']['version'].\"\\\" >\".ADMIN_UPGRADEPLUGIN_ICON.\"</a>\";\n\t\t}\n\n\t\tif ($this->plug['plugin_installflag'] && e_DEBUG == true)\n\t\t{\n\t\t\t\t$text .= \"<a class='btn btn-default' href='\".e_SELF.\"?repair.\".$this->plug['plugin_id'].\"' title='\".LAN_REPAIR_PLUGIN_SETTINGS.\"'> \".ADMIN_REPAIRPLUGIN_ICON.\"</a>\";\n\t\t}\n\n\t\tif($this->plug['plugin_installflag'] && is_dir($_path.\".git\"))\n\t\t{\n\t\t\t$text .=  \"<a class='plugin-manager btn btn-default' href='\".e_SELF.\"?pull.\".$this->plug['plugin_id'].\"' title='\".LAN_SYNC_WITH_GIT_REPO.\"'> \".ADMIN_GITSYNC_ICON.\"</a>\";\n\t\t}\n\n\n\t\t$text .=\"</div>\t\";\n\t\t\t\t\n\t\treturn $text;\n\t}\t\n\n\n\t\n}\n*/\n/*\nrequire_once(\"auth.php\");\n$pman->pluginObserver();\n$mes = e107::getMessage();\n$frm = e107::getForm();*/\n\nrequire_once(\"footer.php\");\nexit;\n\n\n// FIXME switch to admin UI\n/*\nclass pluginManager{\n\n\tvar $plugArray;\n\tvar $action;\n\tvar $id;\n\tvar $frm;\n\tvar $fieldpref;\n\tvar $titlearray \t\t= array();\n\tvar $pagetitle;\n\t\n\n\tvar $mp;\n\t\t\n\tprotected $pid = 'plugin_id';\n\t\n\tprotected $fields = array(\n\n\t\t   \t\t\"checkboxes\"\t\t\t=> array(\"title\" => \"\", 'type'=>null, \"forced\"=>TRUE, \"width\"=>\"3%\", 'thclass'=>'center','class'=>'center'),\n\t\t\t\t\"plugin_icon\"\t\t\t=> array(\"title\" => EPL_ADLAN_82, \"type\"=>\"icon\", \"width\" => \"5%\", \"thclass\" => \"middle center\",'class'=>'center', \"url\" => \"\"),\n\t\t\t\t\"plugin_name\"\t\t\t=> array(\"title\" => EPL_ADLAN_10, 'forced'=>true, \"type\"=>\"text\", \"width\" => \"auto\", 'class'=>'left', \"thclass\" => \"middle\", \"url\" => \"\"),\n \t\t\t\t\"plugin_version\"\t\t=> array(\"title\" => EPL_ADLAN_11, \"type\"=>\"numeric\", \"width\" => \"5%\", \"thclass\" => \"middle\", \"url\" => \"\"),\n    \t\t\t\"plugin_date\"\t\t\t=> array(\"title\" => LAN_RELEASED, \t\"type\"=>\"text\", \"width\" => \"8%\", \"thclass\" => \"middle\"),\n    \t\t\t\n    \t\t\t\"plugin_folder\"\t\t\t=> array(\"title\" => EPL_ADLAN_64, \"type\"=>\"text\", \"width\" => \"10%\", \"thclass\" => \"middle\"),\n\t\t\t\t\"plugin_category\"\t\t=> array(\"title\" => LAN_CATEGORY, \"type\"=>\"text\", \"width\" => \"auto\", \"thclass\" => \"middle\"),\n                \"plugin_author\"\t\t\t=> array(\"title\" => LAN_AUTHOR, \"type\"=>\"text\", \"width\" => \"10%\", \"thclass\" => \"middle\"),\n                \"plugin_license\"\t\t=> array(\"title\" => \"License\", \t 'nolist'=>true,\t\"forced\"=>true, \"type\"=>\"text\", \"width\" => \"5%\", \"thclass\" => \"left\"),\t\n  \t\t//\t\t\"plugin_price\"\t\t\t=> array(\"title\" => \"Price\", \t 'nolist'=>true,\t\"forced\"=>true, \"type\"=>\"text\", \"width\" => \"5%\", \"thclass\" => \"left\"),\t\n  \t\t\t\t\"plugin_compatible\"\t\t=> array(\"title\" => EPL_ADLAN_13, \"type\"=>\"text\", \"width\" => \"5%\", \"thclass\" => \"middle\"),\n\t\t\t\t\"plugin_description\"\t=> array(\"title\" => EPL_ADLAN_14, \"type\"=>\"bbarea\", \"width\" => \"30%\", \"thclass\" => \"middle center\",  'readParms' => 'expand=1&truncate=180&bb=1'),\n\t\t\t\t\"plugin_compliant\"\t\t=> array(\"title\" => EPL_ADLAN_81, \"type\"=>\"text\", \"width\" => \"5%\", \"thclass\" => \"middle center\", \"url\" => \"\"),\n\t\t//\t\t\"plugin_release\"\t\t=> array(\"title\" => EPL_ADLAN_81, \"type\"=>\"text\", \"width\" => \"5%\", \"thclass\" => \"middle center\", \"url\" => \"\"),\n\t\t//\t\t\"plugin_notes\"\t\t\t=> array(\"title\" => EPL_ADLAN_83, \"type\"=>\"url\", \"width\" => \"5%\", \"thclass\" => \"middle center\", \"url\" => \"\"),\n\t\t\t\n\t\t\t\t\"options\"\t\t\t\t=> array(\"title\" => LAN_OPTIONS, 'forced'=>TRUE, 'type'=> 'method', \"width\" => \"15%\", \"thclass\" => \"right last\", 'class'=>'right'),\n\n\t);\n\t\n\t\n\n\tfunction __construct()\n\t{\n        global $user_pref,$admin_log;\n\n\t\t$qry = str_replace('XDEBUG_PROFILE', '', e_QUERY);\n\n        $tmp = explode('.',$qry);\n\n\t  \t$this -> action     = ($tmp[0]) ? $tmp[0] : \"installed\";\n\t\t$this -> id         = !empty($tmp[1]) ? intval($tmp[1]) : \"\";\n\t\t$this -> titlearray = array('installed'=>EPL_ADLAN_22,'avail'=>EPL_ADLAN_23, 'upload'=>EPL_ADLAN_38);\n\t\t\n\t\tif(isset($_GET['mode']))\n\t\t{\n\t\t\t$this->action = $_GET['mode'];\n\t\t}\n\n\t\tif($this->action == 'online')\n\t\t{\n\t\t//\t$this->fields[\"plugin_price\"]['nolist'] = false; //  = array(\"title\" => \"Price\", \"forced\"=>true, \"type\"=>\"text\", \"width\" => \"5%\", \"thclass\" => \"middle center\");\t\t\n\t\t\t$this->fields[\"plugin_license\"]['nolist'] = false; \n\t\t}\n\n        $keys = array_keys($this -> titlearray);\n\t\t$this->pagetitle = (in_array($this->action,$keys)) ? $this -> titlearray[$this->action] : $this -> titlearray['installed'];\n\n\n\n    }\n\n\n\tpublic function getMarketplace()\n\t{\n\t\tif(null === $this->mp)\n\t\t{\n\t\t\trequire_once(e_HANDLER.'e_marketplace.php');\n\t\t\t$this->mp = new e_marketplace(); // autodetect the best method\n\t\t}\n\t\treturn $this->mp;\n\t}\n\n\n\n    function pluginObserver()\n\t{\n\t\t$tp = e107::getParser();\n\n        global $user_pref,$admin_log;\n        \n    \tif (isset($_POST['upload']))\n\t\t{\n        \t$this -> pluginProcessUpload();\n\t\t\t$this->action = 'avail'; \n\t\t}\n\n        if(isset($_POST['etrigger_ecolumns']))\n\t\t{\n\t\t\t$user_pref['admin_pluginmanager_columns'] = $tp->filter($_POST['e-columns']);\n\t\t\tsave_prefs('user');\n\t\t}\n\n\t\t$user_pref['admin_pluginmanager_columns'] = false;\n\t\t\n\t\t$this -> fieldpref = (vartrue($user_pref['admin_pluginmanager_columns'])) ? $user_pref['admin_pluginmanager_columns'] : array(\"plugin_icon\",\"plugin_name\",\"plugin_version\",\"plugin_date\",\"plugin_description\",\"plugin_category\",\"plugin_compatible\",\"plugin_author\",\"plugin_website\",\"plugin_notes\");\n\n\n\t\tforeach($this->fields as $key=>$val)\n\t\t{\n\t\t\tif(vartrue($val['forced']) && substr($key,0,6)=='plugin')\n\t\t\t{\n\t\t\t\t$this->fieldpref[] = $key;\t\n\t\t\t}\t\t\n\t\t}\n\t\t\n\t\tif($this->action == 'download')\n\t\t{\n\t\t\t$this->pluginDownload();\n\t\t\treturn; \t\n\t\t\t\n\t\t}\n\n\n\t\tif($this->action == 'pull' && !empty($this->id))\n\t\t{\n\t\t\t$info = e107::getPlugin()->getinfo($this->id);\n\n\t\t\tif(!empty($info['plugin_path']))\n\t\t\t{\n\t\t\t\t$return = e107::getFile()->gitPull($info['plugin_path'], 'plugin');\n\t\t\t\te107::getMessage()->addSuccess($return);\n\t\t\t\t$this->action = 'refresh';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$this->action = 'avail';\n\t\t\t}\n\n\t\t}\n\n\n\n        if($this->action == 'avail' || $this->action == 'installed')   // Plugin Check is done during upgrade_routine.\n\t\t{\n\t\t\t$this -> pluginCheck();\n\t\t}\n\n\t\tif($this->action == \"uninstall\")\n\t\t{\n        \t$this -> pluginUninstall();\n\t\t\t$this -> pluginCheck(true); // forced\n\t\t}\n\n\n\n\t\tif($this->action == \"repair\")\n\t\t{\n        \t$this -> pluginRepair();\n        \t$this->action = 'refresh';\n\t\t}\n\n\n\t\t\n\t\tif($this->action == \"refresh\")\n\t\t{\n        \t$this -> pluginCheck(true); // forced\n\t\t}\n\n        if($this->action == \"install\" || $this->action == \"refresh\")\n\t\t{\n        \t$this -> pluginInstall();\n    \t\t$this -> action = \"installed\";\n\t\t}\n\n\t\tif($this->action == 'create')\n\t\t{\n\t\t\t$pc = new pluginBuilder;\n\t\t\treturn;\n\t\t\t\t\n\t\t}\n\t\t\n\t\tif($this->action == 'lans')\n\t\t{\n\t\t\t$pc = new pluginLanguage;\n\t\t\treturn;\n\t\t\t\t\n\t\t}\n\n\t\tif($this->action == \"upgrade\")\n\t\t{\n        \t$this -> pluginUpgrade();\n      \t\t$this -> action = \"installed\";\n\t\t}\n\n\n\n\t\tif($this->action == \"upload\")\n\t\t{\n        \t$this -> pluginUpload();\n\t\t}\n\t\t\n\t\tif($this->action == \"online\")\n\t\t{\n        \t$text = $this -> pluginOnline();\n        \t$mes = e107::getMessage();\n        \te107::getRender()->tablerender(ADLAN_98.SEP.$caption, $mes->render(). $text);\n\t\t\treturn;\n\t\t}\n\t\t\n\t//\tprint_a($_POST);\n\n\t\tif(isset($_POST['install-selected']))\n\t\t{\n        \tforeach($_POST['multiselect'] as $val)\n\t\t\t{\n            \t$this -> id = intval($val);\n                $this -> pluginInstall();\n\t\t\t}\n      \t\t$this -> action = \"installed\";\n\t\t}\n\n        if($this->action != 'avail' && varset($this->fields['checkboxes']))\n\t\t{\n\t\t \tunset($this->fields['checkboxes']); //  = FALSE;\n\t\t}\n\n\t\tif($this->action !='upload' && $this->action !='uninstall')\n\t\t{\n\t\t\t$this -> pluginRenderList();\n\t\t}\n\n\n\n\t}\n\t\n\t\n\tprivate function compatibilityLabel($val='')\n\t{\n\t\t$badge = (vartrue($val) > 1.9) ? \"<span class='label label-warning'>\".EPL_ADLAN_88.\"</span>\" : '1.x';\n\t\treturn $badge;\t\n\t}\n\t\n\t\n\t\n\tfunction pluginOnline()\n\t{\n\t\tglobal $plugin, $e107SiteUsername, $e107SiteUserpass;\n\t\t$tp = e107::getParser();\n\t\t$frm = e107::getForm();\n\t\t\n\t\t$caption\t= EPL_ADLAN_89;\n\t\t\n\t\t$e107 = e107::getInstance();\n\t\t$xml = e107::getXml();\n\t\t$mes = e107::getMessage();\n\t\t\n\t//\t$mes->addWarning(\"Some older plugins may produce unpredictable results.\");\n\t\t// check for cURL\n\t\tif(!function_exists('curl_init'))\n\t\t{\n\t\t\t$mes->addWarning(EPL_ADLAN_90);\n\t\t}\n\t\t\n\t\t//TODO use admin_ui including filter capabilities by sending search queries back to the xml script. \n\t\t$from = isset($_GET['frm']) ? intval($_GET['frm']) : 0;\n\t\t$srch = preg_replace('/[^\\w]/','', vartrue($_GET['srch'])); \n\t\t\n\t\n\t\t$mp = $this->getMarketplace();\n\n\t\t// auth\n\t\t$mp->generateAuthKey($e107SiteUsername, $e107SiteUserpass);\n\t\t\n\t\t// do the request, retrieve and parse data\n\t\t$xdata = $mp->call('getList', array(\n\t\t\t'type' => 'plugin', \n\t\t\t'params' => array('limit' => 10, 'search' => $srch, 'from' => $from)\n\t\t));\n\t\t$total = $xdata['params']['count'];\n\t\n\t\t// OLD BIT OF CODE ------------------------------->\n\n\t\t// OLD BIT OF CODE END ------------------------------->\n\t\t\n\t\t\n// print_a($xdata);\n\t\t \n\t\t$c = 1;\n\t\tforeach($xdata['data'] as $row)\n\t\t{\n\t\t\t//$row = $r['@attributes'];\n\t\t\t\n\t\t\t//\tprint_a($row);\n\t\t\t\n\t\t\t\t$badge \t\t= $this->compatibilityLabel($row['compatibility']);;\n\t\t\t\t$featured \t= ($row['featured']== 1) ? \" <span class='label label-info'>\".EPL_ADLAN_91.\"</span>\" : '';\n\t\t\t\t$price \t\t= (!empty($row['price'])) ? \"<span class='label label-primary'>\".$row['price'].\" \".$row['currency'].\"</span>\" : \"<span class='label label-success'>\".EPL_ADLAN_93.\"</span>\";\n\t\t\t\n\t\t\t\t$data[] = array(\n\t\t\t\t\t'plugin_id'\t\t\t\t=> $row['params']['id'],\n\t\t\t\t\t'plugin_mode'\t\t\t=> $row['params']['mode'],\n\t\t\t\t\t'plugin_icon'\t\t\t=> vartrue($row['icon'],'e-plugins-32'),\n\t\t\t\t\t'plugin_name'\t\t\t=> stripslashes($row['name']),\n\t\t\t\t\t'plugin_featured'\t\t=> $featured,\n\t\t\t\t\t'plugin_sef'\t\t\t=> '',\n\t\t\t\t\t'plugin_folder'\t\t\t=> $row['folder'],\n\t\t\t\t\t'plugin_date'\t\t\t=> vartrue($row['date']),\n\t\t\t\t\t'plugin_category'\t\t=> vartrue($row['category'], 'n/a'),\n\t\t\t\t\t'plugin_author'\t\t\t=> vartrue($row['author']),\n\t\t\t\t\t'plugin_version'\t\t=> $row['version'],\n\t\t\t\t\t'plugin_description'\t=> nl2br(vartrue($row['description'])),\n\t\t\t\t\t'plugin_compatible'\t\t=> $badge,\n\t\t\t\t\n\t\t\t\t\t'plugin_website'\t\t=> vartrue($row['authorUrl']),\n\t\t\t\t\t'plugin_url'\t\t\t=> $row['urlView'],\n\t\t\t\t\t'plugin_notes'\t\t\t=> '',\n\t\t\t\t\t'plugin_price'\t\t\t=> $row['price'],\n\t\t\t\t\t'plugin_license'\t\t=> $price\n\t\t\t\t);\t\n\t\t\t\t\n\t\t\t$c++;\n\t\t}\n\n\t\t$fieldList = $this->fields;\n\t\tunset($fieldList['checkboxes']);\n\n\t\t$text = \"\n\t\t\t<form class='form-search form-inline' action='\".e_SELF.\"?\".e_QUERY.\"' id='core-plugin-list-form' method='get'>\n\t\t\t<div id='admin-ui-list-filter' class='e-search '>\".$frm->search('srch', $srch, 'go', $filterName, $filterArray, $filterVal).$frm->hidden('mode','online').\"\n\t\t\t</div>\n\t\t\t</form>\n\t\t\t\n\t\t\t<form action='\".e_SELF.\"?\".e_QUERY.\"' id='core-plugin-list-form' method='post'>\n\t\t\t\t<fieldset class='e-filter' id='core-plugin-list'>\n\t\t\t\t\t<legend class='e-hideme'>\".$caption.\"</legend>\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t<table id=core-plugin-list' class='table adminlist table-striped'>\n\t\t\t\t\t\t\".$frm->colGroup($fieldList,$this->fieldpref).\n\t\t\t\t\t\t$frm->thead($fieldList,$this->fieldpref).\"\n\t\t\t\t\t\t<tbody>\n\t\t\";\t\n\t\t\n\t\t\n\t\n\t\t\n\t\tforeach($data as $key=>$val\t)\n\t\t{\n\t\t//\tprint_a($val);\n\t\t\t$text .= \"<tr>\";\n\t\t\t\t\t\t\n\t\t\tforeach($this->fields as $v=>$foo)\n\t\t\t{\n\t\t\t\tif(!in_array($v,$this->fieldpref) || $v == 'checkboxes')\n\t\t\t\t{\n\t\t\t\t\tcontinue;\t\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t$_value = $val[$v];\n\t\t\t\tif($v == 'plugin_name') $_value .= $val['plugin_featured'];\n\t\t\t\t// echo '<br />v='.$v;\n\t\t\t\t$text .= \"<td style='height: 40px' class='\".vartrue($this->fields[$v]['class'],'left').\"'>\".$frm->renderValue($v, $_value, $this->fields[$v], $key).\"</td>\\n\";\n\t\t\t}\n\t\t\t$text .= \"<td class='right'>\".$this->options($val).\"</td>\";\n\t\t\t$text .= \"</tr>\";\t\t\n\t\t\t\n\t\t}\n\t\t\n\t\t\n\t\t$text .= \"\n\t\t\t\t\t\t</tbody>\n\t\t\t\t\t</table>\";\n\t\t$text .= \"\n\t\t\t\t</fieldset>\n\t\t\t</form>\n\t\t\";\n\t\t\n\t\t$amount = 30;\n\t\t\n\t\t\n\t\tif($total > $amount)\n\t\t{\n\t\t\t$parms = $total.\",\".$amount.\",\".$from.\",\".e_SELF.'?mode=online&amp;frm=[FROM]';\n\n\t\t\tif(!empty($srch))\n\t\t\t{\n\t\t\t\t$parms .= '&amp;srch='.$srch;\n\t\t\t}\n\n\t\t\t$text .= \"<div class='control-group form-inline input-inline' style='text-align:center;margin-top:10px'>\".$tp->parseTemplate(\"{NEXTPREV=$parms}\",TRUE).\"</div>\";\n\t\t}\n\n\t\treturn $text;\n\n\t}\n\t\n\t\n\t\n\tfunction options($data)\n\t{\n\t\t\t\n\t//\tprint_a($data);\n\n\t\t\t\t\n\n\t\t//$url = e_SELF.\"?src=\".base64_encode($d);\n\t//\t$url = e_SELF.'?action=download&amp;src='.base64_encode($d);//$url.'&amp;action=download';\n\t\t$id = 'plug_'.$data['plugin_id'];\n\t\t//<button type='button' data-target='{$id}' data-loading='\".e_IMAGE.\"/generic/loading_32.gif' class='btn btn-primary e-ajax middle' value='Download and Install' data-src='\".$url.\"' ><span>Download and Install</span></button>\n\t\t$modalCaption = (!empty($data['plugin_price'])) ? EPL_ADLAN_92.\" \".$data['plugin_name'].\" \".$data['plugin_version'] : EPL_ADLAN_230.\" \".$data['plugin_name'].\" \".$data['plugin_version'];\n\n\t\t$srcData = array(\n\t\t\t'plugin_id'     => $data['plugin_id'],\n\t\t\t'plugin_folder' => $data['plugin_folder'],\n\t\t\t'plugin_price'  => $data['plugin_price'],\n\t\t\t'plugin_mode'   => $data['plugin_mode'],\n\t\t\t'plugin_url'    => $data['plugin_url'],\n\t\t);\n\n\n\t\t$d = http_build_query($srcData,false,'&');\n\t\t$url = e_SELF.'?mode=download&src='.base64_encode($d);\n\t\t$dicon = '<a title=\"'.EPL_ADLAN_237.'\" class=\"e-modal btn btn-default\" href=\"'.$url.'\" rel=\"external\" data-loading=\"'.e_IMAGE.'/generic/loading_32.gif\"  data-cache=\"false\" data-modal-caption=\"'.$modalCaption.'\"  target=\"_blank\" >'.ADMIN_INSTALLPLUGIN_ICON.'</a>';\n\n\n\n\t\t// Temporary Pop-up version.\n\t//\t$dicon = '<a class=\"e-modal\" href=\"'.$data['plugin_url'].'\" rel=\"external\" data-modal-caption=\"'.$data['plugin_name'].\" \".$data['plugin_version'].'\"  target=\"_blank\" ><img class=\"top\" src=\"'.e_IMAGE_ABS.'icons/download_32.png\" alt=\"\"  /></a>';\n\n\t//\t$dicon = \"<a data-toggle='modal' data-modal-caption=\\\"Downloading \".$data['plugin_name'].\" \".$data['plugin_version'].\"\\\" href='{$url}' data-cache='false' data-target='#uiModal' title='\".$LAN_DOWNLOAD.\"' ><img class='top' src='\".e_IMAGE_ABS.\"icons/download_32.png' alt=''  /></a> \";\n\n\t\treturn \"<div id='{$id}' class='right' >\n\t\t{$dicon}\n\t\t</div>\";\t\t\t\t\n\t}\n\n\n\n\tprivate function pluginDownload()\n\t{\n\t\tdefine('e_IFRAME', true);\n\t\t$frm = e107::getForm();\n\t\t$mes = e107::getMessage();\n\t\t$tp = e107::getParser();\n\t\t\n\t//\tprint_a($_GET); \t\n\t\t\n\t\t$string =  base64_decode($_GET['src']);\t\n\t\tparse_str($string, $data);\n\n\t\tif(deftrue('e_DEBUG_MARKETPLACE'))\n\t\t{\n\t\t\techo \"<b>DEBUG MODE ACTIVE (no downloading)</b><br />\";\n\t\t\techo '$_GET[src]: ';\n\t\t\tprint_a($_GET);\n\n\t\t\techo 'base64 decoded and parsed as $data:';\n\t\t\tprint_a($data);\n\t\t\treturn false;\n\t\t}\n\n\t\t$pluginFolder = !empty($data['plugin_folder']) ? $tp->filter($data['plugin_folder']) : '';\n\t\t$pluginUrl = !empty($data['plugin_url']) ? $tp->filter($data['plugin_url']) : '';\n\t\t$pluginID = !empty($data['plugin_id']) ? $tp->filter($data['plugin_id']) : '';\n\t\t$pluginMode = !empty($data['plugin_mode']) ? $tp->filter($data['plugin_mode']) : '';\n\n\t\tif(!empty($data['plugin_price']))\n\t\t{\n\t\t\te107::getRedirect()->go($pluginUrl);\n\t\t\treturn true;\n\t\t}\n\n\t\t$mp = $this->getMarketplace();\n\t//\t$mp->generateAuthKey($e107SiteUsername, $e107SiteUserpass);\n\t\n\n\t\t\n\t\t// Server flush useless. It's ajax ready state 4, we can't flush (sadly) before that (at least not for all browsers) \n\t \t$mes->addSuccess(EPL_ADLAN_94);\n\n\t\tif($mp->download($pluginID, $pluginMode, 'plugin'))\n\t\t{\n\t\t\t$this -> pluginCheck(true); // rescan the plugin directory\n\t\t\t$text = e107::getPlugin()->install($pluginFolder);\n\n\t\t\t$mes->addInfo($text); \n\t\t\techo $mes->render('default', 'success'); \n\t\t}\n\t\telse\n\t\t{\n\t\t\t// Unable to continue\n\t\t\techo $mes->addError(EPL_ADLAN_95)->render('default', 'error');\n\t\t}\n\t\t\n\t\techo $mes->render('default', 'debug'); \n\t\treturn; \n\t\t\n\t\t\n\t\t\n\t\t$text =\"<iframe src='\".$pluginUrl.\"' style='width:99%; height:500px; border:0px'>Loading...</iframe>\";\n\t//\tprint_a($data); \n\t\t$text .= $frm->open('upload-url-form','post');\n\t\t\n\t\t$text .= \"<div class='form-inline' style='padding:20px'>\";\n\t\t$text .= \"<input type='text' name='upload_url' size='255' style='width:70%;height:50px;text-align:center' placeholder='\".EPL_ADLAN_96.\"' />\";\n\t\t$text .= $frm->admin_button('upload_remote_url',1,'create','Install');\n\t    $text .= \"</div>\";\n\t\t$text .= \"</div>\\n\\n\";\n\t\t\n\t\t$text .= $frm->close();\n\t\techo $text; \n\t\t\n\t}\n\t\n\n\tfunction pluginUninstall()\n\t{\n\n\t\tif(!isset($_POST['uninstall_confirm']))\n\t\t{\t// $id is already an integer\n\n\t\t\t$this->pluginConfirmUninstall();\n\t\t\treturn;\n\t\t}\n\n\t\t$post = e107::getParser()->filter($_POST);\n\t\t$text = e107::getPlugin()->uninstall($this->id, $post);\n\t\t$this->show_message($text, E_MESSAGE_SUCCESS);\n\n\t\t$this->action = 'installed';\n\n\t\t$log = e107::getPlugin()->getLog();\n\t\te107::getDebug()->log($log);\n\n\t\treturn;\n\n   }\n\n\n\n\n\n   function pluginProcessUpload()\n   {\n\t\t\tif (!$_POST['ac'] == md5(ADMINPWCHANGE))\n\t\t\t{\n\t\t\t\texit;\n\t\t\t}\n\t\t\t\n\t\t\t$fl = e107::getFile();\n\t\t\t$data = $fl->getUploaded(e_TEMP); \n\t\t\t$mes = e107::getMessage();\n\t\t\t\n\t\t\tif(empty($data[0]['error']))\n\t\t\t{\n\t\t\t\tif($fl->unzipArchive($data[0]['name'],'plugin'))\n\t\t\t\t{\n\t\t\t\t\t$mes->addSuccess(EPL_ADLAN_43); \n\t\t\t\t}\n\t\t\t\telse \n\t\t\t\t{\n\t\t\t\t\t$mes->addError(EPL_ADLAN_97);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t//\t$data = process_uploaded_files(e_TEMP);\n\t\t//\tprint_a($data); \n\t\t\t\n\t\t\techo $mes->render(); \n\t\t\t\n\t\t\treturn true;\n\n\n   }\n\n\n// -----------------------------------------------------------------------------\n// TODO FIXME - This needs cleaning: e107::getMessage(), limit the globals, etc. \n\n   function pluginInstall()\n   {\n        global $plugin;\n\t\t$text = $plugin->install_plugin($this->id);\n\t\t\n\t\t$log = e107::getAdminLog();\n\t\t\t\n\t\t\t\n\t\t\t\n\t\tif ($text === FALSE)\n\t\t{ // Tidy this up\n\t\t\t$this->show_message(EPL_ADLAN_99, E_MESSAGE_ERROR);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$plugin->save_addon_prefs('update');\n\t\t\t$info = $plugin->getinfo($this->id);\n\t\t\t \n\t\t\t$name = deftrue($info['plugin_name'],$info['plugin_name']). \" v\".$info['plugin_version']. \"({e_PLUGIN}\".$info['plugin_path'].\")\";\n\t\t\t \n\t\t\t$log->log_event('PLUGMAN_01', $name, E_LOG_INFORMATIVE, '');\n\t\t\n\t\t\t$this->show_message($text, E_MESSAGE_SUCCESS);\n\t\t}\n\n   }\n\n\n// -----------------------------------------------------------------------------\n\n\tfunction pluginUpgrade()\n\t{\n\t\t$pref \t\t= e107::getPref();\n\t\t$admin_log \t= e107::getAdminLog();\n\t\t$plugin \t= e107::getPlugin();\n\n\t  \t$sql \t\t= e107::getDb();\n   \t\t$mes \t\t= e107::getMessage(); \n\t\t$plug \t\t= $plugin->getinfo($this->id);\n\n\t\t$text = '';\n\n\t\t$_path = e_PLUGIN.$plug['plugin_path'].'/';\n\t\tif(file_exists($_path.'plugin.xml'))\n\t\t{\n\t\t\t$plugin->install_plugin_xml($this->id, 'upgrade');\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$eplug_folder = null;\n\t\t\t$upgrade_alter_tables = null;\n\t\t\t$upgrade_add_prefs = null;\n\t\t\t$upgrade_remove_prefs = null;\n\t\t\t$upgrade_add_array_pref = null;\n\t\t\t$upgrade_remove_array_pref = null;\n\t\t\t$eplug_version = null;\n\n\n\n\t\t\tinclude(e_PLUGIN.$plug['plugin_path'].'/plugin.php');\n\n\t\t\t$text = '';\n\n\t\t\t$func = $eplug_folder.'_upgrade';\n\t\t\tif (function_exists($func))\n\t\t\t{\n\t\t\t\t$text .= call_user_func($func);\n\t\t\t}\n\n\t\t\tif (is_array($upgrade_alter_tables))\n\t\t\t{\n\t\t\t\t$result = $plugin->manage_tables('upgrade', $upgrade_alter_tables);\n\t\t\t\tif (true !== $result)\n\t\t\t\t{\n\t\t\t\t\t//$text .= EPL_ADLAN_9.'<br />';\n\t\t\t\t\t$mes->addWarning(EPL_ADLAN_9)\n\t\t\t\t\t\t->addDebug($result);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$text .= EPL_ADLAN_7.\"<br />\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (is_array($upgrade_add_prefs))\n\t\t\t{\n\t\t\t\t$plugin->manage_prefs('add', $upgrade_add_prefs);\n\t\t\t\t$text .= EPL_ADLAN_8.'<br />';\n\t\t\t}\n\n\t\t\tif (is_array($upgrade_remove_prefs))\n\t\t\t{\n\t\t\t\t$plugin->manage_prefs('remove', $upgrade_remove_prefs);\n\t\t\t}\n\n\t\t\tif (is_array($upgrade_add_array_pref))\n\t\t\t{\n\t\t\t\tforeach($upgrade_add_array_pref as $key => $val)\n\t\t\t\t{\n\t\t\t\t\t$plugin->manage_plugin_prefs('add', $key, $eplug_folder, $val);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (is_array($upgrade_remove_array_pref))\n\t\t\t{\n\t\t\t\tforeach($upgrade_remove_array_pref as $key => $val)\n\t\t\t\t{\n\t\t\t\t\t$plugin->manage_plugin_prefs('remove', $key, $eplug_folder, $val);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t$plugin->manage_search('upgrade', $eplug_folder);\n\t\t\t$plugin->manage_notify('upgrade', $eplug_folder);\n\n\t\t\t$eplug_addons = $plugin -> getAddons($eplug_folder);\n\n\t\t\t$info = $plugin->getinfo($this->id);\n\t\t\t\t \n\t\t\t$name = deftrue($info['plugin_name'],$info['plugin_name']). \" v\".$eplug_version. \"({e_PLUGIN}\".$info['plugin_path'].\")\";\n\n\t\t\te107::getLog()->add('PLUGMAN_02', $name, E_LOG_INFORMATIVE, '');\n\t\t\t$text .= (isset($eplug_upgrade_done)) ? '<br />'.$eplug_upgrade_done : \"<br />\".LAN_UPGRADE_SUCCESSFUL;\n\t\t\t$sql->update('plugin', \"plugin_version ='{$eplug_version}', plugin_addons='{$eplug_addons}' WHERE plugin_id='$this->id' \");\n\t\t\t$pref['plug_installed'][$plug['plugin_path']] = $eplug_version; \t\t\t// Update the version\n\t\t\t\n\t\t\te107::getConfig('core')->setPref($pref);\n\t\t\t$plugin->rebuildUrlConfig();\n\t\t\te107::getConfig('core')->save();\n\t\t}\n\n\n\t\t$mes->addSuccess($text);\n\t\t$plugin->save_addon_prefs('update');\n\n   }\n\n\n// -----------------------------------------------------------------------------\n\n   function pluginRepair()\n   {\n      // global $plug;\n\n\t\t\t$plug = e107::getSingleton('e107plugin')->getinfo($this->id);\n\n\t\t\t$_path = e_PLUGIN.$plug['plugin_path'].'/';\n\t\t\tif(file_exists($_path.'plugin.xml'))\n\t\t\t{\n\t\t\t\t// $text .= $plugin->install_plugin_xml($this->id, 'refresh');\n\t\t\t\te107::getSingleton('e107plugin')->refresh($plug['plugin_path']);\n\t\t\t\te107::getLog()->add('PLUGMAN_04', $this->id.':'.$plug['plugin_path'], E_LOG_INFORMATIVE, '');\n\t\t\t}\n\n    }\n\n// -----------------------------------------------------------------------------\n\n\t\t// Check for new plugins, create entry in plugin table ...\n    function pluginCheck($force=false)\n\t{\n\t\tglobal $plugin;\n\n\t\tif(!PLUGIN_SCAN_INTERVAL)\n\t\t{\n\t\t\t$plugin->update_plugins_table('update');\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tif((time() > vartrue($_SESSION['nextPluginFolderScan'],0)) || $force == true)\n\t\t{\n\t\t\t$plugin->update_plugins_table('update');\n\t\t}\n\t\t\n\t\t$_SESSION['nextPluginFolderScan'] = time() + PLUGIN_SCAN_INTERVAL;\n\t\t//echo \"TIME = \".$_SESSION['nextPluginFolderScan'];\n\t\t\n    }\n\t\t// ----------------------------------------------------------\n\t\t//        render plugin information ...\n\n\n// -----------------------------------------------------------------------------\n\n\n    function pluginUpload()\n\t{\n         global $plugin;\n\t\t $frm = e107::getForm();\n\n\t\t//TODO 'install' checkbox in plugin upload form. (as it is for theme upload)\n\n\n\t\t\tif(!is_writable(e_PLUGIN))\n\t\t\t{\n\t\t\t   \t$text = EPL_ADLAN_44;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t  // Get largest allowable file upload\n\t\t\t  require_once(e_HANDLER.'upload_handler.php');\n\t\t\t  $max_file_size = get_user_max_upload();\n\n\t\t\t  $text = \"\n\t\t\t\t<form enctype='multipart/form-data' method='post' action='\".e_SELF.\"'>\n                <table class='table adminform'>\n                \t<colgroup>\n                \t\t<col class='col-label' />\n                \t\t<col class='col-control' />\n                \t</colgroup>\n\t\t\t\t<tr>\n\t\t\t\t<td>\".EPL_ADLAN_37.\"</td>\n\t\t\t\t<td>\n\t\t\t\t<input type='hidden' name='MAX_FILE_SIZE' value='{$max_file_size}' />\n\t\t\t\t<input type='hidden' name='ac' value='\".md5(ADMINPWCHANGE).\"' />\n\t\t\t\t<input class='tbox' type='file' name='file_userfile[]' size='50' />\n\t\t\t\t</td>\n                </tr>\n\t\t\t\t</table>\n\n\t\t\t\t<div class='center buttons-bar'>\";\n                $text .= $frm->admin_button('upload', EPL_ADLAN_38, 'submit', EPL_ADLAN_38);\n\n\t\t\t\t$text .= \"\n\t\t\t\t</div>\n\n\t\t\t\t</form>\\n\";\n\t\t\t}\n\n         e107::getRender()->tablerender(ADLAN_98.SEP.EPL_ADLAN_38, $text);\n\t}\n\n// -----------------------------------------------------------------------------\n\n\n\n\n\tfunction pluginRenderList() // Uninstall and Install sorting should be fixed once and for all now !\n\t{\n\n\t\tglobal $plugin;\n\t\t$frm = e107::getForm();\n\t\t$mes = e107::getMessage();\n\n\t\tif($this->action == \"\" || $this->action == \"installed\")\n\t\t{\n\t\t\t$installed = $plugin->getall(1);\n\n\t\t\t$mp = $this->getMarketplace();\n\n\t\t\t$versions = $mp->getVersionList();\n\n\t\t//\tprint_a($versions);\n\t\t\t$caption = EPL_ADLAN_22;\n\t\t\t$pluginRenderPlugin = $this->pluginRenderPlugin($installed, $versions);\n\t\t\t$button_mode = \"uninstall-selected\";\n\t\t\t$button_caption = EPL_ADLAN_85;\n\t\t\t$button_action = \"delete\";\n\t\t}\n\t\tif($this->action == \"avail\")\n\t\t{\n\t\t\t$uninstalled = $plugin->getall(0);\t\t\n\t\t\t$caption = EPL_ADLAN_23;\n\t\t\t$pluginRenderPlugin = $this->pluginRenderPlugin($uninstalled);\n\t\t\t$button_mode = \"install-selected\";\n\t\t\t$button_caption = EPL_ADLAN_84;\n\t\t\t$button_action = \"update\";\n\t\t}\n\n\t\t$text = \"\n\t\t\t<form action='\".e_SELF.\"?\".e_QUERY.\"' id='core-plugin-list-form' method='post'>\n\t\t\t\t<fieldset id='core-plugin-list'>\n\t\t\t\t\t<legend class='e-hideme'>\".vartrue($caption).\"</legend>\n\t\t\t\t\t<table class='table adminlist table-striped'>\n\t\t\t\t\t\t\".$frm->colGroup($this->fields,$this->fieldpref).\n\t\t\t\t\t\t$frm->thead($this->fields,$this->fieldpref).\"\n\t\t\t\t\t\t<tbody>\n\t\t\";\n\n\t\tif(vartrue($pluginRenderPlugin))\n\t\t{\n\t\t\t$text .= $pluginRenderPlugin;\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$text .= \"<tr><td class='center' colspan='\".count($this->fields).\"'>\";\n \t\t\t$text .= str_replace(\"[x]\", \"<a href='\".e_ADMIN.\"plugin.php?avail'>\".EPL_ADLAN_100.\"</a>\", EPL_ADLAN_101);\n\t\t\t$text .= \"</td></tr>\";\n\t\t}\n\n\t\t$text .= \"\n\t\t\t\t\t\t</tbody>\n\t\t\t\t\t</table>\";\n\n\t\tif($this->action == \"avail\")\n\t\t{\n\t\t\t$text .= \"\n\t\t\t\t\t<div class='buttons-bar center'>\".$frm->admin_button($button_mode, $button_caption, $button_action).\"</div>\";\n\t\t}\n\t\t$text .= \"\n\t\t\t\t</fieldset>\n\t\t\t</form>\n\t\t\";\n\n\t\te107::getRender()->tablerender(ADLAN_98.SEP.$caption, $mes->render(). $text);\n\t}\n\n\n// -----------------------------------------------------------------------------\n\n\tfunction pluginRenderPlugin($pluginList, $versions = array())\n\t{\n\t\t\tglobal $plugin; \n\t\t\t\n\t\t\tif (empty($pluginList)) return '';\n\n\t\t\t$tp = e107::getParser();\n\t\t\t$frm = e107::getForm();\n\t\t\t\n\t\t\t$pgf = new pluginmanager_form; \n\n\t\t\t$text = \"\";\n\n\n\n\t\t\tforeach($pluginList as $plug)\n\t\t\t{\n\t\t\t\te107::loadLanFiles($plug['plugin_path'],'admin');\n\t\t\t\t\n\t\t\t\tif($this->action == \"avail\")\n\t\t\t\t{\n\t\t\t\t\te107::lan($plug['plugin_path'],'global', true); // Load language files. \n\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\n\n\t\t\t\t$_path = e_PLUGIN.$plug['plugin_path'].'/';\n\n\t\t\t\t$plug_vars = false;\n\t\t\t\t$plugin_config_icon = \"\";\n\n\n\n\t\t\t\tif($plugin->parse_plugin($plug['plugin_path']))\n\t\t\t\t{\n\t\t\t\t\t$plug_vars = $plugin->plug_vars;\n\t\t\t\t}\n\n\n\n\t\t\t\tif(varset($plug['plugin_category']) == \"menu\") // Hide \"Menu Only\" plugins.\n\t\t\t\t{\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tif($plug_vars)\n\t\t\t\t{\n\n\t\t\t\t\t$icon_src = (isset($plug_vars['plugin_php']) ? e_PLUGIN : $_path).$plug_vars['administration']['icon'];\n\t\t\t\n                   \t$plugin_icon = $plug_vars['administration']['icon'] ? $icon_src : $tp->toGlyph('e-cat_plugins-32');\n              \n                    \n                    $conf_file = \"#\";\n\t\t\t\t\t$conf_title = \"\";\n\n\t\t\t\t\tif ($plug_vars['administration']['configFile'] && $plug['plugin_installflag'] == true)\n\t\t\t\t\t{\n\t\t\t\t\t\t$conf_file = e_PLUGIN.$plug['plugin_path'].'/'.$plug_vars['administration']['configFile'];\n\t\t\t\t\t\t$conf_title = LAN_CONFIGURE.' '.$tp->toHTML($plug_vars['@attributes']['name'], \"\", \"defs,emotes_off, no_make_clickable\");\n\t\t\t\t\t//\t$plugin_icon = \"<a title='{$conf_title}' href='{$conf_file}' >\".$plugin_icon.\"</a>\";\n\t\t\t\t\t\t$plugin_config_icon = \"<a class='btn btn-default' title='{$conf_title}' href='{$conf_file}' >\".ADMIN_CONFIGURE_ICON.\"</a>\";\n\t\t\t\t\t}\n\n\t\t\t\t\t$plugEmail = varset($plug_vars['author']['@attributes']['email'],'');\n\t\t\t\t\t$plugAuthor = varset($plug_vars['author']['@attributes']['name'],'');\n\t\t\t\t\t$plugURL = varset($plug_vars['author']['@attributes']['url'],'');\n\t\t\t\t\t$plugDate\t= varset($plug_vars['@attributes']['date'],'');\n\t\t\t\t\t$compatibility\t= varset($plug_vars['@attributes']['compatibility'],'');\n\t\t\t\t\t\n\t\t\t\t\t$description = varset($plug_vars['description']['@attributes']['lang']) ? $tp->toHTML($plug_vars['description']['@attributes']['lang'], false, \"defs,emotes_off, no_make_clickable\") : $tp->toHTML($plug_vars['description']['@value'], false, \"emotes_off, no_make_clickable\") ;\n\t\t\t\t\t\n                    $plugReadme = \"\";\n\t\t\t\t\tif(varset($plug['plugin_installflag']))\n\t\t\t\t\t{\n\t\t\t\t\t\t$plugName = \"<a title='{$conf_title}' href='{$conf_file}' >\".$tp->toHTML($plug['plugin_name'], false, \"defs,emotes_off, no_make_clickable\").\"</a>\";\n                    }\n                    else\n\t\t\t\t\t{\n                    \t$plugName = $tp->toHTML($plug['plugin_name'], false, \"defs,emotes_off, no_make_clickable\");\n\t\t\t\t\t}\n\t\t\t\t\tif(varset($plug_vars['readme']))   // 0.7 plugin.php\n\t\t\t\t\t{\n                    \t$plugReadme = $plug_vars['readme'];\n\t\t\t\t\t}\n\t\t\t\t\tif(varset($plug_vars['readMe'])) // 0.8 plugin.xml\n\t\t\t\t\t{\n                    \t$plugReadme = $plug_vars['readMe'];\n\t\t\t\t\t}\n\n\t\t\t\t\tif(!file_exists($plugin_icon))\n\t\t\t\t\t{\n\t\t\t\t\t\t$plugin_icon = 'e-cat_plugins-32'; // e_IMAGE.\"admin_images/cat_plugins_32.png\";\n\t\t\t\t\t}\n\n\t\t\t\t\t\t\n\t\t\t\t\t$data = array(\n\t\t\t\t\t'plugin_id'\t\t\t\t=> $plug['plugin_id'],\n\t\t\t\t\t'plugin_icon'\t\t\t=> $plugin_icon,\n\t\t\t\t\t'plugin_name'\t\t\t=> $plugName,\n\t\t\t\t\t'plugin_folder'\t\t\t=> $plug['plugin_path'],\n\t\t\t\t\t'plugin_date'\t\t\t=> $plugDate,\n\t\t\t\t\t'plugin_category'\t\t=> vartrue($plug['plugin_category']),\n\t\t\t\t\t'plugin_author'\t\t\t=> vartrue($plugAuthor), // vartrue($plugEmail) ? \"<a href='mailto:\".$plugEmail.\"' title='\".$plugEmail.\"'>\".$plugAuthor.\"</a>\" : vartrue($plugAuthor),\n\t\t\t\t\t'plugin_version'\t\t=> $plug['plugin_version'],\n\t\t\t\t\t'plugin_description'\t=> $description,\n\t\t\t\t\t'plugin_compatible'\t\t=> $this->compatibilityLabel($plug_vars['@attributes']['compatibility']),\n\t\t\t\t\n\t\t\t\t\t'plugin_website'\t\t=> vartrue($plug['authorUrl']),\n\t\t\t//\t\t'plugin_url'\t\t\t=> vartrue($plugURL), // ; //  ? \"<a href='{$plugURL}' title='{$plugURL}' >\".ADMIN_URL_ICON.\"</a>\" : \"\",\n\t\t\t\t\t'plugin_notes'\t\t\t=> ''\n\t\t\t\t\t);\t\n\n\n\t\t\t\t\t$pgf->plug_vars = $plug_vars;\n\t\t\t\t\t$pgf->plug\t\t= $plug;\n\t\t\t\t\t$text \t\t\t.= $pgf->renderTableRow($this->fields, $this->fieldpref, $data, 'plugin_id');\n\n\n\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn $text;\n\t}\n\n\n// -----------------------------------------------------------------------------\n\n\n\n\t\tfunction pluginConfirmUninstall()\n\t\t{\n\t\t\tglobal $plugin;\n\n\t\t\t$frm \t= e107::getForm();\n\t\t\t$tp \t= e107::getParser();\n\t\t\t$mes \t= e107::getMessage();\n\n\t\t\t$plug = $plugin->getinfo($this->id);\n\n\t\t\tif ($plug['plugin_installflag'] == true )\n\t\t\t{\n\t\t\t\tif($plugin->parse_plugin($plug['plugin_path']))\n\t\t\t\t{\n\t\t\t\t\t$plug_vars = $plugin->plug_vars;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\treturn FALSE;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\treturn FALSE;\n\t\t\t}\n\t\t\t$userclasses = '';\n\t\t\t$eufields = '';\n\t\t\tif (isset($plug_vars['userClasses']))\n\t\t\t{\n\t\t\t\tif (isset($plug_vars['userclass']['@attributes']))\n\t\t\t\t{\n\t\t\t\t\t$plug_vars['userclass'][0]['@attributes'] = $plug_vars['userclass']['@attributes'];\n\t\t\t\t\tunset($plug_vars['userclass']['@attributes']);\n\t\t\t\t}\n\t\t\t\t$spacer = '';\n\t\t\t\tforeach ($plug_vars['userClasses']['class'] as $uc)\n\t\t\t\t{\n\t\t\t\t\t$userclasses .= $spacer.$uc['@attributes']['name'].' - '.$uc['@attributes']['description'];\n\t\t\t\t\t$spacer = '<br />';\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (isset($plug_vars['extendedFields']))\n\t\t\t{\n\t\t\t\tif (isset($plug_vars['extendedFields']['@attributes']))\n\t\t\t\t{\n\t\t\t\t\t$plug_vars['extendedField'][0]['@attributes'] = $plug_vars['extendedField']['@attributes'];\n\t\t\t\t\tunset($plug_vars['extendedField']['@attributes']);\n\t\t\t\t}\n\t\t\t\t$spacer = '';\n\t\t\t\tforeach ($plug_vars['extendedFields']['field'] as $eu)\n\t\t\t\t{\n\t\t\t\t\t$eufields .= $spacer.'plugin_'.$plug_vars['folder'].'_'.$eu['@attributes']['name'];\n\t\t\t\t\t$spacer = '<br />';\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif(is_writable(e_PLUGIN.$plug['plugin_path']))\n\t\t\t{\n\t\t\t\t$del_text = $frm->select('delete_files','yesno',0);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$del_text = \"\n\t\t\t\t\".EPL_ADLAN_53.\"\n\t\t\t\t<input type='hidden' name='delete_files' value='0' />\n\t\t\t\t\";\n\t\t\t}\n\n\t\t\t$text = \"\n\t\t\t<form action='\".e_SELF.\"?\".e_QUERY.\"' method='post'>\n\t\t\t<fieldset id='core-plugin-confirmUninstall'>\n\t\t\t<legend>\".EPL_ADLAN_54.\" \".$tp->toHtml($plug_vars['@attributes']['name'], \"\", \"defs,emotes_off, no_make_clickable\").\"</legend>\n            <table class='table adminform'>\n            \t<colgroup>\n            \t\t<col class='col-label' />\n            \t\t<col class='col-control' />\n            \t</colgroup>\n \t\t\t<tr>\n\t\t\t\t<td>\".EPL_ADLAN_55.\"</td>\n\t\t\t\t<td>\".LAN_YES.\"</td>\n\t\t\t</tr>\";\n\n\t\t\t$opts = array();\n\n\t\t\t$opts['delete_tables'] = array(\n\t\t\t\t\t'label'\t\t\t=> EPL_ADLAN_57,\n\t\t\t\t\t'helpText'\t\t=> EPL_ADLAN_58,\n\t\t\t\t\t'itemList'\t\t=> array(1=>LAN_YES,0=>LAN_NO),\n\t\t\t\t\t'itemDefault' \t=> 1\n\t\t\t);\n\n\t\t\tif ($userclasses)\n\t\t\t{\n\t\t\t\t$opts['delete_userclasses'] = array(\n\t\t\t\t\t'label'\t\t\t=> EPL_ADLAN_78,\n\t\t\t\t\t'preview'\t\t=> $userclasses,\n\t\t\t\t\t'helpText'\t\t=> EPL_ADLAN_79,\n\t\t\t\t\t'itemList'\t\t=> array(1=>LAN_YES,0=>LAN_NO),\n\t\t\t\t\t'itemDefault' \t=> 1\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif ($eufields)\n\t\t\t{\n\t\t\t\t$opts['delete_xfields'] = array(\n\t\t\t\t\t'label'\t\t\t=> EPL_ADLAN_80,\n\t\t\t\t\t'preview'\t\t=> $eufields,\n\t\t\t\t\t'helpText'\t\t=> EPL_ADLAN_79,\n\t\t\t\t\t'itemList'\t\t=> array(1=>LAN_YES,0=>LAN_NO),\n\t\t\t\t\t'itemDefault' \t=> 0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t$med = e107::getMedia();\n\t\t\t$icons = $med->listIcons(e_PLUGIN.$plug['plugin_path']);\n\n\t\t\t$iconText = '';\n\n\t\t\tif(count($icons)>0)\n\t\t\t{\n\t\t\t\tforeach($icons as $key=>$val)\n\t\t\t\t{\n\t\t\t\t\t$iconText .= \"<img src='\".$tp->replaceConstants($val).\"' alt='' />\";\n\t\t\t\t}\n\n\t\t\t\t$iconText = '<div class=\"icon-pool-preview\">'.$iconText.'</div>';\n\n\t\t\t\t$opts['delete_ipool'] = array(\n\t\t\t\t\t'label'\t\t\t=> EPL_ADLAN_231,\n\t\t\t\t\t'preview'\t\t=> $iconText,\n\t\t\t\t\t'helpText'\t\t=> EPL_ADLAN_79,\n\t\t\t\t\t'itemList'\t\t=> array(1=>LAN_YES,0=>LAN_NO),\n\t\t\t\t\t'itemDefault' \t=> 1\n\t\t\t\t);\n\n\n\t\t\t}\n\n\n\n\t\t\tif(is_readable(e_PLUGIN.$plug['plugin_path'].\"/\".$plug['plugin_path'].\"_setup.php\"))\n\t\t\t{\n\t\t\t\tinclude_once(e_PLUGIN.$plug['plugin_path'].\"/\".$plug['plugin_path'].\"_setup.php\");\n\n\n\t\t\t\t$mes->add(\"Loading \".e_PLUGIN.$plug['plugin_path'].\"/\".$plug['plugin_path'].\"_setup.php\", E_MESSAGE_DEBUG);\n\n\t\t\t\t$class_name = $plug['plugin_path'].\"_setup\";\n\n\t\t\t\tif(class_exists($class_name))\n\t\t\t\t{\n\t\t\t\t\t$obj = new $class_name;\n\t\t\t\t\tif(method_exists($obj,'uninstall_options'))\n\t\t\t\t\t{\n\t\t\t\t\t\t$arr = call_user_func(array($obj,'uninstall_options'), $this);\n\t\t\t\t\t\tforeach($arr as $key=>$val)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$newkey = $plug['plugin_path'].\"_\".$key;\n\t\t\t\t\t\t\t$opts[$newkey] = $val;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tforeach($opts as $key=>$val)\n\t\t\t{\n\t\t\t\t$text .= \"<tr>\\n<td class='top'>\".$tp->toHTML($val['label'],FALSE,'TITLE');\n\t\t\t\t$text .= varset($val['preview']) ? \"<div class='indent'>\".$val['preview'].\"</div>\" : \"\";\n\t\t\t\t$text .= \"</td>\\n<td>\".$frm->select($key,$val['itemList'],$val['itemDefault']);\n\t\t\t\t$text .= varset($val['helpText']) ? \"<div class='field-help'>\".$val['helpText'].\"</div>\" : \"\";\n\t\t\t\t$text .= \"</td>\\n</tr>\\n\";\n\t\t\t}\n\n\n\t\t\t$text .=\"<tr>\n\t\t\t<td>\".EPL_ADLAN_59.\"</td>\n\t\t\t<td>{$del_text}\n\t\t\t<div class='field-help'>\".EPL_ADLAN_60.\"</div>\n\t\t\t</td>\n\t\t\t</tr>\n\t\t\t</table>\n\t\t\t<div class='buttons-bar center'>\";\n\t\t\t\n\t\t\t$text .= $frm->admin_button('uninstall_confirm',EPL_ADLAN_3,'submit');\n\t\t\t$text .= $frm->admin_button('uninstall_cancel',EPL_ADLAN_62,'cancel');\n\n\n             //   $frm->admin_button($name, $value, $action = 'submit', $label = '', $options = array());\n\n\t\t\t$text .= \"</div>\n\t\t\t</fieldset>\n\t\t\t</form>\n\t\t\t\";\n\t\t//\te107::getRender()->tablerender(EPL_ADLAN_63.SEP.$tp->toHtml($plug_vars['@attributes']['name'], \"\", \"defs,emotes_off, no_make_clickable\"),$mes->render(). $text);\n\n\t\t}\n\n        function show_message($message, $type = E_MESSAGE_INFO, $session = false)\n\t\t{\n\t\t// ##### Display comfort ---------\n\t\t\t$mes = e107::getMessage();\n\t\t\t$mes->add($message, $type, $session);\n\t\t}\n\n        function pluginMenuOptions()\n\t\t{\n\t\t   //\t$e107 = &e107::getInstance();\n\n\t\t\t\t$var['installed']['text'] = EPL_ADLAN_22;\n\t\t\t\t$var['installed']['link'] = e_SELF;\n\n\t\t\t\t$var['avail']['text'] = EPL_ADLAN_23;\n\t\t\t\t$var['avail']['link'] = e_SELF.\"?avail\";\n\n\t\t\t\t\n\t\t\t\t$var['online']['text'] = EPL_ADLAN_220;\n\t\t\t\t$var['online']['link'] = e_SELF.\"?mode=online\";\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tif(E107_DEBUG_LEVEL > 0)\n\t\t\t\t{\t\n\t\t\t\t\t$var['upload']['text'] = EPL_ADLAN_38;\n\t\t\t\t\t$var['upload']['link'] = e_SELF.\"?mode=upload\";\n\t\t\t\t}\n\n\t\t\t\t$var['create']['text'] = EPL_ADLAN_114;\n\t\t\t\t$var['create']['link'] = e_SELF.\"?mode=create\";\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\n\t\t\t\t$keys = array_keys($var);\n\n\t\t\t\t$action = (in_array($this->action,$keys)) ? $this->action : \"installed\";\n\t\t\t\t\n\t\t\t\tif($this->action == 'lans')\n\t\t\t\t{\n\t\t\t\t\t$action = 'create';\n\t\t\t\t}\n\n\t\t\t\t$icon  = e107::getParser()->toIcon('e-plugmanager-24');\n\t\t\t\t$caption = $icon.\"<span>\".ADLAN_98.\"</span>\";\n\n\t\t\t\te107::getNav()->admin($caption, $action, $var);\n\t\t}\n\n\n\n\t\t\n\n} // end of Class.\n*/\n\n/*\nfunction plugin_adminmenu()\n{\n\tglobal $pman;\n\t$pman -> pluginMenuOptions();\n}*/\n\n\n\nclass pluginLanguage\n{\n\t\n\tprivate $scriptFiles \t= array();\n\tprivate $lanFiles \t\t= array(); \n\t\n\tprivate $lanDefs \t\t= array();\n\tprivate $scriptDefs \t= array(); \n\t\n\tprivate $lanDefsData \t= array();\n\tprivate $scriptDefsData = array(); \n\t\n\tprivate $unused\t\t\t= array();\n\tprivate $unsure\t\t\t= array();\n\n\tprivate $excludeLans \t= array('CORE_LC', 'CORE_LC2', 'e_LAN', 'e_LANGUAGE', 'e_LANGUAGEDIR', 'LAN', 'LANGUAGE');\n\t\n\tprivate $useSimilar\t\t= false; \n\t\n\t\n\tfunction __construct()\n\t\t{\n\t\t\n\t\t\tif(!empty($_GET['newplugin']) && $_GET['step']==2)\n\t\t\t{\n\t\t\t\t$plugin = e107::getParser()->filter($_GET['newplugin'],'file');\n\t\t\t\t$this->step2($plugin);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\t\n\t\t\n\t\t\n\t\t\t// return $this->step1();\n\t\t}\n\n\n\n\t\n\t\n\t\tfunction step2($path)\n\t\t{\n\t\t\t$this->plugin = $path; \n\t\t\t\n\t\t\t$fl = e107::getFile();\n\t\t\t\n\t\t\t$files = $fl->get_files(e_PLUGIN.$path.'/languages',null,null,3);\t\n\t\t\t$files2 = $fl->get_files(e_PLUGIN.$path,'\\.php|\\.sc|\\.bb|\\.xml','languages',3);\t\n\t\t\t\n\t\t\t$this->scanLanFile(e_LANGUAGEDIR.\"English/English.php\");\n\t\t\t$this->scanLanFile(e_LANGUAGEDIR.\"English/admin/lan_admin.php\");\t\t\n\t\t\t\n\t\t\tforeach($files as $v)\n\t\t\t{\n\t\t\t\tif(strpos($v['path'],'English')!==false OR strpos($v['fname'],'English')!==false)\n\t\t\t\t{\n\t\t\t\t\t$path = $v['path'].$v['fname'];\n\t\t\t\t\t$this->lanFiles[] = $path;\n\t\t\t\t\t\n\t\t\t\t\t$this->scanLanFile($path);\t\n\t\t\t\t}\n\t\t\t}\n\t\t\t\t\n\t\t\tforeach($files2 as $v)\n\t\t\t{\n\t\t\t\t$path = $v['path'].$v['fname'];\n\t\t\t\t$this->scriptFiles[] = \t$path;\n\t\t\t\t$this->scanScriptFile($path);\n\t\t\t}\n\t\t\t\t\n\t\t\n\t\t\t$this->renderResults(); \n\n\t\t\treturn true;\n\t\t}\n\t\t\n\t\t\n\t\tfunction findSimilar($data)\n\t\t{\n\t\t\t$sim = array(); \n\t\t\t\n\t\t\tforeach($this->lanDefsData as $k=>$v)\n\t\t\t{\n\t\t\t\tif(empty($v['value']))\n\t\t\t\t{\n\t\t\t\t\tcontinue; \t\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif($this->useSimilar == true)\n\t\t\t\t{\n\t\t\t\t\tsimilar_text($v['value'], $data['value'], $percentSimilar);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$percentSimilar = 0; \t\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif((($v['value'] == $data['value'] || $percentSimilar > 89) && $data['file'] != $v['file']))\n\t\t\t\t{\n\t\t\t\t\tif(strpos($v['lan'],'LAN')===false) // Defined constants that don't contain 'LAN'. \n\t\t\t\t\t{\n\t\t\t\t\t\t$v['status'] = 2; \n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$v['status'] = (in_array($v['lan'],$this->used)) ? 1 : 0; \t\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t$sim[] = $v; \n\t\t\t\t\n\t\t\t\t}\t\n\t\t\t}\t\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\treturn $sim; \t\n\t\t\t\n\t\t}\n\t\t\n\t\t\n\t\tfunction renderSimilar($data,$mode='')\n\t\t{\n\t\t\t\n\t\t\t$sim = $this->findSimilar($data); \n\t\t\t\n\t\t\t\n\t\t\tif(empty($sim) || ($mode == 'script' && count($sim) < 2))\n\t\t\t{\n\t\t\t\treturn; //  ADMIN_TRUE_ICON; \t\n\t\t\t}\n\t\t\t\n\t\t\t$text = \"<table class='table table-striped table-bordered'>\n\t\t\t\";\n\t\t\t\n\t\t\tforeach($sim as $k=>$val)\n\t\t\t{\n\t\t\t\t$text .= \"<tr>\n\t\t\t\t<td style='width:30%'>\".$this->shortPath($val['file']).\"</td>\n\t\t\t\t<td style='width:45%'>\".$val['lan'].\"<br /><small>\".$val['value'].\"</small></td>\n\t\t\t\t<td style='width:25%'>\".$this->renderStatus($val['status']).\"</td>\n\t\t\t\t</tr>\";\t\n\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\t$text .= \"</table>\";\n\t\t\treturn $text;\n\t\t\t\n\t\t}\n\t\t\n\t\tfunction renderFilesList($list)\n\t\t{\n\t\t\t$l= array(); \n\t\t\tforeach($list as $v)\n\t\t\t{\n\t\t\t\t$l[] = $this->shortPath($v,'script');\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t}\t\n\t\t\t\n\t\t\tif(!empty($l))\n\t\t\t{\n\t\t\t\treturn implode(\"<br />\",$l);\t\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t}\n\t\t\n\t\tfunction renderStatus($val,$mode='lan')\n\t\t{\n\t\t\t$diz = array(\n\t\t\t\t'lan'\t\t=> array(0 => 'Unused by '.$this->plugin, 1=>'Used by '.$this->plugin, 2=>'Unsure'),\n\t\t\t\t'script'\t=> array(0=> 'Missing from Language Files', 1=>'Found in Language Files', 3=>\"Generic\")\n\t\t\t);\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tif($val ==1)\n\t\t\t{\n\t\t\t\treturn \"<span class='label label-success'>\".$diz[$mode][$val].\"</span>\";\t\t\n\t\t\t}\n\t\t\t\n\t\t\tif($val == 2)\n\t\t\t{\n\t\t\t\treturn \"<span class='label label-warning'>\".$diz[$mode][$val].\"</span>\";\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\treturn \"<span class='label label-important label-danger'>\".$diz[$mode][$val].\"</span>\";\n\t\t}\n\t\t\n\t\tfunction shortPath($path,$mode='lan')\n\t\t{\n\t\t\t\n\t\t\tif($path == e_LANGUAGEDIR.'English/English.php')\n\t\t\t{\n\t\t\t\treturn \"<i>Core Frontend Language File</i>\";\t\n\t\t\t}\n\t\t\t\n\t\t\tif($path == e_LANGUAGEDIR.'English/admin/lan_admin.php')\n\t\t\t{\n\t\t\t\treturn \"<i>Core Admin-area Language File</i>\";\t\n\t\t\t}\n\t\t\t\n\t\t\tif($mode == 'script')\n\t\t\t{\n\t\t\t\treturn str_replace(e_PLUGIN.$this->plugin.'/','',$path); \t\t\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\n\t\t\t\t$text = str_replace(e_PLUGIN.$this->plugin.'/languages/','',$path); \n\t\t\t\t\n\t\t\t\tif(strpos($path,'_front.php')===false && strpos($path,'_admin.php')===false && strpos($path,'_global.php')===false && strpos($path,'_menu.php')===false && strpos($path,'_notify.php')===false && strpos($path,'_search.php')===false)\n\t\t\t\t{\n\t\t\t\t\treturn \"<span class='text-error e-tip' title='File name should be either English_front.php, English_admin.php or English_global.php'>\".$text.\"</span>\";\t\n\t\t\t\t} \n\t\t\t\t\n\t\t\t\treturn $text;\n\t\t\t\t\n\t\t\t}\n\t\t\t\t\n\t\t}\n\t\t\n\n\t\tfunction renderTable($array,$mode)\n\t\t{\n\t\t\tif(empty($array))\n\t\t\t{\n\t\t\t\treturn \"<div class='alert alert-info alert-block'>No Matches</div>\";\n\t\t\t}\n\t\t\t\n\t\t\t$text2 = '';\n\t\t\t\n\t\t\tif($mode == 'unsure')\n\t\t\t{\n\t\t\t\t$text2 .= \"<div class='alert alert-info alert-block'>LAN items in this list have been named incorrectly. They should include 'LAN' in their name. eg. LAN_\".strtoupper($this->plugin).\"_001</div>\";\t\n\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\t$text2 .= \"<table class='table table-striped  table-bordered'>\n\t\t\t<tr>\n\t\t\t<th>LAN</th>\n\t\t\t<th>File</th>\n\t\t\t<th>Value</th>\n\t\t\t<th>Duplicate or Similar Value</th>\n\t\t\t</tr>\n\t\t\t\";\n\t\t\t\n\t\t\tforeach($array as $k=>$v)\n\t\t\t{\n\t\t\t\t$text2 .= \"<tr>\n\t\t\t\t\t<td style='width:5%'>\".$v.\"</td>\n\t\t\t\t\t<td>\".$this->shortPath($this->lanDefsData[$k]['file']).\"</td>\n\t\t\t\t\t<td style='width:20%'>\".$this->lanDefsData[$k]['value'].\"</td>\n\t\t\t\t\t<td>\".$this->renderSimilar($this->lanDefsData[$k]).\"</td>\n\t\t\t\t\t</tr>\";\t\n\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t$text2 .= \"</table>\";\t\n\t\t\t\n\t\t\treturn $text2;\n\t\t}\n\n\t\tfunction renderScriptTable()\n\t\t{\n\t\t\t\n\t\t//\treturn print_a($this->scriptDefsData,true);\n\t\t\t\n\t\t\t$text2 = \"<table class='table table-striped table-bordered'>\n\t\t\t<tr>\n\t\t\t<th>id</th>\n\t\t\t<th>File</th>\n\t\t\t<th>Detected LAN</th>\n\t\t\t<th>LAN Value</th>\n\t\t\t<th class='right'>Found on Line</th>\n\t\t\t<th style='width:10%'>Status</th>\n\t\t\t<th>Duplicates / Possible Substitions</th>\n\t\t\t</tr>\n\t\t\t\";\n\t\t\t\n\t\t\tforeach($this->scriptDefsData as $k=>$v)\n\t\t\t{\n\t\t\t\t$status = in_array($v['lan'],$this->lanDefs) ? 1 : 0;\n\t\t\t//\t$lan = $v['lan'];\n\t\t\t//\t$v['value'] = $this->lanDefsRaw[$lan];\n\t\t\t//\t$sim = $this->findSimilar($v);\n\t\t\t\t\n\t\t\t\t$text2 .= \"<tr>\n\t\t\t\t\t<td style='width:5%'>\".$k.\"</td>\n\t\t\t\t\t<td>\".$this->shortPath($v['file'],'script').\"</td>\n\t\t\t\t\t<td >\".$v['lan'].\"</td>\n\t\t\t\t\t<td ><small>\".$this->lanDefsRaw[$v['lan']].\"</small></td>\n\t\t\t\t\t<td class='right'>\".$v['line'].\"</td>\n\t\t\t\t\t<td>\".$this->renderStatus($status,'script').\"</td>\n\t\t\t\t\t<td>\".$this->renderSimilar($v,'script').\"</td> \n\t\t\t\t\t</tr>\";\t\n\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t$text2 .= \"</table>\";\t\n\t\t\t\n\t\t\treturn $text2;\t\n\t\t\t\n\t\t}\n\n\t\t\n\t\tfunction renderResults()\n\t\t{\n\t\t\t$frm = e107::getForm();\n\t\t\t$ns = e107::getRender();\n\t\t\t\n\t\t\t$this->unused = array_diff($this->lanDefs,$this->scriptDefs); \n\t\t\t\t\n\t\t\t$this->used = array_intersect($this->lanDefs,$this->scriptDefs); \n\t\t\t\t\n\t\t\tforeach($this->unused as $k=>$v)\n\t\t\t{\n\t\t\t\tif(strpos($v,'LAN')===false)\n\t\t\t\t{\n\t\t\t\t\tunset($this->unused[$k]);\n\t\t\t\t\t$this->unsure[$k] = $v;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif(strpos($this->lanDefsData[$k]['file'],$this->plugin) === false || in_array($v,$this->excludeLans))\n\t\t\t\t{\n\t\t\t\t\tunset($this->unused[$k]);\n\t\t\t\t\tunset($this->unsure[$k]);\n\t\t\t\t}\n\t\t\t\t\t\n\t\t\n\t\t\t}\t\n\n//\t\t\tprint_a($this->scriptData); \n\t\t\t\n\t\t\t$used =  $this->renderTable($this->used, 'used'); \n\t\t\t$unused =  $this->renderTable($this->unused,'unused'); \n\t\t\t$unsure =  $this->renderTable($this->unsure,'unsure'); \n\t\t\t\n\t\t\t\n\t\t\t// echo $text2;\n\t\t\t$tabs = array (\n\t\t\t\t0\t=> array('caption'=>EPL_ADLAN_222, 'text'=> $this->renderScriptTable()),\n\t\t\t\t1 => array('caption'=>EPL_ADLAN_223, 'text'=>$used),\n\t\t\t\t2 => array('caption'=>EPL_ADLAN_224, 'text'=>$unused),\n\t\t\t\t3 => array('caption'=>EPL_ADLAN_225, 'text'=>$unsure),\n\t\t\t\t\n\n\t\t\t);\n\t\t\n\t\t\n\t\t\t\n\t\t\t$ns->tablerender(ADLAN_98.SEP.EPL_ADLAN_114.SEP.EPL_ADLAN_221.SEP.$this->plugin, $frm->tabs($tabs));\n\t\t\t\t\n\t\t}\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\n\t\t\n\t\t\n\t\t\n\t\tfunction scanScriptFile($path)\n\t\t{\n\t\t\t$lines = file($path, FILE_IGNORE_NEW_LINES);  \n\t\t\t\n\t\t\tforeach($lines as $ln=>$row)\n\t\t\t{\n\t\t\t\t$row = trim($row); \n\t\t\t\tif(substr($row,0,2) == '/*')\n\t\t\t\t{\n\t\t\t\t//\t$skip =true; ;\n\t\t\t\t\t\t\n\t\t\t\t}\t\n\t\t\t\tif(substr($row,0,2) == '*/')\n\t\t\t\t{\n\t\t\t\t//\t$skip =false;\n\t\t\t\t//\tcontinue; \t\n\t\t\t\t}\t\n\t\t\t\t\n\t\t\t\tif(empty($row) || $skip == true || substr($row,0,5) == '<?php' || substr($row,0,2) == '?>' || substr($row,0,2)=='//')\n\t\t\t\t{\n\t\t\t\t\tcontinue; \t\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif(preg_match_all(\"/([\\w_]*LAN[\\w_]*)/\", $row, $match))\n\t\t\t\t{\n\t\t\t\t\tforeach($match[1] as $lan)\n\t\t\t\t\t{\n\t\t\t\t\t\tif(!in_array($lan,$this->excludeLans))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$this->scriptDefs[] = $lan;\n\t\t\t\t\t\t\t$this->scriptDefsData[] = array('file'=>$path, 'line'=>$ln, 'lan'=>$lan, 'value'=>$this->lanDefsRaw[$lan]); \n\t\t\t\t\t\t//\t$this->scriptData[$path][$ln] = $row; \n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\t\n\t\t\t}\n\t\t\t\n\t\n\t\t}\t\n\t\t\t\t\t\n\t\t\t\n\t\tfunction scanLanFile($path)\n\t\t{\n\t\t\t\n\t\t\t\n\t\t\t$data = file_get_contents($path); \n\t\t\t\n\t\t\tif(preg_match_all('/(\\/\\*[\\s\\S]*?\\*\\/)/i',$data, $multiComment))\n\t\t\t{\n\t\t\t\t$data = str_replace($multiComment[1],'',$data);\t// strip multi-line comments. \t\n\t\t\t}\n\t\t\t\t\n\t\t\t\n\t\t\t$type = basename($path); \n\t\t\t\n\t\t\tif(preg_match_all('/^\\s*?define\\s*?\\(\\s*?(\\'|\\\")([\\w]+)(\\'|\\\")\\s*?,\\s*?(\\'|\\\")([\\s\\S]*?)\\s*?(\\'|\\\")\\s*?\\)\\s*?;/im',$data,$matches))\n\t\t\t{\n\t\t\t\t$def = $matches[2];\n\t\t\t\t$values = $matches[5];\t\n\t\t\n\t\t\t\tforeach($def as $k=>$d)\n\t\t\t\t{\n\t\t\t\t\tif($d == 'e_PAGETITLE' || $d == 'PAGE_NAME' || $d =='CORE_LC' && $d =='CORE_LC2')\n\t\t\t\t\t{\n\t\t\t\t\t\t\tcontinue; \n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t$retloc[$type][$d]= $values[$k];\n\t\t\t\t\t$this->lanDefs[] = $d;\n\t\t\t\t\t$this->lanDefsData[] = array('file'=>$path, 'lan'=>$d, 'value'=>$values[$k]); \n\t\t\t\t\t$this->lanDefsRaw[$d] = $values[$k];\n\t\t\t\t}\t\n\t\t\t}\n\t\t\t\n\t\t//print_a($this->lanDefsData); \n\t\t\treturn; \n\t\t}\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\n\t\n\t\n}\n\n\n\n\n\n\n\n/**\n * Plugin Admin Generator by CaMer0n. //TODO - Added dummy template and shortcode creation, plus e_search, e_cron, e_xxxxx etc. \n */\nclass pluginBuilder\n{\n\t\n\t\tvar $fields = array();\n\t\tvar $table = '';\n\t\tvar $pluginName = '';\n\t\tvar $special = array();\n\t\tvar $tableCount = 0;\n\t\tvar $tableList = array();\n\t\tvar $createFiles = false;\n\t\tprivate $buildTable = false;\n\t\tprivate $debug = false;\n\t\n\t\tfunction __construct()\n\t\t{\n\n\t\t\tif(e_DEBUG == true)\n\t\t\t{\n\t\t\t\t$this->debug = true;\n\t\t\t}\n\n\t\t\t$this->special['checkboxes'] =  array('title'=> '','type' => null, 'data' => null,\t 'width'=>'5%', 'thclass' =>'center', 'forced'=> TRUE,  'class'=>'center', 'toggle' => 'e-multiselect', 'fieldpref'=>true);\n\t\t\t$this->special['options'] = array( 'title'=> 'LAN_OPTIONS', 'type' => null, 'data' => null, 'width' => '10%',\t'thclass' => 'center last', 'class' => 'center last', 'forced'=>TRUE, 'fieldpref'=>true);\t\t\n\t\t\t\n\n\t\t}\n\n\n\t\tfunction run()\n\t\t{\n\n\t\t\tif(!empty($_GET['newplugin']))\n\t\t\t{\n\t\t\t\t$this->pluginName = e107::getParser()->filter($_GET['newplugin'],'file');\n\t\t\t}\n\n\t\t\tif(!empty($_GET['createFiles']))\n\t\t\t{\n\t\t\t\t$this->createFiles\t= true;\n\t\t\t}\n\n\t\t\tif(vartrue($_POST['step']) == 4)\n\t\t\t{\n\t\t\t\treturn $this->step4();\n\t\t\t}\n\n\t\t\tif(vartrue($_GET['step']) == 3)\n\t\t\t{\n\t\t\t\treturn $this->step3();\n\t\t\t}\n\n\n\n\n\t\t\tif(!empty($_GET['newplugin']) && $_GET['step']==2)\n\t\t\t{\n\t\t\t\treturn $this->step2();\n\t\t\t}\n\n\n\n\t\t\treturn $this->step1();\n\n\n\t\t}\n\n\n\n\t\tfunction step1()\n\t\t{\n\n\t\t\t$fl = e107::getFile();\n\t\t\t$frm = e107::getForm();\n\t\t\t$ns = e107::getRender();\n\t\t\t$mes = e107::getMessage();\n\t\t\t$tp = e107::getParser();\n\t\t\t\n\t\t\t$plugFolders = $fl->get_dirs(e_PLUGIN);\t\n\t\t\tforeach($plugFolders as $dir)\n\t\t\t{\n\t\t\t\t$lanDir[$dir] = $dir;\n\t\t\t\tif(E107_DEBUG_LEVEL == 0 && file_exists(e_PLUGIN.$dir.\"/admin_config.php\"))\n\t\t\t\t{\n\t\t\t\t\tcontinue;\t\n\t\t\t\t}\t\n\t\t\t\t$newDir[$dir] = $dir;\n\t\t\t}\n\n\t\t\t$info = EPL_ADLAN_102;\n\t\t\t$info .= \"<ul>\";\n\t\t\t$info .= \"<li>\".str_replace('[x]', e_PLUGIN, EPL_ADLAN_103).\"</li>\";\n\t\t//\t$info .= \"<li>\".EPL_ADLAN_104.\"</li>\";\n\t\t\t$info .= \"<li>\".EPL_ADLAN_105.\"</li>\";\n\t\t\t$info .= \"<li>\".EPL_ADLAN_106.\"</li>\";\n\t\t\t$info .= \"</ul>\";\n\n\t\t\t$mes->addInfo($tp->toHtml($info,true));\n\t\t\t\n\t\t\t$text = $frm->open('createPlugin','get', e_SELF);\n\t\t\t$text .= $frm->hidden('action', 'build');\n\t\t\t$text .= \"<table class='table adminform'>\n\t\t\t\t\t\t<colgroup>\n\t\t\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t\t\t<col class='col-control' />\n\t\t\t\t\t\t</colgroup>\n\t\t\t\t<tr>\n\t\t\t\t\t<td>\".EPL_ADLAN_107.\"</td>\n\t\t\t\t\t<td><div class='input-append form-inline'>\".$frm->open('createPlugin','get',e_SELF.\"?mode=create\").$frm->select(\"newplugin\",$newDir).$frm->admin_button('step', 2,'other',LAN_GO).\"</div> \".$frm->checkbox('createFiles',1,1,EPL_ADLAN_232).$frm->close().\"</td>\n\t\t\t\t</tr>\n\t\t\t\t\n\t\t\t\t<tr>\n\t\t\t\t\t<td>\".EPL_ADLAN_108.\"</td>\n\t\t\t\t\t<td><div class='input-append form-inline'>\".$frm->open('checkPluginLangs','get',e_SELF.\"?mode=lans\").$frm->select(\"newplugin\",$lanDir).$frm->admin_button('step', 2,'other',LAN_GO).\"</div> \".$frm->close().\"</td>\n\t\t\t\t</tr>\";\n\t\t\t\t\n\t\t\t\t\t\n\t\t\t/* NOT a good idea - requires the use of $_POST which would prevent browser 'go Back' navigation. \n\t\t\tif(e_DOMAIN == FALSE) // localhost. \n\t\t\t{\n\t\t\t\t$text .= \"<tr>\n\t\t\t\t\t<td>Pasted MySql Dump Here</td>\n\t\t\t\t\t<td>\".$frm->textarea('mysql','', 10,80).\"\n\t\t\t\t\t<span class='field-help'>eg. </span></td>\n\t\t\t\t\t</tr>\";\t\t\t\n\t\t\t}\n\t\t\t*/\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t$text .= \"\t\t\t\t\n\t\t\t\t</table>\n\t\t\t\t<div class='buttons-bar center'>\n\t\t\t\t\n\t\t\t\t</div>\";\n\n\t\t\t$text .= $frm->close();\n\n\t\t\treturn $text;\n\n\t\t//\t$ns->tablerender(ADLAN_98.SEP.EPL_ADLAN_114, $mes->render() . $text);\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t//\t$var['lans']['text'] = EPL_ADLAN_226;\n\t\t//\t\t$var['lans']['link'] = e_SELF.\"?mode=lans\";\n\t\t\t\n\t\t\t\n\t\t}\n\n\n\t\tfunction enterMysql()\n\t\t{\n\t\t\t\n\t\t\t$frm = e107::getForm();\n\t\t\treturn \"<div>\".$frm->textarea('mysql','', 10,80).\"</div>\";\t\n\t\t\t\n\t\t}\n\n\n\t\t/**\n\t\t * @param string $table\n\t\t * @param string $file\n\t\t */\n\t\tprivate function buildSQLFile($table, $file)\n\t\t{\n\n\t\t\t$table = e107::getParser()->filter($table);\n\n\t\t\te107::getDb()->gen(\"SHOW CREATE TABLE `#\".$table.\"`\");\n\t\t\t$data = e107::getDb()->fetch('num');\n\n\t\t\tif(!empty($data[1]))\n\t\t\t{\n\t\t\t\t$createData = str_replace(\"`\".MPREFIX, '`', $data[1]);\n\t\t\t\t$createData .= \";\";\n\t\t\t\tif(!file_exists($file))\n\t\t\t\t{\n\t\t\t\t\tfile_put_contents($file,$createData);\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\n\n\n\n\t\tfunction step3()\n\t\t{\n\t\t\t\n\t\t//\trequire_once(e_HANDLER.\"db_verify_class.php\");\n\t\t//\t$dv = new db_verify;\n\t\t\t$dv = e107::getSingleton('db_verify', e_HANDLER.\"db_verify_class.php\");\n\t\t\t\n\t\t\t$frm = e107::getForm();\n\t\t\t$ns = e107::getRender();\n\t\t\t$mes = e107::getMessage();\n\t\t\t$tp = e107::getParser();\n\n\t\t\t\n\t\t\t$newplug = $tp->filter($_GET['newplugin'],'file');\n\t\t\t$this->pluginName = $newplug;\n\n\t\t\t$sqlFile = e_PLUGIN.$newplug.\"/\".$newplug.\"_sql.php\";\n\n\t\t\tif(!empty($_GET['build']) && !file_exists($sqlFile))\n\t\t\t{\n\t\t\t\t$this->buildSQLFile($_GET['build'], $sqlFile);\n\t\t\t}\n\n\t\t\t$ret = array();\n\t\t\t\n\t\t\tif(file_exists($sqlFile))\n\t\t\t{\t\t\n\t\t\t\t$data = file_get_contents($sqlFile);\n\t\t\t\t$ret =  $dv->getSqlFileTables($data);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\te107::getDebug()->log(\"SQL File Not Found\");\n\t\t//\t\t$this->buildTable = true;\n\t\t\t}\n\t\t\n\t\t\t$text = $frm->open('newplugin-step3','post', e_SELF.'?mode=create&action=build&newplugin='.$newplug.'&createFiles='.$this->createFiles.'&step=3');\n\t\t\t\n\t\t\t$text .= \"<ul class='nav nav-tabs'>\\n\";\n\t\t\t$text .= \"<li class='active'><a data-toggle='tab' href='#xml'>\".EPL_ADLAN_109.\"</a></li>\";\n\t\t\t\n\t\t\t$this->tableCount = count($ret['tables']);\n\n\t\t\tif(!empty($ret['tables']))\n\t\t\t{\n\t\t\t\tforeach($ret['tables'] as $key=>$table)\n\t\t\t\t{\n\t\t\t\t\t$label = \"Table: \".$table;\n\t\t\t\t\t$text .= \"<li><a data-toggle='tab'  href='#\".$table.\"'>\".$label.\"</a></li>\";\n\t\t\t\t\t$this->tableList[] = $table;\n\t\t\t\t}\n\t\t\t}\n\n\n\t\t\t$text .= \"<li><a data-toggle='tab'  href='#preferences'>\".LAN_PREFS.\"</a></li>\";\n\t\t\t$text .= \"<li><a data-toggle='tab'  href='#addons'>\".LAN_ADDONS.\"</a></li>\"; //TODO LAN\n\n\t\t\t\n\t\t\t$text .= \"</ul>\";\n\t\t\t\n\t\t\t$text .= \"<div class='tab-content'>\\n\";\n\t\t\t\n\t\t\t$text .= \"<div class='tab-pane active' id='xml'>\\n\";\n\t\t\t$text .= $this->pluginXml(); \n\t\t\t$text .= \"</div>\";\n\n\t\t\tif(!empty($ret['tables']))\n\t\t\t{\n\t\t\t\tforeach($ret['tables'] as $key=>$table)\n\t\t\t\t{\n\t\t\t\t\t$text .= \"<div class='tab-pane' id='\".$table.\"'>\\n\";\n\t\t\t\t\t$fields = $dv->getFields($ret['data'][$key]);\n\t\t\t\t\t$text .= $this->form($table,$fields);\n\t\t\t\t\t$text .= \"</div>\";\n\t\t\t\t}\n\t\t\t}\n\n\n\n\n\t\t\t$text .= \"<div class='tab-pane' id='preferences'>\\n\";\n\t\t\t$text .= $this->prefs(); \n\t\t\t$text .= \"</div>\";\n\n\n\t\t\t$text .= \"<div class='tab-pane' id='addons'>\\n\";\n\t\t\t$text .= $this->addons();\n\t\t\t$text .= \"</div>\";\n\n\n\t\t\tif(empty($ret['tables']))\n\t\t\t{\n\t\t\t\t$text .= $frm->hidden($this->pluginName.'_ui[mode]','main');\n\t\t\t\t$text .= $frm->hidden($this->pluginName.'_ui[pluginName]', $this->pluginName);\n\t\t\t}\n\n\t\t\t$text .= \"</div>\";\n\t\t\t\n\t\t\t$text .= \"\n\t\t\t<div class='buttons-bar center'>\n\t\t\t\".$frm->hidden('newplugin', $this->pluginName).\"\n\t\t\t\".$frm->admin_button('step', 4,'other', LAN_GENERATE).\"\n\t\t\t</div>\";\n\t\t\t\n\t\t\t$text .= $frm->close();\n\t\t\t\n\t\t\t$mes->addInfo(EPL_ADLAN_112);\n\n\t\t\t$mes->addInfo(EPL_ADLAN_113);\n\t\t\n\t\t\treturn array('caption'=>EPL_ADLAN_115, 'text'=> $text);\n\t\t//\t$ns->tablerender(ADLAN_98.SEP.EPL_ADLAN_114.SEP., $mes->render() . $text);\n\t\t}\n\n\n\n\t\tprivate function step2()\n\t\t{\n\n\n\t\t\t$frm = e107::getForm();\n\n\t\t\t$tables = e107::getDb()->tables();\n\n\n\t\t\t$text = $frm->open('buildTab', 'get', e_REQUEST_SELF);\n\n\t\t\t$text .= \"<table class='table adminform'>\n\t\t\t\t<tr><td colspan='2'><h4>\".ucfirst(LAN_OPTIONAL).\"</h4></td></tr>\n\n\t\t\t\t<tr>\n\t\t\t\t<td class='col-label'>To generate your <em>\".$this->pluginName.\"_sql.php</em> table creation file, please select your sql table then click 'Refresh'</td>\n\t\t\t\t<td class='form-inline'>\";\n\n\t\t\t$text .= $frm->select('build', $tables, null, array('useValues'=>1), \"(\".LAN_OPTIONAL.\")\");\n\n\n\t\t//\t$text .= \"<a href='#' id='build-table-submit' class='btn btn-success'>Refresh</a>\";\n\t\t//\t$text .= $frm->button('step', 3, 'submit', \"Continue\");\n\t\t\t\tunset($_GET['step']);\n\t\t\tforeach($_GET as $k=>$v)\n\t\t\t{\n\t\t\t\t$text .= $frm->hidden($k,$v);\n\n\t\t\t}\n\t\t//\t$text .= $frm->hidden(\"build_table_url\", e_REQUEST_SELF.'?'.$qry, array('id'=>'build-table-url'));\n\n\n\t\t\t$text .= \"</td></tr>\n\t\t\t<tr><td>&nbsp;</td><td>\n\t\t\t\".$frm->button('step', 3, 'submit', LAN_CONTINUE).\"\n\t\t\t</td></tr></table>\";\n\n\t\t\t$text .=  $frm->close();\n\n/*\n\t\t\te107::js('footer-inline','\n\n\t\t\t\t  $(document).on(\"click\", \"#build-table-submit\", function(e){\n\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t$(this).addClass(\"disabled\");\n\n                    var url = $(\"#build-table-url\").val();\n                    var sel = $(\"#build-table-tbl\").val();\n\n                    url = url + \"&build=\" + sel;\n\n\t\t\t\t\twindow.location.href = url;\n\n\t\t\t\t\treturn false;\n\t\t\t\t});\n\n\n\n\n\n\t\t\t');*/\n\t\t\t$ns = e107::getRender();\n\t\t\treturn array('caption'=>EPL_ADLAN_115, 'text'=>$text);\n\t\t//\t$ns->tablerender(ADLAN_98.SEP.EPL_ADLAN_114.SEP.EPL_ADLAN_115,  $text);\n\n\n\t\t\treturn $text;\n\n\t\t}\n\n\n\n\n\n\n\n\n\t\tprivate function createAddons($list)\n\t\t{\n\n\t\t\t$srch = array('_blank','blank');\n\t\t\t$result = array();\n\n\t\t\tforeach($list as $addon)\n\t\t\t{\n\t\t\t\t$addonDest = str_replace(\"_blank\",$this->pluginName,$addon);\n\t\t\t\t$source         = e_PLUGIN.\"_blank/\".$addon.\".php\";\n\t\t\t\t$destination    = e_PLUGIN.$this->pluginName. \"/\".$addonDest.\".php\";\n\n\t\t\t\tif(file_exists($destination))\n\t\t\t\t{\n\t\t\t\t\t$result[] = \"Skipped (already exists) : \".$addonDest;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tif($content = file_get_contents($source))\n\t\t\t\t{\n\t\t\t\t\t$content = str_replace($srch, $this->pluginName, $content);\n\n\t\t\t\t\tif(!file_exists($destination))\n\t\t\t\t\t{\n\t\t\t\t\t\tif(file_put_contents($destination,$content))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$result[] = LAN_CREATED.\" : \".$addonDest;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$result[] = \"Skipped (already exists) : \".$addonDest;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t//$mes->addError(\"Addon source-file was empty: \".$addon);\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn $result;\n\t\t}\n\n\n\n\n\t\tprivate function addons()\n\t\t{\n\t\t\t$plg = e107::getPlugin();\n\n\t\t\t$list = $plg->getAddonsList();\n\t\t\t$frm = e107::getForm();\n\t\t\t$text = \"<table class='table table-striped adminlist' >\";\n\n\n\t\t//Todo LANS\n\t\t\t$dizOther = array(\n\t\t\t\t'_blank' => \"Simple frontend script\",\n\t\t\t\t'_blank_setup' => \"Create default table data during install, upgrade, uninstall etc\",\n\t\t\t\t'_blank_menu' => \"Menu item for use in the menu manager.\"\n\t\t\t);\n\n\t\t\tarray_unshift($list,'_blank', '_blank_setup', '_blank_menu');\n\n\t\t\t$templateFiles = scandir(e_PLUGIN.\"_blank\");\n\n\n\n\t//print_a($list);\n\t\t//\t$list[] = \"_blank\";\n\t\t//\t$list[] = \"_blank_setup\";\n\n\t\t\tforeach($list as $v)\n\t\t\t{\n\n\t\t\t\tif(!in_array($v.\".php\", $templateFiles))\n\t\t\t\t{\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t$diz = !empty($dizOther[$v]) ? $dizOther[$v] : $plg->getAddonsDiz($v);\n\t\t\t\t$label = str_replace(\"_blank\", $this->pluginName, $v);\n\t\t\t\t$id = str_replace('_blank', 'blank', $v);\n\n\t\t\t\t$text .= \"<tr>\";\n\t\t\t\t$text .= \"<td>\".$frm->checkbox('addons[]',$v,false,$label).\"</td>\";\n\t\t\t\t$text .= \"<td><label for='\".$frm->name2id('addons-'.$id).\"'>\".$diz.\"</label></td>\";\n\t\t\t\t$text .= \"</tr>\";\n\t\t\t}\n\n\t\t\t$text .= \"</table>\";\n\n\t\t\treturn $text;\n\n\t\t}\n\n\n\n\t\tfunction prefs()\n\t\t{\n\t\t\t$frm = e107::getForm();\n\n\t\t\t$text = '';\n\t\t\t\n\t\t\t\t$options = array(\n\t\t\t\t\t'text'\t\t=> EPL_ADLAN_116,\n\t\t\t\t\t'number'\t=> EPL_ADLAN_117,\n\t\t\t\t\t'url'\t\t=> EPL_ADLAN_118,\n\t\t\t\t\t'textarea'\t=> EPL_ADLAN_119,\n\t\t\t\t\t'bbarea'\t=> EPL_ADLAN_120,\n\t\t\t\t\t'boolean'\t=> EPL_ADLAN_121,\n\t\t\t\t\t\"method\"\t=> EPL_ADLAN_122,\n\t\t\t\t\t\"image\"\t\t=> EPL_ADLAN_123,\n\t\t\t\t\t\n\t\t\t\t\t\"dropdown\"\t=> EPL_ADLAN_124,\n\t\t\t\t\t\"userclass\"\t=> EPL_ADLAN_125,\n\t\t\t\t\t\"language\"\t=> EPL_ADLAN_126,\n\n\t\t\t\t\t\"icon\"\t\t=> EPL_ADLAN_127,\n\t\t\n\t\t\t\t\t\"file\"\t\t=> EPL_ADLAN_128,\n\t\n\t\t\t\t);\n\t\t\t\t\t\t\n\n\t\t\t$text = \"<table class='table table-striped'>\";\n\n\t\t\tfor ($i=0; $i < 10; $i++) \n\t\t\t{ \t\t\n\t\t\t\t$text .= \"<tr><td>\".\n\t\t\t\t$frm->text(\"pluginPrefs[\".$i.\"][index]\", '',40,'placeholder='.EPL_ADLAN_129).\"</td><td>\".\n\t\t\t\t$frm->text(\"pluginPrefs[\".$i.\"][value]\", '',50,'placeholder='.EPL_ADLAN_130).\"</td><td>\".\n\t\t\t\t$frm->select(\"pluginPrefs[\".$i.\"][type]\", $options, '', 'class=null', EPL_ADLAN_131).\"</td><td>\".\n\t\t\t\t$frm->text(\"pluginPrefs[\".$i.\"][help]\", '',80,'size=xxlarge&placeholder='.EPL_ADLAN_174).\"</td>\".\n\t\t\t\t\"</td></tr>\";\n\t\t\t}\n\n\t\t\t$text .= \"</table>\";\n\t\t\treturn $text;\n\t\t}\n\n\n\t\tfunction pluginXml()\n\t\t{\n\t\t\t\n\t\t\t\n\t\t\t//TODO Plugin.xml Form Fields. . \n\t\t\t\n\t\t\t$data = array(\n\t\t\t\t'main' \t\t\t=> array('name','lang','version','date', 'compatibility'),\n\t\t\t\t'author' \t\t=> array('name','url'),\n\t\t\t\t'summary' \t\t=> array('summary'),\n\t\t\t\t'description' \t=> array('description'),\n\t\t\t\t'keywords' \t\t=> array('one','two','three'),\n\t\t\t\t'category'\t\t=> array('category'),\n\t\t\t\t'copyright'\t\t=> array('copyright'),\n\t\t//\t\t'adminLinks'\t=> array('url','description','icon','iconSmall','primary'),\n\t\t//\t\t'sitelinks'\t\t=> array('url','description','icon','iconSmall')\n\t\t\t);\n\t\t\t\n\t\t\t// Load old plugin.php file if it exists; \n\t\t\t$legacyFile = e_PLUGIN.$this->pluginName.\"/plugin.php\";\t\t\n\t\t\tif(file_exists($legacyFile))\n\t\t\t{\n\t\t\t\t$eplug_name = $eplug_author = $eplug_url = $eplug_description = \"\";\n\t\t\t\t$eplug_tables = array();\n\n\t\t\t\trequire_once($legacyFile);\t\n\t\t\t\t$mes = e107::getMessage();\n\t\t\t\t$mes->addInfo(\"Loading plugin.php file\");\n\t\t\t\t\n\t\t\t\t$defaults = array(\n\t\t\t\t\t\"main-name\"\t\t\t\t\t=> $eplug_name,\n\t\t\t\t\t\"author-name\"\t\t\t\t=> $eplug_author,\n\t\t\t\t\t\"author-url\"\t\t\t\t=> $eplug_url,\n\t\t\t\t\t\"description-description\"\t=> $eplug_description,\n\t\t\t\t\t\"summary-summary\"\t\t\t=> $eplug_description\n\t\t\t\t);\n\t\t\t\t\n\t\t\t\tif(count($eplug_tables) && !file_exists(e_PLUGIN.$this->pluginName.\"/\".$this->pluginName.\"_sql.php\"))\n\t\t\t\t{\n\t\t\t\t\t\n\t\t\t\t\t$cont = '';\n\t\t\t\t\tforeach($eplug_tables as $tab)\n\t\t\t\t\t{\n\t\t\t\t\t\tif(strpos($tab,\"INSERT INTO\")!==FALSE)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcontinue;\t\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\t$cont .= \"\\n\".str_replace(\"\\t\",\" \",$tab);\t\n\t\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tif(file_put_contents(e_PLUGIN.$this->pluginName.\"/\".$this->pluginName.\"_sql.php\",$cont))\n\t\t\t\t\t{\n\t\t\t\t\t\t$info = str_replace('[x]', $this->pluginName.\"_sql.php\", EPL_ADLAN_132);\n\t\t\t\t\t\t$mes->addInfo($info,'default',true);\n\t\t\t\t\t\t$red = e107::getRedirect();\n\t\t\t\t\t\t$red->redirect(e_REQUEST_URL,true);\n\t\t\t\t\t//\t$red->redirect(e_SELF.\"?mode=create&newplugin=\".$this->pluginName.\"&createFiles=1&step=2\",true);\n\t\t\t\t\t}\n\t\t\t\t\telse \n\t\t\t\t\t{\n\t\t\t\t\t\t$msg = str_replace('[x]', $this->pluginName.\"_sql.php\", EPL_ADLAN_133).\"<br />\";\n\t\t\t\t\t\t$msg .= str_replace(array('[x]','[y]'), array($this->pluginName.\"_sql.php\",$cont), EPL_ADLAN_134);\n\t\t\t\t\t\t$mes->addWarning($msg);\t\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t$existingXml = e_PLUGIN.$this->pluginName.\"/plugin.xml\";\t\t\n\t\t\tif(file_exists($existingXml))\n\t\t\t{\n\t\t\t\t$p = e107::getXml()->loadXMLfile($existingXml,true);\t\n\t\t\t\t\n\t\t//\t\tprint_a($p);\n\t\t\t\t$defaults = array(\n\t\t\t\t\t\"main-name\"\t\t\t\t\t=> varset($p['@attributes']['name']),\n\t\t\t\t\t\"author-name\"\t\t\t\t=> varset($p['author']['@attributes']['name']),\n\t\t\t\t\t\"author-url\"\t\t\t\t=> varset($p['author']['@attributes']['url']),\n\t\t\t\t\t\"description-description\"\t=> varset($p['description']),\n\t\t\t\t\t\"summary-summary\"\t\t\t=> varset($p['summary'], $p['description']),\n\t\t\t\t\t\"category-category\"\t\t\t=> varset($p['category']),\n\t\t\t\t\t\"keywords-one\"\t\t\t\t=> varset($p['keywords']['word'][0]),\n\t\t\t\t\t\"keywords-two\"\t\t\t\t=> varset($p['keywords']['word'][1]),\n\t\t\t\t\t\"keywords-three\"\t\t\t=> varset($p['keywords']['word'][2]),\n\t\t\t\t);\n\t\t\t\t\n\t\t\t\tunset($p);\n\t\t\n\t\t\t}\n\t\t\t\n\t\t\t$text = \"<table class='table adminform'>\";\n\t\t\t\t\t\n\t\t\tforeach($data as $key=>$val)\n\t\t\t{\n\t\t\t\t$text.= \"<tr><td>$key</td><td>\n\t\t\t\t<div class='controls'>\";\n\t\t\t\tforeach($val as $type)\n\t\t\t\t{\n\t\t\t\t\t$nm = $key.'-'.$type;\n\t\t\t\t\t$name = \"xml[$nm]\";\t\n\t\t\t\t\t$size = (count($val)==1) ? 'span7 col-md-7' : 'span2 col-md-2';\n\t\t\t\t\t$text .= \"<div class='{$size}'>\".$this->xmlInput($name, $key.\"-\". $type, vartrue($defaults[$nm])).\"</div>\";\t\n\t\t\t\t}\t\n\t\t\t\n\t\t\t\t$text .= \"</div></td></tr>\";\n\t\t\t\t\n\t\t\t\t\n\t\t\t}\n\t\t\t$text .= \"</table>\";\n\t\t\t\n\t\t\treturn $text;\t\t\t\t\n\t\t}\n\t\t\n\t\t\n\t\tfunction xmlInput($name, $info, $default='')\n\t\t{\n\t\t\t$frm = e107::getForm();\t\n\t\t\tlist($cat,$type) = explode(\"-\",$info);\n\t\t\t\n\t\t\t$size \t\t= 30;\n\t\t\t$help\t\t= '';\n\t\t\t$pattern\t= \"\";\n\t\t\t$required\t= false;\n\t\t\t\n\t\t\tswitch ($info)\n\t\t\t{\n\t\t\t\t\n\t\t\t\tcase 'main-name':\n\t\t\t\t\t$help \t\t= EPL_ADLAN_135;\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$pattern \t= \"[A-Za-z0-9 -]*\";\n\t\t\t\t\t$xsize\t\t= 'medium';\n\t\t\t\tbreak;\n\t\t\n\t\t\t\tcase 'main-lang':\n\t\t\t\t\t$help \t\t= EPL_ADLAN_136;\n\t\t\t\t\t$required \t= false;\n\t\t\t\t\t$placeholder= \" \";\n\t\t\t\t\t$pattern \t= \"[A-Z0-9_]*\";\n\t\t\t\t\t$xsize\t\t= 'medium';\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'main-date':\n\t\t\t\t\t$help \t\t= EPL_ADLAN_137;\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$xsize\t\t= 'medium';\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'main-version':\n\t\t\t\t\t$default \t= '1.0';\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$help \t\t= EPL_ADLAN_138;\n\t\t\t\t\t$pattern\t= \"^[\\d]{1,2}\\.[\\d]{1,2}(\\.[\\d]{1,2})?$\";\n\t\t\t\t\t$xsize\t\t= 'small';\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'main-compatibility':\n\t\t\t\t\t$default \t= '2.0';\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$help \t\t= EPL_ADLAN_139;\n\t\t\t\t\t$pattern\t= \"^[\\d]{1,2}\\.[\\d]{1,2}$\";\n\t\t\t\t\t$xsize\t\t= 'small';\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'author-name':\n\t\t\t\t\t$default \t= (vartrue($default)) ? $default : USERNAME;\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$help \t\t= EPL_ADLAN_140;\n\t\t\t\t\t$pattern\t= \"[A-Za-z \\.0-9]*\";\n\t\t\t\t\t$xsize\t\t= 'medium';\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'author-url':\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$help \t\t= EPL_ADLAN_141;\n\t\t\t\t//\t$pattern\t= \"https?://.+\";\n\t\t\t\t\t$xsize\t\t= 'medium';\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\t//case 'main-installRequired':\n\t\t\t\t//\treturn \"Installation required: \".$frm->radio_switch($name,'',LAN_YES, LAN_NO);\n\t\t\t\t//break;\t\n\t\t\t\t\n\t\t\t\tcase 'summary-summary':\n\t\t\t\t\t$help \t\t= EPL_ADLAN_142.\"<br />\".EPL_ADLAN_143;\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$size \t\t= 130;\n\t\t\t\t\t$placeholder= \" \";\n\t\t\t\t\t$pattern\t= \"[A-Za-z -\\.0-9]*\";\n\t\t\t\t\t$xsize\t\t= 'block-level';\n\t\t\t\tbreak;\t\n\n\t\t\t\tcase 'keywords-one':\n\t\t\t\t\t$type = 'keywordDropDown';\n\t\t\t\t\t$required = true;\n\t\t\t\t\t$help \t\t= EPL_ADLAN_144;\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'keywords-three':\n\t\t\t\tcase 'keywords-two':\n\t\t\t\t\t$help \t\t= EPL_ADLAN_144.\"<br />\".EPL_ADLAN_143;\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$size \t\t= 20;\n\t\t\t\t\t$placeholder= \" \";\n\t\t\t\t\t$pattern \t= '^[a-z]*$';\n\t\t\t\t\t$xsize\t\t= 'medium';\n\t\t\t\tbreak;\t\n\t\t\t\t\n\t\t\t\tcase 'description-description':\n\t\t\t\t\t$help \t\t= EPL_ADLAN_145.\"<br />\".EPL_ADLAN_143;\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$size \t\t= 100;\n\t\t\t\t\t$placeholder = \" \";\n\t\t\t\t\t$pattern\t= \"[A-Za-z -\\.0-9]*\";\n\t\t\t\t\t$xsize\t\t= 'block-level';\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\t\t\n\t\t\t\tcase 'category-category':\n\t\t\t\t\t$help \t\t= EPL_ADLAN_146;\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$size \t\t= 20;\n\t\t\t\tbreak;\n\t\t\t\t\t\t\n\t\t\t\tdefault:\n\t\t\t\t\t\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t$req = ($required == true) ? \"&required=1\" : \"\";\t\n\t\t\t$placeholder = (varset($placeholder)) ? $placeholder : $type;\n\t\t\t$pat = ($pattern) ? \"&pattern=\".$pattern : \"\";\n\t\t\t$sz = ($xsize) ? \"&size=\".$xsize : \"\";\n\t\t\t\n\t\t\tswitch ($type) \n\t\t\t{\n\t\t\t\tcase 'date':\n\t\t\t\t\t$text = $frm->datepicker($name, time(), 'format=yyyy-mm-dd&return=string'.$req . $sz);\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'description':\n\t\t\t\t\t$text = $frm->textarea($name,$default, 3, 100, $req.$sz);\t// pattern not supported. \t\n\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\tcase 'category':\n\t\t\t\t\t$options = array(\n\t\t\t\t\t'settings'\t=> EPL_ADLAN_147,\n\t\t\t\t\t'users'\t\t=> EPL_ADLAN_148,\n\t\t\t\t\t'content'\t=> EPL_ADLAN_149,\n\t\t\t\t\t'tools'\t\t=> EPL_ADLAN_150,\n\t\t\t\t\t'manage'\t=> EPL_ADLAN_151,\n\t\t\t\t\t'misc'\t\t=> EPL_ADLAN_152,\n\t\t\t\t\t'menu'\t\t=> EPL_ADLAN_153,\n\t\t\t\t\t'about'\t\t=> EPL_ADLAN_154\n\t\t\t\t\t);\n\t\t\t\t\n\t\t\t\t\t$text = $frm->select($name, $options, $default,'required=1&class=form-control', true);\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'keywordDropDown':\n\n\t\t\t\t\t$options = array(\n\n\t\t\t\t\t\t'generic',\n\t\t\t\t\t\t'admin',\n\t\t\t\t\t    'messaging',\n\t\t\t\t\t    'enhancement',\n\t\t\t\t\t    'date',\n\t\t\t\t\t    'commerce',\n\t\t\t\t\t    'form',\n\t\t\t\t\t    'gaming',\n\t\t\t\t\t    'intranet',\n\t\t\t\t\t    'multimedia',\n\t\t\t\t\t    'information',\n\t\t\t\t\t    'mail',\n\t\t\t\t\t    'search',\n\t\t\t\t\t\t'stats',\n\t\t\t\t\t\t'files',\n\t\t\t\t\t\t'security',\n\t\t\t\t\t\t'generic',\n\t\t\t\t\t\t'language'\n\t\t\t\t\t);\n\n\t\t\t\t\tsort($options);\n\n\t\t\t\t\t$text = $frm->select($name, $options, $default,'required=1&class=form-control&useValues=1', true);\n\n\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tdefault:\n\t\t\t\t\t$text = $frm->text($name, $default, $size, 'placeholder='.$placeholder . $sz. $req. $pat);\t\n\t\t\t\tbreak;\n\t\t\t}\n\t\n\t\t\t\n\t\t\t$text .= ($help) ? \"<span class='field-help'>\".$help.\"</span>\" : \"\";\n\t\t\treturn $text;\n\t\t\t\n\t\t}\n\n\t\tfunction createXml($data)\n\t\t{\n\t\t//\tprint_a($_POST);\n\t\t\t$ns = e107::getRender();\n\t\t\t$mes = e107::getMessage();\n\t\t\t$tp = e107::getParser();\n\t\t\t\n\t\t\tforeach($data as $key=>$val)\n\t\t\t{\n\t\t\t\t$key = strtoupper(str_replace(\"-\",\"_\",$key));\n\t\t\t\t$newArray[$key] = $val;\t\n\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\t$newArray['DESCRIPTION_DESCRIPTION'] = strip_tags($tp->toHTML($newArray['DESCRIPTION_DESCRIPTION'],true));\n\n\t\t\t$_POST['pluginPrefs'] = $tp->filter($_POST['pluginPrefs']);\n\n\t\t\tforeach($_POST['pluginPrefs'] as $val)\n\t\t\t{\n\t\t\t\tif(vartrue($val['index']))\n\t\t\t\t{\n\t\t\t\t\t$id = $val['index'];\n\t\t\t\t\t$plugPref[$id] = $val['value'];\t\t\n\t\t\t\t}\t\n\t\t\t}\n\t\t\t\n\t\t//\tprint_a($_POST['pluginPrefs']);\n\t\t\t\n\t\t\tif(count($plugPref))\n\t\t\t{\n\t\t\t\t$xmlPref = \"<pluginPrefs>\\n\";\n\t\t\t\tforeach($plugPref as $k=>$v)\n\t\t\t\t{\n\t\t\t\t\t$xmlPref .= \"\t\t<pref name='\".$k.\"'>\".$v.\"</pref>\\n\";\t\n\t\t\t\t}\t\n\t\t\t\t\n\t\t\t\t$xmlPref .= \"\t</pluginPrefs>\";\n\t\t\t\t$newArray['PLUGINPREFS'] = $xmlPref;\n\t\t\t}\n\t\t\t\n\t\t\t//\tprint_a($newArray);\n\t\t\t// print_a($this);\n\t\t\t\n$template = <<<TEMPLATE\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<e107Plugin name=\"{MAIN_NAME}\" lan=\"{MAIN_LANG}\" version=\"{MAIN_VERSION}\" date=\"{MAIN_DATE}\" compatibility=\"{MAIN_COMPATIBILITY}\" installRequired=\"true\" >\n\t<author name=\"{AUTHOR_NAME}\" url=\"{AUTHOR_URL}\" />\n\t<summary lan=\"\">{SUMMARY_SUMMARY}</summary>\n\t<description lan=\"\">{DESCRIPTION_DESCRIPTION}</description>\n\t<keywords>\n\t\t<word>{KEYWORDS_ONE}</word>\n\t\t<word>{KEYWORDS_TWO}</word>\n\t\t<word>{KEYWORDS_THREE}</word>\n\t</keywords>\n\t<category>{CATEGORY_CATEGORY}</category>\n\t<copyright>{COPYRIGHT_COPYRIGHT}</copyright>\n\t<adminLinks>\n\t\t<link url=\"admin_config.php\" description=\"{ADMINLINKS_DESCRIPTION}\" icon=\"\" iconSmall=\"\" icon128=\"\" primary=\"true\" >LAN_CONFIGURE</link>\n\t</adminLinks>\n\t{PLUGINPREFS}\n</e107Plugin>\nTEMPLATE;\n\n\n// pluginPrefs\n\n\n\n\n// TODO\n/*\n\t<siteLinks>\n\t\t<link url=\"{e_PLUGIN}_blank/_blank.php\" perm=\"everyone\">Blank</link>\t\t\n\t</siteLinks>\n\t<pluginPrefs>\n\t\t<pref name=\"blank_pref_1\">1</pref>\n\t\t<pref name=\"blank_pref_2\">[more...]</pref>\n\t</pluginPrefs>\n\t<userClasses>\n\t\t<class name=\"blank_userclass\" description=\"Blank Userclass Description\" />\t\t\n\t</userClasses>\n\t<extendedFields>\n\t\t<field name=\"custom\" type=\"EUF_TEXTAREA\" default=\"0\" active=\"true\" />\n\t</extendedFields>\t\n*/\n\n\n\t\t\t$result = e107::getParser()->simpleParse($template, $newArray);\n\t\t\t$path = e_PLUGIN.$this->pluginName.\"/plugin.xml\";\n\t\t\t\n\t\t\t\n\t\t\tif($this->createFiles == true)\n\t\t\t{\n\t\t\t\tif(file_put_contents($path,$result) )\n\t\t\t\t{\n\t\t\t\t\t$mes->addSuccess(EPL_ADLAN_155.\" \".$path);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$mes->addError(EPL_ADLAN_156.\" \".$path);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn  htmlentities($result);\n\t\t\t\n\t\t//\t$ns->tablerender(LAN_CREATED.\": plugin.xml\", \"<pre  style='font-size:80%'>\".htmlentities($result).\"</pre>\");\t\n\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\n\n\n\t\tfunction form($table,$fieldArray)\n\t\t{\n\t\t\t$frm = e107::getForm();\n\t\t\t\t\t\n\t\t\t$modes = array(\n\t\t\t\t\"main\"=>EPL_ADLAN_157,\n\t\t\t\t\"cat\"=>EPL_ADLAN_158,\n\t\t\t\t\"other1\"=>EPL_ADLAN_159,\n\t\t\t\t\"other2\"=>EPL_ADLAN_160,\n\t\t\t\t\"other3\"=>EPL_ADLAN_161,\n\t\t\t\t\"other4\"=>EPL_ADLAN_162,\n\t\t\t\t'exclude'=>EPL_ADLAN_163,\n\t\t\t);\n\t\t\t\n\t\t//\techo \"TABLE COUNT= \".$this->tableCount ;\n\t\t\t\n\t\t\t\n\t\t\t$this->table = $table.\"_ui\";\n\t\t\t\n\t\t\t$c=0;\n\t\t\tforeach($modes as $id=>$md)\n\t\t\t{\n\t\t\t\t$tbl = $this->tableList[$c];\n\t\t\t\t$defaultMode[$tbl] = $id;\t\n\t\t\t\t$c++;\n\t\t\t}\n\t\t\t\n\t\t//\tprint_a($defaultMode);\n\t\t\t\t\n\t\t\t$text = \t$frm->hidden($this->table.'[pluginName]', $this->pluginName, 15).\n\t\t\t\t\t\t$frm->hidden($this->table.'[table]', $table, 15);\n\t\t\t\t\n\t\t\tif($this->tableCount > 1)\n\t\t\t{\n\t\t\t\t$text .= \"<table class='table adminform'>\\n\";\n\t\t\t\t$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>Mode</td>\n\t\t\t\t\t\t<td>\".$frm->select($this->table.\"[mode]\",$modes, $defaultMode[$table], 'required=1&class=null', true).\"</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$text .= $frm->hidden($this->table.'[mode]','main');\n\t\t\t}\n\n\t\t\t$text .= \"</table>\".$this->special('checkboxes');\n\t\t\t\n\t\t\t$text .= \"<table class='table adminlist'>\n\t\t\t\t\t\t<thead>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<th>\".EPL_ADLAN_164.\"</th>\n\t\t\t\t\t\t\t<th>\".EPL_ADLAN_165.\"</th>\n\t\t\t\t\t\t\t<th>\".EPL_ADLAN_166.\"</th>\n\t\t\t\t\t\t\t<th>\".EPL_ADLAN_167.\"</th>\n\t\t\t\t\t\t\t<th>\".EPL_ADLAN_168.\"</th>\n\t\t\t\t\t\t\t<th class='center'>\".EPL_ADLAN_169.\"</th>\n\t\t\t\t\t\t\t<th class='center'>\".EPL_ADLAN_170.\"</th>\n\t\t\t\t\t\t\t<th class='center'>\".EPL_ADLAN_171.\"</th>\n\t\t\t\t\t\t\t<th class='center e-tip' title='\".EPL_ADLAN_177.\"'>\".EPL_ADLAN_172.\"</th>\n\t\t\t\t\t\t\t<th class='center e-tip' title='\".EPL_ADLAN_178.\"'>\".EPL_ADLAN_173.\"</th>\n\t\t\t\t\t\t\t<th>\".EPL_ADLAN_174.\"</th>\n\t\t\t\t\t\t\t<th>\".EPL_ADLAN_175.\"</th>\n\t\t\t\t\t\t\t<th>\".EPL_ADLAN_176.\"</th>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t</thead>\n\t\t\t\t\t\t<tbody>\n\t\t\t\t\t\t\";\n\t\t\t\t\t\t\n\t\t\tforeach($fieldArray as $name=>$val)\n\t\t\t{\n\t\t\t\tlist($tmp,$nameDef) = explode(\"_\",$name,2);\n\t\t\t\t// 'faq_question', 'faq_answer', 'faq_parent', 'faq_datestamp'\n\t\t\t\t$text .= \"<tr>\n\t\t\t\t\t<td>\".$name.\"</td>\n\t\t\t\t\t<td>\".$frm->text($this->table.\"[fields][\".$name.\"][title]\", $this->guess($name, $val,'title'),35, 'required=1').\"</td>\n\t\t\t\t\t<td>\".$this->fieldType($name, $val).\"</td>\n\t\t\t\t\t<td>\".$this->fieldData($name, $val).\"</td>\n\t\t\t\t\t<td>\".$frm->text($this->table.\"[fields][\".$name.\"][width]\", $this->guess($name, $val,'width'), 4, 'size=mini').\"</td>\n\t\t\t\t\t<td class='center'>\".$frm->checkbox($this->table.\"[fields][\".$name.\"][batch]\", true, $this->guess($name, $val,'batch')).\"</td>\n\t\t\t\t\t<td class='center'>\".$frm->checkbox($this->table.\"[fields][\".$name.\"][filter]\", true, $this->guess($name, $val,'filter')).\"</td>\n\t\t\t\t\t<td class='center'>\".$frm->checkbox($this->table.\"[fields][\".$name.\"][inline]\", true, $this->guess($name, $val,'inline')).\"</td>\n\t\t\t\t\t<td class='center'>\".$frm->checkbox($this->table.\"[fields][\".$name.\"][validate]\", true).\"</td>\n\t\t\t\t\t<td class='center'>\".$frm->checkbox($this->table.\"[fields][\".$name.\"][fieldpref]\", true, $this->guess($name, $val,'fieldpref')).\"</td>\n\t\t\t\t\t<td>\".$frm->text($this->table.\"[fields][\".$name.\"][help]\",'', 50,'size=medium').\"</td>\n\t\t\t\t\t<td>\".$frm->text($this->table.\"[fields][\".$name.\"][readParms]\",'', 60,'size=small').\"</td>\n\t\t\t\t\t<td>\".$frm->text($this->table.\"[fields][\".$name.\"][writeParms]\",'', 60,'size=small').\n\t\t\t\t\t$frm->hidden($this->table.\"[fields][\".$name.\"][class]\", $this->guess($name, $val,'class')).\n\t\t\t\t\t$frm->hidden($this->table.\"[fields][\".$name.\"][thclass]\", $this->guess($name, $val,'thclass')).\n\t\t\t\t\t\"</td>\n\t\t\t\t\t</tr>\";\n\t\t\t\n\t\t\t}\n\t\t\t//'width' => '20%',\t'thclass' => 'center',\t'batch' => TRUE, 'filter'=>TRUE, 'parms' => 'truncate=30', 'validate' => false, 'help' => 'Enter blank URL here', 'error' => 'please, ener valid URL'),\t\t\n\t\t\t$text .= \"</tbody></table>\".$this->special('options');\t\n\t\t\t\n\t\t\t\n\t\t\treturn $text;\n\t\t\t\n\t\t}\n\t\t\n\t\t// Checkboxes and Options. \n\t\tfunction special($name)\n\t\t{\n\t\t\t$frm = e107::getForm();\n\t\t\t$text = \"\";\n\t\t\t\n\t\t\tforeach($this->special[$name] as $key=>$val)\n\t\t\t{\n\t\t\t\t$text .= $frm->hidden($this->table.\"[fields][\".$name.\"][\".$key.\"]\", $val);\t\t\t\t\t\n\t\t\t}\n\n\t\t\treturn $text;\n\t\t\t\n\t\t}\n\n\n\t\t/**\n\t\t * @param $name\n\t\t * @param $val\n\t\t * @return string\n\t\t */\n\t\tfunction fieldType($name, $val)\n\t\t{\n\t\t\t$type = strtolower($val['type']);\n\t\t\t$frm = e107::getForm();\n\t\t\t\n\t\t\tif(strtolower($val['default']) == \"auto_increment\")\n\t\t\t{\n\t\t\t\t$key = $this->table.\"[pid]\";\n\t\t\t\treturn \"Primary Id\".$frm->hidden($key, $name );\t// \n\t\t\t}\n\t\t\t\n\t\t\tswitch ($type) \n\t\t\t{\n\t\t\t\tcase 'date':\n\t\t\t\tcase 'datetime':\n\t\t\t\tcase 'time':\n\t\t\t\tcase 'timestamp':\n\t\t\t\t\t$array = array(\n\t\t\t\t\t'text'\t\t=> EPL_ADLAN_179,\n\t\t\t\t\t\"hidden\"\t=> EPL_ADLAN_180,\n\t\t\t\t\t\"method\"\t=> EPL_ADLAN_186,\n\t\t\t\t\t);\n\t\t\t\tbreak;\n\t\t\t\n\t\t\t\tcase 'int':\n\t\t\t\tcase 'tinyint':\n\t\t\t\tcase 'bigint':\n\t\t\t\tcase 'smallint':\n\t\t\t\tcase 'mediumint':\n\t\t\t\t\t$array = array(\n\t\t\t\t\t\"boolean\"\t=> EPL_ADLAN_181,\n\t\t\t\t\t\"number\"\t=> EPL_ADLAN_182,\n\t\t\t\t\t\"dropdown\"\t=> EPL_ADLAN_183,\n\t\t\t\t\t\"userclass\"\t=> EPL_ADLAN_184,\n\t\t\t\t\t\"datestamp\"\t=> LAN_DATE,\n\t\t\t\t\t\"method\"\t=> EPL_ADLAN_186,\n\t\t\t\t\t\"hidden\"\t=> EPL_ADLAN_187,\n\t\t\t\t\t\"user\"\t\t=> EPL_ADLAN_188,\n\t\t\t\t\t);\t\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'decimal':\n\t\t\t\tcase 'double':\n\t\t\t\tcase 'float':\n\t\t\t\t\t$array = array(\n\t\t\t\t\t\"number\"\t=> EPL_ADLAN_189,\n\t\t\t\t\t\"dropdown\"\t=> EPL_ADLAN_190,\n\t\t\t\t\t\"method\"\t=> EPL_ADLAN_191,\n\t\t\t\t\t\"hidden\"\t=> EPL_ADLAN_192,\n\t\t\t\t\t);\t\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'varchar':\n\t\t\t\tcase 'tinytext':\n\t\t\t\tcase 'tinyblob':\n\t\t\t\t$array = array(\n\t\t\t\t\t'text'\t\t=> EPL_ADLAN_193,\n\t\t\t\t\t\"url\"\t\t=> EPL_ADLAN_194,\n\t\t\t\t\t\"email\"\t\t=> EPL_ADLAN_195,\n\t\t\t\t\t\"ip\"\t\t=> EPL_ADLAN_196,\n\t\t\t\t\t\"number\"\t=> EPL_ADLAN_197,\n\t\t\t\t\t\"password\"\t=> EPL_ADLAN_198,\n\t\t\t\t\t\"tags\"\t\t=> EPL_ADLAN_199,\n\t\t\t\t\t\n\t\t\t\t\t\"dropdown\"\t=> EPL_ADLAN_200,\n\t\t\t\t\t\"userclass\"\t=> EPL_ADLAN_201,\n\t\t\t\t\t\"language\"\t=> EPL_ADLAN_202,\n\n\t\t\t\t\t\"icon\"\t\t=> EPL_ADLAN_203,\n\t\t\t\t\t\"image\"\t\t=> EPL_ADLAN_204,\n\t\t\t\t\t\"file\"\t\t=> EPL_ADLAN_205,\n\t\t\t\t\t\"method\"\t=> EPL_ADLAN_206,\n\n\t\t\t\t\t\"hidden\"\t=> EPL_ADLAN_207\n\t\t\t\t\t);\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'enum':\n\t\t\t\t$array = array(\n\t\t\t\t\t\"dropdown\"\t=> EPL_ADLAN_200,\n\t\t\t\t\t\"tags\"\t\t=> EPL_ADLAN_211,\n\t\t\t\t\t\"method\"\t=> EPL_ADLAN_212,\n\t\t\t\t\t\"hidden\"\t=> EPL_ADLAN_215\n\t\t\t\t\t);\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'text':\n\t\t\t\tcase 'mediumtext':\n\t\t\t\tcase 'longtext':\n\t\t\t\tcase 'blob':\n\t\t\t\tcase 'mediumblob':\n\t\t\t\tcase 'longblob':\n\t\t\t\t$array = array(\n\t\t\t\t\t'textarea'\t=> EPL_ADLAN_208,\n\t\t\t\t\t'bbarea'\t=> EPL_ADLAN_209,\n\t\t\t\t\t'text'\t\t=> EPL_ADLAN_210,\n\t\t\t\t\t\"tags\"\t\t=> EPL_ADLAN_211,\n\t\t\t\t\t\"method\"\t=> EPL_ADLAN_212,\n\t\t\t\t\t\"image\"\t\t=> EPL_ADLAN_213,\n\t\t\t\t\t\"images\"\t=> EPL_ADLAN_214,\n\t\t\t\t\t\"hidden\"\t=> EPL_ADLAN_215\n\t\t\t\t\t);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\t\n\t\t//\tasort($array);\n\t\t\t\n\t\t\t$fname = $this->table.\"[fields][\".$name.\"][type]\";\n\t\t\treturn $frm->select($fname, $array, $this->guess($name, $val),'required=1&class=null', true);\n\t\t\t\n\t\t}\n\n\t\t// Guess Default Field Type based on name of field. \n\t\tfunction guess($data, $val='',$mode = 'type')\n\t\t{\n\t\t\t$tmp = explode(\"_\",$data);\t\n\t\t\t\n\t\t\tif(count($tmp) == 3) // eg Link_page_title\n\t\t\t{\n\t\t\t\t$name = $tmp[2];\t\n\t\t\t}\n\t\t\telseif(count($tmp) == 2) // Link_description\n\t\t\t{\n\t\t\t\t$name = $tmp[1];\t\t\n\t\t\t}\n\t\t\telseif(count($tmp) === 1)\n\t\t\t{\n\t\t\t\t$name = $data;\t\n\t\t\t}\n\t\n\t\t\t$ret['title'] = ucfirst($name);\n\t\t\t$ret['width'] = 'auto';\n\t\t\t$ret['class'] = 'left';\n\t\t\t$ret['thclass'] = 'left';\n\t\t\t\n\t\t//\techo \"<br />name=\".$name; \n\t\t\tswitch ($name) \n\t\t\t{\n\t\t\t\t\n\t\t\t\tcase 'id':\n\t\t\t\t\t$ret['title'] = 'LAN_ID';\n\t\t\t\t\t$ret['type'] = 'boolean';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\t\t$ret['width'] = '5%';\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'start':\n\t\t\t\tcase 'end':\n\t\t\t\tcase 'datestamp':\n\t\t\t\tcase 'date':\n\t\t\t\t\t$ret['title'] = 'LAN_DATESTAMP';\n\t\t\t\t\t$ret['type'] = 'datestamp';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = true;\n\t\t\t\t\t$ret['fieldpref'] = true;\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'prename':\n\t\t\t\tcase 'firstname':\n\t\t\t\tcase 'lastname':\n\t\t\t\tcase 'company':\n\t\t\t\tcase 'city':\n\t\t\t\t\t$ret['title'] = ucfirst($name);\n\t\t\t\t\t$ret['type'] = 'text';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['fieldpref'] = true;\n\t\t\t\t\t$ret['inline'] = true;\n\t\t\t\tbreak;\n\n\t\t\t\t\n\t\t\t\tcase 'name':\n\t\t\t\tcase 'title':\n\t\t\t\tcase 'subject':\n\t\t\t\tcase 'summary':\n\t\t\t\t\t$ret['title'] = 'LAN_TITLE';\n\t\t\t\t\t$ret['type'] = 'text';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['fieldpref'] = true;\n\t\t\t\t\t$ret['inline'] = true;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'email':\n\t\t\t\tcase 'email2':\n\t\t\t\t\t$ret['title'] = 'LAN_EMAIL';\n\t\t\t\t\t$ret['type'] = 'email';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['fieldpref'] = false;\n\t\t\t\t\t$ret['inline'] = true;\n\t\t\t\tbreak;\n\n\t\t\t\t\n\t\t\t\tcase 'ip':\n\t\t\t\t\t$ret['title'] = 'LAN_IP';\n\t\t\t\t\t$ret['type'] = 'ip';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['fieldpref'] = false;\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'user':\t\n\t\t\t\tcase 'userid':\t\t\t\t\n\t\t\t\tcase 'author':\n\t\t\t\t\t$ret['title'] = 'LAN_AUTHOR';\n\t\t\t\t\t$ret['type'] = 'user';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'thumb':\n\t\t\t\tcase 'thumbnail':\n\t\t\t\tcase 'image':\n\t\t\t\t\t$ret['title'] = 'LAN_IMAGE';\n\t\t\t\t\t$ret['type'] = 'image';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'total':\n\t\t\t\tcase 'order':\n\t\t\t\tcase 'limit':\n\t\t\t\t\t$ret['title'] = 'LAN_ORDER';\n\t\t\t\t\t$ret['type'] = 'number';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'code':\n\t\t\t\tcase 'zip':\n\t\t\t\t\t$ret['title'] = ucfirst($name);\n\t\t\t\t\t$ret['type'] = 'number';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['inline'] = true;\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'state':\n\t\t\t\tcase 'country':\n\t\t\t\tcase 'category':\n\t\t\t\t\t$ret['title'] = ($name == 'category') ? 'LAN_CATEGORY' : ucfirst($name);\n\t\t\t\t\t$ret['type'] = 'dropdown';\n\t\t\t\t\t$ret['batch'] = true;\n\t\t\t\t\t$ret['filter'] = true;\n\t\t\t\t\t$ret['fieldpref'] = true;\n\t\t\t\t\t$ret['inline'] = true;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'type':\n\t\t\t\t\t$ret['title'] = 'LAN_TYPE';\n\t\t\t\t\t$ret['type'] = 'dropdown';\n\t\t\t\t\t$ret['batch'] = true;\n\t\t\t\t\t$ret['filter'] = true;\n\t\t\t\t\t$ret['fieldpref'] = true;\n\t\t\t\t\t$ret['inline'] = true;\n\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\n\t\t\t\tcase 'icon':\n\t\t\t\tcase 'button':\n\t\t\t\t\t$ret['title'] = 'LAN_ICON';\n\t\t\t\t\t$ret['type'] = 'icon';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'website':\n\t\t\t\tcase 'url':\n\t\t\t\tcase 'homepage':\n\t\t\t\t\t$ret['title'] = 'LAN_URL';\n\t\t\t\t\t$ret['type'] = 'url';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['inline'] = true;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'visibility':\n\t\t\t\tcase 'class':\n\t\t\t\t\t$ret['title'] = 'LAN_USERCLASS';\n\t\t\t\t\t $ret['type'] = 'userclass';\n\t\t\t\t\t $ret['batch'] = true;\n\t\t\t\t\t $ret['filter'] = true;\n\t\t\t\t\t $ret['fieldpref'] = true;\n\t\t\t\t\t$ret['inline'] = true;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'notes':\n\t\t\t\tcase 'comment':\n\t\t\t\tcase 'comments':\n\t\t\t\tcase 'address':\n\t\t\t\tcase 'description':\n\t\t\t\t\t$ret['title'] = ($name == 'description') ? 'LAN_DESCRIPTION' : ucfirst($name);\n\t\t\t\t\t $ret['type'] = ($val['type'] == 'TEXT') ? 'textarea' : 'text';\n\t\t\t\t\t $ret['width'] = '40%';\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tdefault:\n\t\t\t\t\t$ret['type'] = 'boolean';\n\t\t\t\t\t$ret['class'] = 'left';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['thclass'] = 'left';\n\t\t\t\t\t$ret['width'] = 'auto';\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\t\n\t\t\treturn vartrue($ret[$mode]);\n\t\t\t\n\t\t}\n\n\n\n\n\t\tfunction fieldData($name, $val)\n\t\t{\n\t\t\t$frm = e107::getForm();\n\t\t\t$type = $val['type'];\n\t\t\t\n\t\t\t$strings = array('time','timestamp','datetime','year','tinyblob','blob',\n\t\t\t\t\t\t\t'mediumblob','longblob','tinytext','mediumtext','longtext','text','date','varchar','char');\n\t\t\t\n\t\t\t\n\t\t\tif(in_array(strtolower($type),$strings))\n\t\t\t{\n\t\t\t\t$value = 'str';\t\n\t\t\t}\t\n\t\t\telse \n\t\t\t{\n\t\t\t\t$value = 'int';\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t$fname = $this->table.\"[fields][\".$name.\"][data]\";\n\t\t\t\n\t\t\treturn $frm->hidden($fname, $value). \"<a href='#' class='e-tip' title='{$type}' >\".$value.\"</a>\" ;\n\t\t\t\n\t\t}\n\n\n\n\n// ******************************** CODE GENERATION AREA *************************************************\n\n\t\tfunction step4()\n\t\t{\n\t\t\t$tp = e107::getParser();\n\t\t\t$pluginTitle = $tp->filter($_POST['xml']['main-name']);\n\t\t\t\n\t\t\tif($_POST['xml'])\n\t\t\t{\n\t\t\t\t$_POST['xml'] = $tp->filter($_POST['xml']);\n\t\t\t\t$xmlText =\t$this->createXml($_POST['xml']);\n\t\t\t}\n\t\t\t\t\t\n\t\t\tif(!empty($_POST['addons']))\n\t\t\t{\n\t\t\t\t$_POST['addons'] = $tp->filter($_POST['addons']);\n\t\t\t\t$addonResults = $this->createAddons($_POST['addons']);\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tunset($_POST['step'],$_POST['xml'], $_POST['addons']);\n\t\t$thePlugin = $tp->filter($_POST['newplugin'],'file');\n\n$text = \"\\n\n// Generated e107 Plugin Admin Area \n\nrequire_once('../../class2.php');\nif (!getperms('P')) \n{\n\te107::redirect('admin');\n\texit;\n}\n\n// e107::lan('\".$thePlugin.\"',true);\n\n\nclass \".$thePlugin.\"_adminArea extends e_admin_dispatcher\n{\n\n\tprotected \\$modes = array(\t\n\t\";\n\t\n\n\tunset($_POST['newplugin']);\n\n\t\n\t\t\tforeach($_POST as $table => $vars) // LOOP Through Tables. \n\t\t\t{\n\t\t\t\tif(vartrue($vars['mode']) && $vars['mode'] != 'exclude')\n\t\t\t\t{\n\n\t\t\t\t\t$vars['mode'] = $tp->filter($vars['mode']);\n\n\t$text .= \"\n\t\t'\".$vars['mode'].\"'\t=> array(\n\t\t\t'controller' \t=> '\".$table.\"',\n\t\t\t'path' \t\t\t=> null,\n\t\t\t'ui' \t\t\t=> '\".str_replace(\"_ui\", \"_form_ui\", $table).\"',\n\t\t\t'uipath' \t\t=> null\n\t\t),\n\t\t\n\";\n\t\t\t\t}\n\t\t\t} // END LOOP\n/*\n\t\t'cat'\t\t=> array(\n\t\t\t'controller' \t=> 'faq_cat_ui',\n\t\t\t'path' \t\t\t=> null,\n\t\t\t'ui' \t\t\t=> 'faq_cat_form_ui',\n\t\t\t'uipath' \t\t=> null\n\t\t)\t\t\t\t\t\n\t);\t\n*/\n\n$text .= \"\n\t);\t\n\t\n\t\n\tprotected \\$adminMenu = array(\n\";\n\t\t\tforeach($_POST as $table => $vars) // LOOP Through Tables. \n\t\t\t{\n\t\t\t\tif(vartrue($vars['mode']) && $vars['mode'] != 'exclude' && !empty($vars['table']))\n\t\t\t\t{\n\n\t\t\t\t\t\t$vars['mode'] = $tp->filter($vars['mode']);\n$text .= \"\n\t\t'\".$vars['mode'].\"/list'\t\t\t=> array('caption'=> LAN_MANAGE, 'perm' => 'P'),\n\t\t'\".$vars['mode'].\"/create'\t\t=> array('caption'=> LAN_CREATE, 'perm' => 'P'),\n\";\n}\n\t\t\t}\n\t\t\t\nif($_POST['pluginPrefs'][0]['index'])\n{\n\t\t\t\t\n$text .= \"\t\t\t\n\t\t'main/prefs' \t\t=> array('caption'=> LAN_PREFS, 'perm' => 'P'),\t\n\";\n}\n$text .= \"\n\t\t// 'main/custom'\t\t=> array('caption'=> 'Custom Page', 'perm' => 'P')\n\t);\n\n\tprotected \\$adminMenuAliases = array(\n\t\t'main/edit'\t=> 'main/list'\t\t\t\t\n\t);\t\n\t\n\tprotected \\$menuTitle = '\".vartrue($pluginTitle, $tp->filter($vars['pluginName'])).\"';\n}\n\n\n\n\";\t\t\t\n\t\t\t// print_a($_POST);\n\n\t\t\t\n\t\t\t$srch = array(\n\t\t\t\t\n\t\t\t\t\"\\n\",\n\t\t\t\t\"),\",\n\t\t\t\t\"    \",\n\t\t\t\t\"'batch' => '1'\",\n\t\t\t\t\"'filter' => '1'\",\n\t\t\t\t\"'inline' => '1'\",\n\t\t\t\t\"'validate' => '1'\",\n\t\t\t\t\", 'fieldpref' => '1'\",\n\t\t\t\t\"'type' => ''\",\n\t\t\t\t\"'data' => ''\"\n\t\t\t );\n\t\t\t \n\t\t\t$repl = array(\n\t\t\t\t\n\t\t\t\t \"\",\n\t\t\t\t \"),\\n\\t\\t\",\n\t\t\t\t \" \",\n\t\t\t\t\"'batch' => true\",\n\t\t\t\t\"'filter' => true\",\n\t\t\t\t\"'inline' => true\",\n\t\t\t\t\"'validate' => true\",\n\t\t\t\t\"\",\n\t\t\t\t\"'type' => null\",\n\t\t\t\t\"'data' => null\"\n\t\t\t\t  );\n\t\t\t\n\t\n\t\t\t\n\t\t\t \n\t\t\t$tableCount = 1;\n\t\t\tforeach($_POST as $table => $vars) // LOOP Through Tables. \n\t\t\t{\n\n\t\t\t\t$vars['mode'] = $tp->filter($vars['mode']);\n\t\t\t\t$vars['pluginName'] = $tp->filter($vars['pluginName']);\n\t\t\t\t$vars['table'] = $tp->filter($vars['table']);\n\t\t\t\t$vars['pid'] = $tp->filter($vars['pid']);\n\n\t\t\t\tif($table == 'pluginPrefs' || $vars['mode'] == 'exclude')\n\t\t\t\t{\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tforeach($vars['fields'] as $key=>$val)\n\t\t\t\t{\n\t\t\t\t\tif($val['type'] == 'image' && empty($val['readParms']))\n\t\t\t\t\t{\t\n\t\t\t\t\t\t$vars['fields'][$key]['readParms'] = 'thumb=80x80'; // provide a thumbnail preview by default. \n\t\t\t\t\t}\t\n\t\t\t\t}\n\t\t\t\t\t\t\n\n\t\t\t\t$FIELDS = str_replace($srch,$repl,var_export($vars['fields'],true));\n\t\t\t\t$FIELDS = preg_replace(\"#('([A-Z0-9_]*?LAN[_A-Z0-9]*)')#\",\"$2\",$FIELDS); // remove quotations from LANs. \n\t\t\t\t$FIELDPREF = array();\n\t\t\t\t\n\t\t\t\tforeach($vars['fields'] as $k=>$v)\n\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\tif(isset($v['fieldpref']) && $k != 'checkboxes' && $k !='options')\n\t\t\t\t\t{\n\t\t\t\t\t\t$FIELDPREF[] = \"'\".$k.\"'\";\n\t\t\t\t\t}\t\t\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\t\n$text .= \n\"\n\t\t\t\t\nclass \".$table.\" extends e_admin_ui\n{\n\t\t\t\n\t\tprotected \\$pluginTitle\t\t= '\".$pluginTitle.\"';\n\t\tprotected \\$pluginName\t\t= '\".$vars['pluginName'].\"';\n\t//\tprotected \\$eventName\t\t= '\".$vars['pluginName'].\"-\".$vars['table'].\"'; // remove comment to enable event triggers in admin. \t\t\n\t\tprotected \\$table\t\t\t= '\".$vars['table'].\"';\n\t\tprotected \\$pid\t\t\t\t= '\".$vars['pid'].\"';\n\t\tprotected \\$perPage\t\t\t= 10; \n\t\tprotected \\$batchDelete\t\t= true;\n\t\tprotected \\$batchExport     = true;\n\t\tprotected \\$batchCopy\t\t= true;\n\t//\tprotected \\$sortField\t\t= 'somefield_order';\n\t//\tprotected \\$orderStep\t\t= 10;\n\t//\tprotected \\$tabs\t\t\t\t= array('Tabl 1','Tab 2'); // Use 'tab'=>0  OR 'tab'=>1 in the \\$fields below to enable. \n\t\t\n\t//\tprotected \\$listQry      \t= \\\"SELECT * FROM `#tableName` WHERE field != '' \\\"; // Example Custom Query. LEFT JOINS allowed. Should be without any Order or Limit.\n\t\n\t\tprotected \\$listOrder\t\t= '\".$vars['pid'].\" DESC';\n\t\n\t\tprotected \\$fields \t\t= \".$FIELDS.\";\t\t\n\t\t\n\t\tprotected \\$fieldpref = array(\".implode(\", \",$FIELDPREF).\");\n\t\t\n\";\n\n\nif($_POST['pluginPrefs'] && ($vars['mode']=='main'))\n{\n\t$text .= \"\n\t//\tprotected \\$preftabs        = array('General', 'Other' );\n\t\tprotected \\$prefs = array(\\n\";\n\t\t\n\t\tforeach($_POST['pluginPrefs'] as $k=>$val)\n\t\t{\n\t\t\tif(vartrue($val['index']))\n\t\t\t{\n\t\t\t\t$index = $tp->filter($val['index']);\n\t\t\t\t$type = vartrue($val['type'],'text');\n\t\t\t\t$help = str_replace(\"'\",'', vartrue($val['help']));\n\t\t\t\t\n\t\t\t\t$text .= \"\\t\\t\\t'\".$index.\"'\\t\\t=> array('title'=> '\".ucfirst($index).\"', 'tab'=>0, 'type'=>'\".$tp->filter($type).\"', 'data' => 'str', 'help'=>'\".$tp->filter($help).\"'),\\n\";\n\t\t\t}\t\n\t\n\t\t}\n\t\t\n\t\t\n\t\t$text .= \"\\t\\t); \\n\\n\";\n\t\t\t\t\n}\n\t\t\t\t\n\t\t\t\n\n$text .= \"\t\n\t\tpublic function init()\n\t\t{\n\t\t\t// Set drop-down values (if any). \n\";\n\t\t\t\n\t\tforeach($vars['fields'] as $k=>$v)\n\t\t{\n\t\t\tif($v['type'] == 'dropdown')\n\t\t\t{\n\t\t\t\t$text .= \"\\t\\t\\t\\$this->fields['\".$k.\"']['writeParms']['optArray'] = array('\".$k.\"_0','\".$k.\"_1', '\".$k.\"_2'); // Example Drop-down array. \\n\";\n\t\t\t}\n\t\t}\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\n\t\t\t\n$text .= \"\t\n\t\t}\n\n\t\t\n\t\t// ------- Customize Create --------\n\t\t\n\t\tpublic function beforeCreate(\\$new_data,\\$old_data)\n\t\t{\n\t\t\treturn \\$new_data;\n\t\t}\n\t\n\t\tpublic function afterCreate(\\$new_data, \\$old_data, \\$id)\n\t\t{\n\t\t\t// do something\n\t\t}\n\n\t\tpublic function onCreateError(\\$new_data, \\$old_data)\n\t\t{\n\t\t\t// do something\t\t\n\t\t}\t\t\n\t\t\n\t\t\n\t\t// ------- Customize Update --------\n\t\t\n\t\tpublic function beforeUpdate(\\$new_data, \\$old_data, \\$id)\n\t\t{\n\t\t\treturn \\$new_data;\n\t\t}\n\n\t\tpublic function afterUpdate(\\$new_data, \\$old_data, \\$id)\n\t\t{\n\t\t\t// do something\t\n\t\t}\n\t\t\n\t\tpublic function onUpdateError(\\$new_data, \\$old_data, \\$id)\n\t\t{\n\t\t\t// do something\t\t\n\t\t}\t\t\n\t\t\n\t\t\t\n\t/*\t\n\t\t// optional - a custom page.  \n\t\tpublic function customPage()\n\t\t{\n\t\t\t\\$text = 'Hello World!';\n\t\t\t\\$otherField  = \\$this->getController()->getFieldVar('other_field_name');\n\t\t\treturn \\$text;\n\t\t\t\n\t\t}\n\t*/\n\t\t\t\n}\n\t\t\t\t\n\n\nclass \".str_replace(\"_ui\", \"_form_ui\", $table).\" extends e_admin_form_ui\n{\n\";\n\nforeach($vars['fields'] as $fld=>$val)\n{\n\tif(varset($val['type']) != 'method')\n\t{\n\t\tcontinue;\t\n\t}\t\n\t\n$text .= \"\n\t\n\t// Custom Method/Function \n\tfunction \".$fld.\"(\\$curVal,\\$mode)\n\t{\n\n\t\t \t\t\n\t\tswitch(\\$mode)\n\t\t{\n\t\t\tcase 'read': // List Page\n\t\t\t\treturn \\$curVal;\n\t\t\tbreak;\n\t\t\t\n\t\t\tcase 'write': // Edit Page\n\t\t\t\treturn \\$this->text('\".$fld.\"',\\$curVal, 255, 'size=large');\n\t\t\tbreak;\n\t\t\t\n\t\t\tcase 'filter':\n\t\t\tcase 'batch':\n\t\t\t\treturn  array();\n\t\t\tbreak;\n\t\t}\n\t}\n\";\n}\n\n$text .= \"\n}\t\t\n\t\t\n\";\t\t\t\n\t\t\t\t\t\t\n\t \t\t$tableCount++;\t\n\t\t\t\t\t\n\t\t\t} // End LOOP. \n\t\n$text .= '\t\t\nnew '.$thePlugin.'_adminArea();\n\nrequire_once(e_ADMIN.\"auth.php\");\ne107::getAdminUI()->runPage();\n\nrequire_once(e_ADMIN.\"footer.php\");\nexit;\n\n';\n\n// ******************************** END GENERATION AREA *************************************************\t\n\t\t\t\t\t\n\t\t\t$ns = e107::getRender();\n\t\t\t$mes = e107::getMessage();\n\t\t\t\n\t\t\t$generatedFile = e_PLUGIN.$thePlugin.\"/admin_config.php\";\n\t\t\t\n\t\t\t$startPHP = chr(60).\"?php\";\t\t\n\t\t\t$endPHP =  \"?>\";\n\n\t\t\tif(!empty($addonResults))\n\t\t\t{\n\t\t\t\tforeach($addonResults as $v)\n\t\t\t\t{\n\t\t\t\t\t$mes->addSuccess($v);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif($this->createFiles == true)\n\t\t\t{\n\t\t\t\tif(file_put_contents($generatedFile, $startPHP .$text . $endPHP))\n\t\t\t\t{\n\t\t\t\t\t$message = str_replace(\"[x]\", \"<a class='alert-link' href='\".$generatedFile.\"'>\".EPL_ADLAN_216.\"</a>\", EPL_ADLAN_217);\n\t\t\t\t\t$mes->addSuccess($message);\n\t\t\t\t}\t\n\t\t\t\telse \n\t\t\t\t{\n\t\t\t\t\t$mes->addError(str_replace('[x]', $generatedFile, EPL_ADLAN_218));\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$mes->addSuccess(EPL_ADLAN_219);\n\t\t\t}\n\n\n\n\n\t\t\t\n\t\t//\techo $mes->render();\n\n\t\t\t$ret = \"<h3>plugin.xml</h3>\";\n\t\t\t$ret .= \"<pre style='font-size:80%'>\".$xmlText.\"</pre>\";\n\t\t\t$ret .= \"<h3>admin_config.php</h3>\";\n\t\t\t$ret .= \"<pre style='font-size:80%'>\".$text.\"</pre>\";\n\n\t\t\treturn array('caption'=>EPL_ADLAN_253, 'text'=> $ret);\n\t\t\t\n\t\t//\t$text =$ns->tablerender(ADLAN_98.SEP.EPL_ADLAN_114.SEP.\" plugin.xml\", \"<pre style='font-size:80%'>\".$xmlText.\"</pre>\", 'default', true);\n\n\n\n\t\t\t\n\t\t\t$text .= $ns->tablerender(\"admin_config.php\", \"<pre style='font-size:80%'>\".$text.\"</pre>\");\n\t\t\t\n\t\t//\t\n\t\t\treturn;\n\t\n\t\t}\n}\n\n?>\n", "<?php\n/*\n * e107 website system\n *\n * Copyright (C) 2008-2013 e107 Inc (e107.org)\n * Released under the terms and conditions of the\n * GNU General Public License (http://www.gnu.org/licenses/gpl.txt)\n *\n * Administration - Site Preferences\n *\n */\n\nrequire_once (\"../class2.php\");\n\nif(isset($_POST['newver']))\n{\n\theader(\"location:http://e107.org/index.php\");\n\texit();\n}\n\nif(!getperms(\"1\"))\n{\n\te107::redirect('admin');\n\texit();\n}\n\ne107::coreLan('prefs', true);\n\n$e_sub_cat = 'prefs';\n//e107::lan('core','mailout','admin');\ne107::coreLan('mailout', true);\n\n\nrequire_once (e_ADMIN.\"auth.php\");\n\n$e_userclass = e107::getUserClass(); \nrequire_once (e_HANDLER.\"user_extended_class.php\");\nrequire_once(e_HANDLER.'mailout_admin_class.php');\t\t// Admin tasks handler\n$ue = new e107_user_extended();\n$core_pref = e107::getConfig();\n\nif(!$core_pref->get('timezone'))\n{\n\t$core_pref->set('timezone', 'UTC');\n}\n\n$frm = e107::getForm(false, true); //enable inner tabindex counter\n$mes = e107::getMessage();\n$tp = e107::getParser();\n\n/*\tRESET DISPLAY NAMES\t*/\nif(isset($_POST['submit_resetdisplaynames']))\n{\n\te107::getDb()->db_Update('user', 'user_name=user_loginname');\n\t$mes->addInfo(PRFLAN_157);\n}\n\n//echo '<pre>';\n//var_dump($core_pref->getPref());\n//echo '</pre>';\n\nif (isset($_POST['testemail'])) \n{\n\tsendTest();\n}\n\t\t\n\t\n\n\n\n\n/*\tUPDATE PREFERENCES */\nif(isset($_POST['updateprefs']))\n{\n\t\n\t\n\t\n\tunset($_POST['updateprefs'], $_POST['sitelanguage']);\n\t\n\n\n\t$_POST['cookie_name'] = str_replace(array(\" \", \".\"), \"_\", $_POST['cookie_name']);\n\t$_POST['cookie_name'] = preg_replace(\"#[^a-zA-Z0-9_]#\", \"\", $_POST['cookie_name']);\n\n\t$_POST['siteurl'] = trim($_POST['siteurl']) ? trim($_POST['siteurl']) : SITEURL;\n\t$_POST['siteurl'] = substr($_POST['siteurl'], - 1) == \"/\" ? $_POST['siteurl'] : $_POST['siteurl'].\"/\";\n\n\t// If email verification or Email/Password Login Method - email address is required!\n\tif (($_POST['user_reg_veri'] == 1 || $_POST['allowEmailLogin'] == 1) && $_POST['disable_emailcheck'])\n\t{\n\t\t$_POST['disable_emailcheck'] = 0;\n\t\t$mes->addError(PRFLAN_211);\n    }\n\n\t// Table of range checking values - min and max for numerics. Only do the important ones\n\t$pref_limits = array('loginname_maxlength' => array('min' => 10, 'max' => 100, 'default' => 30),\n\t\t\t\t\t'displayname_maxlength' => array('min' => 5, 'max' => 100, 'default' => 15),\n\t\t\t\t\t'antiflood_timeout' => array('min' => 3, 'max' => 300, 'default' => 10),\n\t\t\t\t\t'signup_pass_len' => array('min' => 2, 'max' => 100, 'default' => 4)\n\t\t\t\t\t);\n\n\t$pref['post_html'] = intval($_POST['post_html']);\t\t\t// This ensures the setting is reflected in set text\n\n\n\t$smtp_opts = array();\n\n\tif(!empty($_POST['smtp_options']))\n\t{\n\n\t\tswitch (trim($_POST['smtp_options']))\n\t\t{\n\t\t\tcase 'smtp_ssl' :\n\t\t\t\t$smtp_opts[] = 'secure=SSL';\n\t\t\t\tbreak;\n\t\t\tcase 'smtp_tls' :\n\t\t\t\t$smtp_opts[] = 'secure=TLS';\n\t\t\t\tbreak;\n\t\t\tcase 'smtp_pop3auth' :\n\t\t\t\t$smtp_opts[] = 'pop3auth';\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif (!empty($_POST['smtp_keepalive']))\n\t\t{\n\t\t\t$smtp_opts[] = 'keepalive';\n\t\t}\n\n\t\tif (!empty($_POST['smtp_useVERP']))\n\t\t{\n\t\t\t$smtp_opts[] = 'useVERP';\n\t\t}\n\n\t\t$_POST['smtp_options'] = implode(',',$smtp_opts);\n\n\t\tunset($_POST['smtp_keepalive'],$_POST['smtp_useVERP']);\n\n\t\t// e107::getMessage()->addDebug(print_a($_POST['smtp_options'],true));\n\t}\n\n\n\n\n\t\n\t$_POST['membersonly_exceptions'] = explode(\"\\n\",$_POST['membersonly_exceptions']);\n\n\t// FIXME - automate - pref model & validation handler\n\t$prefChanges = array();\n\t$sessionRegenerate = false;\n\tforeach($_POST as $key => $value)\n\t{\n\t\tif(isset($pref_limits[$key]))\n\t\t{ // Its a numeric value to check\n\t\t\tif(is_numeric($value))\n\t\t\t{\n\t\t\t\tif($value < $pref_limits[$key]['min'])\n\t\t\t\t{\n\t\t\t\t\t$value = $pref_limits[$key]['min'];\n\t\t\t\t\t$mes->addWarning(str_replace(array('--FIELD--','--VALUE--'),array($key,$value),PRFLAN_213));\n\t\t\t\t}\n\t\t\t\tif($value > $pref_limits[$key]['max'])\n\t\t\t\t{\n\t\t\t\t\t$value = $pref_limits[$key]['max'];\n\t\t\t\t\t$mes->addWarning(str_replace(array('--FIELD--','--VALUE--'),array($key,$value),PRFLAN_212));\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$value = $pref_limits[$key]['default'];\n\t\t\t}\n\t\t\t$newValue = $value;\n\t\t}\n\t\telseif('cookie_name' == $key && $core_pref->get($key) != $value)\n\t\t{\n\t\t\t// special case\n\t\t\tif(!preg_match('/^[\\w\\-]+$/', $value))\n\t\t\t{\n\t\t\t\t$newValue = e_COOKIE;\n\t\t\t\t$mes->addWarning(PRFLAN_219);\n\t\t\t}\n\t\t\telse \n\t\t\t{\n\t\t\t\t$newValue = $value;\n\t\t\t\t$sessionRegenerate = true;\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$newValue = $tp->toDB($value);\n\t\t}\n\t\t\n\t\t$core_pref->update($key, $newValue);\n\t}\n\n\tif($core_pref->dataHasChanged())\n\t{\n\t\t// Need to clear cache in order to refresh library information.\n\t\te107::getCache()->clearAll('system');\n\t}\n\n\t$core_pref->save(false);\n\n\t// special case, do session cleanup, logout, redirect to login screen\n\tif($sessionRegenerate)\n\t{\n\t\t// reset cookie\n\t\tcookie($core_pref->get('cookie_name'), $_COOKIE[e_COOKIE], (time() + 3600 * 24 * 30), e_HTTP, e107::getLanguage()->getCookieDomain());\n\t\tcookie(e_COOKIE, null, null);\n\t\t\n\t\t// regenerate session\n\t\t$s = $_SESSION;\n\t\te107::getSession()->destroy();\n\t\t$session = new e_core_session(array('name' => $core_pref->get('cookie_name')));\n\t\t$_SESSION = $s;\n\t}\n}\n\nif (e107::isInstalled('alt_auth'))\n{\n\t$authlist[] = \"e107\";\n\t$handle = opendir(e_PLUGIN.\"alt_auth\");\n\twhile($file = readdir($handle))\n\t{\n\t\tif(preg_match(\"/^(.*)_auth\\.php/\", $file, $match))\n\t\t{\n\t\t\t$authlist[] = $match[1];\n\t\t}\n\t}\n}\n\n\n\nfunction sendTest()\n{\n\t$log = e107::getAdminLog();\n\t$mes = e107::getMessage();\n\t\n\tif(trim($_POST['testaddress']) == '')\n\t{\n\t\t$mes->add(LAN_MAILOUT_19, E_MESSAGE_ERROR);\n\t\t$subAction = 'error';\n\t}\n\telse\n\t{\n\t\t$mailheader_e107id = USERID;\n\t\t$pref = e107::pref('core');\n\n\t\t$add = ($pref['mailer']) ? \" (\".strtoupper($pref['mailer']).\") \" : ' (PHP)';\n\n\t\tif($pref['mailer'] == 'smtp')\n\t\t{\n\t\t\t$add .= \"Port: \".varset($pref['smtp_port'],25);\n\t\t\t$add .= \" - \".str_replace(\"secure=\", \"\", $pref['smtp_options']);\n\t\t}\n\n\n\t\t$sendto = trim($_POST['testaddress']);\n\t\t\n\t\t\n\t\t$eml = array(); \n\t\t\n\t\t$eml['email_subject']\t\t= LAN_MAILOUT_113.\" \".$add;\n\t\t$eml['email_sender_email']\t= null; \n\t\t$eml['email_sender_name']\t= null;\n\t\t$eml['email_replyto']\t\t= null;\n\t\t$eml['email_replytonames']\t= null; \n\t\t$eml['send_html']\t\t\t= true; \n\t\t$eml['add_html_header'] \t= null; \n\t\t$eml['email_body']\t\t\t= str_replace(\"[br]\", \"<br>\", LAN_MAILOUT_114);\n\t\t$eml['email_attach']\t\t= null;\n\t\t$eml['template']\t\t\t= 'default';\n\t\t$eml['e107_header']\t\t\t= USERID;\n\n\t\tif (!e107::getEmail()->sendEmail($sendto, LAN_MAILOUT_189, $eml)) \n\t\t{\n\t\t\t$mes->addError(($pref['mailer'] == 'smtp')  ? LAN_MAILOUT_67 : LAN_MAILOUT_106);\n\t\t} \n\t//\tif (!sendemail($sendto, LAN_MAILOUT_113.\" \".SITENAME.$add, str_replace(\"[br]\", \"\\n\", LAN_MAILOUT_114),LAN_MAILOUT_189)) \n\t//\t{\n\t//\t\t$mes->addError(($pref['mailer'] == 'smtp')  ? LAN_MAILOUT_67 : LAN_MAILOUT_106);\n\t//\t} \n\t\telse \n\t\t{\n\t\t\t$mes->addSuccess(LAN_MAILOUT_81. ' ('.$sendto.')');\n\t\t\t$log->log_event('MAIL_01',$sendto,E_LOG_INFORMATIVE,'');\n\t\t}\n\t}\n\n}\n\n/*\nif(e_QUERY == \"u\")\n{\n\t$ns->tablerender(\"\", \"<div style='text-align:center'><b>\".PRFLAN_106.\"</b></div>\");\n}\n*/\n$handle = opendir(e_ADMIN.'includes/');\nwhile($file = readdir($handle))\n{\n\tif($file != \".\" && $file != \"..\")\n\t{\n\t\t$file = str_replace(\".php\", \"\", $file);\n\t\t$adminlist[] = $file;\n\t}\n}\nclosedir($handle);\n\n$pref['membersonly_exceptions'] = implode(\"\\n\",$pref['membersonly_exceptions']);\n\n$text = \"\n<div id='core-prefs'>\n\t<form class='admin-menu' method='post' action='\".e_SELF.\"' autocomplete='off'>\n\t\t<fieldset id='core-prefs-main'>\n\t\t\t<legend>\".PRFLAN_1.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='sitename'>\".PRFLAN_2.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('sitename', $pref['sitename'], 100, 'required=1&size=xxlarge').\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='siteurl'>\".PRFLAN_3.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('siteurl', $pref['siteurl'], 150, 'size=xxlarge').\"\n\t\t\t\t\t\t\t\".($pref['siteurl'] == SITEURL ? \"\" : \"<div class='field-help'>\".PRFLAN_159.\": <strong>\".SITEURL.\"</strong></div>\").\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='redirectsiteurl'>\".PRFLAN_134.\"</label></td>\n\t\t\t\t\t\t<td>\";\n\t\t\t\t\t\t/*\n\t\t\t\t\t\t\t\".$frm->radio('redirectsiteurl', 1, $pref['redirectsiteurl'], array('label'=>LAN_ENABLED)).\" \n\t\t\t\t\t\t\t\".$frm->radio('redirectsiteurl', 0, !$pref['redirectsiteurl'], array('label'=>LAN_DISABLED)).\"\n\t\t\t\t\t\t*/\n\t\t\t\t\t\t$text .= $frm->radio_switch('redirectsiteurl', $pref['redirectsiteurl']).\"<div class='field-help'>\".PRFLAN_135.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='sitebutton'>\".PRFLAN_4.\"</label></td>\n\t\t\t\t\t\t<td>\n\";\n/*\n$parms = \"name=sitebutton\";\n$parms .= \"&path=\".e_THEME.$pref['sitetheme'].\"/images/|\".e_IMAGE;\n$parms .= \"&filter=0\";\n$parms .= \"&fullpath=1\";\n$parms .= \"&default=\".urlencode($pref['sitebutton']);\n//$parms .= \"&width=128px\";\n//$parms .= \"&height=128px\";\n$parms .= \"&multiple=FALSE\";\n$parms .= \"&label=-- No Image --\";\n$parms .= \"&subdirs=1\";\n$parms .= \"&tabindex=\".$frm->getNext();\n\n\n$text .= \"<div class='field-section'>\".$tp->parseTemplate(\"{IMAGESELECTOR={$parms}&scaction=select}\").\"</div>\";\n// $text .= \"<div class='field-section'>\".$frm->imagepicker('sitebutton',$pref['sitebutton'],'-- No Image --').\"</div>\";\n\n//TODO make the preview update when image-picker is used.\n$text .= \"<div class='field-spacer'>\".$tp->parseTemplate(\"{IMAGESELECTOR={$parms}&scaction=preview}\").\"</div>\";\n\n$sLogo = siteinfo_shortcodes::sc_logo();\n*/\n\nif(!empty($pref['sitebutton']) && strpos($pref['sitebutton'],'{')===false && file_exists(e_IMAGE.$pref['sitebutton']))\n{\n\t$pref['sitebutton'] = '{e_IMAGE}'.$pref['sitebutton'];\n}\n\n\n\n$text .= $frm->imagepicker('sitebutton',$pref['sitebutton'],'','help='.PRFLAN_225); //todo  use 'LegacyPath' option instead of code above.\n\n$text .= \"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='sitelogo'>\".PRFLAN_214.\"</label></td>\n\t\t\t\t\t\t<td>\".$frm->imagepicker('sitelogo',$pref['sitelogo'],'','w=200&help='.PRFLAN_226).\"</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='sitetag'>\".PRFLAN_5.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->textarea('sitetag', $tp->toForm($pref['sitetag']), 3, 59, array('size'=>'xxlarge')).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_227.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='sitedescription'>\".PRFLAN_6.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->textarea('sitedescription', $tp->toForm($pref['sitedescription']), 3, 80, array('size'=>'xxlarge')).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_228.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='sitedisclaimer'>\".PRFLAN_9.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->textarea('sitedisclaimer',$tp->toForm( $pref['sitedisclaimer']), 3, 80, array('size'=>'xxlarge')).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_229.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('main').\"\n\t\t</fieldset>\n\";\n\n\n// Email and Contact Information --------------\n\n$text .= \"<fieldset class='e-hideme' id='core-prefs-email'>\n\t\t\t<legend>\".PRFLAN_13.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t<tr>\n\t\t\t\t\t<td><label for='siteadmin'>\".PRFLAN_7.\"</label></td>\n\t\t\t\t\t<td>\n\t\t\t\t\t\t\".$frm->text('siteadmin', SITEADMIN, 100, array('size'=>'xlarge')).\"\n\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='siteadminemail'>\".PRFLAN_8.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('siteadminemail', SITEADMINEMAIL, 100, array('size'=>'xlarge')).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='replyto-name'>\".PRFLAN_174.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('replyto_name', $pref['replyto_name'], 100, array('size'=>'xlarge')).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_175.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='replyto-email'>\".PRFLAN_176.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('replyto_email', $pref['replyto_email'], 100, array('size'=>'xlarge')).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_177.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='testaddress'>\".LAN_MAILOUT_110.\"</label><br /></td>\n\t\t\t\t\t\t<td class='form-inline'>\".$frm->admin_button('testemail', LAN_MAILOUT_112,'other').\"&nbsp;\n\t\t\t\t\t\t\t<input name='testaddress' id='testaddress' class='tbox form-control input-xxlarge' placeholder='user@yoursite.com' type='text' size='40' maxlength='80' value=\\\"\".(varset($_POST['testaddress']) ? $_POST['testaddress'] : USEREMAIL).\"\\\" />\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td style='vertical-align:top'><label for='mailer'>\".PRFLAN_267.\"</label><br /></td>\n\t\t\t\t\t\t<td>\";\n\n\n\t\t\t\t$text .= mailoutAdminClass::mailerPrefsTable($pref);\n\n\n\t\t\t\t$text .=\"</td>\n\t\t\t\t</tr>\n\t\t\t\n\t\t\t\n\t\t\t\t<tr>\n\t\t\t\t\t<td><label for='mail-sendstyle'>\".LAN_MAILOUT_222.\"</label></td>\n\t\t\t\t\t<td>\";\n\t\t\t\t\t\n\t\t\t\t$emFormat = array(\n\t\t\t\t\t'textonly' => LAN_MAILOUT_125,\n\t\t\t\t\t'texthtml' => LAN_MAILOUT_126,\n\t\t\t\t\t'texttheme' => LAN_MAILOUT_127\n\t\t\t\t);\t\n\t\t\t\t$text .= $frm->select('mail_sendstyle', $emFormat, vartrue($pref['mail_sendstyle'])); \n\t\t\t\t$text .= \"\n\t\t\t\t\t</td>\n\t\t\t\t</tr>\n\t\t\t\t\t\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='sitecontactinfo'>\".PRFLAN_162.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->textarea('sitecontactinfo', $pref['sitecontactinfo'], 6, 59, array('size'=>'xxlarge')).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_163.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='sitecontacts'>\".PRFLAN_168.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$e_userclass->uc_dropdown('sitecontacts', $pref['sitecontacts'], 'nobody,main,admin,classes', \"tabindex='\".$frm->getNext().\"'\").\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_169.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='contact_visibility'>\".PRFLAN_258.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$e_userclass->uc_dropdown('contact_visibility', varset( $pref['contact_visibility'],e_UC_PUBLIC), null, \"tabindex='\".$frm->getNext().\"'\").\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_274.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='contact-filter'>\".PRFLAN_270.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->textarea('contact_filter', $pref['contact_filter'], 5, 59, array('size'=>'xxlarge')).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_271.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\n\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='contact-emailcopy'>\".PRFLAN_164.\"</label></td>\n\t\t\t\t\t\t<td>\";\n\t\t\t\t\t\t/*\n\t\t\t\t\t\t\t\".$frm->radio('contact_emailcopy', 1, $pref['contact_emailcopy']).\"\n\t\t\t\t\t\t\t\".$frm->label(LAN_ENABLED, 'contact_emailcopy', 1).\"&nbsp;&nbsp;\n\t\t\t\t\t\t\t\".$frm->radio('contact_emailcopy', 0, !$pref['contact_emailcopy']).\"\n\t\t\t\t\t\t\t\".$frm->label(LAN_DISABLED, 'contact_emailcopy', 0).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_165.\"</div>\n\t\t\t\t\t\t*/\n\t\t\t\t\t$text .= $frm->radio_switch('contact_emailcopy', $pref['contact_emailcopy']).\"<div class='smalltext field-help'>\".PRFLAN_165.\"</div>\n\n\n\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('email').\"\n\t\t</fieldset>\";\n\n\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-display'>\n\t\t\t<legend>\".PRFLAN_13.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='displaythemeinfo'>\".PRFLAN_14.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('displaythemeinfo', $pref['displaythemeinfo']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='displayrendertime'>\".PRFLAN_15.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('displayrendertime', $pref['displayrendertime']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='displaysql'>\".PRFLAN_16.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('displaysql', $pref['displaysql']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\";\nif(function_exists(\"memory_get_usage\"))\n{\n\t$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='display-memory-usage'>\".PRFLAN_137.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('display_memory_usage', $pref['display_memory_usage']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\";\n}\n$text .= \"\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('display').\"\n\t\t</fieldset>\n\";\n\n// Admin Display Areas\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-admindisp'>\n\t\t\t<legend>\".PRFLAN_77.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='admin-alerts-ok'>\".PRFLAN_95.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('admin_alerts_ok', $pref['admin_alerts_ok']).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_96.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='admin-alerts-uniquemenu'>\".PRFLAN_97.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('admin_alerts_uniquemenu', $pref['admin_alerts_uniquemenu']).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_98.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\";\n\t\t\t\t\t/*<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_199.\"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('admin_slidedown_subs', $pref['admin_slidedown_subs']).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_200.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>*/\n\t\t\t\t\t$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='admin-separate-plugins'>\".PRFLAN_204.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('admin_separate_plugins', $pref['admin_separate_plugins']).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_205.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('admindisp').\"\n\t\t</fieldset>\n\n\t\";\n\n// Date options.\n$ga = new convert();\n$date1 = $ga->convert_date(time(), \"short\");\n$date2 = $ga->convert_date(time(), \"long\");\n$date3 = $ga->convert_date(time(), \"forum\");\n$date4 = e107::getDate()->convert(time(),\"input\");\n\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-date'>\n\t\t\t<legend>\".PRFLAN_21.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='shortdate'>\".PRFLAN_22.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('shortdate', $pref['shortdate'], 50).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_83.\": {$date1}</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='longdate'>\".PRFLAN_23.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('longdate', $pref['longdate'], 50).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_83.\": {$date2}</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='forumdate'>\".PRFLAN_24.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('forumdate', $pref['forumdate'], 50).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_83.\": {$date3}</div>\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_25.\" <a href='http://www.php.net/manual/en/function.strftime.php' rel='external'>\".PRFLAN_93.\"</a></div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\";\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t$def = strtotime('December 21, 2012 3:45pm');\n\t\t\t\t\t\n\t\t\t\t\t$inputdate = array( // TODO add more formats\n\t\t\t\t\t\t\"%A, %d %B, %Y\"\t=> strftime(\"%A, %d %B, %Y\",$def),\n\t\t\t\t\t\t\"%A, %d %b, %Y\"\t=> strftime(\"%A, %d %b, %Y\",$def),\n\t\t\t\t\t\t\"%a, %d %B, %Y\"\t=> strftime(\"%a, %d %B, %Y\",$def),\n\t\t\t\t\t\t\"%a, %d %b, %Y\"\t=> strftime(\"%a, %d %b, %Y\",$def),\n\t\t\t\t\t\t\n\t\t\t\t\t\t\"%A, %B %d, %Y\"\t=> strftime(\"%A, %B %d, %Y\",$def),\n\t\t\t\t\t\t\"%A, %b %d, %Y\"\t=> strftime(\"%A, %b %d, %Y\",$def),\n\t\t\t\t\t\t\"%A, %b %d, %y\"\t=> strftime(\"%A, %b %d, %y\",$def),\n\t\t\t\t\t\t\n\t\t\t\t\t\t\"%B %d, %Y\"\t\t=> strftime(\"%B %d, %Y\",$def),\n\t\t\t\t\t\t\"%b %d, %Y\"\t\t=> strftime(\"%b %d, %Y\",$def),\n\t\t\t\t\t\t\"%b %d, %y\"\t\t=> strftime(\"%b %d, %y\",$def),\n\t\t\t\t\t\t\n\t\t\t\t\t\t\"%d %B, %Y\"\t\t=> strftime(\"%d %B, %Y\",$def),\n\t\t\t\t\t\t\"%d %b, %Y\"\t\t=> strftime(\"%d %b, %Y\",$def),\n\t\t\t\t\t\t\"%d %b, %y\"\t\t=> strftime(\"%d %b, %y\",$def),\n\t\t\t\t\t\t\n\t\t\t\t\t\t\"%Y-%m-%d\"\t\t=> strftime(\"%Y-%m-%d\",$def),\n\t\t\t\t\t\t\"%d-%m-%Y\"\t\t=> strftime(\"%d-%m-%Y\",$def),\n\t\t\t\t\t\t\"%m/%d/%Y\"\t\t=> strftime(\"%m/%d/%Y\",$def)\n\t\t\t\t\t);\n\t\t\t\t\t\n\t\t\t\n\t\t\t\t\t$inputtime = array();\n\t\t\t\t\t\n\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\t \n\t\t\t\t\t$inputtime[\"%I:%M %p\"]\t= strftime(\"%I:%M %p\",$def);\n\t\t\t\t\tif(e107::getDate()->supported('P'))\n\t\t\t\t\t{\t\n\t\t\t\t\t\t$inputtime[\"%I:%M %P\"]\t=  strftime(\"%I:%M %P\",$def);\n\t\t\t\t\t}\n\t\t\t\t\tif(e107::getDate()->supported('l'))\n\t\t\t\t\t{\n\t\t\t\t\t\t$inputtime[\"%l:%M %p\"]\t= strftime(\"%l:%M %p\",$def);\n\t\t\t\t\t\t$inputtime[\"%l:%M %P\"]\t= strftime(\"%l:%M %P\",$def);\t\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t$inputtime[\"%H:%M\"]\t\t= strftime(\"%H:%M\",$def);\n\t\t\t\t\t$inputtime[\"%H:%M:%S\"]\t= strftime(\"%H:%M:%S\",$def);\n\t\t\t\t\t\t\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t\n\n\t\t\t\t\t$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='inputdate'>\".PRFLAN_230.\"</label></td>\n\t\t\t\t\t\t<td class='form-inline'>\n\t\t\t\t\t\t\t\".$frm->select('inputdate',$inputdate, e107::getPref('inputdate'));\n\t\t\t\t\t\t\t\n\t\t\t\t\t$text .= $frm->select('inputtime',$inputtime, e107::getPref('inputtime'));\n\t\t\t\t\t\n\t\t\t\t\t$text .= \"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\";\n\n$timeZones = systemTimeZones();\n\n$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='timezone'>\".PRFLAN_56.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->select('timezone', $timeZones, vartrue($pref['timezone'], 'UTC'),'size=xlarge').\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('date').\"\n\t\t</fieldset>\n\";\n\n\n// =========== Registration Preferences. ==================\n\n\n\n$elements = array(1=> PRFLAN_259, 2=> PRFLAN_260, 0=>LAN_DISABLED); \n\n\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-registration'>\n\t\t\t<legend>\".PRFLAN_28.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='user-reg'>\".PRFLAN_224.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio('user_reg', $elements, $pref['user_reg']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_30.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='user-reg-veri'>\".PRFLAN_154.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->select_open('user_reg_veri', array('size'=>'xlarge'));\n                            $veri_list = array(PRFLAN_152,PRFLAN_31,PRFLAN_153);\n\n\t\t\t\t\t\t\tforeach($veri_list as $v => $v_title)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$text .= $frm->option($v_title, $v, ($pref['user_reg_veri'] == $v));\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t$srch = array('[', ']');\n\t\t\t\t\t$repl = array(\"<a href='\".e_ADMIN_ABS.\"notify.php'>\", '</a>');\n\n\t\t\t\t\t$PRFLAN_154a = str_replace($srch,$repl, PRFLAN_154a);\n\n\t\t\t\t\t$text .= \"\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<div class='field-help'>\".$PRFLAN_154a.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\t <tr>\n\t\t\t\t\t\t<td><label for='allowemaillogin'>\".PRFLAN_184.\"</label></td>\n\t\t\t\t\t\t<td>\".$frm->select_open('allowEmailLogin', array('size'=>'xlarge'));\n                     //   $login_list = array(PRFLAN_201,PRFLAN_202,PRFLAN_203);\n                        $login_list = array(\n\t                        2 => PRFLAN_203,\n\t                        1 => PRFLAN_202,\n\t                        0 => PRFLAN_201\n                        );\n                        foreach($login_list as $l => $l_title)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$text .= $frm->option($l_title, $l, ($pref['allowEmailLogin'] == $l));\n\t\t\t\t\t\t}\n\n\t\t\t\t\t$text .= \"\n\t\t\t\t\t\t\t</select></td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\";\n\n\t\t\t\t\t/*\n\t\t\t\t\t // Highly problematic.\n\t\t\t\t\t$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='signup-remote-emailcheck'>\".PRFLAN_160.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('signup_remote_emailcheck', $pref['signup_remote_emailcheck']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\";\n\n\t\t\t\t\t*/\n\t\t\t\t\t$membersOnlyRedirectOptions = array( 'login'=>PRFLAN_264, 'splash'=>PRFLAN_265);\n\n\t\t\t\t\t$text .= \"\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='membersonly-enabled'>\".PRFLAN_58.\"</label></td>\n\t\t\t\t\t\t<td>\";\n\t\t\t\t\t\n\t\t\t\t\t$memDisp = !vartrue($pref['membersonly_enabled']) ? \"e-hideme\" : \"\";\n\t\t\t\t\t\t\n\t\t\t\t\t$text .= $frm->radio_switch('membersonly_enabled', $pref['membersonly_enabled'],'', '', 'class=e-expandit').\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_59.\"</div>\n\t\t\t\t\t\t\t<div class='e-expandit-container {$memDisp}' style='padding-top:10px'>\n\t\t\t\t\t\t\t<div class='form-group clearfix'>\n\t\t\t\t\t\t\t\".\n\t\t\t\t\t\t\t$frm->select('membersonly_redirect',$membersOnlyRedirectOptions,$pref['membersonly_redirect'], array('size'=>'xxlarge')).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_266.\"</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class='form-group clearfix'>\".\n\t\t\t\t\t\t\t$frm->textarea('membersonly_exceptions', $pref['membersonly_exceptions'], 3, 1, 'size=xxlarge&placeholder='.PRFLAN_206).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_207.\"</div></div>\n\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n              \n               \t\t<tr>\n\t\t\t\t\t\t<td><label for='autologinpostsignup'>\".PRFLAN_197.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('autologinpostsignup', $pref['autologinpostsignup']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_198.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='displayname-maxlength'>\".PRFLAN_158.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('displayname_maxlength', $pref['displayname_maxlength'], 3).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='loginname-maxlength'>\".PRFLAN_172.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('loginname_maxlength', $pref['loginname_maxlength'], 3).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='signup-pass-len'>\".CUSTSIG_16.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('signup_pass_len', $pref['signup_pass_len'], 2).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='signup-maxip'>\".PRFLAN_136.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('signup_maxip', $pref['signup_maxip'], 3).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_78.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t\n\t\t\t\t\t</tbody>\n\t\t\t\t\t\n\n\t\t\t</table>\n\t\t\t\".pref_submit('registration').\"\n\t\t</fieldset>\n\n\t\";\n\t\n\n// Key registration \n\n\t\n\t\n\n// Signup options ===========================.\n\n$prefOptionPassword = (isset($pref['signup_option_password'])) ? $pref['signup_option_password'] : 2;\n\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-signup'>\n\t\t\t<legend>\".PRFLAN_19.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_261.\"</td><td><table class='table table-striped table-condensed table-bordered' style='margin-bottom:0px'>\n\t\t\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td><label>Email</label></td>\n\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\".$frm->radio('disable_emailcheck', 2, ($pref['disable_emailcheck']==2), array('label' => CUSTSIG_12, 'disabled'=>true)).\"\n\t\t\t\t\t\t\t\t\".$frm->radio('disable_emailcheck', 1, (intval($pref['disable_emailcheck']) == 1), array('label' => CUSTSIG_14)).\"\n\t\t\t\t\t\t\t\t\".$frm->radio('disable_emailcheck', 0, (intval($pref['disable_emailcheck']) == 0), array('label' => CUSTSIG_15)).\"\n\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td><label for='signup-option-password'>\".LAN_PASSWORD.\"</label></td>\n\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\".$frm->radio('signup_option_password', 0, !$prefOptionPassword, array('label' => CUSTSIG_12)).\"\n\t\t\t\t\t\t\t\t\".$frm->radio('signup_option_password', 1, ($prefOptionPassword == 1), array('label' => CUSTSIG_14, 'disabled'=>true)).\"\n\t\t\t\t\t\t\t\t\".$frm->radio('signup_option_password', 2, ($prefOptionPassword == 2), array('label' => CUSTSIG_15)).\"\n\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t</tr>\n\n\n\t\t\t\t\t\t\";\n\t\t\t\t\n\t\t$signup_option_names = array(\n\t\t//\t\"signup_option_loginname\" \t=> \"Login Name\",\n\n\t\t\"signup_option_realname\" \t\t=> CUSTSIG_2,\n\t\t\"signup_option_email_confirm\" \t=> CUSTSIG_21,\n\t\t\"signup_option_image\" \t\t\t=> CUSTSIG_7,\n\n\t\t'signup_option_customtitle'\t\t=> CUSTSIG_20,\n\t\t'signup_option_hideemail'\t\t=> CUSTSIG_22,\n\t\t\"signup_option_class\" \t\t\t=> CUSTSIG_17,\n\t\t\"signup_option_signature\" \t\t=> CUSTSIG_6,\n\t);\n\n\n\tforeach($signup_option_names as $value => $key)\n\t{\n\t\t$label_value = str_replace('_', '-', $value);\n\t\t$text .= \"\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td><label for='\".$label_value.\"'>\".$key.\"</label></td>\n\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\".$frm->radio($value, 0, !$pref[$value], array('label' => CUSTSIG_12)).\"\n\t\t\t\t\t\t\t\t\".$frm->radio($value, 1, ($pref[$value] == 1), array('label' => CUSTSIG_14)).\"\n\t\t\t\t\t\t\t\t\".$frm->radio($value, 2, ($pref[$value] == 2), array('label' => CUSTSIG_15)).\"\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t</tr>\n\t\t\";\n\t}\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t$text .= \"\n\n\n\t<tr>\n\t\t\t\t\t\t<td><label for='user-reg-secureveri'>\".PRFLAN_262.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('user_reg_secureveri', $pref['user_reg_secureveri'], CUSTSIG_12, CUSTSIG_14).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\n\n</table>\n\t\t\t\t\t\t</td></tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='use-coppa'>\".PRFLAN_45.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('use_coppa', $pref['use_coppa']).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_46.\" <a href='http://www.ftc.gov/privacy/coppafaqs.shtm' rel='external'>\".PRFLAN_94.\"</a></div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\";\n\n/*\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='disable-emailcheck'>\".PRFLAN_167.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\". $pref['disable_emailcheck'].\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>*/\n\n$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='signup-text'>\".PRFLAN_126.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->textarea('signup_text', $pref['signup_text'], 3, 80, array('size'=>'xxlarge')).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='signup-text-after'>\".PRFLAN_140.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->textarea('signup_text_after', $pref['signup_text_after'], 3, 80, array('size'=>'xxlarge')).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='predefinedloginname'>\".PRFLAN_192.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('predefinedLoginName', $pref['predefinedLoginName'], 50).\"\n\t\t\t\t\t\t\t<div class='field-help'><div style='text-align:left'>\".PRFLAN_193.\"<br />\".str_replace(\"[br]\",\"<br /> \",PRFLAN_194).\"</div></div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\n\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='signup-disallow-text'>\".CUSTSIG_18.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->tags('signup_disallow_text', $pref['signup_disallow_text'], 500).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".CUSTSIG_19.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='displayname_class'>\".PRFLAN_155.\":</label></td>\n\t\t\t\t\t\t<td class='form-inline'>\n\t\t\t\t\t\t\t\".$e_userclass->uc_dropdown('displayname_class', $pref['displayname_class'], 'nobody,member,admin,classes', \"tabindex='\".$frm->getNext().\"'\").\"\n\t\t\t\t\t\t\t\".$frm->admin_button('submit_resetdisplaynames', PRFLAN_156, 'delete').\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\n\n\n\";\n\n/*\n\t\t\t\t\t<!--\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".CUSTSIG_13.\"</td>\n\t\t\t\t\t\t<td>\".CUSTSIG_14.\"</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t-->\n*/\n\n\n\n$text .= \"\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('signup').\"\n\t\t</fieldset>\n\";\n\n// Custom Fields.\n\n\n/* text render options */\n\nif(!isset($pref['post_html']))\n{\n\t$pref['post_html'] = '250';\n\tsave_prefs();\n}\n\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-textpost'>\n\t\t\t<legend>\".PRFLAN_101.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='make-clickable'>\".PRFLAN_127.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('make_clickable', $pref['make_clickable']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_128.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\";\n\t\t\t\t\t\n\t\t\t\t$replaceDisp = vartrue($pref['link_replace']) ? \"\" : \"e-hideme\";\n\t\t\t\t\n\t\t\t\t$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='link-replace'>\".PRFLAN_102.\"?:</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('link_replace', $pref['link_replace'],'', '', 'expandit=1').\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_103.\"</div>\n\t\t\t\t\t\t\t<div class='e-expandit-container {$replaceDisp}'>\n\t\t\t\t\t\t\t\".$frm->text('link_text', $pref['link_text'], 200, 'placeholder='.PRFLAN_104).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_105.\"</div>\".\n\t\t\t\t\t\t\t$frm->text('email_text', $tp->post_toForm($pref['email_text']), 200, 'placeholder='.PRFLAN_107).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_108.\"</div>\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\n\t\t\t\t\t<tr >\n\t\t\t\t\t\t<td><label for='links-new-window'>\".PRFLAN_145.\"?:</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('links_new_window', $pref['links_new_window']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_146.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='profanity-filter'>\".PRFLAN_40.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('profanity_filter', $pref['profanity_filter']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_41.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='profanity-replace'>\".PRFLAN_42.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('profanity_replace', $pref['profanity_replace'], 20).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='profanity-words'>\".PRFLAN_43.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->tags('profanity_words', $pref['profanity_words']).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_44.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='main-wordwrap'>\".PRFLAN_109.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('main_wordwrap', $pref['main_wordwrap'], 3).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_110.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='menu-wordwrap'>\".PRFLAN_111.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('menu_wordwrap', $pref['menu_wordwrap'], 3).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_110.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='post-html'>\".PRFLAN_116.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$e_userclass->uc_dropdown('post_html', $pref['post_html'], 'nobody,public,member,admin,main,classes', \"tabindex='\".$frm->getNext().\"'\").\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_117.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='post-script'>\".PRFLAN_215.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".r_userclass('post_script',$pref['post_script'],'off','nobody,member,admin,main,classes').\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_216.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='inline-editing'>\".PRFLAN_268.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->userclass('inline_editing',$pref['inline_editing'],'off','nobody,admin,main,classes,no-excludes').\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_269.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='filter-script'>\".PRFLAN_217.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('filter_script', varset($pref['filter_script'], 1)).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_218.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='html-abuse'>\".PRFLAN_220.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('html_abuse', varset($pref['html_abuse'], 1)).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_221.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='wysiwyg'>\".PRFLAN_122.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('wysiwyg', $pref['wysiwyg']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_123.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='old_np'>\".PRFLAN_124.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('old_np', $pref['old_np']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_125.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\";\n\nif(file_exists(e_PLUGIN.\"geshi/geshi.php\"))\n{\n\t$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='usegeshi'>\".PRFLAN_118.\"?:</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('useGeshi', $pref['useGeshi']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".str_replace(\"[link]\", \"http://qbnz.com/highlighter/\", PRFLAN_119).\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='defaultlangeshi'>\".PRFLAN_120.\"?:</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('defaultLanGeshi', ($pref['defaultLanGeshi'] ? $pref['defaultLanGeshi'] : \"php\"), 20).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_121.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\";\n}\n$text .= \"\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('textpost').\"\n\t\t</fieldset>\n\";\n\nfunction multi_radio($name, $textsVals, $currentval = '')\n{\n\t$ret = '';\n\t$gap = '';\n\tforeach($textsVals as $v => $t)\n\t{\n\t\t$sel = ($v == $currentval) ? \" checked='checked'\" : \"\";\n\t\t$ret .= $gap.\"<input type='radio' name='{$name}' value='{$v}'{$sel} /> \".$t.\"\";\n\t\t$gap = \"&nbsp;&nbsp;\";\n\t}\n\treturn $ret;\n}\n\n// Security Options. .\n$hasGD = extension_loaded(\"gd\");\n\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-security'>\n\t\t\t<legend>\".PRFLAN_47.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\";\n\n\tif(!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != 'off')     // Only allow if an SSL login has been made.\n\t{\n\t\t$text .=\"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='ssl-enabled'>\".PRFLAN_60.\"</label></td>\n\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('ssl_enabled', $pref['ssl_enabled']).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_61.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\";\n\t}\n\t// Secure Image/ Captcha\n\t$secureImage = array('signcode'=>PRFLAN_76, 'logcode'=>PRFLAN_81, \"fpwcode\"=>PRFLAN_138,'admincode'=>PRFLAN_222);\n\t\n\tforeach($secureImage as $key=>$label)\n\t{\n\t\t\n\t\t$label = str_replace($srch,$repl,$label);\n\t\t\n\t\t$text .= \"<tr><td><label for='\".$key.\"'>\".$label.\"</label></td><td>\";\t\n\t\tif($hasGD)\n\t\t{\n\t\t\t$text .= $frm->radio_switch($key, $pref[$key]);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$text .= PRFLAN_133;\n\t\t}\n\t\t\n\t\t$text .= \"\n\t\t<div class='field-help'>\".PRFLAN_223.\"</div>\n\t\t</td></tr>\\n\";\n\t\t\n\t}\n\n\n/*\n\n\n\t\t\t\t\t\n\t$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_81.\": </td>\n\t\t\t\t\t\t<td>\n\";\n\nif($hasGD)\n{\n\t$text .= $frm->radio_switch('logcode', $pref['logcode']);\n}\nelse\n{\n\t$text .= PRFLAN_133;\n}\n$text .= \"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_138.\": </td>\n\t\t\t\t\t\t<td>\n\";\nif($hasGD)\n{\n\t$text .= $frm->radio_switch('fpwcode', $pref['fpwcode']);\n}\nelse\n{\n\t$text .= PRFLAN_133;\n}\n\n$text .= \"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\";\n * \n \n */\n$text .= \"\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='disallowmultilogin'>\".PRFLAN_129.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('disallowMultiLogin', $pref['disallowMultiLogin'], LAN_YES, LAN_NO).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_130.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='user-tracking-cookie'>\".PRFLAN_48.\"</label></td>\n\t\t\t\t\t\t<td >\n\t\t\t\t\t\t\t<div class='form-inline'>\n\t\t\t\t\t\t\t\".$frm->radio('user_tracking', array('cookie' => PRFLAN_49, 'session' => PRFLAN_50), $pref['user_tracking']).\"\n\t\t\t\t\t\t</div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='cookie-name'>\".PRFLAN_55.\"</label></td>\n\t\t\t\t\t\t<td >\".$frm->text('cookie_name', $pref['cookie_name'], 20).\"\n\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_263.\".</div></td></tr>\n\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='session-lifetime'>\".PRFLAN_272.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('session_lifetime', $pref['session_lifetime'],6).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_273.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='passwordencoding'>\".PRFLAN_188.\":</label></td>\n\n\t\t\t\t\t\t\t\";\n\n\t\t\t\t\t\t$pwdEncodeOpts = array();\n\n\t\t\t\t\t\tif(function_exists('password_verify')) // ie. php 5.5 or higher\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$pwdEncodeOpts[3]\t = \"PHP Default (Preferred)\";\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t$pwdEncodeOpts[1] = PRFLAN_190;\n\t\t\t\t\t\t$pwdEncodeOpts[0] = PRFLAN_189;\n\n\t\t\t\t\t\t$text .= (isset($pwdEncodeOpts[3]) && $pref['passwordEncoding']!=3) ? \"<td class='has-warning'>\" : \"<td>\";\n\t\t\t\t\t\t$text .= $frm->select('passwordEncoding', $pwdEncodeOpts,  varset($pref['passwordEncoding'], 0));\n\n\t\t\t\t//\t$text .= $frm->radio_switch('passwordEncoding', varset($pref['passwordEncoding'], 0), PRFLAN_190, PRFLAN_189);\n\n\t\t\t\t\t\t$text .= \"\n\t\t\t\t\t\t\t<div class='smalltext field-help'></div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\";\n\t\t\t\t\t\n\t\t\t\t\t$CHAP_list = array(PRFLAN_180, PRFLAN_181, PRFLAN_182);\n\t\n\t\t\t\t\t$text .= \"\n\t\t\t\t\t\t<td><label for='password-chap'>\".PRFLAN_178.\"</label></td>\n\t\t\t\t\t\t<td>\".$frm->select('password_CHAP',$CHAP_list,$pref['password_CHAP'] );\n\t\t\t\t\t\t//.\"\t\".$frm->select_open('password_CHAP');\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t//TODO - user tracking session name - visible only if Cookie is enabled (JS)\n\n\t\t\t\t\t\t$text .= \"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_183.\"<br />\".PRFLAN_179.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='antiflood1'>\".PRFLAN_35.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('antiflood1', $pref['antiflood1']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='antiflood-timeout'>\".PRFLAN_36.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('antiflood_timeout', $pref['antiflood_timeout'], 3).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_38.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='autoban'>\".PRFLAN_37.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->select_open('autoban');\n\n$autoban_list = array(\n\tPRFLAN_113,\n\tPRFLAN_144,\n\tPRFLAN_142,\n\tPRFLAN_143\n);\n\nforeach($autoban_list as $ab => $ab_title)\n{\n\t$sel = ($pref['autoban'] == $ab) ? \"selected='selected'\" : \"\";\n\t$text .= \"\n\t\t\t\t\t\t\t\t\".$frm->option($ab_title, $ab, ($pref['autoban'] == $ab)).\"\n\t\";\n}\n\n$text .= \"\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_91.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='failed-login-limit'>\".PRFLAN_231.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('failed_login_limit', varset($pref['failed_login_limit'],10), 3, array('max'=>10, 'min'=>0)).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_232.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='adminpwordchange'>\".PRFLAN_139.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('adminpwordchange', $pref['adminpwordchange']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('security').\"\n\t\t</fieldset>\n\";\n\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-comments'>\n\t\t\t<legend>\".PRFLAN_87.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_161.\":</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('comments_disabled', $pref['comments_disabled'], LAN_NO, LAN_YES,array('reverse'=>1)).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n             \t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_32.\"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('anon_post', $pref['anon_post'], LAN_YES, LAN_NO).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_33.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_89.\": </td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('comments_icon', $pref['comments_icon'], LAN_YES, LAN_NO).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_88.\": </td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('nested_comments', $pref['nested_comments'], LAN_YES, LAN_NO).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_90.\": </td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('allowCommentEdit', $pref['allowCommentEdit'], LAN_YES, LAN_NO).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_166.\": </td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('comments_emoticons', $pref['comments_emoticons'], LAN_YES, LAN_NO).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_233.\"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t$frm->uc_select('comments_moderate', $pref['comments_moderate'],\"nobody,guest,new,bots,public,admin,main,classes\").\n\t\t\t\t\t\t\t\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_234.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_235.\"</td>\n\t\t\t\t\t\t<td>\";\n\t\t\t\t\t\t\n\t\t\t\t\t\t$comment_sort = array(\n\t\t\t\t\t\t\t\"desc\"\t=> PRFLAN_236, //default\n\t\t\t\t\t\t\t'asc'\t=> PRFLAN_237\n\t\t\t\t\t\t);\n\t\t\t\t\t\n\t\t\t\t\t$text .= $frm->select('comments_sort',$comment_sort, $pref['comments_moderate'], array('size'=>'xlarge')).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t</tbody>\n\t\t\t</table>\n\n\t\t\t<legend>\".PRFLAN_209.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_208.\":</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$e_userclass->uc_dropdown('email_item_class',varset($pref['email_item_class'],e_UC_MEMBER),'nobody,admin,main,public,member,classes', \"tabindex='\".$frm->getNext().\"'\").\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('comments').\"\n\t\t</fieldset>\n\t\";\n\t\n// File Uploads\n\n\te107::includeLan(e_LANGUAGEDIR.e_LANGUAGE.\"/admin/lan_upload.php\");\n\trequire_once(e_HANDLER.\"upload_handler.php\"); \n\t\n\t\n\t\n\t\n\t\n\t\n\t$text .= \"\n\t<fieldset class='e-hideme' id='core-prefs-uploads'>\n\t\t\t<legend>\".PRFLAN_238.\"</legend>\";\n\t\n\t\n\t$upload_max_filesize = ini_get('upload_max_filesize');\n\t$post_max_size = ini_get('post_max_size');\n\t\n\t$maxINI = min($upload_max_filesize,$post_max_size); \n\t\n\tif($maxINI < $pref['upload_maxfilesize'])\n\t{\n\t\t$text .= \"<div class='alert-block alert alert-danger'>\";\n\t\t$text .= PRFLAN_239.\" \".$maxINI.\"</div>\";\n\t\t$pref['upload_maxfilesize'] = $maxINI;\n\t}\n\t\n\t\n\t\n\t\t\t\n\t$text .= \"\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t<tr>\n\t<td>\".UPLLAN_25.\"</td>\n\t<td>\".\n\t\n\t$frm->radio_switch('upload_enabled', $pref['upload_enabled'])\n\t.\"\n\t<div class='field-help'>\".UPLLAN_26.\"</div>\n\t</td>\n\t</tr>\n\n\t<tr>\n\t<td>\".UPLLAN_33.\"<br />\n\t</td>\n\t<td>\".\n\t$frm->text('upload_maxfilesize', $pref['upload_maxfilesize'], 10)\n\t .\"\n\t <div class='field-help'>\".UPLLAN_34.\"</div>\n\t</td>\n\t</tr>\n\n\t<tr>\n\t<td>\".UPLLAN_37.\"</td>\n\t<td>\".r_userclass(\"upload_class\", $pref['upload_class'],\"off\",\"nobody,public,guest,member,admin,classes\").\"\n\t<div class='field-help'>\".UPLLAN_38.\"</div>\n\t</td>\n\t</tr>\n\t<tr><td>\".PRFLAN_240.\"</td>\n\t<td>\n\n\t<table class='table table-striped table-bordered'>\n\t<tr><th>\".LAN_TYPE.\"</th><th>\".UPLLAN_33.\"</th>\n\t\";\n\t\n\t$fl = e107::getFile();\n\t$data = $fl->getFiletypeLimits(); \n\t \n\tforeach($data as $k=>$v)\n\t{\n\t\t$text .= \"<tr><td>\".$k.\"</td>\n\t\t<td>\".$fl->file_size_encode($v).\"</td>\n\t\t</tr>\";\t\n\t\t\n\t\t\n\t}\n//\t$text .= print_a($data,true); \n\t\n\n\t\n\t$text .= \"</table>\n\t\n\t<div>\".PRFLAN_241.\" <b>\".str_replace(\"../\",'',e_SYSTEM).e_READ_FILETYPES.\"</b></div>\n\t</td>\n\t\n\t\n\t</tbody>\n\t\t</table>\n\t\t\t\".pref_submit('uploads');\n\t\t\t\n\t\t\t\n\t\t\t\n\t$text .= \"\n\t\t</fieldset>\";\n\n\n$text .= \"<fieldset class='e-hideme' id='core-prefs-javascript'>\";\n\nif(E107_DEBUG_LEVEL > 0)\n{\n\t// TODO - remove these old JS settings completely!\n\n\t// Javascript Control\n\t$text .= \"\n\t\t\t<legend>\" . PRFLAN_242 . \"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\";\n\n\t$js_options = array(\n\t\t'auto'  => PRFLAN_243, // load based on dependency\n\t\t'admin' => PRFLAN_244, // Always load in admin\n\t\t'front' => PRFLAN_245, // Always load in front-end\n\t\t'all'   => PRFLAN_246, // Always load in admin and front-end\n\t\t'none'  => PRFLAN_247  // disabled\n\t);\n\n\t$js_types = array(\n\t\tarray('id' => 'jquery', 'name' => 'jQuery (local)'),\n\t\tarray('id' => 'prototype', 'name' => 'Prototype (local)'),\n\t);\n\n\tforeach($js_types as $arr)\n\t{\n\t\t// $k = $arr['path'];\n\t\t$k = $arr['id'];\n\t\t$name = $arr['name'];\n\t\t$text .= \"<tr>\n\t\t\t\t<td>\" . $name . \"</td>\n\t\t\t\t<td>\" . $frm->radio(\"e_jslib_core[{$k}]\", $js_options, $pref['e_jslib_core'][$k]) . \"</td>\n\t\t\t\t</tr>\";\n\t}\n\n\t$text .= \"\n\t\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t<table class='table adminform' style='margin-top: 20px'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<thead>\n\t\t\t\t\t<tr><th colspan='2'><span class='label label-warning'>DEPRECATED</span> Available only in DEBUG mode</th></tr>\n\t\t\t\t</thead>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\" . PRFLAN_248 . \"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\" . $frm->radio_switch('e_jslib_nocombine', $pref['e_jslib_nocombine'], LAN_YES, LAN_NO) . \"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\" . PRFLAN_249 . \"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\" . PRFLAN_250 . \"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\" . $frm->radio_switch('e_jslib_gzip', $pref['e_jslib_gzip'], LAN_YES, LAN_NO) . \"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\" . PRFLAN_251 . \"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\" . PRFLAN_252 . \"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\" . $frm->radio_switch('e_jslib_nocache', $pref['e_jslib_nocache'], LAN_YES, LAN_NO) . \"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\" . PRFLAN_251 . \"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\" . PRFLAN_253 . \"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\" . $frm->radio_switch('e_jslib_nobcache', $pref['e_jslib_nobcache'], LAN_YES, LAN_NO) . \"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\" . PRFLAN_251 . \"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\";\n\n\t$text .= \"</tbody></table>\";\n}\nelse\n{\n\t$text .= \"<div>\";\n\t$text .= $frm->hidden('e_jslib_core[jquery]', 'all');\n\t$text .= $frm->hidden('e_jslib_core[prototype]', 'none');\n\t$text .= $frm->hidden('e_jslib_nocombine', 1);\n\t$text .= $frm->hidden('e_jslib_nocache', 1);\n\t$text .= $frm->hidden('e_jslib_nobcache', 1);\n\t$text .= $frm->hidden('e_jslib_gzip', 0);\n\t$text .= \"</div>\";\n}\n\n/**\n * @addtogroup CDN settings\n * @{\n */\n\n// [e_LANGUAGEDIR]/[e_LANGUAGE]/lan_library_manager.php\ne107::lan('core', 'library_manager');\n\n$CDNproviders = array(\n\t'jsdelivr' => 'jsDelivr',\n\t'cdnjs' => 'cdnjs',\n);\n\n$text .= '\n<h4 class=\"caption\">' . LAN_LIBRARY_MANAGER_30 . '</h4>\n<table class=\"table adminform\">\n\t<colgroup>\n\t\t<col class=\"col-label\"/>\n\t\t<col class=\"col-control\"/>\n\t</colgroup>\n\t<tbody>\n\t\t<tr>\n\t\t\t<td>' . LAN_LIBRARY_MANAGER_31 . '</td>\n\t\t\t<td>\n\t\t\t\t' . $frm->radio(\"e_jslib_cdn\", array(1 => LAN_YES, 0 => LAN_NO), varset($pref['e_jslib_cdn'], 1)) . '\n\t\t\t</td>\n\t\t</tr>\n\t\t<tr>\n\t\t\t<td>' . LAN_LIBRARY_MANAGER_32 . '</td>\n\t\t\t<td>\n\t\t\t\t' . $frm->select(\"e_jslib_cdn_provider\", $CDNproviders, varset($pref['e_jslib_cdn_provider'], 'jsdelivr')) . '\n\t\t\t</td>\n\t\t</tr>\n\t</tbody>\n</table>\n';\n\n// Submit button.\n$text .= pref_submit('javascript');\n\n/**\n * @} End of \"addtogroup CDN settings\".\n */\n\n\n/**\n * @addtogroup Third-party libraries\n * @{\n */\n\n$text .= '<h4 class=\"caption\">' . LAN_LIBRARY_MANAGER_25 . '</h4>';\n$text .= '<table width=\"100%\" class=\"table table-striped\" cellpadding=\"0\" cellspacing=\"0\">';\n$text .= '<thead>';\n$text .= '<tr>';\n$text .= '<th>' . LAN_LIBRARY_MANAGER_13 . '</th>';\n$text .= '<th class=\"text-center\">' . LAN_LIBRARY_MANAGER_21 . '</th>';\n$text .= '<th>' . LAN_LIBRARY_MANAGER_29 . '</th>';\n$text .= '<th class=\"text-center\">' . LAN_VERSION . '</th>';\n$text .= '<th class=\"text-center\">' . LAN_STATUS . '</th>';\n$text .= '<th>' . LAN_MESSAGE . '</th>';\n$text .= '<th>' . LAN_MOREINFO . '</th>';\n$text .= '</tr>';\n$text .= '</thead>';\n$text .= '<tbody>';\n\n$libraries = e107::library('info');\nforeach($libraries as $machineName => $library)\n{\n\t$details = e107::library('detect', $machineName);\n\n\tif(empty($details['name']))\n\t{\n\t\tcontinue;\n\t}\n\n\t$name = libraryGetName($machineName, $details);\n\t$provider = libraryGetProvider($details);\n\t$status = libraryGetStatus($details);\n\t$links = libraryGetLinks($details);\n\n\t$text .= '<tr>';\n\t$text .= '<td>' . $name . '</td>';\n\t$text .= '<td class=\"text-center\">' . $provider . '</td>';\n\t$text .= '<td class=\"smalltext\">' . varset($details['library_path']) . '</td>';\n\t$text .= '<td class=\"text-center\">' . varset($details['version']) . '</td>';\n\t$text .= '<td class=\"text-center\">' . $status . '</td>';\n\t$text .= '<td>' . varset($details['error_message']) . '</td>';\n\t$text .= '<td>' . $links . '</td>';\n\t$text .= '</tr>';\n}\n\nif(empty($libraries))\n{\n\t$text .= '<tr>';\n\t$text .= '<td colspan=\"6\">' . LAN_NOT_FOUND . '</td>';\n\t$text .= '</tr>';\n}\n\n$text .= '</tbody>';\n$text .= '</table>';\n$text .= \"</fieldset>\";\n\n/**\n * @} End of \"addtogroup Third-party libraries\".\n */\n\n\n/**\n * @addtogroup Advanced Features\n * @{\n */\n\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-advanced'>\n\t\t\t<legend>\".PRFLAN_149.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_147.\":</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('developer', $pref['developer']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_148.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_196.\"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\".$frm->radio_switch('log_page_accesses', $pref['log_page_accesses']).\"\n\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_196a.\" <strong>\".e_LOG.\"</strong></div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_17.\"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('compress_output', $pref['compress_output']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\";\n\n$auth_dropdown = '';\nif($authlist)\n{\n\t$auth_dropdown = \"\\n\".$frm->select_open('auth_method').\"\\n\";\n\tforeach($authlist as $a)\n\t{\n\t\t$auth_dropdown .= $frm->option($a, $a, ($pref['auth_method'] == $a)).\"\\n\";\n\t}\n\t$auth_dropdown .= \"</select>\\n\";\n}\nelse\n{\n\t$auth_dropdown = \"<input type='hidden' name='auth_method' value='' />\".PRFLAN_151;\n\t$pref['auth_method'] = \"\";\n}\n\n$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_150.\"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t{$auth_dropdown}\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_173.\"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('check_updates', $pref['check_updates']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('advanced').\"\n\t\t</fieldset>\n\t\";\n\n/**\n * @} End of \"addtogroup Advanced Features\".\n */\n\n\n$text .= \"\n\t</form>\n</div>\n\";\n\n$ns->tablerender(PRFLAN_53, $mes->render().$text);\n\nrequire_once(e_ADMIN.\"footer.php\");\n\nfunction pref_submit($post_id = '')\n{\n\tglobal $frm;\n\tif($post_id) $post_id = '-'.$post_id;\n\t$text = \"\n\t\t<div class='buttons-bar center'>\";\n\n\t// ML\n\t/* if(e_MLANG == 1){\n\t//$text .=\"<input class='fcaption' type='submit' name='updateprefs' value='\".PRFLAN_52.\"' />\n\t$but_typ = array(\"\"); // empty = submit\n\t$but_nam = array(\"updateprefs\"); // empty = autobutX with X autoincrement\n\t$but_val = array(\"updateprefs\"); // empty = Submit\n\t$but_class = array(\"caption\"); // empty = button\n\t$butjs = array(\"\"); // empty = \"\"\n\t$buttitle = array(\"\"); // empty = \"\"\n\t$text .= e107ml_adpanel(1,$but_typ,$but_nam,$but_val,$but_class,$butjs,$buttitle);\n\t}else{*/\n\t$text .= $frm->admin_button('updateprefs', PRFLAN_52, 'update', '', \"id=updateprefs{$post_id}\");\n\t// }\n\t$text .= \"\\n</div>\";\n\n\t// END ML\n\treturn $text;\n}\n\nfunction prefs_adminmenu()\n{\n\t$var['core-prefs-main']['text'] = PRFLAN_1;\n\t$var['core-prefs-email']['text'] = PRFLAN_254;\n\t$var['core-prefs-registration']['text'] = PRFLAN_28;\n\t$var['core-prefs-signup']['text'] = PRFLAN_19;\n//\t$var['core-prefs-sociallogin']['text'] = \"Social Options\"; // Moved into plugin.\n\t\n\t$var['core-prefs-comments']['text'] = PRFLAN_210;\n\t$var['core-prefs-uploads']['text'] = PRFLAN_255;\n\t\n\t$var['core-prefs-header1']['header'] = PRFLAN_256;\n\t\n\t$var['core-prefs-display']['text'] = PRFLAN_13;\n\t$var['core-prefs-admindisp']['text'] = PRFLAN_77;\n\t$var['core-prefs-textpost']['text'] = PRFLAN_101;\n\t$var['core-prefs-security']['text'] = PRFLAN_47;\n\t$var['core-prefs-date']['text'] = PRFLAN_21;\t\n\t$var['core-prefs-javascript']['text'] = PRFLAN_257;\n\t$var['core-prefs-advanced']['text'] = PRFLAN_149;\n\t\n\te107::getNav()->admin(LAN_BASIC_OPTIONS.'--id--prev_nav', 'core-prefs-main', $var);\n}\n\n/**\n * @addtogroup Third-party libraries\n * @{\n */\n\n/**\n * Helper function to get library's name.\n */\nfunction libraryGetName($machineName, $details)\n{\n\t$text = e107::getParser()->lanVars(LAN_LIBRARY_MANAGER_27, array($machineName));\n\treturn '<span data-toggle=\"tooltip\" data-placement=\"top\" title=\"' . $text . '\">' . $details['name'] . '</span>';\n}\n\n/**\n * Helper function to get links.\n */\nfunction libraryGetLinks($details)\n{\n\t$homepage = libraryGetHomepage($details);\n\t$download = libraryGetDownload($details);\n\n\tif ($homepage && $download)\n\t{\n\t\treturn $homepage . ' | ' . $download;\n\t}\n\n\tif($homepage)\n\t{\n\t\treturn $homepage;\n\t}\n\n\tif($download)\n\t{\n\t\treturn $download;\n\t}\n}\n\n/**\n * Helper function to get homepage link.\n */\nfunction libraryGetHomepage($details)\n{\n\tif (empty($details['vendor_url']))\n\t{\n\t\treturn false;\n\t}\n\n\t$href = $details['vendor_url'];\n\t$title = $details['name'];\n\n\treturn '<a href=\"' . $href . '\" title=\"' . $title . '\" target=\"_blank\">' . LAN_WEBSITE . '</a>';\n}\n\n/**\n * Helper function to get download link.\n */\nfunction libraryGetDownload($details)\n{\n\tif (empty($details['download_url']))\n\t{\n\t\treturn false;\n\t}\n\n\t$href = $details['download_url'];\n\t$title = $details['name'];\n\n\treturn '<a href=\"' . $href . '\" title=\"' . $title . '\" target=\"_blank\">' . LAN_DOWNLOAD . '</a>';\n}\n\n/**\n * Helper function to get provider.\n */\nfunction libraryGetProvider($details)\n{\n\t$text = 'e107';\n\t$provider = LAN_CORE;\n\n\tif(varset($details['plugin'], false) == true)\n\t{\n\t\t$text = $details['plugin'];\n\t\t$provider = LAN_PLUGIN;\n\t}\n\n\tif(varset($details['theme'], false) == true)\n\t{\n\t\t$text = $details['theme'];\n\t\t$provider = LAN_THEME;\n\t}\n\n\treturn '<span data-toggle=\"tooltip\" data-placement=\"top\" title=\"' . $text . '\">' . $provider . '</span>';\n}\n\n/**\n * Helper function to get status.\n */\nfunction libraryGetStatus($details)\n{\n\t$tp = e107::getParser();\n\n\tif($details['installed'] == true)\n\t{\n\t\t$icon = $tp->toGlyph('glyphicon-ok');\n\t\t$text = LAN_OK;\n\t\treturn '<span class=\"text-success\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"' . $text . '\">' . $icon . '</span>';\n\t}\n\n\t$icon = $tp->toGlyph('glyphicon-remove');\n\t$text = $details['error'];\n\treturn '<span class=\"text-danger\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"' . $text . '\">' . $icon . '</span>';\n}\n\n/**\n * @} End of \"addtogroup Third-party libraries\".\n */\n"], "fixing_code": ["<?php\r\n/*\r\n * e107 website system\r\n *\r\n * Copyright (C) 2008-2015 e107 Inc (e107.org)\r\n * Released under the terms and conditions of the\r\n * GNU General Public License (http://www.gnu.org/licenses/gpl.txt)\r\n *\r\n * Administration Area - Front page\r\n *\r\n*/\r\n\r\n/**\r\n *\te107 Front page administration\r\n *\r\n *\t@package\te107\r\n *\t@subpackage\tadmin\r\n *\t@version \t$Id$;\r\n */\r\n\r\nif(!empty($_POST) && !isset($_POST['e-token']))\r\n{\r\n\t$_POST['e-token'] = '';\r\n}\r\nrequire_once ('../class2.php');\r\nif(! getperms('G'))\r\n{\r\n\te107::redirect('admin');\r\n\texit();\r\n}\r\n\r\ne107::coreLan('frontpage', true);\r\n\r\n$e_sub_cat = 'frontpage';\r\nrequire_once ('auth.php');\r\n\r\n$mes = e107::getMessage();\r\n\r\n$frontPref = e107::pref('core');              \t\t \t// Get prefs\r\n\r\n// Get list of possible options for front page\r\n$front_page['news'] = array('page' => 'news.php', 'title' => ADLAN_0); // TODO Move to e107_plugins/news\r\n\r\n$front_page['wmessage'] = array('page' => 'index.php', 'title' => ADLAN_28, 'diz'=>'index.php');\r\n\r\nif($sql->db_Select('page', 'page_id, page_title', \"menu_name=''\")) // TODO Move to e107_plugins/page\r\n{\r\n\t$front_page['custom']['title'] = FRTLAN_30;\r\n\twhile($row = $sql->db_Fetch())\r\n\t{\r\n\t\t$front_page['custom']['page'][] = array('page' => 'page.php?'.$row['page_id'], 'title' => $row['page_title']);\r\n\t}\r\n}\r\n\r\n// Now let any plugins add to the options - must append to the $front_page array as above\r\n\r\n\r\n\t//v2.x spec. ----------\r\n\t$new = e107::getAddonConfig('e_frontpage');\r\n\tforeach($new as $k=>$v)\r\n\t{\r\n\t\t$front_page[$k] = $v;\r\n\t}\r\n\r\n\t// v1.x spec.---------------\r\n\tif(!empty($frontPref['e_frontpage_list']))\r\n\t{\r\n\t\tforeach($frontPref['e_frontpage_list'] as $val)\r\n\t\t{\r\n\t\t\tif(is_readable(e_PLUGIN.$val.'/e_frontpage.php'))\r\n\t\t\t{\r\n\t\t\t\trequire_once (e_PLUGIN.$val.'/e_frontpage.php');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\r\n\r\n// Make sure links relative to SITEURL\r\nforeach($front_page as &$front_value)\r\n{\r\n\tif(is_array($front_value['page']))\r\n\t{ // Its a URL with multiple options\r\n\t\tforeach($front_value['page'] as &$multipage)\r\n\t\t{\r\n\t\t\t$multipage = str_replace(e_HTTP, '', $multipage);\r\n\t\t\t//if (substr($multipage, 0, 1) != '/') $multipage = '/'.$multipage;\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$front_value = str_replace(e_HTTP, '', $front_value);\r\n\t\t//if (substr($front_value, 0, 1) != '/') $front_value = '/'.$front_value;\r\n\t}\r\n}\r\n\r\n// print_a($front_page);\r\n\r\n\r\n// Now sort out list of rules for display (based on $pref data to start with)\r\n$gotpub = FALSE;\r\nif(is_array($frontPref['frontpage']))\r\n{\r\n\t$i = 1;\r\n\tforeach($frontPref['frontpage'] as $class => $val)\r\n\t{\r\n\t\tif($class == 'all')\r\n\t\t{\r\n\t\t\t$class = e_UC_PUBLIC;\r\n\t\t\t$gotpub = TRUE;\r\n\t\t}\r\n\t\tif($val)\r\n\t\t{ // Only add non-null pages\r\n\t\t\t$fp_settings[$i] = array('order' => $i, 'class' => $class, 'page' => $val, 'force' => varset($frontPref['frontpage_force'][$class], ''));\r\n\t\t\t$i ++;\r\n\t\t}\r\n\t}\r\n}\r\nelse\r\n{ // Legacy stuff to convert\r\n\t$fp_settings = array();\r\n\t$fp_settings[] = array('order' => 0, 'class' => e_UC_PUBLIC, 'page' => varset($frontPref['frontpage'], 'news.php'), 'force' => '');\r\n}\r\n\r\nif(!$gotpub)\r\n{ // Need a 'default' setting - usually 'all'\r\n\t$fp_settings[] = array('order' => $i, 'class' => e_UC_PUBLIC, 'page' => (isset($frontPref['frontpage']['all']) ? $frontPref['frontpage']['all'] : 'news.php'), 'force' => '');\r\n}\r\n\r\n$fp_update_prefs = FALSE;\r\n\r\n\r\n/*\r\nFollowing code replaced - values not passed on image clicks with Firefox\r\nif(isset($_POST['fp_inc']))\r\n{\r\n\t$mv = intval($_POST['fp_inc']);\r\n\techo \"Increment: {$mv}<br />\";\r\n\tif(($mv > 1) && ($mv <= count($fp_settings)))\r\n\t{\r\n\t\t$temp = $fp_settings[$mv - 1];\r\n\t\t$fp_settings[$mv - 1] = $fp_settings[$mv];\r\n\t\t$fp_settings[$mv] = $temp;\r\n\t\t$fp_update_prefs = TRUE;\r\n\t\tfrontpage_adminlog('01', 'Inc '.$mv);\r\n\t}\r\n}\r\nelseif(isset($_POST['fp_dec']))\r\n{\r\n\t$mv = intval($_POST['fp_dec']);\r\n\techo \"Decrement: {$mv}<br />\";\r\n\tif(($mv > 0) && ($mv < count($fp_settings)))\r\n\t{\r\n\t\t$temp = $fp_settings[$mv + 1];\r\n\t\t$fp_settings[$mv + 1] = $fp_settings[$mv];\r\n\t\t$fp_settings[$mv] = $temp;\r\n\t\t$fp_update_prefs = TRUE;\r\n\t\tfrontpage_adminlog('01', 'Dec '.$mv);\r\n\t}\r\n}\r\n*/\r\n\r\nif (isset($_POST))\r\n{\r\n\r\n\t// avoid endless loop.\r\n\tif($_POST['frontpage'] == 'other' && (trim($_POST['frontpage_other']) == 'index.php' || trim($_POST['frontpage_other']) == '{e_BASE}index.php'))\r\n\t{\r\n\t\t$_POST['frontpage'] = 'wmessage';\r\n\t\t$_POST['frontpage_other'] = '';\r\n\t}\r\n\r\n\r\n\tforeach ($_POST as $k => $v)\r\n\t{\r\n\t\t$incDec = substr($k, 0, 6);\r\n\t\t$idNum = substr($k, 6);\r\n\t\tif ($incDec == 'fp_inc')\r\n\t\t{\r\n\t\t\t$mv = intval($idNum);\r\n\t\t\tif(($mv > 1) && ($mv <= count($fp_settings)))\r\n\t\t\t{\r\n\t\t\t\t$temp = $fp_settings[$mv - 1];\r\n\t\t\t\t$fp_settings[$mv - 1] = $fp_settings[$mv];\r\n\t\t\t\t$fp_settings[$mv] = $temp;\r\n\t\t\t\t$fp_update_prefs = TRUE;\r\n\t\t\t\tfrontpage_adminlog('01', 'Inc '.$mv);\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\telseif ($incDec == 'fp_dec')\r\n\t\t{\r\n\t\t\t$mv = intval($idNum);\r\n\t\t\tif(($mv > 0) && ($mv < count($fp_settings)))\r\n\t\t\t{\r\n\t\t\t\t$temp = $fp_settings[$mv + 1];\r\n\t\t\t\t$fp_settings[$mv + 1] = $fp_settings[$mv];\r\n\t\t\t\t$fp_settings[$mv] = $temp;\r\n\t\t\t\t$fp_update_prefs = TRUE;\r\n\t\t\t\tfrontpage_adminlog('01', 'Dec '.$mv);\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n\r\n\r\n// Edit an existing rule\r\nif(isset($_POST['fp_edit_rule']))\r\n{\r\n\t$_POST['type'] = (isset($_POST['edit']['all'])) ? 'all_users' : 'user_class';\r\n\t$_POST['class'] = key($_POST['edit']);\r\n}\r\n\r\n// Cancel Edit\r\n\r\n\r\nif(isset($_POST['fp_save_new']))\r\n{ // Add or edit an existing rule here.\r\n\t// fp_order - zero for a new rule, non-zero if editing an existing rule\r\n\t// class - user class for rule\r\n\t// frontpage - radio button option indicating type of page (for home page)\r\n\t// frontpage_multipage[] - the other information for custom pages and similar - array index matches value of 'frontpage' when selected\r\n\t// frontpage_other - URL for 'other' home page\r\n\t// fp_force_page - radio button option indicating type of page (for post-login page)\r\n\t// fp_force_page_multipage[] - the other information for custom pages and similar - array index matches value of 'frontpage' when selected\r\n\t// fp_force_page_other - URL for forced post-login 'other' page\r\n\r\n\r\n\tif($_POST['frontpage'] == 'other')\r\n\t{\r\n\t\t$_POST['frontpage_other'] = trim($tp->toForm($_POST['frontpage_other']));\r\n\t\t$frontpage_value = $_POST['frontpage_other'] ? $_POST['frontpage_other'] : 'news.php';\r\n\t}\r\n\telse\r\n\t{\r\n\t\tif(is_array($front_page[$_POST['frontpage']]['page']))\r\n\t\t{\r\n\t\t\t$frontpage_value = $front_page[$_POST['frontpage']]['page'][$_POST['frontpage_multipage'][$_POST['frontpage']]]['page'];\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$frontpage_value = $front_page[$_POST['frontpage']]['page'];\r\n\t\t}\r\n\t}\r\n\r\n\tif($_POST['fp_force_page'] == 'other')\r\n\t{\r\n\t\t$_POST['fp_force_page_other'] = trim($tp->toForm($_POST['fp_force_page_other']));\r\n\t\t$forcepage_value = $_POST['fp_force_page_other']; // A null value is allowable here\r\n\t}\r\n\telse\r\n\t{\r\n\t\tif(is_array($front_page[$_POST['fp_force_page']]['page']))\r\n\t\t{\r\n\t\t\t$forcepage_value = $front_page[$_POST['fp_force_page']]['page'][$_POST['fp_force_page_multipage'][$_POST['fp_force_page']]]['page'];\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$forcepage_value = $front_page[$_POST['fp_force_page']]['page'];\r\n\t\t}\r\n\t}\r\n\r\n\t$temp = array('order' => intval($_POST['fp_order']), 'class' => $_POST['class'], 'page' => $frontpage_value, 'force' => trim($forcepage_value));\r\n\r\n\tif($temp['order'] == 0) // New index to add\r\n\t{\r\n\t\t$ind = 0;\r\n\t\tfor($i = 1; $i <= count($fp_settings); $i ++)\r\n\t\t{\r\n\t\t\tif($fp_settings[$i]['class'] == $temp['class'])\r\n\t\t\t\t$ind = $i;\r\n\t\t}\r\n\r\n\t\tif($ind)\r\n\t\t{\r\n\t\t\t$mes->addDebug(print_a($fp_settings,true));\r\n\t\t\t$mes->addError(FRTLAN_56.\" \".$ind);\r\n\t\t\tunset($fp_settings[$ind]); // Knock out duplicate definition for class\r\n\t\t}\r\n\r\n\t\tarray_unshift($fp_settings, $temp); // Deliberately add twice\r\n\t\tarray_unshift($fp_settings, $temp); // ....because re-indexed from zero\r\n\t\tunset($fp_settings[0]); // Then knock out index zero\r\n\t\t$fp_update_prefs = TRUE;\r\n\t\tfrontpage_adminlog('02', \"class => {$_POST['class']},[!br!]page => {$frontpage_value},[!br!]force => {$forcepage_value}\");\r\n\t}\r\n\telseif(array_key_exists($temp['order'], $fp_settings))\r\n\t{\r\n\t\t$fp_settings[$temp['order']] = $temp;\r\n\t\t$fp_update_prefs = TRUE;\r\n\t\tfrontpage_adminlog('03', \"posn => {$temp},[!br!]class => {$_POST['class']},[!br!]page => {$frontpage_value},[!br!]force => {$forcepage_value}\");\r\n\t}\r\n\telse\r\n\t{ // Someone playing games\r\n\t\t$mes->addError(FRTLAN_57);\r\n\t}\r\n}\r\n\r\nif(isset($_POST['fp_delete_rule']))\r\n{\r\n\tif(isset($fp_settings[key($_POST['fp_delete_rule'])]))\r\n\t{\r\n\t\t$rule_no = key($_POST['fp_delete_rule']);\r\n\t\t$array_size = count($fp_settings);\r\n\t\tfrontpage_adminlog('04', \"Rule {$rule_no},[!br!]class => {$fp_settings[$rule_no]['class']},[!br!]page => {$fp_settings[$rule_no]['page']},[!br!]force => {$fp_settings[$rule_no]['force']}\");\r\n\t\tunset($fp_settings[$rule_no]);\r\n\t\twhile($rule_no < $array_size)\r\n\t\t{ // Move up and renumber any entries after the deleted rule\r\n\t\t\t$fp_settings[$rule_no] = $fp_settings[$rule_no + 1];\r\n\t\t\t$rule_no ++;\r\n\t\t\tunset($fp_settings[$rule_no]);\r\n\t\t}\r\n\t\t$fp_update_prefs = TRUE;\r\n\t}\r\n}\r\n\r\nif($fp_update_prefs)\r\n{ // Save the two arrays\r\n\t$fp_list = array();\r\n\t$fp_force = array();\r\n\tfor($i = 1; $i <= count($fp_settings); $i ++)\r\n\t{\r\n\t\t$fp_list[$fp_settings[$i]['class']] = $fp_settings[$i]['page'];\r\n\t\t$fp_force[$fp_settings[$i]['class']] = $fp_settings[$i]['force'];\r\n\t}\r\n\r\n\t$corePrefs = e107::getConfig('core');\t\t\t\t// Core Prefs Object.\r\n\t$corePrefs->set('frontpage', $fp_list);\r\n\t$corePrefs->set('frontpage_force', $fp_force);\r\n\t$result = $corePrefs->save(FALSE, TRUE);\r\n\t$mes->addDebug(\"<h4>Home</h4>\".print_a($fp_list, true));\r\n\t$mes->addDebug(\"<h4>Post-Login</h4>\".print_a($fp_force, true));\r\n}\r\n\r\n\r\n\r\n\r\n// All updates complete now - latest data is in the $fp_settings, $fp_list and $fp_force arrays\r\n$fp = new frontpage($front_page);\r\n\r\n\r\n\r\n\r\n\r\nclass frontpage\r\n{\r\n\tprotected\t$frm;\r\n\tprotected\t$frontPage = array();\t\t// List of options for front page\r\n\r\n\tpublic function __construct($fp)\r\n\t{\r\n\t\t$this->frm = e107::getForm();\r\n\t\t$this->frontPage = $fp;\r\n\t\t\r\n\t\t$ns = e107::getRender();\r\n\t\t$mes = e107::getMessage();\r\n\t\t\r\n\t\tglobal $fp_settings;\r\n\t\t\r\n\t\t\r\n\t\tif(vartrue($_GET['mode']) == 'create')\r\n\t\t{\r\n\t\t\t$text = $this->edit_rule(array('order' => 0, 'class' => e_UC_PUBLIC, 'page' => 'news.php', 'force' => FALSE)); // Display edit form as well\r\n\t\t//\t$text .= $this->select_class($fp_settings, FALSE);\r\n\t\t\t$ns->tablerender(FRTLAN_PAGE_TITLE.SEP.FRTLAN_42, $text);\r\n\t\t}\r\n\t\telseif(vartrue($_GET['id']))\r\n\t\t{\r\n\t\t\t$key = intval($_GET['id']);\r\n\t\t\t$text = $this->edit_rule($fp_settings[$key]); // Display edit form as well\r\n\t\t//\t$text .= $this->select_class($fp_settings, FALSE);\r\n\t\t\t$ns->tablerender(FRTLAN_PAGE_TITLE.SEP.FRTLAN_46, $text);\r\n\t\t}\r\n\t\telse\r\n\t\t{ // Just show existing rules\r\n\t\t\t$ns->tablerender(FRTLAN_PAGE_TITLE.SEP.FRTLAN_13, $mes->render().$this->select_class($fp_settings, TRUE));\r\n\t\t}\r\n\t\t\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\t *\tShow a list of existing rules, with edit/delete/move buttons, and optional button to add a new rule\r\n\t *\r\n\t *\t@param boolean $show_button - show the 'Add new rule' button if true\r\n\t *\r\n\t *\t@return string text for display\r\n\t */\r\n\tfunction select_class(&$fp_settings, $show_button = TRUE)\r\n\t{\r\n\t\t$frm = e107::getForm();\r\n\t\t// List of current settings\r\n\t\t$show_legend = $show_button ? \" class='e-hideme'\" : '';\r\n\t\t$text = \"\r\n\t\t<form method='post' action='\".e_SELF.\"'>\r\n\t\t<input type='hidden' name='e-token' value='\".e_TOKEN.\"' />\r\n\t\t\t<fieldset id='frontpage-settings'>\r\n\t\t\t\t<legend{$show_legend}>\".FRTLAN_13.\"</legend>\r\n\r\n\t\t\t\t<table class='table adminlist'>\r\n\t\t\t\t\t<colgroup>\r\n\t\t\t\t\t\t<col style='width:  5%' />\r\n\t\t\t\t\t\t<col style='width: 25%' />\r\n\t\t\t\t\t\t<col style='width: 30%' />\r\n\t\t\t\t\t\t<col style='width: 25%' />\r\n\t\t\t\t\t\t<col style='width: 15%' />\r\n\t\t\t\t\t</colgroup>\r\n\t\t\t\t\t<thead>\r\n\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t<th class='first left'>\".LAN_ORDER.\"</th>\r\n\t\t\t\t\t\t\t<th>\".LAN_USERCLASS.\"</th>\r\n\t\t\t\t\t\t\t<th>\".FRTLAN_49.\"</th>\r\n\t\t\t\t\t\t\t<th>\".FRTLAN_35.\"</th>\r\n\t\t\t\t\t\t\t<th class='center last'>\".LAN_OPTIONS.\"</th>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t</thead>\r\n\t\t\t\t\t<tbody>\";\r\n\r\n\t\tforeach($fp_settings as $order => $current_value)\r\n\t\t{\r\n\t\t\t$title = e107::getUserClass()->getName($current_value['class']);\r\n\t\t\t$text .= \"\r\n\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t<td class='left'>\".$order.\"</td>\r\n\t\t\t\t\t\t<td>\".$title.\"</td>\r\n\t\t\t\t\t\t<td>\".$this->lookup_path($current_value['page']).\"</td>\r\n\t\t\t\t\t\t<td>\".$this->lookup_path($current_value['force']).\"</td>\r\n\t\t\t\t\t\t<td class='center options last'>\r\n\t\t\t\t\t\t<div class='btn-group'>\";\r\n\r\n\t\t\t\t\t//\t\t\".$frm->admin_button('fp_inc',$order,'up',ADMIN_UP_ICON).\"\r\n\t\t\t\t\t//\t\t\".$frm->admin_button('fp_dec',$order,'down',ADMIN_DOWN_ICON).\"\r\n\r\n\t\t\t\t\t\t$text .= \"\r\n\t\t\t\t\t\t\t<a class='btn btn-default' title='\".LAN_EDIT.\"' href='\".e_SELF.\"?id=\".$order.\"' >\".ADMIN_EDIT_ICON.\"</a>\r\n\t\t\t\t\t\t\t\".$frm->admin_button('fp_delete_rule['.$order.']',$order,'',ADMIN_DELETE_ICON).\"\t\t\t\t\t\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</td>\r\n\t\t\t\t\t</tr>\";\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t}\r\n\t\t$text .= \"\r\n\t\t \t\t</tbody>\r\n\t\t \t</table>\";\r\n\r\n\t\tif($show_button)\r\n\t\t{\r\n\t\t\t$text .= \"\r\n\t\t\t\t<div class='buttons-bar center'>\r\n\t\t\t\t\t <a href='\".e_SELF.\"?mode=create' class='btn btn-success'>\".FRTLAN_42.\"</a>\r\n\t\t\t\t</div>\";\r\n\t\t}\r\n\r\n\t\t$text .= \"\r\n\t\t\t</fieldset>\r\n\t\t\t</form>\";\r\n\r\n\t\treturn $text;\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\t *\tDisplay form to add/edit rules\r\n\t *\r\n\t *\t@param array $rule_info - initial data (must be preset if new rule)\r\n\t *\r\n\t *\t@return string - text for display\r\n\t */\r\n\tfunction edit_rule($rule_info)\r\n\t{\r\n\t\t$is_other_home = TRUE;\r\n\t\t$is_other_force = TRUE;\r\n\t\t//$force_checked = $rule_info['force'] ? \" checked='checked'\" : '';\r\n\t\t$text_tmp_1 = '';\r\n\t\t$text_tmp_2 = '';\r\n\t\tforeach($this->frontPage as $front_key => $front_value)\r\n\t\t{\r\n\t\t\t//$type_selected = FALSE;\r\n\r\n\t\t\t$text_tmp_1 .= \"\r\n\t\t\t<tr>\r\n\t\t\t\t\".$this->show_front_val('frontpage', $front_key, $front_value, $is_other_home, $rule_info['page']).\"\r\n\t\t\t</tr>\r\n\t\t  \t\";\r\n\r\n\t\t\t$text_tmp_2 .= \"\r\n\t\t\t<tr>\r\n\t\t\t\t\".$this->show_front_val('fp_force_page', $front_key, $front_value, $is_other_force, $rule_info['force']).\"\r\n\t\t\t</tr>\r\n\t\t  \t\";\r\n\r\n\t\t}\r\n\r\n// <legend class='e-hideme'>\".($rule_info['order'] ? FRTLAN_46 : FRTLAN_42).\"</legend>\r\n\r\n\t\t$text = \"\r\n\t\t<form method='post' action='\".e_SELF.\"'>\r\n\t\t<input type='hidden' name='e-token' value='\".e_TOKEN.\"' />\r\n\t\t\";\r\n\t\t\r\n\t\t$text .= '<ul class=\"nav nav-tabs\" id=\"myTabs\">\r\n\t\t\t<li class=\"active\"><a data-toggle=\"tab\" href=\"#home\">'.FRTLAN_49.'</a></li>\r\n\t\t\t<li><a data-toggle=\"tab\" href=\"#postlogin\">'.FRTLAN_35.'</a></li>\r\n\t\t\t</ul>\r\n\t\t\t ';\r\n\t\t\t\r\n\t\t\t$text .= \"\r\n\t\t\t<div class='tab-content'>\t\r\n\t\t\t\t<div class='tab-pane active' id='home'>\r\n\t\t\t\t\t<table class='table adminform'>\r\n\t\t\t\t\t\t<colgroup>\r\n\t\t\t\t\t\t\t<col style='width: 20%' />\r\n\t\t\t\t\t\t\t<col style='width: 80%' />\r\n\t\t\t\t\t\t</colgroup>\r\n\t\t\t\t\t\t<tbody>\r\n\t\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t<td>Selection</td>\r\n\t\t\t\t\t\t\t<td>\r\n\t\t\t\t\t\t\t\t<table class='table table-striped table-bordered'>\r\n\t\t\t\t\t\t\t\t\t<colgroup>\r\n\t\t\t\t\t\t\t\t\t\t<col style='width: 20%' />\r\n\t\t\t\t\t\t\t\t\t\t<col style='width: 80%' />\r\n\t\t\t\t\t\t\t\t\t</colgroup>\r\n\t\t\t\t\t\t\t\t\t\".$text_tmp_1.\"\r\n\t\t\t\t\t\t\t\t\t\".$this->add_other('frontpage', $is_other_home, $rule_info['page']).\"\r\n\t\t\t\t\t\t\t\t</table>\r\n\t\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t\t</tr>\r\n\r\n\t\t\t\t\t\t</tbody>\r\n\t\t\t\t\t</table>\r\n\t\t\t\t</div>\r\n\t\t\t\t\r\n\t\t\t\t<div class='tab-pane' id='postlogin'>\r\n\t\t\t\t\t<table class='table adminform'>\r\n\t\t\t\t\t\t<colgroup>\r\n\t\t\t\t\t\t\t<col style='width: 20%' />\r\n\t\t\t\t\t\t\t<col style='width: 80%' />\r\n\t\t\t\t\t\t</colgroup>\r\n\t\t\t\t\t\t<tbody><tr>\r\n\t\t\t\t\t\t\t<td></td>\r\n\t\t\t\t\t\t\t<td>\r\n\t\t\t\t\t\t\t\t<table class='table table-striped table-bordered'>\r\n\t\t\t\t\t\t\t\t<colgroup>\r\n\t\t\t\t\t\t\t\t\t<col style='width: 20%' />\r\n\t\t\t\t\t\t\t\t\t<col style='width: 80%' />\r\n\t\t\t\t\t\t\t\t</colgroup>\r\n\t\t\t\t\t\t\t\t\".$text_tmp_2.\"\r\n\t\t\t\t\t\t\t\t\".$this->add_other('fp_force_page', $is_other_force, $rule_info['force']).\"\r\n\t\t\t\t\t\t\t\t</table>\r\n\t\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t\t</tr>\r\n\r\n\t\t\t\t\t\t</tbody>\r\n\t\t\t\t\t</table>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<table class='table adminform'>\r\n\t\t\t\t<colgroup>\r\n\t\t\t\t\t<col style='width: 20%' />\r\n\t\t\t\t\t<col style='width: 80%' />\r\n\t\t\t\t</colgroup>\r\n\t\t\t\t<tr>\r\n\t\t\t\t\t<td>\".FRTLAN_43.\"</td>\r\n\t\t\t\t\t<td>\".e107::getUserClass()->uc_dropdown('class', $rule_info['class'], 'public,guest,member,admin,main,classes').\"</td>\r\n\t\t\t\t</tr>\r\n\t\t\t\t<tr>\r\n\t\t\t\t\t<td>\".LAN_ORDER.\"</td>\r\n\t\t\t\t\t<td>\".$this->frm->number('fp_order', $rule_info['order'], 3, 'min=0').\"</td>\r\n\t\t\t\t</tr>\r\n\t\t\t</table>\r\n\t\t\t\r\n\t\t\t\t<div class='buttons-bar center form-inline'>\r\n\r\n\t\t\t\t\t\".$this->frm->admin_button('fp_save_new', LAN_UPDATE, 'update').\"\r\n\t\t\t\t\t\".$this->frm->admin_button('fp_cancel', LAN_CANCEL, 'cancel').\"\r\n\t\t\t\t</div>\r\n\t\t\t\r\n\t\t</form>\r\n\t\t\";\r\n\t\treturn $text;\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\t *\tGiven a path string related to a choice, returns the 'type' (title) for it\r\n\t *\r\n\t *\t@param string $path\r\n\t *\r\n\t *\t@return string - title of option\r\n\t */\r\n\tfunction lookup_path($path)\r\n\t{\r\n\t\tforeach($this->frontPage as $front_value)\r\n\t\t{\r\n\t\t\tif(is_array($front_value['page']))\r\n\t\t\t{ // Its a URL with multiple options\r\n\t\t\t\tforeach($front_value['page'] as $multipage)\r\n\t\t\t\t{\r\n\t\t\t\t\tif($path == $multipage['page'])\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t//\t\t\t  return $front_value['title'].\":\".$path;\r\n\t\t\t\t\t\treturn $front_value['title'].\":\".$multipage['title'];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif($path == $front_value['page'])\r\n\t\t\t\t{\r\n\t\t\t\t\treturn $front_value['title'];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(strlen($path))\r\n\t\t\treturn FRTLAN_51.\":\".$path; // 'Other'\r\n\t\telse\r\n\t\t\treturn LAN_NONE; // 'None'\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\t *\tShow the selection options for a possible target of a rule\r\n\t *\r\n\t *\t@param string $ob_name - name of the radio button which selects this element \r\n\t *\t@param string $front_key \r\n\t *\t@param array|string $front_value - array of choices, or a single value\r\n\t *\t@param boolean $is_other - passed by reference - set if some other option is selected\r\n\t *\t@param string $current_setting - current value\r\n\t *\r\n\t *\t@return string - text for display\r\n\t */\r\n\tfunction show_front_val($ob_name, $front_key, $front_value, &$is_other, $current_setting)\r\n\t{\r\n\t\t$type_selected = FALSE;\r\n\t\t$text = '';\r\n\r\n\t\t// First, work out if the selection os one of these options\r\n\t\tif (is_array($front_value['page']))\r\n\t\t{ // Its a URL with multiple options\r\n\t\t\tforeach($front_value['page'] as $multipage)\r\n\t\t\t{\r\n\t\t\t\tif($current_setting == $multipage['page'])\r\n\t\t\t\t{\r\n\t\t\t\t\t$type_selected = TRUE;\r\n\t\t\t\t\t$is_other = FALSE;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tif($current_setting == $front_value['page'])\r\n\t\t\t{\r\n\t\t\t\t$type_selected = TRUE;\r\n\t\t\t\t$is_other = FALSE;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Now generate the display text - two table cells worth\r\n\t\tif (is_array($front_value['page']))\r\n\t\t{ // Multiple options for same page name\r\n\t\t\t$text .= \"\r\n\t\t\t\t<td>\r\n\t\t\t\t\t\".$this->frm->radio($ob_name, $front_key, $type_selected, array('label'=>$front_value['title'])).\"\r\n\t\t\t\t</td>\r\n\t\t\t\t<td>\r\n\t\t\t\";\r\n\t\t\t$text .= $this->frm->select_open($ob_name.'_multipage['.$front_key.']', 'size=xxlarge');\r\n\t\t\tforeach($front_value['page'] as $multipage_key => $multipage_value)\r\n\t\t\t{\r\n\t\t\t\t$text .= \"\\n\".$this->frm->option($multipage_value['title'], $multipage_key, ($current_setting == $multipage_value['page'])).\"\\n\";\r\n\t\t\t}\r\n\t\t\t$text .= $this->frm->select_close();\r\n\r\n\r\n\t\t\t$text .= \"</td>\";\r\n\t\t}\r\n\t\telse\r\n\t\t{ // Single option for URL\r\n\t\t\t$text .= \"\r\n\t\t\t\t<td>\r\n\t\t\t\t\t\".$this->frm->radio($ob_name, $front_key, $type_selected, array('label'=>$front_value['title'])).\"\r\n\r\n\t\t\t\t</td>\r\n\t\t\t\t<td>\".vartrue($front_value['diz'],\"&nbsp;\").\"</td>\";\r\n\t\t}\r\n\t\treturn $text;\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\t *\tProvide the text for an 'other' option - a text box for URL entry\r\n\t *\r\n\t *\t@param string $ob_name - name of the radio button which selects this element \r\n\t *\t@param string $front_key \r\n\t *\t@param string $curval - current 'selected' value\r\n\t *\t@param string $cur_page - probably the secondary (e.g. custom page) value for any option that has one\r\n\t *\r\n\t *\t@return string - text for display\r\n\t */\r\n\tfunction add_other($ob_name, $cur_val, $cur_page)\r\n\t{\r\n\t\t$label = ($cur_val) ? LAN_CUSTOM_URL_DISABLED : LAN_CUSTOM_URL;\r\n\t\t\r\n\t  \treturn  \"\r\n\t\t\t<td>\".$this->frm->radio($ob_name, 'other', $cur_val, array('label'=> $label)).\"</td>\r\n\t\t\t<td>\".$this->frm->text($ob_name.'_other', ($cur_val ? $cur_page : ''), 150, \"size=xxlarge&id={$ob_name}-other-txt\").\"</td>\r\n\t\t\";\r\n\t}\r\n}\r\n\r\nrequire_once(e_ADMIN.'footer.php');\r\n\r\n/**\r\n *\tLog event to admin log\r\n *\r\n *\t@param string $msg_num - exactly two numeric characters corresponding to a log message\r\n *\t@param string $woffle - information for the body of the log entre\r\n *\r\n *\t@return none\r\n */\r\nfunction frontpage_adminlog($msg_num = '00', $woffle = '')\r\n{\r\n\te107::getAdminLog()->log_event('FRONTPG_'.$msg_num, $woffle, E_LOG_INFORMATIVE, '');\r\n}\r\n\r\n\r\nfunction frontpage_adminmenu() \r\n{\r\n\r\n\t$action = vartrue($_GET['mode'],'main');\r\n\t\r\n\t$var['main']['text'] = LAN_MANAGE;\r\n\t$var['main']['link'] = e_SELF;\r\n\t$var['create']['text'] = LAN_CREATE;\r\n\t$var['create']['link'] = e_SELF.\"?mode=create\";\r\n\r\n\t\t$icon  = e107::getParser()->toIcon('e-frontpage-24');\r\n\t\t$caption = $icon.\"<span>\".FRTLAN_PAGE_TITLE.\"</span>\";\r\n\r\n\r\n\tshow_admin_menu($caption, $action, $var);\r\n}\r\n\r\n\r\n?>", "<?php\n/*\n * e107 website system\n *\n * Copyright (C) 2008-2013 e107 Inc (e107.org)\n * Released under the terms and conditions of the\n * GNU General Public License (http://www.gnu.org/licenses/gpl.txt)\n *\n * Administration Area - Meta Tags\n *\n *\n*/\nif(!empty($_POST) && !isset($_POST['e-token']))\n{\n\t$_POST['e-token'] = '';\n}\nrequire_once(\"../class2.php\");\n\nif (!getperms(\"T\")) \n{\n\te107::redirect('admin');\n\texit;\n}\n\ne107::coreLan('meta', true);\n\n$e_sub_cat = 'meta';\nrequire_once(\"auth.php\");\n\n$mes = e107::getMessage();\n$frm = e107::getForm();\n$ns = e107::getRender();\n\nif (isset($_POST['metasubmit']))\n{\n\t$tmp = $pref['meta_tag'];\n\t$langs = explode(\",\",e_LANLIST);\n\tforeach($langs as $lan)\n\t{\n\t\t$meta_tag[$lan] = $tmp[$lan];\n\t\t$meta_diz[$lan] = $pref['meta_description'][$lan];\n\t\t$meta_keywords[$lan] = $pref['meta_keywords'][$lan];\n\t\t$meta_copyright[$lan] = $pref['meta_copyright'][$lan];\n\t\t$meta_author[$lan] = $pref['meta_author'][$lan];\n\t}\n\n\t$meta_tag[e_LANGUAGE] = strip_if_magic(chop($_POST['meta']));\n\t$meta_diz[e_LANGUAGE] = strip_if_magic(chop($_POST['meta_description']));\n\t$meta_keywords[e_LANGUAGE] = strip_if_magic(chop($_POST['meta_keywords']));\n\t$meta_copyright[e_LANGUAGE] = strip_if_magic(chop($_POST['meta_copyright']));\n\t$meta_author[e_LANGUAGE] = strip_if_magic(chop($_POST['meta_author']));\n\n    $pref['meta_news_summary'] = intval($_POST['meta_news_summary']);\n\t$pref['meta_tag'] = $meta_tag;\n\t$pref['meta_description'] = $meta_diz;\n\t$pref['meta_keywords'] = $meta_keywords;\n\t$pref['meta_copyright'] = $meta_copyright;\n\t$pref['meta_author'] = $meta_author;\n\n   /*\n    if($pref['meta_tag'][e_LANGUAGE] == \"\"){\n        unset($meta_tag[e_LANGUAGE]);\n    }*/\n\n\te107::getLog()->add('META_01', 'meta_news_summary=>'.$pref['meta_news_summary'].'[!br!]'.e_LANGUAGE, E_LOG_INFORMATIVE, '');\n\tsave_prefs();\n}\n\n$meta \t\t\t= vartrue($pref['meta_tag']);\n$meta_diz \t\t= vartrue($pref['meta_description']);\n$meta_keywords \t= vartrue($pref['meta_keywords']);\n$meta_copyright = vartrue($pref['meta_copyright']);\n$meta_author \t= vartrue($pref['meta_author']);\n\n\n$text = \"\n\t<form method='post' action='\".e_SELF.\"' id='dataform'>\n\t\t<fieldset id='core-meta-settings'>\n\t\t\t<legend class='e-hideme'>\".METLAN_00.\" (\".e_LANGUAGE.\")\".\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".LAN_DESCRIPTION.\"</td>\n\t\t\t\t\t\t<td>\";\n\t\t\t\t\t\t$text .= $frm->textarea('meta_description',$tp->toForm($meta_diz[e_LANGUAGE]),3,80, array('size'=>'xxlarge'));\n\t\t\t\t\t//\t$text .= \"<textarea class='tbox textarea e-autoheight' id='meta_description' name='meta_description' cols='70' rows='4'>\".$tp->toForm(varset($meta_diz[e_LANGUAGE])).\"</textarea>\";\n\t\t\t\t\t\t$text .= \"</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".LAN_KEYWORDS.\"</td>\n\t\t\t\t\t\t<td>\";\n\t\t\t\t\t\t$text .= $frm->tags('meta_keywords',$tp->toForm($meta_keywords[e_LANGUAGE]));\n\t\t\t\t\t//\t$text .= \"<textarea class='tbox textarea e-autoheight' id='meta_keywords' name='meta_keywords' cols='70' rows='4'>\".$tp->toForm(varset($meta_keywords[e_LANGUAGE])).\"</textarea>\";\n\t\t\t\t\t\t\n\t\t\t\t\t\t$text .= \"</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".LAN_COPYRIGHT.\"</td>\n\t\t\t\t\t\t<td><input class='tbox form-control input-xxlarge' size='70' type='text' name='meta_copyright' value=\\\"\".$meta_copyright[e_LANGUAGE].\"\\\" /></td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".LAN_AUTHOR.\"</td>\n\t\t\t\t\t\t<td><input class='tbox form-control input-xxlarge' size='70' type='text' name='meta_author' value=\\\"\".$meta_author[e_LANGUAGE].\"\\\" /></td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".METLAN_1.\"</td>\n\t\t\t\t\t\t<td>\";\n\t\t\t\t\t\t$text .= $frm->textarea('meta',str_replace(\"<\",\"&lt;\",$tp->toForm($meta[e_LANGUAGE])),5,100,'size=block-level');\n\t\t\t\t\t\t\n\t\t\t\t\t\t$text .= \"<span class='field-help'>\".METLAN_2.\"</span>\";\n\t\t\t\t\t\t\n\t\t\t\t//\t\t$text .= \"<textarea class='tbox textarea e-autoheight' id='meta' name='meta' cols='70' rows='10' onselect='storeCaret(this);' onclick='storeCaret(this);' onkeyup='storeCaret(this);'>\".str_replace(\"<\",\"&lt;\",$tp->toForm(varset($meta[e_LANGUAGE]))).\"</textarea><span class='field-help'>\".METLAN_2.\"</span>\";\n\t\t\t\t\t\t\n\t\t\t\t\t\t$text .= \"</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".METLAN_3.\"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t<div class='auto-toggle-area autocheck'>\".\n\t\t\t\t\t\t\t\t$frm->checkbox('meta_news_summary',1, varset($pref['meta_news_summary'])).\"\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t<div class='buttons-bar center'>\".\n\t\t\t\t$frm->admin_button('metasubmit','no-value','update', LAN_UPDATE).\"\n\t\t\t</div>\n\t\t\t<input type='hidden' name='e-token' value='\".e_TOKEN.\"' />\n\t\t</fieldset>\n\t</form>\n\";\n\n$ns->tablerender(METLAN_00.\" (\".e_LANGUAGE.\")\", $mes->render().$text);\n\nrequire_once(\"footer.php\");\n\n?>", "<?php\n/*\n * e107 website system\n *\n * Copyright (C) 2008-2013 e107 Inc (e107.org)\n * Released under the terms and conditions of the\n * GNU General Public License (http://www.gnu.org/licenses/gpl.txt)\n *\n * Plugin administration area\n *\n */\n\nrequire_once(\"../class2.php\");\n\nif(!getperms(\"Z\"))\n{\n\te107::redirect('admin');\n\texit;\n}\n\ne107::coreLan('plugin', true);\n\n$e_sub_cat = 'plug_manage';\n\ndefine('PLUGIN_SHOW_REFRESH', FALSE);\ndefine('PLUGIN_SCAN_INTERVAL', !empty($_SERVER['E_DEV']) ? 0 : 360);\ndefine(\"ADMIN_GITSYNC_ICON\", e107::getParser()->toGlyph('fa-refresh', array('size'=>'2x', 'fw'=>1)));\n\n\nglobal $user_pref;\n/*\n\nif(!deftrue('e_DEBUG_PLUGMANAGER'))\n{\n\trequire_once(e_HANDLER.'plugin_class.php');\n\trequire_once(e_HANDLER.'file_class.php');\n\t$plugin = new e107plugin;\n\t$pman = new pluginManager;\n\n\tdefine(\"e_PAGETITLE\",ADLAN_98.\" - \".$pman->pagetitle);\n}\n*/\n\nif(isset($_POST['uninstall_cancel']))\n{\n\theader(\"location:\".e_SELF);\n\texit;\t\t\n}\n\n\n// Experimental rewrite for v2.1.5 ----------------------\n\n\n\n\nclass plugman_adminArea extends e_admin_dispatcher\n{\n\n\tprotected $modes = array(\n\n\t\t'installed'\t=> array(\n\t\t\t'controller' \t=> 'plugin_ui',\n\t\t\t'path' \t\t\t=> null,\n\t\t\t'ui' \t\t\t=> 'plugin_form_ui',\n\t\t\t'uipath' \t\t=> null\n\t\t),\n\t\t'avail'\t=> array(\n\t\t\t'controller' \t=> 'plugin_ui',\n\t\t\t'path' \t\t\t=> null,\n\t\t\t'ui' \t\t\t=> 'plugin_form_ui',\n\t\t\t'uipath' \t\t=> null\n\t\t),\n\t\t'online'\t=> array(\n\t\t\t'controller' \t=> 'plugin_online_ui',\n\t\t\t'path' \t\t\t=> null,\n\t\t\t'ui' \t\t\t=> 'plugin_form_ui',\n\t\t\t'uipath' \t\t=> null\n\t\t),\n\t\t'create'\t=> array(\n\t\t\t'controller' \t=> 'plugin_ui',\n\t\t\t'path' \t\t\t=> null,\n\t\t\t'ui' \t\t\t=> 'plugin_form_ui',\n\t\t\t'uipath' \t\t=> null\n\t\t),\n\n\t);\n\n\n\tprotected $adminMenu = array(\n\n\t\t'installed/list'\t\t=> array('caption'=> EPL_ADLAN_22, 'perm' => 'Z'),\n\t\t'avail/list'\t\t\t=> array('caption'=> EPL_ADLAN_23, 'perm' => 'Z'),\n\t\t'online/list'\t\t\t=> array('caption'=> EPL_ADLAN_220, 'perm' => 'Z'),\n\t\t'avail/upload'\t\t\t=> array('caption'=>EPL_ADLAN_38, 'perm' => '0'),\n\t\t'create/build'          =>  array('caption'=>EPL_ADLAN_114, 'perm' => '0'),\n\n\t//\t'main/create'\t\t=> array('caption'=> LAN_CREATE, 'perm' => 'P'),\n\n\t\t// 'main/custom'\t\t=> array('caption'=> 'Custom Page', 'perm' => 'P')\n\t);\n\n\n\tprotected $defaultMode = 'installed';\n\n\n\tprotected $adminMenuAliases = array(\n\t\t'installed/uninstall'\t=> 'installed/list'\n\n\t);\n\n\tprotected $adminMenuIcon = 'e-plugmanager-24';\n\n\tfunction init()\n\t{\n\n\t\t$mode = $this->getRequest()->getMode();\n\t\t$action = $this->getRequest()->getAction();\n\n\t\tif($mode === 'online' && $action === 'download')\n\t\t{\n\t\t\tdefine('e_IFRAME', true);\n\t\t}\n\t}\n\n\n\tpublic static function getPluginManagerFields()\n\t{\n\n\t\treturn array(\n\t\t\t\t'checkboxes'         => array('title' => '', 'type' => null, 'data' => null, 'width' => '5%', 'thclass' => 'center', 'forced' => '1', 'class' => 'center', 'toggle' => 'e-multiselect',),\n\t\t        'plugin_id'          => array('title' => LAN_ID, 'data' => 'int', 'width' => '5%', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\t\t\t\t'plugin_icon'        => array('title' => LAN_ICON, 'type' => 'icon', 'data' => false, \"width\" => \"5%\", 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\t\t        'plugin_name'        => array('title' => LAN_TITLE, 'type' => 'text', 'data' => 'str', 'width' => 'auto', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\t\t        'plugin_version'     => array('title' => LAN_VERSION, 'type' => 'text', 'data' => false, 'width' => 'auto', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\t\t\t\t'plugin_date'       => array('title' => LAN_RELEASED, 'type' => 'text', 'data' => false,  \"width\" => \"8%\", 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\t\t\t    'plugin_category'    => array('title' => LAN_CATEGORY, 'type' => 'dropdown', 'data' => 'str', 'width' => 'auto', 'batch' => true, 'filter' => true, 'inline' => true, 'help' => '', 'readParms' => '', 'writeParms' => array(), 'class' => 'left', 'thclass' => 'left',),\n\n\t\t\t\t'plugin_author'      => array('title' => LAN_AUTHOR, 'type' => 'text', 'data' => false, 'width' => 'auto', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\t\t\t\t\"plugin_license\"\t => array(\"title\" => \"License\", \t 'nolist'=>false,'data'=>false,\t \"type\"=>\"text\", \"width\" => \"5%\", \"thclass\" => \"left\"),\n  \t\t\t\t'plugin_compatible'  => array('title' => EPL_ADLAN_13, 'type' => 'method', 'data' => false, 'width' => 'auto', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'center', 'thclass' => 'center',),\n\t\t\t\t'plugin_description' => array('title' => LAN_DESCRIPTION, 'type' => 'textarea', 'data' => false, 'width' => 'auto', 'help' => '', 'readParms' => 'expand=1&truncate=180&bb=1', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\n\t\t\t\t'plugin_path'        => array('title' => LAN_PATH, 'type' => 'text', 'data' => 'str', 'width' => 'auto', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\t\t        'plugin_installflag' => array('title' => EPL_ADLAN_22, 'type' => 'boolean', 'data' => 'int', 'width' => 'auto', 'filter' => false, 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'center', 'thclass' => 'center',),\n\t\t        'plugin_addons'      => array('title' => LAN_ADDONS, 'type' => 'method', 'data' => 'str', 'width' => 'auto', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',),\n\t\t         'options'            => array('title' => LAN_OPTIONS, 'type' => 'method', 'data' => null, 'width' => '10%', 'thclass' => 'center last', 'class' => 'center last', 'forced' => '1',),\n\t\t);\n\n\n\t}\n\n\n\n\n\tprotected $menuTitle = ADLAN_98;\n}\n\n\n\n\n\nclass plugin_ui extends e_admin_ui\n{\n\n\t\tprotected $pluginTitle\t\t= ADLAN_98;\n\t\tprotected $pluginName\t\t= 'core';\n\t//\tprotected $eventName\t\t= 'plugman-plugin'; // remove comment to enable event triggers in admin.\n\t\tprotected $table\t\t\t= 'plugin';\n\t\tprotected $pid\t\t\t\t= 'plugin_id';\n\t\tprotected $perPage\t\t\t= 10;\n\t\tprotected $batchDelete\t\t= false;\n\t\tprotected $batchExport     = false;\n\t\tprotected $batchCopy\t\t= false;\n\t//\tprotected $sortField\t\t= 'somefield_order';\n\t//\tprotected $orderStep\t\t= 10;\n\t//\tprotected $tabs\t\t\t\t= array('Tabl 1','Tab 2'); // Use 'tab'=>0  OR 'tab'=>1 in the $fields below to enable.\n\n\t\tprotected $listQry      \t= \"SELECT * FROM `#plugin` WHERE plugin_installflag = 1 AND plugin_category != 'menu' \"; // Example Custom Query. LEFT JOINS allowed. Should be without any Order or Limit.\n\n\t\tprotected $listOrder\t\t= 'plugin_path ASC';\n\n\t\tprotected $fields = array();\n\n\t\tprotected $fieldpref = array('plugin_icon', 'plugin_name', 'plugin_version', 'plugin_description', 'plugin_compatible', 'plugin_released','plugin_author', 'plugin_category','plugin_installflag');\n\n\n\t//\tprotected $preftabs        = array('General', 'Other' );\n\t\tprotected $prefs = array(\n\t\t);\n\n\t\t// Ideal way to set field data.\n\n\t\tpublic function __construct($request, $response, $params = array())\n\t\t{\n\t\t\t$this->fields = plugman_adminArea::getPluginManagerFields();\n\t\t\t$this->fields['plugin_category']['writeParms']['optArray'] = e107::getPlug()->getCategoryList(); // array('plugin_category_0','plugin_category_1', 'plugin_category_2'); // Example Drop-down array.\n\n\t\t\tunset($this->fields['plugin_category']['writeParms']['optArray']['menu']);\n\t\t\tunset($this->fields['plugin_category']['writeParms']['optArray']['about']);\n\n\t\t\tparent:: __construct($request, $response, $params);\n\n\t\t}\n\n\n\t\tpublic function init()\n\t\t{\n\n\t\t\tif(!e_QUERY)\n\t\t\t{\n\t\t\t\te107::getPlug()->clearCache();\n\t\t\t}\n\n\n\t\t\tif($this->getMode()=== 'avail')\n\t\t\t{\n\t\t\t\t$this->listQry  = \"SELECT * FROM `#plugin` WHERE plugin_installflag = 0 AND plugin_category != 'menu'  \";\n\t\t\t}\n\n\t\t\t// Set drop-down values (if any).\n\n\t\t}\n\n\t\t// Modify the list data.\n        public function ListObserver()\n        {\n            parent::ListObserver();\n\n\t        $this->setPlugData();\n        }\n\n\t\tprivate function setPlugData()\n\t\t{\n\t\t\t   $tree = $this->getTreeModel();\n\n\t\t\t\t$plg = e107::getPlug();\n\n\t            foreach ($tree->getTree() as $id => $model)\n\t            {\n\t\t\t\t\t$path = $model->get('plugin_path');\n\n\t\t\t\t\t$plg->load($path);\n\n\t\t            $model->set('plugin_name',$plg->getName());\n\t\t            $model->set('plugin_date',$plg->getDate());\n\t\t            $model->set('plugin_author',$plg->getAuthor());\n\t\t            $model->set('plugin_compatible',$plg->getCompat());\n\t\t            $model->set('plugin_admin_url',$plg->getAdminUrl());\n\t\t            $model->set('plugin_admin_caption', $plg->getAdminCaption());\n\t\t            $model->set('plugin_description',$plg->getDescription());\n\t\t            $model->set('plugin_version_file',$plg->getVersion());\n\t\t            $model->set('plugin_install_required',$plg->getInstallRequired());\n\t                $model->set('plugin_icon',$plg->getIcon(32, 'path'));\n\n\t            }\n\n\t\t}\n\n\n\t\tpublic function ListAjaxObserver()\n\t\t{\n\n\t\t\t$this->getTreeModel()->setParam('db_query', $this->_modifyListQry(false, false, 0, false, $this->listQry))->load();\n\n\t\t\t$this->setPlugData();\n\t\t}\n\n        private function pluginProcessUpload()\n        {\n\t\t\tif (!$_POST['ac'] == md5(ADMINPWCHANGE))\n\t\t\t{\n\t\t\t\texit;\n\t\t\t}\n\n\t\t\t$fl = e107::getFile();\n\t\t\t$data = $fl->getUploaded(e_TEMP);\n\t\t\t$mes = e107::getMessage();\n\n\t\t\tif(empty($data[0]['error']))\n\t\t\t{\n\t\t\t\tif($fl->unzipArchive($data[0]['name'],'plugin'))\n\t\t\t\t{\n\t\t\t\t\t$mes->addSuccess(EPL_ADLAN_43);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$mes->addError(EPL_ADLAN_97);\n\t\t\t\t}\n\t\t\t}\n\n\n\t\t\t//echo $mes->render();\n\n\t\t\treturn true;\n\n\t     }\n\n\n\n\t\tfunction renderHelp()\n\t\t{\n\t\t\t$plg = e107::getPlug();\n\t\t\tif(!$list = $plg->getUpgradableList())\n\t\t\t{\n\t\t\t\treturn null;\n\t\t\t}\n\n\n\t\t\t$text = \"<ul class='media-list'>\";\n\t\t\tforeach($list as $path=>$ver)\n\t\t\t{\n\t\t\t\t$plg->load($path);\n\t\t\t\t$url = e_ADMIN.\"plugin.php?mode=installed&action=upgrade&id=\".$path;\n\t\t\t\t$text .= \"<li class='media'>\n\t\t\t\t<div class='media-left'>\n\t\t\t\t\t<a href='\".$url.\"'>\".$plg->getIcon(32).\"</a>\n\t\t\t\t\t</div><div class='media-body'><a href='\".$url.\"'>\".$plg->getName().\"</a></div></li>\";\n\n\t\t\t}\n\t\t\t$text .= \"</ul>\";\n\n\n\n\n\t\t\treturn array('caption'=>\"Updates to be Installed\", 'text'=>$text);\n\n\t\t}\n\n\t\t// Action Pages.\n\n\n\n\n\n\t\tfunction installPage()\n\t\t{\n\t\t\t$id = $this->getId();\n\n\t\t\t$text = e107::getPlugin()->install($id);\n\n\t\t\t$log = e107::getAdminLog();\n\n\t\t\tif ($text === FALSE)\n\t\t\t{\n\t\t\t\te107::getMessage()->add(EPL_ADLAN_99, E_MESSAGE_ERROR);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t//$plugin->save_addon_prefs('update');\n\t\t\t//\t$info = $plugin->getinfo($this->id);  //FIXME use e107::getPlug();\n\n\t\t\t//\t$name = deftrue($info['plugin_name'],$info['plugin_name']). \" v\".$info['plugin_version']. \"({e_PLUGIN}\".$info['plugin_path'].\")\";\n\n\t\t\t//\t$log->log_event('PLUGMAN_01', $name, E_LOG_INFORMATIVE, '');\n\n\t\t\t\te107::getMessage()->add($text, E_MESSAGE_SUCCESS);\n\t\t\t}\n\n\n\t\t\t$this->redirectAction('list');\n\t\t}\n\n\n\t\tfunction buildPage()\n\t\t{\n\t\t\t$pc = new pluginBuilder;\n\t\t\t$ret = $pc->run();\n\n\t\t\tif(is_array($ret))\n\t\t\t{\n\t\t\t\t$this->addTitle($ret['caption']);\n\t\t\t\treturn $ret['text'];\n\t\t\t}\n\n\t\t\treturn $ret;\n\t\t}\n\n\n\n\n\t\tfunction uninstallPage()\n\t\t{\n\t\t\t$id = $this->getId();\n\n\t\t\tif(empty($_POST['uninstall_confirm']))\n\t\t\t{\n\n\t\t\t\t$plug_vars = e107::getPlug()->load($id)->getMeta();\n\n\t\t\t\t$name = e107::getPlug()->getName();\n\t\t\t\t$this->addTitle(EPL_ADLAN_63);\n\t\t\t\t$this->addTitle($name);\n\n\t\t\t\treturn $this->pluginConfirmUninstall($plug_vars);\n\t\t\t}\n\n\t\t\t$post = e107::getParser()->filter($_POST);\n\n\t\t\tif(empty($_POST['e-token']))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t//\t$id = e107::getPlugin\n\n\t\t\t$text = e107::getPlugin()->uninstall($id, $post);\n\n\t\t\te107::getMessage()->add($text, E_MESSAGE_SUCCESS);\n\t\t\t$log = e107::getPlugin()->getLog();\n\t\t\te107::getDebug()->log($log);\n\n\t\t\t$this->redirectAction('list');\n\t\t}\n\n\n\n\t\tfunction repairPage()\n\t\t{\n\t\t\t$id = $this->getId();\n\n\t\t\tif(!e107::isInstalled($id))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\te107::getSingleton('e107plugin')->refresh($id);\n\t\t\te107::getLog()->add('PLUGMAN_04', $id, E_LOG_INFORMATIVE, '');\n\n\t\t\t$this->redirectAction('list');\n\t\t}\n\n\n\t\tfunction pullPage()\n\t\t{\n\t\t\t$id = $this->getId();\n\n\t\t\tif(!e107::isInstalled($id))\n\t\t\t{\n\t\t\t\t$this->redirectAction('list');\n\t\t\t}\n\n\n\t\t\t$return = e107::getFile()->gitPull($id, 'plugin');\n\t\t\te107::getMessage()->addSuccess($return);\n\t\t\te107::getPlugin()->refresh($id);\n\n\t\t\t$this->redirectAction('list');\n\t\t}\n\n\n\t\tfunction upgradePage()\n\t\t{\n\t\t\t$this->pluginUpgrade();\n\t\t}\n\n\n\n\t\tfunction uploadPage()\n\t\t{\n\n\t\t\tglobal $plugin;\n\t\t    $frm = e107::getForm();\n\t\t\tif(!empty($_POST['upload']))\n\t\t\t{\n\t            $this->pluginProcessUpload();\n\n\t\t\t\t$this->redirectAction('list');\n\t\t\t}\n\n\n\n\t\t//TODO 'install' checkbox in plugin upload form. (as it is for theme upload)\n\n\t\t/* plugin upload form */\n\n\t\t\tif(!is_writable(e_PLUGIN))\n\t\t\t{\n\t\t\t   \t$text = EPL_ADLAN_44;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t  // Get largest allowable file upload\n\t\t\t  require_once(e_HANDLER.'upload_handler.php');\n\t\t\t  $max_file_size = get_user_max_upload();\n\n\t\t\t  $text = \"\n\t\t\t\t<form enctype='multipart/form-data' method='post' action='\".e_SELF.\"'>\n                <table class='table adminform'>\n                \t<colgroup>\n                \t\t<col class='col-label' />\n                \t\t<col class='col-control' />\n                \t</colgroup>\n\t\t\t\t<tr>\n\t\t\t\t<td>\".EPL_ADLAN_37.\"</td>\n\t\t\t\t<td>\n\t\t\t\t<input type='hidden' name='MAX_FILE_SIZE' value='{$max_file_size}' />\n\t\t\t\t<input type='hidden' name='ac' value='\".md5(ADMINPWCHANGE).\"' />\n\t\t\t\t<input class='tbox' type='file' name='file_userfile[]' size='50' />\n\t\t\t\t</td>\n                </tr>\n\t\t\t\t</table>\n\n\t\t\t\t<div class='center buttons-bar'>\";\n                $text .= $frm->admin_button('upload', EPL_ADLAN_38, 'submit', EPL_ADLAN_38);\n\n\t\t\t\t$text .= \"\n\t\t\t\t</div>\n\n\t\t\t\t</form>\\n\";\n\t\t\t}\n\n\n\t\t\treturn $text;\n            e107::getRender()->tablerender(ADLAN_98.SEP.EPL_ADLAN_38, $text);\n\n\n\t\t}\n\n\t\tprivate function pluginUpgrade()\n\t\t{\n\t\t\t$pref \t\t= e107::getPref();\n\t\t\t$admin_log \t= e107::getAdminLog();\n\t\t\t$plugin \t= e107::getPlugin();\n\n\t\t    $sql \t\t= e107::getDb();\n\t        $mes \t\t= e107::getMessage();\n\n\t        $id         = $this->getId();\n\n\t\t\t$plug \t\t= e107::getPlug()->load($id)->getMeta();\n\n\t\t\t$text = '';\n\n\t\t\t$_path = e_PLUGIN.$id.'/';\n\t\t\tif(file_exists($_path.'plugin.xml'))\n\t\t\t{\n\t\t\t\t$plugin->install_plugin_xml($id, 'upgrade');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$eplug_folder = null;\n\t\t\t\t$upgrade_alter_tables = null;\n\t\t\t\t$upgrade_add_prefs = null;\n\t\t\t\t$upgrade_remove_prefs = null;\n\t\t\t\t$upgrade_add_array_pref = null;\n\t\t\t\t$upgrade_remove_array_pref = null;\n\t\t\t\t$eplug_version = null;\n\n\n\n\t\t\t\tinclude(e_PLUGIN.$plug['plugin_path'].'/plugin.php');\n\n\t\t\t\t$text = '';\n\n\t\t\t\t$func = $eplug_folder.'_upgrade';\n\t\t\t\tif (function_exists($func))\n\t\t\t\t{\n\t\t\t\t\t$text .= call_user_func($func);\n\t\t\t\t}\n\n\t\t\t\tif (is_array($upgrade_alter_tables))\n\t\t\t\t{\n\t\t\t\t\t$result = $plugin->manage_tables('upgrade', $upgrade_alter_tables);\n\t\t\t\t\tif (true !== $result)\n\t\t\t\t\t{\n\t\t\t\t\t\t//$text .= EPL_ADLAN_9.'<br />';\n\t\t\t\t\t\t$mes->addWarning(EPL_ADLAN_9)\n\t\t\t\t\t\t\t->addDebug($result);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$text .= EPL_ADLAN_7.\"<br />\";\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (is_array($upgrade_add_prefs))\n\t\t\t\t{\n\t\t\t\t\t$plugin->manage_prefs('add', $upgrade_add_prefs);\n\t\t\t\t\t$text .= EPL_ADLAN_8.'<br />';\n\t\t\t\t}\n\n\t\t\t\tif (is_array($upgrade_remove_prefs))\n\t\t\t\t{\n\t\t\t\t\t$plugin->manage_prefs('remove', $upgrade_remove_prefs);\n\t\t\t\t}\n\n\t\t\t\tif (is_array($upgrade_add_array_pref))\n\t\t\t\t{\n\t\t\t\t\tforeach($upgrade_add_array_pref as $key => $val)\n\t\t\t\t\t{\n\t\t\t\t\t\t$plugin->manage_plugin_prefs('add', $key, $eplug_folder, $val);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (is_array($upgrade_remove_array_pref))\n\t\t\t\t{\n\t\t\t\t\tforeach($upgrade_remove_array_pref as $key => $val)\n\t\t\t\t\t{\n\t\t\t\t\t\t$plugin->manage_plugin_prefs('remove', $key, $eplug_folder, $val);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t$plugin->manage_search('upgrade', $eplug_folder);\n\t\t\t\t$plugin->manage_notify('upgrade', $eplug_folder);\n\n\t\t\t\t$eplug_addons = $plugin -> getAddons($eplug_folder);\n\n\t\t\t\t$info = $plugin->getinfo($this->id);\n\n\t\t\t\t$name = deftrue($info['plugin_name'],$info['plugin_name']). \" v\".$eplug_version. \"({e_PLUGIN}\".$info['plugin_path'].\")\";\n\n\t\t\t\te107::getLog()->add('PLUGMAN_02', $name, E_LOG_INFORMATIVE, '');\n\t\t\t\t$text .= (isset($eplug_upgrade_done)) ? '<br />'.$eplug_upgrade_done : \"<br />\".LAN_UPGRADE_SUCCESSFUL;\n\t\t\t\t$sql->update('plugin', \"plugin_version ='{$eplug_version}', plugin_addons='{$eplug_addons}' WHERE plugin_id='$this->id' \");\n\t\t\t\t$pref['plug_installed'][$plug['plugin_path']] = $eplug_version; \t\t\t// Update the version\n\n\t\t\t\te107::getConfig('core')->setPref($pref);\n\t\t\t\t$plugin->rebuildUrlConfig();\n\t\t\t\te107::getConfig('core')->save();\n\t\t\t}\n\n\n\t\t\t$mes->addSuccess($text);\n\t\t\t$plugin->save_addon_prefs('update');\n\n\t\t\t$this->redirectAction('list');\n\t   }\n\n\n\n\n\t\tprivate function pluginConfirmUninstall($plug_vars)\n\t\t{\n\t\t\tglobal $plugin;\n\n\t\t\t$frm \t= e107::getForm();\n\t\t\t$tp \t= e107::getParser();\n\t\t\t$mes \t= e107::getMessage();\n\n\n\t\t\t$path = $plug_vars['folder'];\n\t\t//\t$plug = $plugin->getinfo($this->id);\n\n\t\t\tif(!e107::isInstalled($path))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t$userclasses = '';\n\t\t\t$eufields = '';\n\t\t\tif (isset($plug_vars['userClasses']))\n\t\t\t{\n\t\t\t\tif (isset($plug_vars['userclass']['@attributes']))\n\t\t\t\t{\n\t\t\t\t\t$plug_vars['userclass'][0]['@attributes'] = $plug_vars['userclass']['@attributes'];\n\t\t\t\t\tunset($plug_vars['userclass']['@attributes']);\n\t\t\t\t}\n\t\t\t\t$spacer = '';\n\t\t\t\tforeach ($plug_vars['userClasses']['class'] as $uc)\n\t\t\t\t{\n\t\t\t\t\t$userclasses .= $spacer.$uc['@attributes']['name'].' - '.$uc['@attributes']['description'];\n\t\t\t\t\t$spacer = '<br />';\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (isset($plug_vars['extendedFields']))\n\t\t\t{\n\t\t\t\tif (isset($plug_vars['extendedFields']['@attributes']))\n\t\t\t\t{\n\t\t\t\t\t$plug_vars['extendedField'][0]['@attributes'] = $plug_vars['extendedField']['@attributes'];\n\t\t\t\t\tunset($plug_vars['extendedField']['@attributes']);\n\t\t\t\t}\n\t\t\t\t$spacer = '';\n\t\t\t\tforeach ($plug_vars['extendedFields']['field'] as $eu)\n\t\t\t\t{\n\t\t\t\t\t$eufields .= $spacer.'plugin_'.$plug_vars['folder'].'_'.$eu['@attributes']['name'];\n\t\t\t\t\t$spacer = '<br />';\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif(is_writable(e_PLUGIN.$path))\n\t\t\t{\n\t\t\t\t$del_text = $frm->select('delete_files','yesno',0);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$del_text = \"\n\t\t\t\t\".EPL_ADLAN_53.\"\n\t\t\t\t<input type='hidden' name='delete_files' value='0' />\n\t\t\t\t\";\n\t\t\t}\n\n\t\t\t$text = \"\n\t\t\t<form action='\".e_SELF.\"?\".e_QUERY.\"' method='post'>\n\t\t\t<fieldset id='core-plugin-confirmUninstall'>\n\t\t\t<legend>\".EPL_ADLAN_54.\" \".$tp->toHtml($plug_vars['@attributes']['name'], \"\", \"defs,emotes_off, no_make_clickable\").\"</legend>\n            <table class='table adminform'>\n            \t<colgroup>\n            \t\t<col class='col-label' />\n            \t\t<col class='col-control' />\n            \t</colgroup>\n \t\t\t<tr>\n\t\t\t\t<td>\".EPL_ADLAN_55.\"</td>\n\t\t\t\t<td>\".LAN_YES.\"</td>\n\t\t\t</tr>\";\n\n\t\t\t$opts = array();\n\n\t\t\t$opts['delete_tables'] = array(\n\t\t\t\t\t'label'\t\t\t=> EPL_ADLAN_57,\n\t\t\t\t\t'helpText'\t\t=> EPL_ADLAN_58,\n\t\t\t\t\t'itemList'\t\t=> array(1=>LAN_YES,0=>LAN_NO),\n\t\t\t\t\t'itemDefault' \t=> 1\n\t\t\t);\n\n\t\t\tif ($userclasses)\n\t\t\t{\n\t\t\t\t$opts['delete_userclasses'] = array(\n\t\t\t\t\t'label'\t\t\t=> EPL_ADLAN_78,\n\t\t\t\t\t'preview'\t\t=> $userclasses,\n\t\t\t\t\t'helpText'\t\t=> EPL_ADLAN_79,\n\t\t\t\t\t'itemList'\t\t=> array(1=>LAN_YES,0=>LAN_NO),\n\t\t\t\t\t'itemDefault' \t=> 1\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif ($eufields)\n\t\t\t{\n\t\t\t\t$opts['delete_xfields'] = array(\n\t\t\t\t\t'label'\t\t\t=> EPL_ADLAN_80,\n\t\t\t\t\t'preview'\t\t=> $eufields,\n\t\t\t\t\t'helpText'\t\t=> EPL_ADLAN_79,\n\t\t\t\t\t'itemList'\t\t=> array(1=>LAN_YES,0=>LAN_NO),\n\t\t\t\t\t'itemDefault' \t=> 0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t$med = e107::getMedia();\n\t\t\t$icons = $med->listIcons(e_PLUGIN.$path);\n\n\t\t\t$iconText = '';\n\n\t\t\tif(count($icons)>0)\n\t\t\t{\n\t\t\t\tforeach($icons as $key=>$val)\n\t\t\t\t{\n\t\t\t\t\t$iconText .= \"<img src='\".$tp->replaceConstants($val).\"' alt='' />\";\n\t\t\t\t}\n\n\t\t\t\t$iconText = '<div class=\"icon-pool-preview\">'.$iconText.'</div>';\n\n\t\t\t\t$opts['delete_ipool'] = array(\n\t\t\t\t\t'label'\t\t\t=> EPL_ADLAN_231,\n\t\t\t\t\t'preview'\t\t=> $iconText,\n\t\t\t\t\t'helpText'\t\t=> EPL_ADLAN_79,\n\t\t\t\t\t'itemList'\t\t=> array(1=>LAN_YES,0=>LAN_NO),\n\t\t\t\t\t'itemDefault' \t=> 1\n\t\t\t\t);\n\n\n\t\t\t}\n\n\n\n\t\t\tif(is_readable(e_PLUGIN.$path.\"/\".$path.\"_setup.php\"))\n\t\t\t{\n\t\t\t\tinclude_once(e_PLUGIN.$path.\"/\".$path.\"_setup.php\");\n\n\n\t\t\t\t$mes->add(\"Loading \".e_PLUGIN.$path.\"/\".$path.\"_setup.php\", E_MESSAGE_DEBUG);\n\n\t\t\t\t$class_name = $path.\"_setup\";\n\n\t\t\t\tif(class_exists($class_name))\n\t\t\t\t{\n\t\t\t\t\t$obj = new $class_name;\n\t\t\t\t\tif(method_exists($obj,'uninstall_options'))\n\t\t\t\t\t{\n\t\t\t\t\t\t$arr = call_user_func(array($obj,'uninstall_options'), $this);\n\t\t\t\t\t\tforeach($arr as $key=>$val)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$newkey = $path.\"_\".$key;\n\t\t\t\t\t\t\t$opts[$newkey] = $val;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tforeach($opts as $key=>$val)\n\t\t\t{\n\t\t\t\t$text .= \"<tr>\\n<td class='top'>\".$tp->toHTML($val['label'],FALSE,'TITLE');\n\t\t\t\t$text .= varset($val['preview']) ? \"<div class='indent'>\".$val['preview'].\"</div>\" : \"\";\n\t\t\t\t$text .= \"</td>\\n<td>\".$frm->select($key,$val['itemList'],$val['itemDefault']);\n\t\t\t\t$text .= varset($val['helpText']) ? \"<div class='field-help'>\".$val['helpText'].\"</div>\" : \"\";\n\t\t\t\t$text .= \"</td>\\n</tr>\\n\";\n\t\t\t}\n\n\n\t\t\t$text .=\"<tr>\n\t\t\t<td>\".EPL_ADLAN_59.\"</td>\n\t\t\t<td>{$del_text}\n\t\t\t<div class='field-help'>\".EPL_ADLAN_60.\"</div>\n\t\t\t</td>\n\t\t\t</tr>\n\t\t\t</table>\n\t\t\t<div class='buttons-bar center'>\";\n\n\t\t\t$text .= $frm->admin_button('uninstall_confirm',EPL_ADLAN_3,'submit');\n\t\t\t$text .= $frm->admin_button('uninstall_cancel',EPL_ADLAN_62,'cancel');\n\n\t\t\t/*\n\t\t\t$text .= \"<input class='btn' type='submit' name='uninstall_confirm' value=\\\"\".EPL_ADLAN_3.\"\\\" />&nbsp;&nbsp;\n\t\t\t<input class='btn' type='submit' name='uninstall_cancel' value='\".EPL_ADLAN_62.\"' onclick=\\\"location.href='\".e_SELF.\"'; return false;\\\"/>\";\n\t\t\t*/\n             //   $frm->admin_button($name, $value, $action = 'submit', $label = '', $options = array());\n\n\n\n\t\t\t$text .= \"<input type='hidden' name='e-token' value='\".e_TOKEN.\"' /></div>\n\t\t\t</fieldset>\n\t\t\t</form>\n\t\t\t\";\n\n\t\t\treturn $text;\n\t\t//\te107::getRender()->tablerender(EPL_ADLAN_63.SEP.$tp->toHtml($plug_vars['@attributes']['name'], \"\", \"defs,emotes_off, no_make_clickable\"),$mes->render(). $text);\n\n\t\t}\n\t/*\n\t\t// optional - a custom page.\n\t\tpublic function customPage()\n\t\t{\n\t\t\t$text = 'Hello World!';\n\t\t\t$otherField  = $this->getController()->getFieldVar('other_field_name');\n\t\t\treturn $text;\n\n\t\t}\n\t*/\n\n}\n\n\n\nclass plugin_form_ui extends e_admin_form_ui\n{\n\n\n\t// Custom Method/Function\n\tfunction plugin_compatible($curVal,$mode)\n\t{\n\t\t$frm = e107::getForm();\n\n\t\tswitch($mode)\n\t\t{\n\t\t\tcase 'read': // List Page\n\n\t\t\t\tif(intval($curVal) > 1)\n\t\t\t\t{\n\t\t\t\t\treturn \"<span class='label label-warning'>\".$curVal.\"</span>\";\n\t\t\t\t}\n\n\t\t\t\treturn $curVal;\n\t\t\tbreak;\n\n\t\t\tcase 'write': // Edit Page\n\t\t\t\treturn $frm->text('plugin_name',$curVal, 255, 'size=large');\n\t\t\tbreak;\n\n\t\t\tcase 'filter':\n\t\t\tcase 'batch':\n\t\t\t\treturn  array();\n\t\t\tbreak;\n\t\t}\n\t}\n\n\n\t// Custom Method/Function\n\tfunction plugin_addons($curVal,$mode)\n\t{\n\t\t$frm = e107::getForm();\n\n\t\tswitch($mode)\n\t\t{\n\t\t\tcase 'read': // List Page\n\t\t\t\treturn $curVal;\n\t\t\tbreak;\n\n\t\t\tcase 'write': // Edit Page\n\t\t\t\treturn $frm->text('plugin_addons',$curVal, 255, 'size=large');\n\t\t\tbreak;\n\n\t\t\tcase 'filter':\n\t\t\tcase 'batch':\n\t\t\t\treturn  array();\n\t\t\tbreak;\n\t\t}\n\t}\n\n\n\tfunction options($val, $curVal)\n\t{\n\n\t\t$tp = e107::getParser();\n\n\t\t$var = $this->getController()->getListModel()->getData();\n\n\t\t$mode = $this->getController()->getMode();\n\n\n\t//\te107::getDebug()->log($var);\n\n\t\t$_path = e_PLUGIN . $var['plugin_path'] . '/';\n\n\t\tif($var['plugin_admin_url'] && $var['plugin_installflag'] == true)\n\t\t{\n\n\t\t\t$conf_title = !empty($var['plugin_admin_caption']) ? $var['plugin_admin_caption'] : LAN_CONFIGURE . ' ' . $tp->toHTML($var['plugin_name'], \"\", \"defs,emotes_off, no_make_clickable\");\n\t\t\t$plugin_config_icon = \"<a class='btn btn-default' title='{$conf_title}' href='\" . $var['plugin_admin_url'] . \"' >\" . ADMIN_CONFIGURE_ICON . \"</a>\";\n\t\t}\n\n\t\t$text = \"<div class='btn-group'>\";\n\t\t$text .= vartrue($plugin_config_icon);\n\n\t\tif($var['plugin_install_required'] == true)\n\t\t{\n\n\t\t\tif($var['plugin_installflag'])\n\t\t\t{\n\t\t\t\t$text .= ($var['plugin_installflag'] ? \"<a class='btn btn-default' href=\\\"\" . e_SELF . \"?mode=\".$mode.\"&action=uninstall&id={$var['plugin_path']}\\\" title='\" . EPL_ADLAN_1 . \"'  >\" . ADMIN_UNINSTALLPLUGIN_ICON . \"</a>\" : \"<a class='btn' href=\\\"\" . e_SELF . \"?install.{$var['plugin_id']}\\\" title='\" . EPL_ADLAN_0 . \"' >\" . ADMIN_INSTALLPLUGIN_ICON . \"</a>\");\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$text .= \"<a class='btn btn-default' href=\\\"\" . e_SELF . \"?mode=installed&action=install&id={$var['plugin_path']}\\\" title='\" . EPL_ADLAN_0 . \"' >\" . ADMIN_INSTALLPLUGIN_ICON . \"</a>\";\n\t\t\t}\n\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif($var['menuName'])\n\t\t\t{\n\t\t\t//\t$text .= EPL_NOINSTALL . str_replace(\"..\", \"\", e_PLUGIN . $var['plugin_path']) . \"/ \" . EPL_DIRECTORY;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t//\t$text .= EPL_NOINSTALL_1 . str_replace(\"..\", \"\", e_PLUGIN . $var['plugin_path']) . \"/ \" . EPL_DIRECTORY;\n\t\t\t\tif($var['plugin_installflag'] == false)\n\t\t\t\t{\n\t\t\t//\t\te107::getDb()->delete('plugin', \"plugin_installflag=0 AND (plugin_path='{$var['plugin_path']}' OR plugin_path='{$var['plugin_path']}/' )  \");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif($var['plugin_version'] != $var['plugin_version_file'] && $var['plugin_installflag'])\n\t\t{\n\t\t\t$text .= \"<a class='btn btn-default' href='\" . e_SELF . \"?mode=\".$mode.\"&action=upgrade&id={$var['plugin_path']}' title=\\\"\" . EPL_UPGRADE . \" v\" . $var['plugin_version'] . \"\\\" >\" . ADMIN_UPGRADEPLUGIN_ICON . \"</a>\";\n\t\t}\n\n\t\tif($var['plugin_installflag'] && e_DEBUG == true)\n\t\t{\n\t\t\t$text .= \"<a class='btn btn-default' href='\" . e_SELF . \"?mode=\".$mode.\"&action=repair&id={$var['plugin_path']}' title='\" . LAN_REPAIR_PLUGIN_SETTINGS . \"'> \" . ADMIN_REPAIRPLUGIN_ICON . \"</a>\";\n\t\t}\n\n\t\tif($var['plugin_installflag'] && is_dir($_path . \".git\"))\n\t\t{\n\t\t\t$text .= \"<a class='plugin-manager btn btn-default' href='\" . e_SELF . \"?mode=\".$mode.\"&action=pull&id={$var['plugin_path']}' title='\" . LAN_SYNC_WITH_GIT_REPO . \"'> \" . ADMIN_GITSYNC_ICON . \"</a>\";\n\t\t}\n\n\n\t\t$text .= \"</div>\t\";\n\n\t\treturn $text;\n\t}\n\n}\n\n\n\n\n\n\n\nclass plugin_online_ui extends e_admin_ui\n{\n\n\t\tprotected $pluginTitle\t\t=  ADLAN_98;\n\t\tprotected $pluginName\t\t= 'core';\n\t//\tprotected $eventName\t\t= 'plugman-plugin'; // remove comment to enable event triggers in admin.\n\t\tprotected $table\t\t\t= false;\n\t\tprotected $pid\t\t\t\t= '';\n\t\tprotected $perPage\t\t\t= 10;\n\t\tprotected $batchDelete\t\t= true;\n\t\tprotected $batchExport     = true;\n\t\tprotected $batchCopy\t\t= true;\n\t//\tprotected $sortField\t\t= 'somefield_order';\n\t//\tprotected $orderStep\t\t= 10;\n\t//\tprotected $tabs\t\t\t\t= array('Tabl 1','Tab 2'); // Use 'tab'=>0  OR 'tab'=>1 in the $fields below to enable.\n\n\t//\tprotected $listQry      \t= \"SELECT * FROM `#tableName` WHERE field != '' \"; // Example Custom Query. LEFT JOINS allowed. Should be without any Order or Limit.\n\n\t\tprotected $listOrder\t\t= '';\n\n\t\tprotected $fields \t\t= array ();\n\n\t\tprotected $fieldpref = array('plugin_icon', 'plugin_name', 'plugin_version', 'plugin_license', 'plugin_description', 'plugin_compatible', 'plugin_released','plugin_author', 'plugin_category','plugin_installflag');\n\n\n\t//\tprotected $preftabs        = array('General', 'Other' );\n\t\tprotected $prefs = array(\n\t\t);\n\n\t\tprotected $mp = null;\n\n\n\t\tpublic function __construct($request, $response, $params = array())\n\t\t{\n\n\t\t\t$this->fields = plugman_adminArea::getPluginManagerFields();\n\t\t\t$this->fields['plugin_category']['writeParms']['optArray'] = e107::getPlug()->getCategoryList(); // array('plugin_category_0','plugin_category_1', 'plugin_category_2'); // Example Drop-down array.\n\t\t\t$this->fields[\"plugin_license\"]['nolist'] = false;\n\t\t\tparent:: __construct($request, $response, $params);\n\n\t\t}\n\n\n\t\tpublic function init()\n\t\t{\n\t\t\trequire_once(e_HANDLER.'e_marketplace.php');\n\t\t}\n\n\t\tfunction pluginCheck($force=false)\n\t\t{\n\t\t\tif(!PLUGIN_SCAN_INTERVAL)\n\t\t\t{\n\t\t\t\te107::getPlugin()->update_plugins_table('update');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif((time() > vartrue($_SESSION['nextPluginFolderScan'],0)) || $force == true)\n\t\t\t{\n\t\t\t\te107::getPlugin()->update_plugins_table('update');\n\t\t\t}\n\n\t\t\t$_SESSION['nextPluginFolderScan'] = time() + PLUGIN_SCAN_INTERVAL;\n\t\t\t//echo \"TIME = \".$_SESSION['nextPluginFolderScan'];\n\n\t    }\n\n\t\t// Modal Download.\n\t\tpublic function downloadPage()\n\t\t{\n\n\t\t\t$frm = e107::getForm();\n\t\t\t$mes = e107::getMessage();\n\t\t\t$tp = e107::getParser();\n\n\t\t//\tprint_a($_GET);\n\n\t\t\t$string =  base64_decode($_GET['src']);\n\t\t\tparse_str($string, $data);\n\n\t\t\tif(deftrue('e_DEBUG_MARKETPLACE'))\n\t\t\t{\n\t\t\t\techo \"<b>DEBUG MODE ACTIVE (no downloading)</b><br />\";\n\t\t\t\techo '$_GET[src]: ';\n\t\t\t\tprint_a($_GET);\n\n\t\t\t\techo 'base64 decoded and parsed as $data:';\n\t\t\t\tprint_a($data);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t$pluginFolder = !empty($data['plugin_folder']) ? $tp->filter($data['plugin_folder']) : '';\n\t\t\t$pluginUrl = !empty($data['plugin_url']) ? $tp->filter($data['plugin_url']) : '';\n\t\t\t$pluginID = !empty($data['plugin_id']) ? $tp->filter($data['plugin_id']) : '';\n\t\t\t$pluginMode = !empty($data['plugin_mode']) ? $tp->filter($data['plugin_mode']) : '';\n\n\t\t\tif(!empty($data['plugin_price']))\n\t\t\t{\n\t\t\t\te107::getRedirect()->go($pluginUrl);\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\t$mp = $this->getMarketplace();\n\t\t//\t$mp->generateAuthKey($e107SiteUsername, $e107SiteUserpass);\n\n\n\n\t\t\t// Server flush useless. It's ajax ready state 4, we can't flush (sadly) before that (at least not for all browsers)\n\t\t    $mes->addSuccess(EPL_ADLAN_94);\n\n\t\t\tif($mp->download($pluginID, $pluginMode, 'plugin'))\n\t\t\t{\n\t\t\t\t$this -> pluginCheck(true); // rescan the plugin directory\n\t\t\t\t$text = e107::getPlugin()->install($pluginFolder);\n\n\t\t\t\t$mes->addInfo($text);\n\t\t\t\techo $mes->render('default', 'success');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t// Unable to continue\n\t\t\t\techo $mes->addError(EPL_ADLAN_95)->render('default', 'error');\n\t\t\t}\n\n\t\t\techo $mes->render('default', 'debug');\n\t\t\treturn null;\n\n\n\n\t\t}\n\n        public function ListObserver()\n        {\n      //    parent::ListObserver();\n\n\t        $this->setPlugData();\n        }\n\n\n\n\t\t/**\n\t\t * @return e_marketplace|null\n\t\t */\n\t\tpublic function getMarketplace()\n\t\t{\n\t\t\tif(null === $this->mp)\n\t\t\t{\n\t\t\t\t$this->mp = new e_marketplace(); // autodetect the best method\n\t\t\t}\n\n\t\t\treturn $this->mp;\n\t\t}\n\n\n\n\t\tprivate function compatibilityLabel($val='')\n\t\t{\n\t\t\t$badge = (vartrue($val) > 1.9) ? \"<span class='label label-warning'>\".EPL_ADLAN_88.\"</span>\" : '1.x';\n\t\t\treturn $badge;\n\t\t}\n\n\n\n\tfunction options($data)\n\t{\n\n\t//\tprint_a($data);\n\n\t\t/*\n\t\tif(!e107::getFile()->hasAuthKey())\n\t\t{\n\t\t//\treturn \"<a href='\".e_SELF.\"' class='btn btn-primary e-modal' >Download and Install</a>\";\n\n\t\t}\n\t\t*/\n\t\tif($data['plugin_installflag'])\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\n\n\t\t//$url = e_SELF.\"?src=\".base64_encode($d);\n\t//\t$url = e_SELF.'?action=download&amp;src='.base64_encode($d);//$url.'&amp;action=download';\n\t\t$id = 'plug_'.$data['plugin_id'];\n\t\t//<button type='button' data-target='{$id}' data-loading='\".e_IMAGE.\"/generic/loading_32.gif' class='btn btn-primary e-ajax middle' value='Download and Install' data-src='\".$url.\"' ><span>Download and Install</span></button>\n\t\t$modalCaption = (!empty($data['plugin_price'])) ? EPL_ADLAN_92.\" \".$data['plugin_name'].\" \".$data['plugin_version'] : EPL_ADLAN_230.\" \".$data['plugin_name'].\" \".$data['plugin_version'];\n\n\t\t$srcData = array(\n\t\t\t'plugin_id'     => $data['plugin_id'],\n\t\t\t'plugin_folder' => $data['plugin_folder'],\n\t\t\t'plugin_price'  => $data['plugin_price'],\n\t\t\t'plugin_mode'   => $data['plugin_mode'],\n\t\t\t'plugin_url'    => $data['plugin_url'],\n\t\t);\n\n\n\t\t$url = $this->getMarketplace()->getDownloadModal('plugin',  $srcData);\n\n\n\t//\t$d = http_build_query($srcData,false,'&');\n\t//\t$url = e_SELF.'?mode=download&src='.base64_encode($d);\n\t\t$dicon = '<a title=\"'.EPL_ADLAN_237.'\" class=\"e-modal btn btn-default\" href=\"'.$url.'\" rel=\"external\" data-loading=\"'.e_IMAGE.'/generic/loading_32.gif\"  data-cache=\"false\" data-modal-caption=\"'.$modalCaption.'\"  target=\"_blank\" >'.ADMIN_INSTALLPLUGIN_ICON.'</a>';\n\n\t\t/*\n\n\t\t// DEBUGGER .\n\t\t$base64 = base64_encode($d);\n\t\t$tmp = base64_decode($base64);\n\t\tparse_str($tmp, $data);\n\n\t//  XXX Suhosin has a 512 char limit for $_GET strings.\n\t\te107::getDebug()->log($data['plugin_name'].' : '.strlen($base64).\"<br />\".print_a($data,true)); //FIXME - enable when needed to debug.\n\t\t*/\n\n\t\t// Temporary Pop-up version.\n\t//\t$dicon = '<a class=\"e-modal\" href=\"'.$data['plugin_url'].'\" rel=\"external\" data-modal-caption=\"'.$data['plugin_name'].\" \".$data['plugin_version'].'\"  target=\"_blank\" ><img class=\"top\" src=\"'.e_IMAGE_ABS.'icons/download_32.png\" alt=\"\"  /></a>';\n\n\t//\t$dicon = \"<a data-toggle='modal' data-modal-caption=\\\"Downloading \".$data['plugin_name'].\" \".$data['plugin_version'].\"\\\" href='{$url}' data-cache='false' data-target='#uiModal' title='\".$LAN_DOWNLOAD.\"' ><img class='top' src='\".e_IMAGE_ABS.\"icons/download_32.png' alt=''  /></a> \";\n\n\t\treturn \"<div id='{$id}' class='center' >\n\t\t{$dicon}\n\t\t</div>\";\n\t}\n\n\t\tprivate function setPlugData()\n\t\t{\n\n\t\t\t//\t$this->setTreeModel();\n\n\t\t\t/*   $tree = $this->getTreeModel();\n\n\t\t\t\t$plg = e107::getPlug();\n\n\t            foreach ($tree->getTree() as $id => $model)\n\t            {\n\t\t\t\t\t$path = $model->get('plugin_path');\n\n\t\t\t\t\t$plg->load($path);\n\n\t\t            $model->set('plugin_name',$plg->getName());\n\t\t            $model->set('plugin_date',$plg->getDate());\n\t\t            $model->set('plugin_author',$plg->getAuthor());\n\t\t            $model->set('plugin_compatible',$plg->getCompat());\n\t\t            $model->set('plugin_admin_url',$plg->getAdminUrl());\n\t\t            $model->set('plugin_description',$plg->getDescription());\n\t\t            $model->set('plugin_version_file',$plg->getVersion());\n\t\t            $model->set('plugin_install_required',$plg->getInstallRequired());\n\t                $model->set('plugin_icon',$plg->getIcon(32, 'path'));\n\n\t            }*/\n\n\t\t}\n\n\n\t\tpublic function listPage()\n\t\t{\n\n\n\t\t\tglobal $plugin, $e107SiteUsername, $e107SiteUserpass;\n\t\t\t$tp = e107::getParser();\n\t\t\t$frm = $this->getUI();\n\n\t\t\t$caption\t= EPL_ADLAN_89;\n\n\t\t\t$e107 = e107::getInstance();\n\t\t\t$xml = e107::getXml();\n\t\t\t$mes = e107::getMessage();\n\n\t\t//\t$mes->addWarning(\"Some older plugins may produce unpredictable results.\");\n\t\t\t// check for cURL\n\t\t\tif(!function_exists('curl_init'))\n\t\t\t{\n\t\t\t\t$mes->addWarning(EPL_ADLAN_90);\n\t\t\t}\n\n\t\t\t//TODO use admin_ui including filter capabilities by sending search queries back to the xml script.\n\t\t\t$from = isset($_GET['frm']) ? intval($_GET['frm']) : 0;\n\t\t\t$srch = preg_replace('/[^\\w]/','', vartrue($_GET['srch']));\n\n\n\t\t\t$mp = $this->getMarketplace();\n\n\t\t\t// auth\n\t\t\t$mp->generateAuthKey($e107SiteUsername, $e107SiteUserpass);\n\n\t\t\t// do the request, retrieve and parse data\n\t\t\t$xdata = $mp->call('getList', array(\n\t\t\t\t'type' => 'plugin',\n\t\t\t\t'params' => array('limit' => 10, 'search' => $srch, 'from' => $from)\n\t\t\t));\n\t\t\t$total = $xdata['params']['count'];\n\n\t\t\t// OLD BIT OF CODE ------------------------------->\n\t\t/*\n\t\t//\t$file = SITEURLBASE.e_PLUGIN_ABS.\"release/release.php\";  // temporary testing\n\t\t\t$file = \"http://e107.org/feed?type=plugin&frm=\".$from.\"&srch=\".$srch.\"&limit=10\";\n\n\t\t\t$xml->setOptArrayTags('plugin'); // make sure 'plugin' tag always returns an array\n\t\t\t$xdata = $xml->loadXMLfile($file,'advanced');\n\n\t\t\t$total = $xdata['@attributes']['total'];\n\n\t\t\techo 'file='.$file;\n\t\t//\tprint_a($xdata);\n\n\t\t\t$xdata['data'] = $xdata['plugin'];\n\t\t\t*/\n\t\t\t// OLD BIT OF CODE END ------------------------------->\n\n\n\t// print_a($xdata);\n\n\t\t\t$c = 1;\n\t\t\tforeach($xdata['data'] as $row)\n\t\t\t{\n\t\t\t\t//$row = $r['@attributes'];\n\n\t\t\t\t//\tprint_a($row);\n\n\t\t\t\t\t$badge \t\t= $this->compatibilityLabel($row['compatibility']);;\n\t\t\t\t\t$featured \t= ($row['featured']== 1) ? \" <span class='label label-info'>\".EPL_ADLAN_91.\"</span>\" : '';\n\t\t\t\t\t$price \t\t= (!empty($row['price'])) ? \"<span class='label label-primary'>\".$row['price'].\" \".$row['currency'].\"</span>\" : \"<span class='label label-success'>\".EPL_ADLAN_93.\"</span>\";\n\n\t\t\t\t\t$data[] = array(\n\t\t\t\t\t\t'plugin_id'\t\t\t\t=> $row['params']['id'],\n\t\t\t\t\t\t'plugin_mode'\t\t\t=> $row['params']['mode'],\n\t\t\t\t\t\t'plugin_icon'\t\t\t=> vartrue($row['icon'],'e-plugins-32'),\n\t\t\t\t\t\t'plugin_name'\t\t\t=> stripslashes($row['name']),\n\t\t\t\t\t\t'plugin_featured'\t\t=> $featured,\n\t\t\t\t\t\t'plugin_sef'\t\t\t=> '',\n\t\t\t\t\t\t'plugin_folder'\t\t\t=> $row['folder'],\n\t\t\t\t\t\t'plugin_date'\t\t\t=> vartrue($row['date']),\n\t\t\t\t\t\t'plugin_category'\t\t=> vartrue($row['category'], 'n/a'),\n\t\t\t\t\t\t'plugin_author'\t\t\t=> vartrue($row['author']),\n\t\t\t\t\t\t'plugin_version'\t\t=> $row['version'],\n\t\t\t\t\t\t'plugin_description'\t=> nl2br(vartrue($row['description'])),\n\t\t\t\t\t\t'plugin_compatible'\t\t=> $badge,\n\n\t\t\t\t\t\t'plugin_website'\t\t=> vartrue($row['authorUrl']),\n\t\t\t\t\t\t'plugin_url'\t\t\t=> $row['urlView'],\n\t\t\t\t\t\t'plugin_notes'\t\t\t=> '',\n\t\t\t\t\t\t'plugin_price'\t\t\t=> $row['price'],\n\t\t\t\t\t\t'plugin_license'\t\t=> $price,\n\t\t\t\t\t\t'plugin_installflag'    => e107::isInstalled($row['folder'])\n\t\t\t\t\t);\n\n\t\t\t\t$c++;\n\t\t\t}\n\n\t\t\t$fieldList = $this->fields;\n\t\t\tunset($fieldList['checkboxes']);\n\n\t\t\t$text = \"\n\t\t\t\t<form class='form-search form-inline' action='\".e_SELF.\"?\".e_QUERY.\"' id='core-plugin-list-form' method='get'>\n\t\t\t\t<div id='admin-ui-list-filter' class='e-search '>\".$frm->search('srch', $srch, 'go', $filterName, $filterArray, $filterVal).$frm->hidden('mode','online').\"\n\t\t\t\t</div>\n\t\t\t\t</form>\n\n\t\t\t\t<form action='\".e_SELF.\"?\".e_QUERY.\"' id='core-plugin-list-form' method='post'>\n\t\t\t\t\t<fieldset class='e-filter' id='core-plugin-list'>\n\t\t\t\t\t\t<legend class='e-hideme'>\".$caption.\"</legend>\n\n\n\n\n\n\t\t\t\t\t\t<table id=core-plugin-list' class='table adminlist table-striped'>\n\t\t\t\t\t\t\t\".$frm->colGroup($fieldList,$this->fieldpref).\n\t\t\t\t\t\t\t$frm->thead($fieldList,$this->fieldpref).\"\n\t\t\t\t\t\t\t<tbody>\n\t\t\t\";\n\n\n\n\n\t\t\tforeach($data as $key=>$val\t)\n\t\t\t{\n\t\t\t//\tprint_a($val);\n\t\t\t\t$text .= \"<tr>\";\n\n\t\t\t\tforeach($this->fields as $v=>$foo)\n\t\t\t\t{\n\t\t\t\t\tif(!in_array($v,$this->fieldpref) || $v == 'checkboxes')\n\t\t\t\t\t{\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\t$_value = $val[$v];\n\t\t\t\t\tif($v == 'plugin_name') $_value .= $val['plugin_featured'];\n\t\t\t\t\t// echo '<br />v='.$v;\n\t\t\t\t\t$text .= \"<td style='height: 40px' class='\".vartrue($this->fields[$v]['class'],'left').\"'>\".$frm->renderValue($v, $_value, $this->fields[$v], $key).\"</td>\\n\";\n\t\t\t\t}\n\t\t\t\t$text .= \"<td class='center'>\".$this->options($val).\"</td>\";\n\t\t\t\t$text .= \"</tr>\";\n\n\t\t\t}\n\n\n\t\t\t$text .= \"\n\t\t\t\t\t\t\t</tbody>\n\t\t\t\t\t\t</table>\";\n\t\t\t$text .= \"\n\t\t\t\t\t</fieldset>\n\t\t\t\t</form>\n\t\t\t\";\n\n\t\t\t$amount = 30;\n\n\n\t\t\tif($total > $amount)\n\t\t\t{\n\t\t\t\t$parms = $total.\",\".$amount.\",\".$from.\",\".e_SELF.'?mode=online&amp;action=list&amp;frm=[FROM]';\n\n\t\t\t\tif(!empty($srch))\n\t\t\t\t{\n\t\t\t\t\t$parms .= '&amp;srch='.$srch;\n\t\t\t\t}\n\n\t\t\t\t$text .= \"<div class='control-group form-inline input-inline' style='text-align:center;margin-top:10px'>\".$tp->parseTemplate(\"{NEXTPREV=$parms}\",TRUE).\"</div>\";\n\t\t\t}\n\n\t\t\treturn $text;\n\n\t\t}\n\n\n\n\n\t\t// ------- Customize Create --------\n\n\t\tpublic function beforeCreate($new_data,$old_data)\n\t\t{\n\t\t\treturn $new_data;\n\t\t}\n\n\t\tpublic function afterCreate($new_data, $old_data, $id)\n\t\t{\n\t\t\t// do something\n\t\t}\n\n\t\tpublic function onCreateError($new_data, $old_data)\n\t\t{\n\t\t\t// do something\n\t\t}\n\n\n\t\t// ------- Customize Update --------\n\n\t\tpublic function beforeUpdate($new_data, $old_data, $id)\n\t\t{\n\t\t\treturn $new_data;\n\t\t}\n\n\t\tpublic function afterUpdate($new_data, $old_data, $id)\n\t\t{\n\t\t\t// do something\n\t\t}\n\n\t\tpublic function onUpdateError($new_data, $old_data, $id)\n\t\t{\n\t\t\t// do something\n\t\t}\n\n\n\t/*\n\t\t// optional - a custom page.\n\t\tpublic function customPage()\n\t\t{\n\t\t\t$text = 'Hello World!';\n\t\t\t$otherField  = $this->getController()->getFieldVar('other_field_name');\n\t\t\treturn $text;\n\n\t\t}\n\t*/\n\n}\n\n\n\nclass plugin_form_online_ui extends e_admin_form_ui\n{\n\n\n\t// Custom Method/Function\n\tfunction plugin_name($curVal,$mode)\n\t{\n\t\t$frm = e107::getForm();\n\n\t\tswitch($mode)\n\t\t{\n\t\t\tcase 'read': // List Page\n\t\t\t\treturn $curVal;\n\t\t\tbreak;\n\n\t\t\tcase 'write': // Edit Page\n\t\t\t\treturn $frm->text('plugin_name',$curVal, 255, 'size=large');\n\t\t\tbreak;\n\n\t\t\tcase 'filter':\n\t\t\tcase 'batch':\n\t\t\t\treturn  array();\n\t\t\tbreak;\n\t\t}\n\t}\n\n\n\t// Custom Method/Function\n\tfunction plugin_addons($curVal,$mode)\n\t{\n\t\t$frm = e107::getForm();\n\n\t\tswitch($mode)\n\t\t{\n\t\t\tcase 'read': // List Page\n\t\t\t\treturn $curVal;\n\t\t\tbreak;\n\n\t\t\tcase 'write': // Edit Page\n\t\t\t\treturn $frm->text('plugin_addons',$curVal, 255, 'size=large');\n\t\t\tbreak;\n\n\t\t\tcase 'filter':\n\t\t\tcase 'batch':\n\t\t\t\treturn  array();\n\t\t\tbreak;\n\t\t}\n\t}\n\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n//if(deftrue('e_DEBUG_PLUGMANAGER'))\n{\n\tnew plugman_adminArea();\n\trequire_once(e_ADMIN.\"auth.php\");\n\te107::getAdminUI()->runPage();\n\trequire_once(e_ADMIN.\"footer.php\");\n\texit;\n\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n// --------------------------------------\n\n/*\nclass pluginmanager_form extends e_form\n{\n\t\n\tvar $plug;\n\tvar $plug_vars;\n\t\t\n\t//FIXME _ there's a problem with calling this. \n\tfunction plugin_website($parms, $value, $id, $attributes)\n\t{\n\t\treturn (varset($plugURL, false)) ? \"<a href='{$plugURL}' title='{$plugURL}' >\".ADMIN_URL_ICON.\"</a>\" : \"\";\t\n\t\t\n\t}\n\t\n\t\n\tfunction options($val, $curVal)\n\t{\n\t\t\n\t\t$tp = e107::getParser();\n\t\t\n\t\t$_path = e_PLUGIN.$this->plug['plugin_path'].'/';\n\t\t\n\t\t$icon_src = (isset($this->plug_vars['plugin_php']) ? e_PLUGIN : $_path).$this->plug_vars['administration']['icon'];\n\t\t$plugin_icon = $this->plug_vars['administration']['icon'] ? \"<img src='{$icon_src}' alt='' class='icon S32' />\" : $tp->toGlyph('e-cat_plugins-32');\n   \t\t$conf_file = \"#\";\n\t\t$conf_title = \"\";\n\t\t\n\t\tif ($this->plug_vars['administration']['configFile'] && $this->plug['plugin_installflag'] == true)\n\t\t{\n\t\t\t$conf_file = e_PLUGIN. $this->plug['plugin_path'].'/'.$this->plug_vars['administration']['configFile'];\n\t\t\t$conf_title = LAN_CONFIGURE.' '.$tp->toHTML($this->plug_vars['@attributes']['name'], \"\", \"defs,emotes_off, no_make_clickable\");\n\t\t\t$plugin_icon = \"<a title='{$conf_title}' href='{$conf_file}' >\".$plugin_icon.\"</a>\";\n\t\t\t$plugin_config_icon = \"<a class='btn btn-default' title='{$conf_title}' href='{$conf_file}' >\".ADMIN_CONFIGURE_ICON.\"</a>\";\n\t\t}\n\t\t\t\t\n\t\t$text = \"<div class='btn-group'>\";\n\t\t\n\t\t$text .= vartrue($plugin_config_icon);\n\t\t\n\t\tif ($this->plug_vars['@attributes']['installRequired'])\n\t\t{\n\t\t\t\n\t\t\tif ($this->plug['plugin_installflag'])\n\t\t\t{\n\t\t  \t\t$text .= ($this->plug['plugin_installflag'] ? \"<a class='btn btn-default' href=\\\"\".e_SELF.\"?uninstall.{$this->plug['plugin_id']}\\\" title='\".EPL_ADLAN_1.\"'  >\".ADMIN_UNINSTALLPLUGIN_ICON.\"</a>\" : \"<a class='btn' href=\\\"\".e_SELF.\"?install.{$this->plug['plugin_id']}\\\" title='\".EPL_ADLAN_0.\"' >\".ADMIN_INSTALLPLUGIN_ICON.\"</a>\");\n                           //   $text .= ($this->plug['plugin_installflag'] ? \"<button type='button' class='delete' value='no-value' onclick=\\\"location.href='\".e_SELF.\"?uninstall.{$this->plug['plugin_id']}'\\\"><span>\".EPL_ADLAN_1.\"</span></button>\" : \"<button type='button' class='update' value='no-value' onclick=\\\"location.href='\".e_SELF.\"?install.{$this->plug['plugin_id']}'\\\"><span>\".EPL_ADLAN_0.\"</span></button>\");\n\t\t\t\tif (e_DEBUG && !vartrue($this->plug_vars['plugin_php']))\n\t\t\t\t{\n\t\t\t//\t\t$text .= \"<br /><br /><input type='button' class='btn btn-default button' onclick=\\\"location.href='\".e_SELF.\"?refresh.{$this->plug['plugin_id']}'\\\" title='\".'Refresh plugin settings'.\"' value='\".'Refresh plugin settings'.\"' /> \";\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t  //\t$text .=  \"<input type='button' class='btn' onclick=\\\"location.href='\".e_SELF.\"?install.{$this->plug['plugin_id']}'\\\" title='\".EPL_ADLAN_0.\"' value='\".EPL_ADLAN_0.\"' />\";\n\t\t\t  //\t$text .= \"<button type='button' class='update' value='no-value' onclick=\\\"location.href='\".e_SELF.\"?install.{$this->plug['plugin_id']}'\\\"><span>\".EPL_ADLAN_0.\"</span></button>\";\n\t           \t$text .= \"<a class='btn btn-default' href=\\\"\".e_SELF.\"?install.{$this->plug['plugin_id']}\\\" title='\".EPL_ADLAN_0.\"' >\".ADMIN_INSTALLPLUGIN_ICON.\"</a>\";\n\t\t\t}\n\t\t\t\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif ($this->plug_vars['menuName'])\n\t\t\t{\n\t\t\t\t$text .= EPL_NOINSTALL.str_replace(\"..\", \"\", e_PLUGIN.$this->plug['plugin_path']).\"/ \".EPL_DIRECTORY;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$text .= EPL_NOINSTALL_1.str_replace(\"..\", \"\", e_PLUGIN.$this->plug['plugin_path']).\"/ \".EPL_DIRECTORY;\n\t\t\t\tif($this->plug['plugin_installflag'] == false)\n\t\t\t\t{\t\t\t\t\t\n\t\t\t\t\te107::getDb()->delete('plugin', \"plugin_installflag=0 AND (plugin_path='{$this->plug['plugin_path']}' OR plugin_path='{$this->plug['plugin_path']}/' )  \");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif ($this->plug['plugin_version'] != $this->plug_vars['@attributes']['version'] && $this->plug['plugin_installflag'])\n\t\t{\n\t\t  //\t$text .= \"<br /><input type='button' class='btn' onclick=\\\"location.href='\".e_SELF.\"?upgrade.{$this->plug['plugin_id']}'\\\" title='\".EPL_UPGRADE.\" to v\".$this->plug_vars['@attributes']['version'].\"' value='\".EPL_UPGRADE.\"' />\";\n\t\t    e107::getMessage()->addInfo(\"<b>\".$tp->toHtml($this->plug['plugin_name'],false,'TITLE').\"</b> is ready to be upgraded. (see below)\"); // TODO LAN\n\t\t\t$text .= \"<a class='btn btn-default' href='\".e_SELF.\"?upgrade.{$this->plug['plugin_id']}' title=\\\"\".EPL_UPGRADE.\" v\".$this->plug_vars['@attributes']['version'].\"\\\" >\".ADMIN_UPGRADEPLUGIN_ICON.\"</a>\";\n\t\t}\n\n\t\tif ($this->plug['plugin_installflag'] && e_DEBUG == true)\n\t\t{\n\t\t\t\t$text .= \"<a class='btn btn-default' href='\".e_SELF.\"?repair.\".$this->plug['plugin_id'].\"' title='\".LAN_REPAIR_PLUGIN_SETTINGS.\"'> \".ADMIN_REPAIRPLUGIN_ICON.\"</a>\";\n\t\t}\n\n\t\tif($this->plug['plugin_installflag'] && is_dir($_path.\".git\"))\n\t\t{\n\t\t\t$text .=  \"<a class='plugin-manager btn btn-default' href='\".e_SELF.\"?pull.\".$this->plug['plugin_id'].\"' title='\".LAN_SYNC_WITH_GIT_REPO.\"'> \".ADMIN_GITSYNC_ICON.\"</a>\";\n\t\t}\n\n\n\t\t$text .=\"</div>\t\";\n\t\t\t\t\n\t\treturn $text;\n\t}\t\n\n\n\t\n}\n*/\n/*\nrequire_once(\"auth.php\");\n$pman->pluginObserver();\n$mes = e107::getMessage();\n$frm = e107::getForm();*/\n\nrequire_once(\"footer.php\");\nexit;\n\n\n// FIXME switch to admin UI\n/*\nclass pluginManager{\n\n\tvar $plugArray;\n\tvar $action;\n\tvar $id;\n\tvar $frm;\n\tvar $fieldpref;\n\tvar $titlearray \t\t= array();\n\tvar $pagetitle;\n\t\n\n\tvar $mp;\n\t\t\n\tprotected $pid = 'plugin_id';\n\t\n\tprotected $fields = array(\n\n\t\t   \t\t\"checkboxes\"\t\t\t=> array(\"title\" => \"\", 'type'=>null, \"forced\"=>TRUE, \"width\"=>\"3%\", 'thclass'=>'center','class'=>'center'),\n\t\t\t\t\"plugin_icon\"\t\t\t=> array(\"title\" => EPL_ADLAN_82, \"type\"=>\"icon\", \"width\" => \"5%\", \"thclass\" => \"middle center\",'class'=>'center', \"url\" => \"\"),\n\t\t\t\t\"plugin_name\"\t\t\t=> array(\"title\" => EPL_ADLAN_10, 'forced'=>true, \"type\"=>\"text\", \"width\" => \"auto\", 'class'=>'left', \"thclass\" => \"middle\", \"url\" => \"\"),\n \t\t\t\t\"plugin_version\"\t\t=> array(\"title\" => EPL_ADLAN_11, \"type\"=>\"numeric\", \"width\" => \"5%\", \"thclass\" => \"middle\", \"url\" => \"\"),\n    \t\t\t\"plugin_date\"\t\t\t=> array(\"title\" => LAN_RELEASED, \t\"type\"=>\"text\", \"width\" => \"8%\", \"thclass\" => \"middle\"),\n    \t\t\t\n    \t\t\t\"plugin_folder\"\t\t\t=> array(\"title\" => EPL_ADLAN_64, \"type\"=>\"text\", \"width\" => \"10%\", \"thclass\" => \"middle\"),\n\t\t\t\t\"plugin_category\"\t\t=> array(\"title\" => LAN_CATEGORY, \"type\"=>\"text\", \"width\" => \"auto\", \"thclass\" => \"middle\"),\n                \"plugin_author\"\t\t\t=> array(\"title\" => LAN_AUTHOR, \"type\"=>\"text\", \"width\" => \"10%\", \"thclass\" => \"middle\"),\n                \"plugin_license\"\t\t=> array(\"title\" => \"License\", \t 'nolist'=>true,\t\"forced\"=>true, \"type\"=>\"text\", \"width\" => \"5%\", \"thclass\" => \"left\"),\t\n  \t\t//\t\t\"plugin_price\"\t\t\t=> array(\"title\" => \"Price\", \t 'nolist'=>true,\t\"forced\"=>true, \"type\"=>\"text\", \"width\" => \"5%\", \"thclass\" => \"left\"),\t\n  \t\t\t\t\"plugin_compatible\"\t\t=> array(\"title\" => EPL_ADLAN_13, \"type\"=>\"text\", \"width\" => \"5%\", \"thclass\" => \"middle\"),\n\t\t\t\t\"plugin_description\"\t=> array(\"title\" => EPL_ADLAN_14, \"type\"=>\"bbarea\", \"width\" => \"30%\", \"thclass\" => \"middle center\",  'readParms' => 'expand=1&truncate=180&bb=1'),\n\t\t\t\t\"plugin_compliant\"\t\t=> array(\"title\" => EPL_ADLAN_81, \"type\"=>\"text\", \"width\" => \"5%\", \"thclass\" => \"middle center\", \"url\" => \"\"),\n\t\t//\t\t\"plugin_release\"\t\t=> array(\"title\" => EPL_ADLAN_81, \"type\"=>\"text\", \"width\" => \"5%\", \"thclass\" => \"middle center\", \"url\" => \"\"),\n\t\t//\t\t\"plugin_notes\"\t\t\t=> array(\"title\" => EPL_ADLAN_83, \"type\"=>\"url\", \"width\" => \"5%\", \"thclass\" => \"middle center\", \"url\" => \"\"),\n\t\t\t\n\t\t\t\t\"options\"\t\t\t\t=> array(\"title\" => LAN_OPTIONS, 'forced'=>TRUE, 'type'=> 'method', \"width\" => \"15%\", \"thclass\" => \"right last\", 'class'=>'right'),\n\n\t);\n\t\n\t\n\n\tfunction __construct()\n\t{\n        global $user_pref,$admin_log;\n\n\t\t$qry = str_replace('XDEBUG_PROFILE', '', e_QUERY);\n\n        $tmp = explode('.',$qry);\n\n\t  \t$this -> action     = ($tmp[0]) ? $tmp[0] : \"installed\";\n\t\t$this -> id         = !empty($tmp[1]) ? intval($tmp[1]) : \"\";\n\t\t$this -> titlearray = array('installed'=>EPL_ADLAN_22,'avail'=>EPL_ADLAN_23, 'upload'=>EPL_ADLAN_38);\n\t\t\n\t\tif(isset($_GET['mode']))\n\t\t{\n\t\t\t$this->action = $_GET['mode'];\n\t\t}\n\n\t\tif($this->action == 'online')\n\t\t{\n\t\t//\t$this->fields[\"plugin_price\"]['nolist'] = false; //  = array(\"title\" => \"Price\", \"forced\"=>true, \"type\"=>\"text\", \"width\" => \"5%\", \"thclass\" => \"middle center\");\t\t\n\t\t\t$this->fields[\"plugin_license\"]['nolist'] = false; \n\t\t}\n\n        $keys = array_keys($this -> titlearray);\n\t\t$this->pagetitle = (in_array($this->action,$keys)) ? $this -> titlearray[$this->action] : $this -> titlearray['installed'];\n\n\n\n    }\n\n\n\tpublic function getMarketplace()\n\t{\n\t\tif(null === $this->mp)\n\t\t{\n\t\t\trequire_once(e_HANDLER.'e_marketplace.php');\n\t\t\t$this->mp = new e_marketplace(); // autodetect the best method\n\t\t}\n\t\treturn $this->mp;\n\t}\n\n\n\n    function pluginObserver()\n\t{\n\t\t$tp = e107::getParser();\n\n        global $user_pref,$admin_log;\n        \n    \tif (isset($_POST['upload']))\n\t\t{\n        \t$this -> pluginProcessUpload();\n\t\t\t$this->action = 'avail'; \n\t\t}\n\n        if(isset($_POST['etrigger_ecolumns']))\n\t\t{\n\t\t\t$user_pref['admin_pluginmanager_columns'] = $tp->filter($_POST['e-columns']);\n\t\t\tsave_prefs('user');\n\t\t}\n\n\t\t$user_pref['admin_pluginmanager_columns'] = false;\n\t\t\n\t\t$this -> fieldpref = (vartrue($user_pref['admin_pluginmanager_columns'])) ? $user_pref['admin_pluginmanager_columns'] : array(\"plugin_icon\",\"plugin_name\",\"plugin_version\",\"plugin_date\",\"plugin_description\",\"plugin_category\",\"plugin_compatible\",\"plugin_author\",\"plugin_website\",\"plugin_notes\");\n\n\n\t\tforeach($this->fields as $key=>$val)\n\t\t{\n\t\t\tif(vartrue($val['forced']) && substr($key,0,6)=='plugin')\n\t\t\t{\n\t\t\t\t$this->fieldpref[] = $key;\t\n\t\t\t}\t\t\n\t\t}\n\t\t\n\t\tif($this->action == 'download')\n\t\t{\n\t\t\t$this->pluginDownload();\n\t\t\treturn; \t\n\t\t\t\n\t\t}\n\n\n\t\tif($this->action == 'pull' && !empty($this->id))\n\t\t{\n\t\t\t$info = e107::getPlugin()->getinfo($this->id);\n\n\t\t\tif(!empty($info['plugin_path']))\n\t\t\t{\n\t\t\t\t$return = e107::getFile()->gitPull($info['plugin_path'], 'plugin');\n\t\t\t\te107::getMessage()->addSuccess($return);\n\t\t\t\t$this->action = 'refresh';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$this->action = 'avail';\n\t\t\t}\n\n\t\t}\n\n\n\n        if($this->action == 'avail' || $this->action == 'installed')   // Plugin Check is done during upgrade_routine.\n\t\t{\n\t\t\t$this -> pluginCheck();\n\t\t}\n\n\t\tif($this->action == \"uninstall\")\n\t\t{\n        \t$this -> pluginUninstall();\n\t\t\t$this -> pluginCheck(true); // forced\n\t\t}\n\n\n\n\t\tif($this->action == \"repair\")\n\t\t{\n        \t$this -> pluginRepair();\n        \t$this->action = 'refresh';\n\t\t}\n\n\n\t\t\n\t\tif($this->action == \"refresh\")\n\t\t{\n        \t$this -> pluginCheck(true); // forced\n\t\t}\n\n        if($this->action == \"install\" || $this->action == \"refresh\")\n\t\t{\n        \t$this -> pluginInstall();\n    \t\t$this -> action = \"installed\";\n\t\t}\n\n\t\tif($this->action == 'create')\n\t\t{\n\t\t\t$pc = new pluginBuilder;\n\t\t\treturn;\n\t\t\t\t\n\t\t}\n\t\t\n\t\tif($this->action == 'lans')\n\t\t{\n\t\t\t$pc = new pluginLanguage;\n\t\t\treturn;\n\t\t\t\t\n\t\t}\n\n\t\tif($this->action == \"upgrade\")\n\t\t{\n        \t$this -> pluginUpgrade();\n      \t\t$this -> action = \"installed\";\n\t\t}\n\n\n\n\t\tif($this->action == \"upload\")\n\t\t{\n        \t$this -> pluginUpload();\n\t\t}\n\t\t\n\t\tif($this->action == \"online\")\n\t\t{\n        \t$text = $this -> pluginOnline();\n        \t$mes = e107::getMessage();\n        \te107::getRender()->tablerender(ADLAN_98.SEP.$caption, $mes->render(). $text);\n\t\t\treturn;\n\t\t}\n\t\t\n\t//\tprint_a($_POST);\n\n\t\tif(isset($_POST['install-selected']))\n\t\t{\n        \tforeach($_POST['multiselect'] as $val)\n\t\t\t{\n            \t$this -> id = intval($val);\n                $this -> pluginInstall();\n\t\t\t}\n      \t\t$this -> action = \"installed\";\n\t\t}\n\n        if($this->action != 'avail' && varset($this->fields['checkboxes']))\n\t\t{\n\t\t \tunset($this->fields['checkboxes']); //  = FALSE;\n\t\t}\n\n\t\tif($this->action !='upload' && $this->action !='uninstall')\n\t\t{\n\t\t\t$this -> pluginRenderList();\n\t\t}\n\n\n\n\t}\n\t\n\t\n\tprivate function compatibilityLabel($val='')\n\t{\n\t\t$badge = (vartrue($val) > 1.9) ? \"<span class='label label-warning'>\".EPL_ADLAN_88.\"</span>\" : '1.x';\n\t\treturn $badge;\t\n\t}\n\t\n\t\n\t\n\tfunction pluginOnline()\n\t{\n\t\tglobal $plugin, $e107SiteUsername, $e107SiteUserpass;\n\t\t$tp = e107::getParser();\n\t\t$frm = e107::getForm();\n\t\t\n\t\t$caption\t= EPL_ADLAN_89;\n\t\t\n\t\t$e107 = e107::getInstance();\n\t\t$xml = e107::getXml();\n\t\t$mes = e107::getMessage();\n\t\t\n\t//\t$mes->addWarning(\"Some older plugins may produce unpredictable results.\");\n\t\t// check for cURL\n\t\tif(!function_exists('curl_init'))\n\t\t{\n\t\t\t$mes->addWarning(EPL_ADLAN_90);\n\t\t}\n\t\t\n\t\t//TODO use admin_ui including filter capabilities by sending search queries back to the xml script. \n\t\t$from = isset($_GET['frm']) ? intval($_GET['frm']) : 0;\n\t\t$srch = preg_replace('/[^\\w]/','', vartrue($_GET['srch'])); \n\t\t\n\t\n\t\t$mp = $this->getMarketplace();\n\n\t\t// auth\n\t\t$mp->generateAuthKey($e107SiteUsername, $e107SiteUserpass);\n\t\t\n\t\t// do the request, retrieve and parse data\n\t\t$xdata = $mp->call('getList', array(\n\t\t\t'type' => 'plugin', \n\t\t\t'params' => array('limit' => 10, 'search' => $srch, 'from' => $from)\n\t\t));\n\t\t$total = $xdata['params']['count'];\n\t\n\t\t// OLD BIT OF CODE ------------------------------->\n\n\t\t// OLD BIT OF CODE END ------------------------------->\n\t\t\n\t\t\n// print_a($xdata);\n\t\t \n\t\t$c = 1;\n\t\tforeach($xdata['data'] as $row)\n\t\t{\n\t\t\t//$row = $r['@attributes'];\n\t\t\t\n\t\t\t//\tprint_a($row);\n\t\t\t\n\t\t\t\t$badge \t\t= $this->compatibilityLabel($row['compatibility']);;\n\t\t\t\t$featured \t= ($row['featured']== 1) ? \" <span class='label label-info'>\".EPL_ADLAN_91.\"</span>\" : '';\n\t\t\t\t$price \t\t= (!empty($row['price'])) ? \"<span class='label label-primary'>\".$row['price'].\" \".$row['currency'].\"</span>\" : \"<span class='label label-success'>\".EPL_ADLAN_93.\"</span>\";\n\t\t\t\n\t\t\t\t$data[] = array(\n\t\t\t\t\t'plugin_id'\t\t\t\t=> $row['params']['id'],\n\t\t\t\t\t'plugin_mode'\t\t\t=> $row['params']['mode'],\n\t\t\t\t\t'plugin_icon'\t\t\t=> vartrue($row['icon'],'e-plugins-32'),\n\t\t\t\t\t'plugin_name'\t\t\t=> stripslashes($row['name']),\n\t\t\t\t\t'plugin_featured'\t\t=> $featured,\n\t\t\t\t\t'plugin_sef'\t\t\t=> '',\n\t\t\t\t\t'plugin_folder'\t\t\t=> $row['folder'],\n\t\t\t\t\t'plugin_date'\t\t\t=> vartrue($row['date']),\n\t\t\t\t\t'plugin_category'\t\t=> vartrue($row['category'], 'n/a'),\n\t\t\t\t\t'plugin_author'\t\t\t=> vartrue($row['author']),\n\t\t\t\t\t'plugin_version'\t\t=> $row['version'],\n\t\t\t\t\t'plugin_description'\t=> nl2br(vartrue($row['description'])),\n\t\t\t\t\t'plugin_compatible'\t\t=> $badge,\n\t\t\t\t\n\t\t\t\t\t'plugin_website'\t\t=> vartrue($row['authorUrl']),\n\t\t\t\t\t'plugin_url'\t\t\t=> $row['urlView'],\n\t\t\t\t\t'plugin_notes'\t\t\t=> '',\n\t\t\t\t\t'plugin_price'\t\t\t=> $row['price'],\n\t\t\t\t\t'plugin_license'\t\t=> $price\n\t\t\t\t);\t\n\t\t\t\t\n\t\t\t$c++;\n\t\t}\n\n\t\t$fieldList = $this->fields;\n\t\tunset($fieldList['checkboxes']);\n\n\t\t$text = \"\n\t\t\t<form class='form-search form-inline' action='\".e_SELF.\"?\".e_QUERY.\"' id='core-plugin-list-form' method='get'>\n\t\t\t<div id='admin-ui-list-filter' class='e-search '>\".$frm->search('srch', $srch, 'go', $filterName, $filterArray, $filterVal).$frm->hidden('mode','online').\"\n\t\t\t</div>\n\t\t\t</form>\n\t\t\t\n\t\t\t<form action='\".e_SELF.\"?\".e_QUERY.\"' id='core-plugin-list-form' method='post'>\n\t\t\t\t<fieldset class='e-filter' id='core-plugin-list'>\n\t\t\t\t\t<legend class='e-hideme'>\".$caption.\"</legend>\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t<table id=core-plugin-list' class='table adminlist table-striped'>\n\t\t\t\t\t\t\".$frm->colGroup($fieldList,$this->fieldpref).\n\t\t\t\t\t\t$frm->thead($fieldList,$this->fieldpref).\"\n\t\t\t\t\t\t<tbody>\n\t\t\";\t\n\t\t\n\t\t\n\t\n\t\t\n\t\tforeach($data as $key=>$val\t)\n\t\t{\n\t\t//\tprint_a($val);\n\t\t\t$text .= \"<tr>\";\n\t\t\t\t\t\t\n\t\t\tforeach($this->fields as $v=>$foo)\n\t\t\t{\n\t\t\t\tif(!in_array($v,$this->fieldpref) || $v == 'checkboxes')\n\t\t\t\t{\n\t\t\t\t\tcontinue;\t\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t$_value = $val[$v];\n\t\t\t\tif($v == 'plugin_name') $_value .= $val['plugin_featured'];\n\t\t\t\t// echo '<br />v='.$v;\n\t\t\t\t$text .= \"<td style='height: 40px' class='\".vartrue($this->fields[$v]['class'],'left').\"'>\".$frm->renderValue($v, $_value, $this->fields[$v], $key).\"</td>\\n\";\n\t\t\t}\n\t\t\t$text .= \"<td class='right'>\".$this->options($val).\"</td>\";\n\t\t\t$text .= \"</tr>\";\t\t\n\t\t\t\n\t\t}\n\t\t\n\t\t\n\t\t$text .= \"\n\t\t\t\t\t\t</tbody>\n\t\t\t\t\t</table>\";\n\t\t$text .= \"\n\t\t\t\t</fieldset>\n\t\t\t</form>\n\t\t\";\n\t\t\n\t\t$amount = 30;\n\t\t\n\t\t\n\t\tif($total > $amount)\n\t\t{\n\t\t\t$parms = $total.\",\".$amount.\",\".$from.\",\".e_SELF.'?mode=online&amp;frm=[FROM]';\n\n\t\t\tif(!empty($srch))\n\t\t\t{\n\t\t\t\t$parms .= '&amp;srch='.$srch;\n\t\t\t}\n\n\t\t\t$text .= \"<div class='control-group form-inline input-inline' style='text-align:center;margin-top:10px'>\".$tp->parseTemplate(\"{NEXTPREV=$parms}\",TRUE).\"</div>\";\n\t\t}\n\n\t\treturn $text;\n\n\t}\n\t\n\t\n\t\n\tfunction options($data)\n\t{\n\t\t\t\n\t//\tprint_a($data);\n\n\t\t\t\t\n\n\t\t//$url = e_SELF.\"?src=\".base64_encode($d);\n\t//\t$url = e_SELF.'?action=download&amp;src='.base64_encode($d);//$url.'&amp;action=download';\n\t\t$id = 'plug_'.$data['plugin_id'];\n\t\t//<button type='button' data-target='{$id}' data-loading='\".e_IMAGE.\"/generic/loading_32.gif' class='btn btn-primary e-ajax middle' value='Download and Install' data-src='\".$url.\"' ><span>Download and Install</span></button>\n\t\t$modalCaption = (!empty($data['plugin_price'])) ? EPL_ADLAN_92.\" \".$data['plugin_name'].\" \".$data['plugin_version'] : EPL_ADLAN_230.\" \".$data['plugin_name'].\" \".$data['plugin_version'];\n\n\t\t$srcData = array(\n\t\t\t'plugin_id'     => $data['plugin_id'],\n\t\t\t'plugin_folder' => $data['plugin_folder'],\n\t\t\t'plugin_price'  => $data['plugin_price'],\n\t\t\t'plugin_mode'   => $data['plugin_mode'],\n\t\t\t'plugin_url'    => $data['plugin_url'],\n\t\t);\n\n\n\t\t$d = http_build_query($srcData,false,'&');\n\t\t$url = e_SELF.'?mode=download&src='.base64_encode($d);\n\t\t$dicon = '<a title=\"'.EPL_ADLAN_237.'\" class=\"e-modal btn btn-default\" href=\"'.$url.'\" rel=\"external\" data-loading=\"'.e_IMAGE.'/generic/loading_32.gif\"  data-cache=\"false\" data-modal-caption=\"'.$modalCaption.'\"  target=\"_blank\" >'.ADMIN_INSTALLPLUGIN_ICON.'</a>';\n\n\n\n\t\t// Temporary Pop-up version.\n\t//\t$dicon = '<a class=\"e-modal\" href=\"'.$data['plugin_url'].'\" rel=\"external\" data-modal-caption=\"'.$data['plugin_name'].\" \".$data['plugin_version'].'\"  target=\"_blank\" ><img class=\"top\" src=\"'.e_IMAGE_ABS.'icons/download_32.png\" alt=\"\"  /></a>';\n\n\t//\t$dicon = \"<a data-toggle='modal' data-modal-caption=\\\"Downloading \".$data['plugin_name'].\" \".$data['plugin_version'].\"\\\" href='{$url}' data-cache='false' data-target='#uiModal' title='\".$LAN_DOWNLOAD.\"' ><img class='top' src='\".e_IMAGE_ABS.\"icons/download_32.png' alt=''  /></a> \";\n\n\t\treturn \"<div id='{$id}' class='right' >\n\t\t{$dicon}\n\t\t</div>\";\t\t\t\t\n\t}\n\n\n\n\tprivate function pluginDownload()\n\t{\n\t\tdefine('e_IFRAME', true);\n\t\t$frm = e107::getForm();\n\t\t$mes = e107::getMessage();\n\t\t$tp = e107::getParser();\n\t\t\n\t//\tprint_a($_GET); \t\n\t\t\n\t\t$string =  base64_decode($_GET['src']);\t\n\t\tparse_str($string, $data);\n\n\t\tif(deftrue('e_DEBUG_MARKETPLACE'))\n\t\t{\n\t\t\techo \"<b>DEBUG MODE ACTIVE (no downloading)</b><br />\";\n\t\t\techo '$_GET[src]: ';\n\t\t\tprint_a($_GET);\n\n\t\t\techo 'base64 decoded and parsed as $data:';\n\t\t\tprint_a($data);\n\t\t\treturn false;\n\t\t}\n\n\t\t$pluginFolder = !empty($data['plugin_folder']) ? $tp->filter($data['plugin_folder']) : '';\n\t\t$pluginUrl = !empty($data['plugin_url']) ? $tp->filter($data['plugin_url']) : '';\n\t\t$pluginID = !empty($data['plugin_id']) ? $tp->filter($data['plugin_id']) : '';\n\t\t$pluginMode = !empty($data['plugin_mode']) ? $tp->filter($data['plugin_mode']) : '';\n\n\t\tif(!empty($data['plugin_price']))\n\t\t{\n\t\t\te107::getRedirect()->go($pluginUrl);\n\t\t\treturn true;\n\t\t}\n\n\t\t$mp = $this->getMarketplace();\n\t//\t$mp->generateAuthKey($e107SiteUsername, $e107SiteUserpass);\n\t\n\n\t\t\n\t\t// Server flush useless. It's ajax ready state 4, we can't flush (sadly) before that (at least not for all browsers) \n\t \t$mes->addSuccess(EPL_ADLAN_94);\n\n\t\tif($mp->download($pluginID, $pluginMode, 'plugin'))\n\t\t{\n\t\t\t$this -> pluginCheck(true); // rescan the plugin directory\n\t\t\t$text = e107::getPlugin()->install($pluginFolder);\n\n\t\t\t$mes->addInfo($text); \n\t\t\techo $mes->render('default', 'success'); \n\t\t}\n\t\telse\n\t\t{\n\t\t\t// Unable to continue\n\t\t\techo $mes->addError(EPL_ADLAN_95)->render('default', 'error');\n\t\t}\n\t\t\n\t\techo $mes->render('default', 'debug'); \n\t\treturn; \n\t\t\n\t\t\n\t\t\n\t\t$text =\"<iframe src='\".$pluginUrl.\"' style='width:99%; height:500px; border:0px'>Loading...</iframe>\";\n\t//\tprint_a($data); \n\t\t$text .= $frm->open('upload-url-form','post');\n\t\t\n\t\t$text .= \"<div class='form-inline' style='padding:20px'>\";\n\t\t$text .= \"<input type='text' name='upload_url' size='255' style='width:70%;height:50px;text-align:center' placeholder='\".EPL_ADLAN_96.\"' />\";\n\t\t$text .= $frm->admin_button('upload_remote_url',1,'create','Install');\n\t    $text .= \"</div>\";\n\t\t$text .= \"</div>\\n\\n\";\n\t\t\n\t\t$text .= $frm->close();\n\t\techo $text; \n\t\t\n\t}\n\t\n\n\tfunction pluginUninstall()\n\t{\n\n\t\tif(!isset($_POST['uninstall_confirm']))\n\t\t{\t// $id is already an integer\n\n\t\t\t$this->pluginConfirmUninstall();\n\t\t\treturn;\n\t\t}\n\n\t\t$post = e107::getParser()->filter($_POST);\n\t\t$text = e107::getPlugin()->uninstall($this->id, $post);\n\t\t$this->show_message($text, E_MESSAGE_SUCCESS);\n\n\t\t$this->action = 'installed';\n\n\t\t$log = e107::getPlugin()->getLog();\n\t\te107::getDebug()->log($log);\n\n\t\treturn;\n\n   }\n\n\n\n\n\n   function pluginProcessUpload()\n   {\n\t\t\tif (!$_POST['ac'] == md5(ADMINPWCHANGE))\n\t\t\t{\n\t\t\t\texit;\n\t\t\t}\n\t\t\t\n\t\t\t$fl = e107::getFile();\n\t\t\t$data = $fl->getUploaded(e_TEMP); \n\t\t\t$mes = e107::getMessage();\n\t\t\t\n\t\t\tif(empty($data[0]['error']))\n\t\t\t{\n\t\t\t\tif($fl->unzipArchive($data[0]['name'],'plugin'))\n\t\t\t\t{\n\t\t\t\t\t$mes->addSuccess(EPL_ADLAN_43); \n\t\t\t\t}\n\t\t\t\telse \n\t\t\t\t{\n\t\t\t\t\t$mes->addError(EPL_ADLAN_97);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t//\t$data = process_uploaded_files(e_TEMP);\n\t\t//\tprint_a($data); \n\t\t\t\n\t\t\techo $mes->render(); \n\t\t\t\n\t\t\treturn true;\n\n\n   }\n\n\n// -----------------------------------------------------------------------------\n// TODO FIXME - This needs cleaning: e107::getMessage(), limit the globals, etc. \n\n   function pluginInstall()\n   {\n        global $plugin;\n\t\t$text = $plugin->install_plugin($this->id);\n\t\t\n\t\t$log = e107::getAdminLog();\n\t\t\t\n\t\t\t\n\t\t\t\n\t\tif ($text === FALSE)\n\t\t{ // Tidy this up\n\t\t\t$this->show_message(EPL_ADLAN_99, E_MESSAGE_ERROR);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$plugin->save_addon_prefs('update');\n\t\t\t$info = $plugin->getinfo($this->id);\n\t\t\t \n\t\t\t$name = deftrue($info['plugin_name'],$info['plugin_name']). \" v\".$info['plugin_version']. \"({e_PLUGIN}\".$info['plugin_path'].\")\";\n\t\t\t \n\t\t\t$log->log_event('PLUGMAN_01', $name, E_LOG_INFORMATIVE, '');\n\t\t\n\t\t\t$this->show_message($text, E_MESSAGE_SUCCESS);\n\t\t}\n\n   }\n\n\n// -----------------------------------------------------------------------------\n\n\tfunction pluginUpgrade()\n\t{\n\t\t$pref \t\t= e107::getPref();\n\t\t$admin_log \t= e107::getAdminLog();\n\t\t$plugin \t= e107::getPlugin();\n\n\t  \t$sql \t\t= e107::getDb();\n   \t\t$mes \t\t= e107::getMessage(); \n\t\t$plug \t\t= $plugin->getinfo($this->id);\n\n\t\t$text = '';\n\n\t\t$_path = e_PLUGIN.$plug['plugin_path'].'/';\n\t\tif(file_exists($_path.'plugin.xml'))\n\t\t{\n\t\t\t$plugin->install_plugin_xml($this->id, 'upgrade');\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$eplug_folder = null;\n\t\t\t$upgrade_alter_tables = null;\n\t\t\t$upgrade_add_prefs = null;\n\t\t\t$upgrade_remove_prefs = null;\n\t\t\t$upgrade_add_array_pref = null;\n\t\t\t$upgrade_remove_array_pref = null;\n\t\t\t$eplug_version = null;\n\n\n\n\t\t\tinclude(e_PLUGIN.$plug['plugin_path'].'/plugin.php');\n\n\t\t\t$text = '';\n\n\t\t\t$func = $eplug_folder.'_upgrade';\n\t\t\tif (function_exists($func))\n\t\t\t{\n\t\t\t\t$text .= call_user_func($func);\n\t\t\t}\n\n\t\t\tif (is_array($upgrade_alter_tables))\n\t\t\t{\n\t\t\t\t$result = $plugin->manage_tables('upgrade', $upgrade_alter_tables);\n\t\t\t\tif (true !== $result)\n\t\t\t\t{\n\t\t\t\t\t//$text .= EPL_ADLAN_9.'<br />';\n\t\t\t\t\t$mes->addWarning(EPL_ADLAN_9)\n\t\t\t\t\t\t->addDebug($result);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$text .= EPL_ADLAN_7.\"<br />\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (is_array($upgrade_add_prefs))\n\t\t\t{\n\t\t\t\t$plugin->manage_prefs('add', $upgrade_add_prefs);\n\t\t\t\t$text .= EPL_ADLAN_8.'<br />';\n\t\t\t}\n\n\t\t\tif (is_array($upgrade_remove_prefs))\n\t\t\t{\n\t\t\t\t$plugin->manage_prefs('remove', $upgrade_remove_prefs);\n\t\t\t}\n\n\t\t\tif (is_array($upgrade_add_array_pref))\n\t\t\t{\n\t\t\t\tforeach($upgrade_add_array_pref as $key => $val)\n\t\t\t\t{\n\t\t\t\t\t$plugin->manage_plugin_prefs('add', $key, $eplug_folder, $val);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (is_array($upgrade_remove_array_pref))\n\t\t\t{\n\t\t\t\tforeach($upgrade_remove_array_pref as $key => $val)\n\t\t\t\t{\n\t\t\t\t\t$plugin->manage_plugin_prefs('remove', $key, $eplug_folder, $val);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t$plugin->manage_search('upgrade', $eplug_folder);\n\t\t\t$plugin->manage_notify('upgrade', $eplug_folder);\n\n\t\t\t$eplug_addons = $plugin -> getAddons($eplug_folder);\n\n\t\t\t$info = $plugin->getinfo($this->id);\n\t\t\t\t \n\t\t\t$name = deftrue($info['plugin_name'],$info['plugin_name']). \" v\".$eplug_version. \"({e_PLUGIN}\".$info['plugin_path'].\")\";\n\n\t\t\te107::getLog()->add('PLUGMAN_02', $name, E_LOG_INFORMATIVE, '');\n\t\t\t$text .= (isset($eplug_upgrade_done)) ? '<br />'.$eplug_upgrade_done : \"<br />\".LAN_UPGRADE_SUCCESSFUL;\n\t\t\t$sql->update('plugin', \"plugin_version ='{$eplug_version}', plugin_addons='{$eplug_addons}' WHERE plugin_id='$this->id' \");\n\t\t\t$pref['plug_installed'][$plug['plugin_path']] = $eplug_version; \t\t\t// Update the version\n\t\t\t\n\t\t\te107::getConfig('core')->setPref($pref);\n\t\t\t$plugin->rebuildUrlConfig();\n\t\t\te107::getConfig('core')->save();\n\t\t}\n\n\n\t\t$mes->addSuccess($text);\n\t\t$plugin->save_addon_prefs('update');\n\n   }\n\n\n// -----------------------------------------------------------------------------\n\n   function pluginRepair()\n   {\n      // global $plug;\n\n\t\t\t$plug = e107::getSingleton('e107plugin')->getinfo($this->id);\n\n\t\t\t$_path = e_PLUGIN.$plug['plugin_path'].'/';\n\t\t\tif(file_exists($_path.'plugin.xml'))\n\t\t\t{\n\t\t\t\t// $text .= $plugin->install_plugin_xml($this->id, 'refresh');\n\t\t\t\te107::getSingleton('e107plugin')->refresh($plug['plugin_path']);\n\t\t\t\te107::getLog()->add('PLUGMAN_04', $this->id.':'.$plug['plugin_path'], E_LOG_INFORMATIVE, '');\n\t\t\t}\n\n    }\n\n// -----------------------------------------------------------------------------\n\n\t\t// Check for new plugins, create entry in plugin table ...\n    function pluginCheck($force=false)\n\t{\n\t\tglobal $plugin;\n\n\t\tif(!PLUGIN_SCAN_INTERVAL)\n\t\t{\n\t\t\t$plugin->update_plugins_table('update');\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tif((time() > vartrue($_SESSION['nextPluginFolderScan'],0)) || $force == true)\n\t\t{\n\t\t\t$plugin->update_plugins_table('update');\n\t\t}\n\t\t\n\t\t$_SESSION['nextPluginFolderScan'] = time() + PLUGIN_SCAN_INTERVAL;\n\t\t//echo \"TIME = \".$_SESSION['nextPluginFolderScan'];\n\t\t\n    }\n\t\t// ----------------------------------------------------------\n\t\t//        render plugin information ...\n\n\n// -----------------------------------------------------------------------------\n\n\n    function pluginUpload()\n\t{\n         global $plugin;\n\t\t $frm = e107::getForm();\n\n\t\t//TODO 'install' checkbox in plugin upload form. (as it is for theme upload)\n\n\n\t\t\tif(!is_writable(e_PLUGIN))\n\t\t\t{\n\t\t\t   \t$text = EPL_ADLAN_44;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t  // Get largest allowable file upload\n\t\t\t  require_once(e_HANDLER.'upload_handler.php');\n\t\t\t  $max_file_size = get_user_max_upload();\n\n\t\t\t  $text = \"\n\t\t\t\t<form enctype='multipart/form-data' method='post' action='\".e_SELF.\"'>\n                <table class='table adminform'>\n                \t<colgroup>\n                \t\t<col class='col-label' />\n                \t\t<col class='col-control' />\n                \t</colgroup>\n\t\t\t\t<tr>\n\t\t\t\t<td>\".EPL_ADLAN_37.\"</td>\n\t\t\t\t<td>\n\t\t\t\t<input type='hidden' name='MAX_FILE_SIZE' value='{$max_file_size}' />\n\t\t\t\t<input type='hidden' name='ac' value='\".md5(ADMINPWCHANGE).\"' />\n\t\t\t\t<input class='tbox' type='file' name='file_userfile[]' size='50' />\n\t\t\t\t</td>\n                </tr>\n\t\t\t\t</table>\n\n\t\t\t\t<div class='center buttons-bar'>\";\n                $text .= $frm->admin_button('upload', EPL_ADLAN_38, 'submit', EPL_ADLAN_38);\n\n\t\t\t\t$text .= \"\n\t\t\t\t</div>\n\n\t\t\t\t</form>\\n\";\n\t\t\t}\n\n         e107::getRender()->tablerender(ADLAN_98.SEP.EPL_ADLAN_38, $text);\n\t}\n\n// -----------------------------------------------------------------------------\n\n\n\n\n\tfunction pluginRenderList() // Uninstall and Install sorting should be fixed once and for all now !\n\t{\n\n\t\tglobal $plugin;\n\t\t$frm = e107::getForm();\n\t\t$mes = e107::getMessage();\n\n\t\tif($this->action == \"\" || $this->action == \"installed\")\n\t\t{\n\t\t\t$installed = $plugin->getall(1);\n\n\t\t\t$mp = $this->getMarketplace();\n\n\t\t\t$versions = $mp->getVersionList();\n\n\t\t//\tprint_a($versions);\n\t\t\t$caption = EPL_ADLAN_22;\n\t\t\t$pluginRenderPlugin = $this->pluginRenderPlugin($installed, $versions);\n\t\t\t$button_mode = \"uninstall-selected\";\n\t\t\t$button_caption = EPL_ADLAN_85;\n\t\t\t$button_action = \"delete\";\n\t\t}\n\t\tif($this->action == \"avail\")\n\t\t{\n\t\t\t$uninstalled = $plugin->getall(0);\t\t\n\t\t\t$caption = EPL_ADLAN_23;\n\t\t\t$pluginRenderPlugin = $this->pluginRenderPlugin($uninstalled);\n\t\t\t$button_mode = \"install-selected\";\n\t\t\t$button_caption = EPL_ADLAN_84;\n\t\t\t$button_action = \"update\";\n\t\t}\n\n\t\t$text = \"\n\t\t\t<form action='\".e_SELF.\"?\".e_QUERY.\"' id='core-plugin-list-form' method='post'>\n\t\t\t\t<fieldset id='core-plugin-list'>\n\t\t\t\t\t<legend class='e-hideme'>\".vartrue($caption).\"</legend>\n\t\t\t\t\t<table class='table adminlist table-striped'>\n\t\t\t\t\t\t\".$frm->colGroup($this->fields,$this->fieldpref).\n\t\t\t\t\t\t$frm->thead($this->fields,$this->fieldpref).\"\n\t\t\t\t\t\t<tbody>\n\t\t\";\n\n\t\tif(vartrue($pluginRenderPlugin))\n\t\t{\n\t\t\t$text .= $pluginRenderPlugin;\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$text .= \"<tr><td class='center' colspan='\".count($this->fields).\"'>\";\n \t\t\t$text .= str_replace(\"[x]\", \"<a href='\".e_ADMIN.\"plugin.php?avail'>\".EPL_ADLAN_100.\"</a>\", EPL_ADLAN_101);\n\t\t\t$text .= \"</td></tr>\";\n\t\t}\n\n\t\t$text .= \"\n\t\t\t\t\t\t</tbody>\n\t\t\t\t\t</table>\";\n\n\t\tif($this->action == \"avail\")\n\t\t{\n\t\t\t$text .= \"\n\t\t\t\t\t<div class='buttons-bar center'>\".$frm->admin_button($button_mode, $button_caption, $button_action).\"</div>\";\n\t\t}\n\t\t$text .= \"\n\t\t\t\t</fieldset>\n\t\t\t</form>\n\t\t\";\n\n\t\te107::getRender()->tablerender(ADLAN_98.SEP.$caption, $mes->render(). $text);\n\t}\n\n\n// -----------------------------------------------------------------------------\n\n\tfunction pluginRenderPlugin($pluginList, $versions = array())\n\t{\n\t\t\tglobal $plugin; \n\t\t\t\n\t\t\tif (empty($pluginList)) return '';\n\n\t\t\t$tp = e107::getParser();\n\t\t\t$frm = e107::getForm();\n\t\t\t\n\t\t\t$pgf = new pluginmanager_form; \n\n\t\t\t$text = \"\";\n\n\n\n\t\t\tforeach($pluginList as $plug)\n\t\t\t{\n\t\t\t\te107::loadLanFiles($plug['plugin_path'],'admin');\n\t\t\t\t\n\t\t\t\tif($this->action == \"avail\")\n\t\t\t\t{\n\t\t\t\t\te107::lan($plug['plugin_path'],'global', true); // Load language files. \n\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\n\n\t\t\t\t$_path = e_PLUGIN.$plug['plugin_path'].'/';\n\n\t\t\t\t$plug_vars = false;\n\t\t\t\t$plugin_config_icon = \"\";\n\n\n\n\t\t\t\tif($plugin->parse_plugin($plug['plugin_path']))\n\t\t\t\t{\n\t\t\t\t\t$plug_vars = $plugin->plug_vars;\n\t\t\t\t}\n\n\n\n\t\t\t\tif(varset($plug['plugin_category']) == \"menu\") // Hide \"Menu Only\" plugins.\n\t\t\t\t{\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tif($plug_vars)\n\t\t\t\t{\n\n\t\t\t\t\t$icon_src = (isset($plug_vars['plugin_php']) ? e_PLUGIN : $_path).$plug_vars['administration']['icon'];\n\t\t\t\n                   \t$plugin_icon = $plug_vars['administration']['icon'] ? $icon_src : $tp->toGlyph('e-cat_plugins-32');\n              \n                    \n                    $conf_file = \"#\";\n\t\t\t\t\t$conf_title = \"\";\n\n\t\t\t\t\tif ($plug_vars['administration']['configFile'] && $plug['plugin_installflag'] == true)\n\t\t\t\t\t{\n\t\t\t\t\t\t$conf_file = e_PLUGIN.$plug['plugin_path'].'/'.$plug_vars['administration']['configFile'];\n\t\t\t\t\t\t$conf_title = LAN_CONFIGURE.' '.$tp->toHTML($plug_vars['@attributes']['name'], \"\", \"defs,emotes_off, no_make_clickable\");\n\t\t\t\t\t//\t$plugin_icon = \"<a title='{$conf_title}' href='{$conf_file}' >\".$plugin_icon.\"</a>\";\n\t\t\t\t\t\t$plugin_config_icon = \"<a class='btn btn-default' title='{$conf_title}' href='{$conf_file}' >\".ADMIN_CONFIGURE_ICON.\"</a>\";\n\t\t\t\t\t}\n\n\t\t\t\t\t$plugEmail = varset($plug_vars['author']['@attributes']['email'],'');\n\t\t\t\t\t$plugAuthor = varset($plug_vars['author']['@attributes']['name'],'');\n\t\t\t\t\t$plugURL = varset($plug_vars['author']['@attributes']['url'],'');\n\t\t\t\t\t$plugDate\t= varset($plug_vars['@attributes']['date'],'');\n\t\t\t\t\t$compatibility\t= varset($plug_vars['@attributes']['compatibility'],'');\n\t\t\t\t\t\n\t\t\t\t\t$description = varset($plug_vars['description']['@attributes']['lang']) ? $tp->toHTML($plug_vars['description']['@attributes']['lang'], false, \"defs,emotes_off, no_make_clickable\") : $tp->toHTML($plug_vars['description']['@value'], false, \"emotes_off, no_make_clickable\") ;\n\t\t\t\t\t\n                    $plugReadme = \"\";\n\t\t\t\t\tif(varset($plug['plugin_installflag']))\n\t\t\t\t\t{\n\t\t\t\t\t\t$plugName = \"<a title='{$conf_title}' href='{$conf_file}' >\".$tp->toHTML($plug['plugin_name'], false, \"defs,emotes_off, no_make_clickable\").\"</a>\";\n                    }\n                    else\n\t\t\t\t\t{\n                    \t$plugName = $tp->toHTML($plug['plugin_name'], false, \"defs,emotes_off, no_make_clickable\");\n\t\t\t\t\t}\n\t\t\t\t\tif(varset($plug_vars['readme']))   // 0.7 plugin.php\n\t\t\t\t\t{\n                    \t$plugReadme = $plug_vars['readme'];\n\t\t\t\t\t}\n\t\t\t\t\tif(varset($plug_vars['readMe'])) // 0.8 plugin.xml\n\t\t\t\t\t{\n                    \t$plugReadme = $plug_vars['readMe'];\n\t\t\t\t\t}\n\n\t\t\t\t\tif(!file_exists($plugin_icon))\n\t\t\t\t\t{\n\t\t\t\t\t\t$plugin_icon = 'e-cat_plugins-32'; // e_IMAGE.\"admin_images/cat_plugins_32.png\";\n\t\t\t\t\t}\n\n\t\t\t\t\t\t\n\t\t\t\t\t$data = array(\n\t\t\t\t\t'plugin_id'\t\t\t\t=> $plug['plugin_id'],\n\t\t\t\t\t'plugin_icon'\t\t\t=> $plugin_icon,\n\t\t\t\t\t'plugin_name'\t\t\t=> $plugName,\n\t\t\t\t\t'plugin_folder'\t\t\t=> $plug['plugin_path'],\n\t\t\t\t\t'plugin_date'\t\t\t=> $plugDate,\n\t\t\t\t\t'plugin_category'\t\t=> vartrue($plug['plugin_category']),\n\t\t\t\t\t'plugin_author'\t\t\t=> vartrue($plugAuthor), // vartrue($plugEmail) ? \"<a href='mailto:\".$plugEmail.\"' title='\".$plugEmail.\"'>\".$plugAuthor.\"</a>\" : vartrue($plugAuthor),\n\t\t\t\t\t'plugin_version'\t\t=> $plug['plugin_version'],\n\t\t\t\t\t'plugin_description'\t=> $description,\n\t\t\t\t\t'plugin_compatible'\t\t=> $this->compatibilityLabel($plug_vars['@attributes']['compatibility']),\n\t\t\t\t\n\t\t\t\t\t'plugin_website'\t\t=> vartrue($plug['authorUrl']),\n\t\t\t//\t\t'plugin_url'\t\t\t=> vartrue($plugURL), // ; //  ? \"<a href='{$plugURL}' title='{$plugURL}' >\".ADMIN_URL_ICON.\"</a>\" : \"\",\n\t\t\t\t\t'plugin_notes'\t\t\t=> ''\n\t\t\t\t\t);\t\n\n\n\t\t\t\t\t$pgf->plug_vars = $plug_vars;\n\t\t\t\t\t$pgf->plug\t\t= $plug;\n\t\t\t\t\t$text \t\t\t.= $pgf->renderTableRow($this->fields, $this->fieldpref, $data, 'plugin_id');\n\n\n\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn $text;\n\t}\n\n\n// -----------------------------------------------------------------------------\n\n\n\n\t\tfunction pluginConfirmUninstall()\n\t\t{\n\t\t\tglobal $plugin;\n\n\t\t\t$frm \t= e107::getForm();\n\t\t\t$tp \t= e107::getParser();\n\t\t\t$mes \t= e107::getMessage();\n\n\t\t\t$plug = $plugin->getinfo($this->id);\n\n\t\t\tif ($plug['plugin_installflag'] == true )\n\t\t\t{\n\t\t\t\tif($plugin->parse_plugin($plug['plugin_path']))\n\t\t\t\t{\n\t\t\t\t\t$plug_vars = $plugin->plug_vars;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\treturn FALSE;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\treturn FALSE;\n\t\t\t}\n\t\t\t$userclasses = '';\n\t\t\t$eufields = '';\n\t\t\tif (isset($plug_vars['userClasses']))\n\t\t\t{\n\t\t\t\tif (isset($plug_vars['userclass']['@attributes']))\n\t\t\t\t{\n\t\t\t\t\t$plug_vars['userclass'][0]['@attributes'] = $plug_vars['userclass']['@attributes'];\n\t\t\t\t\tunset($plug_vars['userclass']['@attributes']);\n\t\t\t\t}\n\t\t\t\t$spacer = '';\n\t\t\t\tforeach ($plug_vars['userClasses']['class'] as $uc)\n\t\t\t\t{\n\t\t\t\t\t$userclasses .= $spacer.$uc['@attributes']['name'].' - '.$uc['@attributes']['description'];\n\t\t\t\t\t$spacer = '<br />';\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (isset($plug_vars['extendedFields']))\n\t\t\t{\n\t\t\t\tif (isset($plug_vars['extendedFields']['@attributes']))\n\t\t\t\t{\n\t\t\t\t\t$plug_vars['extendedField'][0]['@attributes'] = $plug_vars['extendedField']['@attributes'];\n\t\t\t\t\tunset($plug_vars['extendedField']['@attributes']);\n\t\t\t\t}\n\t\t\t\t$spacer = '';\n\t\t\t\tforeach ($plug_vars['extendedFields']['field'] as $eu)\n\t\t\t\t{\n\t\t\t\t\t$eufields .= $spacer.'plugin_'.$plug_vars['folder'].'_'.$eu['@attributes']['name'];\n\t\t\t\t\t$spacer = '<br />';\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif(is_writable(e_PLUGIN.$plug['plugin_path']))\n\t\t\t{\n\t\t\t\t$del_text = $frm->select('delete_files','yesno',0);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$del_text = \"\n\t\t\t\t\".EPL_ADLAN_53.\"\n\t\t\t\t<input type='hidden' name='delete_files' value='0' />\n\t\t\t\t\";\n\t\t\t}\n\n\t\t\t$text = \"\n\t\t\t<form action='\".e_SELF.\"?\".e_QUERY.\"' method='post'>\n\t\t\t<fieldset id='core-plugin-confirmUninstall'>\n\t\t\t<legend>\".EPL_ADLAN_54.\" \".$tp->toHtml($plug_vars['@attributes']['name'], \"\", \"defs,emotes_off, no_make_clickable\").\"</legend>\n            <table class='table adminform'>\n            \t<colgroup>\n            \t\t<col class='col-label' />\n            \t\t<col class='col-control' />\n            \t</colgroup>\n \t\t\t<tr>\n\t\t\t\t<td>\".EPL_ADLAN_55.\"</td>\n\t\t\t\t<td>\".LAN_YES.\"</td>\n\t\t\t</tr>\";\n\n\t\t\t$opts = array();\n\n\t\t\t$opts['delete_tables'] = array(\n\t\t\t\t\t'label'\t\t\t=> EPL_ADLAN_57,\n\t\t\t\t\t'helpText'\t\t=> EPL_ADLAN_58,\n\t\t\t\t\t'itemList'\t\t=> array(1=>LAN_YES,0=>LAN_NO),\n\t\t\t\t\t'itemDefault' \t=> 1\n\t\t\t);\n\n\t\t\tif ($userclasses)\n\t\t\t{\n\t\t\t\t$opts['delete_userclasses'] = array(\n\t\t\t\t\t'label'\t\t\t=> EPL_ADLAN_78,\n\t\t\t\t\t'preview'\t\t=> $userclasses,\n\t\t\t\t\t'helpText'\t\t=> EPL_ADLAN_79,\n\t\t\t\t\t'itemList'\t\t=> array(1=>LAN_YES,0=>LAN_NO),\n\t\t\t\t\t'itemDefault' \t=> 1\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif ($eufields)\n\t\t\t{\n\t\t\t\t$opts['delete_xfields'] = array(\n\t\t\t\t\t'label'\t\t\t=> EPL_ADLAN_80,\n\t\t\t\t\t'preview'\t\t=> $eufields,\n\t\t\t\t\t'helpText'\t\t=> EPL_ADLAN_79,\n\t\t\t\t\t'itemList'\t\t=> array(1=>LAN_YES,0=>LAN_NO),\n\t\t\t\t\t'itemDefault' \t=> 0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t$med = e107::getMedia();\n\t\t\t$icons = $med->listIcons(e_PLUGIN.$plug['plugin_path']);\n\n\t\t\t$iconText = '';\n\n\t\t\tif(count($icons)>0)\n\t\t\t{\n\t\t\t\tforeach($icons as $key=>$val)\n\t\t\t\t{\n\t\t\t\t\t$iconText .= \"<img src='\".$tp->replaceConstants($val).\"' alt='' />\";\n\t\t\t\t}\n\n\t\t\t\t$iconText = '<div class=\"icon-pool-preview\">'.$iconText.'</div>';\n\n\t\t\t\t$opts['delete_ipool'] = array(\n\t\t\t\t\t'label'\t\t\t=> EPL_ADLAN_231,\n\t\t\t\t\t'preview'\t\t=> $iconText,\n\t\t\t\t\t'helpText'\t\t=> EPL_ADLAN_79,\n\t\t\t\t\t'itemList'\t\t=> array(1=>LAN_YES,0=>LAN_NO),\n\t\t\t\t\t'itemDefault' \t=> 1\n\t\t\t\t);\n\n\n\t\t\t}\n\n\n\n\t\t\tif(is_readable(e_PLUGIN.$plug['plugin_path'].\"/\".$plug['plugin_path'].\"_setup.php\"))\n\t\t\t{\n\t\t\t\tinclude_once(e_PLUGIN.$plug['plugin_path'].\"/\".$plug['plugin_path'].\"_setup.php\");\n\n\n\t\t\t\t$mes->add(\"Loading \".e_PLUGIN.$plug['plugin_path'].\"/\".$plug['plugin_path'].\"_setup.php\", E_MESSAGE_DEBUG);\n\n\t\t\t\t$class_name = $plug['plugin_path'].\"_setup\";\n\n\t\t\t\tif(class_exists($class_name))\n\t\t\t\t{\n\t\t\t\t\t$obj = new $class_name;\n\t\t\t\t\tif(method_exists($obj,'uninstall_options'))\n\t\t\t\t\t{\n\t\t\t\t\t\t$arr = call_user_func(array($obj,'uninstall_options'), $this);\n\t\t\t\t\t\tforeach($arr as $key=>$val)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$newkey = $plug['plugin_path'].\"_\".$key;\n\t\t\t\t\t\t\t$opts[$newkey] = $val;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tforeach($opts as $key=>$val)\n\t\t\t{\n\t\t\t\t$text .= \"<tr>\\n<td class='top'>\".$tp->toHTML($val['label'],FALSE,'TITLE');\n\t\t\t\t$text .= varset($val['preview']) ? \"<div class='indent'>\".$val['preview'].\"</div>\" : \"\";\n\t\t\t\t$text .= \"</td>\\n<td>\".$frm->select($key,$val['itemList'],$val['itemDefault']);\n\t\t\t\t$text .= varset($val['helpText']) ? \"<div class='field-help'>\".$val['helpText'].\"</div>\" : \"\";\n\t\t\t\t$text .= \"</td>\\n</tr>\\n\";\n\t\t\t}\n\n\n\t\t\t$text .=\"<tr>\n\t\t\t<td>\".EPL_ADLAN_59.\"</td>\n\t\t\t<td>{$del_text}\n\t\t\t<div class='field-help'>\".EPL_ADLAN_60.\"</div>\n\t\t\t</td>\n\t\t\t</tr>\n\t\t\t</table>\n\t\t\t<div class='buttons-bar center'>\";\n\t\t\t\n\t\t\t$text .= $frm->admin_button('uninstall_confirm',EPL_ADLAN_3,'submit');\n\t\t\t$text .= $frm->admin_button('uninstall_cancel',EPL_ADLAN_62,'cancel');\n\n\n             //   $frm->admin_button($name, $value, $action = 'submit', $label = '', $options = array());\n\n\t\t\t$text .= \"</div>\n\t\t\t</fieldset>\n\t\t\t</form>\n\t\t\t\";\n\t\t//\te107::getRender()->tablerender(EPL_ADLAN_63.SEP.$tp->toHtml($plug_vars['@attributes']['name'], \"\", \"defs,emotes_off, no_make_clickable\"),$mes->render(). $text);\n\n\t\t}\n\n        function show_message($message, $type = E_MESSAGE_INFO, $session = false)\n\t\t{\n\t\t// ##### Display comfort ---------\n\t\t\t$mes = e107::getMessage();\n\t\t\t$mes->add($message, $type, $session);\n\t\t}\n\n        function pluginMenuOptions()\n\t\t{\n\t\t   //\t$e107 = &e107::getInstance();\n\n\t\t\t\t$var['installed']['text'] = EPL_ADLAN_22;\n\t\t\t\t$var['installed']['link'] = e_SELF;\n\n\t\t\t\t$var['avail']['text'] = EPL_ADLAN_23;\n\t\t\t\t$var['avail']['link'] = e_SELF.\"?avail\";\n\n\t\t\t\t\n\t\t\t\t$var['online']['text'] = EPL_ADLAN_220;\n\t\t\t\t$var['online']['link'] = e_SELF.\"?mode=online\";\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tif(E107_DEBUG_LEVEL > 0)\n\t\t\t\t{\t\n\t\t\t\t\t$var['upload']['text'] = EPL_ADLAN_38;\n\t\t\t\t\t$var['upload']['link'] = e_SELF.\"?mode=upload\";\n\t\t\t\t}\n\n\t\t\t\t$var['create']['text'] = EPL_ADLAN_114;\n\t\t\t\t$var['create']['link'] = e_SELF.\"?mode=create\";\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\n\t\t\t\t$keys = array_keys($var);\n\n\t\t\t\t$action = (in_array($this->action,$keys)) ? $this->action : \"installed\";\n\t\t\t\t\n\t\t\t\tif($this->action == 'lans')\n\t\t\t\t{\n\t\t\t\t\t$action = 'create';\n\t\t\t\t}\n\n\t\t\t\t$icon  = e107::getParser()->toIcon('e-plugmanager-24');\n\t\t\t\t$caption = $icon.\"<span>\".ADLAN_98.\"</span>\";\n\n\t\t\t\te107::getNav()->admin($caption, $action, $var);\n\t\t}\n\n\n\n\t\t\n\n} // end of Class.\n*/\n\n/*\nfunction plugin_adminmenu()\n{\n\tglobal $pman;\n\t$pman -> pluginMenuOptions();\n}*/\n\n\n\nclass pluginLanguage\n{\n\t\n\tprivate $scriptFiles \t= array();\n\tprivate $lanFiles \t\t= array(); \n\t\n\tprivate $lanDefs \t\t= array();\n\tprivate $scriptDefs \t= array(); \n\t\n\tprivate $lanDefsData \t= array();\n\tprivate $scriptDefsData = array(); \n\t\n\tprivate $unused\t\t\t= array();\n\tprivate $unsure\t\t\t= array();\n\n\tprivate $excludeLans \t= array('CORE_LC', 'CORE_LC2', 'e_LAN', 'e_LANGUAGE', 'e_LANGUAGEDIR', 'LAN', 'LANGUAGE');\n\t\n\tprivate $useSimilar\t\t= false; \n\t\n\t\n\tfunction __construct()\n\t\t{\n\t\t\n\t\t\tif(!empty($_GET['newplugin']) && $_GET['step']==2)\n\t\t\t{\n\t\t\t\t$plugin = e107::getParser()->filter($_GET['newplugin'],'file');\n\t\t\t\t$this->step2($plugin);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\t\n\t\t\n\t\t\n\t\t\t// return $this->step1();\n\t\t}\n\n\n\n\t\n\t\n\t\tfunction step2($path)\n\t\t{\n\t\t\t$this->plugin = $path; \n\t\t\t\n\t\t\t$fl = e107::getFile();\n\t\t\t\n\t\t\t$files = $fl->get_files(e_PLUGIN.$path.'/languages',null,null,3);\t\n\t\t\t$files2 = $fl->get_files(e_PLUGIN.$path,'\\.php|\\.sc|\\.bb|\\.xml','languages',3);\t\n\t\t\t\n\t\t\t$this->scanLanFile(e_LANGUAGEDIR.\"English/English.php\");\n\t\t\t$this->scanLanFile(e_LANGUAGEDIR.\"English/admin/lan_admin.php\");\t\t\n\t\t\t\n\t\t\tforeach($files as $v)\n\t\t\t{\n\t\t\t\tif(strpos($v['path'],'English')!==false OR strpos($v['fname'],'English')!==false)\n\t\t\t\t{\n\t\t\t\t\t$path = $v['path'].$v['fname'];\n\t\t\t\t\t$this->lanFiles[] = $path;\n\t\t\t\t\t\n\t\t\t\t\t$this->scanLanFile($path);\t\n\t\t\t\t}\n\t\t\t}\n\t\t\t\t\n\t\t\tforeach($files2 as $v)\n\t\t\t{\n\t\t\t\t$path = $v['path'].$v['fname'];\n\t\t\t\t$this->scriptFiles[] = \t$path;\n\t\t\t\t$this->scanScriptFile($path);\n\t\t\t}\n\t\t\t\t\n\t\t\n\t\t\t$this->renderResults(); \n\n\t\t\treturn true;\n\t\t}\n\t\t\n\t\t\n\t\tfunction findSimilar($data)\n\t\t{\n\t\t\t$sim = array(); \n\t\t\t\n\t\t\tforeach($this->lanDefsData as $k=>$v)\n\t\t\t{\n\t\t\t\tif(empty($v['value']))\n\t\t\t\t{\n\t\t\t\t\tcontinue; \t\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif($this->useSimilar == true)\n\t\t\t\t{\n\t\t\t\t\tsimilar_text($v['value'], $data['value'], $percentSimilar);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$percentSimilar = 0; \t\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif((($v['value'] == $data['value'] || $percentSimilar > 89) && $data['file'] != $v['file']))\n\t\t\t\t{\n\t\t\t\t\tif(strpos($v['lan'],'LAN')===false) // Defined constants that don't contain 'LAN'. \n\t\t\t\t\t{\n\t\t\t\t\t\t$v['status'] = 2; \n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$v['status'] = (in_array($v['lan'],$this->used)) ? 1 : 0; \t\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t$sim[] = $v; \n\t\t\t\t\n\t\t\t\t}\t\n\t\t\t}\t\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\treturn $sim; \t\n\t\t\t\n\t\t}\n\t\t\n\t\t\n\t\tfunction renderSimilar($data,$mode='')\n\t\t{\n\t\t\t\n\t\t\t$sim = $this->findSimilar($data); \n\t\t\t\n\t\t\t\n\t\t\tif(empty($sim) || ($mode == 'script' && count($sim) < 2))\n\t\t\t{\n\t\t\t\treturn; //  ADMIN_TRUE_ICON; \t\n\t\t\t}\n\t\t\t\n\t\t\t$text = \"<table class='table table-striped table-bordered'>\n\t\t\t\";\n\t\t\t\n\t\t\tforeach($sim as $k=>$val)\n\t\t\t{\n\t\t\t\t$text .= \"<tr>\n\t\t\t\t<td style='width:30%'>\".$this->shortPath($val['file']).\"</td>\n\t\t\t\t<td style='width:45%'>\".$val['lan'].\"<br /><small>\".$val['value'].\"</small></td>\n\t\t\t\t<td style='width:25%'>\".$this->renderStatus($val['status']).\"</td>\n\t\t\t\t</tr>\";\t\n\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\t$text .= \"</table>\";\n\t\t\treturn $text;\n\t\t\t\n\t\t}\n\t\t\n\t\tfunction renderFilesList($list)\n\t\t{\n\t\t\t$l= array(); \n\t\t\tforeach($list as $v)\n\t\t\t{\n\t\t\t\t$l[] = $this->shortPath($v,'script');\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t}\t\n\t\t\t\n\t\t\tif(!empty($l))\n\t\t\t{\n\t\t\t\treturn implode(\"<br />\",$l);\t\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t}\n\t\t\n\t\tfunction renderStatus($val,$mode='lan')\n\t\t{\n\t\t\t$diz = array(\n\t\t\t\t'lan'\t\t=> array(0 => 'Unused by '.$this->plugin, 1=>'Used by '.$this->plugin, 2=>'Unsure'),\n\t\t\t\t'script'\t=> array(0=> 'Missing from Language Files', 1=>'Found in Language Files', 3=>\"Generic\")\n\t\t\t);\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tif($val ==1)\n\t\t\t{\n\t\t\t\treturn \"<span class='label label-success'>\".$diz[$mode][$val].\"</span>\";\t\t\n\t\t\t}\n\t\t\t\n\t\t\tif($val == 2)\n\t\t\t{\n\t\t\t\treturn \"<span class='label label-warning'>\".$diz[$mode][$val].\"</span>\";\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\treturn \"<span class='label label-important label-danger'>\".$diz[$mode][$val].\"</span>\";\n\t\t}\n\t\t\n\t\tfunction shortPath($path,$mode='lan')\n\t\t{\n\t\t\t\n\t\t\tif($path == e_LANGUAGEDIR.'English/English.php')\n\t\t\t{\n\t\t\t\treturn \"<i>Core Frontend Language File</i>\";\t\n\t\t\t}\n\t\t\t\n\t\t\tif($path == e_LANGUAGEDIR.'English/admin/lan_admin.php')\n\t\t\t{\n\t\t\t\treturn \"<i>Core Admin-area Language File</i>\";\t\n\t\t\t}\n\t\t\t\n\t\t\tif($mode == 'script')\n\t\t\t{\n\t\t\t\treturn str_replace(e_PLUGIN.$this->plugin.'/','',$path); \t\t\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\n\t\t\t\t$text = str_replace(e_PLUGIN.$this->plugin.'/languages/','',$path); \n\t\t\t\t\n\t\t\t\tif(strpos($path,'_front.php')===false && strpos($path,'_admin.php')===false && strpos($path,'_global.php')===false && strpos($path,'_menu.php')===false && strpos($path,'_notify.php')===false && strpos($path,'_search.php')===false)\n\t\t\t\t{\n\t\t\t\t\treturn \"<span class='text-error e-tip' title='File name should be either English_front.php, English_admin.php or English_global.php'>\".$text.\"</span>\";\t\n\t\t\t\t} \n\t\t\t\t\n\t\t\t\treturn $text;\n\t\t\t\t\n\t\t\t}\n\t\t\t\t\n\t\t}\n\t\t\n\n\t\tfunction renderTable($array,$mode)\n\t\t{\n\t\t\tif(empty($array))\n\t\t\t{\n\t\t\t\treturn \"<div class='alert alert-info alert-block'>No Matches</div>\";\n\t\t\t}\n\t\t\t\n\t\t\t$text2 = '';\n\t\t\t\n\t\t\tif($mode == 'unsure')\n\t\t\t{\n\t\t\t\t$text2 .= \"<div class='alert alert-info alert-block'>LAN items in this list have been named incorrectly. They should include 'LAN' in their name. eg. LAN_\".strtoupper($this->plugin).\"_001</div>\";\t\n\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\t$text2 .= \"<table class='table table-striped  table-bordered'>\n\t\t\t<tr>\n\t\t\t<th>LAN</th>\n\t\t\t<th>File</th>\n\t\t\t<th>Value</th>\n\t\t\t<th>Duplicate or Similar Value</th>\n\t\t\t</tr>\n\t\t\t\";\n\t\t\t\n\t\t\tforeach($array as $k=>$v)\n\t\t\t{\n\t\t\t\t$text2 .= \"<tr>\n\t\t\t\t\t<td style='width:5%'>\".$v.\"</td>\n\t\t\t\t\t<td>\".$this->shortPath($this->lanDefsData[$k]['file']).\"</td>\n\t\t\t\t\t<td style='width:20%'>\".$this->lanDefsData[$k]['value'].\"</td>\n\t\t\t\t\t<td>\".$this->renderSimilar($this->lanDefsData[$k]).\"</td>\n\t\t\t\t\t</tr>\";\t\n\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t$text2 .= \"</table>\";\t\n\t\t\t\n\t\t\treturn $text2;\n\t\t}\n\n\t\tfunction renderScriptTable()\n\t\t{\n\t\t\t\n\t\t//\treturn print_a($this->scriptDefsData,true);\n\t\t\t\n\t\t\t$text2 = \"<table class='table table-striped table-bordered'>\n\t\t\t<tr>\n\t\t\t<th>id</th>\n\t\t\t<th>File</th>\n\t\t\t<th>Detected LAN</th>\n\t\t\t<th>LAN Value</th>\n\t\t\t<th class='right'>Found on Line</th>\n\t\t\t<th style='width:10%'>Status</th>\n\t\t\t<th>Duplicates / Possible Substitions</th>\n\t\t\t</tr>\n\t\t\t\";\n\t\t\t\n\t\t\tforeach($this->scriptDefsData as $k=>$v)\n\t\t\t{\n\t\t\t\t$status = in_array($v['lan'],$this->lanDefs) ? 1 : 0;\n\t\t\t//\t$lan = $v['lan'];\n\t\t\t//\t$v['value'] = $this->lanDefsRaw[$lan];\n\t\t\t//\t$sim = $this->findSimilar($v);\n\t\t\t\t\n\t\t\t\t$text2 .= \"<tr>\n\t\t\t\t\t<td style='width:5%'>\".$k.\"</td>\n\t\t\t\t\t<td>\".$this->shortPath($v['file'],'script').\"</td>\n\t\t\t\t\t<td >\".$v['lan'].\"</td>\n\t\t\t\t\t<td ><small>\".$this->lanDefsRaw[$v['lan']].\"</small></td>\n\t\t\t\t\t<td class='right'>\".$v['line'].\"</td>\n\t\t\t\t\t<td>\".$this->renderStatus($status,'script').\"</td>\n\t\t\t\t\t<td>\".$this->renderSimilar($v,'script').\"</td> \n\t\t\t\t\t</tr>\";\t\n\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t$text2 .= \"</table>\";\t\n\t\t\t\n\t\t\treturn $text2;\t\n\t\t\t\n\t\t}\n\n\t\t\n\t\tfunction renderResults()\n\t\t{\n\t\t\t$frm = e107::getForm();\n\t\t\t$ns = e107::getRender();\n\t\t\t\n\t\t\t$this->unused = array_diff($this->lanDefs,$this->scriptDefs); \n\t\t\t\t\n\t\t\t$this->used = array_intersect($this->lanDefs,$this->scriptDefs); \n\t\t\t\t\n\t\t\tforeach($this->unused as $k=>$v)\n\t\t\t{\n\t\t\t\tif(strpos($v,'LAN')===false)\n\t\t\t\t{\n\t\t\t\t\tunset($this->unused[$k]);\n\t\t\t\t\t$this->unsure[$k] = $v;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif(strpos($this->lanDefsData[$k]['file'],$this->plugin) === false || in_array($v,$this->excludeLans))\n\t\t\t\t{\n\t\t\t\t\tunset($this->unused[$k]);\n\t\t\t\t\tunset($this->unsure[$k]);\n\t\t\t\t}\n\t\t\t\t\t\n\t\t\n\t\t\t}\t\n\n//\t\t\tprint_a($this->scriptData); \n\t\t\t\n\t\t\t$used =  $this->renderTable($this->used, 'used'); \n\t\t\t$unused =  $this->renderTable($this->unused,'unused'); \n\t\t\t$unsure =  $this->renderTable($this->unsure,'unsure'); \n\t\t\t\n\t\t\t\n\t\t\t// echo $text2;\n\t\t\t$tabs = array (\n\t\t\t\t0\t=> array('caption'=>EPL_ADLAN_222, 'text'=> $this->renderScriptTable()),\n\t\t\t\t1 => array('caption'=>EPL_ADLAN_223, 'text'=>$used),\n\t\t\t\t2 => array('caption'=>EPL_ADLAN_224, 'text'=>$unused),\n\t\t\t\t3 => array('caption'=>EPL_ADLAN_225, 'text'=>$unsure),\n\t\t\t\t\n\n\t\t\t);\n\t\t\n\t\t\n\t\t\t\n\t\t\t$ns->tablerender(ADLAN_98.SEP.EPL_ADLAN_114.SEP.EPL_ADLAN_221.SEP.$this->plugin, $frm->tabs($tabs));\n\t\t\t\t\n\t\t}\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\n\t\t\n\t\t\n\t\t\n\t\tfunction scanScriptFile($path)\n\t\t{\n\t\t\t$lines = file($path, FILE_IGNORE_NEW_LINES);  \n\t\t\t\n\t\t\tforeach($lines as $ln=>$row)\n\t\t\t{\n\t\t\t\t$row = trim($row); \n\t\t\t\tif(substr($row,0,2) == '/*')\n\t\t\t\t{\n\t\t\t\t//\t$skip =true; ;\n\t\t\t\t\t\t\n\t\t\t\t}\t\n\t\t\t\tif(substr($row,0,2) == '*/')\n\t\t\t\t{\n\t\t\t\t//\t$skip =false;\n\t\t\t\t//\tcontinue; \t\n\t\t\t\t}\t\n\t\t\t\t\n\t\t\t\tif(empty($row) || $skip == true || substr($row,0,5) == '<?php' || substr($row,0,2) == '?>' || substr($row,0,2)=='//')\n\t\t\t\t{\n\t\t\t\t\tcontinue; \t\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif(preg_match_all(\"/([\\w_]*LAN[\\w_]*)/\", $row, $match))\n\t\t\t\t{\n\t\t\t\t\tforeach($match[1] as $lan)\n\t\t\t\t\t{\n\t\t\t\t\t\tif(!in_array($lan,$this->excludeLans))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$this->scriptDefs[] = $lan;\n\t\t\t\t\t\t\t$this->scriptDefsData[] = array('file'=>$path, 'line'=>$ln, 'lan'=>$lan, 'value'=>$this->lanDefsRaw[$lan]); \n\t\t\t\t\t\t//\t$this->scriptData[$path][$ln] = $row; \n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\t\n\t\t\t}\n\t\t\t\n\t\n\t\t}\t\n\t\t\t\t\t\n\t\t\t\n\t\tfunction scanLanFile($path)\n\t\t{\n\t\t\t\n\t\t\t\n\t\t\t$data = file_get_contents($path); \n\t\t\t\n\t\t\tif(preg_match_all('/(\\/\\*[\\s\\S]*?\\*\\/)/i',$data, $multiComment))\n\t\t\t{\n\t\t\t\t$data = str_replace($multiComment[1],'',$data);\t// strip multi-line comments. \t\n\t\t\t}\n\t\t\t\t\n\t\t\t\n\t\t\t$type = basename($path); \n\t\t\t\n\t\t\tif(preg_match_all('/^\\s*?define\\s*?\\(\\s*?(\\'|\\\")([\\w]+)(\\'|\\\")\\s*?,\\s*?(\\'|\\\")([\\s\\S]*?)\\s*?(\\'|\\\")\\s*?\\)\\s*?;/im',$data,$matches))\n\t\t\t{\n\t\t\t\t$def = $matches[2];\n\t\t\t\t$values = $matches[5];\t\n\t\t\n\t\t\t\tforeach($def as $k=>$d)\n\t\t\t\t{\n\t\t\t\t\tif($d == 'e_PAGETITLE' || $d == 'PAGE_NAME' || $d =='CORE_LC' && $d =='CORE_LC2')\n\t\t\t\t\t{\n\t\t\t\t\t\t\tcontinue; \n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t$retloc[$type][$d]= $values[$k];\n\t\t\t\t\t$this->lanDefs[] = $d;\n\t\t\t\t\t$this->lanDefsData[] = array('file'=>$path, 'lan'=>$d, 'value'=>$values[$k]); \n\t\t\t\t\t$this->lanDefsRaw[$d] = $values[$k];\n\t\t\t\t}\t\n\t\t\t}\n\t\t\t\n\t\t//print_a($this->lanDefsData); \n\t\t\treturn; \n\t\t}\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\n\t\n\t\n}\n\n\n\n\n\n\n\n/**\n * Plugin Admin Generator by CaMer0n. //TODO - Added dummy template and shortcode creation, plus e_search, e_cron, e_xxxxx etc. \n */\nclass pluginBuilder\n{\n\t\n\t\tvar $fields = array();\n\t\tvar $table = '';\n\t\tvar $pluginName = '';\n\t\tvar $special = array();\n\t\tvar $tableCount = 0;\n\t\tvar $tableList = array();\n\t\tvar $createFiles = false;\n\t\tprivate $buildTable = false;\n\t\tprivate $debug = false;\n\t\n\t\tfunction __construct()\n\t\t{\n\n\t\t\tif(e_DEBUG == true)\n\t\t\t{\n\t\t\t\t$this->debug = true;\n\t\t\t}\n\n\t\t\t$this->special['checkboxes'] =  array('title'=> '','type' => null, 'data' => null,\t 'width'=>'5%', 'thclass' =>'center', 'forced'=> TRUE,  'class'=>'center', 'toggle' => 'e-multiselect', 'fieldpref'=>true);\n\t\t\t$this->special['options'] = array( 'title'=> 'LAN_OPTIONS', 'type' => null, 'data' => null, 'width' => '10%',\t'thclass' => 'center last', 'class' => 'center last', 'forced'=>TRUE, 'fieldpref'=>true);\t\t\n\t\t\t\n\n\t\t}\n\n\n\t\tfunction run()\n\t\t{\n\n\t\t\tif(!empty($_GET['newplugin']))\n\t\t\t{\n\t\t\t\t$this->pluginName = e107::getParser()->filter($_GET['newplugin'],'file');\n\t\t\t}\n\n\t\t\tif(!empty($_GET['createFiles']))\n\t\t\t{\n\t\t\t\t$this->createFiles\t= true;\n\t\t\t}\n\n\t\t\tif(vartrue($_POST['step']) == 4)\n\t\t\t{\n\t\t\t\treturn $this->step4();\n\t\t\t}\n\n\t\t\tif(vartrue($_GET['step']) == 3)\n\t\t\t{\n\t\t\t\treturn $this->step3();\n\t\t\t}\n\n\n\n\n\t\t\tif(!empty($_GET['newplugin']) && $_GET['step']==2)\n\t\t\t{\n\t\t\t\treturn $this->step2();\n\t\t\t}\n\n\n\n\t\t\treturn $this->step1();\n\n\n\t\t}\n\n\n\n\t\tfunction step1()\n\t\t{\n\n\t\t\t$fl = e107::getFile();\n\t\t\t$frm = e107::getForm();\n\t\t\t$ns = e107::getRender();\n\t\t\t$mes = e107::getMessage();\n\t\t\t$tp = e107::getParser();\n\t\t\t\n\t\t\t$plugFolders = $fl->get_dirs(e_PLUGIN);\t\n\t\t\tforeach($plugFolders as $dir)\n\t\t\t{\n\t\t\t\t$lanDir[$dir] = $dir;\n\t\t\t\tif(E107_DEBUG_LEVEL == 0 && file_exists(e_PLUGIN.$dir.\"/admin_config.php\"))\n\t\t\t\t{\n\t\t\t\t\tcontinue;\t\n\t\t\t\t}\t\n\t\t\t\t$newDir[$dir] = $dir;\n\t\t\t}\n\n\t\t\t$info = EPL_ADLAN_102;\n\t\t\t$info .= \"<ul>\";\n\t\t\t$info .= \"<li>\".str_replace('[x]', e_PLUGIN, EPL_ADLAN_103).\"</li>\";\n\t\t//\t$info .= \"<li>\".EPL_ADLAN_104.\"</li>\";\n\t\t\t$info .= \"<li>\".EPL_ADLAN_105.\"</li>\";\n\t\t\t$info .= \"<li>\".EPL_ADLAN_106.\"</li>\";\n\t\t\t$info .= \"</ul>\";\n\n\t\t\t$mes->addInfo($tp->toHtml($info,true));\n\t\t\t\n\t\t\t$text = $frm->open('createPlugin','get', e_SELF);\n\t\t\t$text .= $frm->hidden('action', 'build');\n\t\t\t$text .= \"<table class='table adminform'>\n\t\t\t\t\t\t<colgroup>\n\t\t\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t\t\t<col class='col-control' />\n\t\t\t\t\t\t</colgroup>\n\t\t\t\t<tr>\n\t\t\t\t\t<td>\".EPL_ADLAN_107.\"</td>\n\t\t\t\t\t<td><div class='input-append form-inline'>\".$frm->open('createPlugin','get',e_SELF.\"?mode=create\").$frm->select(\"newplugin\",$newDir).$frm->admin_button('step', 2,'other',LAN_GO).\"</div> \".$frm->checkbox('createFiles',1,1,EPL_ADLAN_232).$frm->close().\"</td>\n\t\t\t\t</tr>\n\t\t\t\t\n\t\t\t\t<tr>\n\t\t\t\t\t<td>\".EPL_ADLAN_108.\"</td>\n\t\t\t\t\t<td><div class='input-append form-inline'>\".$frm->open('checkPluginLangs','get',e_SELF.\"?mode=lans\").$frm->select(\"newplugin\",$lanDir).$frm->admin_button('step', 2,'other',LAN_GO).\"</div> \".$frm->close().\"</td>\n\t\t\t\t</tr>\";\n\t\t\t\t\n\t\t\t\t\t\n\t\t\t/* NOT a good idea - requires the use of $_POST which would prevent browser 'go Back' navigation. \n\t\t\tif(e_DOMAIN == FALSE) // localhost. \n\t\t\t{\n\t\t\t\t$text .= \"<tr>\n\t\t\t\t\t<td>Pasted MySql Dump Here</td>\n\t\t\t\t\t<td>\".$frm->textarea('mysql','', 10,80).\"\n\t\t\t\t\t<span class='field-help'>eg. </span></td>\n\t\t\t\t\t</tr>\";\t\t\t\n\t\t\t}\n\t\t\t*/\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t$text .= \"\t\t\t\t\n\t\t\t\t</table>\n\t\t\t\t<div class='buttons-bar center'>\n\t\t\t\t\n\t\t\t\t</div>\";\n\n\t\t\t$text .= $frm->close();\n\n\t\t\treturn $text;\n\n\t\t//\t$ns->tablerender(ADLAN_98.SEP.EPL_ADLAN_114, $mes->render() . $text);\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t//\t$var['lans']['text'] = EPL_ADLAN_226;\n\t\t//\t\t$var['lans']['link'] = e_SELF.\"?mode=lans\";\n\t\t\t\n\t\t\t\n\t\t}\n\n\n\t\tfunction enterMysql()\n\t\t{\n\t\t\t\n\t\t\t$frm = e107::getForm();\n\t\t\treturn \"<div>\".$frm->textarea('mysql','', 10,80).\"</div>\";\t\n\t\t\t\n\t\t}\n\n\n\t\t/**\n\t\t * @param string $table\n\t\t * @param string $file\n\t\t */\n\t\tprivate function buildSQLFile($table, $file)\n\t\t{\n\n\t\t\t$table = e107::getParser()->filter($table);\n\n\t\t\te107::getDb()->gen(\"SHOW CREATE TABLE `#\".$table.\"`\");\n\t\t\t$data = e107::getDb()->fetch('num');\n\n\t\t\tif(!empty($data[1]))\n\t\t\t{\n\t\t\t\t$createData = str_replace(\"`\".MPREFIX, '`', $data[1]);\n\t\t\t\t$createData .= \";\";\n\t\t\t\tif(!file_exists($file))\n\t\t\t\t{\n\t\t\t\t\tfile_put_contents($file,$createData);\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\n\n\n\n\t\tfunction step3()\n\t\t{\n\t\t\t\n\t\t//\trequire_once(e_HANDLER.\"db_verify_class.php\");\n\t\t//\t$dv = new db_verify;\n\t\t\t$dv = e107::getSingleton('db_verify', e_HANDLER.\"db_verify_class.php\");\n\t\t\t\n\t\t\t$frm = e107::getForm();\n\t\t\t$ns = e107::getRender();\n\t\t\t$mes = e107::getMessage();\n\t\t\t$tp = e107::getParser();\n\n\t\t\t\n\t\t\t$newplug = $tp->filter($_GET['newplugin'],'file');\n\t\t\t$this->pluginName = $newplug;\n\n\t\t\t$sqlFile = e_PLUGIN.$newplug.\"/\".$newplug.\"_sql.php\";\n\n\t\t\tif(!empty($_GET['build']) && !file_exists($sqlFile))\n\t\t\t{\n\t\t\t\t$this->buildSQLFile($_GET['build'], $sqlFile);\n\t\t\t}\n\n\t\t\t$ret = array();\n\t\t\t\n\t\t\tif(file_exists($sqlFile))\n\t\t\t{\t\t\n\t\t\t\t$data = file_get_contents($sqlFile);\n\t\t\t\t$ret =  $dv->getSqlFileTables($data);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\te107::getDebug()->log(\"SQL File Not Found\");\n\t\t//\t\t$this->buildTable = true;\n\t\t\t}\n\t\t\n\t\t\t$text = $frm->open('newplugin-step3','post', e_SELF.'?mode=create&action=build&newplugin='.$newplug.'&createFiles='.$this->createFiles.'&step=3');\n\t\t\t\n\t\t\t$text .= \"<ul class='nav nav-tabs'>\\n\";\n\t\t\t$text .= \"<li class='active'><a data-toggle='tab' href='#xml'>\".EPL_ADLAN_109.\"</a></li>\";\n\t\t\t\n\t\t\t$this->tableCount = count($ret['tables']);\n\n\t\t\tif(!empty($ret['tables']))\n\t\t\t{\n\t\t\t\tforeach($ret['tables'] as $key=>$table)\n\t\t\t\t{\n\t\t\t\t\t$label = \"Table: \".$table;\n\t\t\t\t\t$text .= \"<li><a data-toggle='tab'  href='#\".$table.\"'>\".$label.\"</a></li>\";\n\t\t\t\t\t$this->tableList[] = $table;\n\t\t\t\t}\n\t\t\t}\n\n\n\t\t\t$text .= \"<li><a data-toggle='tab'  href='#preferences'>\".LAN_PREFS.\"</a></li>\";\n\t\t\t$text .= \"<li><a data-toggle='tab'  href='#addons'>\".LAN_ADDONS.\"</a></li>\"; //TODO LAN\n\n\t\t\t\n\t\t\t$text .= \"</ul>\";\n\t\t\t\n\t\t\t$text .= \"<div class='tab-content'>\\n\";\n\t\t\t\n\t\t\t$text .= \"<div class='tab-pane active' id='xml'>\\n\";\n\t\t\t$text .= $this->pluginXml(); \n\t\t\t$text .= \"</div>\";\n\n\t\t\tif(!empty($ret['tables']))\n\t\t\t{\n\t\t\t\tforeach($ret['tables'] as $key=>$table)\n\t\t\t\t{\n\t\t\t\t\t$text .= \"<div class='tab-pane' id='\".$table.\"'>\\n\";\n\t\t\t\t\t$fields = $dv->getFields($ret['data'][$key]);\n\t\t\t\t\t$text .= $this->form($table,$fields);\n\t\t\t\t\t$text .= \"</div>\";\n\t\t\t\t}\n\t\t\t}\n\n\n\n\n\t\t\t$text .= \"<div class='tab-pane' id='preferences'>\\n\";\n\t\t\t$text .= $this->prefs(); \n\t\t\t$text .= \"</div>\";\n\n\n\t\t\t$text .= \"<div class='tab-pane' id='addons'>\\n\";\n\t\t\t$text .= $this->addons();\n\t\t\t$text .= \"</div>\";\n\n\n\t\t\tif(empty($ret['tables']))\n\t\t\t{\n\t\t\t\t$text .= $frm->hidden($this->pluginName.'_ui[mode]','main');\n\t\t\t\t$text .= $frm->hidden($this->pluginName.'_ui[pluginName]', $this->pluginName);\n\t\t\t}\n\n\t\t\t$text .= \"</div>\";\n\t\t\t\n\t\t\t$text .= \"\n\t\t\t<div class='buttons-bar center'>\n\t\t\t\".$frm->hidden('newplugin', $this->pluginName).\"\n\t\t\t\".$frm->admin_button('step', 4,'other', LAN_GENERATE).\"\n\t\t\t</div>\";\n\t\t\t\n\t\t\t$text .= $frm->close();\n\t\t\t\n\t\t\t$mes->addInfo(EPL_ADLAN_112);\n\n\t\t\t$mes->addInfo(EPL_ADLAN_113);\n\t\t\n\t\t\treturn array('caption'=>EPL_ADLAN_115, 'text'=> $text);\n\t\t//\t$ns->tablerender(ADLAN_98.SEP.EPL_ADLAN_114.SEP., $mes->render() . $text);\n\t\t}\n\n\n\n\t\tprivate function step2()\n\t\t{\n\n\n\t\t\t$frm = e107::getForm();\n\n\t\t\t$tables = e107::getDb()->tables();\n\n\n\t\t\t$text = $frm->open('buildTab', 'get', e_REQUEST_SELF);\n\n\t\t\t$text .= \"<table class='table adminform'>\n\t\t\t\t<tr><td colspan='2'><h4>\".ucfirst(LAN_OPTIONAL).\"</h4></td></tr>\n\n\t\t\t\t<tr>\n\t\t\t\t<td class='col-label'>To generate your <em>\".$this->pluginName.\"_sql.php</em> table creation file, please select your sql table then click 'Refresh'</td>\n\t\t\t\t<td class='form-inline'>\";\n\n\t\t\t$text .= $frm->select('build', $tables, null, array('useValues'=>1), \"(\".LAN_OPTIONAL.\")\");\n\n\n\t\t//\t$text .= \"<a href='#' id='build-table-submit' class='btn btn-success'>Refresh</a>\";\n\t\t//\t$text .= $frm->button('step', 3, 'submit', \"Continue\");\n\t\t\t\tunset($_GET['step']);\n\t\t\tforeach($_GET as $k=>$v)\n\t\t\t{\n\t\t\t\t$text .= $frm->hidden($k,$v);\n\n\t\t\t}\n\t\t//\t$text .= $frm->hidden(\"build_table_url\", e_REQUEST_SELF.'?'.$qry, array('id'=>'build-table-url'));\n\n\n\t\t\t$text .= \"</td></tr>\n\t\t\t<tr><td>&nbsp;</td><td>\n\t\t\t\".$frm->button('step', 3, 'submit', LAN_CONTINUE).\"\n\t\t\t</td></tr></table>\";\n\n\t\t\t$text .=  $frm->close();\n\n/*\n\t\t\te107::js('footer-inline','\n\n\t\t\t\t  $(document).on(\"click\", \"#build-table-submit\", function(e){\n\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t$(this).addClass(\"disabled\");\n\n                    var url = $(\"#build-table-url\").val();\n                    var sel = $(\"#build-table-tbl\").val();\n\n                    url = url + \"&build=\" + sel;\n\n\t\t\t\t\twindow.location.href = url;\n\n\t\t\t\t\treturn false;\n\t\t\t\t});\n\n\n\n\n\n\t\t\t');*/\n\t\t\t$ns = e107::getRender();\n\t\t\treturn array('caption'=>EPL_ADLAN_115, 'text'=>$text);\n\t\t//\t$ns->tablerender(ADLAN_98.SEP.EPL_ADLAN_114.SEP.EPL_ADLAN_115,  $text);\n\n\n\t\t\treturn $text;\n\n\t\t}\n\n\n\n\n\n\n\n\n\t\tprivate function createAddons($list)\n\t\t{\n\n\t\t\t$srch = array('_blank','blank');\n\t\t\t$result = array();\n\n\t\t\tforeach($list as $addon)\n\t\t\t{\n\t\t\t\t$addonDest = str_replace(\"_blank\",$this->pluginName,$addon);\n\t\t\t\t$source         = e_PLUGIN.\"_blank/\".$addon.\".php\";\n\t\t\t\t$destination    = e_PLUGIN.$this->pluginName. \"/\".$addonDest.\".php\";\n\n\t\t\t\tif(file_exists($destination))\n\t\t\t\t{\n\t\t\t\t\t$result[] = \"Skipped (already exists) : \".$addonDest;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tif($content = file_get_contents($source))\n\t\t\t\t{\n\t\t\t\t\t$content = str_replace($srch, $this->pluginName, $content);\n\n\t\t\t\t\tif(!file_exists($destination))\n\t\t\t\t\t{\n\t\t\t\t\t\tif(file_put_contents($destination,$content))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$result[] = LAN_CREATED.\" : \".$addonDest;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$result[] = \"Skipped (already exists) : \".$addonDest;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t//$mes->addError(\"Addon source-file was empty: \".$addon);\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn $result;\n\t\t}\n\n\n\n\n\t\tprivate function addons()\n\t\t{\n\t\t\t$plg = e107::getPlugin();\n\n\t\t\t$list = $plg->getAddonsList();\n\t\t\t$frm = e107::getForm();\n\t\t\t$text = \"<table class='table table-striped adminlist' >\";\n\n\n\t\t//Todo LANS\n\t\t\t$dizOther = array(\n\t\t\t\t'_blank' => \"Simple frontend script\",\n\t\t\t\t'_blank_setup' => \"Create default table data during install, upgrade, uninstall etc\",\n\t\t\t\t'_blank_menu' => \"Menu item for use in the menu manager.\"\n\t\t\t);\n\n\t\t\tarray_unshift($list,'_blank', '_blank_setup', '_blank_menu');\n\n\t\t\t$templateFiles = scandir(e_PLUGIN.\"_blank\");\n\n\n\n\t//print_a($list);\n\t\t//\t$list[] = \"_blank\";\n\t\t//\t$list[] = \"_blank_setup\";\n\n\t\t\tforeach($list as $v)\n\t\t\t{\n\n\t\t\t\tif(!in_array($v.\".php\", $templateFiles))\n\t\t\t\t{\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t$diz = !empty($dizOther[$v]) ? $dizOther[$v] : $plg->getAddonsDiz($v);\n\t\t\t\t$label = str_replace(\"_blank\", $this->pluginName, $v);\n\t\t\t\t$id = str_replace('_blank', 'blank', $v);\n\n\t\t\t\t$text .= \"<tr>\";\n\t\t\t\t$text .= \"<td>\".$frm->checkbox('addons[]',$v,false,$label).\"</td>\";\n\t\t\t\t$text .= \"<td><label for='\".$frm->name2id('addons-'.$id).\"'>\".$diz.\"</label></td>\";\n\t\t\t\t$text .= \"</tr>\";\n\t\t\t}\n\n\t\t\t$text .= \"</table>\";\n\n\t\t\treturn $text;\n\n\t\t}\n\n\n\n\t\tfunction prefs()\n\t\t{\n\t\t\t$frm = e107::getForm();\n\n\t\t\t$text = '';\n\t\t\t\n\t\t\t\t$options = array(\n\t\t\t\t\t'text'\t\t=> EPL_ADLAN_116,\n\t\t\t\t\t'number'\t=> EPL_ADLAN_117,\n\t\t\t\t\t'url'\t\t=> EPL_ADLAN_118,\n\t\t\t\t\t'textarea'\t=> EPL_ADLAN_119,\n\t\t\t\t\t'bbarea'\t=> EPL_ADLAN_120,\n\t\t\t\t\t'boolean'\t=> EPL_ADLAN_121,\n\t\t\t\t\t\"method\"\t=> EPL_ADLAN_122,\n\t\t\t\t\t\"image\"\t\t=> EPL_ADLAN_123,\n\t\t\t\t\t\n\t\t\t\t\t\"dropdown\"\t=> EPL_ADLAN_124,\n\t\t\t\t\t\"userclass\"\t=> EPL_ADLAN_125,\n\t\t\t\t\t\"language\"\t=> EPL_ADLAN_126,\n\n\t\t\t\t\t\"icon\"\t\t=> EPL_ADLAN_127,\n\t\t\n\t\t\t\t\t\"file\"\t\t=> EPL_ADLAN_128,\n\t\n\t\t\t\t);\n\t\t\t\t\t\t\n\n\t\t\t$text = \"<table class='table table-striped'>\";\n\n\t\t\tfor ($i=0; $i < 10; $i++) \n\t\t\t{ \t\t\n\t\t\t\t$text .= \"<tr><td>\".\n\t\t\t\t$frm->text(\"pluginPrefs[\".$i.\"][index]\", '',40,'placeholder='.EPL_ADLAN_129).\"</td><td>\".\n\t\t\t\t$frm->text(\"pluginPrefs[\".$i.\"][value]\", '',50,'placeholder='.EPL_ADLAN_130).\"</td><td>\".\n\t\t\t\t$frm->select(\"pluginPrefs[\".$i.\"][type]\", $options, '', 'class=null', EPL_ADLAN_131).\"</td><td>\".\n\t\t\t\t$frm->text(\"pluginPrefs[\".$i.\"][help]\", '',80,'size=xxlarge&placeholder='.EPL_ADLAN_174).\"</td>\".\n\t\t\t\t\"</td></tr>\";\n\t\t\t}\n\n\t\t\t$text .= \"</table>\";\n\t\t\treturn $text;\n\t\t}\n\n\n\t\tfunction pluginXml()\n\t\t{\n\t\t\t\n\t\t\t\n\t\t\t//TODO Plugin.xml Form Fields. . \n\t\t\t\n\t\t\t$data = array(\n\t\t\t\t'main' \t\t\t=> array('name','lang','version','date', 'compatibility'),\n\t\t\t\t'author' \t\t=> array('name','url'),\n\t\t\t\t'summary' \t\t=> array('summary'),\n\t\t\t\t'description' \t=> array('description'),\n\t\t\t\t'keywords' \t\t=> array('one','two','three'),\n\t\t\t\t'category'\t\t=> array('category'),\n\t\t\t\t'copyright'\t\t=> array('copyright'),\n\t\t//\t\t'adminLinks'\t=> array('url','description','icon','iconSmall','primary'),\n\t\t//\t\t'sitelinks'\t\t=> array('url','description','icon','iconSmall')\n\t\t\t);\n\t\t\t\n\t\t\t// Load old plugin.php file if it exists; \n\t\t\t$legacyFile = e_PLUGIN.$this->pluginName.\"/plugin.php\";\t\t\n\t\t\tif(file_exists($legacyFile))\n\t\t\t{\n\t\t\t\t$eplug_name = $eplug_author = $eplug_url = $eplug_description = \"\";\n\t\t\t\t$eplug_tables = array();\n\n\t\t\t\trequire_once($legacyFile);\t\n\t\t\t\t$mes = e107::getMessage();\n\t\t\t\t$mes->addInfo(\"Loading plugin.php file\");\n\t\t\t\t\n\t\t\t\t$defaults = array(\n\t\t\t\t\t\"main-name\"\t\t\t\t\t=> $eplug_name,\n\t\t\t\t\t\"author-name\"\t\t\t\t=> $eplug_author,\n\t\t\t\t\t\"author-url\"\t\t\t\t=> $eplug_url,\n\t\t\t\t\t\"description-description\"\t=> $eplug_description,\n\t\t\t\t\t\"summary-summary\"\t\t\t=> $eplug_description\n\t\t\t\t);\n\t\t\t\t\n\t\t\t\tif(count($eplug_tables) && !file_exists(e_PLUGIN.$this->pluginName.\"/\".$this->pluginName.\"_sql.php\"))\n\t\t\t\t{\n\t\t\t\t\t\n\t\t\t\t\t$cont = '';\n\t\t\t\t\tforeach($eplug_tables as $tab)\n\t\t\t\t\t{\n\t\t\t\t\t\tif(strpos($tab,\"INSERT INTO\")!==FALSE)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcontinue;\t\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\t$cont .= \"\\n\".str_replace(\"\\t\",\" \",$tab);\t\n\t\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tif(file_put_contents(e_PLUGIN.$this->pluginName.\"/\".$this->pluginName.\"_sql.php\",$cont))\n\t\t\t\t\t{\n\t\t\t\t\t\t$info = str_replace('[x]', $this->pluginName.\"_sql.php\", EPL_ADLAN_132);\n\t\t\t\t\t\t$mes->addInfo($info,'default',true);\n\t\t\t\t\t\t$red = e107::getRedirect();\n\t\t\t\t\t\t$red->redirect(e_REQUEST_URL,true);\n\t\t\t\t\t//\t$red->redirect(e_SELF.\"?mode=create&newplugin=\".$this->pluginName.\"&createFiles=1&step=2\",true);\n\t\t\t\t\t}\n\t\t\t\t\telse \n\t\t\t\t\t{\n\t\t\t\t\t\t$msg = str_replace('[x]', $this->pluginName.\"_sql.php\", EPL_ADLAN_133).\"<br />\";\n\t\t\t\t\t\t$msg .= str_replace(array('[x]','[y]'), array($this->pluginName.\"_sql.php\",$cont), EPL_ADLAN_134);\n\t\t\t\t\t\t$mes->addWarning($msg);\t\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t$existingXml = e_PLUGIN.$this->pluginName.\"/plugin.xml\";\t\t\n\t\t\tif(file_exists($existingXml))\n\t\t\t{\n\t\t\t\t$p = e107::getXml()->loadXMLfile($existingXml,true);\t\n\t\t\t\t\n\t\t//\t\tprint_a($p);\n\t\t\t\t$defaults = array(\n\t\t\t\t\t\"main-name\"\t\t\t\t\t=> varset($p['@attributes']['name']),\n\t\t\t\t\t\"author-name\"\t\t\t\t=> varset($p['author']['@attributes']['name']),\n\t\t\t\t\t\"author-url\"\t\t\t\t=> varset($p['author']['@attributes']['url']),\n\t\t\t\t\t\"description-description\"\t=> varset($p['description']),\n\t\t\t\t\t\"summary-summary\"\t\t\t=> varset($p['summary'], $p['description']),\n\t\t\t\t\t\"category-category\"\t\t\t=> varset($p['category']),\n\t\t\t\t\t\"keywords-one\"\t\t\t\t=> varset($p['keywords']['word'][0]),\n\t\t\t\t\t\"keywords-two\"\t\t\t\t=> varset($p['keywords']['word'][1]),\n\t\t\t\t\t\"keywords-three\"\t\t\t=> varset($p['keywords']['word'][2]),\n\t\t\t\t);\n\t\t\t\t\n\t\t\t\tunset($p);\n\t\t\n\t\t\t}\n\t\t\t\n\t\t\t$text = \"<table class='table adminform'>\";\n\t\t\t\t\t\n\t\t\tforeach($data as $key=>$val)\n\t\t\t{\n\t\t\t\t$text.= \"<tr><td>$key</td><td>\n\t\t\t\t<div class='controls'>\";\n\t\t\t\tforeach($val as $type)\n\t\t\t\t{\n\t\t\t\t\t$nm = $key.'-'.$type;\n\t\t\t\t\t$name = \"xml[$nm]\";\t\n\t\t\t\t\t$size = (count($val)==1) ? 'span7 col-md-7' : 'span2 col-md-2';\n\t\t\t\t\t$text .= \"<div class='{$size}'>\".$this->xmlInput($name, $key.\"-\". $type, vartrue($defaults[$nm])).\"</div>\";\t\n\t\t\t\t}\t\n\t\t\t\n\t\t\t\t$text .= \"</div></td></tr>\";\n\t\t\t\t\n\t\t\t\t\n\t\t\t}\n\t\t\t$text .= \"</table>\";\n\t\t\t\n\t\t\treturn $text;\t\t\t\t\n\t\t}\n\t\t\n\t\t\n\t\tfunction xmlInput($name, $info, $default='')\n\t\t{\n\t\t\t$frm = e107::getForm();\t\n\t\t\tlist($cat,$type) = explode(\"-\",$info);\n\t\t\t\n\t\t\t$size \t\t= 30;\n\t\t\t$help\t\t= '';\n\t\t\t$pattern\t= \"\";\n\t\t\t$required\t= false;\n\t\t\t\n\t\t\tswitch ($info)\n\t\t\t{\n\t\t\t\t\n\t\t\t\tcase 'main-name':\n\t\t\t\t\t$help \t\t= EPL_ADLAN_135;\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$pattern \t= \"[A-Za-z0-9 -]*\";\n\t\t\t\t\t$xsize\t\t= 'medium';\n\t\t\t\tbreak;\n\t\t\n\t\t\t\tcase 'main-lang':\n\t\t\t\t\t$help \t\t= EPL_ADLAN_136;\n\t\t\t\t\t$required \t= false;\n\t\t\t\t\t$placeholder= \" \";\n\t\t\t\t\t$pattern \t= \"[A-Z0-9_]*\";\n\t\t\t\t\t$xsize\t\t= 'medium';\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'main-date':\n\t\t\t\t\t$help \t\t= EPL_ADLAN_137;\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$xsize\t\t= 'medium';\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'main-version':\n\t\t\t\t\t$default \t= '1.0';\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$help \t\t= EPL_ADLAN_138;\n\t\t\t\t\t$pattern\t= \"^[\\d]{1,2}\\.[\\d]{1,2}(\\.[\\d]{1,2})?$\";\n\t\t\t\t\t$xsize\t\t= 'small';\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'main-compatibility':\n\t\t\t\t\t$default \t= '2.0';\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$help \t\t= EPL_ADLAN_139;\n\t\t\t\t\t$pattern\t= \"^[\\d]{1,2}\\.[\\d]{1,2}$\";\n\t\t\t\t\t$xsize\t\t= 'small';\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'author-name':\n\t\t\t\t\t$default \t= (vartrue($default)) ? $default : USERNAME;\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$help \t\t= EPL_ADLAN_140;\n\t\t\t\t\t$pattern\t= \"[A-Za-z \\.0-9]*\";\n\t\t\t\t\t$xsize\t\t= 'medium';\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'author-url':\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$help \t\t= EPL_ADLAN_141;\n\t\t\t\t//\t$pattern\t= \"https?://.+\";\n\t\t\t\t\t$xsize\t\t= 'medium';\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\t//case 'main-installRequired':\n\t\t\t\t//\treturn \"Installation required: \".$frm->radio_switch($name,'',LAN_YES, LAN_NO);\n\t\t\t\t//break;\t\n\t\t\t\t\n\t\t\t\tcase 'summary-summary':\n\t\t\t\t\t$help \t\t= EPL_ADLAN_142.\"<br />\".EPL_ADLAN_143;\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$size \t\t= 130;\n\t\t\t\t\t$placeholder= \" \";\n\t\t\t\t\t$pattern\t= \"[A-Za-z -\\.0-9]*\";\n\t\t\t\t\t$xsize\t\t= 'block-level';\n\t\t\t\tbreak;\t\n\n\t\t\t\tcase 'keywords-one':\n\t\t\t\t\t$type = 'keywordDropDown';\n\t\t\t\t\t$required = true;\n\t\t\t\t\t$help \t\t= EPL_ADLAN_144;\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'keywords-three':\n\t\t\t\tcase 'keywords-two':\n\t\t\t\t\t$help \t\t= EPL_ADLAN_144.\"<br />\".EPL_ADLAN_143;\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$size \t\t= 20;\n\t\t\t\t\t$placeholder= \" \";\n\t\t\t\t\t$pattern \t= '^[a-z]*$';\n\t\t\t\t\t$xsize\t\t= 'medium';\n\t\t\t\tbreak;\t\n\t\t\t\t\n\t\t\t\tcase 'description-description':\n\t\t\t\t\t$help \t\t= EPL_ADLAN_145.\"<br />\".EPL_ADLAN_143;\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$size \t\t= 100;\n\t\t\t\t\t$placeholder = \" \";\n\t\t\t\t\t$pattern\t= \"[A-Za-z -\\.0-9]*\";\n\t\t\t\t\t$xsize\t\t= 'block-level';\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\t\t\n\t\t\t\tcase 'category-category':\n\t\t\t\t\t$help \t\t= EPL_ADLAN_146;\n\t\t\t\t\t$required \t= true;\n\t\t\t\t\t$size \t\t= 20;\n\t\t\t\tbreak;\n\t\t\t\t\t\t\n\t\t\t\tdefault:\n\t\t\t\t\t\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t$req = ($required == true) ? \"&required=1\" : \"\";\t\n\t\t\t$placeholder = (varset($placeholder)) ? $placeholder : $type;\n\t\t\t$pat = ($pattern) ? \"&pattern=\".$pattern : \"\";\n\t\t\t$sz = ($xsize) ? \"&size=\".$xsize : \"\";\n\t\t\t\n\t\t\tswitch ($type) \n\t\t\t{\n\t\t\t\tcase 'date':\n\t\t\t\t\t$text = $frm->datepicker($name, time(), 'format=yyyy-mm-dd&return=string'.$req . $sz);\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'description':\n\t\t\t\t\t$text = $frm->textarea($name,$default, 3, 100, $req.$sz);\t// pattern not supported. \t\n\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\tcase 'category':\n\t\t\t\t\t$options = array(\n\t\t\t\t\t'settings'\t=> EPL_ADLAN_147,\n\t\t\t\t\t'users'\t\t=> EPL_ADLAN_148,\n\t\t\t\t\t'content'\t=> EPL_ADLAN_149,\n\t\t\t\t\t'tools'\t\t=> EPL_ADLAN_150,\n\t\t\t\t\t'manage'\t=> EPL_ADLAN_151,\n\t\t\t\t\t'misc'\t\t=> EPL_ADLAN_152,\n\t\t\t\t\t'menu'\t\t=> EPL_ADLAN_153,\n\t\t\t\t\t'about'\t\t=> EPL_ADLAN_154\n\t\t\t\t\t);\n\t\t\t\t\n\t\t\t\t\t$text = $frm->select($name, $options, $default,'required=1&class=form-control', true);\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'keywordDropDown':\n\n\t\t\t\t\t$options = array(\n\n\t\t\t\t\t\t'generic',\n\t\t\t\t\t\t'admin',\n\t\t\t\t\t    'messaging',\n\t\t\t\t\t    'enhancement',\n\t\t\t\t\t    'date',\n\t\t\t\t\t    'commerce',\n\t\t\t\t\t    'form',\n\t\t\t\t\t    'gaming',\n\t\t\t\t\t    'intranet',\n\t\t\t\t\t    'multimedia',\n\t\t\t\t\t    'information',\n\t\t\t\t\t    'mail',\n\t\t\t\t\t    'search',\n\t\t\t\t\t\t'stats',\n\t\t\t\t\t\t'files',\n\t\t\t\t\t\t'security',\n\t\t\t\t\t\t'generic',\n\t\t\t\t\t\t'language'\n\t\t\t\t\t);\n\n\t\t\t\t\tsort($options);\n\n\t\t\t\t\t$text = $frm->select($name, $options, $default,'required=1&class=form-control&useValues=1', true);\n\n\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tdefault:\n\t\t\t\t\t$text = $frm->text($name, $default, $size, 'placeholder='.$placeholder . $sz. $req. $pat);\t\n\t\t\t\tbreak;\n\t\t\t}\n\t\n\t\t\t\n\t\t\t$text .= ($help) ? \"<span class='field-help'>\".$help.\"</span>\" : \"\";\n\t\t\treturn $text;\n\t\t\t\n\t\t}\n\n\t\tfunction createXml($data)\n\t\t{\n\t\t//\tprint_a($_POST);\n\t\t\t$ns = e107::getRender();\n\t\t\t$mes = e107::getMessage();\n\t\t\t$tp = e107::getParser();\n\t\t\t\n\t\t\tforeach($data as $key=>$val)\n\t\t\t{\n\t\t\t\t$key = strtoupper(str_replace(\"-\",\"_\",$key));\n\t\t\t\t$newArray[$key] = $val;\t\n\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\t$newArray['DESCRIPTION_DESCRIPTION'] = strip_tags($tp->toHTML($newArray['DESCRIPTION_DESCRIPTION'],true));\n\n\t\t\t$_POST['pluginPrefs'] = $tp->filter($_POST['pluginPrefs']);\n\n\t\t\tforeach($_POST['pluginPrefs'] as $val)\n\t\t\t{\n\t\t\t\tif(vartrue($val['index']))\n\t\t\t\t{\n\t\t\t\t\t$id = $val['index'];\n\t\t\t\t\t$plugPref[$id] = $val['value'];\t\t\n\t\t\t\t}\t\n\t\t\t}\n\t\t\t\n\t\t//\tprint_a($_POST['pluginPrefs']);\n\t\t\t\n\t\t\tif(count($plugPref))\n\t\t\t{\n\t\t\t\t$xmlPref = \"<pluginPrefs>\\n\";\n\t\t\t\tforeach($plugPref as $k=>$v)\n\t\t\t\t{\n\t\t\t\t\t$xmlPref .= \"\t\t<pref name='\".$k.\"'>\".$v.\"</pref>\\n\";\t\n\t\t\t\t}\t\n\t\t\t\t\n\t\t\t\t$xmlPref .= \"\t</pluginPrefs>\";\n\t\t\t\t$newArray['PLUGINPREFS'] = $xmlPref;\n\t\t\t}\n\t\t\t\n\t\t\t//\tprint_a($newArray);\n\t\t\t// print_a($this);\n\t\t\t\n$template = <<<TEMPLATE\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<e107Plugin name=\"{MAIN_NAME}\" lan=\"{MAIN_LANG}\" version=\"{MAIN_VERSION}\" date=\"{MAIN_DATE}\" compatibility=\"{MAIN_COMPATIBILITY}\" installRequired=\"true\" >\n\t<author name=\"{AUTHOR_NAME}\" url=\"{AUTHOR_URL}\" />\n\t<summary lan=\"\">{SUMMARY_SUMMARY}</summary>\n\t<description lan=\"\">{DESCRIPTION_DESCRIPTION}</description>\n\t<keywords>\n\t\t<word>{KEYWORDS_ONE}</word>\n\t\t<word>{KEYWORDS_TWO}</word>\n\t\t<word>{KEYWORDS_THREE}</word>\n\t</keywords>\n\t<category>{CATEGORY_CATEGORY}</category>\n\t<copyright>{COPYRIGHT_COPYRIGHT}</copyright>\n\t<adminLinks>\n\t\t<link url=\"admin_config.php\" description=\"{ADMINLINKS_DESCRIPTION}\" icon=\"\" iconSmall=\"\" icon128=\"\" primary=\"true\" >LAN_CONFIGURE</link>\n\t</adminLinks>\n\t{PLUGINPREFS}\n</e107Plugin>\nTEMPLATE;\n\n\n// pluginPrefs\n\n\n\n\n// TODO\n/*\n\t<siteLinks>\n\t\t<link url=\"{e_PLUGIN}_blank/_blank.php\" perm=\"everyone\">Blank</link>\t\t\n\t</siteLinks>\n\t<pluginPrefs>\n\t\t<pref name=\"blank_pref_1\">1</pref>\n\t\t<pref name=\"blank_pref_2\">[more...]</pref>\n\t</pluginPrefs>\n\t<userClasses>\n\t\t<class name=\"blank_userclass\" description=\"Blank Userclass Description\" />\t\t\n\t</userClasses>\n\t<extendedFields>\n\t\t<field name=\"custom\" type=\"EUF_TEXTAREA\" default=\"0\" active=\"true\" />\n\t</extendedFields>\t\n*/\n\n\n\t\t\t$result = e107::getParser()->simpleParse($template, $newArray);\n\t\t\t$path = e_PLUGIN.$this->pluginName.\"/plugin.xml\";\n\t\t\t\n\t\t\t\n\t\t\tif($this->createFiles == true)\n\t\t\t{\n\t\t\t\tif(file_put_contents($path,$result) )\n\t\t\t\t{\n\t\t\t\t\t$mes->addSuccess(EPL_ADLAN_155.\" \".$path);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$mes->addError(EPL_ADLAN_156.\" \".$path);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn  htmlentities($result);\n\t\t\t\n\t\t//\t$ns->tablerender(LAN_CREATED.\": plugin.xml\", \"<pre  style='font-size:80%'>\".htmlentities($result).\"</pre>\");\t\n\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\n\n\n\t\tfunction form($table,$fieldArray)\n\t\t{\n\t\t\t$frm = e107::getForm();\n\t\t\t\t\t\n\t\t\t$modes = array(\n\t\t\t\t\"main\"=>EPL_ADLAN_157,\n\t\t\t\t\"cat\"=>EPL_ADLAN_158,\n\t\t\t\t\"other1\"=>EPL_ADLAN_159,\n\t\t\t\t\"other2\"=>EPL_ADLAN_160,\n\t\t\t\t\"other3\"=>EPL_ADLAN_161,\n\t\t\t\t\"other4\"=>EPL_ADLAN_162,\n\t\t\t\t'exclude'=>EPL_ADLAN_163,\n\t\t\t);\n\t\t\t\n\t\t//\techo \"TABLE COUNT= \".$this->tableCount ;\n\t\t\t\n\t\t\t\n\t\t\t$this->table = $table.\"_ui\";\n\t\t\t\n\t\t\t$c=0;\n\t\t\tforeach($modes as $id=>$md)\n\t\t\t{\n\t\t\t\t$tbl = $this->tableList[$c];\n\t\t\t\t$defaultMode[$tbl] = $id;\t\n\t\t\t\t$c++;\n\t\t\t}\n\t\t\t\n\t\t//\tprint_a($defaultMode);\n\t\t\t\t\n\t\t\t$text = \t$frm->hidden($this->table.'[pluginName]', $this->pluginName, 15).\n\t\t\t\t\t\t$frm->hidden($this->table.'[table]', $table, 15);\n\t\t\t\t\n\t\t\tif($this->tableCount > 1)\n\t\t\t{\n\t\t\t\t$text .= \"<table class='table adminform'>\\n\";\n\t\t\t\t$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>Mode</td>\n\t\t\t\t\t\t<td>\".$frm->select($this->table.\"[mode]\",$modes, $defaultMode[$table], 'required=1&class=null', true).\"</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$text .= $frm->hidden($this->table.'[mode]','main');\n\t\t\t}\n\n\t\t\t$text .= \"</table>\".$this->special('checkboxes');\n\t\t\t\n\t\t\t$text .= \"<table class='table adminlist'>\n\t\t\t\t\t\t<thead>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<th>\".EPL_ADLAN_164.\"</th>\n\t\t\t\t\t\t\t<th>\".EPL_ADLAN_165.\"</th>\n\t\t\t\t\t\t\t<th>\".EPL_ADLAN_166.\"</th>\n\t\t\t\t\t\t\t<th>\".EPL_ADLAN_167.\"</th>\n\t\t\t\t\t\t\t<th>\".EPL_ADLAN_168.\"</th>\n\t\t\t\t\t\t\t<th class='center'>\".EPL_ADLAN_169.\"</th>\n\t\t\t\t\t\t\t<th class='center'>\".EPL_ADLAN_170.\"</th>\n\t\t\t\t\t\t\t<th class='center'>\".EPL_ADLAN_171.\"</th>\n\t\t\t\t\t\t\t<th class='center e-tip' title='\".EPL_ADLAN_177.\"'>\".EPL_ADLAN_172.\"</th>\n\t\t\t\t\t\t\t<th class='center e-tip' title='\".EPL_ADLAN_178.\"'>\".EPL_ADLAN_173.\"</th>\n\t\t\t\t\t\t\t<th>\".EPL_ADLAN_174.\"</th>\n\t\t\t\t\t\t\t<th>\".EPL_ADLAN_175.\"</th>\n\t\t\t\t\t\t\t<th>\".EPL_ADLAN_176.\"</th>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t</thead>\n\t\t\t\t\t\t<tbody>\n\t\t\t\t\t\t\";\n\t\t\t\t\t\t\n\t\t\tforeach($fieldArray as $name=>$val)\n\t\t\t{\n\t\t\t\tlist($tmp,$nameDef) = explode(\"_\",$name,2);\n\t\t\t\t// 'faq_question', 'faq_answer', 'faq_parent', 'faq_datestamp'\n\t\t\t\t$text .= \"<tr>\n\t\t\t\t\t<td>\".$name.\"</td>\n\t\t\t\t\t<td>\".$frm->text($this->table.\"[fields][\".$name.\"][title]\", $this->guess($name, $val,'title'),35, 'required=1').\"</td>\n\t\t\t\t\t<td>\".$this->fieldType($name, $val).\"</td>\n\t\t\t\t\t<td>\".$this->fieldData($name, $val).\"</td>\n\t\t\t\t\t<td>\".$frm->text($this->table.\"[fields][\".$name.\"][width]\", $this->guess($name, $val,'width'), 4, 'size=mini').\"</td>\n\t\t\t\t\t<td class='center'>\".$frm->checkbox($this->table.\"[fields][\".$name.\"][batch]\", true, $this->guess($name, $val,'batch')).\"</td>\n\t\t\t\t\t<td class='center'>\".$frm->checkbox($this->table.\"[fields][\".$name.\"][filter]\", true, $this->guess($name, $val,'filter')).\"</td>\n\t\t\t\t\t<td class='center'>\".$frm->checkbox($this->table.\"[fields][\".$name.\"][inline]\", true, $this->guess($name, $val,'inline')).\"</td>\n\t\t\t\t\t<td class='center'>\".$frm->checkbox($this->table.\"[fields][\".$name.\"][validate]\", true).\"</td>\n\t\t\t\t\t<td class='center'>\".$frm->checkbox($this->table.\"[fields][\".$name.\"][fieldpref]\", true, $this->guess($name, $val,'fieldpref')).\"</td>\n\t\t\t\t\t<td>\".$frm->text($this->table.\"[fields][\".$name.\"][help]\",'', 50,'size=medium').\"</td>\n\t\t\t\t\t<td>\".$frm->text($this->table.\"[fields][\".$name.\"][readParms]\",'', 60,'size=small').\"</td>\n\t\t\t\t\t<td>\".$frm->text($this->table.\"[fields][\".$name.\"][writeParms]\",'', 60,'size=small').\n\t\t\t\t\t$frm->hidden($this->table.\"[fields][\".$name.\"][class]\", $this->guess($name, $val,'class')).\n\t\t\t\t\t$frm->hidden($this->table.\"[fields][\".$name.\"][thclass]\", $this->guess($name, $val,'thclass')).\n\t\t\t\t\t\"</td>\n\t\t\t\t\t</tr>\";\n\t\t\t\n\t\t\t}\n\t\t\t//'width' => '20%',\t'thclass' => 'center',\t'batch' => TRUE, 'filter'=>TRUE, 'parms' => 'truncate=30', 'validate' => false, 'help' => 'Enter blank URL here', 'error' => 'please, ener valid URL'),\t\t\n\t\t\t$text .= \"</tbody></table>\".$this->special('options');\t\n\t\t\t\n\t\t\t\n\t\t\treturn $text;\n\t\t\t\n\t\t}\n\t\t\n\t\t// Checkboxes and Options. \n\t\tfunction special($name)\n\t\t{\n\t\t\t$frm = e107::getForm();\n\t\t\t$text = \"\";\n\t\t\t\n\t\t\tforeach($this->special[$name] as $key=>$val)\n\t\t\t{\n\t\t\t\t$text .= $frm->hidden($this->table.\"[fields][\".$name.\"][\".$key.\"]\", $val);\t\t\t\t\t\n\t\t\t}\n\n\t\t\treturn $text;\n\t\t\t\n\t\t}\n\n\n\t\t/**\n\t\t * @param $name\n\t\t * @param $val\n\t\t * @return string\n\t\t */\n\t\tfunction fieldType($name, $val)\n\t\t{\n\t\t\t$type = strtolower($val['type']);\n\t\t\t$frm = e107::getForm();\n\t\t\t\n\t\t\tif(strtolower($val['default']) == \"auto_increment\")\n\t\t\t{\n\t\t\t\t$key = $this->table.\"[pid]\";\n\t\t\t\treturn \"Primary Id\".$frm->hidden($key, $name );\t// \n\t\t\t}\n\t\t\t\n\t\t\tswitch ($type) \n\t\t\t{\n\t\t\t\tcase 'date':\n\t\t\t\tcase 'datetime':\n\t\t\t\tcase 'time':\n\t\t\t\tcase 'timestamp':\n\t\t\t\t\t$array = array(\n\t\t\t\t\t'text'\t\t=> EPL_ADLAN_179,\n\t\t\t\t\t\"hidden\"\t=> EPL_ADLAN_180,\n\t\t\t\t\t\"method\"\t=> EPL_ADLAN_186,\n\t\t\t\t\t);\n\t\t\t\tbreak;\n\t\t\t\n\t\t\t\tcase 'int':\n\t\t\t\tcase 'tinyint':\n\t\t\t\tcase 'bigint':\n\t\t\t\tcase 'smallint':\n\t\t\t\tcase 'mediumint':\n\t\t\t\t\t$array = array(\n\t\t\t\t\t\"boolean\"\t=> EPL_ADLAN_181,\n\t\t\t\t\t\"number\"\t=> EPL_ADLAN_182,\n\t\t\t\t\t\"dropdown\"\t=> EPL_ADLAN_183,\n\t\t\t\t\t\"userclass\"\t=> EPL_ADLAN_184,\n\t\t\t\t\t\"datestamp\"\t=> LAN_DATE,\n\t\t\t\t\t\"method\"\t=> EPL_ADLAN_186,\n\t\t\t\t\t\"hidden\"\t=> EPL_ADLAN_187,\n\t\t\t\t\t\"user\"\t\t=> EPL_ADLAN_188,\n\t\t\t\t\t);\t\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'decimal':\n\t\t\t\tcase 'double':\n\t\t\t\tcase 'float':\n\t\t\t\t\t$array = array(\n\t\t\t\t\t\"number\"\t=> EPL_ADLAN_189,\n\t\t\t\t\t\"dropdown\"\t=> EPL_ADLAN_190,\n\t\t\t\t\t\"method\"\t=> EPL_ADLAN_191,\n\t\t\t\t\t\"hidden\"\t=> EPL_ADLAN_192,\n\t\t\t\t\t);\t\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'varchar':\n\t\t\t\tcase 'tinytext':\n\t\t\t\tcase 'tinyblob':\n\t\t\t\t$array = array(\n\t\t\t\t\t'text'\t\t=> EPL_ADLAN_193,\n\t\t\t\t\t\"url\"\t\t=> EPL_ADLAN_194,\n\t\t\t\t\t\"email\"\t\t=> EPL_ADLAN_195,\n\t\t\t\t\t\"ip\"\t\t=> EPL_ADLAN_196,\n\t\t\t\t\t\"number\"\t=> EPL_ADLAN_197,\n\t\t\t\t\t\"password\"\t=> EPL_ADLAN_198,\n\t\t\t\t\t\"tags\"\t\t=> EPL_ADLAN_199,\n\t\t\t\t\t\n\t\t\t\t\t\"dropdown\"\t=> EPL_ADLAN_200,\n\t\t\t\t\t\"userclass\"\t=> EPL_ADLAN_201,\n\t\t\t\t\t\"language\"\t=> EPL_ADLAN_202,\n\n\t\t\t\t\t\"icon\"\t\t=> EPL_ADLAN_203,\n\t\t\t\t\t\"image\"\t\t=> EPL_ADLAN_204,\n\t\t\t\t\t\"file\"\t\t=> EPL_ADLAN_205,\n\t\t\t\t\t\"method\"\t=> EPL_ADLAN_206,\n\n\t\t\t\t\t\"hidden\"\t=> EPL_ADLAN_207\n\t\t\t\t\t);\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'enum':\n\t\t\t\t$array = array(\n\t\t\t\t\t\"dropdown\"\t=> EPL_ADLAN_200,\n\t\t\t\t\t\"tags\"\t\t=> EPL_ADLAN_211,\n\t\t\t\t\t\"method\"\t=> EPL_ADLAN_212,\n\t\t\t\t\t\"hidden\"\t=> EPL_ADLAN_215\n\t\t\t\t\t);\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'text':\n\t\t\t\tcase 'mediumtext':\n\t\t\t\tcase 'longtext':\n\t\t\t\tcase 'blob':\n\t\t\t\tcase 'mediumblob':\n\t\t\t\tcase 'longblob':\n\t\t\t\t$array = array(\n\t\t\t\t\t'textarea'\t=> EPL_ADLAN_208,\n\t\t\t\t\t'bbarea'\t=> EPL_ADLAN_209,\n\t\t\t\t\t'text'\t\t=> EPL_ADLAN_210,\n\t\t\t\t\t\"tags\"\t\t=> EPL_ADLAN_211,\n\t\t\t\t\t\"method\"\t=> EPL_ADLAN_212,\n\t\t\t\t\t\"image\"\t\t=> EPL_ADLAN_213,\n\t\t\t\t\t\"images\"\t=> EPL_ADLAN_214,\n\t\t\t\t\t\"hidden\"\t=> EPL_ADLAN_215\n\t\t\t\t\t);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\t\n\t\t//\tasort($array);\n\t\t\t\n\t\t\t$fname = $this->table.\"[fields][\".$name.\"][type]\";\n\t\t\treturn $frm->select($fname, $array, $this->guess($name, $val),'required=1&class=null', true);\n\t\t\t\n\t\t}\n\n\t\t// Guess Default Field Type based on name of field. \n\t\tfunction guess($data, $val='',$mode = 'type')\n\t\t{\n\t\t\t$tmp = explode(\"_\",$data);\t\n\t\t\t\n\t\t\tif(count($tmp) == 3) // eg Link_page_title\n\t\t\t{\n\t\t\t\t$name = $tmp[2];\t\n\t\t\t}\n\t\t\telseif(count($tmp) == 2) // Link_description\n\t\t\t{\n\t\t\t\t$name = $tmp[1];\t\t\n\t\t\t}\n\t\t\telseif(count($tmp) === 1)\n\t\t\t{\n\t\t\t\t$name = $data;\t\n\t\t\t}\n\t\n\t\t\t$ret['title'] = ucfirst($name);\n\t\t\t$ret['width'] = 'auto';\n\t\t\t$ret['class'] = 'left';\n\t\t\t$ret['thclass'] = 'left';\n\t\t\t\n\t\t//\techo \"<br />name=\".$name; \n\t\t\tswitch ($name) \n\t\t\t{\n\t\t\t\t\n\t\t\t\tcase 'id':\n\t\t\t\t\t$ret['title'] = 'LAN_ID';\n\t\t\t\t\t$ret['type'] = 'boolean';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\t\t$ret['width'] = '5%';\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'start':\n\t\t\t\tcase 'end':\n\t\t\t\tcase 'datestamp':\n\t\t\t\tcase 'date':\n\t\t\t\t\t$ret['title'] = 'LAN_DATESTAMP';\n\t\t\t\t\t$ret['type'] = 'datestamp';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = true;\n\t\t\t\t\t$ret['fieldpref'] = true;\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'prename':\n\t\t\t\tcase 'firstname':\n\t\t\t\tcase 'lastname':\n\t\t\t\tcase 'company':\n\t\t\t\tcase 'city':\n\t\t\t\t\t$ret['title'] = ucfirst($name);\n\t\t\t\t\t$ret['type'] = 'text';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['fieldpref'] = true;\n\t\t\t\t\t$ret['inline'] = true;\n\t\t\t\tbreak;\n\n\t\t\t\t\n\t\t\t\tcase 'name':\n\t\t\t\tcase 'title':\n\t\t\t\tcase 'subject':\n\t\t\t\tcase 'summary':\n\t\t\t\t\t$ret['title'] = 'LAN_TITLE';\n\t\t\t\t\t$ret['type'] = 'text';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['fieldpref'] = true;\n\t\t\t\t\t$ret['inline'] = true;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'email':\n\t\t\t\tcase 'email2':\n\t\t\t\t\t$ret['title'] = 'LAN_EMAIL';\n\t\t\t\t\t$ret['type'] = 'email';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['fieldpref'] = false;\n\t\t\t\t\t$ret['inline'] = true;\n\t\t\t\tbreak;\n\n\t\t\t\t\n\t\t\t\tcase 'ip':\n\t\t\t\t\t$ret['title'] = 'LAN_IP';\n\t\t\t\t\t$ret['type'] = 'ip';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['fieldpref'] = false;\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'user':\t\n\t\t\t\tcase 'userid':\t\t\t\t\n\t\t\t\tcase 'author':\n\t\t\t\t\t$ret['title'] = 'LAN_AUTHOR';\n\t\t\t\t\t$ret['type'] = 'user';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'thumb':\n\t\t\t\tcase 'thumbnail':\n\t\t\t\tcase 'image':\n\t\t\t\t\t$ret['title'] = 'LAN_IMAGE';\n\t\t\t\t\t$ret['type'] = 'image';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'total':\n\t\t\t\tcase 'order':\n\t\t\t\tcase 'limit':\n\t\t\t\t\t$ret['title'] = 'LAN_ORDER';\n\t\t\t\t\t$ret['type'] = 'number';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'code':\n\t\t\t\tcase 'zip':\n\t\t\t\t\t$ret['title'] = ucfirst($name);\n\t\t\t\t\t$ret['type'] = 'number';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['inline'] = true;\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'state':\n\t\t\t\tcase 'country':\n\t\t\t\tcase 'category':\n\t\t\t\t\t$ret['title'] = ($name == 'category') ? 'LAN_CATEGORY' : ucfirst($name);\n\t\t\t\t\t$ret['type'] = 'dropdown';\n\t\t\t\t\t$ret['batch'] = true;\n\t\t\t\t\t$ret['filter'] = true;\n\t\t\t\t\t$ret['fieldpref'] = true;\n\t\t\t\t\t$ret['inline'] = true;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'type':\n\t\t\t\t\t$ret['title'] = 'LAN_TYPE';\n\t\t\t\t\t$ret['type'] = 'dropdown';\n\t\t\t\t\t$ret['batch'] = true;\n\t\t\t\t\t$ret['filter'] = true;\n\t\t\t\t\t$ret['fieldpref'] = true;\n\t\t\t\t\t$ret['inline'] = true;\n\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\n\t\t\t\tcase 'icon':\n\t\t\t\tcase 'button':\n\t\t\t\t\t$ret['title'] = 'LAN_ICON';\n\t\t\t\t\t$ret['type'] = 'icon';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'website':\n\t\t\t\tcase 'url':\n\t\t\t\tcase 'homepage':\n\t\t\t\t\t$ret['title'] = 'LAN_URL';\n\t\t\t\t\t$ret['type'] = 'url';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['inline'] = true;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'visibility':\n\t\t\t\tcase 'class':\n\t\t\t\t\t$ret['title'] = 'LAN_USERCLASS';\n\t\t\t\t\t $ret['type'] = 'userclass';\n\t\t\t\t\t $ret['batch'] = true;\n\t\t\t\t\t $ret['filter'] = true;\n\t\t\t\t\t $ret['fieldpref'] = true;\n\t\t\t\t\t$ret['inline'] = true;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase 'notes':\n\t\t\t\tcase 'comment':\n\t\t\t\tcase 'comments':\n\t\t\t\tcase 'address':\n\t\t\t\tcase 'description':\n\t\t\t\t\t$ret['title'] = ($name == 'description') ? 'LAN_DESCRIPTION' : ucfirst($name);\n\t\t\t\t\t $ret['type'] = ($val['type'] == 'TEXT') ? 'textarea' : 'text';\n\t\t\t\t\t $ret['width'] = '40%';\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tdefault:\n\t\t\t\t\t$ret['type'] = 'boolean';\n\t\t\t\t\t$ret['class'] = 'left';\n\t\t\t\t\t$ret['batch'] = false;\n\t\t\t\t\t$ret['filter'] = false;\n\t\t\t\t\t$ret['thclass'] = 'left';\n\t\t\t\t\t$ret['width'] = 'auto';\n\t\t\t\t\t$ret['inline'] = false;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\t\n\t\t\treturn vartrue($ret[$mode]);\n\t\t\t\n\t\t}\n\n\n\n\n\t\tfunction fieldData($name, $val)\n\t\t{\n\t\t\t$frm = e107::getForm();\n\t\t\t$type = $val['type'];\n\t\t\t\n\t\t\t$strings = array('time','timestamp','datetime','year','tinyblob','blob',\n\t\t\t\t\t\t\t'mediumblob','longblob','tinytext','mediumtext','longtext','text','date','varchar','char');\n\t\t\t\n\t\t\t\n\t\t\tif(in_array(strtolower($type),$strings))\n\t\t\t{\n\t\t\t\t$value = 'str';\t\n\t\t\t}\t\n\t\t\telse \n\t\t\t{\n\t\t\t\t$value = 'int';\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t$fname = $this->table.\"[fields][\".$name.\"][data]\";\n\t\t\t\n\t\t\treturn $frm->hidden($fname, $value). \"<a href='#' class='e-tip' title='{$type}' >\".$value.\"</a>\" ;\n\t\t\t\n\t\t}\n\n\n\n\n// ******************************** CODE GENERATION AREA *************************************************\n\n\t\tfunction step4()\n\t\t{\n\t\t\t$tp = e107::getParser();\n\t\t\t$pluginTitle = $tp->filter($_POST['xml']['main-name']);\n\t\t\t\n\t\t\tif($_POST['xml'])\n\t\t\t{\n\t\t\t\t$_POST['xml'] = $tp->filter($_POST['xml']);\n\t\t\t\t$xmlText =\t$this->createXml($_POST['xml']);\n\t\t\t}\n\t\t\t\t\t\n\t\t\tif(!empty($_POST['addons']))\n\t\t\t{\n\t\t\t\t$_POST['addons'] = $tp->filter($_POST['addons']);\n\t\t\t\t$addonResults = $this->createAddons($_POST['addons']);\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tunset($_POST['step'],$_POST['xml'], $_POST['addons']);\n\t\t$thePlugin = $tp->filter($_POST['newplugin'],'file');\n\n$text = \"\\n\n// Generated e107 Plugin Admin Area \n\nrequire_once('../../class2.php');\nif (!getperms('P')) \n{\n\te107::redirect('admin');\n\texit;\n}\n\n// e107::lan('\".$thePlugin.\"',true);\n\n\nclass \".$thePlugin.\"_adminArea extends e_admin_dispatcher\n{\n\n\tprotected \\$modes = array(\t\n\t\";\n\t\n\n\tunset($_POST['newplugin']);\n\n\t\n\t\t\tforeach($_POST as $table => $vars) // LOOP Through Tables. \n\t\t\t{\n\t\t\t\tif(vartrue($vars['mode']) && $vars['mode'] != 'exclude')\n\t\t\t\t{\n\n\t\t\t\t\t$vars['mode'] = $tp->filter($vars['mode']);\n\n\t$text .= \"\n\t\t'\".$vars['mode'].\"'\t=> array(\n\t\t\t'controller' \t=> '\".$table.\"',\n\t\t\t'path' \t\t\t=> null,\n\t\t\t'ui' \t\t\t=> '\".str_replace(\"_ui\", \"_form_ui\", $table).\"',\n\t\t\t'uipath' \t\t=> null\n\t\t),\n\t\t\n\";\n\t\t\t\t}\n\t\t\t} // END LOOP\n/*\n\t\t'cat'\t\t=> array(\n\t\t\t'controller' \t=> 'faq_cat_ui',\n\t\t\t'path' \t\t\t=> null,\n\t\t\t'ui' \t\t\t=> 'faq_cat_form_ui',\n\t\t\t'uipath' \t\t=> null\n\t\t)\t\t\t\t\t\n\t);\t\n*/\n\n$text .= \"\n\t);\t\n\t\n\t\n\tprotected \\$adminMenu = array(\n\";\n\t\t\tforeach($_POST as $table => $vars) // LOOP Through Tables. \n\t\t\t{\n\t\t\t\tif(vartrue($vars['mode']) && $vars['mode'] != 'exclude' && !empty($vars['table']))\n\t\t\t\t{\n\n\t\t\t\t\t\t$vars['mode'] = $tp->filter($vars['mode']);\n$text .= \"\n\t\t'\".$vars['mode'].\"/list'\t\t\t=> array('caption'=> LAN_MANAGE, 'perm' => 'P'),\n\t\t'\".$vars['mode'].\"/create'\t\t=> array('caption'=> LAN_CREATE, 'perm' => 'P'),\n\";\n}\n\t\t\t}\n\t\t\t\nif($_POST['pluginPrefs'][0]['index'])\n{\n\t\t\t\t\n$text .= \"\t\t\t\n\t\t'main/prefs' \t\t=> array('caption'=> LAN_PREFS, 'perm' => 'P'),\t\n\";\n}\n$text .= \"\n\t\t// 'main/custom'\t\t=> array('caption'=> 'Custom Page', 'perm' => 'P')\n\t);\n\n\tprotected \\$adminMenuAliases = array(\n\t\t'main/edit'\t=> 'main/list'\t\t\t\t\n\t);\t\n\t\n\tprotected \\$menuTitle = '\".vartrue($pluginTitle, $tp->filter($vars['pluginName'])).\"';\n}\n\n\n\n\";\t\t\t\n\t\t\t// print_a($_POST);\n\n\t\t\t\n\t\t\t$srch = array(\n\t\t\t\t\n\t\t\t\t\"\\n\",\n\t\t\t\t\"),\",\n\t\t\t\t\"    \",\n\t\t\t\t\"'batch' => '1'\",\n\t\t\t\t\"'filter' => '1'\",\n\t\t\t\t\"'inline' => '1'\",\n\t\t\t\t\"'validate' => '1'\",\n\t\t\t\t\", 'fieldpref' => '1'\",\n\t\t\t\t\"'type' => ''\",\n\t\t\t\t\"'data' => ''\"\n\t\t\t );\n\t\t\t \n\t\t\t$repl = array(\n\t\t\t\t\n\t\t\t\t \"\",\n\t\t\t\t \"),\\n\\t\\t\",\n\t\t\t\t \" \",\n\t\t\t\t\"'batch' => true\",\n\t\t\t\t\"'filter' => true\",\n\t\t\t\t\"'inline' => true\",\n\t\t\t\t\"'validate' => true\",\n\t\t\t\t\"\",\n\t\t\t\t\"'type' => null\",\n\t\t\t\t\"'data' => null\"\n\t\t\t\t  );\n\t\t\t\n\t\n\t\t\t\n\t\t\t \n\t\t\t$tableCount = 1;\n\t\t\tforeach($_POST as $table => $vars) // LOOP Through Tables. \n\t\t\t{\n\n\t\t\t\t$vars['mode'] = $tp->filter($vars['mode']);\n\t\t\t\t$vars['pluginName'] = $tp->filter($vars['pluginName']);\n\t\t\t\t$vars['table'] = $tp->filter($vars['table']);\n\t\t\t\t$vars['pid'] = $tp->filter($vars['pid']);\n\n\t\t\t\tif($table == 'pluginPrefs' || $vars['mode'] == 'exclude')\n\t\t\t\t{\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tforeach($vars['fields'] as $key=>$val)\n\t\t\t\t{\n\t\t\t\t\tif($val['type'] == 'image' && empty($val['readParms']))\n\t\t\t\t\t{\t\n\t\t\t\t\t\t$vars['fields'][$key]['readParms'] = 'thumb=80x80'; // provide a thumbnail preview by default. \n\t\t\t\t\t}\t\n\t\t\t\t}\n\t\t\t\t\t\t\n\n\t\t\t\t$FIELDS = str_replace($srch,$repl,var_export($vars['fields'],true));\n\t\t\t\t$FIELDS = preg_replace(\"#('([A-Z0-9_]*?LAN[_A-Z0-9]*)')#\",\"$2\",$FIELDS); // remove quotations from LANs. \n\t\t\t\t$FIELDPREF = array();\n\t\t\t\t\n\t\t\t\tforeach($vars['fields'] as $k=>$v)\n\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\tif(isset($v['fieldpref']) && $k != 'checkboxes' && $k !='options')\n\t\t\t\t\t{\n\t\t\t\t\t\t$FIELDPREF[] = \"'\".$k.\"'\";\n\t\t\t\t\t}\t\t\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\t\n$text .= \n\"\n\t\t\t\t\nclass \".$table.\" extends e_admin_ui\n{\n\t\t\t\n\t\tprotected \\$pluginTitle\t\t= '\".$pluginTitle.\"';\n\t\tprotected \\$pluginName\t\t= '\".$vars['pluginName'].\"';\n\t//\tprotected \\$eventName\t\t= '\".$vars['pluginName'].\"-\".$vars['table'].\"'; // remove comment to enable event triggers in admin. \t\t\n\t\tprotected \\$table\t\t\t= '\".$vars['table'].\"';\n\t\tprotected \\$pid\t\t\t\t= '\".$vars['pid'].\"';\n\t\tprotected \\$perPage\t\t\t= 10; \n\t\tprotected \\$batchDelete\t\t= true;\n\t\tprotected \\$batchExport     = true;\n\t\tprotected \\$batchCopy\t\t= true;\n\t//\tprotected \\$sortField\t\t= 'somefield_order';\n\t//\tprotected \\$orderStep\t\t= 10;\n\t//\tprotected \\$tabs\t\t\t\t= array('Tabl 1','Tab 2'); // Use 'tab'=>0  OR 'tab'=>1 in the \\$fields below to enable. \n\t\t\n\t//\tprotected \\$listQry      \t= \\\"SELECT * FROM `#tableName` WHERE field != '' \\\"; // Example Custom Query. LEFT JOINS allowed. Should be without any Order or Limit.\n\t\n\t\tprotected \\$listOrder\t\t= '\".$vars['pid'].\" DESC';\n\t\n\t\tprotected \\$fields \t\t= \".$FIELDS.\";\t\t\n\t\t\n\t\tprotected \\$fieldpref = array(\".implode(\", \",$FIELDPREF).\");\n\t\t\n\";\n\n\nif($_POST['pluginPrefs'] && ($vars['mode']=='main'))\n{\n\t$text .= \"\n\t//\tprotected \\$preftabs        = array('General', 'Other' );\n\t\tprotected \\$prefs = array(\\n\";\n\t\t\n\t\tforeach($_POST['pluginPrefs'] as $k=>$val)\n\t\t{\n\t\t\tif(vartrue($val['index']))\n\t\t\t{\n\t\t\t\t$index = $tp->filter($val['index']);\n\t\t\t\t$type = vartrue($val['type'],'text');\n\t\t\t\t$help = str_replace(\"'\",'', vartrue($val['help']));\n\t\t\t\t\n\t\t\t\t$text .= \"\\t\\t\\t'\".$index.\"'\\t\\t=> array('title'=> '\".ucfirst($index).\"', 'tab'=>0, 'type'=>'\".$tp->filter($type).\"', 'data' => 'str', 'help'=>'\".$tp->filter($help).\"'),\\n\";\n\t\t\t}\t\n\t\n\t\t}\n\t\t\n\t\t\n\t\t$text .= \"\\t\\t); \\n\\n\";\n\t\t\t\t\n}\n\t\t\t\t\n\t\t\t\n\n$text .= \"\t\n\t\tpublic function init()\n\t\t{\n\t\t\t// Set drop-down values (if any). \n\";\n\t\t\t\n\t\tforeach($vars['fields'] as $k=>$v)\n\t\t{\n\t\t\tif($v['type'] == 'dropdown')\n\t\t\t{\n\t\t\t\t$text .= \"\\t\\t\\t\\$this->fields['\".$k.\"']['writeParms']['optArray'] = array('\".$k.\"_0','\".$k.\"_1', '\".$k.\"_2'); // Example Drop-down array. \\n\";\n\t\t\t}\n\t\t}\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\n\t\t\t\n$text .= \"\t\n\t\t}\n\n\t\t\n\t\t// ------- Customize Create --------\n\t\t\n\t\tpublic function beforeCreate(\\$new_data,\\$old_data)\n\t\t{\n\t\t\treturn \\$new_data;\n\t\t}\n\t\n\t\tpublic function afterCreate(\\$new_data, \\$old_data, \\$id)\n\t\t{\n\t\t\t// do something\n\t\t}\n\n\t\tpublic function onCreateError(\\$new_data, \\$old_data)\n\t\t{\n\t\t\t// do something\t\t\n\t\t}\t\t\n\t\t\n\t\t\n\t\t// ------- Customize Update --------\n\t\t\n\t\tpublic function beforeUpdate(\\$new_data, \\$old_data, \\$id)\n\t\t{\n\t\t\treturn \\$new_data;\n\t\t}\n\n\t\tpublic function afterUpdate(\\$new_data, \\$old_data, \\$id)\n\t\t{\n\t\t\t// do something\t\n\t\t}\n\t\t\n\t\tpublic function onUpdateError(\\$new_data, \\$old_data, \\$id)\n\t\t{\n\t\t\t// do something\t\t\n\t\t}\t\t\n\t\t\n\t\t\t\n\t/*\t\n\t\t// optional - a custom page.  \n\t\tpublic function customPage()\n\t\t{\n\t\t\t\\$text = 'Hello World!';\n\t\t\t\\$otherField  = \\$this->getController()->getFieldVar('other_field_name');\n\t\t\treturn \\$text;\n\t\t\t\n\t\t}\n\t*/\n\t\t\t\n}\n\t\t\t\t\n\n\nclass \".str_replace(\"_ui\", \"_form_ui\", $table).\" extends e_admin_form_ui\n{\n\";\n\nforeach($vars['fields'] as $fld=>$val)\n{\n\tif(varset($val['type']) != 'method')\n\t{\n\t\tcontinue;\t\n\t}\t\n\t\n$text .= \"\n\t\n\t// Custom Method/Function \n\tfunction \".$fld.\"(\\$curVal,\\$mode)\n\t{\n\n\t\t \t\t\n\t\tswitch(\\$mode)\n\t\t{\n\t\t\tcase 'read': // List Page\n\t\t\t\treturn \\$curVal;\n\t\t\tbreak;\n\t\t\t\n\t\t\tcase 'write': // Edit Page\n\t\t\t\treturn \\$this->text('\".$fld.\"',\\$curVal, 255, 'size=large');\n\t\t\tbreak;\n\t\t\t\n\t\t\tcase 'filter':\n\t\t\tcase 'batch':\n\t\t\t\treturn  array();\n\t\t\tbreak;\n\t\t}\n\t}\n\";\n}\n\n$text .= \"\n}\t\t\n\t\t\n\";\t\t\t\n\t\t\t\t\t\t\n\t \t\t$tableCount++;\t\n\t\t\t\t\t\n\t\t\t} // End LOOP. \n\t\n$text .= '\t\t\nnew '.$thePlugin.'_adminArea();\n\nrequire_once(e_ADMIN.\"auth.php\");\ne107::getAdminUI()->runPage();\n\nrequire_once(e_ADMIN.\"footer.php\");\nexit;\n\n';\n\n// ******************************** END GENERATION AREA *************************************************\t\n\t\t\t\t\t\n\t\t\t$ns = e107::getRender();\n\t\t\t$mes = e107::getMessage();\n\t\t\t\n\t\t\t$generatedFile = e_PLUGIN.$thePlugin.\"/admin_config.php\";\n\t\t\t\n\t\t\t$startPHP = chr(60).\"?php\";\t\t\n\t\t\t$endPHP =  \"?>\";\n\n\t\t\tif(!empty($addonResults))\n\t\t\t{\n\t\t\t\tforeach($addonResults as $v)\n\t\t\t\t{\n\t\t\t\t\t$mes->addSuccess($v);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif($this->createFiles == true)\n\t\t\t{\n\t\t\t\tif(file_put_contents($generatedFile, $startPHP .$text . $endPHP))\n\t\t\t\t{\n\t\t\t\t\t$message = str_replace(\"[x]\", \"<a class='alert-link' href='\".$generatedFile.\"'>\".EPL_ADLAN_216.\"</a>\", EPL_ADLAN_217);\n\t\t\t\t\t$mes->addSuccess($message);\n\t\t\t\t}\t\n\t\t\t\telse \n\t\t\t\t{\n\t\t\t\t\t$mes->addError(str_replace('[x]', $generatedFile, EPL_ADLAN_218));\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$mes->addSuccess(EPL_ADLAN_219);\n\t\t\t}\n\n\n\n\n\t\t\t\n\t\t//\techo $mes->render();\n\n\t\t\t$ret = \"<h3>plugin.xml</h3>\";\n\t\t\t$ret .= \"<pre style='font-size:80%'>\".$xmlText.\"</pre>\";\n\t\t\t$ret .= \"<h3>admin_config.php</h3>\";\n\t\t\t$ret .= \"<pre style='font-size:80%'>\".$text.\"</pre>\";\n\n\t\t\treturn array('caption'=>EPL_ADLAN_253, 'text'=> $ret);\n\t\t\t\n\t\t//\t$text =$ns->tablerender(ADLAN_98.SEP.EPL_ADLAN_114.SEP.\" plugin.xml\", \"<pre style='font-size:80%'>\".$xmlText.\"</pre>\", 'default', true);\n\n\n\n\t\t\t\n\t\t\t$text .= $ns->tablerender(\"admin_config.php\", \"<pre style='font-size:80%'>\".$text.\"</pre>\");\n\t\t\t\n\t\t//\t\n\t\t\treturn;\n\t\n\t\t}\n}\n\n?>\n", "<?php\n/*\n * e107 website system\n *\n * Copyright (C) 2008-2013 e107 Inc (e107.org)\n * Released under the terms and conditions of the\n * GNU General Public License (http://www.gnu.org/licenses/gpl.txt)\n *\n * Administration - Site Preferences\n *\n */\n\nif(!empty($_POST) && !isset($_POST['e-token']))\n{\n\t$_POST['e-token'] = '';\n}\nrequire_once (\"../class2.php\");\n\nif(isset($_POST['newver']))\n{\n\theader(\"location:http://e107.org/index.php\");\n\texit();\n}\n\nif(!getperms(\"1\"))\n{\n\te107::redirect('admin');\n\texit();\n}\n\ne107::coreLan('prefs', true);\n\n$e_sub_cat = 'prefs';\n//e107::lan('core','mailout','admin');\ne107::coreLan('mailout', true);\n\n\nrequire_once (e_ADMIN.\"auth.php\");\n\n$e_userclass = e107::getUserClass(); \nrequire_once (e_HANDLER.\"user_extended_class.php\");\nrequire_once(e_HANDLER.'mailout_admin_class.php');\t\t// Admin tasks handler\n$ue = new e107_user_extended();\n$core_pref = e107::getConfig();\n\nif(!$core_pref->get('timezone'))\n{\n\t$core_pref->set('timezone', 'UTC');\n}\n\n$frm = e107::getForm(false, true); //enable inner tabindex counter\n$mes = e107::getMessage();\n$tp = e107::getParser();\n\n/*\tRESET DISPLAY NAMES\t*/\nif(isset($_POST['submit_resetdisplaynames']))\n{\n\te107::getDb()->db_Update('user', 'user_name=user_loginname');\n\t$mes->addInfo(PRFLAN_157);\n}\n\n//echo '<pre>';\n//var_dump($core_pref->getPref());\n//echo '</pre>';\n\nif (isset($_POST['testemail'])) \n{\n\tsendTest();\n}\n\t\t\n\t\n\n\n\n\n/*\tUPDATE PREFERENCES */\nif(isset($_POST['updateprefs']))\n{\n\t\n\t\n\t\n\tunset($_POST['updateprefs'], $_POST['sitelanguage']);\n\t\n\n\n\t$_POST['cookie_name'] = str_replace(array(\" \", \".\"), \"_\", $_POST['cookie_name']);\n\t$_POST['cookie_name'] = preg_replace(\"#[^a-zA-Z0-9_]#\", \"\", $_POST['cookie_name']);\n\n\t$_POST['siteurl'] = trim($_POST['siteurl']) ? trim($_POST['siteurl']) : SITEURL;\n\t$_POST['siteurl'] = substr($_POST['siteurl'], - 1) == \"/\" ? $_POST['siteurl'] : $_POST['siteurl'].\"/\";\n\n\t// If email verification or Email/Password Login Method - email address is required!\n\tif (($_POST['user_reg_veri'] == 1 || $_POST['allowEmailLogin'] == 1) && $_POST['disable_emailcheck'])\n\t{\n\t\t$_POST['disable_emailcheck'] = 0;\n\t\t$mes->addError(PRFLAN_211);\n    }\n\n\t// Table of range checking values - min and max for numerics. Only do the important ones\n\t$pref_limits = array('loginname_maxlength' => array('min' => 10, 'max' => 100, 'default' => 30),\n\t\t\t\t\t'displayname_maxlength' => array('min' => 5, 'max' => 100, 'default' => 15),\n\t\t\t\t\t'antiflood_timeout' => array('min' => 3, 'max' => 300, 'default' => 10),\n\t\t\t\t\t'signup_pass_len' => array('min' => 2, 'max' => 100, 'default' => 4)\n\t\t\t\t\t);\n\n\t$pref['post_html'] = intval($_POST['post_html']);\t\t\t// This ensures the setting is reflected in set text\n\n\n\t$smtp_opts = array();\n\n\tif(!empty($_POST['smtp_options']))\n\t{\n\n\t\tswitch (trim($_POST['smtp_options']))\n\t\t{\n\t\t\tcase 'smtp_ssl' :\n\t\t\t\t$smtp_opts[] = 'secure=SSL';\n\t\t\t\tbreak;\n\t\t\tcase 'smtp_tls' :\n\t\t\t\t$smtp_opts[] = 'secure=TLS';\n\t\t\t\tbreak;\n\t\t\tcase 'smtp_pop3auth' :\n\t\t\t\t$smtp_opts[] = 'pop3auth';\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif (!empty($_POST['smtp_keepalive']))\n\t\t{\n\t\t\t$smtp_opts[] = 'keepalive';\n\t\t}\n\n\t\tif (!empty($_POST['smtp_useVERP']))\n\t\t{\n\t\t\t$smtp_opts[] = 'useVERP';\n\t\t}\n\n\t\t$_POST['smtp_options'] = implode(',',$smtp_opts);\n\n\t\tunset($_POST['smtp_keepalive'],$_POST['smtp_useVERP']);\n\n\t\t// e107::getMessage()->addDebug(print_a($_POST['smtp_options'],true));\n\t}\n\n\n\n\n\t\n\t$_POST['membersonly_exceptions'] = explode(\"\\n\",$_POST['membersonly_exceptions']);\n\n\t// FIXME - automate - pref model & validation handler\n\t$prefChanges = array();\n\t$sessionRegenerate = false;\n\tforeach($_POST as $key => $value)\n\t{\n\t\tif(isset($pref_limits[$key]))\n\t\t{ // Its a numeric value to check\n\t\t\tif(is_numeric($value))\n\t\t\t{\n\t\t\t\tif($value < $pref_limits[$key]['min'])\n\t\t\t\t{\n\t\t\t\t\t$value = $pref_limits[$key]['min'];\n\t\t\t\t\t$mes->addWarning(str_replace(array('--FIELD--','--VALUE--'),array($key,$value),PRFLAN_213));\n\t\t\t\t}\n\t\t\t\tif($value > $pref_limits[$key]['max'])\n\t\t\t\t{\n\t\t\t\t\t$value = $pref_limits[$key]['max'];\n\t\t\t\t\t$mes->addWarning(str_replace(array('--FIELD--','--VALUE--'),array($key,$value),PRFLAN_212));\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$value = $pref_limits[$key]['default'];\n\t\t\t}\n\t\t\t$newValue = $value;\n\t\t}\n\t\telseif('cookie_name' == $key && $core_pref->get($key) != $value)\n\t\t{\n\t\t\t// special case\n\t\t\tif(!preg_match('/^[\\w\\-]+$/', $value))\n\t\t\t{\n\t\t\t\t$newValue = e_COOKIE;\n\t\t\t\t$mes->addWarning(PRFLAN_219);\n\t\t\t}\n\t\t\telse \n\t\t\t{\n\t\t\t\t$newValue = $value;\n\t\t\t\t$sessionRegenerate = true;\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$newValue = $tp->toDB($value);\n\t\t}\n\t\t\n\t\t$core_pref->update($key, $newValue);\n\t}\n\n\tif($core_pref->dataHasChanged())\n\t{\n\t\t// Need to clear cache in order to refresh library information.\n\t\te107::getCache()->clearAll('system');\n\t}\n\n\t$core_pref->save(false);\n\n\t// special case, do session cleanup, logout, redirect to login screen\n\tif($sessionRegenerate)\n\t{\n\t\t// reset cookie\n\t\tcookie($core_pref->get('cookie_name'), $_COOKIE[e_COOKIE], (time() + 3600 * 24 * 30), e_HTTP, e107::getLanguage()->getCookieDomain());\n\t\tcookie(e_COOKIE, null, null);\n\t\t\n\t\t// regenerate session\n\t\t$s = $_SESSION;\n\t\te107::getSession()->destroy();\n\t\t$session = new e_core_session(array('name' => $core_pref->get('cookie_name')));\n\t\t$_SESSION = $s;\n\t}\n}\n\nif (e107::isInstalled('alt_auth'))\n{\n\t$authlist[] = \"e107\";\n\t$handle = opendir(e_PLUGIN.\"alt_auth\");\n\twhile($file = readdir($handle))\n\t{\n\t\tif(preg_match(\"/^(.*)_auth\\.php/\", $file, $match))\n\t\t{\n\t\t\t$authlist[] = $match[1];\n\t\t}\n\t}\n}\n\n\n\nfunction sendTest()\n{\n\t$log = e107::getAdminLog();\n\t$mes = e107::getMessage();\n\t\n\tif(trim($_POST['testaddress']) == '')\n\t{\n\t\t$mes->add(LAN_MAILOUT_19, E_MESSAGE_ERROR);\n\t\t$subAction = 'error';\n\t}\n\telse\n\t{\n\t\t$mailheader_e107id = USERID;\n\t\t$pref = e107::pref('core');\n\n\t\t$add = ($pref['mailer']) ? \" (\".strtoupper($pref['mailer']).\") \" : ' (PHP)';\n\n\t\tif($pref['mailer'] == 'smtp')\n\t\t{\n\t\t\t$add .= \"Port: \".varset($pref['smtp_port'],25);\n\t\t\t$add .= \" - \".str_replace(\"secure=\", \"\", $pref['smtp_options']);\n\t\t}\n\n\n\t\t$sendto = trim($_POST['testaddress']);\n\t\t\n\t\t\n\t\t$eml = array(); \n\t\t\n\t\t$eml['email_subject']\t\t= LAN_MAILOUT_113.\" \".$add;\n\t\t$eml['email_sender_email']\t= null; \n\t\t$eml['email_sender_name']\t= null;\n\t\t$eml['email_replyto']\t\t= null;\n\t\t$eml['email_replytonames']\t= null; \n\t\t$eml['send_html']\t\t\t= true; \n\t\t$eml['add_html_header'] \t= null; \n\t\t$eml['email_body']\t\t\t= str_replace(\"[br]\", \"<br>\", LAN_MAILOUT_114);\n\t\t$eml['email_attach']\t\t= null;\n\t\t$eml['template']\t\t\t= 'default';\n\t\t$eml['e107_header']\t\t\t= USERID;\n\n\t\tif (!e107::getEmail()->sendEmail($sendto, LAN_MAILOUT_189, $eml)) \n\t\t{\n\t\t\t$mes->addError(($pref['mailer'] == 'smtp')  ? LAN_MAILOUT_67 : LAN_MAILOUT_106);\n\t\t} \n\t//\tif (!sendemail($sendto, LAN_MAILOUT_113.\" \".SITENAME.$add, str_replace(\"[br]\", \"\\n\", LAN_MAILOUT_114),LAN_MAILOUT_189)) \n\t//\t{\n\t//\t\t$mes->addError(($pref['mailer'] == 'smtp')  ? LAN_MAILOUT_67 : LAN_MAILOUT_106);\n\t//\t} \n\t\telse \n\t\t{\n\t\t\t$mes->addSuccess(LAN_MAILOUT_81. ' ('.$sendto.')');\n\t\t\t$log->log_event('MAIL_01',$sendto,E_LOG_INFORMATIVE,'');\n\t\t}\n\t}\n\n}\n\n/*\nif(e_QUERY == \"u\")\n{\n\t$ns->tablerender(\"\", \"<div style='text-align:center'><b>\".PRFLAN_106.\"</b></div>\");\n}\n*/\n$handle = opendir(e_ADMIN.'includes/');\nwhile($file = readdir($handle))\n{\n\tif($file != \".\" && $file != \"..\")\n\t{\n\t\t$file = str_replace(\".php\", \"\", $file);\n\t\t$adminlist[] = $file;\n\t}\n}\nclosedir($handle);\n\n$pref['membersonly_exceptions'] = implode(\"\\n\",$pref['membersonly_exceptions']);\n\n$text = \"\n<div id='core-prefs'>\n\t<form class='admin-menu' method='post' action='\".e_SELF.\"' autocomplete='off'>\n\t<input type='hidden' name='e-token' value='\".e_TOKEN.\"' />\n\t\t<fieldset id='core-prefs-main'>\n\t\t\t<legend>\".PRFLAN_1.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='sitename'>\".PRFLAN_2.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('sitename', $pref['sitename'], 100, 'required=1&size=xxlarge').\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='siteurl'>\".PRFLAN_3.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('siteurl', $pref['siteurl'], 150, 'size=xxlarge').\"\n\t\t\t\t\t\t\t\".($pref['siteurl'] == SITEURL ? \"\" : \"<div class='field-help'>\".PRFLAN_159.\": <strong>\".SITEURL.\"</strong></div>\").\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='redirectsiteurl'>\".PRFLAN_134.\"</label></td>\n\t\t\t\t\t\t<td>\";\n\t\t\t\t\t\t/*\n\t\t\t\t\t\t\t\".$frm->radio('redirectsiteurl', 1, $pref['redirectsiteurl'], array('label'=>LAN_ENABLED)).\" \n\t\t\t\t\t\t\t\".$frm->radio('redirectsiteurl', 0, !$pref['redirectsiteurl'], array('label'=>LAN_DISABLED)).\"\n\t\t\t\t\t\t*/\n\t\t\t\t\t\t$text .= $frm->radio_switch('redirectsiteurl', $pref['redirectsiteurl']).\"<div class='field-help'>\".PRFLAN_135.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='sitebutton'>\".PRFLAN_4.\"</label></td>\n\t\t\t\t\t\t<td>\n\";\n/*\n$parms = \"name=sitebutton\";\n$parms .= \"&path=\".e_THEME.$pref['sitetheme'].\"/images/|\".e_IMAGE;\n$parms .= \"&filter=0\";\n$parms .= \"&fullpath=1\";\n$parms .= \"&default=\".urlencode($pref['sitebutton']);\n//$parms .= \"&width=128px\";\n//$parms .= \"&height=128px\";\n$parms .= \"&multiple=FALSE\";\n$parms .= \"&label=-- No Image --\";\n$parms .= \"&subdirs=1\";\n$parms .= \"&tabindex=\".$frm->getNext();\n\n\n$text .= \"<div class='field-section'>\".$tp->parseTemplate(\"{IMAGESELECTOR={$parms}&scaction=select}\").\"</div>\";\n// $text .= \"<div class='field-section'>\".$frm->imagepicker('sitebutton',$pref['sitebutton'],'-- No Image --').\"</div>\";\n\n//TODO make the preview update when image-picker is used.\n$text .= \"<div class='field-spacer'>\".$tp->parseTemplate(\"{IMAGESELECTOR={$parms}&scaction=preview}\").\"</div>\";\n\n$sLogo = siteinfo_shortcodes::sc_logo();\n*/\n\nif(!empty($pref['sitebutton']) && strpos($pref['sitebutton'],'{')===false && file_exists(e_IMAGE.$pref['sitebutton']))\n{\n\t$pref['sitebutton'] = '{e_IMAGE}'.$pref['sitebutton'];\n}\n\n\n\n$text .= $frm->imagepicker('sitebutton',$pref['sitebutton'],'','help='.PRFLAN_225); //todo  use 'LegacyPath' option instead of code above.\n\n$text .= \"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='sitelogo'>\".PRFLAN_214.\"</label></td>\n\t\t\t\t\t\t<td>\".$frm->imagepicker('sitelogo',$pref['sitelogo'],'','w=200&help='.PRFLAN_226).\"</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='sitetag'>\".PRFLAN_5.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->textarea('sitetag', $tp->toForm($pref['sitetag']), 3, 59, array('size'=>'xxlarge')).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_227.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='sitedescription'>\".PRFLAN_6.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->textarea('sitedescription', $tp->toForm($pref['sitedescription']), 3, 80, array('size'=>'xxlarge')).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_228.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='sitedisclaimer'>\".PRFLAN_9.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->textarea('sitedisclaimer',$tp->toForm( $pref['sitedisclaimer']), 3, 80, array('size'=>'xxlarge')).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_229.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('main').\"\n\t\t</fieldset>\n\";\n\n\n// Email and Contact Information --------------\n\n$text .= \"<fieldset class='e-hideme' id='core-prefs-email'>\n\t\t\t<legend>\".PRFLAN_13.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t<tr>\n\t\t\t\t\t<td><label for='siteadmin'>\".PRFLAN_7.\"</label></td>\n\t\t\t\t\t<td>\n\t\t\t\t\t\t\".$frm->text('siteadmin', SITEADMIN, 100, array('size'=>'xlarge')).\"\n\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='siteadminemail'>\".PRFLAN_8.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('siteadminemail', SITEADMINEMAIL, 100, array('size'=>'xlarge')).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='replyto-name'>\".PRFLAN_174.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('replyto_name', $pref['replyto_name'], 100, array('size'=>'xlarge')).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_175.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='replyto-email'>\".PRFLAN_176.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('replyto_email', $pref['replyto_email'], 100, array('size'=>'xlarge')).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_177.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='testaddress'>\".LAN_MAILOUT_110.\"</label><br /></td>\n\t\t\t\t\t\t<td class='form-inline'>\".$frm->admin_button('testemail', LAN_MAILOUT_112,'other').\"&nbsp;\n\t\t\t\t\t\t\t<input name='testaddress' id='testaddress' class='tbox form-control input-xxlarge' placeholder='user@yoursite.com' type='text' size='40' maxlength='80' value=\\\"\".(varset($_POST['testaddress']) ? $_POST['testaddress'] : USEREMAIL).\"\\\" />\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td style='vertical-align:top'><label for='mailer'>\".PRFLAN_267.\"</label><br /></td>\n\t\t\t\t\t\t<td>\";\n\n\n\t\t\t\t$text .= mailoutAdminClass::mailerPrefsTable($pref);\n\n\n\t\t\t\t$text .=\"</td>\n\t\t\t\t</tr>\n\t\t\t\n\t\t\t\n\t\t\t\t<tr>\n\t\t\t\t\t<td><label for='mail-sendstyle'>\".LAN_MAILOUT_222.\"</label></td>\n\t\t\t\t\t<td>\";\n\t\t\t\t\t\n\t\t\t\t$emFormat = array(\n\t\t\t\t\t'textonly' => LAN_MAILOUT_125,\n\t\t\t\t\t'texthtml' => LAN_MAILOUT_126,\n\t\t\t\t\t'texttheme' => LAN_MAILOUT_127\n\t\t\t\t);\t\n\t\t\t\t$text .= $frm->select('mail_sendstyle', $emFormat, vartrue($pref['mail_sendstyle'])); \n\t\t\t\t$text .= \"\n\t\t\t\t\t</td>\n\t\t\t\t</tr>\n\t\t\t\t\t\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='sitecontactinfo'>\".PRFLAN_162.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->textarea('sitecontactinfo', $pref['sitecontactinfo'], 6, 59, array('size'=>'xxlarge')).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_163.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='sitecontacts'>\".PRFLAN_168.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$e_userclass->uc_dropdown('sitecontacts', $pref['sitecontacts'], 'nobody,main,admin,classes', \"tabindex='\".$frm->getNext().\"'\").\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_169.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='contact_visibility'>\".PRFLAN_258.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$e_userclass->uc_dropdown('contact_visibility', varset( $pref['contact_visibility'],e_UC_PUBLIC), null, \"tabindex='\".$frm->getNext().\"'\").\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_274.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='contact-filter'>\".PRFLAN_270.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->textarea('contact_filter', $pref['contact_filter'], 5, 59, array('size'=>'xxlarge')).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_271.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\n\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='contact-emailcopy'>\".PRFLAN_164.\"</label></td>\n\t\t\t\t\t\t<td>\";\n\t\t\t\t\t\t/*\n\t\t\t\t\t\t\t\".$frm->radio('contact_emailcopy', 1, $pref['contact_emailcopy']).\"\n\t\t\t\t\t\t\t\".$frm->label(LAN_ENABLED, 'contact_emailcopy', 1).\"&nbsp;&nbsp;\n\t\t\t\t\t\t\t\".$frm->radio('contact_emailcopy', 0, !$pref['contact_emailcopy']).\"\n\t\t\t\t\t\t\t\".$frm->label(LAN_DISABLED, 'contact_emailcopy', 0).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_165.\"</div>\n\t\t\t\t\t\t*/\n\t\t\t\t\t$text .= $frm->radio_switch('contact_emailcopy', $pref['contact_emailcopy']).\"<div class='smalltext field-help'>\".PRFLAN_165.\"</div>\n\n\n\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('email').\"\n\t\t</fieldset>\";\n\n\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-display'>\n\t\t\t<legend>\".PRFLAN_13.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='displaythemeinfo'>\".PRFLAN_14.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('displaythemeinfo', $pref['displaythemeinfo']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='displayrendertime'>\".PRFLAN_15.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('displayrendertime', $pref['displayrendertime']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='displaysql'>\".PRFLAN_16.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('displaysql', $pref['displaysql']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\";\nif(function_exists(\"memory_get_usage\"))\n{\n\t$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='display-memory-usage'>\".PRFLAN_137.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('display_memory_usage', $pref['display_memory_usage']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\";\n}\n$text .= \"\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('display').\"\n\t\t</fieldset>\n\";\n\n// Admin Display Areas\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-admindisp'>\n\t\t\t<legend>\".PRFLAN_77.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='admin-alerts-ok'>\".PRFLAN_95.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('admin_alerts_ok', $pref['admin_alerts_ok']).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_96.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='admin-alerts-uniquemenu'>\".PRFLAN_97.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('admin_alerts_uniquemenu', $pref['admin_alerts_uniquemenu']).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_98.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\";\n\t\t\t\t\t/*<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_199.\"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('admin_slidedown_subs', $pref['admin_slidedown_subs']).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_200.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>*/\n\t\t\t\t\t$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='admin-separate-plugins'>\".PRFLAN_204.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('admin_separate_plugins', $pref['admin_separate_plugins']).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_205.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('admindisp').\"\n\t\t</fieldset>\n\n\t\";\n\n// Date options.\n$ga = new convert();\n$date1 = $ga->convert_date(time(), \"short\");\n$date2 = $ga->convert_date(time(), \"long\");\n$date3 = $ga->convert_date(time(), \"forum\");\n$date4 = e107::getDate()->convert(time(),\"input\");\n\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-date'>\n\t\t\t<legend>\".PRFLAN_21.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='shortdate'>\".PRFLAN_22.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('shortdate', $pref['shortdate'], 50).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_83.\": {$date1}</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='longdate'>\".PRFLAN_23.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('longdate', $pref['longdate'], 50).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_83.\": {$date2}</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='forumdate'>\".PRFLAN_24.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('forumdate', $pref['forumdate'], 50).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_83.\": {$date3}</div>\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_25.\" <a href='http://www.php.net/manual/en/function.strftime.php' rel='external'>\".PRFLAN_93.\"</a></div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\";\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t$def = strtotime('December 21, 2012 3:45pm');\n\t\t\t\t\t\n\t\t\t\t\t$inputdate = array( // TODO add more formats\n\t\t\t\t\t\t\"%A, %d %B, %Y\"\t=> strftime(\"%A, %d %B, %Y\",$def),\n\t\t\t\t\t\t\"%A, %d %b, %Y\"\t=> strftime(\"%A, %d %b, %Y\",$def),\n\t\t\t\t\t\t\"%a, %d %B, %Y\"\t=> strftime(\"%a, %d %B, %Y\",$def),\n\t\t\t\t\t\t\"%a, %d %b, %Y\"\t=> strftime(\"%a, %d %b, %Y\",$def),\n\t\t\t\t\t\t\n\t\t\t\t\t\t\"%A, %B %d, %Y\"\t=> strftime(\"%A, %B %d, %Y\",$def),\n\t\t\t\t\t\t\"%A, %b %d, %Y\"\t=> strftime(\"%A, %b %d, %Y\",$def),\n\t\t\t\t\t\t\"%A, %b %d, %y\"\t=> strftime(\"%A, %b %d, %y\",$def),\n\t\t\t\t\t\t\n\t\t\t\t\t\t\"%B %d, %Y\"\t\t=> strftime(\"%B %d, %Y\",$def),\n\t\t\t\t\t\t\"%b %d, %Y\"\t\t=> strftime(\"%b %d, %Y\",$def),\n\t\t\t\t\t\t\"%b %d, %y\"\t\t=> strftime(\"%b %d, %y\",$def),\n\t\t\t\t\t\t\n\t\t\t\t\t\t\"%d %B, %Y\"\t\t=> strftime(\"%d %B, %Y\",$def),\n\t\t\t\t\t\t\"%d %b, %Y\"\t\t=> strftime(\"%d %b, %Y\",$def),\n\t\t\t\t\t\t\"%d %b, %y\"\t\t=> strftime(\"%d %b, %y\",$def),\n\t\t\t\t\t\t\n\t\t\t\t\t\t\"%Y-%m-%d\"\t\t=> strftime(\"%Y-%m-%d\",$def),\n\t\t\t\t\t\t\"%d-%m-%Y\"\t\t=> strftime(\"%d-%m-%Y\",$def),\n\t\t\t\t\t\t\"%m/%d/%Y\"\t\t=> strftime(\"%m/%d/%Y\",$def)\n\t\t\t\t\t);\n\t\t\t\t\t\n\t\t\t\n\t\t\t\t\t$inputtime = array();\n\t\t\t\t\t\n\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\t \n\t\t\t\t\t$inputtime[\"%I:%M %p\"]\t= strftime(\"%I:%M %p\",$def);\n\t\t\t\t\tif(e107::getDate()->supported('P'))\n\t\t\t\t\t{\t\n\t\t\t\t\t\t$inputtime[\"%I:%M %P\"]\t=  strftime(\"%I:%M %P\",$def);\n\t\t\t\t\t}\n\t\t\t\t\tif(e107::getDate()->supported('l'))\n\t\t\t\t\t{\n\t\t\t\t\t\t$inputtime[\"%l:%M %p\"]\t= strftime(\"%l:%M %p\",$def);\n\t\t\t\t\t\t$inputtime[\"%l:%M %P\"]\t= strftime(\"%l:%M %P\",$def);\t\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t$inputtime[\"%H:%M\"]\t\t= strftime(\"%H:%M\",$def);\n\t\t\t\t\t$inputtime[\"%H:%M:%S\"]\t= strftime(\"%H:%M:%S\",$def);\n\t\t\t\t\t\t\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t\n\n\t\t\t\t\t$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='inputdate'>\".PRFLAN_230.\"</label></td>\n\t\t\t\t\t\t<td class='form-inline'>\n\t\t\t\t\t\t\t\".$frm->select('inputdate',$inputdate, e107::getPref('inputdate'));\n\t\t\t\t\t\t\t\n\t\t\t\t\t$text .= $frm->select('inputtime',$inputtime, e107::getPref('inputtime'));\n\t\t\t\t\t\n\t\t\t\t\t$text .= \"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\";\n\n$timeZones = systemTimeZones();\n\n$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='timezone'>\".PRFLAN_56.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->select('timezone', $timeZones, vartrue($pref['timezone'], 'UTC'),'size=xlarge').\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('date').\"\n\t\t</fieldset>\n\";\n\n\n// =========== Registration Preferences. ==================\n\n\n\n$elements = array(1=> PRFLAN_259, 2=> PRFLAN_260, 0=>LAN_DISABLED); \n\n\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-registration'>\n\t\t\t<legend>\".PRFLAN_28.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='user-reg'>\".PRFLAN_224.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio('user_reg', $elements, $pref['user_reg']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_30.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='user-reg-veri'>\".PRFLAN_154.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->select_open('user_reg_veri', array('size'=>'xlarge'));\n                            $veri_list = array(PRFLAN_152,PRFLAN_31,PRFLAN_153);\n\n\t\t\t\t\t\t\tforeach($veri_list as $v => $v_title)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$text .= $frm->option($v_title, $v, ($pref['user_reg_veri'] == $v));\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t$srch = array('[', ']');\n\t\t\t\t\t$repl = array(\"<a href='\".e_ADMIN_ABS.\"notify.php'>\", '</a>');\n\n\t\t\t\t\t$PRFLAN_154a = str_replace($srch,$repl, PRFLAN_154a);\n\n\t\t\t\t\t$text .= \"\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<div class='field-help'>\".$PRFLAN_154a.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\t <tr>\n\t\t\t\t\t\t<td><label for='allowemaillogin'>\".PRFLAN_184.\"</label></td>\n\t\t\t\t\t\t<td>\".$frm->select_open('allowEmailLogin', array('size'=>'xlarge'));\n                     //   $login_list = array(PRFLAN_201,PRFLAN_202,PRFLAN_203);\n                        $login_list = array(\n\t                        2 => PRFLAN_203,\n\t                        1 => PRFLAN_202,\n\t                        0 => PRFLAN_201\n                        );\n                        foreach($login_list as $l => $l_title)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$text .= $frm->option($l_title, $l, ($pref['allowEmailLogin'] == $l));\n\t\t\t\t\t\t}\n\n\t\t\t\t\t$text .= \"\n\t\t\t\t\t\t\t</select></td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\";\n\n\t\t\t\t\t/*\n\t\t\t\t\t // Highly problematic.\n\t\t\t\t\t$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='signup-remote-emailcheck'>\".PRFLAN_160.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('signup_remote_emailcheck', $pref['signup_remote_emailcheck']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\";\n\n\t\t\t\t\t*/\n\t\t\t\t\t$membersOnlyRedirectOptions = array( 'login'=>PRFLAN_264, 'splash'=>PRFLAN_265);\n\n\t\t\t\t\t$text .= \"\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='membersonly-enabled'>\".PRFLAN_58.\"</label></td>\n\t\t\t\t\t\t<td>\";\n\t\t\t\t\t\n\t\t\t\t\t$memDisp = !vartrue($pref['membersonly_enabled']) ? \"e-hideme\" : \"\";\n\t\t\t\t\t\t\n\t\t\t\t\t$text .= $frm->radio_switch('membersonly_enabled', $pref['membersonly_enabled'],'', '', 'class=e-expandit').\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_59.\"</div>\n\t\t\t\t\t\t\t<div class='e-expandit-container {$memDisp}' style='padding-top:10px'>\n\t\t\t\t\t\t\t<div class='form-group clearfix'>\n\t\t\t\t\t\t\t\".\n\t\t\t\t\t\t\t$frm->select('membersonly_redirect',$membersOnlyRedirectOptions,$pref['membersonly_redirect'], array('size'=>'xxlarge')).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_266.\"</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class='form-group clearfix'>\".\n\t\t\t\t\t\t\t$frm->textarea('membersonly_exceptions', $pref['membersonly_exceptions'], 3, 1, 'size=xxlarge&placeholder='.PRFLAN_206).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_207.\"</div></div>\n\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n              \n               \t\t<tr>\n\t\t\t\t\t\t<td><label for='autologinpostsignup'>\".PRFLAN_197.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('autologinpostsignup', $pref['autologinpostsignup']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_198.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='displayname-maxlength'>\".PRFLAN_158.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('displayname_maxlength', $pref['displayname_maxlength'], 3).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='loginname-maxlength'>\".PRFLAN_172.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('loginname_maxlength', $pref['loginname_maxlength'], 3).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='signup-pass-len'>\".CUSTSIG_16.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('signup_pass_len', $pref['signup_pass_len'], 2).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='signup-maxip'>\".PRFLAN_136.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('signup_maxip', $pref['signup_maxip'], 3).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_78.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t\n\t\t\t\t\t</tbody>\n\t\t\t\t\t\n\n\t\t\t</table>\n\t\t\t\".pref_submit('registration').\"\n\t\t</fieldset>\n\n\t\";\n\t\n\n// Key registration \n\n\t\n\t\n\n// Signup options ===========================.\n\n$prefOptionPassword = (isset($pref['signup_option_password'])) ? $pref['signup_option_password'] : 2;\n\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-signup'>\n\t\t\t<legend>\".PRFLAN_19.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_261.\"</td><td><table class='table table-striped table-condensed table-bordered' style='margin-bottom:0px'>\n\t\t\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td><label>Email</label></td>\n\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\".$frm->radio('disable_emailcheck', 2, ($pref['disable_emailcheck']==2), array('label' => CUSTSIG_12, 'disabled'=>true)).\"\n\t\t\t\t\t\t\t\t\".$frm->radio('disable_emailcheck', 1, (intval($pref['disable_emailcheck']) == 1), array('label' => CUSTSIG_14)).\"\n\t\t\t\t\t\t\t\t\".$frm->radio('disable_emailcheck', 0, (intval($pref['disable_emailcheck']) == 0), array('label' => CUSTSIG_15)).\"\n\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td><label for='signup-option-password'>\".LAN_PASSWORD.\"</label></td>\n\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\".$frm->radio('signup_option_password', 0, !$prefOptionPassword, array('label' => CUSTSIG_12)).\"\n\t\t\t\t\t\t\t\t\".$frm->radio('signup_option_password', 1, ($prefOptionPassword == 1), array('label' => CUSTSIG_14, 'disabled'=>true)).\"\n\t\t\t\t\t\t\t\t\".$frm->radio('signup_option_password', 2, ($prefOptionPassword == 2), array('label' => CUSTSIG_15)).\"\n\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t</tr>\n\n\n\t\t\t\t\t\t\";\n\t\t\t\t\n\t\t$signup_option_names = array(\n\t\t//\t\"signup_option_loginname\" \t=> \"Login Name\",\n\n\t\t\"signup_option_realname\" \t\t=> CUSTSIG_2,\n\t\t\"signup_option_email_confirm\" \t=> CUSTSIG_21,\n\t\t\"signup_option_image\" \t\t\t=> CUSTSIG_7,\n\n\t\t'signup_option_customtitle'\t\t=> CUSTSIG_20,\n\t\t'signup_option_hideemail'\t\t=> CUSTSIG_22,\n\t\t\"signup_option_class\" \t\t\t=> CUSTSIG_17,\n\t\t\"signup_option_signature\" \t\t=> CUSTSIG_6,\n\t);\n\n\n\tforeach($signup_option_names as $value => $key)\n\t{\n\t\t$label_value = str_replace('_', '-', $value);\n\t\t$text .= \"\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td><label for='\".$label_value.\"'>\".$key.\"</label></td>\n\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\".$frm->radio($value, 0, !$pref[$value], array('label' => CUSTSIG_12)).\"\n\t\t\t\t\t\t\t\t\".$frm->radio($value, 1, ($pref[$value] == 1), array('label' => CUSTSIG_14)).\"\n\t\t\t\t\t\t\t\t\".$frm->radio($value, 2, ($pref[$value] == 2), array('label' => CUSTSIG_15)).\"\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t</tr>\n\t\t\";\n\t}\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t$text .= \"\n\n\n\t<tr>\n\t\t\t\t\t\t<td><label for='user-reg-secureveri'>\".PRFLAN_262.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('user_reg_secureveri', $pref['user_reg_secureveri'], CUSTSIG_12, CUSTSIG_14).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\n\n</table>\n\t\t\t\t\t\t</td></tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='use-coppa'>\".PRFLAN_45.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('use_coppa', $pref['use_coppa']).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_46.\" <a href='http://www.ftc.gov/privacy/coppafaqs.shtm' rel='external'>\".PRFLAN_94.\"</a></div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\";\n\n/*\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='disable-emailcheck'>\".PRFLAN_167.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\". $pref['disable_emailcheck'].\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>*/\n\n$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='signup-text'>\".PRFLAN_126.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->textarea('signup_text', $pref['signup_text'], 3, 80, array('size'=>'xxlarge')).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='signup-text-after'>\".PRFLAN_140.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->textarea('signup_text_after', $pref['signup_text_after'], 3, 80, array('size'=>'xxlarge')).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='predefinedloginname'>\".PRFLAN_192.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('predefinedLoginName', $pref['predefinedLoginName'], 50).\"\n\t\t\t\t\t\t\t<div class='field-help'><div style='text-align:left'>\".PRFLAN_193.\"<br />\".str_replace(\"[br]\",\"<br /> \",PRFLAN_194).\"</div></div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\n\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='signup-disallow-text'>\".CUSTSIG_18.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->tags('signup_disallow_text', $pref['signup_disallow_text'], 500).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".CUSTSIG_19.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='displayname_class'>\".PRFLAN_155.\":</label></td>\n\t\t\t\t\t\t<td class='form-inline'>\n\t\t\t\t\t\t\t\".$e_userclass->uc_dropdown('displayname_class', $pref['displayname_class'], 'nobody,member,admin,classes', \"tabindex='\".$frm->getNext().\"'\").\"\n\t\t\t\t\t\t\t\".$frm->admin_button('submit_resetdisplaynames', PRFLAN_156, 'delete').\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\n\n\n\";\n\n/*\n\t\t\t\t\t<!--\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".CUSTSIG_13.\"</td>\n\t\t\t\t\t\t<td>\".CUSTSIG_14.\"</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t-->\n*/\n\n\n\n$text .= \"\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('signup').\"\n\t\t</fieldset>\n\";\n\n// Custom Fields.\n\n\n/* text render options */\n\nif(!isset($pref['post_html']))\n{\n\t$pref['post_html'] = '250';\n\tsave_prefs();\n}\n\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-textpost'>\n\t\t\t<legend>\".PRFLAN_101.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='make-clickable'>\".PRFLAN_127.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('make_clickable', $pref['make_clickable']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_128.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\";\n\t\t\t\t\t\n\t\t\t\t$replaceDisp = vartrue($pref['link_replace']) ? \"\" : \"e-hideme\";\n\t\t\t\t\n\t\t\t\t$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='link-replace'>\".PRFLAN_102.\"?:</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('link_replace', $pref['link_replace'],'', '', 'expandit=1').\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_103.\"</div>\n\t\t\t\t\t\t\t<div class='e-expandit-container {$replaceDisp}'>\n\t\t\t\t\t\t\t\".$frm->text('link_text', $pref['link_text'], 200, 'placeholder='.PRFLAN_104).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_105.\"</div>\".\n\t\t\t\t\t\t\t$frm->text('email_text', $tp->post_toForm($pref['email_text']), 200, 'placeholder='.PRFLAN_107).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_108.\"</div>\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\n\t\t\t\t\t<tr >\n\t\t\t\t\t\t<td><label for='links-new-window'>\".PRFLAN_145.\"?:</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('links_new_window', $pref['links_new_window']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_146.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='profanity-filter'>\".PRFLAN_40.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('profanity_filter', $pref['profanity_filter']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_41.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='profanity-replace'>\".PRFLAN_42.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('profanity_replace', $pref['profanity_replace'], 20).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='profanity-words'>\".PRFLAN_43.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->tags('profanity_words', $pref['profanity_words']).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_44.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='main-wordwrap'>\".PRFLAN_109.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('main_wordwrap', $pref['main_wordwrap'], 3).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_110.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='menu-wordwrap'>\".PRFLAN_111.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('menu_wordwrap', $pref['menu_wordwrap'], 3).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_110.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='post-html'>\".PRFLAN_116.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$e_userclass->uc_dropdown('post_html', $pref['post_html'], 'nobody,public,member,admin,main,classes', \"tabindex='\".$frm->getNext().\"'\").\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_117.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='post-script'>\".PRFLAN_215.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".r_userclass('post_script',$pref['post_script'],'off','nobody,member,admin,main,classes').\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_216.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='inline-editing'>\".PRFLAN_268.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->userclass('inline_editing',$pref['inline_editing'],'off','nobody,admin,main,classes,no-excludes').\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_269.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='filter-script'>\".PRFLAN_217.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('filter_script', varset($pref['filter_script'], 1)).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_218.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='html-abuse'>\".PRFLAN_220.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('html_abuse', varset($pref['html_abuse'], 1)).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_221.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='wysiwyg'>\".PRFLAN_122.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('wysiwyg', $pref['wysiwyg']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_123.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='old_np'>\".PRFLAN_124.\":</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('old_np', $pref['old_np']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_125.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\";\n\nif(file_exists(e_PLUGIN.\"geshi/geshi.php\"))\n{\n\t$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='usegeshi'>\".PRFLAN_118.\"?:</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('useGeshi', $pref['useGeshi']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".str_replace(\"[link]\", \"http://qbnz.com/highlighter/\", PRFLAN_119).\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='defaultlangeshi'>\".PRFLAN_120.\"?:</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->text('defaultLanGeshi', ($pref['defaultLanGeshi'] ? $pref['defaultLanGeshi'] : \"php\"), 20).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_121.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\";\n}\n$text .= \"\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('textpost').\"\n\t\t</fieldset>\n\";\n\nfunction multi_radio($name, $textsVals, $currentval = '')\n{\n\t$ret = '';\n\t$gap = '';\n\tforeach($textsVals as $v => $t)\n\t{\n\t\t$sel = ($v == $currentval) ? \" checked='checked'\" : \"\";\n\t\t$ret .= $gap.\"<input type='radio' name='{$name}' value='{$v}'{$sel} /> \".$t.\"\";\n\t\t$gap = \"&nbsp;&nbsp;\";\n\t}\n\treturn $ret;\n}\n\n// Security Options. .\n$hasGD = extension_loaded(\"gd\");\n\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-security'>\n\t\t\t<legend>\".PRFLAN_47.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\";\n\n\tif(!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != 'off')     // Only allow if an SSL login has been made.\n\t{\n\t\t$text .=\"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='ssl-enabled'>\".PRFLAN_60.\"</label></td>\n\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('ssl_enabled', $pref['ssl_enabled']).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_61.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\";\n\t}\n\t// Secure Image/ Captcha\n\t$secureImage = array('signcode'=>PRFLAN_76, 'logcode'=>PRFLAN_81, \"fpwcode\"=>PRFLAN_138,'admincode'=>PRFLAN_222);\n\t\n\tforeach($secureImage as $key=>$label)\n\t{\n\t\t\n\t\t$label = str_replace($srch,$repl,$label);\n\t\t\n\t\t$text .= \"<tr><td><label for='\".$key.\"'>\".$label.\"</label></td><td>\";\t\n\t\tif($hasGD)\n\t\t{\n\t\t\t$text .= $frm->radio_switch($key, $pref[$key]);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$text .= PRFLAN_133;\n\t\t}\n\t\t\n\t\t$text .= \"\n\t\t<div class='field-help'>\".PRFLAN_223.\"</div>\n\t\t</td></tr>\\n\";\n\t\t\n\t}\n\n\n/*\n\n\n\t\t\t\t\t\n\t$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_81.\": </td>\n\t\t\t\t\t\t<td>\n\";\n\nif($hasGD)\n{\n\t$text .= $frm->radio_switch('logcode', $pref['logcode']);\n}\nelse\n{\n\t$text .= PRFLAN_133;\n}\n$text .= \"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_138.\": </td>\n\t\t\t\t\t\t<td>\n\";\nif($hasGD)\n{\n\t$text .= $frm->radio_switch('fpwcode', $pref['fpwcode']);\n}\nelse\n{\n\t$text .= PRFLAN_133;\n}\n\n$text .= \"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\";\n * \n \n */\n$text .= \"\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='disallowmultilogin'>\".PRFLAN_129.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('disallowMultiLogin', $pref['disallowMultiLogin'], LAN_YES, LAN_NO).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_130.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='user-tracking-cookie'>\".PRFLAN_48.\"</label></td>\n\t\t\t\t\t\t<td >\n\t\t\t\t\t\t\t<div class='form-inline'>\n\t\t\t\t\t\t\t\".$frm->radio('user_tracking', array('cookie' => PRFLAN_49, 'session' => PRFLAN_50), $pref['user_tracking']).\"\n\t\t\t\t\t\t</div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='cookie-name'>\".PRFLAN_55.\"</label></td>\n\t\t\t\t\t\t<td >\".$frm->text('cookie_name', $pref['cookie_name'], 20).\"\n\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_263.\".</div></td></tr>\n\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='session-lifetime'>\".PRFLAN_272.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('session_lifetime', $pref['session_lifetime'],6).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_273.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='passwordencoding'>\".PRFLAN_188.\":</label></td>\n\n\t\t\t\t\t\t\t\";\n\n\t\t\t\t\t\t$pwdEncodeOpts = array();\n\n\t\t\t\t\t\tif(function_exists('password_verify')) // ie. php 5.5 or higher\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$pwdEncodeOpts[3]\t = \"PHP Default (Preferred)\";\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t$pwdEncodeOpts[1] = PRFLAN_190;\n\t\t\t\t\t\t$pwdEncodeOpts[0] = PRFLAN_189;\n\n\t\t\t\t\t\t$text .= (isset($pwdEncodeOpts[3]) && $pref['passwordEncoding']!=3) ? \"<td class='has-warning'>\" : \"<td>\";\n\t\t\t\t\t\t$text .= $frm->select('passwordEncoding', $pwdEncodeOpts,  varset($pref['passwordEncoding'], 0));\n\n\t\t\t\t//\t$text .= $frm->radio_switch('passwordEncoding', varset($pref['passwordEncoding'], 0), PRFLAN_190, PRFLAN_189);\n\n\t\t\t\t\t\t$text .= \"\n\t\t\t\t\t\t\t<div class='smalltext field-help'></div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\";\n\t\t\t\t\t\n\t\t\t\t\t$CHAP_list = array(PRFLAN_180, PRFLAN_181, PRFLAN_182);\n\t\n\t\t\t\t\t$text .= \"\n\t\t\t\t\t\t<td><label for='password-chap'>\".PRFLAN_178.\"</label></td>\n\t\t\t\t\t\t<td>\".$frm->select('password_CHAP',$CHAP_list,$pref['password_CHAP'] );\n\t\t\t\t\t\t//.\"\t\".$frm->select_open('password_CHAP');\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t//TODO - user tracking session name - visible only if Cookie is enabled (JS)\n\n\t\t\t\t\t\t$text .= \"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_183.\"<br />\".PRFLAN_179.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='antiflood1'>\".PRFLAN_35.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('antiflood1', $pref['antiflood1']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='antiflood-timeout'>\".PRFLAN_36.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('antiflood_timeout', $pref['antiflood_timeout'], 3).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_38.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='autoban'>\".PRFLAN_37.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->select_open('autoban');\n\n$autoban_list = array(\n\tPRFLAN_113,\n\tPRFLAN_144,\n\tPRFLAN_142,\n\tPRFLAN_143\n);\n\nforeach($autoban_list as $ab => $ab_title)\n{\n\t$sel = ($pref['autoban'] == $ab) ? \"selected='selected'\" : \"\";\n\t$text .= \"\n\t\t\t\t\t\t\t\t\".$frm->option($ab_title, $ab, ($pref['autoban'] == $ab)).\"\n\t\";\n}\n\n$text .= \"\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_91.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='failed-login-limit'>\".PRFLAN_231.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->number('failed_login_limit', varset($pref['failed_login_limit'],10), 3, array('max'=>10, 'min'=>0)).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_232.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><label for='adminpwordchange'>\".PRFLAN_139.\"</label></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('adminpwordchange', $pref['adminpwordchange']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('security').\"\n\t\t</fieldset>\n\";\n\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-comments'>\n\t\t\t<legend>\".PRFLAN_87.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_161.\":</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('comments_disabled', $pref['comments_disabled'], LAN_NO, LAN_YES,array('reverse'=>1)).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n             \t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_32.\"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('anon_post', $pref['anon_post'], LAN_YES, LAN_NO).\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_33.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_89.\": </td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('comments_icon', $pref['comments_icon'], LAN_YES, LAN_NO).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_88.\": </td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('nested_comments', $pref['nested_comments'], LAN_YES, LAN_NO).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_90.\": </td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('allowCommentEdit', $pref['allowCommentEdit'], LAN_YES, LAN_NO).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_166.\": </td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('comments_emoticons', $pref['comments_emoticons'], LAN_YES, LAN_NO).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_233.\"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t$frm->uc_select('comments_moderate', $pref['comments_moderate'],\"nobody,guest,new,bots,public,admin,main,classes\").\n\t\t\t\t\t\t\t\"\n\t\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_234.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_235.\"</td>\n\t\t\t\t\t\t<td>\";\n\t\t\t\t\t\t\n\t\t\t\t\t\t$comment_sort = array(\n\t\t\t\t\t\t\t\"desc\"\t=> PRFLAN_236, //default\n\t\t\t\t\t\t\t'asc'\t=> PRFLAN_237\n\t\t\t\t\t\t);\n\t\t\t\t\t\n\t\t\t\t\t$text .= $frm->select('comments_sort',$comment_sort, $pref['comments_moderate'], array('size'=>'xlarge')).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t\n\t\t\t\t</tbody>\n\t\t\t</table>\n\n\t\t\t<legend>\".PRFLAN_209.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_208.\":</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$e_userclass->uc_dropdown('email_item_class',varset($pref['email_item_class'],e_UC_MEMBER),'nobody,admin,main,public,member,classes', \"tabindex='\".$frm->getNext().\"'\").\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('comments').\"\n\t\t</fieldset>\n\t\";\n\t\n// File Uploads\n\n\te107::includeLan(e_LANGUAGEDIR.e_LANGUAGE.\"/admin/lan_upload.php\");\n\trequire_once(e_HANDLER.\"upload_handler.php\"); \n\t\n\t\n\t\n\t\n\t\n\t\n\t$text .= \"\n\t<fieldset class='e-hideme' id='core-prefs-uploads'>\n\t\t\t<legend>\".PRFLAN_238.\"</legend>\";\n\t\n\t\n\t$upload_max_filesize = ini_get('upload_max_filesize');\n\t$post_max_size = ini_get('post_max_size');\n\t\n\t$maxINI = min($upload_max_filesize,$post_max_size); \n\t\n\tif($maxINI < $pref['upload_maxfilesize'])\n\t{\n\t\t$text .= \"<div class='alert-block alert alert-danger'>\";\n\t\t$text .= PRFLAN_239.\" \".$maxINI.\"</div>\";\n\t\t$pref['upload_maxfilesize'] = $maxINI;\n\t}\n\t\n\t\n\t\n\t\t\t\n\t$text .= \"\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t<tr>\n\t<td>\".UPLLAN_25.\"</td>\n\t<td>\".\n\t\n\t$frm->radio_switch('upload_enabled', $pref['upload_enabled'])\n\t.\"\n\t<div class='field-help'>\".UPLLAN_26.\"</div>\n\t</td>\n\t</tr>\n\n\t<tr>\n\t<td>\".UPLLAN_33.\"<br />\n\t</td>\n\t<td>\".\n\t$frm->text('upload_maxfilesize', $pref['upload_maxfilesize'], 10)\n\t .\"\n\t <div class='field-help'>\".UPLLAN_34.\"</div>\n\t</td>\n\t</tr>\n\n\t<tr>\n\t<td>\".UPLLAN_37.\"</td>\n\t<td>\".r_userclass(\"upload_class\", $pref['upload_class'],\"off\",\"nobody,public,guest,member,admin,classes\").\"\n\t<div class='field-help'>\".UPLLAN_38.\"</div>\n\t</td>\n\t</tr>\n\t<tr><td>\".PRFLAN_240.\"</td>\n\t<td>\n\n\t<table class='table table-striped table-bordered'>\n\t<tr><th>\".LAN_TYPE.\"</th><th>\".UPLLAN_33.\"</th>\n\t\";\n\t\n\t$fl = e107::getFile();\n\t$data = $fl->getFiletypeLimits(); \n\t \n\tforeach($data as $k=>$v)\n\t{\n\t\t$text .= \"<tr><td>\".$k.\"</td>\n\t\t<td>\".$fl->file_size_encode($v).\"</td>\n\t\t</tr>\";\t\n\t\t\n\t\t\n\t}\n//\t$text .= print_a($data,true); \n\t\n\n\t\n\t$text .= \"</table>\n\t\n\t<div>\".PRFLAN_241.\" <b>\".str_replace(\"../\",'',e_SYSTEM).e_READ_FILETYPES.\"</b></div>\n\t</td>\n\t\n\t\n\t</tbody>\n\t\t</table>\n\t\t\t\".pref_submit('uploads');\n\t\t\t\n\t\t\t\n\t\t\t\n\t$text .= \"\n\t\t</fieldset>\";\n\n\n$text .= \"<fieldset class='e-hideme' id='core-prefs-javascript'>\";\n\nif(E107_DEBUG_LEVEL > 0)\n{\n\t// TODO - remove these old JS settings completely!\n\n\t// Javascript Control\n\t$text .= \"\n\t\t\t<legend>\" . PRFLAN_242 . \"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\";\n\n\t$js_options = array(\n\t\t'auto'  => PRFLAN_243, // load based on dependency\n\t\t'admin' => PRFLAN_244, // Always load in admin\n\t\t'front' => PRFLAN_245, // Always load in front-end\n\t\t'all'   => PRFLAN_246, // Always load in admin and front-end\n\t\t'none'  => PRFLAN_247  // disabled\n\t);\n\n\t$js_types = array(\n\t\tarray('id' => 'jquery', 'name' => 'jQuery (local)'),\n\t\tarray('id' => 'prototype', 'name' => 'Prototype (local)'),\n\t);\n\n\tforeach($js_types as $arr)\n\t{\n\t\t// $k = $arr['path'];\n\t\t$k = $arr['id'];\n\t\t$name = $arr['name'];\n\t\t$text .= \"<tr>\n\t\t\t\t<td>\" . $name . \"</td>\n\t\t\t\t<td>\" . $frm->radio(\"e_jslib_core[{$k}]\", $js_options, $pref['e_jslib_core'][$k]) . \"</td>\n\t\t\t\t</tr>\";\n\t}\n\n\t$text .= \"\n\t\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t<table class='table adminform' style='margin-top: 20px'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<thead>\n\t\t\t\t\t<tr><th colspan='2'><span class='label label-warning'>DEPRECATED</span> Available only in DEBUG mode</th></tr>\n\t\t\t\t</thead>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\" . PRFLAN_248 . \"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\" . $frm->radio_switch('e_jslib_nocombine', $pref['e_jslib_nocombine'], LAN_YES, LAN_NO) . \"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\" . PRFLAN_249 . \"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\" . PRFLAN_250 . \"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\" . $frm->radio_switch('e_jslib_gzip', $pref['e_jslib_gzip'], LAN_YES, LAN_NO) . \"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\" . PRFLAN_251 . \"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\" . PRFLAN_252 . \"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\" . $frm->radio_switch('e_jslib_nocache', $pref['e_jslib_nocache'], LAN_YES, LAN_NO) . \"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\" . PRFLAN_251 . \"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\" . PRFLAN_253 . \"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\" . $frm->radio_switch('e_jslib_nobcache', $pref['e_jslib_nobcache'], LAN_YES, LAN_NO) . \"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\" . PRFLAN_251 . \"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\";\n\n\t$text .= \"</tbody></table>\";\n}\nelse\n{\n\t$text .= \"<div>\";\n\t$text .= $frm->hidden('e_jslib_core[jquery]', 'all');\n\t$text .= $frm->hidden('e_jslib_core[prototype]', 'none');\n\t$text .= $frm->hidden('e_jslib_nocombine', 1);\n\t$text .= $frm->hidden('e_jslib_nocache', 1);\n\t$text .= $frm->hidden('e_jslib_nobcache', 1);\n\t$text .= $frm->hidden('e_jslib_gzip', 0);\n\t$text .= \"</div>\";\n}\n\n/**\n * @addtogroup CDN settings\n * @{\n */\n\n// [e_LANGUAGEDIR]/[e_LANGUAGE]/lan_library_manager.php\ne107::lan('core', 'library_manager');\n\n$CDNproviders = array(\n\t'jsdelivr' => 'jsDelivr',\n\t'cdnjs' => 'cdnjs',\n);\n\n$text .= '\n<h4 class=\"caption\">' . LAN_LIBRARY_MANAGER_30 . '</h4>\n<table class=\"table adminform\">\n\t<colgroup>\n\t\t<col class=\"col-label\"/>\n\t\t<col class=\"col-control\"/>\n\t</colgroup>\n\t<tbody>\n\t\t<tr>\n\t\t\t<td>' . LAN_LIBRARY_MANAGER_31 . '</td>\n\t\t\t<td>\n\t\t\t\t' . $frm->radio(\"e_jslib_cdn\", array(1 => LAN_YES, 0 => LAN_NO), varset($pref['e_jslib_cdn'], 1)) . '\n\t\t\t</td>\n\t\t</tr>\n\t\t<tr>\n\t\t\t<td>' . LAN_LIBRARY_MANAGER_32 . '</td>\n\t\t\t<td>\n\t\t\t\t' . $frm->select(\"e_jslib_cdn_provider\", $CDNproviders, varset($pref['e_jslib_cdn_provider'], 'jsdelivr')) . '\n\t\t\t</td>\n\t\t</tr>\n\t</tbody>\n</table>\n';\n\n// Submit button.\n$text .= pref_submit('javascript');\n\n/**\n * @} End of \"addtogroup CDN settings\".\n */\n\n\n/**\n * @addtogroup Third-party libraries\n * @{\n */\n\n$text .= '<h4 class=\"caption\">' . LAN_LIBRARY_MANAGER_25 . '</h4>';\n$text .= '<table width=\"100%\" class=\"table table-striped\" cellpadding=\"0\" cellspacing=\"0\">';\n$text .= '<thead>';\n$text .= '<tr>';\n$text .= '<th>' . LAN_LIBRARY_MANAGER_13 . '</th>';\n$text .= '<th class=\"text-center\">' . LAN_LIBRARY_MANAGER_21 . '</th>';\n$text .= '<th>' . LAN_LIBRARY_MANAGER_29 . '</th>';\n$text .= '<th class=\"text-center\">' . LAN_VERSION . '</th>';\n$text .= '<th class=\"text-center\">' . LAN_STATUS . '</th>';\n$text .= '<th>' . LAN_MESSAGE . '</th>';\n$text .= '<th>' . LAN_MOREINFO . '</th>';\n$text .= '</tr>';\n$text .= '</thead>';\n$text .= '<tbody>';\n\n$libraries = e107::library('info');\nforeach($libraries as $machineName => $library)\n{\n\t$details = e107::library('detect', $machineName);\n\n\tif(empty($details['name']))\n\t{\n\t\tcontinue;\n\t}\n\n\t$name = libraryGetName($machineName, $details);\n\t$provider = libraryGetProvider($details);\n\t$status = libraryGetStatus($details);\n\t$links = libraryGetLinks($details);\n\n\t$text .= '<tr>';\n\t$text .= '<td>' . $name . '</td>';\n\t$text .= '<td class=\"text-center\">' . $provider . '</td>';\n\t$text .= '<td class=\"smalltext\">' . varset($details['library_path']) . '</td>';\n\t$text .= '<td class=\"text-center\">' . varset($details['version']) . '</td>';\n\t$text .= '<td class=\"text-center\">' . $status . '</td>';\n\t$text .= '<td>' . varset($details['error_message']) . '</td>';\n\t$text .= '<td>' . $links . '</td>';\n\t$text .= '</tr>';\n}\n\nif(empty($libraries))\n{\n\t$text .= '<tr>';\n\t$text .= '<td colspan=\"6\">' . LAN_NOT_FOUND . '</td>';\n\t$text .= '</tr>';\n}\n\n$text .= '</tbody>';\n$text .= '</table>';\n$text .= \"</fieldset>\";\n\n/**\n * @} End of \"addtogroup Third-party libraries\".\n */\n\n\n/**\n * @addtogroup Advanced Features\n * @{\n */\n\n$text .= \"\n\t\t<fieldset class='e-hideme' id='core-prefs-advanced'>\n\t\t\t<legend>\".PRFLAN_149.\"</legend>\n\t\t\t<table class='table adminform'>\n\t\t\t\t<colgroup>\n\t\t\t\t\t<col class='col-label' />\n\t\t\t\t\t<col class='col-control' />\n\t\t\t\t</colgroup>\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_147.\":</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('developer', $pref['developer']).\"\n\t\t\t\t\t\t\t<div class='smalltext field-help'>\".PRFLAN_148.\"</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_196.\"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\".$frm->radio_switch('log_page_accesses', $pref['log_page_accesses']).\"\n\t\t\t\t\t\t<div class='field-help'>\".PRFLAN_196a.\" <strong>\".e_LOG.\"</strong></div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_17.\"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('compress_output', $pref['compress_output']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\";\n\n$auth_dropdown = '';\nif($authlist)\n{\n\t$auth_dropdown = \"\\n\".$frm->select_open('auth_method').\"\\n\";\n\tforeach($authlist as $a)\n\t{\n\t\t$auth_dropdown .= $frm->option($a, $a, ($pref['auth_method'] == $a)).\"\\n\";\n\t}\n\t$auth_dropdown .= \"</select>\\n\";\n}\nelse\n{\n\t$auth_dropdown = \"<input type='hidden' name='auth_method' value='' />\".PRFLAN_151;\n\t$pref['auth_method'] = \"\";\n}\n\n$text .= \"\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_150.\"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t{$auth_dropdown}\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>\".PRFLAN_173.\"</td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\".$frm->radio_switch('check_updates', $pref['check_updates']).\"\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t\".pref_submit('advanced').\"\n\t\t</fieldset>\n\t\";\n\n/**\n * @} End of \"addtogroup Advanced Features\".\n */\n\n\n$text .= \"\n\t</form>\n</div>\n\";\n\n$ns->tablerender(PRFLAN_53, $mes->render().$text);\n\nrequire_once(e_ADMIN.\"footer.php\");\n\nfunction pref_submit($post_id = '')\n{\n\tglobal $frm;\n\tif($post_id) $post_id = '-'.$post_id;\n\t$text = \"\n\t\t<div class='buttons-bar center'>\";\n\n\t// ML\n\t/* if(e_MLANG == 1){\n\t//$text .=\"<input class='fcaption' type='submit' name='updateprefs' value='\".PRFLAN_52.\"' />\n\t$but_typ = array(\"\"); // empty = submit\n\t$but_nam = array(\"updateprefs\"); // empty = autobutX with X autoincrement\n\t$but_val = array(\"updateprefs\"); // empty = Submit\n\t$but_class = array(\"caption\"); // empty = button\n\t$butjs = array(\"\"); // empty = \"\"\n\t$buttitle = array(\"\"); // empty = \"\"\n\t$text .= e107ml_adpanel(1,$but_typ,$but_nam,$but_val,$but_class,$butjs,$buttitle);\n\t}else{*/\n\t$text .= $frm->admin_button('updateprefs', PRFLAN_52, 'update', '', \"id=updateprefs{$post_id}\");\n\t// }\n\t$text .= \"\\n</div>\";\n\n\t// END ML\n\treturn $text;\n}\n\nfunction prefs_adminmenu()\n{\n\t$var['core-prefs-main']['text'] = PRFLAN_1;\n\t$var['core-prefs-email']['text'] = PRFLAN_254;\n\t$var['core-prefs-registration']['text'] = PRFLAN_28;\n\t$var['core-prefs-signup']['text'] = PRFLAN_19;\n//\t$var['core-prefs-sociallogin']['text'] = \"Social Options\"; // Moved into plugin.\n\t\n\t$var['core-prefs-comments']['text'] = PRFLAN_210;\n\t$var['core-prefs-uploads']['text'] = PRFLAN_255;\n\t\n\t$var['core-prefs-header1']['header'] = PRFLAN_256;\n\t\n\t$var['core-prefs-display']['text'] = PRFLAN_13;\n\t$var['core-prefs-admindisp']['text'] = PRFLAN_77;\n\t$var['core-prefs-textpost']['text'] = PRFLAN_101;\n\t$var['core-prefs-security']['text'] = PRFLAN_47;\n\t$var['core-prefs-date']['text'] = PRFLAN_21;\t\n\t$var['core-prefs-javascript']['text'] = PRFLAN_257;\n\t$var['core-prefs-advanced']['text'] = PRFLAN_149;\n\t\n\te107::getNav()->admin(LAN_BASIC_OPTIONS.'--id--prev_nav', 'core-prefs-main', $var);\n}\n\n/**\n * @addtogroup Third-party libraries\n * @{\n */\n\n/**\n * Helper function to get library's name.\n */\nfunction libraryGetName($machineName, $details)\n{\n\t$text = e107::getParser()->lanVars(LAN_LIBRARY_MANAGER_27, array($machineName));\n\treturn '<span data-toggle=\"tooltip\" data-placement=\"top\" title=\"' . $text . '\">' . $details['name'] . '</span>';\n}\n\n/**\n * Helper function to get links.\n */\nfunction libraryGetLinks($details)\n{\n\t$homepage = libraryGetHomepage($details);\n\t$download = libraryGetDownload($details);\n\n\tif ($homepage && $download)\n\t{\n\t\treturn $homepage . ' | ' . $download;\n\t}\n\n\tif($homepage)\n\t{\n\t\treturn $homepage;\n\t}\n\n\tif($download)\n\t{\n\t\treturn $download;\n\t}\n}\n\n/**\n * Helper function to get homepage link.\n */\nfunction libraryGetHomepage($details)\n{\n\tif (empty($details['vendor_url']))\n\t{\n\t\treturn false;\n\t}\n\n\t$href = $details['vendor_url'];\n\t$title = $details['name'];\n\n\treturn '<a href=\"' . $href . '\" title=\"' . $title . '\" target=\"_blank\">' . LAN_WEBSITE . '</a>';\n}\n\n/**\n * Helper function to get download link.\n */\nfunction libraryGetDownload($details)\n{\n\tif (empty($details['download_url']))\n\t{\n\t\treturn false;\n\t}\n\n\t$href = $details['download_url'];\n\t$title = $details['name'];\n\n\treturn '<a href=\"' . $href . '\" title=\"' . $title . '\" target=\"_blank\">' . LAN_DOWNLOAD . '</a>';\n}\n\n/**\n * Helper function to get provider.\n */\nfunction libraryGetProvider($details)\n{\n\t$text = 'e107';\n\t$provider = LAN_CORE;\n\n\tif(varset($details['plugin'], false) == true)\n\t{\n\t\t$text = $details['plugin'];\n\t\t$provider = LAN_PLUGIN;\n\t}\n\n\tif(varset($details['theme'], false) == true)\n\t{\n\t\t$text = $details['theme'];\n\t\t$provider = LAN_THEME;\n\t}\n\n\treturn '<span data-toggle=\"tooltip\" data-placement=\"top\" title=\"' . $text . '\">' . $provider . '</span>';\n}\n\n/**\n * Helper function to get status.\n */\nfunction libraryGetStatus($details)\n{\n\t$tp = e107::getParser();\n\n\tif($details['installed'] == true)\n\t{\n\t\t$icon = $tp->toGlyph('glyphicon-ok');\n\t\t$text = LAN_OK;\n\t\treturn '<span class=\"text-success\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"' . $text . '\">' . $icon . '</span>';\n\t}\n\n\t$icon = $tp->toGlyph('glyphicon-remove');\n\t$text = $details['error'];\n\treturn '<span class=\"text-danger\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"' . $text . '\">' . $icon . '</span>';\n}\n\n/**\n * @} End of \"addtogroup Third-party libraries\".\n */\n"], "filenames": ["e107_admin/frontpage.php", "e107_admin/meta.php", "e107_admin/plugin.php", "e107_admin/prefs.php"], "buggy_code_start_loc": [20, 12, 215, 12], "buggy_code_end_loc": [498, 130, 821, 311], "fixing_code_start_loc": [21, 13, 214, 13], "fixing_code_end_loc": [505, 136, 825, 317], "type": "CWE-352", "message": "e107 2.1.4 is vulnerable to cross-site request forgery in plugin-installing, meta-changing, and settings-changing. A malicious web page can use forged requests to make e107 download and install a plug-in provided by the attacker.", "other": {"cve": {"id": "CVE-2017-8098", "sourceIdentifier": "cve@mitre.org", "published": "2017-04-24T18:59:00.663", "lastModified": "2017-04-29T18:38:35.803", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "e107 2.1.4 is vulnerable to cross-site request forgery in plugin-installing, meta-changing, and settings-changing. A malicious web page can use forged requests to make e107 download and install a plug-in provided by the attacker."}, {"lang": "es", "value": "e107 2.1.4 es vulnerable a CSRF en la instalaci\u00f3n de plugins, el meta cambio y el cambio de configuraci\u00f3n. Una p\u00e1gina web maliciosa puede utilizar solicitudes falsificadas para hacer una descarga e107 e instalar un plug-in proporcionado por el atacante."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:H/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "HIGH", "availabilityImpact": "NONE", "baseScore": 6.5, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 3.6}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-352"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:e107:e107:2.1.4:*:*:*:*:*:*:*", "matchCriteriaId": "787202B4-C2E4-492E-8FFA-0A567F2E3734"}]}]}], "references": [{"url": "http://seclists.org/fulldisclosure/2017/Apr/40", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory", "VDB Entry"]}, {"url": "https://github.com/e107inc/e107/commit/7a3e3d9fc7e05ce6941b9af1c14010bf2141f1a5", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/e107inc/e107/commit/7a3e3d9fc7e05ce6941b9af1c14010bf2141f1a5"}}