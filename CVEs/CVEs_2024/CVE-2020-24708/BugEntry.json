{"buggy_code": ["var profiles=[];function sendTestEmail(){var o=[];$.each($(\"#headersTable\").DataTable().rows().data(),function(e,a){o.push({key:unescapeHtml(a[0]),value:unescapeHtml(a[1])})});var e={template:{},first_name:$(\"input[name=to_first_name]\").val(),last_name:$(\"input[name=to_last_name]\").val(),email:$(\"input[name=to_email]\").val(),position:$(\"input[name=to_position]\").val(),url:\"\",smtp:{from_address:$(\"#from\").val(),host:$(\"#host\").val(),username:$(\"#username\").val(),password:$(\"#password\").val(),ignore_cert_errors:$(\"#ignore_cert_errors\").prop(\"checked\"),headers:o}};btnHtml=$(\"#sendTestModalSubmit\").html(),$(\"#sendTestModalSubmit\").html('<i class=\"fa fa-spinner fa-spin\"></i> Sending'),api.send_test_email(e).success(function(e){$(\"#sendTestEmailModal\\\\.flashes\").empty().append('<div style=\"text-align:center\" class=\"alert alert-success\">\\t    <i class=\"fa fa-check-circle\"></i> Email Sent!</div>'),$(\"#sendTestModalSubmit\").html(btnHtml)}).error(function(e){$(\"#sendTestEmailModal\\\\.flashes\").empty().append('<div style=\"text-align:center\" class=\"alert alert-danger\">\\t    <i class=\"fa fa-exclamation-circle\"></i> '+e.responseJSON.message+\"</div>\"),$(\"#sendTestModalSubmit\").html(btnHtml)})}function save(e){var o={headers:[]};$.each($(\"#headersTable\").DataTable().rows().data(),function(e,a){o.headers.push({key:unescapeHtml(a[0]),value:unescapeHtml(a[1])})}),o.name=$(\"#name\").val(),o.interface_type=$(\"#interface_type\").val(),o.from_address=$(\"#from\").val(),o.host=$(\"#host\").val(),o.username=$(\"#username\").val(),o.password=$(\"#password\").val(),o.ignore_cert_errors=$(\"#ignore_cert_errors\").prop(\"checked\"),-1!=e?(o.id=profiles[e].id,api.SMTPId.put(o).success(function(e){successFlash(\"Profile edited successfully!\"),load(),dismiss()}).error(function(e){modalError(e.responseJSON.message)})):api.SMTP.post(o).success(function(e){successFlash(\"Profile added successfully!\"),load(),dismiss()}).error(function(e){modalError(e.responseJSON.message)})}function dismiss(){$(\"#modal\\\\.flashes\").empty(),$(\"#name\").val(\"\"),$(\"#interface_type\").val(\"SMTP\"),$(\"#from\").val(\"\"),$(\"#host\").val(\"\"),$(\"#username\").val(\"\"),$(\"#password\").val(\"\"),$(\"#ignore_cert_errors\").prop(\"checked\",!0),$(\"#headersTable\").dataTable().DataTable().clear().draw(),$(\"#modal\").modal(\"hide\")}var dismissSendTestEmailModal=function(){$(\"#sendTestEmailModal\\\\.flashes\").empty(),$(\"#sendTestModalSubmit\").html(\"<i class='fa fa-envelope'></i> Send\")},deleteProfile=function(e){Swal.fire({title:\"Are you sure?\",text:\"This will delete the sending profile. This can't be undone!\",type:\"warning\",animation:!1,showCancelButton:!0,confirmButtonText:\"Delete \"+escapeHtml(profiles[e].name),confirmButtonColor:\"#428bca\",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise(function(a,o){api.SMTPId.delete(profiles[e].id).success(function(e){a()}).error(function(e){o(e.responseJSON.message)})})}}).then(function(e){e.value&&Swal.fire(\"Sending Profile Deleted!\",\"This sending profile has been deleted!\",\"success\"),$('button:contains(\"OK\")').on(\"click\",function(){location.reload()})})};function edit(e){headers=$(\"#headersTable\").dataTable({destroy:!0,columnDefs:[{orderable:!1,targets:\"no-sort\"}]}),$(\"#modalSubmit\").unbind(\"click\").click(function(){save(e)});var a={};-1!=e&&(a=profiles[e],$(\"#name\").val(a.name),$(\"#interface_type\").val(a.interface_type),$(\"#from\").val(a.from_address),$(\"#host\").val(a.host),$(\"#username\").val(a.username),$(\"#password\").val(a.password),$(\"#ignore_cert_errors\").prop(\"checked\",a.ignore_cert_errors),$.each(a.headers,function(e,a){addCustomHeader(a.key,a.value)}))}function copy(e){$(\"#modalSubmit\").unbind(\"click\").click(function(){save(-1)});var a;a=profiles[e],$(\"#name\").val(\"Copy of \"+a.name),$(\"#interface_type\").val(a.interface_type),$(\"#from\").val(a.from_address),$(\"#host\").val(a.host),$(\"#username\").val(a.username),$(\"#password\").val(a.password),$(\"#ignore_cert_errors\").prop(\"checked\",a.ignore_cert_errors)}function load(){$(\"#profileTable\").hide(),$(\"#emptyMessage\").hide(),$(\"#loading\").show(),api.SMTP.get().success(function(e){profiles=e,$(\"#loading\").hide(),0<profiles.length?($(\"#profileTable\").show(),profileTable=$(\"#profileTable\").DataTable({destroy:!0,columnDefs:[{orderable:!1,targets:\"no-sort\"}]}),profileTable.clear(),profileRows=[],$.each(profiles,function(e,a){profileRows.push([escapeHtml(a.name),a.interface_type,moment(a.modified_date).format(\"MMMM Do YYYY, h:mm:ss a\"),\"<div class='pull-right'><span data-toggle='modal' data-backdrop='static' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Edit Profile' onclick='edit(\"+e+\")'>                    <i class='fa fa-pencil'></i>                    </button></span>\\t\\t    <span data-toggle='modal' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Copy Profile' onclick='copy(\"+e+\")'>                    <i class='fa fa-copy'></i>                    </button></span>                    <button class='btn btn-danger' data-toggle='tooltip' data-placement='left' title='Delete Profile' onclick='deleteProfile(\"+e+\")'>                    <i class='fa fa-trash-o'></i>                    </button></div>\"])}),profileTable.rows.add(profileRows).draw(),$('[data-toggle=\"tooltip\"]').tooltip()):$(\"#emptyMessage\").show()}).error(function(){$(\"#loading\").hide(),errorFlash(\"Error fetching profiles\")})}function addCustomHeader(e,a){var o=[escapeHtml(e),escapeHtml(a),'<span style=\"cursor:pointer;\"><i class=\"fa fa-trash-o\"></i></span>'],s=headers.DataTable(),t=s.column(0).data().indexOf(escapeHtml(e));0<=t?s.row(t,{order:\"index\"}).data(o):s.row.add(o),s.draw()}$(document).ready(function(){$(\".modal\").on(\"hidden.bs.modal\",function(e){$(this).removeClass(\"fv-modal-stack\"),$(\"body\").data(\"fv_open_modals\",$(\"body\").data(\"fv_open_modals\")-1)}),$(\".modal\").on(\"shown.bs.modal\",function(e){void 0===$(\"body\").data(\"fv_open_modals\")&&$(\"body\").data(\"fv_open_modals\",0),$(this).hasClass(\"fv-modal-stack\")||($(this).addClass(\"fv-modal-stack\"),$(\"body\").data(\"fv_open_modals\",$(\"body\").data(\"fv_open_modals\")+1),$(this).css(\"z-index\",1040+10*$(\"body\").data(\"fv_open_modals\")),$(\".modal-backdrop\").not(\".fv-modal-stack\").css(\"z-index\",1039+10*$(\"body\").data(\"fv_open_modals\")),$(\".modal-backdrop\").not(\"fv-modal-stack\").addClass(\"fv-modal-stack\"))}),$.fn.modal.Constructor.prototype.enforceFocus=function(){$(document).off(\"focusin.bs.modal\").on(\"focusin.bs.modal\",$.proxy(function(e){this.$element[0]===e.target||this.$element.has(e.target).length||$(e.target).closest(\".cke_dialog, .cke\").length||this.$element.trigger(\"focus\")},this))},$(document).on(\"hidden.bs.modal\",\".modal\",function(){$(\".modal:visible\").length&&$(document.body).addClass(\"modal-open\")}),$(\"#modal\").on(\"hidden.bs.modal\",function(e){dismiss()}),$(\"#sendTestEmailModal\").on(\"hidden.bs.modal\",function(e){dismissSendTestEmailModal()}),$(\"#headersForm\").on(\"submit\",function(){return headerKey=$(\"#headerKey\").val(),headerValue=$(\"#headerValue\").val(),\"\"==headerKey||\"\"==headerValue||(addCustomHeader(headerKey,headerValue),$(\"#headersForm>div>input\").val(\"\"),$(\"#headerKey\").focus()),!1}),$(\"#headersTable\").on(\"click\",\"span>i.fa-trash-o\",function(){headers.DataTable().row($(this).parents(\"tr\")).remove().draw()}),load()});", "var profiles = []\n\n// Attempts to send a test email by POSTing to /campaigns/\nfunction sendTestEmail() {\n    var headers = [];\n    $.each($(\"#headersTable\").DataTable().rows().data(), function (i, header) {\n        headers.push({\n            key: unescapeHtml(header[0]),\n            value: unescapeHtml(header[1]),\n        })\n    })\n    var test_email_request = {\n        template: {},\n        first_name: $(\"input[name=to_first_name]\").val(),\n        last_name: $(\"input[name=to_last_name]\").val(),\n        email: $(\"input[name=to_email]\").val(),\n        position: $(\"input[name=to_position]\").val(),\n        url: '',\n        smtp: {\n            from_address: $(\"#from\").val(),\n            host: $(\"#host\").val(),\n            username: $(\"#username\").val(),\n            password: $(\"#password\").val(),\n            ignore_cert_errors: $(\"#ignore_cert_errors\").prop(\"checked\"),\n            headers: headers,\n        }\n    }\n    btnHtml = $(\"#sendTestModalSubmit\").html()\n    $(\"#sendTestModalSubmit\").html('<i class=\"fa fa-spinner fa-spin\"></i> Sending')\n    // Send the test email\n    api.send_test_email(test_email_request)\n        .success(function (data) {\n            $(\"#sendTestEmailModal\\\\.flashes\").empty().append(\"<div style=\\\"text-align:center\\\" class=\\\"alert alert-success\\\">\\\n\t    <i class=\\\"fa fa-check-circle\\\"></i> Email Sent!</div>\")\n            $(\"#sendTestModalSubmit\").html(btnHtml)\n        })\n        .error(function (data) {\n            $(\"#sendTestEmailModal\\\\.flashes\").empty().append(\"<div style=\\\"text-align:center\\\" class=\\\"alert alert-danger\\\">\\\n\t    <i class=\\\"fa fa-exclamation-circle\\\"></i> \" + data.responseJSON.message + \"</div>\")\n            $(\"#sendTestModalSubmit\").html(btnHtml)\n        })\n}\n\n// Save attempts to POST to /smtp/\nfunction save(idx) {\n    var profile = {\n        headers: []\n    }\n    $.each($(\"#headersTable\").DataTable().rows().data(), function (i, header) {\n        profile.headers.push({\n            key: unescapeHtml(header[0]),\n            value: unescapeHtml(header[1]),\n        })\n    })\n    profile.name = $(\"#name\").val()\n    profile.interface_type = $(\"#interface_type\").val()\n    profile.from_address = $(\"#from\").val()\n    profile.host = $(\"#host\").val()\n    profile.username = $(\"#username\").val()\n    profile.password = $(\"#password\").val()\n    profile.ignore_cert_errors = $(\"#ignore_cert_errors\").prop(\"checked\")\n    if (idx != -1) {\n        profile.id = profiles[idx].id\n        api.SMTPId.put(profile)\n            .success(function (data) {\n                successFlash(\"Profile edited successfully!\")\n                load()\n                dismiss()\n            })\n            .error(function (data) {\n                modalError(data.responseJSON.message)\n            })\n    } else {\n        // Submit the profile\n        api.SMTP.post(profile)\n            .success(function (data) {\n                successFlash(\"Profile added successfully!\")\n                load()\n                dismiss()\n            })\n            .error(function (data) {\n                modalError(data.responseJSON.message)\n            })\n    }\n}\n\nfunction dismiss() {\n    $(\"#modal\\\\.flashes\").empty()\n    $(\"#name\").val(\"\")\n    $(\"#interface_type\").val(\"SMTP\")\n    $(\"#from\").val(\"\")\n    $(\"#host\").val(\"\")\n    $(\"#username\").val(\"\")\n    $(\"#password\").val(\"\")\n    $(\"#ignore_cert_errors\").prop(\"checked\", true)\n    $(\"#headersTable\").dataTable().DataTable().clear().draw()\n    $(\"#modal\").modal('hide')\n}\n\nvar dismissSendTestEmailModal = function () {\n    $(\"#sendTestEmailModal\\\\.flashes\").empty()\n    $(\"#sendTestModalSubmit\").html(\"<i class='fa fa-envelope'></i> Send\")\n}\n\n\nvar deleteProfile = function (idx) {\n    Swal.fire({\n        title: \"Are you sure?\",\n        text: \"This will delete the sending profile. This can't be undone!\",\n        type: \"warning\",\n        animation: false,\n        showCancelButton: true,\n        confirmButtonText: \"Delete \" + escapeHtml(profiles[idx].name),\n        confirmButtonColor: \"#428bca\",\n        reverseButtons: true,\n        allowOutsideClick: false,\n        preConfirm: function () {\n            return new Promise(function (resolve, reject) {\n                api.SMTPId.delete(profiles[idx].id)\n                    .success(function (msg) {\n                        resolve()\n                    })\n                    .error(function (data) {\n                        reject(data.responseJSON.message)\n                    })\n            })\n        }\n    }).then(function (result) {\n        if (result.value){\n            Swal.fire(\n                'Sending Profile Deleted!',\n                'This sending profile has been deleted!',\n                'success'\n            );\n        }\n        $('button:contains(\"OK\")').on('click', function () {\n            location.reload()\n        })\n    })\n}\n\nfunction edit(idx) {\n    headers = $(\"#headersTable\").dataTable({\n        destroy: true, // Destroy any other instantiated table - http://datatables.net/manual/tech-notes/3#destroy\n        columnDefs: [{\n            orderable: false,\n            targets: \"no-sort\"\n        }]\n    })\n\n    $(\"#modalSubmit\").unbind('click').click(function () {\n        save(idx)\n    })\n    var profile = {}\n    if (idx != -1) {\n        profile = profiles[idx]\n        $(\"#name\").val(profile.name)\n        $(\"#interface_type\").val(profile.interface_type)\n        $(\"#from\").val(profile.from_address)\n        $(\"#host\").val(profile.host)\n        $(\"#username\").val(profile.username)\n        $(\"#password\").val(profile.password)\n        $(\"#ignore_cert_errors\").prop(\"checked\", profile.ignore_cert_errors)\n        $.each(profile.headers, function (i, record) {\n            addCustomHeader(record.key, record.value)\n        });\n    }\n}\n\nfunction copy(idx) {\n    $(\"#modalSubmit\").unbind('click').click(function () {\n        save(-1)\n    })\n    var profile = {}\n    profile = profiles[idx]\n    $(\"#name\").val(\"Copy of \" + profile.name)\n    $(\"#interface_type\").val(profile.interface_type)\n    $(\"#from\").val(profile.from_address)\n    $(\"#host\").val(profile.host)\n    $(\"#username\").val(profile.username)\n    $(\"#password\").val(profile.password)\n    $(\"#ignore_cert_errors\").prop(\"checked\", profile.ignore_cert_errors)\n}\n\nfunction load() {\n    $(\"#profileTable\").hide()\n    $(\"#emptyMessage\").hide()\n    $(\"#loading\").show()\n    api.SMTP.get()\n        .success(function (ss) {\n            profiles = ss\n            $(\"#loading\").hide()\n            if (profiles.length > 0) {\n                $(\"#profileTable\").show()\n                profileTable = $(\"#profileTable\").DataTable({\n                    destroy: true,\n                    columnDefs: [{\n                        orderable: false,\n                        targets: \"no-sort\"\n                    }]\n                });\n                profileTable.clear()\n                profileRows = []\n                $.each(profiles, function (i, profile) {\n                    profileRows.push([\n                        escapeHtml(profile.name),\n                        profile.interface_type,\n                        moment(profile.modified_date).format('MMMM Do YYYY, h:mm:ss a'),\n                        \"<div class='pull-right'><span data-toggle='modal' data-backdrop='static' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Edit Profile' onclick='edit(\" + i + \")'>\\\n                    <i class='fa fa-pencil'></i>\\\n                    </button></span>\\\n\t\t    <span data-toggle='modal' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Copy Profile' onclick='copy(\" + i + \")'>\\\n                    <i class='fa fa-copy'></i>\\\n                    </button></span>\\\n                    <button class='btn btn-danger' data-toggle='tooltip' data-placement='left' title='Delete Profile' onclick='deleteProfile(\" + i + \")'>\\\n                    <i class='fa fa-trash-o'></i>\\\n                    </button></div>\"\n                    ])\n                })\n                profileTable.rows.add(profileRows).draw()\n                $('[data-toggle=\"tooltip\"]').tooltip()\n            } else {\n                $(\"#emptyMessage\").show()\n            }\n        })\n        .error(function () {\n            $(\"#loading\").hide()\n            errorFlash(\"Error fetching profiles\")\n        })\n}\n\nfunction addCustomHeader(header, value) {\n    // Create new data row.\n    var newRow = [\n        escapeHtml(header),\n        escapeHtml(value),\n        '<span style=\"cursor:pointer;\"><i class=\"fa fa-trash-o\"></i></span>'\n    ];\n\n    // Check table to see if header already exists.\n    var headersTable = headers.DataTable();\n    var existingRowIndex = headersTable\n        .column(0) // Email column has index of 2\n        .data()\n        .indexOf(escapeHtml(header));\n\n    // Update or add new row as necessary.\n    if (existingRowIndex >= 0) {\n        headersTable\n            .row(existingRowIndex, {\n                order: \"index\"\n            })\n            .data(newRow);\n    } else {\n        headersTable.row.add(newRow);\n    }\n    headersTable.draw();\n}\n\n$(document).ready(function () {\n    // Setup multiple modals\n    // Code based on http://miles-by-motorcycle.com/static/bootstrap-modal/index.html\n    $('.modal').on('hidden.bs.modal', function (event) {\n        $(this).removeClass('fv-modal-stack');\n        $('body').data('fv_open_modals', $('body').data('fv_open_modals') - 1);\n    });\n    $('.modal').on('shown.bs.modal', function (event) {\n        // Keep track of the number of open modals\n        if (typeof ($('body').data('fv_open_modals')) == 'undefined') {\n            $('body').data('fv_open_modals', 0);\n        }\n        // if the z-index of this modal has been set, ignore.\n        if ($(this).hasClass('fv-modal-stack')) {\n            return;\n        }\n        $(this).addClass('fv-modal-stack');\n        // Increment the number of open modals\n        $('body').data('fv_open_modals', $('body').data('fv_open_modals') + 1);\n        // Setup the appropriate z-index\n        $(this).css('z-index', 1040 + (10 * $('body').data('fv_open_modals')));\n        $('.modal-backdrop').not('.fv-modal-stack').css('z-index', 1039 + (10 * $('body').data('fv_open_modals')));\n        $('.modal-backdrop').not('fv-modal-stack').addClass('fv-modal-stack');\n    });\n    $.fn.modal.Constructor.prototype.enforceFocus = function () {\n        $(document)\n            .off('focusin.bs.modal') // guard against infinite focus loop\n            .on('focusin.bs.modal', $.proxy(function (e) {\n                if (\n                    this.$element[0] !== e.target && !this.$element.has(e.target).length\n                    // CKEditor compatibility fix start.\n                    &&\n                    !$(e.target).closest('.cke_dialog, .cke').length\n                    // CKEditor compatibility fix end.\n                ) {\n                    this.$element.trigger('focus');\n                }\n            }, this));\n    };\n    // Scrollbar fix - https://stackoverflow.com/questions/19305821/multiple-modals-overlay\n    $(document).on('hidden.bs.modal', '.modal', function () {\n        $('.modal:visible').length && $(document.body).addClass('modal-open');\n    });\n    $('#modal').on('hidden.bs.modal', function (event) {\n        dismiss()\n    });\n    $(\"#sendTestEmailModal\").on(\"hidden.bs.modal\", function (event) {\n        dismissSendTestEmailModal()\n    })\n    // Code to deal with custom email headers\n    $(\"#headersForm\").on('submit', function () {\n        headerKey = $(\"#headerKey\").val();\n        headerValue = $(\"#headerValue\").val();\n\n        if (headerKey == \"\" || headerValue == \"\") {\n            return false;\n        }\n        addCustomHeader(headerKey, headerValue);\n        // Reset user input.\n        $(\"#headersForm>div>input\").val('');\n        $(\"#headerKey\").focus();\n        return false;\n    });\n    // Handle Deletion\n    $(\"#headersTable\").on(\"click\", \"span>i.fa-trash-o\", function () {\n        headers.DataTable()\n            .row($(this).parents('tr'))\n            .remove()\n            .draw();\n    });\n    load()\n})\n"], "fixing_code": ["var profiles=[];function sendTestEmail(){var s=[];$.each($(\"#headersTable\").DataTable().rows().data(),function(e,a){s.push({key:unescapeHtml(a[0]),value:unescapeHtml(a[1])})});var e={template:{},first_name:$(\"input[name=to_first_name]\").val(),last_name:$(\"input[name=to_last_name]\").val(),email:$(\"input[name=to_email]\").val(),position:$(\"input[name=to_position]\").val(),url:\"\",smtp:{from_address:$(\"#from\").val(),host:$(\"#host\").val(),username:$(\"#username\").val(),password:$(\"#password\").val(),ignore_cert_errors:$(\"#ignore_cert_errors\").prop(\"checked\"),headers:s}};btnHtml=$(\"#sendTestModalSubmit\").html(),$(\"#sendTestModalSubmit\").html('<i class=\"fa fa-spinner fa-spin\"></i> Sending'),api.send_test_email(e).success(function(e){$(\"#sendTestEmailModal\\\\.flashes\").empty().append('<div style=\"text-align:center\" class=\"alert alert-success\">\\t    <i class=\"fa fa-check-circle\"></i> Email Sent!</div>'),$(\"#sendTestModalSubmit\").html(btnHtml)}).error(function(e){$(\"#sendTestEmailModal\\\\.flashes\").empty().append('<div style=\"text-align:center\" class=\"alert alert-danger\">\\t    <i class=\"fa fa-exclamation-circle\"></i> '+escapeHtml(e.responseJSON.message)+\"</div>\"),$(\"#sendTestModalSubmit\").html(btnHtml)})}function save(e){var s={headers:[]};$.each($(\"#headersTable\").DataTable().rows().data(),function(e,a){s.headers.push({key:unescapeHtml(a[0]),value:unescapeHtml(a[1])})}),s.name=$(\"#name\").val(),s.interface_type=$(\"#interface_type\").val(),s.from_address=$(\"#from\").val(),s.host=$(\"#host\").val(),s.username=$(\"#username\").val(),s.password=$(\"#password\").val(),s.ignore_cert_errors=$(\"#ignore_cert_errors\").prop(\"checked\"),-1!=e?(s.id=profiles[e].id,api.SMTPId.put(s).success(function(e){successFlash(\"Profile edited successfully!\"),load(),dismiss()}).error(function(e){modalError(e.responseJSON.message)})):api.SMTP.post(s).success(function(e){successFlash(\"Profile added successfully!\"),load(),dismiss()}).error(function(e){modalError(e.responseJSON.message)})}function dismiss(){$(\"#modal\\\\.flashes\").empty(),$(\"#name\").val(\"\"),$(\"#interface_type\").val(\"SMTP\"),$(\"#from\").val(\"\"),$(\"#host\").val(\"\"),$(\"#username\").val(\"\"),$(\"#password\").val(\"\"),$(\"#ignore_cert_errors\").prop(\"checked\",!0),$(\"#headersTable\").dataTable().DataTable().clear().draw(),$(\"#modal\").modal(\"hide\")}var dismissSendTestEmailModal=function(){$(\"#sendTestEmailModal\\\\.flashes\").empty(),$(\"#sendTestModalSubmit\").html(\"<i class='fa fa-envelope'></i> Send\")},deleteProfile=function(e){Swal.fire({title:\"Are you sure?\",text:\"This will delete the sending profile. This can't be undone!\",type:\"warning\",animation:!1,showCancelButton:!0,confirmButtonText:\"Delete \"+escapeHtml(profiles[e].name),confirmButtonColor:\"#428bca\",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise(function(a,s){api.SMTPId.delete(profiles[e].id).success(function(e){a()}).error(function(e){s(e.responseJSON.message)})})}}).then(function(e){e.value&&Swal.fire(\"Sending Profile Deleted!\",\"This sending profile has been deleted!\",\"success\"),$('button:contains(\"OK\")').on(\"click\",function(){location.reload()})})};function edit(e){headers=$(\"#headersTable\").dataTable({destroy:!0,columnDefs:[{orderable:!1,targets:\"no-sort\"}]}),$(\"#modalSubmit\").unbind(\"click\").click(function(){save(e)});var a={};-1!=e&&(a=profiles[e],$(\"#name\").val(a.name),$(\"#interface_type\").val(a.interface_type),$(\"#from\").val(a.from_address),$(\"#host\").val(a.host),$(\"#username\").val(a.username),$(\"#password\").val(a.password),$(\"#ignore_cert_errors\").prop(\"checked\",a.ignore_cert_errors),$.each(a.headers,function(e,a){addCustomHeader(a.key,a.value)}))}function copy(e){$(\"#modalSubmit\").unbind(\"click\").click(function(){save(-1)});var a;a=profiles[e],$(\"#name\").val(\"Copy of \"+a.name),$(\"#interface_type\").val(a.interface_type),$(\"#from\").val(a.from_address),$(\"#host\").val(a.host),$(\"#username\").val(a.username),$(\"#password\").val(a.password),$(\"#ignore_cert_errors\").prop(\"checked\",a.ignore_cert_errors)}function load(){$(\"#profileTable\").hide(),$(\"#emptyMessage\").hide(),$(\"#loading\").show(),api.SMTP.get().success(function(e){profiles=e,$(\"#loading\").hide(),0<profiles.length?($(\"#profileTable\").show(),profileTable=$(\"#profileTable\").DataTable({destroy:!0,columnDefs:[{orderable:!1,targets:\"no-sort\"}]}),profileTable.clear(),profileRows=[],$.each(profiles,function(e,a){profileRows.push([escapeHtml(a.name),a.interface_type,moment(a.modified_date).format(\"MMMM Do YYYY, h:mm:ss a\"),\"<div class='pull-right'><span data-toggle='modal' data-backdrop='static' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Edit Profile' onclick='edit(\"+e+\")'>                    <i class='fa fa-pencil'></i>                    </button></span>\\t\\t    <span data-toggle='modal' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Copy Profile' onclick='copy(\"+e+\")'>                    <i class='fa fa-copy'></i>                    </button></span>                    <button class='btn btn-danger' data-toggle='tooltip' data-placement='left' title='Delete Profile' onclick='deleteProfile(\"+e+\")'>                    <i class='fa fa-trash-o'></i>                    </button></div>\"])}),profileTable.rows.add(profileRows).draw(),$('[data-toggle=\"tooltip\"]').tooltip()):$(\"#emptyMessage\").show()}).error(function(){$(\"#loading\").hide(),errorFlash(\"Error fetching profiles\")})}function addCustomHeader(e,a){var s=[escapeHtml(e),escapeHtml(a),'<span style=\"cursor:pointer;\"><i class=\"fa fa-trash-o\"></i></span>'],t=headers.DataTable(),o=t.column(0).data().indexOf(escapeHtml(e));0<=o?t.row(o,{order:\"index\"}).data(s):t.row.add(s),t.draw()}$(document).ready(function(){$(\".modal\").on(\"hidden.bs.modal\",function(e){$(this).removeClass(\"fv-modal-stack\"),$(\"body\").data(\"fv_open_modals\",$(\"body\").data(\"fv_open_modals\")-1)}),$(\".modal\").on(\"shown.bs.modal\",function(e){void 0===$(\"body\").data(\"fv_open_modals\")&&$(\"body\").data(\"fv_open_modals\",0),$(this).hasClass(\"fv-modal-stack\")||($(this).addClass(\"fv-modal-stack\"),$(\"body\").data(\"fv_open_modals\",$(\"body\").data(\"fv_open_modals\")+1),$(this).css(\"z-index\",1040+10*$(\"body\").data(\"fv_open_modals\")),$(\".modal-backdrop\").not(\".fv-modal-stack\").css(\"z-index\",1039+10*$(\"body\").data(\"fv_open_modals\")),$(\".modal-backdrop\").not(\"fv-modal-stack\").addClass(\"fv-modal-stack\"))}),$.fn.modal.Constructor.prototype.enforceFocus=function(){$(document).off(\"focusin.bs.modal\").on(\"focusin.bs.modal\",$.proxy(function(e){this.$element[0]===e.target||this.$element.has(e.target).length||$(e.target).closest(\".cke_dialog, .cke\").length||this.$element.trigger(\"focus\")},this))},$(document).on(\"hidden.bs.modal\",\".modal\",function(){$(\".modal:visible\").length&&$(document.body).addClass(\"modal-open\")}),$(\"#modal\").on(\"hidden.bs.modal\",function(e){dismiss()}),$(\"#sendTestEmailModal\").on(\"hidden.bs.modal\",function(e){dismissSendTestEmailModal()}),$(\"#headersForm\").on(\"submit\",function(){return headerKey=$(\"#headerKey\").val(),headerValue=$(\"#headerValue\").val(),\"\"==headerKey||\"\"==headerValue||(addCustomHeader(headerKey,headerValue),$(\"#headersForm>div>input\").val(\"\"),$(\"#headerKey\").focus()),!1}),$(\"#headersTable\").on(\"click\",\"span>i.fa-trash-o\",function(){headers.DataTable().row($(this).parents(\"tr\")).remove().draw()}),load()});", "var profiles = []\n\n// Attempts to send a test email by POSTing to /campaigns/\nfunction sendTestEmail() {\n    var headers = [];\n    $.each($(\"#headersTable\").DataTable().rows().data(), function (i, header) {\n        headers.push({\n            key: unescapeHtml(header[0]),\n            value: unescapeHtml(header[1]),\n        })\n    })\n    var test_email_request = {\n        template: {},\n        first_name: $(\"input[name=to_first_name]\").val(),\n        last_name: $(\"input[name=to_last_name]\").val(),\n        email: $(\"input[name=to_email]\").val(),\n        position: $(\"input[name=to_position]\").val(),\n        url: '',\n        smtp: {\n            from_address: $(\"#from\").val(),\n            host: $(\"#host\").val(),\n            username: $(\"#username\").val(),\n            password: $(\"#password\").val(),\n            ignore_cert_errors: $(\"#ignore_cert_errors\").prop(\"checked\"),\n            headers: headers,\n        }\n    }\n    btnHtml = $(\"#sendTestModalSubmit\").html()\n    $(\"#sendTestModalSubmit\").html('<i class=\"fa fa-spinner fa-spin\"></i> Sending')\n    // Send the test email\n    api.send_test_email(test_email_request)\n        .success(function (data) {\n            $(\"#sendTestEmailModal\\\\.flashes\").empty().append(\"<div style=\\\"text-align:center\\\" class=\\\"alert alert-success\\\">\\\n\t    <i class=\\\"fa fa-check-circle\\\"></i> Email Sent!</div>\")\n            $(\"#sendTestModalSubmit\").html(btnHtml)\n        })\n        .error(function (data) {\n            $(\"#sendTestEmailModal\\\\.flashes\").empty().append(\"<div style=\\\"text-align:center\\\" class=\\\"alert alert-danger\\\">\\\n\t    <i class=\\\"fa fa-exclamation-circle\\\"></i> \" + escapeHtml(data.responseJSON.message) + \"</div>\")\n            $(\"#sendTestModalSubmit\").html(btnHtml)\n        })\n}\n\n// Save attempts to POST to /smtp/\nfunction save(idx) {\n    var profile = {\n        headers: []\n    }\n    $.each($(\"#headersTable\").DataTable().rows().data(), function (i, header) {\n        profile.headers.push({\n            key: unescapeHtml(header[0]),\n            value: unescapeHtml(header[1]),\n        })\n    })\n    profile.name = $(\"#name\").val()\n    profile.interface_type = $(\"#interface_type\").val()\n    profile.from_address = $(\"#from\").val()\n    profile.host = $(\"#host\").val()\n    profile.username = $(\"#username\").val()\n    profile.password = $(\"#password\").val()\n    profile.ignore_cert_errors = $(\"#ignore_cert_errors\").prop(\"checked\")\n    if (idx != -1) {\n        profile.id = profiles[idx].id\n        api.SMTPId.put(profile)\n            .success(function (data) {\n                successFlash(\"Profile edited successfully!\")\n                load()\n                dismiss()\n            })\n            .error(function (data) {\n                modalError(data.responseJSON.message)\n            })\n    } else {\n        // Submit the profile\n        api.SMTP.post(profile)\n            .success(function (data) {\n                successFlash(\"Profile added successfully!\")\n                load()\n                dismiss()\n            })\n            .error(function (data) {\n                modalError(data.responseJSON.message)\n            })\n    }\n}\n\nfunction dismiss() {\n    $(\"#modal\\\\.flashes\").empty()\n    $(\"#name\").val(\"\")\n    $(\"#interface_type\").val(\"SMTP\")\n    $(\"#from\").val(\"\")\n    $(\"#host\").val(\"\")\n    $(\"#username\").val(\"\")\n    $(\"#password\").val(\"\")\n    $(\"#ignore_cert_errors\").prop(\"checked\", true)\n    $(\"#headersTable\").dataTable().DataTable().clear().draw()\n    $(\"#modal\").modal('hide')\n}\n\nvar dismissSendTestEmailModal = function () {\n    $(\"#sendTestEmailModal\\\\.flashes\").empty()\n    $(\"#sendTestModalSubmit\").html(\"<i class='fa fa-envelope'></i> Send\")\n}\n\n\nvar deleteProfile = function (idx) {\n    Swal.fire({\n        title: \"Are you sure?\",\n        text: \"This will delete the sending profile. This can't be undone!\",\n        type: \"warning\",\n        animation: false,\n        showCancelButton: true,\n        confirmButtonText: \"Delete \" + escapeHtml(profiles[idx].name),\n        confirmButtonColor: \"#428bca\",\n        reverseButtons: true,\n        allowOutsideClick: false,\n        preConfirm: function () {\n            return new Promise(function (resolve, reject) {\n                api.SMTPId.delete(profiles[idx].id)\n                    .success(function (msg) {\n                        resolve()\n                    })\n                    .error(function (data) {\n                        reject(data.responseJSON.message)\n                    })\n            })\n        }\n    }).then(function (result) {\n        if (result.value){\n            Swal.fire(\n                'Sending Profile Deleted!',\n                'This sending profile has been deleted!',\n                'success'\n            );\n        }\n        $('button:contains(\"OK\")').on('click', function () {\n            location.reload()\n        })\n    })\n}\n\nfunction edit(idx) {\n    headers = $(\"#headersTable\").dataTable({\n        destroy: true, // Destroy any other instantiated table - http://datatables.net/manual/tech-notes/3#destroy\n        columnDefs: [{\n            orderable: false,\n            targets: \"no-sort\"\n        }]\n    })\n\n    $(\"#modalSubmit\").unbind('click').click(function () {\n        save(idx)\n    })\n    var profile = {}\n    if (idx != -1) {\n        profile = profiles[idx]\n        $(\"#name\").val(profile.name)\n        $(\"#interface_type\").val(profile.interface_type)\n        $(\"#from\").val(profile.from_address)\n        $(\"#host\").val(profile.host)\n        $(\"#username\").val(profile.username)\n        $(\"#password\").val(profile.password)\n        $(\"#ignore_cert_errors\").prop(\"checked\", profile.ignore_cert_errors)\n        $.each(profile.headers, function (i, record) {\n            addCustomHeader(record.key, record.value)\n        });\n    }\n}\n\nfunction copy(idx) {\n    $(\"#modalSubmit\").unbind('click').click(function () {\n        save(-1)\n    })\n    var profile = {}\n    profile = profiles[idx]\n    $(\"#name\").val(\"Copy of \" + profile.name)\n    $(\"#interface_type\").val(profile.interface_type)\n    $(\"#from\").val(profile.from_address)\n    $(\"#host\").val(profile.host)\n    $(\"#username\").val(profile.username)\n    $(\"#password\").val(profile.password)\n    $(\"#ignore_cert_errors\").prop(\"checked\", profile.ignore_cert_errors)\n}\n\nfunction load() {\n    $(\"#profileTable\").hide()\n    $(\"#emptyMessage\").hide()\n    $(\"#loading\").show()\n    api.SMTP.get()\n        .success(function (ss) {\n            profiles = ss\n            $(\"#loading\").hide()\n            if (profiles.length > 0) {\n                $(\"#profileTable\").show()\n                profileTable = $(\"#profileTable\").DataTable({\n                    destroy: true,\n                    columnDefs: [{\n                        orderable: false,\n                        targets: \"no-sort\"\n                    }]\n                });\n                profileTable.clear()\n                profileRows = []\n                $.each(profiles, function (i, profile) {\n                    profileRows.push([\n                        escapeHtml(profile.name),\n                        profile.interface_type,\n                        moment(profile.modified_date).format('MMMM Do YYYY, h:mm:ss a'),\n                        \"<div class='pull-right'><span data-toggle='modal' data-backdrop='static' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Edit Profile' onclick='edit(\" + i + \")'>\\\n                    <i class='fa fa-pencil'></i>\\\n                    </button></span>\\\n\t\t    <span data-toggle='modal' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Copy Profile' onclick='copy(\" + i + \")'>\\\n                    <i class='fa fa-copy'></i>\\\n                    </button></span>\\\n                    <button class='btn btn-danger' data-toggle='tooltip' data-placement='left' title='Delete Profile' onclick='deleteProfile(\" + i + \")'>\\\n                    <i class='fa fa-trash-o'></i>\\\n                    </button></div>\"\n                    ])\n                })\n                profileTable.rows.add(profileRows).draw()\n                $('[data-toggle=\"tooltip\"]').tooltip()\n            } else {\n                $(\"#emptyMessage\").show()\n            }\n        })\n        .error(function () {\n            $(\"#loading\").hide()\n            errorFlash(\"Error fetching profiles\")\n        })\n}\n\nfunction addCustomHeader(header, value) {\n    // Create new data row.\n    var newRow = [\n        escapeHtml(header),\n        escapeHtml(value),\n        '<span style=\"cursor:pointer;\"><i class=\"fa fa-trash-o\"></i></span>'\n    ];\n\n    // Check table to see if header already exists.\n    var headersTable = headers.DataTable();\n    var existingRowIndex = headersTable\n        .column(0) // Email column has index of 2\n        .data()\n        .indexOf(escapeHtml(header));\n\n    // Update or add new row as necessary.\n    if (existingRowIndex >= 0) {\n        headersTable\n            .row(existingRowIndex, {\n                order: \"index\"\n            })\n            .data(newRow);\n    } else {\n        headersTable.row.add(newRow);\n    }\n    headersTable.draw();\n}\n\n$(document).ready(function () {\n    // Setup multiple modals\n    // Code based on http://miles-by-motorcycle.com/static/bootstrap-modal/index.html\n    $('.modal').on('hidden.bs.modal', function (event) {\n        $(this).removeClass('fv-modal-stack');\n        $('body').data('fv_open_modals', $('body').data('fv_open_modals') - 1);\n    });\n    $('.modal').on('shown.bs.modal', function (event) {\n        // Keep track of the number of open modals\n        if (typeof ($('body').data('fv_open_modals')) == 'undefined') {\n            $('body').data('fv_open_modals', 0);\n        }\n        // if the z-index of this modal has been set, ignore.\n        if ($(this).hasClass('fv-modal-stack')) {\n            return;\n        }\n        $(this).addClass('fv-modal-stack');\n        // Increment the number of open modals\n        $('body').data('fv_open_modals', $('body').data('fv_open_modals') + 1);\n        // Setup the appropriate z-index\n        $(this).css('z-index', 1040 + (10 * $('body').data('fv_open_modals')));\n        $('.modal-backdrop').not('.fv-modal-stack').css('z-index', 1039 + (10 * $('body').data('fv_open_modals')));\n        $('.modal-backdrop').not('fv-modal-stack').addClass('fv-modal-stack');\n    });\n    $.fn.modal.Constructor.prototype.enforceFocus = function () {\n        $(document)\n            .off('focusin.bs.modal') // guard against infinite focus loop\n            .on('focusin.bs.modal', $.proxy(function (e) {\n                if (\n                    this.$element[0] !== e.target && !this.$element.has(e.target).length\n                    // CKEditor compatibility fix start.\n                    &&\n                    !$(e.target).closest('.cke_dialog, .cke').length\n                    // CKEditor compatibility fix end.\n                ) {\n                    this.$element.trigger('focus');\n                }\n            }, this));\n    };\n    // Scrollbar fix - https://stackoverflow.com/questions/19305821/multiple-modals-overlay\n    $(document).on('hidden.bs.modal', '.modal', function () {\n        $('.modal:visible').length && $(document.body).addClass('modal-open');\n    });\n    $('#modal').on('hidden.bs.modal', function (event) {\n        dismiss()\n    });\n    $(\"#sendTestEmailModal\").on(\"hidden.bs.modal\", function (event) {\n        dismissSendTestEmailModal()\n    })\n    // Code to deal with custom email headers\n    $(\"#headersForm\").on('submit', function () {\n        headerKey = $(\"#headerKey\").val();\n        headerValue = $(\"#headerValue\").val();\n\n        if (headerKey == \"\" || headerValue == \"\") {\n            return false;\n        }\n        addCustomHeader(headerKey, headerValue);\n        // Reset user input.\n        $(\"#headersForm>div>input\").val('');\n        $(\"#headerKey\").focus();\n        return false;\n    });\n    // Handle Deletion\n    $(\"#headersTable\").on(\"click\", \"span>i.fa-trash-o\", function () {\n        headers.DataTable()\n            .row($(this).parents('tr'))\n            .remove()\n            .draw();\n    });\n    load()\n})\n"], "filenames": ["static/js/dist/app/sending_profiles.min.js", "static/js/src/app/sending_profiles.js"], "buggy_code_start_loc": [1, 39], "buggy_code_end_loc": [2, 40], "fixing_code_start_loc": [1, 39], "fixing_code_end_loc": [2, 40], "type": "CWE-79", "message": "Cross Site Scripting (XSS) vulnerability in Gophish before 0.11.0 via the Host field on the send profile form.", "other": {"cve": {"id": "CVE-2020-24708", "sourceIdentifier": "cve@mitre.org", "published": "2020-10-28T20:15:13.227", "lastModified": "2020-10-29T20:51:49.290", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Cross Site Scripting (XSS) vulnerability in Gophish before 0.11.0 via the Host field on the send profile form."}, {"lang": "es", "value": "Una vulnerabilidad de tipo Cross Site Scripting (XSS) en Gophish versiones anteriores a 0.11.0, por medio del campo Host en el formulario de perfil de env\u00edo"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 3.5}, "baseSeverity": "LOW", "exploitabilityScore": 6.8, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:getgophish:gophish:*:*:*:*:*:*:*:*", "versionEndExcluding": "0.11.0", "matchCriteriaId": "EBAFA832-F932-4CA4-BAB8-3F639424B438"}]}]}], "references": [{"url": "https://github.com/gophish/gophish/commit/90fed5a575628b89eaf941e1627b49e0f3693812", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://herolab.usd.de/security-advisories/usd-2020-0048/", "source": "cve@mitre.org", "tags": ["Exploit", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/gophish/gophish/commit/90fed5a575628b89eaf941e1627b49e0f3693812"}}