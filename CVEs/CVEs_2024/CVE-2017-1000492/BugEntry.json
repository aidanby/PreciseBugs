{"buggy_code": ["// 1. notebook change\n// notebook\u4e00\u6539\u53d8, \u5f53\u524d\u7684\u80af\u5b9a\u8981\u4fdd\u5b58, ajax\u662f\u5f02\u6b65\u7684. \u6b64\u65f6\u5148\u6e05\u7a7a\u6240\u6709note\u4fe1\u606f. -> \u5f97\u5230\u8be5notebook\u7684notes, \u663e\u793a\u51fa\u6765, \u5e76\u9009\u4e2d\u7b2c\u4e00\u4e2a!\n// \u5728\u8fd9\u671f\u95f4\u5b9a\u65f6\u5668\u8fd8\u4f1a\u4fdd\u5b58, curNoteId\u8fd8\u6ca1\u6362, \u6240\u4ee5\u4f1a\u6e05\u7a7acurNoteId\u7684content!!!\n\n// 2. note change, save cur, \u7acb\u5373curNoteId = \"\"!!\n\n// 3. \u4ec0\u4e48\u65f6\u5019\u8bbe\u7f6ecurNoteId? \u662fajax\u5f97\u5230\u5185\u5bb9\u4e4b\u540e\u8bbe\u7f6e\n\n// note\nNote.curNoteId = \"\";\n\nNote.interval = \"\"; // \u5b9a\u65f6\u5668\n\nNote.noteItemListO = $(\"#noteItemList\");\nNote.$itemList = $('#noteItemList');\n\n// notbeookId => {\"updatedTime\" => [noteId1, noteId2], \"title\" => [noteId1, noteId2...]} \u6392\u5e8f\u65b9\u5f0f\u5206\u7ec4\n// \u4e00\u65e6\u67d0notebook\u6539\u53d8\u4e86\u5c31\u6e05\u7a7a, \u91cd\u65b0\u6392\u5e8f\u4e4b. (\u7528js\u6392)\nNote.cacheByNotebookId = { all: {} };\nNote.notebookIds = {}; // notebookId => true\n\n// \u521d\u59cb\u5316\u6a21\u7248\u5b57\u7b26\u4e32\n// blog, star, settings\nvar itemIsBlog = '<div class=\"item-options\"><div class=\"item-blog\"><i class=\"fa fa-bold\" title=\"' + getMsg('Blog') + '\"></i></div><div class=\"item-conflict-info\"><i class=\"fa fa-bug\" title=\"' + getMsg('Conflict') + '!!\"></i></div><div class=\"item-warning\"><i class=\"fa fa-warning\" title=\"' + getMsg('Error') + '!!\"></i></div><div class=\"item-star\"><i class=\"fa fa-star-o\" title=\"' + getMsg('Star') + '\"></i></div><div class=\"item-setting\"><i class=\"fa fa-cog\" title=\"' + getMsg('Setting') + '\"></i></div></div>';\nNote.itemTplNoImg = '<li href=\"#\" class=\"item ?\" data-seq=\"?\" noteId=\"?\">';\nNote.itemTplNoImg += itemIsBlog + '<div class=\"item-desc\"><p class=\"item-title\">?</p><p class=\"item-info\"><i class=\"fa fa-book\"></i> <span class=\"note-notebook\">?</span> <i class=\"fa fa-clock-o\"></i> <span class=\"updated-time\">?</span></p><p class=\"desc\">?</p></div></li>';\nNote.itemTpl = '<li href=\"#\" class=\"item ? item-image\" data-seq=\"?\" noteId=\"?\"><div class=\"item-thumb\" style=\"\"><img src=\"?\"/></div>';\nNote.itemTpl += itemIsBlog + '<div class=\"item-desc\" style=\"\"><p class=\"item-title\">?</p><p class=\"item-info\"><i class=\"fa fa-book\"></i> <span class=\"note-notebook\">?</span> <i class=\"fa fa-clock-o\"></i> <span class=\"updated-time\">?</span></p><p class=\"desc\">?</p></div></li>';\n\nNote.switchView = function(view) {\n    const viewList = ['snippet', 'list'];\n    if (viewList.indexOf(view) === -1) return;\n    viewList.forEach(function(name) {\n        $('#noteItemList').removeClass(name + '-view');\n    });\n    $('#noteItemList').addClass(view + '-view');\n    Config.view = view;\n    Api.writeConfig(Config);\n}\nNote.switchView(Config.view || 'snippet');\n\nNote.getItemTpl = function() {\n    return Note.itemTpl;\n}\n\nNote.getItemTplNoImg = function() {\n    return Note.itemTplNoImg;\n}\n\n// \u5b9a\u65f6\u4fdd\u5b58\u4fe1\u606f\nNote.intervalTime = 10 * 1000; // 10\u79d2\nNote.startInterval = function() {\n    if (Note.interval) {\n        clearInterval(Note.interval);\n    }\n    Note.interval = setInterval(function() {\n        console.log(\"\u81ea\u52a8\u4fdd\u5b58...\");\n        Note.curChangedSaveIt(false);\n    }, Note.intervalTime); // 600s, 10mins\n};\n\n// \u505c\u6b62, \u5f53\u5207\u6362note\u65f6\n// \u4f46\u8fc75000\u540e\u81ea\u52a8\u542f\u52a8\nNote.stopInterval = function(notStartAuto) {\n    clearInterval(Note.interval);\n\n    // \u662f\u5426\u81ea\u52a8\u542f\u52a8, \u9ed8\u8ba4\u662f\u81ea\u52a8\u542f\u52a8\n    if (!notStartAuto) {\n        setTimeout(function() {\n            Note.startInterval();\n        }, Note.intervalTime);\n    }\n};\n\n// note = {NoteId, Desc, UserId,...}\nNote.addNoteCache = function(note) {\n        Note.cache[note.NoteId] = note;\n        Note.clearCacheByNotebookId(note.NotebookId);\n    }\n    // content = {NoteId:, Content:}\n    // \u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u5176\u5b83\u7684\u503c\nNote.setNoteCache = function(content, clear) {\n    if (!Note.cache[content.NoteId]) {\n        Note.cache[content.NoteId] = content;\n    } else {\n        $.extend(Note.cache[content.NoteId], content);\n    }\n\n    if (clear == undefined) {\n        clear = true;\n    }\n    if (clear) {\n        Note.clearCacheByNotebookId(content.NotebookId);\n    }\n}\n\n// \u5220\u9664\u7f13\u5b58\nNote.deleteCache = function(noteId) {\n    delete this.cache[noteId];\n};\n\n// \u5f97\u5230\u5f53\u524d\u7684\u7b14\u8bb0\nNote.getCurNote = function() {\n    var self = this;\n    if (!self.curNoteId) {\n        return null;\n    }\n    return self.cache[self.curNoteId];\n}\nNote.getNote = function(noteId) {\n    var self = this;\n    return self.cache[noteId];\n};\n\nNote.getTargetById = function(noteId) {\n    return this.$itemList.find('li[noteId=\"' + noteId + '\"]');\n};\n\n// \u6bcf\u5f53\u6709notebookId\u76f8\u5e94\u7684note\u6539\u53d8\u65f6\u90fd\u8981\u91cd\u65b0\u6e05\u7a7a\u4e4b\n// \u5e76\u8bbe\u7f6e\u8be5notebookId\u6709\u503c\nNote.clearCacheByNotebookId = function(notebookId) {\n    if (notebookId) {\n        Note.cacheByNotebookId[notebookId] = {};\n        Note.cacheByNotebookId[\"all\"] = {};\n        Note.notebookIds[notebookId] = true;\n    }\n};\n\n// notebook\u662f\u5426\u6709notes\n// called by Notebook\nNote.notebookHasNotes = function(notebookId) {\n    var notes = Note.getNotesByNotebookId(notebookId);\n    return !isEmpty(notes);\n};\n\n// \u91cd\u65b0\u8bbe\u7f6esorter, \u6b64\u65f6\u8981\u91cd\u65b0render\n// sortType = dateCreatedASC dateCreatedDESC\nNote.setNotesSorter = function (sortType) {\n\tConfig.sortType = sortType;\n\n    // \u5982\u679c\u5f53\u524d\u662ftagSearch, search, star \u600e\u4e48\u529e?\n\t// \u91cd\u65b0Render\n    if (Notebook.isTag || Notebook.isStarred || Notebook.isSearch) {\n        Note.renderNotesAndTargetNote(Note._everNotes, false, false);\n    } else {\n        // \u5176\u5b9e\u8fd9\u91cc\u4e5f\u53ef\u4ee5\u7528Note._everNotes, \u4e3b\u8981\u662f\u4e3a\u4e86\u7f13\u5b58\u6570\u636e\n        Notebook.changeNotebook(Notebook.curNotebookId);\n    }\n    // Note.renderNotesAndTargetNote(Note._everNotes, false, false);\n\n\tApi.writeConfig(Config);\n};\n\n// render\u524d\u5148\u6392\u5e8f\nNote.sortNotes = function (notes) {\n\tif (isEmpty(notes)) {\n\t\treturn;\n\t}\n\n\tvar sorterAndOrder = Note.getSorterAndOrder();\n    var sortBy = sorterAndOrder.sortBy;\n    var isAsc = sorterAndOrder.isAsc;\n\n\t// \u6392\u5e8f\u4e4b\n    notes.sort(function(a, b) {\n        var t1 = a[sortBy];\n        var t2 = b[sortBy];\n\n        if (isAsc) {\n            if (t1 < t2) {\n                return -1;\n            } else if (t1 > t2) {\n                return 1;\n            }\n        } else {\n            if (t1 < t2) {\n                return 1;\n            } else if (t1 > t2) {\n                return -1;\n            }\n        }\n        return 0;\n    });\n};\n\nNote.getSorterAndOrder = function () {\n\tvar sortBy = \"UpdatedTime\";\n    var isAsc = false; // \u9ed8\u8ba4\u662f\u964d\u5e8f\n    if (Config.sortType) {\n    \tswitch(Config.sortType) {\n    \t\tcase 'dateCreatedASC':\n    \t\t\tsortBy = 'CreatedTime';\n    \t\t\tisAsc = true;\n    \t\t\tbreak;\n    \t\tcase 'dateCreatedDESC':\n    \t\t\tsortBy = 'CreatedTime';\n    \t\t\tisAsc = false;\n    \t\t\tbreak;\n    \t\tcase 'dateUpdatedASC':\n    \t\t\tsortBy = 'UpdatedTime';\n    \t\t\tisAsc = true;\n    \t\t\tbreak;\n    \t\tcase 'dateUpdatedDESC':\n    \t\t\tsortBy = 'UpdatedTime';\n    \t\t\tisAsc = false;\n    \t\t\tbreak;\n    \t\tcase 'titleASC':\n    \t\t\tsortBy = 'Title';\n    \t\t\tisAsc = true;\n    \t\t\tbreak;\n    \t\tcase 'titleDESC':\n    \t\t\tsortBy = 'Title';\n    \t\t\tisAsc = false;\n    \t\t\tbreak;\n    \t}\n    }\n    console.log({sortBy: sortBy, isAsc: isAsc});\n    return {sortBy: sortBy, isAsc: isAsc};\n};\n\n// \u5f97\u5230notebook\u4e0b\u7684notes, \u6309\u4ec0\u4e48\u6392\u5e8f updatedTime?\nNote.getNotesByNotebookId = function(notebookId) {\n    var sorterAndOrder = Note.getSorterAndOrder();\n    var sortBy = sorterAndOrder.sortBy;\n    var isAsc = sorterAndOrder.isAsc;\n\n    if (!notebookId) {\n        notebookId = \"all\";\n    }\n\n    if (!Note.cacheByNotebookId[notebookId]) {\n        return [];\n    }\n\n    if (Note.cacheByNotebookId[notebookId][sortBy]) {\n    \tif (Note.cacheByNotebookId[notebookId][sortBy][isAsc]) {\n    \t\treturn Note.cacheByNotebookId[notebookId][sortBy][isAsc];\n    \t}\n    \t// \u9006\u5e8f\n    \tNote.cacheByNotebookId[notebookId][sortBy][!isAsc].reverse();\n    \tvar notes = Note.cacheByNotebookId[notebookId][sortBy][!isAsc];\n    \tNote.cacheByNotebookId[notebookId][sortBy][!isAsc] = null;\n    \tNote.cacheByNotebookId[notebookId][sortBy][isAsc] = notes;\n    \treturn notes;\n    }\n\n    // \u4ece\u6240\u6709\u7684notes\u4e2d\u627e\u5230notebookId\u7684, \u5e76\u6392\u5e8f\u4e4b\n    var notes = [];\n    for (var i in Note.cache) {\n        if (!i) {\n            continue;\n        }\n        var note = Note.cache[i];\n        if (!note) {\n            continue;\n        }\n\n        if (!('IsMarkdown' in note)) {\n            console.error('\u50f5\u5c38note------');\n        }\n        // \u4e0d\u8981trash\u7684not, \u5171\u4eab\u7684\u4e5f\u4e0d\u8981\n        if (note.IsTrash || note.IsDeleted || note.LocalIsDelete) {\n            continue;\n        }\n        if (notebookId == \"all\" || note.NotebookId == notebookId) {\n            notes.push(note);\n        }\n    }\n\n    Note.sortNotes(notes);\n\n    // \u7f13\u5b58\u4e4b\n    Note.cacheByNotebookId[notebookId][sortBy] = {};\n    Note.cacheByNotebookId[notebookId][sortBy][isAsc] = notes;\n    return notes;\n};\n\n// called by Notebook\n// render \u6240\u6709notes, \u548c\u7b2c\u4e00\u4e2anote\u7684content\nNote.renderNotesAndFirstOneContent = function(ret) {\n    // \u9519\u8bef\u7684ret\u662f\u4e00\u4e2aObject\n    if (!isArray(ret)) {\n        return;\n    }\n\n    // note \u5bfc\u822a\n    Note.renderNotes(ret);\n    // \u6e32\u67d3\u7b2c\u4e00\u4e2a\n    if (!isEmpty(ret[0])) {\n        Note.changeNoteForPjax(ret[0].NoteId, true, false);\n    } else {}\n};\n\n// \u6e32\u67d3\u5e76\u5b9a\u4f4d\u5230\u7279\u5b9a\u7684\nNote.renderNotesAndTargetNote = function(ret, noteId, hasSorted) {\n    // \u9519\u8bef\u7684ret\u662f\u4e00\u4e2aObject\n    if (!isArray(ret)) {\n        return;\n    }\n\n    // note \u5bfc\u822a\n    Note.renderNotes(ret, false, hasSorted);\n    // \u6e32\u67d3\u7279\u5b9a\u7684\n    if (!isEmpty(ret[0])) {\n        if (noteId) {\n            // Note.changeNoteForPjax(noteId, true, false);\n            Note.changeNoteForPjax(noteId, true, false);\n            if (!Note.directToNote(noteId)) {\n                // \u627e\u4e0d\u5230\u554a\n                Note.changeNoteForPjax(ret[0].NoteId, true, false);\n            }\n        } else {\n            Note.changeNoteForPjax(ret[0].NoteId, true, false);\n        }\n    }\n};\n\nNote.alertWeb = function(msg) {\n    alert(msg);\n};\n\n// \u5f53\u524d\u7684note\u662f\u5426\u6539\u53d8\u8fc7\u4e86?\n// \u8fd4\u56de\u5df2\u6539\u53d8\u7684\u4fe1\u606f\nNote.curHasChanged = function(force) {\n    var cacheNote = Note.getCurNote();\n    if (!cacheNote || cacheNote.InitSync) { // \u8fd8\u6ca1\u6709\u540c\u6b65\u7684, \u4e0d\u80fd\u4fdd\u5b58\n        return false;\n    }\n    // else {\n    // \t// console.log('\u5f53\u524d\u7b14\u8bb0\u4e3a' + cacheNote.NoteId);\n    // }\n\n    // \u6536\u96c6\u5f53\u524d\u4fe1\u606f, \u4e0ecache\u6bd4\u5bf9\n    var title = $('#noteTitle').val();\n    var tags = Tag.input.getTags();\n\n    var hasChanged = {\n        hasChanged: false, // \u603b\u7684\u662f\u5426\u6709\u6539\u53d8\n        IsNew: cacheNote.IsNew, // \u662f\u5426\u662f\u65b0\u6dfb\u52a0\u7684\n        IsMarkdown: cacheNote.IsMarkdown, // \u662f\u5426\u662fmarkdown\u7b14\u8bb0\n        FromUserId: cacheNote.FromUserId, // \u662f\u5426\u662f\u5171\u4eab\u65b0\u5efa\u7684\n        NoteId: cacheNote.NoteId,\n        NotebookId: cacheNote.NotebookId\n    };\n\n    if (cacheNote.IsNew) {\n        hasChanged.hasChanged = true;\n    }\n\n    if (cacheNote.Title != title) {\n        hasChanged.hasChanged = true; // \u672c\u9875\u4f7f\u7528\u7528\u5c0f\u5199\n        hasChanged.Title = title; // \u8981\u4f20\u5230\u540e\u53f0\u7684\u7528\u5927\u5199\n    }\n\n    if (!arrayEqual(cacheNote.Tags, tags)) {\n        hasChanged.hasChanged = true;\n        hasChanged.Tags = tags;\n    }\n\n    // \u662f\u5426\u9700\u8981\u68c0\u67e5\u5185\u5bb9\u5462?\n    var needCheckContent = false;\n    if (cacheNote.IsNew || force || !Note.readOnly) {\n        needCheckContent = true;\n    }\n\n    // \u6807\u9898, \u6807\u7b7e, \u5185\u5bb9\u90fd\u6ca1\u6539\u53d8\n    if (!hasChanged.hasChanged && !needCheckContent) {\n        return false;\n    }\n\n    if (!needCheckContent) {\n        return hasChanged;\n    }\n\n    //===========\n    // \u5185\u5bb9\u7684\u6bd4\u8f83\n\n    // \u662fmardown\u7f16\u8f91\u5668, \u6216\u8005\u5bcc\u6587\u672c\u7f16\u8f91\u5668\u5df2Dirty\n    if (cacheNote.IsMarkdown || editorIsDirty()) {\n\n        // \u5982\u679c\u662fmarkdown\u8fd4\u56de[content, preview]\n        var contents = getEditorContent(cacheNote.IsMarkdown);\n        var content, preview;\n        if (isArray(contents)) {\n            content = contents[0];\n            preview = contents[1];\n            // preview\u53ef\u80fd\u6ca1\u6765\u5f97\u5230\u53ca\u89e3\u6790\n            if (content && previewIsEmpty(preview) && Converter) {\n                preview = Converter.makeHtml(content);\n            }\n            if (!content) {\n                preview = \"\";\n            }\n            cacheNote.Preview = preview; // \u4ec5\u4ec5\u7f13\u5b58\u5728\u524d\u53f0\n        } else if (cacheNote.IsMarkdown && typeof contents === 'boolean') {\n            // \u4e0d\u4f1a\u51fa\u73b0, \u56e0\u4e3a\u521a\u5f00\u59cb\u65f6readOnly=true, \u4e14\u53ea\u6709\u8bbe\u7f6e\u5185\u5bb9\u5b8c\u6210\u540e\u624dsetCurNoteId\n            // markdown\u7f16\u8f91\u5668\u8fd8\u6ca1\u51c6\u5907\u597d\n            throw new Error('markdown\u7f16\u8f91\u5668\u8fd8\u6ca1\u51c6\u5907\u597d');\n        }\n        // \u5bcc\u6587\u672c\u7f16\u8f91\u5668\n        else {\n            content = contents;\n        }\n\n        if (cacheNote.Content != content) {\n            hasChanged.hasChanged = true;\n            hasChanged.Content = content;\n\n            // \u4ecehtml\u4e2d\u5f97\u5230...\n            var c = preview || content;\n\n            // \u4e0d\u662f\u535a\u5ba2\u6216\u6ca1\u6709\u81ea\u5b9a\u4e49\u8bbe\u7f6e\u7684\n            if (!cacheNote.HasSelfDefined || !cacheNote.IsBlog) {\n                hasChanged.Desc = Note.genDesc(c);\n                hasChanged.ImgSrc = Note.getImgSrc(c);\n                hasChanged.Abstract = Note.genAbstract(c);\n            }\n        }\n\n        // \u5df2\u4fdd\u5b58\u4e86, \u4e0d\u518dDirty\n        setEditorIsDirty(false);\n    } else {\n        console.log('\u5185\u5bb9\u65e0\u4fee\u6539', 'isMarkdown:' + cacheNote.IsMarkdown, 'isDirty:' + editorIsDirty());\n    }\n\n    if (hasChanged.hasChanged) {\n        return hasChanged;\n    }\n    return false;\n};\n\n// \u7531content\u751f\u6210desc\n// \u6362\u884c\u4e0d\u8981\u66ff\u6362\nNote.genDesc = function(content, length) {\n    if (!content) {\n        return \"\";\n    }\n    if (!length) {\n        length = 20;\n    }\n\n    // \u7559\u7a7a\u683c\n    content = content.replace(/<br \\/>/g, \" \");\n    content = content.replace(/<\\/p>/g, \" \");\n    content = content.replace(/<\\/div>/g, \" \");\n\n    // \u975e\u5e38\u5371\u9669, \u4e07\u4e00markdown\u91cc, \u6216\u8005code\u91cc\u5199\u4e86<script></script>\u6216<http meta=refresh>\u4e4b\u7c7b\u7684\n    // \u907f\u514d\u5176\u5b83\u7684<img \u4e4b\u7c7b\u7684\u4e0d\u5b8c\u5168\n    // \u4e4b\u524d\u4f1a\u5c06content\u653e\u5230<div></div>\u4e2d\n    // content = $(\"<div></div>\").html(content).text();\n    // content = $(\"<div>\" + content + \"</div>\").text();\n\n    // \u5c06html tags\u5168\u90e8\u5220\u9664\n    content = content.replace(/<\\/?[^>]+(>|$)/g, \"\");\n    content = $.trim(content);\n    // pre\u4e0btext()\u4f1a\u5c06&lt; => < &gt; => >\n    content = content.replace(/</g, \"&lt;\");\n    content = content.replace(/>/g, \"&gt;\");\n\n    if (content.length < length) {\n        return content;\n    }\n\n    return content.substring(0, length);\n}\n\n// \u5f97\u5230\u6458\u8981\nNote.genAbstract = function(content, len) {\n    if (!content) {\n        return \"\";\n    }\n    if (len == undefined) {\n        len = 1000;\n    }\n    if (content.length < len) {\n        return content;\n    }\n    var isCode = false;\n    var isHTML = false;\n    var n = 0;\n    var result = \"\";\n    var maxLen = len;\n    for (var i = 0; i < content.length; ++i) {\n        var temp = content[i]\n        if (temp == '<') {\n            isCode = true\n        } else if (temp == '&') {\n            isHTML = true\n        } else if (temp == '>' && isCode) {\n            n = n - 1\n            isCode = false\n        } else if (temp == ';' && isHTML) {\n            isHTML = false\n        }\n        if (!isCode && !isHTML) {\n            n = n + 1\n        }\n        result += temp\n        if (n >= maxLen) {\n            break\n        }\n    }\n\n    var d = document.createElement(\"div\");\n    d.innerHTML = result\n    return d.innerHTML;\n};\n\nNote.fixImageSrc = function(src) {\n    return fixContentUrl(src);\n};\n\nNote.getImgSrc = function(content) {\n    if (!content) {\n        return \"\";\n    }\n    try {\n        var imgs = $(content).find(\"img\");\n        for (var i in imgs) {\n            var src = imgs.eq(i).attr(\"src\");\n            if (src) {\n                return src;\n            }\n        }\n    } catch (e) {}\n    return \"\";\n};\n\nNote.setNoteDirty = function(noteId, isDirty) {\n    console.trace('setNoteDirty');\n    var $leftNoteNav = $(tt('#noteItemList [noteId=\"?\"]', noteId));\n    if (!isDirty) {\n        $leftNoteNav.removeClass('item-err');\n    }\n    this.setNoteCache({ NoteId: noteId, IsDirty: isDirty }, false);\n    isDirty ? $leftNoteNav.addClass('item-dirty') : $leftNoteNav.removeClass('item-dirty');\n};\n\n// \u5982\u679c\u5f53\u524d\u7684\u6539\u53d8\u4e86, \u5c31\u4fdd\u5b58\u5b83\n// \u4ee5\u540e\u8981\u5b9a\u65f6\u8c03\u7528\n// force , \u9ed8\u8ba4\u662ftrue, \u8868\u5f3a\u6821\u9a8c\u5185\u5bb9\n// \u5b9a\u65f6\u4fdd\u5b58\u4f20false\nNote.saveInProcess = {}; // noteId => bool, true\u8868\u793a\u8be5note\u6b63\u5728\u4fdd\u5b58\u5230\u670d\u52a1\u5668, \u670d\u52a1\u5668\u672a\u54cd\u5e94\nNote.savePool = {}; // \u4fdd\u5b58\u6c60, \u4ee5\u540e\u7684\u4fdd\u5b58\u5148\u653e\u5728pool\u4e2d, id => note\nNote.savePoolNew = {}; // \u5982\u679c\u4e4b\u524d\u65b0\u5efa\u7684\u4fdd\u5b58\u4e86, \u8fde\u7eed2\u6b21\u4e8b\u4ef6, \u62d6\u52a8\u7b14\u8bb0, \u5219\u4f1a\u4fdd\u5b58\u65b0\u5efa\u4e24\u6b21, \u6b64\u65f6\u6570\u636e\u5e93\u4e2d\u51fa\u73b0\u4e24\u4e2anoteId\u4e00\u6837\u7684\nNote.curChangedSaveIt = function(force, callback) {\n    var me = Note;\n    // \u5982\u679c\u5f53\u524d\u6ca1\u6709\u7b14\u8bb0, \u4e0d\u4fdd\u5b58\n    if (!me.curNoteId) {\n        // console.trace('\u65e0\u5f53\u524d\u7b14\u8bb0!!');\n        callback && callback();\n        return;\n    }\n\n    try {\n        var hasChanged = Note.curHasChanged(force);\n    } catch (e) {\n        console.error('error curHasChanged:'); // + e.toString())\n        console.error(e);\n        callback && callback();\n        return;\n    }\n\n    if (hasChanged && hasChanged.hasChanged) {\n        // \u628a\u5df2\u6539\u53d8\u7684\u6e32\u67d3\u5230\u5de6\u8fb9 item-list\n        Note.renderChangedNote(hasChanged);\n\n        delete hasChanged.hasChanged;\n\n        // \u5148\u7f13\u5b58, \u628amarkdown\u7684preview\u4e5f\u7f13\u5b58\u8d77\u6765\n        Note.setNoteCache(hasChanged, false);\n\n        // \u8bbe\u7f6e\u66f4\u65b0\u65f6\u95f4\n        Note.setNoteCache({ \"NoteId\": hasChanged.NoteId, \"UpdatedTime\": new Date() }, false);\n        Note.clearCacheByNotebookId(hasChanged.NotebookId);\n\n        // \u4fdd\u5b58\u4e4b\n        me.saveInProcess[hasChanged.NoteId] = true;\n\n        if (hasChanged.IsNew) {\n            if (me.savePoolNew[hasChanged.NoteId]) {\n                console.log('\u8981\u4fdd\u5b58\u65b0\u5efa\u4e24\u6b21, \u88ab\u963b\u6b62')\n                return;\n            }\n            me.savePoolNew[hasChanged.NoteId] = true;\n        }\n\n        // console.log(hasChanged);\n        NoteService.updateNoteOrContent(hasChanged, function(ret) {\n            me.saveInProcess[hasChanged.NoteId] = false;\n            if (hasChanged.IsNew) {\n                // \u7f13\u5b58\u4e4b, \u540e\u53f0\u5f97\u5230\u5176\u5b83\u4fe1\u606f\n                ret.IsNew = false;\n                Note.setNoteCache(ret, false);\n\n                // \u65b0\u5efa\u7b14\u8bb0\u4e5f\u8981change history\n                Pjax.changeNote(ret);\n            }\n\n            me.setNoteDirty(hasChanged.NoteId, true);\n\n            callback && callback(ret);\n        }, force);\n\n        return hasChanged;\n\n    } else {\n        // \u5982\u679c\u662f\u5f3a\u5236\u7684, \u5219\u8981\u52a0\u5386\u53f2, \u4f46\u56e0\u7b14\u8bb0\u5185\u5bb9\u6ca1\u6539, \u6240\u4ee5\u4e4b\u524d\u4e0d\u4f1a\u6709\n        if (force) {\n            var note = me.getCurNote();\n            if (!note) {\n                return;\n            }\n            var content = getEditorContent(note.IsMarkdown);\n            if (isArray(content)) {\n                content = content[0];\n            }\n            NoteService.addNoteHistory(me.curNoteId, content, callback);\n            // console.log('\u5df2\u4fdd\u5b58\u5230\u5386\u53f2\u4e2d')\n        } else {\n            console.log('\u4e0d\u7528\u4fdd\u5b58 (^_^)');\n            callback && callback();\n        }\n    }\n    // callback && callback();\n    return false;\n};\n\n// \u66f4\u65b0\u6c60\u91cc\u7684\u7b14\u8bb0\nNote.updatePoolNote = function() {\n    var me = this;\n    for (var noteId in me.savePool) {\n        if (!noteId) {\n            continue;\n        }\n        // \u5220\u9664\u4e4b\n        delete me.savePool[noteId];\n        var hasChanged = me.savePool[noteId];\n        me.saveInProcess[noteId] = true;\n        ajaxPost(\"/note/updateNoteOrContent\", hasChanged, function(ret) {\n            me.saveInProcess[noteId] = false;\n        });\n    }\n};\n// \u542f\u52a8\u4fdd\u5b58, \u6682\u4e0d\u5904\u7406\nNote.updatePoolNoteInterval = null;\nNote.startUpdatePoolNoteInterval = function() {\n    return;\n    var me = this;\n    if (me.updatePoolNoteInterval) {\n        return;\n    }\n    me.updatePoolNoteInterval = setTimeout(function() {\n        log('update pool');\n        me.updatePoolNote();\n    }, 1000);\n};\n\nNote.clearSelect = function(target) {\n    $(\".item\").removeClass(\"item-active\");\n};\nNote.selectTarget = function(target) {\n    this.clearSelect();\n    $(target).addClass(\"item-active\");\n\n    // \u5224\u65ad\u662f\u5426\u5728star\u4e2d\n    var noteId = $(target).attr('noteId');\n    Note.selectStar(noteId);\n};\n\n// \u6539\u53d8note\n// \u53ef\u80fd\u6539\u53d8\u7684\u662fshare note\n// 1. \u4fdd\u5b58\u4e4b\u524d\u7684note\n// 2. ajax\u5f97\u5230\u73b0\u5728\u7684note\nNote.showContentLoading = function() {\n    $(\"#noteMaskForLoading\").css(\"z-index\", 11);\n};\nNote.hideContentLoading = function() {\n    $(\"#noteMaskForLoading\").css(\"z-index\", -1);\n};\n\n// \u5b9a\u4f4d\u5230\u7b14\u8bb0\nNote.directToNote = function(noteId) {\n    // alert(noteId);\n    var $t = $(\"[noteId='\" + noteId + \"']\");\n    if ($t.length == 0) {\n        return false;\n    }\n\n    var $p = $(\"#noteItemList\");\n    var pHeight = $p.height();\n\n    var scrollTop = $p.scrollTop();\n    var pTop = $t.position().top; // \u76f8\u5bf9\u4e8enoteItemList\u7684\u4f4d\u7f6e\n\n    // \u5f53\u524d\u7684\u53ef\u89c6\u8303\u56f4\u7684\u5143\u7d20\u4f4d\u7f6e\u662f[0, pHeight]\n    if (pTop >= 0 && pTop <= pHeight) {\n        // alert(pTop + ' ' + scrollTop + ' ' + pHeight)\n    } else {\n        // var top = pTop;\n        // console.log(\"\u5b9a\u4f4d\u5230\u7279\u5b9anote, \u5728\u53ef\u89c6\u8303\u56f4\u5185\");\n        $(\"#noteItemList\").scrollTop(pTop + scrollTop);\n    }\n    return true;\n};\n\n// mustPush\u8868\u793a\u662f\u5426\u5c06\u72b6\u6001push\u5230state\u4e2d, \u9ed8\u8ba4\u4e3atrue\n// \u4ec0\u4e48\u65f6\u5019\u4e3afalse, \u5728popstate\u65f6\n// needTargetNobook\u9ed8\u8ba4\u4e3afalse, \u5728\u70b9\u51fbnotebook, renderfirst\u65f6\u4e3afalse\nNote.changeNoteForPjax = function(noteId, mustPush, needTargetNotebook) {\n    // console.trace('changeNoteForPjax');\n    var me = this;\n    if (!noteId) {\n        return;\n    }\n    var note = me.getNote(noteId);\n    if (!note) {\n        return;\n    }\n    var isShare = note.Perm != undefined;\n    if (needTargetNotebook == undefined) {\n        needTargetNotebook = true;\n    }\n    me.changeNote(noteId, isShare, true, function(note) {\n        // push state\n        if (mustPush == undefined) {\n            mustPush = true;\n        }\n        if (mustPush) {\n            Pjax.changeNote(note);\n        }\n\n        // popstate\u65f6\u867d\u7136\u9009\u4e2d\u4e86note, \u4f46\u4f4d\u7f6e\u53ef\u80fd\u4e0d\u53ef\u89c1\n        if (needTargetNotebook) {\n            Note.directToNote(noteId);\n        }\n    });\n\n    // \u7b2c\u4e00\u6b21render\u65f6\u5b9a\u4f4d\u5230\u7b2c\u4e00\u4e2a\u7b14\u8bb0\u7684notebook 12.06 life\n    // \u6216\u901a\u8fc7pop\u65f6\n    // \u4ec0\u4e48\u65f6\u5019\u9700\u8981? 1. \u7b2c\u4e00\u6b21changeNote, 2. pop\u65f6, \u53ea\u6709\u5f53\u70b9\u51fb\u4e86notebook\u540e\u624d\u4e0d\u8981\n\n    // \u8fd9\u91cc, \u4e07\u4e00\u662f\u5171\u4eab\u7b14\u8bb0\u5462?\n    // \u5207\u6362\u5230\u5171\u4eab\u4e2d\n    if (needTargetNotebook) {\n        if (isShare) {\n            if ($(\"#myShareNotebooks\").hasClass(\"closed\")) {\n                $(\"#myShareNotebooks .folderHeader\").trigger(\"click\");\n            }\n        } else {\n            if ($(\"#myNotebooks\").hasClass(\"closed\")) {\n                $(\"#myNotebooks .folderHeader\").trigger(\"click\");\n            }\n        }\n        // \u5982\u679c\u662f\u5b50\u7b14\u8bb0\u672c, \u90a3\u4e48\u8981\u5c55\u5f00\u7236\u7b14\u8bb0\u672c\n        Notebook.expandNotebookTo(note.NotebookId);\n    }\n};\n\n// \u70b9\u51fbnotebook\u65f6\u8c03\u7528, \u6e32\u67d3\u7b2c\u4e00\u4e2a\u7b14\u8bb0\nNote.contentAjax = null;\nNote.contentAjaxSeq = 1;\nNote.inChangeNoteId = '';\nNote.setCurNoteId = function(noteId) {\n    // console.trace('setCurNoteId: ' + noteId);\n    Note.curNoteId = noteId;\n    Note.inChangeNoteId = '';\n};\n// \u6e05\u7a7acurNoteId,\nNote.clearCurNoteId = function() {\n    // \u4e3a\u4ec0\u4e48\u8981++? \u907f\u514d\u521a\u6e05\u7a7a, \u56e0\u4e3a\u5185\u5bb9\u7684\u5ef6\u8fdf\u53c8\u8bbe\u7f6e\u56de\u53bb\u4e86\n    Note.contentAjaxSeq++;\n    this.curNoteId = null;\n};\n\nNote.changeNote = function(selectNoteId, isShare, needSaveChanged, callback) {\n    var self = this;\n    if (!selectNoteId) {\n        return;\n    }\n    // 1 \u505c\u6b62\u5b9a\u65f6\u5668\n    Note.stopInterval();\n\n    // 3\n    var target = self.getTargetById(selectNoteId);\n    Note.selectTarget(target);\n\n    // 1 \u4e4b\u524d\u7684note, \u5224\u65ad\u662f\u5426\u5df2\u6539\u53d8, \u6539\u53d8\u4e86\u5c31\u8981\u4fdd\u5b58\u4e4b\n    // \u8fd9\u91cc, \u5728\u641c\u7d22\u7684\u65f6\u5019\u603b\u662f\u4fdd\u5b58, \u641c\u7d22\u7684\u8bdd, \u6bd4\u8f83\u5feb, \u80af\u5b9a\u6ca1\u6709\u53d8\u5316, \u5c31\u4e0d\u8981\u6267\u884c\u8be5\u64cd\u4f5c\n    if (needSaveChanged == undefined) {\n        needSaveChanged = true;\n    }\n    if (needSaveChanged) {\n        Note.curChangedSaveIt(true);\n    }\n\n    // 2. \u8bbe\u7a7a, \u9632\u6b62\u5728\u5185\u5bb9\u5f97\u5230\u4e4b\u524d\u53c8\u53d1\u751f\u4fdd\u5b58\n    Note.clearCurNoteId();\n    Note.inChangeNoteId = selectNoteId;\n\n    // 2 \u5f97\u5230\u73b0\u5728\u7684\n    // ajax\u4e4b\n    var cacheNote = self.getNote(selectNoteId);\n    if (!cacheNote) {\n        return;\n    }\n\n    Note.renderNote(cacheNote);\n\n    // \u8fd9\u91cc\u8981\u5207\u6362\u7f16\u8f91\u5668\n    switchEditor(cacheNote.IsMarkdown);\n    Note.hideEditorMask();\n\n    setTimeout(function() {\n        Attach.renderNoteAttachNum(selectNoteId, true);\n    });\n\n    // \u4e0b\u9762\u5f88\u6162\n    Note.contentAjaxSeq++;\n    var seq = Note.contentAjaxSeq;\n\n    function setContent(ret, fromCache, seq2) {\n        // \u627e\u4e0d\u5230\u5185\u5bb9, \u5c31\u4e00\u76f4loading\n        if (!ret) {\n            console.error('\u53d6\u4e0d\u5230\u5185\u5bb9');\n            return;\n        }\n\n        cacheNote.InitSync = false;\n\n        ret = ret || {};\n        Note.contentAjax = null;\n        if (seq2 != Note.contentAjaxSeq) {\n            return;\n        }\n        if (!fromCache) {\n            Note.setNoteCache(ret, false);\n        }\n        // \u628a\u5176\u5b83\u4fe1\u606f\u4e5f\u5e26\u4e0a\n        ret = Note.cache[selectNoteId]\n        Note.renderNoteContent(ret, false, seq2);\n\n        self.hideContentLoading();\n\n        callback && callback(ret);\n    }\n\n    // \u4e0d\u662f\u521a\u540c\u6b65\u8fc7\u6765\u7684, \u4e14\u6709\u5185\u5bb9\n    if (!cacheNote.InitSync && cacheNote.Content) {\n        setContent(cacheNote, true, seq);\n        return;\n    }\n\n    self.showContentLoading();\n    Service.noteService.getNoteContent(cacheNote.NoteId, (function(seq2) {\n        return function(ret) {\n            setContent(ret, false, seq2);\n        }\n    })(seq));\n};\n\n// \u91cd\u65b0\u6e32\u67d3\u7b14\u8bb0, \u56e0\u4e3async\u66f4\u65b0\u4e86\nNote.reRenderNote = function(noteId) {\n    var me = this;\n\n    me.showContentLoading();\n    var note = Note.getNote(noteId);\n    Note.renderNote(note);\n    NoteService.getNoteContent(noteId, function(noteContent) {\n        if (noteContent) {\n            Note.setNoteCache(noteContent, false);\n            // \u786e\u4fdd\u91cd\u7f6e\u7684\u662f\u5f53\u524dnote\n            if (Note.curNoteId === noteId) {\n                Attach.renderNoteAttachNum(noteId, true);\n                Note.renderNoteContent(noteContent, true);\n            }\n        }\n        me.hideContentLoading();\n    });\n};\n\n// \u66f4\u6539\u4fe1\u606f\u5230\u5de6\u4fa7\n// \u5b9a\u65f6\u66f4\u6539 \u5f53\u524d\u6b63\u5728\u7f16\u8f91\u7684\u4fe1\u606f\u5230\u5de6\u4fa7\u5bfc\u822a\n// \u6216change select. \u4e4b\u524d\u7684note, \u5df2\u7ecf\u6539\u53d8\u4e86\nNote.renderChangedNote = function(changedNote) {\n    if (!changedNote) {\n        return;\n    }\n\n    // \u627e\u5230\u5de6\u4fa7\u76f8\u5e94\u7684note\n    var $leftNoteNav = $(tt('#noteItemList [noteId=\"?\"]', changedNote.NoteId));\n    if (changedNote.Title) {\n        $leftNoteNav.find(\".item-title\").html(trimTitle(changedNote.Title));\n        // \u5982\u679c\u6807\u9898\u6539\u4e86, \u5982\u679c\u4e5f\u5728star\u5217\u8868\u4e2d, \u90a3\u4e5f\u8981\u6539star\u7684\u6807\u9898\u554a\n        Note.changeStarNoteTitle(changedNote.NoteId, trimTitle(changedNote.Title));\n    }\n\n    if ($leftNoteNav.hasClass(\"list-item\")) {\n        return; //list view\u53ea\u9700\u8981\u66f4\u65b0title\n    }\n\n    if (changedNote.Desc) {\n        $leftNoteNav.find(\".desc\").html(trimTitle(changedNote.Desc));\n    }\n    if (changedNote.ImgSrc) {\n        var $thumb = $leftNoteNav.find(\".item-thumb\");\n        // \u6709\u53ef\u80fd\u4e4b\u524d\u6ca1\u6709\u56fe\u7247\n        if ($thumb.length > 0) {\n            $thumb.find(\"img\").attr(\"src\", Note.fixImageSrc(changedNote.ImgSrc));\n        } else {\n            $leftNoteNav.append(tt('<div class=\"item-thumb\" style=\"\"><img src=\"?\"></div>', Note.fixImageSrc(changedNote.ImgSrc)));\n            $leftNoteNav.addClass(\"item-image\");\n        }\n        $leftNoteNav.find(\".item-desc\").removeAttr(\"style\");\n    } else if (changedNote.ImgSrc == \"\") {\n        $leftNoteNav.find(\".item-thumb\").remove(); // \u4ee5\u524d\u6709, \u73b0\u5728\u6ca1\u6709\u4e86\n        $leftNoteNav.removeClass(\"item-image\");\n    }\n};\n\n// \u6e05\u7a7a\u53f3\u4fa7note\u4fe1\u606f, \u53ef\u80fd\u662f\u5171\u4eab\u7684,\n// \u6b64\u65f6\u9700\u8981\u6e05\u7a7a\u53ea\u8bfb\u7684, \u4e14\u5207\u6362\u5230note edit\u6a21\u5f0f\u4e0b\nNote.clearNoteInfo = function() {\n    Note.clearCurNoteId();\n    Tag.input.clearTags();\n    $(\"#noteTitle\").val(\"\");\n    setEditorContent(\"\");\n\n    // markdown editor\n    /*\n    $(\"#wmd-input\").val(\"\");\n    $(\"#wmd-preview\").html(\"\");\n    */\n\n    // \u53ea\u9690\u85cf\u5373\u53ef\n    $(\"#noteRead\").hide();\n};\n\n// \u6e05\u9664noteList\u5bfc\u822a\nNote.clearNoteList = function() {\n    Note.noteItemListO.html(\"\"); // \u6e05\u7a7a\n}\n\n// \u6e05\u7a7a\u6240\u6709, \u5728\u8f6c\u6362notebook\u65f6\u4f7f\u7528\nNote.clearAll = function() {\n    // \u5f53\u524d\u7684\u7b14\u8bb0\u6e05\u7a7a\u6389\n    Note.clearCurNoteId();\n\n    Note.clearNoteInfo();\n    Note.clearNoteList();\n};\n\n// render\u5230\u7f16\u8f91\u5668\n// render note\nNote.renderNote = function(note) {\n    if (!note) {\n        return;\n    }\n    // title\n    $(\"#noteTitle\").val(note.Title);\n\n    // \u5f53\u524d\u6b63\u5728\u7f16\u8f91\u7684\n    // tags\n    Tag.input.setTags(note.Tags);\n};\n\n// render content\n// \u8fd9\u4e00\u6b65\u5f88\u6162\nNote.renderNoteContent = function(content, dontNeedSetReadonly, seq2) {\n    if (seq2 && seq2 != Note.contentAjaxSeq) {\n        return;\n    }\n    setEditorContent(content.Content, content.IsMarkdown, content.Preview, function() {\n        if (seq2 && seq2 != Note.contentAjaxSeq) {\n            return;\n        }\n        Note.setCurNoteId(content.NoteId);\n\n        if (!dontNeedSetReadonly) {\n            Note.toggleReadOnly();\n        }\n    });\n\n    // \u53ea\u6709\u5728renderNoteContent\u65f6\u624d\u8bbe\u7f6ecurNoteId\n    // Note.setCurNoteId(content.NoteId);\n\n    // \u91cd\u65b0\u6e32\u67d3\u5230\u5de6\u4fa7 desc, \u56e0\u4e3a\u7b14\u8bb0\u4f20\u8fc7\u6765\u662f\u6ca1\u6709desc\u7684\n    var $leftNoteNav = $(tt('#noteItemList [noteId=\"?\"]', content.NoteId));\n    if ($leftNoteNav.find(\".desc\").text() == \"\") {\n        Note.renderNoteDesc(content);\n    }\n};\n\nNote.renderNoteDesc = function(note) {\n    // life\n    // \u91cd\u65b0\u6e32\u67d3\u5230\u5de6\u4fa7 desc, \u56e0\u4e3a\u7b14\u8bb0\u4f20\u8fc7\u6765\u662f\u6ca1\u6709desc\u7684\n    note.Desc = Note.genDesc(note.Content);\n    note.ImgSrc = Note.getImgSrc(note.Content);\n    Note.renderChangedNote(note);\n};\n\nNote.showEditorMask = function() {\n    $(\"#editorMask\").css(\"z-index\", 10).show();\n    // \u8981\u5224\u65ad\u662f\u5426\u662f\u5783\u573e\u7b52\n    if (Notebook.curNotebookIsTrashOrAll()) {\n        $(\"#editorMaskBtns\").hide();\n        $(\"#editorMaskBtnsEmpty\").show();\n    } else {\n        $(\"#editorMaskBtns\").show();\n        $(\"#editorMaskBtnsEmpty\").hide();\n    }\n};\n\nNote.hideEditorMask = function() {\n    $(\"#editorMask\").css(\"z-index\", -10).hide();\n};\n\n// \u8fd9\u91cc\u5982\u679cnotes\u8fc7\u591a>100\u4e2a\u5c06\u4f1a\u5f88\u6162!!, \u4f7f\u7528setTimeout\u6765\u5206\u89e3\nNote.renderNotesC = 0;\n/**\n * [renderNotes description]\n * @param  {[type]}  notes      [description]\n * @param  {[type]}  forNewNote [description]\n * @param  {Boolean} hasSorted  \u662f\u5426\u5df2\u6392\u5e8f\u8fc7\n * @return {[type]}             [description]\n */\nNote.renderNotes = function(notes, forNewNote, hasSorted) {\n    var renderNotesC = ++Note.renderNotesC;\n    var isShared = false;\n\n    this.clearSeqForNew();\n    this.batch.reset();\n\n    // \u4e3a\u4e86\u5207\u6362\u6392\u5e8f\u65b9\u5f0f\u7528\n    Note._everNotes = notes;\n\n    // \u624b\u673a\u7aef\u4e0d\u7528\n    // slimScroll\u4f7f\u5f97\u624b\u673a\u7aef\u6eda\u52a8\u4e0d\u6d41\u7545\n    if (!LEA.isMobile && !Mobile.isMobile()) {\n        // $(\"#noteItemList\").slimScroll({ scrollTo: '0px', height: \"100%\", onlyScrollBar: true});\n        $(\"#noteItemList\").scrollTop(0); // ({ scrollTo: '0px', height: \"100%\", onlyScrollBar: true});\n    }\n\n    if (!notes || typeof notes != \"object\" || notes.length <= 0) {\n        // \u5982\u679c\u6ca1\u6709, \u90a3\u4e48\u662f\u4e0d\u662f\u5e94\u8be5hide editor?\n        if (!forNewNote) {\n            Note.showEditorMask();\n        }\n        return;\n    }\n    Note.hideEditorMask();\n    // \u65b0\u5efa\u7b14\u8bb0\u65f6\u4f1a\u5148\u521b\u5efa\u4e00\u4e2a\u65b0\u7b14\u8bb0, \u6240\u4ee5\u4e0d\u80fd\u6e05\u7a7a\n    if (forNewNote == undefined) {\n        forNewNote = false;\n    }\n    if (!forNewNote) {\n        Note.noteItemListO.html(\"\"); // \u6e05\u7a7a\n    }\n\n    // \u91cd\u7f6e\u83b7\u53d6\u5185\u5bb9\n    // console.trace('--------render notes-----------');\n    Note.resetGetNoteContentLazy();\n\n    // \u91cd\u65b0\u6392\u5e8f\n    if (!hasSorted) {\n\t    Note.sortNotes(notes);\n    }\n\n    // 20\u4e2a\u4e00\u6b21\n    var len = notes.length;\n    var c = Math.ceil(len / 20);\n\n    Note._renderNotes(notes, forNewNote, isShared, 1);\n\n    // \u5148\u8bbe\u7f6e\u7f13\u5b58\n    for (var i = 0; i < len; ++i) {\n        var note = notes[i];\n        // \u4e0d\u6e05\u7a7a\n        // \u4e4b\u524d\u662faddNoteCache, \u5982\u679c\u662f\u641c\u7d22\u51fa\u7684, \u4f1a\u628a\u5185\u5bb9\u90fd\u91cd\u7f6e\u4e86\n        Note.setNoteCache(note, false);\n    }\n\n    for (var i = 1; i < c; ++i) {\n        setTimeout(\n            (function(i) {\n                // \u9632\u6b62\u8fd8\u6ca1\u6e32\u67d3\u5b8c\u5c31\u70b9\u51fb\u53e6\u4e00\u4e2anotebook\u4e86\n                return function() {\n                    if (renderNotesC == Note.renderNotesC) {\n                        Note._renderNotes(notes, forNewNote, isShared, i + 1);\n                    }\n                }\n            })(i), i * 2000);\n    }\n};\n\nNote._getNoteHtmlObjct = function(note, isShared) {\n        var baseClasses = \"item-my\";\n        var classes = baseClasses;\n        if (note.IsDeleted) {\n            console.error('_getNoteHtmlObjct note.IsDeleted');\n            return;\n        }\n\n        var tmp;\n        if (note.ImgSrc) {\n            tmp = tt(Note.getItemTpl(), classes, this.newNoteSeq(), note.NoteId, Note.fixImageSrc(note.ImgSrc), note.Title || getMsg('UnTitled'), Notebook.getNotebookTitle(note.NotebookId), goNowToDatetime(note.UpdatedTime), note.Desc);\n        } else {\n            tmp = tt(Note.getItemTplNoImg(), classes, this.newNoteSeq(), note.NoteId, note.Title || getMsg('UnTitled'), Notebook.getNotebookTitle(note.NotebookId), goNowToDatetime(note.UpdatedTime), note.Desc);\n        }\n        // blog ?\n        var $tmp = $(tmp);\n        if (!note.IsBlog) {\n            $tmp.removeClass('item-b');\n        } else {\n            $tmp.addClass('item-b');\n        }\n        // star ?\n        if (note.Star) {\n            $tmp.addClass('item-is-star');\n        }\n\n        return tmp;\n    },\n    Note._renderNotes = function(notes, forNewNote, isShared, tang) { // \u7b2c\u51e0\u8d9f\n        var baseClasses = \"item-my\";\n\n        var len = notes.length;\n        for (var i = (tang - 1) * 20; i < len && i < tang * 20; ++i) {\n            var classes = baseClasses;\n\n            if (!forNewNote && i == 0) {\n                classes += \" item-active\";\n            }\n            var note = notes[i];\n            if (note.IsDeleted) {\n                console.error('note.IsDeleted');\n                continue;\n            }\n\n            note.Title = trimTitle(note.Title);\n            if (note.IsDirty || note.IsNew) {\n                classes += \" item-dirty\";\n            }\n            // \u4e0d\u662ftrash\u624d\u8981star, conflict fix\n            if (!note.IsTrash) {\n                // star ?\n                if (note.Star) {\n                    classes += ' item-is-star';\n                }\n                if (note.ConflictNoteId) {\n                    classes += ' item-conflict';\n                }\n            } else {\n                classes += ' item-is-trash';\n            }\n\n            if (note.Err) {\n                classes += ' item-err';\n            }\n\n            if (note.IsBlog) {\n                classes += ' item-b';\n            }\n\n            // \u8fd9\u91cc, \u5982\u679c\u6ca1\u6709\u5185\u5bb9, \u5219\u6dfb\u52a0\u5230\u5f02\u6b65\u6c60\u4e2d\n            if (note.InitSync) {\n                Note.addGetNoteContentLazy(note.NoteId);\n            }\n\n            if (!note.Desc && note.Content) {\n                note.Desc = Note.genDesc(note.Content);\n            }\n\n            var tmp;\n            if (note.ImgSrc) {\n                tmp = tt(Note.getItemTpl(), classes, i, note.NoteId, Note.fixImageSrc(note.ImgSrc), note.Title || getMsg('UnTitled'), Notebook.getNotebookTitle(note.NotebookId), goNowToDatetime(note.UpdatedTime), note.Desc || '');\n            } else {\n                tmp = tt(Note.getItemTplNoImg(), classes, i, note.NoteId, note.Title || getMsg('UnTitled'), Notebook.getNotebookTitle(note.NotebookId), goNowToDatetime(note.UpdatedTime), note.Desc || '');\n            }\n\n            Note.noteItemListO.append(tmp);\n        }\n    };\n\nNote._seqForNew = 0;\nNote.clearSeqForNew = function() {\n    this._seqForNew = 0;\n};\nNote.newNoteSeq = function() {\n    return --this._seqForNew;\n};\n\n// \u65b0\u5efa\u4e00\u4e2a\u7b14\u8bb0\n// \u8981\u5207\u6362\u5230\u5f53\u524d\u7684notebook\u4e0b\u53bb\u65b0\u5efa\u7b14\u8bb0\n// isShare\u65f6fromUserId\u624d\u6709\u7528\n// 3.8 add isMarkdown\nNote.newNote = function(notebookId, isShare, fromUserId, isMarkdown) {\n    var me = this;\n\n    // \u5207\u6362\u7f16\u8f91\u5668\n    switchEditor(isMarkdown);\n    Note.hideEditorMask();\n\n    Note.stopInterval();\n\n    Note.batch.reset();\n\n    // \u4fdd\u5b58\u5f53\u524d\u7684\u7b14\u8bb0\n    Note.curChangedSaveIt(true);\n\n    // \u65b0\u7b14\u8bb0\n    var note = {\n        NoteId: getObjectId(),\n        Title: '',\n        Tags: [],\n        Desc: '',\n        Content: '',\n        NotebookId: notebookId,\n        IsNew: true,\n        FromUserId: fromUserId,\n        IsMarkdown: isMarkdown,\n        CreatedTime: new Date(),\n        UpdatedTime: new Date()\n    }; // \u662f\u65b0\u7684\n\n    // \u6dfb\u52a0\u5230\u7f13\u5b58\u4e2d\n    Note.addNoteCache(note);\n    Note.clearCacheByNotebookId(notebookId);\n\n    // \u6e05\u7a7a\u9644\u4ef6\u6570\n    Attach.clearNoteAttachNum();\n\n    // \u662f\u5426\u662f\u4e3a\u5171\u4eab\u7684notebook\u6dfb\u52a0\u7b14\u8bb0, \u5982\u679c\u662f, \u5219\u8fd8\u8981\u8bb0\u5f55fromUserId\n    var newItem = \"\";\n\n    var baseClasses = \"item-my item-active\";\n\n    var notebook = Notebook.getNotebook(notebookId);\n    var notebookTitle = notebook ? notebook.Title : \"\";\n    var curDate = getCurDatetime();\n\n    newItem = tt(Note.getItemTplNoImg(), baseClasses, me.newNoteSeq(), note.NoteId, note.Title, notebookTitle, curDate, \"\");\n\n    newItem = $(newItem);\n    // newItem.find(\".item-blog\").hide();\n\n    // \u662f\u5426\u5728\u5f53\u524dnotebook\u4e0b, \u4e0d\u662f\u5219\u5207\u6362\u8fc7\u53bb, \u5e76\u5f97\u5230\u8be5notebook\u4e0b\u6240\u6709\u7684notes, \u8ffd\u52a0\u5230\u540e\u9762!\n    if (!Notebook.isCurNotebook(notebookId)) {\n        // \u5148\u6e05\u7a7a\u6240\u6709\n        Note.clearAll();\n\n        // \u63d2\u5165\u5230\u7b2c\u4e00\u4e2a\u4f4d\u7f6e\n        Note.noteItemListO.prepend(newItem);\n\n        // \u6539\u53d8\u4e3a\u5f53\u524d\u7684notebookId\n        // \u4f1a\u5f97\u5230\u8be5notebookId\u7684\u5176\u5b83\u7b14\u8bb0\n        Notebook.changeNotebookForNewNote(notebookId);\n    } else {\n        // \u63d2\u5165\u5230\u7b2c\u4e00\u4e2a\u4f4d\u7f6e\n        Note.noteItemListO.prepend(newItem);\n    }\n\n    Note.selectTarget($(tt('#noteItemList [noteId=\"?\"]', note.NoteId)));\n\n    setTimeout(function() {\n        $(\"#noteTitle\").focus();\n    });\n\n    Note.renderNote(note);\n    Note.renderNoteContent(note);\n    Note.setCurNoteId(note.NoteId);\n\n    // \u66f4\u65b0\u6570\u91cf\n    // Notebook.incrNotebookNumberNotes(notebookId);\n\n    // \u5207\u6362\u5230\u5199\u6a21\u5f0f\n    Note.toggleWriteable(true);\n};\n\n// \u540c\u6b65\nNote._syncRefreshE = $('#syncRefresh');\nNote._syncWarningE = $('#syncWarning');\nNote.showSpin = function() {\n    var me = this;\n    me._syncRefreshE.addClass('fa-spin');\n\n    // \u5982\u679c\u8d85\u8fc730\u79d2\u8fd8\u5728\u8f6c, \u8bc1\u660e\u6709\u95ee\u9898\u4e86\n    /*\n    setTimeout(function() {\n    \tif(me._syncRefreshE.hasClass('fa-spin')) {\n    \t\tme._syncRefreshE.removeClass('fa-spin');\n    \t\tNote.hideSyncProgress();\n    \t}\n    }, 30 * 1000);\n    */\n\n    // \u7981\u6b62\u81ea\u52a8\u4fdd\u5b58\n    me.stopInterval(true);\n};\nNote.hideSpin = function() {\n    var me = this;\n    me._syncRefreshE.removeClass('fa-spin');\n    // \u5f00\u59cb\u81ea\u52a8\u4fdd\u5b58\n    me.startInterval();\n};\n// nodejs\u8c03\u7528\nNote.syncFinished = function(hasError) {\n    var me = this;\n    me.hideSpin();\n    if (!hasError) {\n        me._syncWarningE.hide();\n    }\n    Note.hideSyncProgress();\n};\n// \u8fc7\u65f6\nNote.sync = function() {\n    var me = this;\n    me.showSpin();\n    SyncService.incrSync();\n    me.syncProgress(1);\n};\nNote._syncProgressO = $('#syncProgress');\nNote._syncProgressBarO = $('#syncProgressBar');\nNote.syncProgress = function(n) {\n    var me = this;\n    me._syncProgressO.removeClass('hide');\n    me._syncProgressBarO.css('width', n + '%');\n};\nNote.hideSyncProgress = function() {\n    var me = this;\n    // \u5347\u5230100, \u518d\u9690\u85cf\n    me.syncProgress(100);\n    setTimeout(function() {\n        me._syncProgressO.addClass('hide');\n    }, 1000);\n};\n\n// \u65ad\u7f51\u5904\u7406\n/*\n1. sync\u51fa\u73b0\u611f\u53f9\u53f7\n2. \u5982\u679c\u662f\u9700\u8981\u91cd\u65b0\u767b\u5f55, \u5219\u70b9\u51fb\u540e\u51fa\u73b0\u91cd\u65b0\u767b\u5f55\u7684\u754c\u9762\n*/\nNote.unConnected = function() {\n    var me = this;\n    me._syncWarningE.show();\n    SyncService.setSyncFinished(true);\n    me.hideSpin();\n    me._syncWarningE.data('reason', 'unConnected');\n    me._syncWarningE.attr('title', 'Network error');\n};\n// \u7f51\u7edc\u5df2\u7ecf\u8fde\u63a5\u597d\u4e86\nNote.connected = function() {\n    var me = this;\n    if (me._syncWarningE.data('reason') == 'unConnected') {\n    \tme._syncWarningE.data('reason', '-');\n    \tme._syncWarningE.hide();\n    }\n};\nNote.notLogin = function() {\n    var me = this;\n    me._syncWarningE.show();\n    me.hideSpin();\n    SyncService.setSyncFinished(true);\n    me._syncWarningE.data('reason', 'notLogin');\n    me._syncWarningE.attr('title', getMsg('You need to sign in Leanote'));\n};\nNote.needUpgradeAccount = function() {\n    var me = this;\n    me.hideSpin();\n    SyncService.setSyncFinished(true);\n    me._syncWarningE.show();\n    me._syncWarningE.data('reason', 'NEED-UPGRADE-ACCOUNT');\n    me._syncWarningE.attr('title', getMsg('You need to upgrade Leanote account'));\n};\n// \u70b9\u51fb\u611f\u53f9\u53f7, \u5904\u7406\u9519\u8bef\nNote.fixNetOrAuthError = function() {\n    var me = this;\n    var reason = me._syncWarningE.data('reason');\n\n    if (reason == 'unConnected') {\n        alert(getMsg('Network error, please check out your network.'));\n\n    } else if (reason == 'notLogin') {\n        alert(getMsg('You need to sign in Leanote'));\n        // \u5f39\u51fa\u767b\u5f55\u6846\u767b\u5f55\u4e4b, \u91cd\u65b0\u5f39\u51fa\n        toLogin();\n\n        // \u9700\u8981\u5347\u7ea7Leanote\n    } else if (reason == 'NEED-UPGRADE-ACCOUNT') {\n        alert(getMsg('You need to upgrade Leanote account'));\n        openExternal('https://leanote.com/pricing#buy');\n    }\n};\n\n// \u540c\u6b65\u8fdb\u5ea6\u663e\u793a\nNote.syncProcess = function(msg) {\n    $('#allProcess').hide();\n    $('#syncProcess').show().html(msg);\n    $('.loading-footer').show();\n};\n\n// \u4fdd\u5b58note ctrl + s\nNote.saveNote = function(e) {\n    var num = e.which ? e.which : e.keyCode;\n    // \u4fdd\u5b58\n    if ((e.ctrlKey || e.metaKey) && num == 83) { // ctrl + s or command + s\n        incrSync(true);\n        e.preventDefault();\n        return false;\n    } else {}\n\n    return;\n    // \u4ee5\u524d\u9700\u8981, \u4f46\u73b0\u5728\u662felectron, \u4e0d\u9700\u8981\n    // copy, paste\n    if (e.ctrlKey || e.metaKey) {\n        if (num == 67) { // ctrl + c\n            document.execCommand('copy');\n        } else if (num == 86) { // ctrl + v\n            // \u4e0d\u80fd\u8981, \u8981\u7684\u8bdd\u4f1a\u6709\u4e24\u6b21paste\n            // document.execCommand('paste');\n        } else if (num == 65) { // ctrl + a\n            document.execCommand('selectAll');\n        } else if (num == 88) { // ctrl + x\n            document.execCommand('cut');\n        }\n    }\n};\n\n// \u5220\u9664\u6216\u79fb\u52a8\u7b14\u8bb0\u540e, \u6e32\u67d3\u4e0b\u4e00\u4e2a\u6216\u4e0a\u4e00\u4e2a\nNote.changeToNext = function(target) {\n    var $target = $(target);\n    var next = $target.next();\n    if (!next.length) {\n        var prev = $target.prev();\n        if (prev.length) {\n            next = prev;\n        } else {\n            // \u5c31\u5b83\u4e00\u4e2a\n            Note.showEditorMask();\n            return;\n        }\n    }\n\n    Note.changeNote(next.attr(\"noteId\"));\n};\n\n// \u8981\u5220\u9664noteIds, \u627e\u4e0b\u4e00\u4e2a\u53ef\u4ee5\u7684\nNote.changeToNextSkipNotes = function(noteIds) {\n    var me = Note;\n    if (isEmpty(noteIds)) {\n        return;\n    }\n\n    // \u5168\u5220\u9664\u4e86\n    if (me.$itemList.find('li').length <= noteIds.length) {\n        me.showEditorMask();\n        return;\n    }\n\n    // \u5982\u679c\u53ea\u6709\u4e00\u4e2a\u7b14\u8bb0, \u4e14\u5f53\u524d\u6d3b\u8dc3\u7684\u53c8\u4e0d\u662f\u8981\u5220\u9664\u7684, \u5219\u4e0d\u7528change\n    if (noteIds.length == 1) {\n        var $actives = me.$itemList.find('.item-active');\n        if ($actives.length == 1 && $actives.attr('noteId') != noteIds[0]) {\n            return;\n        }\n    }\n\n    var $start = me.getTargetById(noteIds[0]);\n    var $next = $start.next();\n    var i = 1;\n    var len = noteIds.length;\n    var find = false;\n    while ($next.length) {\n        // \u8d85\u51fa\u4e86noteIds\n        if (i >= len) {\n            find = true;\n            break;\n        }\n        // \u4e0d\u5728\u5220\u9664\u7684\u5217\u8868\u4e2d\n        if ($next.attr('noteId') != me.getTargetById(noteIds[i]).attr('noteId')) {\n            find = true;\n            break;\n        }\n\n        $next = $next.next();\n        i++;\n    }\n\n    // \u627e\u4e0d\u5230, \u8bc1\u660e\u662f\u8981\u5230\u524d\u4e00\u4e2a\u4e86\n    if (!find) {\n        $next = $start.prev();\n    }\n\n    if ($next) {\n        me.changeNote($next.attr(\"noteId\"));\n    }\n};\n\n// \u5220\u9664\u7b14\u8bb0\nNote.deleteNote = function(target, contextmenuItem, isShared) {\n    var me = Note;\n\n    var noteIds;\n    if (me.inBatch) {\n        noteIds = me.getBatchNoteIds();\n    } else {\n        noteIds = [$(target).attr('noteId')];\n    }\n    if (isEmpty(noteIds)) {\n        return;\n    }\n\n    // \u5982\u679c\u5220\u9664\u7684\u662f\u5df2\u9009\u4e2d\u7684, \u8d76\u7d27\u8bbe\u7f6ecurNoteId = null\n    if (noteIds.length == 1 && $(target).hasClass(\"item-active\")) {\n        // -1 \u505c\u6b62\u5b9a\u65f6\u5668\n        Note.stopInterval();\n        // \u4e0d\u4fdd\u5b58\n        me.clearCurNoteId();\n        // \u6e05\u7a7a\u4fe1\u606f\n        Note.clearNoteInfo();\n    }\n\n    var $actives;\n    if (noteIds.length == 1) {\n        $actives = $(target);\n    } else {\n        $actives = me.$itemList.find('.item-active');\n    }\n\n    // 1\n    $actives.hide();\n    // 2\n    NoteService.deleteNote(noteIds, function(ret) {\n        if (ret) {\n            Note.changeToNextSkipNotes(noteIds);\n            $actives.remove();\n\n            // \u5220\u9664\u7f13\u5b58\n            for (var i = 0; i < noteIds.length; ++i) {\n                var noteId = noteIds[i];\n                var note = me.getNote(noteId);\n                if (note) {\n                    // \u53d6\u6d88star\n                    Note.unStar(noteId);\n\n                    /*\n                    \u7531\u540e\u7aef\u5230\u524d\u7aefrender\n                    if (!note.IsTrash) {\n                    \t// \u51cf\u5c11\u6570\u91cf\n                    \t// Notebook.minusNotebookNumberNotes(note.NotebookId);\n                    }\n                    */\n                    Note.clearCacheByNotebookId(note.NotebookId);\n\n                    // \u5220\u9664\u7f13\u5b58\n                    delete Note.cache[noteId];\n                }\n            }\n        }\n    });\n\n    me.batch.reset();\n    return;\n};\n\n// \u663e\u793a\u5171\u4eab\u4fe1\u606f\nNote.listNoteShareUserInfo = function(target) {\n    var noteId = $(target).attr(\"noteId\");\n    showDialogRemote(\"/share/listNoteShareUserInfo\", { noteId: noteId });\n}\n\n// \u5171\u4eab\u7b14\u8bb0\nNote.shareNote = function(target) {\n    var title = $(target).find(\".item-title\").text();\n    showDialog(\"dialogShareNote\", { title: getMsg(\"shareToFriends\") + \"-\" + title });\n\n    setTimeout(function() {\n        $(\"#friendsEmail\").focus();\n    }, 500);\n\n    var noteId = $(target).attr(\"noteId\");\n    shareNoteOrNotebook(noteId, true);\n}\n\n//---------------------------\n// \u641c\u7d22\n// \u6709\u70b9\u5c0f\u590d\u6742, \u56e0\u4e3a\u901f\u5ea6\u8fc7\u5feb\u4f1a\u5bfc\u81f4\u6ca1\u52a0\u8f7d\u5b8c, \u7136\u540e\u5c31\u4fdd\u5b58\u4e0a\u4e00\u4e2a => \u81f4\u4f7f\u6807\u9898\u6ca1\u6709\n// \u4e3a\u4ec0\u4e48\u4f1a\u6807\u9898\u6ca1\u6709?\nNote.lastSearch = null;\nNote.lastKey = null; // \u5224\u65ad\u662f\u5426\u4e0e\u4e0a\u4e00\u4e2a\u76f8\u7b49, \u76f8\u7b49\u5c31\u4e0d\u67e5\u8be2, \u5982\u679c\u662f\u7b49\u4e86\u5f88\u4e45\u518d\u6309enter?\nNote.lastSearchTime = new Date();\nNote.isOver2Seconds = false;\nNote.isSameSearch = function(key) {\n    // \u5224\u65ad\u65f6\u95f4\u662f\u5426\u8d85\u8fc7\u4e861\u79d2, \u8d85\u8fc7\u4e86\u5c31\u8ba4\u4e3a\u662f\u4e0d\u540c\u7684\n    var now = new Date();\n    var duration = now.getTime() - Note.lastSearchTime.getTime();\n    Note.isOver2Seconds = duration > 2000 ? true : false;\n    if (!Note.lastKey || Note.lastKey != key || duration > 1000) {\n        Note.lastKey = key;\n        Note.lastSearchTime = now;\n        return false;\n    }\n\n    if (key == Note.lastKey) {\n        return true;\n    }\n\n    Note.lastSearchTime = now;\n    Note.lastKey = key;\n    return false;\n}\n\n// \u641c\u7d22\u7b14\u8bb0\nNote.searchSeq = 0;\n\n// for recoverState\nNote.searchNoteSys = function(val, noteId) {\n    $(\"#searchNoteInput\").val(val);\n    var me = this;\n    NoteService.searchNote(val, function(notes) {\n        if (notes) {\n            Note.searchKey = val;\n            Notebook.changeCurNotebookTitle(getMsg('Search results'), false, notes.length, false, true);\n            Note.renderNotes(notes);\n            // markdown\u4e00\u65e6setContent\u5c31focus, \u5bfc\u81f4\u641c\u7d22\u5931\u53bb\u7126\u70b9\n            setTimeout(function() {\n                $(\"#searchNoteInput\").focus();\n            })\n            if (!isEmpty(notes)) {\n                Note.renderNotesAndTargetNote(notes, noteId, false);\n            }\n        } else {\n            // abort\u7684\n        }\n    });\n};\n\nNote.searchNote = function() {\n    var val = $(\"#searchNoteInput\").val();\n    if (!val) {\n        // \u5b9a\u4f4d\u5230all\n        Notebook.changeNotebook(\"0\");\n        return;\n    }\n    // \u5224\u65ad\u662f\u5426\u4e0e\u4e0a\u4e00\u4e2a\u662f\u76f8\u540c\u7684\u641c\u7d22, \u662f\u5219\u4e0d\u641c\u7d22\n    if (Note.isSameSearch(val)) {\n        return;\n    }\n\n    // \u4e4b\u524d\u6709, \u8fd8\u6709\u7ed3\u675f\u7684\n    // if(Note.lastSearch) {\n    // Note.lastSearch.abort();\n    // }\n\n    // \u6b65\u9aa4\u4e0etag\u7684\u641c\u7d22\u4e00\u6837\n    // 1\n    Note.curChangedSaveIt();\n\n    // 2 \u5148\u6e05\u7a7a\u6240\u6709\n    Note.clearAll();\n\n    // \u53d1\u9001\u8bf7\u6c42\u4e4b\n    // \u5148\u53d6\u6d88\u4e0a\u4e00\u4e2a\n    showLoading();\n\n    Note.searchSeq++;\n    var t = Note.searchSeq;\n    NoteService.searchNote(val, function(notes) {\n        hideLoading();\n        if (t == Note.searchSeq && notes) {\n            Note.searchKey = val;\n            Notebook.changeCurNotebookTitle(getMsg('Search results'), false, notes.length, false, true);\n            Note.renderNotes(notes);\n            // markdown\u4e00\u65e6setContent\u5c31focus, \u5bfc\u81f4\u641c\u7d22\u5931\u53bb\u7126\u70b9\n            setTimeout(function() {\n                $(\"#searchNoteInput\").focus();\n            })\n            if (!isEmpty(notes)) {\n                Note.changeNote(notes[0].NoteId, false /*, true || Note.isOver2Seconds*/ ); // isShare, needSaveChanged?, \u8d85\u8fc72\u79d2\u5c31\u8981\u4fdd\u5b58\n            }\n        } else {\n            // abort\u7684\n        }\n    });\n    // Note.lastSearch.abort();\n}\n\n//---------------\n//\u8bbe\u4e3ablog/unset\n\n\nNote.setNote2Blog = function(target, isBlog) {\n    var me = Note;\n\n    var noteIds;\n    if (me.inBatch) {\n        noteIds = me.getBatchNoteIds();\n    } else {\n        noteIds = [$(target).attr('noteId')];\n    }\n    if (isEmpty(noteIds)) {\n        return;\n    }\n\n    // \u662f\u65b0\u7b14\u8bb0 \u6216 \u5f53\u524d\u7b14\u8bb0\u5c31\u662f\u5b83\u7684, \u5219\u5148\u4fdd\u5b58\u4e4b\n    Note.curChangedSaveIt(true, function() {\n        NoteService.setNote2Blog(noteIds, isBlog, function(ret) {\n            if (ret) {\n                // \u89e6\u53d1\u540c\u6b65\n                incrSync();\n            }\n        });\n    });\n};\n\n// \u8bbe\u7f6enotebook\u7684blog\u72b6\u6001\n// \u5f53\u4fee\u6539notebook\u662f\u5426\u662fblog\u65f6\u8c03\u7528\nNote.setAllNoteBlogStatus = function(notebookId, isBlog) {\n    if (!notebookId) {\n        return;\n    }\n    var notes = Note.getNotesByNotebookId(notebookId);\n    if (!isArray(notes)) {\n        return;\n    }\n    var len = notes.length;\n    if (len == 0) {\n        for (var i in Note.cache) {\n            if (Note.cache[i].NotebookId == notebookId) {\n                Note.cache[i].IsBlog = isBlog;\n            }\n        }\n    } else {\n        for (var i = 0; i < len; ++i) {\n            notes[i].IsBlog = isBlog;\n        }\n    }\n};\n\n// \u79fb\u52a8\nNote.moveNote = function(target, data) {\n    var me = Note;\n    // \u6279\u91cf\u64cd\u4f5c\n    var noteIds;\n    if (Note.inBatch) {\n        noteIds = me.getBatchNoteIds();\n    } else {\n        noteIds = [$(target).attr('noteId')];\n    }\n\n    // \u5f53\u524d\u5728\u8be5\u7b14\u8bb0\u672c\u4e0b\n    var toNotebookId = data.notebookId;\n    if (Notebook.getCurNotebookId() == toNotebookId) {\n        return;\n    }\n\n    if (noteIds.length == 1) {\n        var note = me.getNote(noteIds[0]);\n        if (!note.IsTrash && note.NotebookId == toNotebookId) {\n            return;\n        }\n    }\n\n    NoteService.moveNote(noteIds, toNotebookId, function(ret) {\n        if (ret) {\n            me.clearCacheByNotebookId(toNotebookId);\n\n            for (var i = 0; i < noteIds.length; ++i) {\n                var noteId = noteIds[i];\n                var note = me.getNote(noteId);\n                if (note) {\n                    // \u4fee\u6539\u7b14\u8bb0\u6570\u91cf\n                    if (note.NotebookId != toNotebookId) {\n                        Notebook.incrNotebookNumberNotes(toNotebookId);\n                        if (!note.IsTrash) {\n                            Notebook.minusNotebookNumberNotes(note.NotebookId);\n                        }\n                    } else if (note.IsTrash) {\n                        Notebook.incrNotebookNumberNotes(note.NotebookId);\n                    }\n\n                    me.clearCacheByNotebookId(note.NotebookId);\n\n                    // \u8bbe\u7f6e\u7f13\u5b58\n                    note.NotebookId = toNotebookId;\n                    note.IsTrash = false;\n                    note.UpdatedTime = new Date();\n                    me.setNoteCache(note);\n                }\n            }\n\n            var $actives;\n            if (noteIds.length == 1) {\n                $actives = target;\n            } else {\n                $actives = me.$itemList.find('.item-active');\n            }\n            // \u4e0d\u5728all\u4e0b, \u5c31\u5220\u9664\u4e4b\n            if (!Notebook.curActiveNotebookIsAll()) {\n                me.changeToNextSkipNotes(noteIds);\n                $actives.remove();\n            }\n            // \u5728all\u4e0b, \u4e0d\u8981\u5220\u9664\n            else {\n                // \u4e0d\u79fb\u52a8, \u90a3\u4e48\u8981\u6539\u53d8\u5176notebook title\n                $actives.find(\".note-notebook\").html(Notebook.getNotebookTitle(toNotebookId));\n\n                me.changeNote($actives.eq(0).attr('noteId'));\n            }\n        }\n    });\n\n    // \u91cd\u7f6e, \u56e0\u4e3a\u53ef\u80fd\u79fb\u52a8\u540e\u7b14\u8bb0\u4e0b\u6ca1\u7b14\u8bb0\u4e86\n    me.batch.reset();\n};\n\n// \u590d\u5236\n// data\u662f\u81ea\u52a8\u4f20\u6765\u7684, \u662fcontextmenu\u6570\u636e\nNote.copyNote = function(target, data, isShared) {\n    var me = Note;\n\n    var toNotebookId = data.notebookId;\n    var noteIds;\n    if (Note.inBatch) {\n        noteIds = me.getBatchNoteIds();\n    } else {\n        noteIds = [$(target).attr('noteId')];\n    }\n\n    // \u5f97\u5230\u9700\u8981\u590d\u5236\u7684\n    var needNoteIds = [];\n    for (var i = 0; i < noteIds.length; ++i) {\n        var noteId = noteIds[i];\n        var note = me.getNote(noteId);\n        if (note) {\n            // trash\u4e0d\u80fd\u590d\u5236, \u4e0d\u80fd\u590d\u5236\u7ed9\u81ea\u5df1\n            // \u56e0\u4e3acontexmenu\u4e0d\u80fddisable\u6709\u5b50menu\u7684\u9879, \u6240\u4ee5\u5141\u8bb8\u590d\u5236trash\n            if ( /*note.IsTrash || */ note.NotebookId == toNotebookId) {\n                continue;\n            }\n            needNoteIds.push(noteId);\n        }\n    }\n    if (needNoteIds.length == 0) {\n        return;\n    }\n\n    NoteService.copyNote(needNoteIds, toNotebookId, function(notes) {\n        if (!isEmpty(notes)) {\n            // \u91cd\u65b0\u6e05\u7a7acache \u4e4b\u540e\u7684\n            Note.clearCacheByNotebookId(toNotebookId);\n            for (var i = 0; i < notes.length; ++i) {\n                var note = notes[i];\n                if (!note.NoteId) {\n                    continue;\n                }\n                // \u6539\u53d8\u7f13\u5b58, \u6dfb\u52a0\u4e4b\n                Note.setNoteCache(note);\n\n                // \u589e\u52a0\u6570\u91cf\n                Notebook.incrNotebookNumberNotes(toNotebookId)\n            }\n        }\n    });\n};\n\n// \u5220\u9664\u7b14\u8bb0\u6807\u7b7e\n// item = {noteId => usn}\nNote.deleteNoteTag = function(item, tag) {\n    if (!item) {\n        return;\n    }\n    // noteId => note\n    for (var noteId in item) {\n        var note = Note.getNote(noteId);\n        if (note) {\n            note.Tags = note.Tags || [];\n            for (var i = 0; i < note.Tags.length; ++i) {\n                if (note.Tags[i] == tag) {\n                    note.Tags.splice(i, 1);\n                    continue;\n                }\n            }\n            // \u5982\u679c\u5f53\u524d\u7b14\u8bb0\u662f\u5c55\u793a\u7684\u7b14\u8bb0, \u5219\u91cd\u65b0renderTags\n            if (noteId == Note.curNoteId) {\n                Tag.input.setTags(note.Tags);\n            }\n\n            Note.setNoteDirty(noteId, true);\n        }\n    }\n};\n\nNote.readOnly = true; // \u9ed8\u8ba4\u4e3atrue\nLEA.readOnly = true;\n// \u5207\u6362\u53ea\u8bfb\u6a21\u5f0f\nNote.toggleReadOnly = function(needSave) {\n    var me = this;\n    var note = me.getCurNote();\n\n    // tinymce\n    var $editor = $('#editor');\n    $editor.addClass('read-only').removeClass('all-tool'); // \u4e0d\u8981\u5168\u90e8\u7684\n\n    // \u4e0d\u53ef\u5199\n    $('#editorContent').attr('contenteditable', false);\n\n    // markdown\n    $('#mdEditor').addClass('read-only');\n    $('#note').addClass('read-only-editor');\n\n    if (!note) {\n        return;\n    }\n\n    if (note.IsMarkdown) {\n        $('#mdInfoToolbar .created-time').html(goNowToDatetime(note.CreatedTime));\n        $('#mdInfoToolbar .updated-time').html(goNowToDatetime(note.UpdatedTime));\n    } else {\n        $('#infoToolbar .created-time').html(goNowToDatetime(note.CreatedTime));\n        $('#infoToolbar .updated-time').html(goNowToDatetime(note.UpdatedTime));\n    }\n\n    // \u4fdd\u5b58\u4e4b\n    if (needSave) {\n        Note.curChangedSaveIt(true);\n    }\n\n    Note.readOnly = true;\n    LEA.readOnly = true;\n\n    if (!note.IsMarkdown) {\n        // \u91cc\u9762\u7684pre\u4e5f\u8bbe\u4e3a\u4e0d\u53ef\u5199\n        $('#editorContent pre').each(function() {\n            LeaAce.setAceReadOnly($(this), true);\n        });\n    }\n};\n\n// \u5207\u6362\u5230\u7f16\u8f91\u6a21\u5f0f\nLEA.toggleWriteable = Note.toggleWriteable = function(isFromNewNote) {\n    var me = Note;\n    var note = me.getCurNote();\n    if (note) {\n        if (note.InitSync) {\n            alert('Waiting for loading content from server');\n            return;\n        }\n    }\n\n    // $('#infoToolbar').hide();\n    $('#editor').removeClass('read-only');\n    $('#note').removeClass('read-only-editor');\n    $('#editorContent').attr('contenteditable', true);\n\n    // markdown\n    $('#mdEditor').removeClass('read-only');\n\n    if (!note) {\n        return;\n    }\n\n    Note.readOnly = false;\n    LEA.readOnly = false;\n\n    if (!note.IsMarkdown) {\n        // \u91cc\u9762\u7684pre\u4e5f\u8bbe\u4e3a\u4e0d\u53ef\u5199\n        $('#editorContent pre').each(function() {\n            LeaAce.setAceReadOnly($(this), false);\n        });\n\n        isFromNewNote || tinymce.activeEditor.focus();\n    } else {\n        if (MD) {\n            isFromNewNote || MD.focus();\n            MD.onResize();\n        }\n    }\n};\n\nNote.toggleWriteableAndReadOnly = function() {\n    if (LEA.readOnly) {\n        Note.toggleWriteable();\n    } else {\n        Note.toggleReadOnly(true);\n    }\n};\n\n// \u6e32\u67d3\u5217\u8868\nNote.starNotes = [];\nNote.starItemT = '<li data-id=\"?\"><a>?<span class=\"delete-star\" title=\"' + getMsg('Remove') + '\">X</span></a></li>';\nNote.starNotesO = $('#starNotes');\nNote.renderStars = function(notes) {\n    var me = this;\n    var notes = notes || me.starNotes;\n    me.starNotes = notes;\n    me.starNotesO.html('');\n    for (var i = 0; i < notes.length; ++i) {\n        var note = notes[i];\n        var t = tt(me.starItemT, note.NoteId, note.Title || getMsg('Untitled'));\n        me.starNotesO.append(t);\n    }\n\n    if (notes.length == 0) {\n        me.starNotesO.html('<p class=\"no-info\">' + getMsg('No Starred Note') + '</p>');\n    }\n};\n\n// \u70b9\u51fb\u7b14\u8bb0, \u5224\u65ad\u662f\u5426\u5728star\u4e2d, \u5982\u679c\u5728, \u5219\u4e5f\u9009\u4e2d\nNote.selectStar = function(noteId) {\n    var me = this;\n    var target = me.starNotesO.find('li[data-id=\"' + noteId + '\"]');\n    me.starNotesO.find('li').removeClass('selected');\n    target.addClass('selected');\n};\n\n// \u70b9\u51fb, note\nNote.renderStarNote = function(target) {\n    var me = this;\n    var noteId = target.data('id');\n    // \u5982\u679c\u6ca1\u6709target, \u5219\u9009\u7b2c\u4e00\u4e2a\n    if (!noteId) {\n        target = me.starNotesO.find('li').eq(0);\n    }\n    var noteId = target.data('id');\n    if (!noteId) {\n        return;\n    }\n    me.starNotesO.find('li').removeClass('selected');\n    target.addClass('selected');\n\n\n    // \u5927BUG start\n    // \u5148\u4fdd\u5b58\u73b0\u6709\u7684\u554a\n    me.curChangedSaveIt();\n\n    // \u628a\u5f53\u524d\u7b14\u8bb0\u653e\u5728\u7b2c\u4e00\u4f4d\n    me.clearAll();\n\n    // \u5982\u679c\u6570\u636e\u6539\u4e86, me.starNotes \u7684content\u4e0d\u662f\u6700\u65b0\u7684\n    me.starNotes || (me.starNotes = []);\n    for (var i = 0; i < me.starNotes.length; ++i) {\n        me.starNotes[i] = me.getNote(me.starNotes[i].NoteId);\n    }\n    // \u5927BUG end\n\n    me.renderNotes(me.starNotes);\n    me.changeNoteForPjax(noteId, true, false);\n    me.directToNote(noteId);\n\n    // $('#curNotebookForLisNote').text(\"Starred\");\n    Notebook.changeCurNotebookTitle(getMsg('Starred'), true);\n};\n\n// \u7b14\u8bb0\u6807\u9898\u6539\u4e86\u540e, \u5982\u679c\u5728star\u4e2d, \u5219\u4e5f\u8981\u6539\u6807\u9898\nNote.changeStarNoteTitle = function(noteId, title) {\n    var me = this;\n    var cacheNote = me.getNote(noteId);\n    /*\n    if(!cacheNote.Star) {\n    \treturn;\n    }\n    */\n\n    var target = me.starNotesO.find('li[data-id=\"' + noteId + '\"]');\n    if (target.length == 1) {\n        target.find('a').html((title || 'Untitled') + '<span class=\"delete-star\" title=\"' + getMsg('Remove') + '\">X</span>');\n    }\n};\n\n// \u53d6\u6d88star, note delete/trash\u65f6\u53d6\u6d88star\nNote.unStar = function(noteId) {\n    var me = this;\n\n    // \u5220\u9664\u8be5stars\n    var has = false;\n    for (var i = 0; i < me.starNotes.length; ++i) {\n        var tNote = me.starNotes[i];\n        if (tNote.NoteId == noteId) {\n            var has = true;\n            me.starNotes.splice(i, 1);\n            break;\n        }\n    }\n\n    if (has) {\n        // \u91cd\u65b0\u6e32\u67d3\u4e4b\n        me.renderStars(me.starNotes);\n    }\n};\n\n// \u6536\u85cf\u6216\u53d6\u6d88\u6536\u85cf\nNote.star = function(noteId) {\n    var me = this;\n    var note = me.getNote(noteId);\n    if (!note || note.IsTrash) {\n        return;\n    }\n    var $target = $('[noteId=\"' + noteId + '\"]');\n    NoteService.star(noteId, function(ok, isStarred) {\n        if (ok) {\n            note.Star = isStarred;\n            if (isStarred) {\n                me.starNotes.unshift(note);\n                $target.addClass('item-is-star');\n            } else {\n                $target.removeClass('item-is-star');\n                // \u5220\u9664\u8be5stars\n                for (var i = 0; i < me.starNotes.length; ++i) {\n                    var tNote = me.starNotes[i];\n                    if (tNote.NoteId == noteId) {\n                        me.starNotes.splice(i, 1);\n                        break;\n                    }\n                }\n            }\n\n            // \u91cd\u65b0\u6e32\u67d3\u4e4b\n            me.renderStars(me.starNotes);\n        }\n    });\n};\n\n// \u663e\u793a\nNote._curFixNoteId = ''; // \u5f53\u524d\u8981\u5904\u7406\u7684\nNote._curFixNoteTarget = '';\nNote._conflictTipsElem = $('#conflictTips');\nNote._showConflictInfoInited = false;\n// \u521d\u59cb\u5316\u4e8b\u4ef6\nNote._initshowConflictInfo = function() {\n    var me = this;\n\n    // \u70b9\u51fb\u4e0e\u4e4b\u51b2\u7a81\u7684\u7b14\u8bb0, \u5219\u5c06\u8be5\u7b14\u8bb0\u663e\u793a\u5230\u5b83\u524d\u9762, \u5e76\u9009\u4e2d\n    Note._conflictTipsElem.find('.conflict-title').click(function() {\n        var conflictNoteId = $(this).data('id');\n        var conflictNote = me.getNote(conflictNoteId);\n        if (!conflictNote) {\n            alert('The note is not exists');\n            return;\n        }\n        // \u662f\u5426\u5728\u8be5\u5217\u8868\u4e2d?\n        var target = $(tt('#noteItemList [noteId=\"?\"]', conflictNoteId)); //\n        // \u5982\u679c\u5f53\u524d\u7b14\u8bb0\u5728\u7b14\u8bb0\u5217\u8868\u4e2d, \u90a3\u4e48\u751f\u6210\u4e00\u4e2a\u65b0\u7b14\u8bb0\u653e\u5728\u8fd9\u4e2a\u7b14\u8bb0\u4e0a\u9762\n        if (target.length > 0) {} else {\n            target = me._getNoteHtmlObjct(conflictNote);\n        }\n        // console.log(\">....>\");\n        // console.log(me._curFixNoteTarget);\n        // console.log(target);\n\n        target.insertAfter(me._curFixNoteTarget);\n        // alert(3);\n        // me._curFixNoteTarget.insertBefore(target);\n        // \u9009\u4e2d\u4e0e\u4e4b\u51b2\u7a81\u7684\u7b14\u8bb0\n        me.changeNote(conflictNoteId);\n    });\n};\nNote.showConflictInfo = function(target, e) {\n    var me = this;\n\n    var $li = $(target).closest('li');\n    var noteId = $li.attr('noteId');\n\n    var note = me.getNote(noteId);\n    if (!note) {\n        return;\n    }\n    var conflictNoteId = note.ConflictNoteId;\n\n    function conflictIsFixed() {\n        // \u53bb\u6389item-confict class\n        // \u5e76\u4e14\u6539\u53d8\n        $li.removeClass('item-conflict');\n        note.ConflictNoteId = \"\";\n        NoteService.conflictIsFixed(noteId);\n    }\n    if (!conflictNoteId) {\n        return conflictIsFixed();\n    }\n\n    var conflictNote = me.getNote(conflictNoteId);\n    if (!conflictNote) {\n        return conflictIsFixed();\n    }\n\n    me._curFixNoteId = noteId;\n    me._curFixNoteTarget = $li;\n\n    if (!me._showConflictInfoInited) {\n        me._showConflictInfoInited = true;\n        me._initshowConflictInfo();\n    }\n\n    // \u521d\u59cb\u5316\u6570\u636e\n    var titleElem = Note._conflictTipsElem.find('.conflict-title');\n    titleElem.text(conflictNote.Title);\n    titleElem.data('id', conflictNoteId);\n    Note._conflictTipsElem.find('.conflict-resolved').prop('checked', false);\n\n    ContextTips.show('#conflictTips', e, function() {\n        if (Note._conflictTipsElem.find('.conflict-resolved').prop('checked')) {\n            conflictIsFixed();\n        }\n    });\n};\n\n// \u5185\u5bb9\u5df2\u540c\u6b65\u6210\u529f\nNote.contentSynced = function(noteId, content) {\n    var me = this;\n    var note = me.getNote(noteId);\n    if (!note) {\n        // \u53ef\u80fd\u4e4b\u524d\u8fd8\u6ca1\u6709\n        // me.setNoteCache(noteId, {Content: content});\n        return;\n    }\n    if (note.InitSync) {\n        // \u91cd\u65b0render\u5185\u5bb9\n        note.InitSync = false;\n        note.Content = content;\n        if (me.curNoteId == noteId || me.inChangeNoteId == noteId) {\n            // alert(note.Title);\n            // \u91cd\u65b0\u6e32\u67d3\n            // alert(me.curNoteId == noteId); false\n            // alert(me.inChangeNoteId == noteId); true\n            Note.reRenderNote(noteId);\n        } else {\n            // \u751f\u6210desc\n            me.renderNoteDesc(note);\n        }\n    }\n};\n\n//------------------------\n// \u5f02\u6b65\u52a0\u8f7dnote content\n\n// \u6c60, \u6700\u592710\u4e2a\nNote._loadContentPool = [];\nNote._loadContentPoolSeq = 0;\nNote._startedGetNoteContentLazy = false;\nNote._stopGetNoteContentLazy = false;\n\nNote._loadContentRunSeq = 0;\n\nNote._loadContentStarted = {};\n\n// \u5728render notes\u65f6\n// \u5ef6\u8fdf\u52a0\u8f7d\u5185\u5bb9\n\n// \u91cd\u65b0render notes\u65f6, \u91cd\u7f6epool\nNote.resetGetNoteContentLazy = function() {\n    var me = this;\n    me._loadContentPool = [];\n    me._loadContentPoolSeq = 0;\n    me._stopGetNoteContentLazy = false;\n    me._startedGetNoteContentLazy = false;\n    me._loadContentRunSeq++;\n};\n\n// \u6dfb\u52a0\u5230\u6c60\u5b50\u4e2d\nNote.addGetNoteContentLazy = function(noteId) {\n    var me = this;\n    Note._loadContentPool.push(noteId);\n    me.startGetNoteContentLazy();\n};\n\n// render notes\u540e,\n// \u5f00\u59cb\u52a0\u8f7d\nNote.startGetNoteContentLazy = function() {\n    var me = this;\n\n    if (me._loadContentStarted[me._loadContentRunSeq]) {\n        return;\n    }\n    me._loadContentStarted[me._loadContentRunSeq] = true;\n\n    me.getNoteContentLazy(me._loadContentRunSeq);\n};\n\n// \u5f97\u5230\u4e0b\u4e00\u4e2a\u8981\u5904\u7406\u7684noteId\nNote._getNextNoteId = function() {\n    var me = this;\n    var noteId = me._loadContentPool[me._loadContentPoolSeq];\n    me._loadContentPoolSeq++;\n    return noteId;\n};\n\nNote.getNoteContentLazy = function(runSeq) {\n    var me = this;\n\n    // // \u6682\u505c\u4e86\n    // if (me._stopGetNoteContentLazy) {\n    // \treturn;\n    // }\n\n    // \u4e0d\u662f\u4e00\u4e2a\u65f6\u5019\u4e86\n    if (runSeq != me._loadContentRunSeq) {\n        console.log('\u4e0d\u662f\u4e00\u4e2a\u65f6\u5019\u4e86 ' + runSeq + '_' + me._loadContentRunSeq);\n        return;\n    }\n\n    var noteId = me._getNextNoteId();\n    if (!noteId) {\n        return;\n    }\n\n    var note = me.getNote(noteId);\n    if (note && !note.InitSync) {\n        console.log('\u4e0d\u7528\u52a0\u8f7d');\n        me.getNoteContentLazy(runSeq);\n        return;\n    }\n\n    console.log('\u6b63\u5728\u52a0\u8f7d....' + noteId);\n\n    setTimeout(function() {\n        NoteService.getNoteContent(noteId, function(contentO) {\n            if (typeof contentO == 'object') {\n                Note.contentSynced(noteId, contentO.Content);\n                me.getNoteContentLazy(runSeq);\n            }\n        });\n    }, 800);\n};\n\nNote.stopGetNoteContentLazy = function() {\n    var me = this;\n    me._stopGetNoteContentLazy = true;\n};\n\nNote.target = null; // \u5f53\u524d\u5904\u7406\u7684note\nNote.menuItemsForMove = {}; // notebookId => menu\nNote.menuItemsForCopy = {}; // notebookId => menu\nNote.getContextNotebooksSys = function(notebooks) {\n\n    var submenuMoves = new gui.Menu();\n    var submenuCopys = new gui.Menu();\n\n    for (var i in notebooks) {\n        (function(j) {\n            var notebook = notebooks[j];\n\n            var moveMenu = {\n                label: notebook.Title,\n                click: function() {\n                    Note.moveNote(Note.target, { notebookId: notebook.NotebookId });\n                }\n            };\n            var copyMenu = {\n                label: notebook.Title,\n                click: function() {\n                    Note.copyNote(Note.target, { notebookId: notebook.NotebookId });\n                }\n            };\n\n            if (!isEmpty(notebook.Subs)) {\n                var mc = Note.getContextNotebooksSys(notebook.Subs);\n                moveMenu.submenu = mc[0];\n                moveMenu.type = 'submenu';\n                copyMenu.submenu = mc[1];\n                copyMenu.type = 'submenu';\n            }\n\n            var move = new gui.MenuItem(moveMenu);\n            var copy = new gui.MenuItem(copyMenu);\n\n            Note.menuItemsForMove[notebook.NotebookId] = move;\n            Note.menuItemsForCopy[notebook.NotebookId] = copy;\n\n            submenuMoves.append(move);\n            submenuCopys.append(copy);\n\n        })(i);\n    }\n    return [submenuMoves, submenuCopys];\n};\n\n// Notebook\u8c03\u7528\nNote.contextmenu = null;\nNote.notebooksCopy = []; // share\u4f1a\u7528\u5230\nNote.initContextmenu = function() {\n    var self = Note;\n    var notebooks = Notebook.everNotebooks;\n\n    //-------------------\n    // \u53f3\u952e\u83dc\u5355\n    function noteMenu() {\n\n        var me = this;\n        // this.target = '';\n        this.menu = new gui.Menu();\n        this.del = new gui.MenuItem({\n            label: getMsg(\"Delete\"),\n            click: function(e) {\n                Note.deleteNote(self.target);\n            }\n        });\n\n        this.publicBlog = new gui.MenuItem({\n            label: getMsg(\"Public as blog\"),\n            click: function(e) {\n                Note.setNote2Blog(self.target, true);\n            }\n        });\n        this.unPublicBlog = new gui.MenuItem({\n            label: getMsg(\"Cancel public\"),\n            click: function(e) {\n                Note.setNote2Blog(self.target, false);\n            }\n        });\n\n        // var ms = Note.getContextNotebooksSys(notebooks);\n        // this.move.submenu = ms[0];\n        // this.copy.submenu = ms[1];\n\n        this.move = new gui.MenuItem({\n            label: getMsg(\"Move\"),\n            click: function(e) {\n                dialogOperateNotes({ notebooks: notebooks, func: 'move' });\n            }\n        });\n        this.copy = new gui.MenuItem({\n            label: getMsg(\"Copy\"),\n            click: function(e) {\n                dialogOperateNotes({ notebooks: notebooks, func: 'copy' });\n            }\n        });\n\n        function dialogOperateNotes(options) {\n            $(\"#leanoteDialog #modalTitle\").html(getMsg(\"selectNotebook\"));\n\n            $(\"#leanoteDialog .modal-body\").html('<p><strong>' + getMsg(\"doubleClick\") + '</strong></p><ul id=\"notebookTree\" class=\"ztree showIcon\"></ul>');\n            $(\"#leanoteDialog .modal-footer\").html('\\\n            \t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">' + getMsg(\"Close\") + '</button>\\\n            \t');\n            var callback;\n            if ('move' == options.func) {\n                callback = function(notebookId) {\n                    Note.moveNote(Note.target, { notebookId: notebookId });\n                }\n            } else if ('copy' == options.func) {\n                callback = function(notebookId) {\n                    Note.copyNote(Note.target, { notebookId: notebookId });\n                }\n            }\n            var notebookTree = $.fn.zTree.init($(\"#notebookTree\"), Notebook.getSimpleTreeSetting({ callback: callback }), options.notebooks);\n            delete options.title;\n            options.show = true;\n            $(\"#leanoteDialog\").modal(options);\n        }\n\n        // \u672c\u5730\u7b14\u8bb0\u4e0d\u80fd\u516c\u5f00\u4e3a\u535a\u5ba2\n        if (!UserInfo.IsLocal) {\n            this.menu.append(this.publicBlog);\n            this.menu.append(this.unPublicBlog);\n            this.menu.append(gui.getSeparatorMenu());\n        }\n\n        this.menu.append(this.del);\n        this.menu.append(gui.getSeparatorMenu());\n\n        this.menu.append(this.move);\n        this.menu.append(this.copy);\n\n        // \u5bfc\u51fa\n        var exportsSubMenus = new gui.Menu();\n        var exportMenus = Api.getExportMenus() || [];\n        for (var i = 0; i < exportMenus.length; ++i) {\n            (function(j) {\n\n                var menu = exportMenus[j];\n                var clickBac = menu.click;\n\n                var menuItem = new gui.MenuItem({\n                    label: menu.label,\n                    click: function(e) {\n                        if (Note.inBatch) {\n                            var noteIds = Note.getBatchNoteIds();\n                        } else {\n                            var noteIds = [$(self.target).attr('noteId')];\n                        }\n                        // var note = Note.getNote();\n                        clickBac && clickBac(noteIds);\n                    }\n                });\n\n                exportMenus[i].menu = menuItem;\n\n                exportsSubMenus.append(menuItem);\n            })(i);\n        }\n\n        if (exportMenus.length > 0) {\n            this.exports = new gui.MenuItem({\n                label: getMsg('Export'),\n                submenu: exportsSubMenus,\n                click: function(e) {}\n            });\n\n            this.menu.append(gui.getSeparatorMenu());\n            this.menu.append(this.exports);\n        }\n\n        this.enable = function(name, ok) {\n                this[name].enabled = ok;\n            }\n            // \u63a7\u5236disable\n        this.popup = function(e, target) {\n            self.target = target;\n            var noteIds;\n            if (Note.inBatch) {\n                noteIds = Note.getBatchNoteIds();\n            } else {\n                noteIds = [$(target).attr(\"noteId\")];\n            }\n\n            // \u5bfc\u51fa\u7684enabled\n            for (var i = 0; i < exportMenus.length; ++i) {\n                exportMenus[i].menu.enabled = exportMenus[i].enabled(noteIds);\n            }\n\n            // \u6279\u91cf, \u9664\u4e86\u5bfc\u51fapdf\u90fd\u53ef\u4ee5\u64cd\u4f5c\n            if (Note.inBatch) {\n                this.copy.enabled = true;\n                this.move.enabled = true;\n                this.publicBlog.enabled = true;\n                this.unPublicBlog.enabled = true;\n            } else {\n                var note = Note.getNote(noteIds[0]);\n                if (!note) {\n                    return;\n                }\n\n                if (note.IsTrash || Notebook.curNotebookIsTrash()) {\n                    this.copy.enabled = false; // \u6ca1\u7528\n                    this.publicBlog.enabled = false;\n                    this.unPublicBlog.enabled = false;\n                } else {\n                    this.copy.enabled = true;\n\n                    if (note.IsBlog) {\n                        this.publicBlog.enabled = false;\n                        this.unPublicBlog.enabled = true;\n                    } else {\n                        this.publicBlog.enabled = true;\n                        this.unPublicBlog.enabled = false;\n                    }\n                }\n            }\n\n            // this.menu.popup(gui.getCurrentWindow(), e.originalEvent.x, e.originalEvent.y);\n            this.menu.popup(gui.getCurrentWindow(), e.pageX, e.pageY);\n        }\n    }\n\n    var noteMenuSys = new noteMenu();\n\n    Note.noteMenuSys = noteMenuSys;\n};\n\n// \u9644\u4ef6\n// \u7b14\u8bb0\u7684\u9644\u4ef6\u9700\u8981ajax\u83b7\u53d6\n// \u5efa\u4e00\u5f20\u9644\u4ef6\u8868? attachId, noteId, \u5176\u5b83\u4fe1\u606f\n// note\u91cc\u6709attach_nums\u5b57\u6bb5\u8bb0\u5f55\u4e2a\u6570\n// [ok]\nvar Attach = {\n    loadedNoteAttachs: {}, // noteId => [attch1Info, attach2Info...] // \u6309\u7b14\u8bb0\n    attachsMap: {}, // attachId => attachInfo\n    getAttach: function(attachId) {\n        return this.attachsMap[attachId];\n    },\n    init: function() {\n        var self = this;\n        var me = this;\n        // \u663e\u793aattachs\n        $(\"#showAttach\").click(function() {\n            self.renderAttachs(Note.curNoteId);\n        });\n        // \u9632\u6b62\u70b9\u51fb\u9690\u85cf\n        self.attachListO.click(function(e) {\n            e.stopPropagation();\n        });\n        // \u5220\u9664\n        self.attachListO.on(\"click\", \".delete-attach\", function(e) {\n            e.stopPropagation();\n            var attachId = $(this).closest('li').data(\"id\");\n            var t = this;\n            if (confirm(getMsg(\"Are you sure to delete it ?\"))) {\n                // $(t).button(\"loading\");\n                self.deleteAttach(attachId);\n                // $(t).button(\"reset\");\n            }\n        });\n        // \u4e0b\u8f7d\n        var curAttachId = '';\n        self.attachListO.on(\"click\", \".download-attach\", function(e) {\n            e.stopPropagation();\n            var $li = $(this).closest('li');\n            var attachId = $li.data(\"id\");\n            var title = $li.find('.attach-title').text();\n\n            gui.dialog.showSaveDialog(gui.getCurrentWindow(), { title: title, defaultPath: gui.app.getPath('userDesktop') + '/' + title }, function(targetPath) {\n                if (targetPath) {\n                    var curAttach = me.getAttach(attachId);\n                    if (curAttach) {\n                        FileService.download(curAttach.Path, targetPath, function(ok, msg) {\n                            if (!ok) {\n                                Notify.show({ type: 'warning', title: 'Warning', body: 'File saved failed!' });\n                            } else {\n                                Notify.show({ title: 'Info', body: 'File saved successful!' });\n                            }\n                        });\n                    } else {\n                        alert('error');\n                    }\n                } else {}\n            });\n        });\n\n        // make link\n        self.attachListO.on(\"click\", \".link-attach\", function(e) {\n            e.stopPropagation();\n            var attachId = $(this).closest('li').data(\"id\");\n            var attach = self.attachsMap[attachId];\n            var src = EvtService.getAttachLocalUrl(attachId); // + \"/attach/download?attachId=\" + attachId;\n            // http://leanote.com/attach/download?attachId=54f7481638f4112ff000170f\n\n            Note.toggleWriteable();\n            if (LEA.isMarkdownEditor() && MD) {\n                MD.insertLink(src, attach.Title);\n            } else {\n                tinymce.activeEditor.insertContent('<a target=\"_blank\" href=\"' + src + '\">' + attach.Title + '</a>');\n            }\n        });\n\n        // \u6dfb\u52a0Attach\n        $('#chooseFile').click(function() {\n            gui.dialog.showOpenDialog(gui.getCurrentWindow(), {\n                    defaultPath: gui.app.getPath('userDesktop'),\n                    properties: ['openFile', 'multiSelections']\n                },\n                function(paths) {\n                    if (!paths) {\n                        return;\n                    }\n\n                    // \u5982\u679c\u662f\u65b0\u5efa\u7684\u7b14\u8bb0, \u5fc5\u987b\u5148\u4fdd\u5b58note\n                    var note = Note.getCurNote();\n                    if (note && note.IsNew) {\n                        Note.curChangedSaveIt(true);\n                    }\n\n                    FileService.addAttach(paths, Note.curNoteId, function(files) {\n                        if (files) {\n                            me.addAttachs(files);\n                        }\n                    });\n                }\n            );\n        });\n    },\n    attachListO: $(\"#attachList\"),\n    attachNumO: $(\"#attachNum\"),\n    attachDropdownO: $(\"#attachDropdown\"),\n    downloadAllBtnO: $(\"#downloadAllBtn\"),\n    linkAllBtnO: $(\"#linkAllBtn\"),\n    // \u6dfb\u52a0\u7b14\u8bb0\u65f6\n    clearNoteAttachNum: function() {\n        var self = this;\n        self.attachNumO.html(\"\").hide();\n    },\n    renderNoteAttachNum: function(noteId, needHide) {\n        var self = this;\n        var note = Note.getNote(noteId);\n        var attachs = note.Attachs;\n        var attachNum = attachs ? attachs.length : 0;\n        if (attachNum) {\n            self.attachNumO.html(\"(\" + attachNum + \")\").show();\n            self.downloadAllBtnO.show();\n            self.linkAllBtnO.show();\n        } else {\n            self.attachNumO.hide();\n            self.downloadAllBtnO.hide();\n            self.linkAllBtnO.hide();\n        }\n\n        // \u9690\u85cf\u6389\n        if (needHide) {\n            self.attachDropdownO.removeClass(\"open\");\n        }\n    },\n    _renderAttachs: function(attachs) {\n        var self = this;\n        // foreach \u5faa\u73af\u4e4b\n        /*\n        <li class=\"clearfix\">\n        \t<div class=\"attach-title\">leanote\u5b98abcefedafadfadfadfadfad\u65b9\u6587\u6863.doc</div>\n        \t<div class=\"attach-process\">\n        \t\t<button class=\"btn btn-sm btn-warning\">Delete</button>\n        \t\t<button class=\"btn btn-sm btn-deafult\">Download</button>\n        \t</div>\n        </li>\n        */\n        var html = \"\";\n        var attachNum = attachs.length;\n        // console.log(attachs);\n        for (var i = 0; i < attachNum; ++i) {\n            var each = attachs[i];\n            var path = each.Path;\n            // \u672c\u5730\u662f\u5426\u6709, \u6ca1\u6709, \u662f\u5426\u662f\u5728\u663e\u793a\u7684\u65f6\u5019\u624d\u53bb\u4ece\u670d\u52a1\u5668\u4e0a\u6293? \u4e0d\n            var disabled = '';\n            if (path) {\n                var d = '<i class=\"fa fa-download\"></i>';\n            } else {\n                d = '...'\n                disabled = 'disabled';\n                // \u901a\u8fc7\u540e\u7aef\u53bb\u4e0b\u8f7d\n                NoteService.downloadAttachFromServer(Note.curNoteId, each.ServerFileId, each.FileId);\n            }\n            html += '<li class=\"clearfix\" data-id=\"' + each.FileId + '\">' +\n                '<div class=\"attach-title\">' + each.Title + '</div>' +\n                '<div class=\"attach-process\"> ' +\n                '\t  <button class=\"btn btn-sm btn-warning delete-attach\" data-loading-text=\"...\" title=\"' + getMsg('Delete') + '\"><i class=\"fa fa-trash-o\"></i></button> ' +\n                '\t  <button type=\"button\" class=\"btn btn-sm btn-primary download-attach\" ' + disabled + ' title=\"' + getMsg('Save as') + '\">' + d + '</button> ' +\n                '\t  <button type=\"button\" class=\"btn btn-sm btn-default link-attach\" title=\"' + getMsg('Insert link into content') + '\"><i class=\"fa fa-link\"></i></button> ' +\n                '</div>' +\n                '</li>';\n            self.attachsMap[each.FileId] = each;\n        }\n        self.attachListO.html(html);\n\n        // \u8bbe\u7f6e\u6570\u91cf\n        var note = Note.getCurNote();\n        if (note) {\n            note.AttachNum = attachNum;\n            self.renderNoteAttachNum(note.NoteId, false);\n        }\n    },\n    // \u6e32\u67d3noteId\u7684\u9644\u4ef6\n    // \u5f53\u70b9\u51fb\"\u9644\u4ef6\"\u65f6\u52a0\u8f7d,\n    // TODO \u5224\u65ad\u662f\u5426\u5df2loaded\n    // note\u6dfb\u52a0\u4e00\u4e2aAttachs\n    renderAttachs: function(noteId) {\n        var self = this;\n        var note = Note.getNote(noteId);\n        note.Attachs = note.Attachs || [];\n        self.loadedNoteAttachs[noteId] = note.Attachs; // \u4e00\u4e2a\u5bf9\u8c61\n        self._renderAttachs(note.Attachs);\n        return;\n        /*\n\n        if(self.loadedNoteAttachs[noteId]) {\n        \tself._renderAttachs(self.loadedNoteAttachs[noteId]);\n        \treturn;\n        }\n        // \u663e\u793aloading\n        self.attachListO.html('<li class=\"loading\"><img src=\"public/images/loading-24.gif\"/></li>');\n        // ajax\u83b7\u53d6noteAttachs\n        ajaxGet(\"/attach/getAttachs\", {noteId: noteId}, function(ret) {\n        \tvar list = [];\n        \tif(ret.Ok) {\n        \t\tlist = ret.List;\n        \t\tif(!list) {\n        \t\t\tlist = [];\n        \t\t}\n        \t}\n        \t// \u6dfb\u52a0\u5230\u7f13\u5b58\u4e2d\n        \tself.loadedNoteAttachs[noteId] = list;\n        \tself._renderAttachs(list);\n        });\n        */\n    },\n    // \u6dfb\u52a0\u9644\u4ef6, attachment_upload\u4e0a\u4f20\u8c03\u7528\n    addAttach: function(attachInfo) {\n        var self = this;\n        self.loadedNoteAttachs[attachInfo.NoteId].push(attachInfo);\n        self.renderAttachs(attachInfo.NoteId);\n        // TOOD \u66f4\u65b0Note\u8868\n        self.updateAttachToDB(attachInfo.NoteId);\n    },\n    addAttachs: function(attachInfos) {\n        var self = this;\n        var noteId = '';\n        for (var i in attachInfos) {\n            var attachInfo = attachInfos[i];\n            noteId = attachInfo.NoteId;\n            self.loadedNoteAttachs[noteId].push(attachInfo);\n        }\n        self.renderAttachs(attachInfo.NoteId);\n        // TOOD \u66f4\u65b0Note\u8868\n        self.updateAttachToDB(noteId);\n    },\n    // \u5220\u9664\n    deleteAttach: function(attachId) {\n        var self = this;\n        var noteId = Note.curNoteId;\n        var attachs = self.loadedNoteAttachs[noteId];\n        for (var i = 0; i < attachs.length; ++i) {\n            if (attachs[i].FileId == attachId) {\n                // \u5220\u9664\u4e4b, \u5e76render\u4e4b\n                attachs.splice(i, 1);\n                break;\n            }\n        }\n        // self.loadedNoteAttachs[noteId] = attachs;\n        self.renderAttachs(noteId);\n        // TODO \u66f4\u65b0\n        self.updateAttachToDB(noteId);\n    },\n\n    // \u66f4\u65b0\u5230Note\u8868\u4e2d\n    updateAttachToDB: function(noteId) {\n        var self = this;\n        var attachs = self.loadedNoteAttachs[noteId]\n        NoteService.updateAttach(noteId, attachs);\n    },\n\n    // \u4e0b\u8f7d\n    downloadAttach: function(fileId) {\n        var self = this;\n    },\n    downloadAll: function() {},\n\n    // \u670d\u52a1\u5668\u7aef\u540c\u6b65\u6210\u529f\u540e\u8c03\u7528\n    attachSynced: function(attachs, attach, noteId) {\n        var me = this;\n        var fileId = attach.FileId;\n        var note = Note.getNote(noteId);\n        if (note) {\n            note.Attachs = attachs;\n            me.attachsMap[fileId] = attach;\n            if (noteId == Note.curNoteId) {\n                // \u91cd\u65b0render\u4e4b\n                me.renderAttachs(noteId);\n            }\n        }\n    }\n};\n\n//===============\n\n// \u6279\u91cf\u64cd\u4f5c\nNote.inBatch = false;\nNote.getBatchNoteIds = function() {\n    var noteIds = [];\n    var items = Note.$itemList.find('.item-active');\n    for (var i = 0; i < items.length; ++i) {\n        noteIds.push(items.eq(i).attr('noteId'));\n    }\n    return noteIds;\n};\nNote.batch = {\n    $noteItemList: $(\"#noteItemList\"),\n\n    cancelInBatch: function() {\n        Note.inBatch = false;\n        this.$body.removeClass('batch');\n    },\n    setInBatch: function() {\n        Note.inBatch = true;\n        this.$body.addClass('batch');\n    },\n\n    // \u662f\u5426\u662f\u591a\u9009, \u81f3\u5c11\u9009\u4e862\u4e2a\n    isInBatch: function() {\n        var me = this;\n        var items = me.$noteItemList.find('.item-active');\n        if (items.length >= 2) {\n            return true;\n        }\n        return false;\n    },\n\n    // \u5f97\u5230\u5f00\u59cb\u7684\u7b14\u8bb0\n    _startNoteO: null, // \u5f00\u59cb\u9009\u62e9\u7684\u7b14\u8bb0\n    getStartNoteO: function() {\n        var me = this;\n        if (!me._startNoteO) {\n            me._startNoteO = me.getCurSelected();\n        }\n        return me._startNoteO;\n    },\n\n    // \u6e05\u7a7a\u4ee5start\u5f00\u5934\u5df2\u9009\u62e9\u7684\n    // \u7528\u4e8eshift\n    _selectByStart: {}, // start.NoteId => [target1, target2]\n    clearByStart: function(noteId) {\n        var me = this;\n        if (!noteId) {\n            return;\n        }\n        var targets = this._selectByStart[noteId];\n        if (isEmpty(targets)) {\n            return;\n        }\n        for (var i = 0; i < targets.length; ++i) {\n            me.clearTarget(targets[i]);\n        }\n    },\n    selectTo: function($to) {\n        var $start = this.getStartNoteO();\n\n        var startSeq = +$start.data('seq');\n        var toSeq = +$to.data('seq');\n\n        var $start2, $to2, startSeq2, toSeq2;\n        if (startSeq < toSeq) {\n            $start2 = $start;\n            $to2 = $to;\n            startSeq2 = startSeq;\n            toSeq2 = toSeq;\n        } else {\n            $start2 = $to;\n            $to2 = $start;\n            startSeq2 = toSeq;\n            toSeq2 = startSeq;\n        }\n\n        // \u5148\u6e05\u7a7a\u4e4b\n        // \u6e05\u7a7a\u4ee5$start\u4e3a\u9996\u7684, \u5df2\u9009\u7684\u7b14\u8bb0\n        var startNoteId = $start.attr('noteId');\n        this.clearByStart(startNoteId);\n\n        var $now = $start2;\n        this._selectByStart[startNoteId] = [];\n        for (var i = startSeq2; i <= toSeq2; ++i) {\n            this.selectTarget($now);\n            this._selectByStart[startNoteId].push($now);\n            $now = $now.next();\n        }\n    },\n\n    selectAll: function() {\n        this.$noteItemList.find('li').addClass('item-active');\n    },\n\n    clearAllSelect: function() {\n        Note.clearSelect();\n    },\n\n    selectTarget: function($target) {\n        if ($target) {\n            $target.addClass('item-active');\n        }\n    },\n    clearTarget: function($target) {\n        if ($target) {\n            $target.removeClass('item-active');\n        }\n    },\n\n    // multi\u64cd\u4f5c\n    // \u9009\u62e9\u4e4b\u67d0\u4e00\n    // \u5982\u679c\u4e4b\u524d\u5df2\u9009\u62e9\u4e86, \u5219\u53d6\u6d88\u9009\u62e9\n    select: function($target) {\n        var me = this;\n        // \u4e4b\u524d\u5df2\u9009\u4e2d\n        if ($target.hasClass('item-active')) {\n            var isInBatch = this.isInBatch();\n            if (isInBatch) {\n                $target.removeClass('item-active');\n            }\n        } else {\n            me._startNoteO = $target;\n            this.selectTarget($target);\n        }\n    },\n\n    // \u5f97\u5230\u5f53\u524d\u9009\u4e2d\u7684\u5143\u7d20\n    getCurSelected: function() {\n        return this.$noteItemList.find('.item-active');\n    },\n\n    // \u5f53\u91cd\u65b0render\u540e\n    reset: function() {\n        this.cancelInBatch();\n        this._selectByStart = {};\n        this._startMove = false;\n        this._startNoteO = null;\n        this.clearRender();\n    },\n\n    // \u53ef\u4ee5\u591a\u9009\n    canBatch: function() {\n        return !Writting.isWriting();\n    },\n\n    init: function() {\n        var me = this;\n        me.$noteItemList.on(\"click\", \".item\", function(e) {\n            var $this = $(this);\n            var noteId = $this.attr(\"noteId\");\n            if (!noteId) {\n                return;\n            }\n\n            var isMulti = false;\n            var isConti = false;\n            if (me.canBatch()) {\n                if (e.shiftKey) {\n                    isConti = true;\n                } else {\n                    isMulti = e.metaKey || e.ctrlKey;\n                }\n            }\n\n            //----------\n            // \u591a\u9009\u64cd\u4f5c\n            //----------\n\n            if (isMulti || isConti) {\n                Note.curChangedSaveIt();\n            }\n\n            // \u591a\u9009\n            if (isMulti) {\n                me.select($this);\n\n                // \u8fde\u7eed\u9009\n            } else if (isConti) {\n                // \u9009\u62e9 \u5f00\u59cb\u4f4d\u7f6e\u5230\u7ed3\u675f\u4f4d\u7f6e\n                // \u5f53\u524d\u70b9\u51fb\u7684\u662f\u7ed3\u675f\u4f4d\u7f6e\n                me.selectTo($this);\n            }\n\n            //---------\n            // \u5355\u9009\n            //---------\n\n            // \u5426\u5219, \u4e0d\u662f\u591a\u9009, \u6e05\u7a7aitem-active\n            else {\n                Note.selectTarget($this);\n            }\n\n            me.finalFix();\n        });\n\n        //----------\n\n        // \u9f20\u6807\u62d6\u52a8\u5f00\u59cb\n        me._startMove = false;\n        me.$noteItemList.on(\"mousedown\", \".item\", function(e) {\n            if (!me.canBatch()) {\n                return;\n            }\n\n            // \u53f3\u952e\n            if (me.isContextMenu(e)) {\n                return;\n            }\n\n            if (!me._startMove && (e.metaKey || e.ctrlKey || e.shiftKey)) {\n                return;\n            }\n\n            me._startNoteO = $(this);\n            me._startMove = true;\n        });\n\n        // \u9f20\u6807\u6b63\u5728\u62d6\u52a8\n        me.$noteItemList.on(\"mousemove\", \".item\", function(e) {\n            if (me.canBatch() && me._startMove) {\n\n                Note.curChangedSaveIt();\n\n                me.clearAllSelect();\n\n                me.selectTo($(this));\n\n                me.finalFix(true);\n            }\n        });\n\n        var $body = $('body');\n        $body.on('mouseup', function() {\n            me._startMove = false;\n        });\n\n        // ctrl + all\n        $body.keydown(function(e) {\n            if (e.target && e.target.nodeName === 'BODY') {\n                if ((e.ctrlKey || e.metaKey) && e.which === 65) {\n                    e.preventDefault();\n\n                    if (me.canBatch()) {\n                        Note.curChangedSaveIt();\n\n                        me.selectAll();\n                        me.finalFix();\n                    }\n                }\n            }\n        });\n\n        // \u4e0d\u8ba9\u62d6\u52a8\n        me.$noteItemList.on(\"dragstart\", function(e) {\n            e.preventDefault();\n            e.stopPropagation();\n        });\n\n        me.initContextmenu();\n        me.initBatchStatus();\n    },\n\n    initContextmenu: function() {\n        var me = this;\n\n        me.$batchMask.on('contextmenu', function(e) {\n            e.preventDefault();\n            Note.noteMenuSys.popup(e, null);\n        });\n\n        me.$batchMask.find('.batch-info .fa').click(function(e) {\n            e.preventDefault();\n\n            e.pageX -= 70;\n            e.pageY += 10;\n\n            e.stopPropagation();\n            // \u6240\u4ee5\n            $(document).click();\n            Note.noteMenuSys.popup(e, null);\n        });\n    },\n\n    $body: $('body'),\n    finalFix: function(isMove) {\n        var me = this;\n        // \u9009\u62e9\u4e86\u51e0\u4e2a? \u5982\u679c >= 2\u5219\u662f\u6279\u91cf\u64cd\u4f5c\n        if (me.isInBatch()) {\n            // \u6e05\u7a7a\u5f53\u524d\u7b14\u8bb0, \u4e0d\u8ba9\u81ea\u52a8\u4fdd\u5b58\n            Note.clearCurNoteId();\n\n            me.renderBatchNotes();\n            me.setInBatch();\n\n            // \u5355\u4e2a\u5904\u7406\n        } else {\n            me.clearRender();\n            me.cancelInBatch();\n\n            // \u4e3a\u4ec0\u4e48\u8fd8\u8981\u5f97\u5230\u5f53\u524d\u9009\u4e2d\u7684, \u56e0\u4e3a\u6709\u53ef\u80fd\u662f\u53d6\u6d88\u9009\u62e9\n            // \u5f97\u5230\u5f53\u524d\u9009\u4e2d\u7684\n            var $target = me.getCurSelected();\n            if ($target) {\n                var noteId = $target.attr('noteId');\n\n                if (!isMove) {\n                    me._startNoteO = $target;\n                }\n\n                // \u624b\u673a\u7aef\u5904\u7406\n                Mobile.changeNote(noteId);\n                // \u5f53\u524d\u7684\u548c\u6240\u9009\u7684\u662f\u4e00\u4e2a, \u4e0d\u6539\u53d8\n                if (Note.curNoteId != noteId) {\n                    // \u4e0d\u7528\u91cd\u5b9a\u5411\u5230notebook\n                    Note.changeNoteForPjax(noteId, true, false);\n                }\n            }\n        }\n    },\n\n    // \u5224\u65ad\u662f\u5426\u662f\u53f3\u51fb\n    isContextMenu: function(evt) {\n        if ((evt.which != undefined && evt.which == 1) || evt.button == 1)\n            return false;\n        else if ((evt.which != undefined && evt.which == 3) || evt.button == 2)\n            return true;\n        return false;\n    },\n\n    //==========\n    _notes: {},\n    clearRender: function() {\n        this._notes = {};\n        this.$batchCtn.html('');\n        this.hideMask();\n    },\n    showMask: function() {\n        this.$batchMask.css({ 'z-index': 99 }).show();\n    },\n    hideMask: function() {\n        this.$batchMask.css({ 'z-index': -2 }).hide();\n    },\n    renderBatchNotes: function() {\n        var me = this;\n        me.showMask();\n\n        var selectedTargets = me.$noteItemList.find('.item-active');\n        me.$batchNum.html(selectedTargets.length);\n\n        var ids = {};\n        for (var i = 0; i < selectedTargets.length; ++i) {\n            var noteId = selectedTargets.eq(i).attr('noteId');\n            me.addTo(noteId);\n            ids[noteId] = 1;\n        }\n        for (var noteId in me._notes) {\n            if (!ids[noteId]) {\n                var $tmp = me._notes[noteId];\n                $tmp.css({ 'margin-left': '-800px' /*, 'margin-top': '100px'*/ });\n                setTimeout(function() {\n                    $tmp.remove();\n                }, 500);\n                delete me._notes[noteId];\n            }\n        }\n    },\n    $batchMask: $('#batchMask'),\n    $batchCtn: $('#batchCtn'),\n\n    initBatchStatus: function() {\n        $('#batchMask .batch-status').html(getMsg('<span></span> notes selected'));\n        this.$batchNum = $('#batchMask .batch-info span');\n    },\n\n    _i: 1,\n    getRotate: function() {\n        var me = this;\n        var time = me._i++;\n        var e = time % 2 === 0 ? 1 : -1;\n        var rotate = e * Math.random() * 70;\n        var margins = [0, 10, 20, 30, 40];\n        var margin = e * margins[time % 5] * 3;\n        // if (e < 0) {\n        margin -= 80;\n        // }\n        return [e * Math.random() * 30, margin];\n    },\n    addTo: function(noteId) {\n        var me = this;\n        if (me._notes[noteId]) {\n            return;\n        }\n        var note = Note.getNote(noteId);\n        var title = note.Title || getMsg('unTitled');\n        var desc = note.Desc || '...';\n        // desc = substr(note.Content, 0, 200);\n\n        var $note = $('<div class=\"batch-note\"><div class=\"title\">' + title + '</div><div class=\"content\">' + desc + '</div></div>');\n        me._notes[noteId] = $note;\n        var rotate = me.getRotate();\n        me.$batchCtn.append($note);\n        setTimeout(function() {\n            $note.css({ transform: 'rotate(' + rotate[0] + 'deg)', 'margin-left': rotate[1] + 'px' });\n        });\n    }\n};\n\n//------------------- \u4e8b\u4ef6\n$(function() {\n    // \u9644\u4ef6\u521d\u59cb\u5316\n    Attach.init();\n\n    Note.batch.init();\n\n    //------------------\n    // \u65b0\u5efa\u7b14\u8bb0\n    // 1. \u76f4\u63a5\u70b9\u51fb\u65b0\u5efa OR\n    // 2. \u70b9\u51fbnav for new note\n    $(\"#newNoteBtn, #editorMask .note\").click(function() {\n        var notebookId = $(\"#curNotebookForNewNote\").attr('notebookId');\n        Note.newNote(notebookId);\n    });\n    $(\"#newNoteMarkdownBtn, #editorMask .markdown\").click(function() {\n        var notebookId = $(\"#curNotebookForNewNote\").attr('notebookId');\n        Note.newNote(notebookId, false, \"\", true);\n    });\n    $(\"#notebookNavForNewNote\").on(\"click\", \"li div\", function() {\n        var notebookId = $(this).attr(\"notebookId\");\n        if ($(this).hasClass(\"new-note-right\")) {\n            Note.newNote(notebookId, false, \"\", true);\n        } else {\n            Note.newNote(notebookId);\n        }\n    });\n    $(\"#searchNotebookForAdd\").click(function(e) {\n        e.stopPropagation();\n    });\n    $(\"#searchNotebookForAdd\").keyup(function() {\n        var key = $(this).val();\n        Notebook.searchNotebookForAddNote(key);\n    });\n    $(\"#searchNotebookForList\").keyup(function() {\n        var key = $(this).val();\n        Notebook.searchNotebookForList(key);\n    });\n\n    // \u5207\u6362\u5217\u8868\u89c6\u56fe\n    $(\"#viewModeDropdown\").click(function() {\n        var noteViewMenus = new gui.Menu();\n        noteViewMenus.append(new gui.MenuItem({\n            checked: Config.view === \"snippet\",\n            label: Api.getMsg(\"Snippet View\"),\n            type: \"checkbox\",\n            click: function() {\n                Note.switchView('snippet');\n            }\n        }));\n        noteViewMenus.append(new gui.MenuItem({\n            checked: Config.view === \"list\",\n            label: Api.getMsg(\"List View\"),\n            type: \"checkbox\",\n            click: function() {\n                Note.switchView('list');\n            }\n        }));\n        noteViewMenus.append(new gui.MenuItem({type: \"separator\"}));\n        noteViewMenus.append(new gui.MenuItem({\n            checked: Config.sortType == \"dateCreatedASC\",\n            label: Api.getMsg(\"Date Created - ASC\"),\n            type: \"checkbox\",\n            click: function() {\n            \tNote.setNotesSorter('dateCreatedASC');\n            }\n        }));\n        noteViewMenus.append(new gui.MenuItem({\n            checked: Config.sortType == \"dateCreatedDESC\",\n            label: Api.getMsg(\"Date Created - DESC\"),\n            type: \"checkbox\",\n            click: function() {\n            \tNote.setNotesSorter('dateCreatedDESC');\n            }\n        }));\n        noteViewMenus.append(new gui.MenuItem({type: \"separator\"}));\n        noteViewMenus.append(new gui.MenuItem({\n            checked: Config.sortType == \"dateUpdatedASC\",\n            label: Api.getMsg(\"Date Updated - ASC\"),\n            type: \"checkbox\",\n            click: function() {\n            \tNote.setNotesSorter('dateUpdatedASC');\n            }\n        }));\n        noteViewMenus.append(new gui.MenuItem({\n            checked: !Config.sortType || Config.sortType == \"dateUpdatedDESC\",\n            label: Api.getMsg(\"Date Updated - DESC\"),\n            type: \"checkbox\",\n            click: function() {\n            \tNote.setNotesSorter('dateUpdatedDESC');\n            }\n        }));\n        noteViewMenus.append(new gui.MenuItem({type: \"separator\"}));\n        noteViewMenus.append(new gui.MenuItem({\n            checked: Config.sortType == \"titleASC\",\n            label: Api.getMsg(\"Title - ASC\"),\n            type: \"checkbox\",\n            click: function() {\n            \tNote.setNotesSorter('titleASC');\n            }\n        }));\n        noteViewMenus.append(new gui.MenuItem({\n            checked: Config.sortType == \"titleDESC\",\n            label: Api.getMsg(\"Title - DESC\"),\n            type: \"checkbox\",\n            click: function() {\n            \tNote.setNotesSorter('titleDESC');\n            }\n        }));\n\n        var $this = $(this);\n        var x = $this.offset().left;\n        var y = $this.offset().top + $this.height();\n        noteViewMenus.popup(gui.getCurrentWindow(), Math.round(x), Math.round(y));\n    });\n\n\n    //---------------------------\n    // \u641c\u7d22, \u6309enter\u624d\u641c\u7d22\n    /*\n    $(\"#searchNoteInput\").on(\"keyup\", function(e) {\n    \tNote.searchNote();\n    });\n    */\n    $(\"#searchNoteInput\").on(\"keydown\", function(e) {\n        var theEvent = e; // window.event || arguments.callee.caller.arguments[0];\n        if (theEvent.keyCode == 13 || theEvent.keyCode == 108) {\n            theEvent.preventDefault();\n            Note.searchNote();\n            return false;\n        }\n    });\n\n    $(\"#saveBtn\").click(function() {\n        Note.curChangedSaveIt(true);\n    });\n\n    // blog\n    $(\"#noteItemList\").on(\"click\", \".item-blog\", function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        // \u5f97\u5230ID\n        var noteId = $(this).closest('li').attr('noteId');\n        var note = Note.getNote(noteId);\n        if (note.ServerNoteId) {\n            openExternal(UserInfo.Host + '/blog/post/' + note.ServerNoteId);\n        }\n    });\n\n    // note setting\n    $(\"#noteItemList\").on(\"click\", \".item-setting\", function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        Note.noteMenuSys.popup(e, $(this).closest('li'));\n    });\n    $(\"#noteItemList\").on(\"contextmenu\", \"li\", function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        Note.noteMenuSys.popup(e, $(this));\n    });\n\n    // \u6536\u85cf\n    $(\"#noteItemList\").on(\"click\", \".item-star\", function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        var $li = $(this).closest('li');\n        var noteId = $li.attr('noteId');\n        Note.star(noteId);\n    });\n\n    Note.starNotesO = $('#starNotes');\n    // \u53d6\u6d88\u6536\u85cf\n    Note.starNotesO.on('click', '.delete-star', function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        var $li = $(this).closest('li');\n        var noteId = $li.data('id');\n        Note.star(noteId);\n    });\n    Note.starNotesO.on('click', 'a', function(e) {\n        var $li = $(this).closest('li');\n        Note.renderStarNote($li);\n    });\n\n    $(\"#noteItemList\").on(\"click\", \".item-conflict-info\", function(e) {\n        Note.showConflictInfo(this, e);\n    });\n\n    $(\"#noteItemList\").on(\"click\", \".item-warning\", function(e) {\n        var $li = $(this).closest('li');\n        var noteId = $li.attr('noteId');\n        var note = Note.getNote(noteId);\n        if (!note) {\n            return;\n        }\n        if (!note.Err) {\n            $li.removeClass('item-err');\n            return;\n        }\n        var err = note.Err;\n        var msg = getMsg('Sync error') + '\\n';\n        err.err && (msg = getMsg('Error') + ': ' + err.err + '\\n')\n        err.msg && (msg += getMsg('Message') + ': ' + getMsg(err.msg));\n        alert(msg);\n    });\n\n    Note._syncRefreshE = $('#syncRefresh');\n    Note._syncWarningE = $('#syncWarning');\n    // sync\n    Note._syncRefreshE.click(function() {\n        incrSync(true);\n    });\n\n    Note._syncWarningE.click(function() {\n        Note.fixNetOrAuthError();\n    });\n\n    // readony\n    // \u4fee\u6539\n    // $('.toolbar-update').click(function() {\n    // \tNote.toggleWriteable();\n    // });\n    $(\"#editBtn\").click(function() {\n        Note.toggleWriteableAndReadOnly();\n    });\n\n    // note title \u91cc\u6309tab, \u5207\u6362\u5230\u7f16\u8f91\u533a\n    $('#noteTitle').on(\"keydown\", function(e) {\n        var keyCode = e.keyCode || e.witch;\n        // tab\n        if (keyCode == 9) {\n            // \u4e00\u4e3e\u4e24\u5f97, \u5373\u5207\u6362\u5230\u4e86writable, \u53c8focus\u4e86\n            Note.toggleWriteable();\n            e.preventDefault();\n        }\n    });\n\n});\n\n// \u5b9a\u65f6\u5668\u542f\u52a8\nNote.startInterval();\n\n//----------------------\n// \u51b2\u7a81\u89e3\u51b3, \u589e\u91cfsync\u65f6\n// note\u662f\u670d\u52a1\u5668\u7aef\u7684\u7b14\u8bb0, newNote\u662f\u672c\u5730\u590d\u5236\u540e\u7684\u7b14\u8bb0\nNote.fixSyncConflict = function(note, newNote) {\n    // Note.cache[note.NoteId] = note;\n    // Note.cache[newNote.NoteId] = newNote;\n    Note.addNoteCache(note);\n    Note.addNoteCache(newNote);\n\n    var target = $(tt('#noteItemList [noteId=\"?\"]', note.NoteId)); //\n    // \u5982\u679c\u5f53\u524d\u7b14\u8bb0\u5728\u7b14\u8bb0\u5217\u8868\u4e2d, \u90a3\u4e48\u751f\u6210\u4e00\u4e2a\u65b0\u7b14\u8bb0\u653e\u5728\u8fd9\u4e2a\u7b14\u8bb0\u4e0a\u9762\n    if (target.length > 0) {\n        var newHtmlObject = Note._getNoteHtmlObjct(note);\n        if (newHtmlObject) {\n            $(newHtmlObject).insertBefore(target);\n        }\n    }\n    // \u5f53\u524d\u8fd9\u4e2a\u6362\u6210\u65b0\u590d\u5236\u7684\n    target.attr('noteId', newNote.NoteId);\n    target.addClass('item-conflict');\n    // \u91cd\u65b0render \u5de6\u4fa7\u4e0b, \u56e0\u4e3a\u6709\u51b2\u7a81\u4e86, \u4e0d\u8981render\u5185\u5bb9\u554a\n\n    // \u5982\u679c\u5f53\u524d\u7f16\u8f91\u7684\u662f\u8fd9\u4e2a\u7b14\u8bb0, \u90a3\u5207\u6362\u5230newNote\u4e0a\u6765\n    if (Note.curNoteId == note.NoteId) {\n        Note.setCurNoteId(newNote.NoteId);\n    }\n};\n\n// \u8bbe\u7f6e\u535a\u5ba2\u662f\u5426\u53ef\u4ee5\u89c1\nNote.setNoteBlogVisible = function(noteId, isBlog) {\n    var target = $(tt('#noteItemList [noteId=\"?\"]', noteId));\n    if (target.length) {\n        if (isBlog) {\n            target.addClass('item-b');\n        } else {\n            target.removeClass('item-b');\n        }\n    }\n};\n\n// \u4e3a\u4e86\u535a\u5ba2\n// \u670d\u52a1\u5668\u4e0a\u66f4\u65b0\u4e86, \u524d\u7aef\u4e5f\u6765\u66f4\u65b0\n// changeAdds \u6709\u4e86serverId\n// updates...\nNote.updateNoteCacheForServer = function(notes) {\n    if (isEmpty(notes)) {\n        return;\n    }\n    for (var i in notes) {\n        var note = notes[i];\n        if (note && !note.IsTrash && !note.IsDeleted) {\n            Note.setNoteCache({\n                NoteId: note.NoteId,\n                ServerNoteId: note.ServerNoteId,\n                IsBlog: note.IsBlog,\n            });\n            Note.setNoteBlogVisible(note.NoteId, note.IsBlog);\n        }\n    }\n};\n\n// \u66f4\u65b0\n// push\n// --> send changes\nNote.updateSync = function(notes) {\n    if (isEmpty(notes)) {\n        return;\n    }\n\n    var curNotebookIsTrash = Notebook.curNotebookIsTrash();\n\n    var currentIsDeleted = false;\n\n    for (var i = 0; i < notes.length; ++i) {\n        var note = notes[i];\n        note.InitSync = true; // \u9700\u8981\u91cd\u65b0\u83b7\u53d6\u5185\u5bb9\n        Note.addNoteCache(note);\n\n        // \u5982\u679c\u5f53\u524d\u4fee\u6539\u7684\u662f\u672c\u7b14\u8bb0, \u90a3\u4e48\u91cd\u65b0render\u4e4b\n        /*\n        \u8fd9\u91cc\u662f\u4e00\u4e2a\u91cd\u5927BUG\n        \t\u8fdc\u7a0b\u7b14\u8bb0sync -> \u672c\u5730\n        \t\u662ftrash\u64cd\u4f5c, \u5219\u524d\u7aef\u5148\u5220\u9664, delete cache, toggle next\n        \t\u4f46\u662f\u4f1a\u5f02\u6b65\u53d6content, \u53d6\u5230\u540e, reRender\u73b0\u6709\u7b14\u8bb0 -> renderContent, \u90a3\u4e48\u91cd\u7f6e\u4e3a\u5f53\u524d\u7b14\u8bb0\n        */\n        if (Note.curNoteId == note.NoteId && !(!curNotebookIsTrash && note.IsTrash)) {\n            Note.reRenderNote(Note.curNoteId);\n        }\n\n        // \u4e0d\u662fdirty\u7684\n        Note.setNoteDirty(note.NoteId, false);\n\n        // \u8bbe\u7f6e\u5f53\u524d\u662f\u5426\u662f\u535a\u5ba2\n        // alert(note.NoteId + \" \" + note.IsBlog);\n        Note.setNoteBlogVisible(note.NoteId, note.IsBlog);\n\n        // \u5982\u679c\u662ftrash, \u4e14\u5f53\u524d\u4e0d\u5728trash\u76ee\u5f55\u4e0b, \u4e14\u6709\u8be5\u7b14\u8bb0, \u5219\u5220\u9664\u4e4b\n        if (!curNotebookIsTrash && note.IsTrash) {\n\n            // \u524d\u7aef\u7f13\u5b58\u4e5f\u8981\u5220\u9664!!\n            // \u5148\u5220\u9664, \u4e0d\u7136changeToNext()\u4e4b\u524d\u4f1a\u5148\u4fdd\u5b58\u73b0\u5728\u7684, \u5bfc\u81f4\u50f5\u5c38note\n            Note.deleteCache(note.NoteId);\n\n            var target = $(tt('#noteItemList [noteId=\"?\"]', note.NoteId));\n\n            // \u5f53\u524d\u7b14\u8bb0\u8981\u5220\u9664\u4e86, \u5982\u679c\u6709\u591a\u4e2a\u7b14\u8bb0\u8981\u5220\u9664, \u8fd9\u5c31\u6709\u95ee\u9898\u4e86\n            // \u521a\u4e00\u5207\u6362\u5230\u4e0b\u4e00\u4e2a, \u5c31\u88ab\u5220\u9664\u4e86, \u5bfc\u81f4\u6ca1\u6709\u88ab\u9009\u4e2d\n            if (target.length) {\n                if (Note.curNoteId == note.NoteId) {\n                    currentIsDeleted = true;\n                    Note.changeToNext(target);\n                }\n                target.remove();\n            }\n        }\n    }\n\n    // \u6700\u540e\u518d\u5220\u9664\n    if (currentIsDeleted) {\n        // Note.changeToNext(target);\n        setTimeout(function() {\n            Note.checkHasSelectedNote();\n        }, 100);\n    }\n};\n\nNote.checkHasSelectedNote = function() {\n    if (!$('#noteItemList .item-active').length) {\n        if ($('#noteItemList .item').length > 0) {\n            Note.changeNote($('#noteItemList .item').eq(0).attr(\"noteId\"));\n        } else {\n            Note.showEditorMask();\n        }\n    }\n};\n\n// pull\n// \u6dfb\u52a0\u540c\u6b65\u7684notes\n// <-- server\nNote.addSync = function(notes) {\n    if (isEmpty(notes)) {\n        return;\n    }\n    for (var i in notes) {\n        var note = notes[i];\n        // \u907f\u514dtrash\u7684\u4e5f\u52a0\u8fdb\u6765\n        if (!note.IsDeleted) {\n            if (\n                (note.IsTrash && Notebook.curNotebookIsTrash()) || !note.IsTrash) {\n\n                Note.addNoteCache(note);\n\n                // \u5f88\u53ef\u80fd\u5176\u7b14\u8bb0\u672c\u4e5f\u662f\u65b0\u6dfb\u52a0\u7684, \u6b64\u65f6\u91cd\u65b0render notebooks' numberNotes\n                Notebook.reRenderNotebookNumberNotesIfIsNewNotebook(note.NotebookId);\n\n                // alert(note.ServerNoteId);\n                // \u6dfb\u52a0\u5230\u5f53\u524d\u7684\u7b14\u8bb0\u5217\u8868\u4e2d\n                var newHtmlObject = Note._getNoteHtmlObjct(note);\n                if (newHtmlObject) {\n                    $('#noteItemList').prepend(newHtmlObject);\n                    Note.setNoteBlogVisible(note.NoteId, note.IsBlog);\n                }\n            }\n        }\n    }\n};\n\n// \u5220\u9664\nNote.deleteSync = function(notes) {\n    if (isEmpty(notes)) {\n        return;\n    }\n    for (var i in notes) {\n        var noteId = notes[i];\n        note = Note.getNote(noteId);\n        if (note) {\n            Note.clearCacheByNotebookId(note.NotebookId);\n            delete Note.cache[noteId];\n            // \u5982\u679c\u5728\u7b14\u8bb0\u5217\u8868\u4e2d\u5219\u5220\u9664\n            $(tt('#noteItemList [noteId=\"?\"]', note.NoteId)).remove();\n        }\n\n        // \u524d\u7aef\u7f13\u5b58\u4e5f\u8981\u5220\u9664!!\n        Note.deleteCache(noteId);\n    }\n};\n\n// push\n\n// \u53d1\u9001\u6210\u529f\u6dfb\u52a0\u4e86\u7684\nNote.updateChangeAdds = function(notes) {\n    if (isEmpty(notes)) {\n        return;\n    }\n    for (var i = 0; i < notes.length; ++i) {\n        var note = notes[i];\n        this.setNoteDirty(note.NoteId, false);\n    }\n};\n\n// \u53d1\u9001\u6539\u53d8\u6210\u529f\u4e86\u7684\nNote.updateChangeUpdates = function(notes) {\n    this.updateChangeAdds(notes);\n};\n\n// \u8fd4\u56de {err:'', msg: ''}\nNote._getError = function(err, ret) {\n    var Err = {};\n    try {\n        if (err && typeof err == 'object') {\n            Err.err = err.toString();\n        }\n    } catch (e) {}\n    if (typeof ret == 'object' && 'Msg' in ret) {\n        Err.msg = ret.Msg;\n    } else {\n        Err.msg = ret + '';\n    }\n    return Err;\n};\nNote.updateErrors = function(errs) {\n    if (isEmpty(errs)) {\n        return;\n    }\n    for (var i = 0; i < errs.length; ++i) {\n        var err = errs[i]; // {err: err, ret: ret, note: note}\n        var note = err.note;\n        if (!note || !note.NoteId) {\n            continue;\n        }\n        var Err = this._getError(err.err, err.ret);\n        this.setNoteCache({ NoteId: note.NoteId, Err: Err }, false);\n\n        var $leftNoteNav = $(tt('#noteItemList [noteId=\"?\"]', note.NoteId));\n        $leftNoteNav.addClass('item-err');\n    }\n}\n"], "fixing_code": ["// 1. notebook change\n// notebook\u4e00\u6539\u53d8, \u5f53\u524d\u7684\u80af\u5b9a\u8981\u4fdd\u5b58, ajax\u662f\u5f02\u6b65\u7684. \u6b64\u65f6\u5148\u6e05\u7a7a\u6240\u6709note\u4fe1\u606f. -> \u5f97\u5230\u8be5notebook\u7684notes, \u663e\u793a\u51fa\u6765, \u5e76\u9009\u4e2d\u7b2c\u4e00\u4e2a!\n// \u5728\u8fd9\u671f\u95f4\u5b9a\u65f6\u5668\u8fd8\u4f1a\u4fdd\u5b58, curNoteId\u8fd8\u6ca1\u6362, \u6240\u4ee5\u4f1a\u6e05\u7a7acurNoteId\u7684content!!!\n\n// 2. note change, save cur, \u7acb\u5373curNoteId = \"\"!!\n\n// 3. \u4ec0\u4e48\u65f6\u5019\u8bbe\u7f6ecurNoteId? \u662fajax\u5f97\u5230\u5185\u5bb9\u4e4b\u540e\u8bbe\u7f6e\n\n// note\nNote.curNoteId = \"\";\n\nNote.interval = \"\"; // \u5b9a\u65f6\u5668\n\nNote.noteItemListO = $(\"#noteItemList\");\nNote.$itemList = $('#noteItemList');\n\n// notbeookId => {\"updatedTime\" => [noteId1, noteId2], \"title\" => [noteId1, noteId2...]} \u6392\u5e8f\u65b9\u5f0f\u5206\u7ec4\n// \u4e00\u65e6\u67d0notebook\u6539\u53d8\u4e86\u5c31\u6e05\u7a7a, \u91cd\u65b0\u6392\u5e8f\u4e4b. (\u7528js\u6392)\nNote.cacheByNotebookId = { all: {} };\nNote.notebookIds = {}; // notebookId => true\n\n// \u521d\u59cb\u5316\u6a21\u7248\u5b57\u7b26\u4e32\n// blog, star, settings\nvar itemIsBlog = '<div class=\"item-options\"><div class=\"item-blog\"><i class=\"fa fa-bold\" title=\"' + getMsg('Blog') + '\"></i></div><div class=\"item-conflict-info\"><i class=\"fa fa-bug\" title=\"' + getMsg('Conflict') + '!!\"></i></div><div class=\"item-warning\"><i class=\"fa fa-warning\" title=\"' + getMsg('Error') + '!!\"></i></div><div class=\"item-star\"><i class=\"fa fa-star-o\" title=\"' + getMsg('Star') + '\"></i></div><div class=\"item-setting\"><i class=\"fa fa-cog\" title=\"' + getMsg('Setting') + '\"></i></div></div>';\nNote.itemTplNoImg = '<li href=\"#\" class=\"item ?\" data-seq=\"?\" noteId=\"?\">';\nNote.itemTplNoImg += itemIsBlog + '<div class=\"item-desc\"><p class=\"item-title\">?</p><p class=\"item-info\"><i class=\"fa fa-book\"></i> <span class=\"note-notebook\">?</span> <i class=\"fa fa-clock-o\"></i> <span class=\"updated-time\">?</span></p><p class=\"desc\">?</p></div></li>';\nNote.itemTpl = '<li href=\"#\" class=\"item ? item-image\" data-seq=\"?\" noteId=\"?\"><div class=\"item-thumb\" style=\"\"><img src=\"?\"/></div>';\nNote.itemTpl += itemIsBlog + '<div class=\"item-desc\" style=\"\"><p class=\"item-title\">?</p><p class=\"item-info\"><i class=\"fa fa-book\"></i> <span class=\"note-notebook\">?</span> <i class=\"fa fa-clock-o\"></i> <span class=\"updated-time\">?</span></p><p class=\"desc\">?</p></div></li>';\n\nNote.switchView = function(view) {\n    const viewList = ['snippet', 'list'];\n    if (viewList.indexOf(view) === -1) return;\n    viewList.forEach(function(name) {\n        $('#noteItemList').removeClass(name + '-view');\n    });\n    $('#noteItemList').addClass(view + '-view');\n    Config.view = view;\n    Api.writeConfig(Config);\n}\nNote.switchView(Config.view || 'snippet');\n\nNote.getItemTpl = function() {\n    return Note.itemTpl;\n}\n\nNote.getItemTplNoImg = function() {\n    return Note.itemTplNoImg;\n}\n\n// \u5b9a\u65f6\u4fdd\u5b58\u4fe1\u606f\nNote.intervalTime = 10 * 1000; // 10\u79d2\nNote.startInterval = function() {\n    if (Note.interval) {\n        clearInterval(Note.interval);\n    }\n    Note.interval = setInterval(function() {\n        console.log(\"\u81ea\u52a8\u4fdd\u5b58...\");\n        Note.curChangedSaveIt(false);\n    }, Note.intervalTime); // 600s, 10mins\n};\n\n// \u505c\u6b62, \u5f53\u5207\u6362note\u65f6\n// \u4f46\u8fc75000\u540e\u81ea\u52a8\u542f\u52a8\nNote.stopInterval = function(notStartAuto) {\n    clearInterval(Note.interval);\n\n    // \u662f\u5426\u81ea\u52a8\u542f\u52a8, \u9ed8\u8ba4\u662f\u81ea\u52a8\u542f\u52a8\n    if (!notStartAuto) {\n        setTimeout(function() {\n            Note.startInterval();\n        }, Note.intervalTime);\n    }\n};\n\n// note = {NoteId, Desc, UserId,...}\nNote.addNoteCache = function(note) {\n        Note.cache[note.NoteId] = note;\n        Note.clearCacheByNotebookId(note.NotebookId);\n    }\n    // content = {NoteId:, Content:}\n    // \u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u5176\u5b83\u7684\u503c\nNote.setNoteCache = function(content, clear) {\n    if (!Note.cache[content.NoteId]) {\n        Note.cache[content.NoteId] = content;\n    } else {\n        $.extend(Note.cache[content.NoteId], content);\n    }\n\n    if (clear == undefined) {\n        clear = true;\n    }\n    if (clear) {\n        Note.clearCacheByNotebookId(content.NotebookId);\n    }\n}\n\n// \u5220\u9664\u7f13\u5b58\nNote.deleteCache = function(noteId) {\n    delete this.cache[noteId];\n};\n\n// \u5f97\u5230\u5f53\u524d\u7684\u7b14\u8bb0\nNote.getCurNote = function() {\n    var self = this;\n    if (!self.curNoteId) {\n        return null;\n    }\n    return self.cache[self.curNoteId];\n}\nNote.getNote = function(noteId) {\n    var self = this;\n    return self.cache[noteId];\n};\n\nNote.getTargetById = function(noteId) {\n    return this.$itemList.find('li[noteId=\"' + noteId + '\"]');\n};\n\n// \u6bcf\u5f53\u6709notebookId\u76f8\u5e94\u7684note\u6539\u53d8\u65f6\u90fd\u8981\u91cd\u65b0\u6e05\u7a7a\u4e4b\n// \u5e76\u8bbe\u7f6e\u8be5notebookId\u6709\u503c\nNote.clearCacheByNotebookId = function(notebookId) {\n    if (notebookId) {\n        Note.cacheByNotebookId[notebookId] = {};\n        Note.cacheByNotebookId[\"all\"] = {};\n        Note.notebookIds[notebookId] = true;\n    }\n};\n\n// notebook\u662f\u5426\u6709notes\n// called by Notebook\nNote.notebookHasNotes = function(notebookId) {\n    var notes = Note.getNotesByNotebookId(notebookId);\n    return !isEmpty(notes);\n};\n\n// \u91cd\u65b0\u8bbe\u7f6esorter, \u6b64\u65f6\u8981\u91cd\u65b0render\n// sortType = dateCreatedASC dateCreatedDESC\nNote.setNotesSorter = function (sortType) {\n\tConfig.sortType = sortType;\n\n    // \u5982\u679c\u5f53\u524d\u662ftagSearch, search, star \u600e\u4e48\u529e?\n\t// \u91cd\u65b0Render\n    if (Notebook.isTag || Notebook.isStarred || Notebook.isSearch) {\n        Note.renderNotesAndTargetNote(Note._everNotes, false, false);\n    } else {\n        // \u5176\u5b9e\u8fd9\u91cc\u4e5f\u53ef\u4ee5\u7528Note._everNotes, \u4e3b\u8981\u662f\u4e3a\u4e86\u7f13\u5b58\u6570\u636e\n        Notebook.changeNotebook(Notebook.curNotebookId);\n    }\n    // Note.renderNotesAndTargetNote(Note._everNotes, false, false);\n\n\tApi.writeConfig(Config);\n};\n\n// render\u524d\u5148\u6392\u5e8f\nNote.sortNotes = function (notes) {\n\tif (isEmpty(notes)) {\n\t\treturn;\n\t}\n\n\tvar sorterAndOrder = Note.getSorterAndOrder();\n    var sortBy = sorterAndOrder.sortBy;\n    var isAsc = sorterAndOrder.isAsc;\n\n\t// \u6392\u5e8f\u4e4b\n    notes.sort(function(a, b) {\n        var t1 = a[sortBy];\n        var t2 = b[sortBy];\n\n        if (isAsc) {\n            if (t1 < t2) {\n                return -1;\n            } else if (t1 > t2) {\n                return 1;\n            }\n        } else {\n            if (t1 < t2) {\n                return 1;\n            } else if (t1 > t2) {\n                return -1;\n            }\n        }\n        return 0;\n    });\n};\n\nNote.getSorterAndOrder = function () {\n\tvar sortBy = \"UpdatedTime\";\n    var isAsc = false; // \u9ed8\u8ba4\u662f\u964d\u5e8f\n    if (Config.sortType) {\n    \tswitch(Config.sortType) {\n    \t\tcase 'dateCreatedASC':\n    \t\t\tsortBy = 'CreatedTime';\n    \t\t\tisAsc = true;\n    \t\t\tbreak;\n    \t\tcase 'dateCreatedDESC':\n    \t\t\tsortBy = 'CreatedTime';\n    \t\t\tisAsc = false;\n    \t\t\tbreak;\n    \t\tcase 'dateUpdatedASC':\n    \t\t\tsortBy = 'UpdatedTime';\n    \t\t\tisAsc = true;\n    \t\t\tbreak;\n    \t\tcase 'dateUpdatedDESC':\n    \t\t\tsortBy = 'UpdatedTime';\n    \t\t\tisAsc = false;\n    \t\t\tbreak;\n    \t\tcase 'titleASC':\n    \t\t\tsortBy = 'Title';\n    \t\t\tisAsc = true;\n    \t\t\tbreak;\n    \t\tcase 'titleDESC':\n    \t\t\tsortBy = 'Title';\n    \t\t\tisAsc = false;\n    \t\t\tbreak;\n    \t}\n    }\n    console.log({sortBy: sortBy, isAsc: isAsc});\n    return {sortBy: sortBy, isAsc: isAsc};\n};\n\n// \u5f97\u5230notebook\u4e0b\u7684notes, \u6309\u4ec0\u4e48\u6392\u5e8f updatedTime?\nNote.getNotesByNotebookId = function(notebookId) {\n    var sorterAndOrder = Note.getSorterAndOrder();\n    var sortBy = sorterAndOrder.sortBy;\n    var isAsc = sorterAndOrder.isAsc;\n\n    if (!notebookId) {\n        notebookId = \"all\";\n    }\n\n    if (!Note.cacheByNotebookId[notebookId]) {\n        return [];\n    }\n\n    if (Note.cacheByNotebookId[notebookId][sortBy]) {\n    \tif (Note.cacheByNotebookId[notebookId][sortBy][isAsc]) {\n    \t\treturn Note.cacheByNotebookId[notebookId][sortBy][isAsc];\n    \t}\n    \t// \u9006\u5e8f\n    \tNote.cacheByNotebookId[notebookId][sortBy][!isAsc].reverse();\n    \tvar notes = Note.cacheByNotebookId[notebookId][sortBy][!isAsc];\n    \tNote.cacheByNotebookId[notebookId][sortBy][!isAsc] = null;\n    \tNote.cacheByNotebookId[notebookId][sortBy][isAsc] = notes;\n    \treturn notes;\n    }\n\n    // \u4ece\u6240\u6709\u7684notes\u4e2d\u627e\u5230notebookId\u7684, \u5e76\u6392\u5e8f\u4e4b\n    var notes = [];\n    for (var i in Note.cache) {\n        if (!i) {\n            continue;\n        }\n        var note = Note.cache[i];\n        if (!note) {\n            continue;\n        }\n\n        if (!('IsMarkdown' in note)) {\n            console.error('\u50f5\u5c38note------');\n        }\n        // \u4e0d\u8981trash\u7684not, \u5171\u4eab\u7684\u4e5f\u4e0d\u8981\n        if (note.IsTrash || note.IsDeleted || note.LocalIsDelete) {\n            continue;\n        }\n        if (notebookId == \"all\" || note.NotebookId == notebookId) {\n            notes.push(note);\n        }\n    }\n\n    Note.sortNotes(notes);\n\n    // \u7f13\u5b58\u4e4b\n    Note.cacheByNotebookId[notebookId][sortBy] = {};\n    Note.cacheByNotebookId[notebookId][sortBy][isAsc] = notes;\n    return notes;\n};\n\n// called by Notebook\n// render \u6240\u6709notes, \u548c\u7b2c\u4e00\u4e2anote\u7684content\nNote.renderNotesAndFirstOneContent = function(ret) {\n    // \u9519\u8bef\u7684ret\u662f\u4e00\u4e2aObject\n    if (!isArray(ret)) {\n        return;\n    }\n\n    // note \u5bfc\u822a\n    Note.renderNotes(ret);\n    // \u6e32\u67d3\u7b2c\u4e00\u4e2a\n    if (!isEmpty(ret[0])) {\n        Note.changeNoteForPjax(ret[0].NoteId, true, false);\n    } else {}\n};\n\n// \u6e32\u67d3\u5e76\u5b9a\u4f4d\u5230\u7279\u5b9a\u7684\nNote.renderNotesAndTargetNote = function(ret, noteId, hasSorted) {\n    // \u9519\u8bef\u7684ret\u662f\u4e00\u4e2aObject\n    if (!isArray(ret)) {\n        return;\n    }\n\n    // note \u5bfc\u822a\n    Note.renderNotes(ret, false, hasSorted);\n    // \u6e32\u67d3\u7279\u5b9a\u7684\n    if (!isEmpty(ret[0])) {\n        if (noteId) {\n            // Note.changeNoteForPjax(noteId, true, false);\n            Note.changeNoteForPjax(noteId, true, false);\n            if (!Note.directToNote(noteId)) {\n                // \u627e\u4e0d\u5230\u554a\n                Note.changeNoteForPjax(ret[0].NoteId, true, false);\n            }\n        } else {\n            Note.changeNoteForPjax(ret[0].NoteId, true, false);\n        }\n    }\n};\n\nNote.alertWeb = function(msg) {\n    alert(msg);\n};\n\n// \u5f53\u524d\u7684note\u662f\u5426\u6539\u53d8\u8fc7\u4e86?\n// \u8fd4\u56de\u5df2\u6539\u53d8\u7684\u4fe1\u606f\nNote.curHasChanged = function(force) {\n    var cacheNote = Note.getCurNote();\n    if (!cacheNote || cacheNote.InitSync) { // \u8fd8\u6ca1\u6709\u540c\u6b65\u7684, \u4e0d\u80fd\u4fdd\u5b58\n        return false;\n    }\n    // else {\n    // \t// console.log('\u5f53\u524d\u7b14\u8bb0\u4e3a' + cacheNote.NoteId);\n    // }\n\n    // \u6536\u96c6\u5f53\u524d\u4fe1\u606f, \u4e0ecache\u6bd4\u5bf9\n    var title = $('#noteTitle').val();\n    var tags = Tag.input.getTags();\n\n    var hasChanged = {\n        hasChanged: false, // \u603b\u7684\u662f\u5426\u6709\u6539\u53d8\n        IsNew: cacheNote.IsNew, // \u662f\u5426\u662f\u65b0\u6dfb\u52a0\u7684\n        IsMarkdown: cacheNote.IsMarkdown, // \u662f\u5426\u662fmarkdown\u7b14\u8bb0\n        FromUserId: cacheNote.FromUserId, // \u662f\u5426\u662f\u5171\u4eab\u65b0\u5efa\u7684\n        NoteId: cacheNote.NoteId,\n        NotebookId: cacheNote.NotebookId\n    };\n\n    if (cacheNote.IsNew) {\n        hasChanged.hasChanged = true;\n    }\n\n    if (cacheNote.Title != title) {\n        hasChanged.hasChanged = true; // \u672c\u9875\u4f7f\u7528\u7528\u5c0f\u5199\n        hasChanged.Title = title; // \u8981\u4f20\u5230\u540e\u53f0\u7684\u7528\u5927\u5199\n    }\n\n    if (!arrayEqual(cacheNote.Tags, tags)) {\n        hasChanged.hasChanged = true;\n        hasChanged.Tags = tags;\n    }\n\n    // \u662f\u5426\u9700\u8981\u68c0\u67e5\u5185\u5bb9\u5462?\n    var needCheckContent = false;\n    if (cacheNote.IsNew || force || !Note.readOnly) {\n        needCheckContent = true;\n    }\n\n    // \u6807\u9898, \u6807\u7b7e, \u5185\u5bb9\u90fd\u6ca1\u6539\u53d8\n    if (!hasChanged.hasChanged && !needCheckContent) {\n        return false;\n    }\n\n    if (!needCheckContent) {\n        return hasChanged;\n    }\n\n    //===========\n    // \u5185\u5bb9\u7684\u6bd4\u8f83\n\n    // \u662fmardown\u7f16\u8f91\u5668, \u6216\u8005\u5bcc\u6587\u672c\u7f16\u8f91\u5668\u5df2Dirty\n    if (cacheNote.IsMarkdown || editorIsDirty()) {\n\n        // \u5982\u679c\u662fmarkdown\u8fd4\u56de[content, preview]\n        var contents = getEditorContent(cacheNote.IsMarkdown);\n        var content, preview;\n        if (isArray(contents)) {\n            content = contents[0];\n            preview = contents[1];\n            // preview\u53ef\u80fd\u6ca1\u6765\u5f97\u5230\u53ca\u89e3\u6790\n            if (content && previewIsEmpty(preview) && Converter) {\n                preview = Converter.makeHtml(content);\n            }\n            if (!content) {\n                preview = \"\";\n            }\n            cacheNote.Preview = preview; // \u4ec5\u4ec5\u7f13\u5b58\u5728\u524d\u53f0\n        } else if (cacheNote.IsMarkdown && typeof contents === 'boolean') {\n            // \u4e0d\u4f1a\u51fa\u73b0, \u56e0\u4e3a\u521a\u5f00\u59cb\u65f6readOnly=true, \u4e14\u53ea\u6709\u8bbe\u7f6e\u5185\u5bb9\u5b8c\u6210\u540e\u624dsetCurNoteId\n            // markdown\u7f16\u8f91\u5668\u8fd8\u6ca1\u51c6\u5907\u597d\n            throw new Error('markdown\u7f16\u8f91\u5668\u8fd8\u6ca1\u51c6\u5907\u597d');\n        }\n        // \u5bcc\u6587\u672c\u7f16\u8f91\u5668\n        else {\n            content = contents;\n        }\n\n        if (cacheNote.Content != content) {\n            hasChanged.hasChanged = true;\n            hasChanged.Content = content;\n\n            // \u4ecehtml\u4e2d\u5f97\u5230...\n            var c = preview || content;\n\n            // \u4e0d\u662f\u535a\u5ba2\u6216\u6ca1\u6709\u81ea\u5b9a\u4e49\u8bbe\u7f6e\u7684\n            if (!cacheNote.HasSelfDefined || !cacheNote.IsBlog) {\n                hasChanged.Desc = Note.genDesc(c);\n                hasChanged.ImgSrc = Note.getImgSrc(c);\n                hasChanged.Abstract = Note.genAbstract(c);\n            }\n        }\n\n        // \u5df2\u4fdd\u5b58\u4e86, \u4e0d\u518dDirty\n        setEditorIsDirty(false);\n    } else {\n        console.log('\u5185\u5bb9\u65e0\u4fee\u6539', 'isMarkdown:' + cacheNote.IsMarkdown, 'isDirty:' + editorIsDirty());\n    }\n\n    if (hasChanged.hasChanged) {\n        return hasChanged;\n    }\n    return false;\n};\n\n// \u7531content\u751f\u6210desc\n// \u6362\u884c\u4e0d\u8981\u66ff\u6362\nNote.genDesc = function(content, length) {\n    if (!content) {\n        return \"\";\n    }\n    if (!length) {\n        length = 20;\n    }\n\n    // \u7559\u7a7a\u683c\n    content = content.replace(/<br \\/>/g, \" \");\n    content = content.replace(/<\\/p>/g, \" \");\n    content = content.replace(/<\\/div>/g, \" \");\n\n    // \u975e\u5e38\u5371\u9669, \u4e07\u4e00markdown\u91cc, \u6216\u8005code\u91cc\u5199\u4e86<script></script>\u6216<http meta=refresh>\u4e4b\u7c7b\u7684\n    // \u907f\u514d\u5176\u5b83\u7684<img \u4e4b\u7c7b\u7684\u4e0d\u5b8c\u5168\n    // \u4e4b\u524d\u4f1a\u5c06content\u653e\u5230<div></div>\u4e2d\n    // content = $(\"<div></div>\").html(content).text();\n    // content = $(\"<div>\" + content + \"</div>\").text();\n\n    // \u5c06html tags\u5168\u90e8\u5220\u9664\n    content = content.replace(/<\\/?[^>]+(>|$)/g, \"\");\n    content = $.trim(content);\n    // pre\u4e0btext()\u4f1a\u5c06&lt; => < &gt; => >\n    content = content.replace(/</g, \"&lt;\");\n    content = content.replace(/>/g, \"&gt;\");\n\n    if (content.length < length) {\n        return content;\n    }\n\n    return content.substring(0, length);\n}\n\n// \u5f97\u5230\u6458\u8981\nNote.genAbstract = function(content, len) {\n    if (!content) {\n        return \"\";\n    }\n    if (len == undefined) {\n        len = 1000;\n    }\n    if (content.length < len) {\n        return content;\n    }\n    var isCode = false;\n    var isHTML = false;\n    var n = 0;\n    var result = \"\";\n    var maxLen = len;\n    for (var i = 0; i < content.length; ++i) {\n        var temp = content[i]\n        if (temp == '<') {\n            isCode = true\n        } else if (temp == '&') {\n            isHTML = true\n        } else if (temp == '>' && isCode) {\n            n = n - 1\n            isCode = false\n        } else if (temp == ';' && isHTML) {\n            isHTML = false\n        }\n        if (!isCode && !isHTML) {\n            n = n + 1\n        }\n        result += temp\n        if (n >= maxLen) {\n            break\n        }\n    }\n\n    var d = document.createElement(\"div\");\n    d.innerHTML = result\n    return d.innerHTML;\n};\n\nNote.fixImageSrc = function(src) {\n    return fixContentUrl(src);\n};\n\nNote.getImgSrc = function(content) {\n    if (!content) {\n        return \"\";\n    }\n    try {\n        var imgs = $(content).find(\"img\");\n        for (var i in imgs) {\n            var src = imgs.eq(i).attr(\"src\");\n            if (src) {\n                return src;\n            }\n        }\n    } catch (e) {}\n    return \"\";\n};\n\nNote.setNoteDirty = function(noteId, isDirty) {\n    console.trace('setNoteDirty');\n    var $leftNoteNav = $(tt('#noteItemList [noteId=\"?\"]', noteId));\n    if (!isDirty) {\n        $leftNoteNav.removeClass('item-err');\n    }\n    this.setNoteCache({ NoteId: noteId, IsDirty: isDirty }, false);\n    isDirty ? $leftNoteNav.addClass('item-dirty') : $leftNoteNav.removeClass('item-dirty');\n};\n\n// \u5982\u679c\u5f53\u524d\u7684\u6539\u53d8\u4e86, \u5c31\u4fdd\u5b58\u5b83\n// \u4ee5\u540e\u8981\u5b9a\u65f6\u8c03\u7528\n// force , \u9ed8\u8ba4\u662ftrue, \u8868\u5f3a\u6821\u9a8c\u5185\u5bb9\n// \u5b9a\u65f6\u4fdd\u5b58\u4f20false\nNote.saveInProcess = {}; // noteId => bool, true\u8868\u793a\u8be5note\u6b63\u5728\u4fdd\u5b58\u5230\u670d\u52a1\u5668, \u670d\u52a1\u5668\u672a\u54cd\u5e94\nNote.savePool = {}; // \u4fdd\u5b58\u6c60, \u4ee5\u540e\u7684\u4fdd\u5b58\u5148\u653e\u5728pool\u4e2d, id => note\nNote.savePoolNew = {}; // \u5982\u679c\u4e4b\u524d\u65b0\u5efa\u7684\u4fdd\u5b58\u4e86, \u8fde\u7eed2\u6b21\u4e8b\u4ef6, \u62d6\u52a8\u7b14\u8bb0, \u5219\u4f1a\u4fdd\u5b58\u65b0\u5efa\u4e24\u6b21, \u6b64\u65f6\u6570\u636e\u5e93\u4e2d\u51fa\u73b0\u4e24\u4e2anoteId\u4e00\u6837\u7684\nNote.curChangedSaveIt = function(force, callback) {\n    var me = Note;\n    // \u5982\u679c\u5f53\u524d\u6ca1\u6709\u7b14\u8bb0, \u4e0d\u4fdd\u5b58\n    if (!me.curNoteId) {\n        // console.trace('\u65e0\u5f53\u524d\u7b14\u8bb0!!');\n        callback && callback();\n        return;\n    }\n\n    try {\n        var hasChanged = Note.curHasChanged(force);\n    } catch (e) {\n        console.error('error curHasChanged:'); // + e.toString())\n        console.error(e);\n        callback && callback();\n        return;\n    }\n\n    if (hasChanged && hasChanged.hasChanged) {\n        // \u628a\u5df2\u6539\u53d8\u7684\u6e32\u67d3\u5230\u5de6\u8fb9 item-list\n        Note.renderChangedNote(hasChanged);\n\n        delete hasChanged.hasChanged;\n\n        // \u5148\u7f13\u5b58, \u628amarkdown\u7684preview\u4e5f\u7f13\u5b58\u8d77\u6765\n        Note.setNoteCache(hasChanged, false);\n\n        // \u8bbe\u7f6e\u66f4\u65b0\u65f6\u95f4\n        Note.setNoteCache({ \"NoteId\": hasChanged.NoteId, \"UpdatedTime\": new Date() }, false);\n        Note.clearCacheByNotebookId(hasChanged.NotebookId);\n\n        // \u4fdd\u5b58\u4e4b\n        me.saveInProcess[hasChanged.NoteId] = true;\n\n        if (hasChanged.IsNew) {\n            if (me.savePoolNew[hasChanged.NoteId]) {\n                console.log('\u8981\u4fdd\u5b58\u65b0\u5efa\u4e24\u6b21, \u88ab\u963b\u6b62')\n                return;\n            }\n            me.savePoolNew[hasChanged.NoteId] = true;\n        }\n\n        // console.log(hasChanged);\n        NoteService.updateNoteOrContent(hasChanged, function(ret) {\n            me.saveInProcess[hasChanged.NoteId] = false;\n            if (hasChanged.IsNew) {\n                // \u7f13\u5b58\u4e4b, \u540e\u53f0\u5f97\u5230\u5176\u5b83\u4fe1\u606f\n                ret.IsNew = false;\n                Note.setNoteCache(ret, false);\n\n                // \u65b0\u5efa\u7b14\u8bb0\u4e5f\u8981change history\n                Pjax.changeNote(ret);\n            }\n\n            me.setNoteDirty(hasChanged.NoteId, true);\n\n            callback && callback(ret);\n        }, force);\n\n        return hasChanged;\n\n    } else {\n        // \u5982\u679c\u662f\u5f3a\u5236\u7684, \u5219\u8981\u52a0\u5386\u53f2, \u4f46\u56e0\u7b14\u8bb0\u5185\u5bb9\u6ca1\u6539, \u6240\u4ee5\u4e4b\u524d\u4e0d\u4f1a\u6709\n        if (force) {\n            var note = me.getCurNote();\n            if (!note) {\n                return;\n            }\n            var content = getEditorContent(note.IsMarkdown);\n            if (isArray(content)) {\n                content = content[0];\n            }\n            NoteService.addNoteHistory(me.curNoteId, content, callback);\n            // console.log('\u5df2\u4fdd\u5b58\u5230\u5386\u53f2\u4e2d')\n        } else {\n            console.log('\u4e0d\u7528\u4fdd\u5b58 (^_^)');\n            callback && callback();\n        }\n    }\n    // callback && callback();\n    return false;\n};\n\n// \u66f4\u65b0\u6c60\u91cc\u7684\u7b14\u8bb0\nNote.updatePoolNote = function() {\n    var me = this;\n    for (var noteId in me.savePool) {\n        if (!noteId) {\n            continue;\n        }\n        // \u5220\u9664\u4e4b\n        delete me.savePool[noteId];\n        var hasChanged = me.savePool[noteId];\n        me.saveInProcess[noteId] = true;\n        ajaxPost(\"/note/updateNoteOrContent\", hasChanged, function(ret) {\n            me.saveInProcess[noteId] = false;\n        });\n    }\n};\n// \u542f\u52a8\u4fdd\u5b58, \u6682\u4e0d\u5904\u7406\nNote.updatePoolNoteInterval = null;\nNote.startUpdatePoolNoteInterval = function() {\n    return;\n    var me = this;\n    if (me.updatePoolNoteInterval) {\n        return;\n    }\n    me.updatePoolNoteInterval = setTimeout(function() {\n        log('update pool');\n        me.updatePoolNote();\n    }, 1000);\n};\n\nNote.clearSelect = function(target) {\n    $(\".item\").removeClass(\"item-active\");\n};\nNote.selectTarget = function(target) {\n    this.clearSelect();\n    $(target).addClass(\"item-active\");\n\n    // \u5224\u65ad\u662f\u5426\u5728star\u4e2d\n    var noteId = $(target).attr('noteId');\n    Note.selectStar(noteId);\n};\n\n// \u6539\u53d8note\n// \u53ef\u80fd\u6539\u53d8\u7684\u662fshare note\n// 1. \u4fdd\u5b58\u4e4b\u524d\u7684note\n// 2. ajax\u5f97\u5230\u73b0\u5728\u7684note\nNote.showContentLoading = function() {\n    $(\"#noteMaskForLoading\").css(\"z-index\", 11);\n};\nNote.hideContentLoading = function() {\n    $(\"#noteMaskForLoading\").css(\"z-index\", -1);\n};\n\n// \u5b9a\u4f4d\u5230\u7b14\u8bb0\nNote.directToNote = function(noteId) {\n    // alert(noteId);\n    var $t = $(\"[noteId='\" + noteId + \"']\");\n    if ($t.length == 0) {\n        return false;\n    }\n\n    var $p = $(\"#noteItemList\");\n    var pHeight = $p.height();\n\n    var scrollTop = $p.scrollTop();\n    var pTop = $t.position().top; // \u76f8\u5bf9\u4e8enoteItemList\u7684\u4f4d\u7f6e\n\n    // \u5f53\u524d\u7684\u53ef\u89c6\u8303\u56f4\u7684\u5143\u7d20\u4f4d\u7f6e\u662f[0, pHeight]\n    if (pTop >= 0 && pTop <= pHeight) {\n        // alert(pTop + ' ' + scrollTop + ' ' + pHeight)\n    } else {\n        // var top = pTop;\n        // console.log(\"\u5b9a\u4f4d\u5230\u7279\u5b9anote, \u5728\u53ef\u89c6\u8303\u56f4\u5185\");\n        $(\"#noteItemList\").scrollTop(pTop + scrollTop);\n    }\n    return true;\n};\n\n// mustPush\u8868\u793a\u662f\u5426\u5c06\u72b6\u6001push\u5230state\u4e2d, \u9ed8\u8ba4\u4e3atrue\n// \u4ec0\u4e48\u65f6\u5019\u4e3afalse, \u5728popstate\u65f6\n// needTargetNobook\u9ed8\u8ba4\u4e3afalse, \u5728\u70b9\u51fbnotebook, renderfirst\u65f6\u4e3afalse\nNote.changeNoteForPjax = function(noteId, mustPush, needTargetNotebook) {\n    // console.trace('changeNoteForPjax');\n    var me = this;\n    if (!noteId) {\n        return;\n    }\n    var note = me.getNote(noteId);\n    if (!note) {\n        return;\n    }\n    var isShare = note.Perm != undefined;\n    if (needTargetNotebook == undefined) {\n        needTargetNotebook = true;\n    }\n    me.changeNote(noteId, isShare, true, function(note) {\n        // push state\n        if (mustPush == undefined) {\n            mustPush = true;\n        }\n        if (mustPush) {\n            Pjax.changeNote(note);\n        }\n\n        // popstate\u65f6\u867d\u7136\u9009\u4e2d\u4e86note, \u4f46\u4f4d\u7f6e\u53ef\u80fd\u4e0d\u53ef\u89c1\n        if (needTargetNotebook) {\n            Note.directToNote(noteId);\n        }\n    });\n\n    // \u7b2c\u4e00\u6b21render\u65f6\u5b9a\u4f4d\u5230\u7b2c\u4e00\u4e2a\u7b14\u8bb0\u7684notebook 12.06 life\n    // \u6216\u901a\u8fc7pop\u65f6\n    // \u4ec0\u4e48\u65f6\u5019\u9700\u8981? 1. \u7b2c\u4e00\u6b21changeNote, 2. pop\u65f6, \u53ea\u6709\u5f53\u70b9\u51fb\u4e86notebook\u540e\u624d\u4e0d\u8981\n\n    // \u8fd9\u91cc, \u4e07\u4e00\u662f\u5171\u4eab\u7b14\u8bb0\u5462?\n    // \u5207\u6362\u5230\u5171\u4eab\u4e2d\n    if (needTargetNotebook) {\n        if (isShare) {\n            if ($(\"#myShareNotebooks\").hasClass(\"closed\")) {\n                $(\"#myShareNotebooks .folderHeader\").trigger(\"click\");\n            }\n        } else {\n            if ($(\"#myNotebooks\").hasClass(\"closed\")) {\n                $(\"#myNotebooks .folderHeader\").trigger(\"click\");\n            }\n        }\n        // \u5982\u679c\u662f\u5b50\u7b14\u8bb0\u672c, \u90a3\u4e48\u8981\u5c55\u5f00\u7236\u7b14\u8bb0\u672c\n        Notebook.expandNotebookTo(note.NotebookId);\n    }\n};\n\n// \u70b9\u51fbnotebook\u65f6\u8c03\u7528, \u6e32\u67d3\u7b2c\u4e00\u4e2a\u7b14\u8bb0\nNote.contentAjax = null;\nNote.contentAjaxSeq = 1;\nNote.inChangeNoteId = '';\nNote.setCurNoteId = function(noteId) {\n    // console.trace('setCurNoteId: ' + noteId);\n    Note.curNoteId = noteId;\n    Note.inChangeNoteId = '';\n};\n// \u6e05\u7a7acurNoteId,\nNote.clearCurNoteId = function() {\n    // \u4e3a\u4ec0\u4e48\u8981++? \u907f\u514d\u521a\u6e05\u7a7a, \u56e0\u4e3a\u5185\u5bb9\u7684\u5ef6\u8fdf\u53c8\u8bbe\u7f6e\u56de\u53bb\u4e86\n    Note.contentAjaxSeq++;\n    this.curNoteId = null;\n};\n\nNote.changeNote = function(selectNoteId, isShare, needSaveChanged, callback) {\n    var self = this;\n    if (!selectNoteId) {\n        return;\n    }\n    // 1 \u505c\u6b62\u5b9a\u65f6\u5668\n    Note.stopInterval();\n\n    // 3\n    var target = self.getTargetById(selectNoteId);\n    Note.selectTarget(target);\n\n    // 1 \u4e4b\u524d\u7684note, \u5224\u65ad\u662f\u5426\u5df2\u6539\u53d8, \u6539\u53d8\u4e86\u5c31\u8981\u4fdd\u5b58\u4e4b\n    // \u8fd9\u91cc, \u5728\u641c\u7d22\u7684\u65f6\u5019\u603b\u662f\u4fdd\u5b58, \u641c\u7d22\u7684\u8bdd, \u6bd4\u8f83\u5feb, \u80af\u5b9a\u6ca1\u6709\u53d8\u5316, \u5c31\u4e0d\u8981\u6267\u884c\u8be5\u64cd\u4f5c\n    if (needSaveChanged == undefined) {\n        needSaveChanged = true;\n    }\n    if (needSaveChanged) {\n        Note.curChangedSaveIt(true);\n    }\n\n    // 2. \u8bbe\u7a7a, \u9632\u6b62\u5728\u5185\u5bb9\u5f97\u5230\u4e4b\u524d\u53c8\u53d1\u751f\u4fdd\u5b58\n    Note.clearCurNoteId();\n    Note.inChangeNoteId = selectNoteId;\n\n    // 2 \u5f97\u5230\u73b0\u5728\u7684\n    // ajax\u4e4b\n    var cacheNote = self.getNote(selectNoteId);\n    if (!cacheNote) {\n        return;\n    }\n\n    Note.renderNote(cacheNote);\n\n    // \u8fd9\u91cc\u8981\u5207\u6362\u7f16\u8f91\u5668\n    switchEditor(cacheNote.IsMarkdown);\n    Note.hideEditorMask();\n\n    setTimeout(function() {\n        Attach.renderNoteAttachNum(selectNoteId, true);\n    });\n\n    // \u4e0b\u9762\u5f88\u6162\n    Note.contentAjaxSeq++;\n    var seq = Note.contentAjaxSeq;\n\n    function setContent(ret, fromCache, seq2) {\n        // \u627e\u4e0d\u5230\u5185\u5bb9, \u5c31\u4e00\u76f4loading\n        if (!ret) {\n            console.error('\u53d6\u4e0d\u5230\u5185\u5bb9');\n            return;\n        }\n\n        cacheNote.InitSync = false;\n\n        ret = ret || {};\n        Note.contentAjax = null;\n        if (seq2 != Note.contentAjaxSeq) {\n            return;\n        }\n        if (!fromCache) {\n            Note.setNoteCache(ret, false);\n        }\n        // \u628a\u5176\u5b83\u4fe1\u606f\u4e5f\u5e26\u4e0a\n        ret = Note.cache[selectNoteId]\n        Note.renderNoteContent(ret, false, seq2);\n\n        self.hideContentLoading();\n\n        callback && callback(ret);\n    }\n\n    // \u4e0d\u662f\u521a\u540c\u6b65\u8fc7\u6765\u7684, \u4e14\u6709\u5185\u5bb9\n    if (!cacheNote.InitSync && cacheNote.Content) {\n        setContent(cacheNote, true, seq);\n        return;\n    }\n\n    self.showContentLoading();\n    Service.noteService.getNoteContent(cacheNote.NoteId, (function(seq2) {\n        return function(ret) {\n            setContent(ret, false, seq2);\n        }\n    })(seq));\n};\n\n// \u91cd\u65b0\u6e32\u67d3\u7b14\u8bb0, \u56e0\u4e3async\u66f4\u65b0\u4e86\nNote.reRenderNote = function(noteId) {\n    var me = this;\n\n    me.showContentLoading();\n    var note = Note.getNote(noteId);\n    Note.renderNote(note);\n    NoteService.getNoteContent(noteId, function(noteContent) {\n        if (noteContent) {\n            Note.setNoteCache(noteContent, false);\n            // \u786e\u4fdd\u91cd\u7f6e\u7684\u662f\u5f53\u524dnote\n            if (Note.curNoteId === noteId) {\n                Attach.renderNoteAttachNum(noteId, true);\n                Note.renderNoteContent(noteContent, true);\n            }\n        }\n        me.hideContentLoading();\n    });\n};\n\n// \u66f4\u6539\u4fe1\u606f\u5230\u5de6\u4fa7\n// \u5b9a\u65f6\u66f4\u6539 \u5f53\u524d\u6b63\u5728\u7f16\u8f91\u7684\u4fe1\u606f\u5230\u5de6\u4fa7\u5bfc\u822a\n// \u6216change select. \u4e4b\u524d\u7684note, \u5df2\u7ecf\u6539\u53d8\u4e86\nNote.renderChangedNote = function(changedNote) {\n    if (!changedNote) {\n        return;\n    }\n\n    // \u627e\u5230\u5de6\u4fa7\u76f8\u5e94\u7684note\n    var $leftNoteNav = $(tt('#noteItemList [noteId=\"?\"]', changedNote.NoteId));\n    if (changedNote.Title) {\n        $leftNoteNav.find(\".item-title\").html(trimTitle(changedNote.Title));\n        // \u5982\u679c\u6807\u9898\u6539\u4e86, \u5982\u679c\u4e5f\u5728star\u5217\u8868\u4e2d, \u90a3\u4e5f\u8981\u6539star\u7684\u6807\u9898\u554a\n        Note.changeStarNoteTitle(changedNote.NoteId, trimTitle(changedNote.Title));\n    }\n\n    if ($leftNoteNav.hasClass(\"list-item\")) {\n        return; //list view\u53ea\u9700\u8981\u66f4\u65b0title\n    }\n\n    if (changedNote.Desc) {\n        $leftNoteNav.find(\".desc\").html(trimTitle(changedNote.Desc));\n    }\n    if (changedNote.ImgSrc) {\n        var $thumb = $leftNoteNav.find(\".item-thumb\");\n        // \u6709\u53ef\u80fd\u4e4b\u524d\u6ca1\u6709\u56fe\u7247\n        if ($thumb.length > 0) {\n            $thumb.find(\"img\").attr(\"src\", Note.fixImageSrc(changedNote.ImgSrc));\n        } else {\n            $leftNoteNav.append(tt('<div class=\"item-thumb\" style=\"\"><img src=\"?\"></div>', Note.fixImageSrc(changedNote.ImgSrc)));\n            $leftNoteNav.addClass(\"item-image\");\n        }\n        $leftNoteNav.find(\".item-desc\").removeAttr(\"style\");\n    } else if (changedNote.ImgSrc == \"\") {\n        $leftNoteNav.find(\".item-thumb\").remove(); // \u4ee5\u524d\u6709, \u73b0\u5728\u6ca1\u6709\u4e86\n        $leftNoteNav.removeClass(\"item-image\");\n    }\n};\n\n// \u6e05\u7a7a\u53f3\u4fa7note\u4fe1\u606f, \u53ef\u80fd\u662f\u5171\u4eab\u7684,\n// \u6b64\u65f6\u9700\u8981\u6e05\u7a7a\u53ea\u8bfb\u7684, \u4e14\u5207\u6362\u5230note edit\u6a21\u5f0f\u4e0b\nNote.clearNoteInfo = function() {\n    Note.clearCurNoteId();\n    Tag.input.clearTags();\n    $(\"#noteTitle\").val(\"\");\n    setEditorContent(\"\");\n\n    // markdown editor\n    /*\n    $(\"#wmd-input\").val(\"\");\n    $(\"#wmd-preview\").html(\"\");\n    */\n\n    // \u53ea\u9690\u85cf\u5373\u53ef\n    $(\"#noteRead\").hide();\n};\n\n// \u6e05\u9664noteList\u5bfc\u822a\nNote.clearNoteList = function() {\n    Note.noteItemListO.html(\"\"); // \u6e05\u7a7a\n}\n\n// \u6e05\u7a7a\u6240\u6709, \u5728\u8f6c\u6362notebook\u65f6\u4f7f\u7528\nNote.clearAll = function() {\n    // \u5f53\u524d\u7684\u7b14\u8bb0\u6e05\u7a7a\u6389\n    Note.clearCurNoteId();\n\n    Note.clearNoteInfo();\n    Note.clearNoteList();\n};\n\n// render\u5230\u7f16\u8f91\u5668\n// render note\nNote.renderNote = function(note) {\n    if (!note) {\n        return;\n    }\n    var title = note.Title || '';\n    title = title.replace(/&lt;/g, '<').replace(/&gt;/g, '>');\n    // title\n    $(\"#noteTitle\").val(title);\n\n    // \u5f53\u524d\u6b63\u5728\u7f16\u8f91\u7684\n    // tags\n    Tag.input.setTags(note.Tags);\n};\n\n// render content\n// \u8fd9\u4e00\u6b65\u5f88\u6162\nNote.renderNoteContent = function(content, dontNeedSetReadonly, seq2) {\n    if (seq2 && seq2 != Note.contentAjaxSeq) {\n        return;\n    }\n    setEditorContent(content.Content, content.IsMarkdown, content.Preview, function() {\n        if (seq2 && seq2 != Note.contentAjaxSeq) {\n            return;\n        }\n        Note.setCurNoteId(content.NoteId);\n\n        if (!dontNeedSetReadonly) {\n            Note.toggleReadOnly();\n        }\n    });\n\n    // \u53ea\u6709\u5728renderNoteContent\u65f6\u624d\u8bbe\u7f6ecurNoteId\n    // Note.setCurNoteId(content.NoteId);\n\n    // \u91cd\u65b0\u6e32\u67d3\u5230\u5de6\u4fa7 desc, \u56e0\u4e3a\u7b14\u8bb0\u4f20\u8fc7\u6765\u662f\u6ca1\u6709desc\u7684\n    var $leftNoteNav = $(tt('#noteItemList [noteId=\"?\"]', content.NoteId));\n    if ($leftNoteNav.find(\".desc\").text() == \"\") {\n        Note.renderNoteDesc(content);\n    }\n};\n\nNote.renderNoteDesc = function(note) {\n    // life\n    // \u91cd\u65b0\u6e32\u67d3\u5230\u5de6\u4fa7 desc, \u56e0\u4e3a\u7b14\u8bb0\u4f20\u8fc7\u6765\u662f\u6ca1\u6709desc\u7684\n    note.Desc = Note.genDesc(note.Content);\n    note.ImgSrc = Note.getImgSrc(note.Content);\n    Note.renderChangedNote(note);\n};\n\nNote.showEditorMask = function() {\n    $(\"#editorMask\").css(\"z-index\", 10).show();\n    // \u8981\u5224\u65ad\u662f\u5426\u662f\u5783\u573e\u7b52\n    if (Notebook.curNotebookIsTrashOrAll()) {\n        $(\"#editorMaskBtns\").hide();\n        $(\"#editorMaskBtnsEmpty\").show();\n    } else {\n        $(\"#editorMaskBtns\").show();\n        $(\"#editorMaskBtnsEmpty\").hide();\n    }\n};\n\nNote.hideEditorMask = function() {\n    $(\"#editorMask\").css(\"z-index\", -10).hide();\n};\n\n// \u8fd9\u91cc\u5982\u679cnotes\u8fc7\u591a>100\u4e2a\u5c06\u4f1a\u5f88\u6162!!, \u4f7f\u7528setTimeout\u6765\u5206\u89e3\nNote.renderNotesC = 0;\n/**\n * [renderNotes description]\n * @param  {[type]}  notes      [description]\n * @param  {[type]}  forNewNote [description]\n * @param  {Boolean} hasSorted  \u662f\u5426\u5df2\u6392\u5e8f\u8fc7\n * @return {[type]}             [description]\n */\nNote.renderNotes = function(notes, forNewNote, hasSorted) {\n    var renderNotesC = ++Note.renderNotesC;\n    var isShared = false;\n\n    this.clearSeqForNew();\n    this.batch.reset();\n\n    // \u4e3a\u4e86\u5207\u6362\u6392\u5e8f\u65b9\u5f0f\u7528\n    Note._everNotes = notes;\n\n    // \u624b\u673a\u7aef\u4e0d\u7528\n    // slimScroll\u4f7f\u5f97\u624b\u673a\u7aef\u6eda\u52a8\u4e0d\u6d41\u7545\n    if (!LEA.isMobile && !Mobile.isMobile()) {\n        // $(\"#noteItemList\").slimScroll({ scrollTo: '0px', height: \"100%\", onlyScrollBar: true});\n        $(\"#noteItemList\").scrollTop(0); // ({ scrollTo: '0px', height: \"100%\", onlyScrollBar: true});\n    }\n\n    if (!notes || typeof notes != \"object\" || notes.length <= 0) {\n        // \u5982\u679c\u6ca1\u6709, \u90a3\u4e48\u662f\u4e0d\u662f\u5e94\u8be5hide editor?\n        if (!forNewNote) {\n            Note.showEditorMask();\n        }\n        return;\n    }\n    Note.hideEditorMask();\n    // \u65b0\u5efa\u7b14\u8bb0\u65f6\u4f1a\u5148\u521b\u5efa\u4e00\u4e2a\u65b0\u7b14\u8bb0, \u6240\u4ee5\u4e0d\u80fd\u6e05\u7a7a\n    if (forNewNote == undefined) {\n        forNewNote = false;\n    }\n    if (!forNewNote) {\n        Note.noteItemListO.html(\"\"); // \u6e05\u7a7a\n    }\n\n    // \u91cd\u7f6e\u83b7\u53d6\u5185\u5bb9\n    // console.trace('--------render notes-----------');\n    Note.resetGetNoteContentLazy();\n\n    // \u91cd\u65b0\u6392\u5e8f\n    if (!hasSorted) {\n\t    Note.sortNotes(notes);\n    }\n\n    // 20\u4e2a\u4e00\u6b21\n    var len = notes.length;\n    var c = Math.ceil(len / 20);\n\n    Note._renderNotes(notes, forNewNote, isShared, 1);\n\n    // \u5148\u8bbe\u7f6e\u7f13\u5b58\n    for (var i = 0; i < len; ++i) {\n        var note = notes[i];\n        // \u4e0d\u6e05\u7a7a\n        // \u4e4b\u524d\u662faddNoteCache, \u5982\u679c\u662f\u641c\u7d22\u51fa\u7684, \u4f1a\u628a\u5185\u5bb9\u90fd\u91cd\u7f6e\u4e86\n        Note.setNoteCache(note, false);\n    }\n\n    for (var i = 1; i < c; ++i) {\n        setTimeout(\n            (function(i) {\n                // \u9632\u6b62\u8fd8\u6ca1\u6e32\u67d3\u5b8c\u5c31\u70b9\u51fb\u53e6\u4e00\u4e2anotebook\u4e86\n                return function() {\n                    if (renderNotesC == Note.renderNotesC) {\n                        Note._renderNotes(notes, forNewNote, isShared, i + 1);\n                    }\n                }\n            })(i), i * 2000);\n    }\n};\n\nNote._getNoteHtmlObjct = function(note, isShared) {\n        var baseClasses = \"item-my\";\n        var classes = baseClasses;\n        if (note.IsDeleted) {\n            console.error('_getNoteHtmlObjct note.IsDeleted');\n            return;\n        }\n\n        var tmp;\n        if (note.ImgSrc) {\n            tmp = tt(Note.getItemTpl(), classes, this.newNoteSeq(), note.NoteId, Note.fixImageSrc(note.ImgSrc), note.Title || getMsg('UnTitled'), Notebook.getNotebookTitle(note.NotebookId), goNowToDatetime(note.UpdatedTime), note.Desc);\n        } else {\n            tmp = tt(Note.getItemTplNoImg(), classes, this.newNoteSeq(), note.NoteId, note.Title || getMsg('UnTitled'), Notebook.getNotebookTitle(note.NotebookId), goNowToDatetime(note.UpdatedTime), note.Desc);\n        }\n        // blog ?\n        var $tmp = $(tmp);\n        if (!note.IsBlog) {\n            $tmp.removeClass('item-b');\n        } else {\n            $tmp.addClass('item-b');\n        }\n        // star ?\n        if (note.Star) {\n            $tmp.addClass('item-is-star');\n        }\n\n        return tmp;\n    },\n    Note._renderNotes = function(notes, forNewNote, isShared, tang) { // \u7b2c\u51e0\u8d9f\n        var baseClasses = \"item-my\";\n\n        var len = notes.length;\n        for (var i = (tang - 1) * 20; i < len && i < tang * 20; ++i) {\n            var classes = baseClasses;\n\n            if (!forNewNote && i == 0) {\n                classes += \" item-active\";\n            }\n            var note = notes[i];\n            if (note.IsDeleted) {\n                console.error('note.IsDeleted');\n                continue;\n            }\n\n            note.Title = trimTitle(note.Title);\n            if (note.IsDirty || note.IsNew) {\n                classes += \" item-dirty\";\n            }\n            // \u4e0d\u662ftrash\u624d\u8981star, conflict fix\n            if (!note.IsTrash) {\n                // star ?\n                if (note.Star) {\n                    classes += ' item-is-star';\n                }\n                if (note.ConflictNoteId) {\n                    classes += ' item-conflict';\n                }\n            } else {\n                classes += ' item-is-trash';\n            }\n\n            if (note.Err) {\n                classes += ' item-err';\n            }\n\n            if (note.IsBlog) {\n                classes += ' item-b';\n            }\n\n            // \u8fd9\u91cc, \u5982\u679c\u6ca1\u6709\u5185\u5bb9, \u5219\u6dfb\u52a0\u5230\u5f02\u6b65\u6c60\u4e2d\n            if (note.InitSync) {\n                Note.addGetNoteContentLazy(note.NoteId);\n            }\n\n            if (!note.Desc && note.Content) {\n                note.Desc = Note.genDesc(note.Content);\n            }\n\n            var tmp;\n            if (note.ImgSrc) {\n                tmp = tt(Note.getItemTpl(), classes, i, note.NoteId, Note.fixImageSrc(note.ImgSrc), note.Title || getMsg('UnTitled'), Notebook.getNotebookTitle(note.NotebookId), goNowToDatetime(note.UpdatedTime), note.Desc || '');\n            } else {\n                tmp = tt(Note.getItemTplNoImg(), classes, i, note.NoteId, note.Title || getMsg('UnTitled'), Notebook.getNotebookTitle(note.NotebookId), goNowToDatetime(note.UpdatedTime), note.Desc || '');\n            }\n\n            Note.noteItemListO.append(tmp);\n        }\n    };\n\nNote._seqForNew = 0;\nNote.clearSeqForNew = function() {\n    this._seqForNew = 0;\n};\nNote.newNoteSeq = function() {\n    return --this._seqForNew;\n};\n\n// \u65b0\u5efa\u4e00\u4e2a\u7b14\u8bb0\n// \u8981\u5207\u6362\u5230\u5f53\u524d\u7684notebook\u4e0b\u53bb\u65b0\u5efa\u7b14\u8bb0\n// isShare\u65f6fromUserId\u624d\u6709\u7528\n// 3.8 add isMarkdown\nNote.newNote = function(notebookId, isShare, fromUserId, isMarkdown) {\n    var me = this;\n\n    // \u5207\u6362\u7f16\u8f91\u5668\n    switchEditor(isMarkdown);\n    Note.hideEditorMask();\n\n    Note.stopInterval();\n\n    Note.batch.reset();\n\n    // \u4fdd\u5b58\u5f53\u524d\u7684\u7b14\u8bb0\n    Note.curChangedSaveIt(true);\n\n    // \u65b0\u7b14\u8bb0\n    var note = {\n        NoteId: getObjectId(),\n        Title: '',\n        Tags: [],\n        Desc: '',\n        Content: '',\n        NotebookId: notebookId,\n        IsNew: true,\n        FromUserId: fromUserId,\n        IsMarkdown: isMarkdown,\n        CreatedTime: new Date(),\n        UpdatedTime: new Date()\n    }; // \u662f\u65b0\u7684\n\n    // \u6dfb\u52a0\u5230\u7f13\u5b58\u4e2d\n    Note.addNoteCache(note);\n    Note.clearCacheByNotebookId(notebookId);\n\n    // \u6e05\u7a7a\u9644\u4ef6\u6570\n    Attach.clearNoteAttachNum();\n\n    // \u662f\u5426\u662f\u4e3a\u5171\u4eab\u7684notebook\u6dfb\u52a0\u7b14\u8bb0, \u5982\u679c\u662f, \u5219\u8fd8\u8981\u8bb0\u5f55fromUserId\n    var newItem = \"\";\n\n    var baseClasses = \"item-my item-active\";\n\n    var notebook = Notebook.getNotebook(notebookId);\n    var notebookTitle = notebook ? notebook.Title : \"\";\n    var curDate = getCurDatetime();\n\n    newItem = tt(Note.getItemTplNoImg(), baseClasses, me.newNoteSeq(), note.NoteId, note.Title, notebookTitle, curDate, \"\");\n\n    newItem = $(newItem);\n    // newItem.find(\".item-blog\").hide();\n\n    // \u662f\u5426\u5728\u5f53\u524dnotebook\u4e0b, \u4e0d\u662f\u5219\u5207\u6362\u8fc7\u53bb, \u5e76\u5f97\u5230\u8be5notebook\u4e0b\u6240\u6709\u7684notes, \u8ffd\u52a0\u5230\u540e\u9762!\n    if (!Notebook.isCurNotebook(notebookId)) {\n        // \u5148\u6e05\u7a7a\u6240\u6709\n        Note.clearAll();\n\n        // \u63d2\u5165\u5230\u7b2c\u4e00\u4e2a\u4f4d\u7f6e\n        Note.noteItemListO.prepend(newItem);\n\n        // \u6539\u53d8\u4e3a\u5f53\u524d\u7684notebookId\n        // \u4f1a\u5f97\u5230\u8be5notebookId\u7684\u5176\u5b83\u7b14\u8bb0\n        Notebook.changeNotebookForNewNote(notebookId);\n    } else {\n        // \u63d2\u5165\u5230\u7b2c\u4e00\u4e2a\u4f4d\u7f6e\n        Note.noteItemListO.prepend(newItem);\n    }\n\n    Note.selectTarget($(tt('#noteItemList [noteId=\"?\"]', note.NoteId)));\n\n    setTimeout(function() {\n        $(\"#noteTitle\").focus();\n    });\n\n    Note.renderNote(note);\n    Note.renderNoteContent(note);\n    Note.setCurNoteId(note.NoteId);\n\n    // \u66f4\u65b0\u6570\u91cf\n    // Notebook.incrNotebookNumberNotes(notebookId);\n\n    // \u5207\u6362\u5230\u5199\u6a21\u5f0f\n    Note.toggleWriteable(true);\n};\n\n// \u540c\u6b65\nNote._syncRefreshE = $('#syncRefresh');\nNote._syncWarningE = $('#syncWarning');\nNote.showSpin = function() {\n    var me = this;\n    me._syncRefreshE.addClass('fa-spin');\n\n    // \u5982\u679c\u8d85\u8fc730\u79d2\u8fd8\u5728\u8f6c, \u8bc1\u660e\u6709\u95ee\u9898\u4e86\n    /*\n    setTimeout(function() {\n    \tif(me._syncRefreshE.hasClass('fa-spin')) {\n    \t\tme._syncRefreshE.removeClass('fa-spin');\n    \t\tNote.hideSyncProgress();\n    \t}\n    }, 30 * 1000);\n    */\n\n    // \u7981\u6b62\u81ea\u52a8\u4fdd\u5b58\n    me.stopInterval(true);\n};\nNote.hideSpin = function() {\n    var me = this;\n    me._syncRefreshE.removeClass('fa-spin');\n    // \u5f00\u59cb\u81ea\u52a8\u4fdd\u5b58\n    me.startInterval();\n};\n// nodejs\u8c03\u7528\nNote.syncFinished = function(hasError) {\n    var me = this;\n    me.hideSpin();\n    if (!hasError) {\n        me._syncWarningE.hide();\n    }\n    Note.hideSyncProgress();\n};\n// \u8fc7\u65f6\nNote.sync = function() {\n    var me = this;\n    me.showSpin();\n    SyncService.incrSync();\n    me.syncProgress(1);\n};\nNote._syncProgressO = $('#syncProgress');\nNote._syncProgressBarO = $('#syncProgressBar');\nNote.syncProgress = function(n) {\n    var me = this;\n    me._syncProgressO.removeClass('hide');\n    me._syncProgressBarO.css('width', n + '%');\n};\nNote.hideSyncProgress = function() {\n    var me = this;\n    // \u5347\u5230100, \u518d\u9690\u85cf\n    me.syncProgress(100);\n    setTimeout(function() {\n        me._syncProgressO.addClass('hide');\n    }, 1000);\n};\n\n// \u65ad\u7f51\u5904\u7406\n/*\n1. sync\u51fa\u73b0\u611f\u53f9\u53f7\n2. \u5982\u679c\u662f\u9700\u8981\u91cd\u65b0\u767b\u5f55, \u5219\u70b9\u51fb\u540e\u51fa\u73b0\u91cd\u65b0\u767b\u5f55\u7684\u754c\u9762\n*/\nNote.unConnected = function() {\n    var me = this;\n    me._syncWarningE.show();\n    SyncService.setSyncFinished(true);\n    me.hideSpin();\n    me._syncWarningE.data('reason', 'unConnected');\n    me._syncWarningE.attr('title', 'Network error');\n};\n// \u7f51\u7edc\u5df2\u7ecf\u8fde\u63a5\u597d\u4e86\nNote.connected = function() {\n    var me = this;\n    if (me._syncWarningE.data('reason') == 'unConnected') {\n    \tme._syncWarningE.data('reason', '-');\n    \tme._syncWarningE.hide();\n    }\n};\nNote.notLogin = function() {\n    var me = this;\n    me._syncWarningE.show();\n    me.hideSpin();\n    SyncService.setSyncFinished(true);\n    me._syncWarningE.data('reason', 'notLogin');\n    me._syncWarningE.attr('title', getMsg('You need to sign in Leanote'));\n};\nNote.needUpgradeAccount = function() {\n    var me = this;\n    me.hideSpin();\n    SyncService.setSyncFinished(true);\n    me._syncWarningE.show();\n    me._syncWarningE.data('reason', 'NEED-UPGRADE-ACCOUNT');\n    me._syncWarningE.attr('title', getMsg('You need to upgrade Leanote account'));\n};\n// \u70b9\u51fb\u611f\u53f9\u53f7, \u5904\u7406\u9519\u8bef\nNote.fixNetOrAuthError = function() {\n    var me = this;\n    var reason = me._syncWarningE.data('reason');\n\n    if (reason == 'unConnected') {\n        alert(getMsg('Network error, please check out your network.'));\n\n    } else if (reason == 'notLogin') {\n        alert(getMsg('You need to sign in Leanote'));\n        // \u5f39\u51fa\u767b\u5f55\u6846\u767b\u5f55\u4e4b, \u91cd\u65b0\u5f39\u51fa\n        toLogin();\n\n        // \u9700\u8981\u5347\u7ea7Leanote\n    } else if (reason == 'NEED-UPGRADE-ACCOUNT') {\n        alert(getMsg('You need to upgrade Leanote account'));\n        openExternal('https://leanote.com/pricing#buy');\n    }\n};\n\n// \u540c\u6b65\u8fdb\u5ea6\u663e\u793a\nNote.syncProcess = function(msg) {\n    $('#allProcess').hide();\n    $('#syncProcess').show().html(msg);\n    $('.loading-footer').show();\n};\n\n// \u4fdd\u5b58note ctrl + s\nNote.saveNote = function(e) {\n    var num = e.which ? e.which : e.keyCode;\n    // \u4fdd\u5b58\n    if ((e.ctrlKey || e.metaKey) && num == 83) { // ctrl + s or command + s\n        incrSync(true);\n        e.preventDefault();\n        return false;\n    } else {}\n\n    return;\n    // \u4ee5\u524d\u9700\u8981, \u4f46\u73b0\u5728\u662felectron, \u4e0d\u9700\u8981\n    // copy, paste\n    if (e.ctrlKey || e.metaKey) {\n        if (num == 67) { // ctrl + c\n            document.execCommand('copy');\n        } else if (num == 86) { // ctrl + v\n            // \u4e0d\u80fd\u8981, \u8981\u7684\u8bdd\u4f1a\u6709\u4e24\u6b21paste\n            // document.execCommand('paste');\n        } else if (num == 65) { // ctrl + a\n            document.execCommand('selectAll');\n        } else if (num == 88) { // ctrl + x\n            document.execCommand('cut');\n        }\n    }\n};\n\n// \u5220\u9664\u6216\u79fb\u52a8\u7b14\u8bb0\u540e, \u6e32\u67d3\u4e0b\u4e00\u4e2a\u6216\u4e0a\u4e00\u4e2a\nNote.changeToNext = function(target) {\n    var $target = $(target);\n    var next = $target.next();\n    if (!next.length) {\n        var prev = $target.prev();\n        if (prev.length) {\n            next = prev;\n        } else {\n            // \u5c31\u5b83\u4e00\u4e2a\n            Note.showEditorMask();\n            return;\n        }\n    }\n\n    Note.changeNote(next.attr(\"noteId\"));\n};\n\n// \u8981\u5220\u9664noteIds, \u627e\u4e0b\u4e00\u4e2a\u53ef\u4ee5\u7684\nNote.changeToNextSkipNotes = function(noteIds) {\n    var me = Note;\n    if (isEmpty(noteIds)) {\n        return;\n    }\n\n    // \u5168\u5220\u9664\u4e86\n    if (me.$itemList.find('li').length <= noteIds.length) {\n        me.showEditorMask();\n        return;\n    }\n\n    // \u5982\u679c\u53ea\u6709\u4e00\u4e2a\u7b14\u8bb0, \u4e14\u5f53\u524d\u6d3b\u8dc3\u7684\u53c8\u4e0d\u662f\u8981\u5220\u9664\u7684, \u5219\u4e0d\u7528change\n    if (noteIds.length == 1) {\n        var $actives = me.$itemList.find('.item-active');\n        if ($actives.length == 1 && $actives.attr('noteId') != noteIds[0]) {\n            return;\n        }\n    }\n\n    var $start = me.getTargetById(noteIds[0]);\n    var $next = $start.next();\n    var i = 1;\n    var len = noteIds.length;\n    var find = false;\n    while ($next.length) {\n        // \u8d85\u51fa\u4e86noteIds\n        if (i >= len) {\n            find = true;\n            break;\n        }\n        // \u4e0d\u5728\u5220\u9664\u7684\u5217\u8868\u4e2d\n        if ($next.attr('noteId') != me.getTargetById(noteIds[i]).attr('noteId')) {\n            find = true;\n            break;\n        }\n\n        $next = $next.next();\n        i++;\n    }\n\n    // \u627e\u4e0d\u5230, \u8bc1\u660e\u662f\u8981\u5230\u524d\u4e00\u4e2a\u4e86\n    if (!find) {\n        $next = $start.prev();\n    }\n\n    if ($next) {\n        me.changeNote($next.attr(\"noteId\"));\n    }\n};\n\n// \u5220\u9664\u7b14\u8bb0\nNote.deleteNote = function(target, contextmenuItem, isShared) {\n    var me = Note;\n\n    var noteIds;\n    if (me.inBatch) {\n        noteIds = me.getBatchNoteIds();\n    } else {\n        noteIds = [$(target).attr('noteId')];\n    }\n    if (isEmpty(noteIds)) {\n        return;\n    }\n\n    // \u5982\u679c\u5220\u9664\u7684\u662f\u5df2\u9009\u4e2d\u7684, \u8d76\u7d27\u8bbe\u7f6ecurNoteId = null\n    if (noteIds.length == 1 && $(target).hasClass(\"item-active\")) {\n        // -1 \u505c\u6b62\u5b9a\u65f6\u5668\n        Note.stopInterval();\n        // \u4e0d\u4fdd\u5b58\n        me.clearCurNoteId();\n        // \u6e05\u7a7a\u4fe1\u606f\n        Note.clearNoteInfo();\n    }\n\n    var $actives;\n    if (noteIds.length == 1) {\n        $actives = $(target);\n    } else {\n        $actives = me.$itemList.find('.item-active');\n    }\n\n    // 1\n    $actives.hide();\n    // 2\n    NoteService.deleteNote(noteIds, function(ret) {\n        if (ret) {\n            Note.changeToNextSkipNotes(noteIds);\n            $actives.remove();\n\n            // \u5220\u9664\u7f13\u5b58\n            for (var i = 0; i < noteIds.length; ++i) {\n                var noteId = noteIds[i];\n                var note = me.getNote(noteId);\n                if (note) {\n                    // \u53d6\u6d88star\n                    Note.unStar(noteId);\n\n                    /*\n                    \u7531\u540e\u7aef\u5230\u524d\u7aefrender\n                    if (!note.IsTrash) {\n                    \t// \u51cf\u5c11\u6570\u91cf\n                    \t// Notebook.minusNotebookNumberNotes(note.NotebookId);\n                    }\n                    */\n                    Note.clearCacheByNotebookId(note.NotebookId);\n\n                    // \u5220\u9664\u7f13\u5b58\n                    delete Note.cache[noteId];\n                }\n            }\n        }\n    });\n\n    me.batch.reset();\n    return;\n};\n\n// \u663e\u793a\u5171\u4eab\u4fe1\u606f\nNote.listNoteShareUserInfo = function(target) {\n    var noteId = $(target).attr(\"noteId\");\n    showDialogRemote(\"/share/listNoteShareUserInfo\", { noteId: noteId });\n}\n\n// \u5171\u4eab\u7b14\u8bb0\nNote.shareNote = function(target) {\n    var title = $(target).find(\".item-title\").text();\n    showDialog(\"dialogShareNote\", { title: getMsg(\"shareToFriends\") + \"-\" + title });\n\n    setTimeout(function() {\n        $(\"#friendsEmail\").focus();\n    }, 500);\n\n    var noteId = $(target).attr(\"noteId\");\n    shareNoteOrNotebook(noteId, true);\n}\n\n//---------------------------\n// \u641c\u7d22\n// \u6709\u70b9\u5c0f\u590d\u6742, \u56e0\u4e3a\u901f\u5ea6\u8fc7\u5feb\u4f1a\u5bfc\u81f4\u6ca1\u52a0\u8f7d\u5b8c, \u7136\u540e\u5c31\u4fdd\u5b58\u4e0a\u4e00\u4e2a => \u81f4\u4f7f\u6807\u9898\u6ca1\u6709\n// \u4e3a\u4ec0\u4e48\u4f1a\u6807\u9898\u6ca1\u6709?\nNote.lastSearch = null;\nNote.lastKey = null; // \u5224\u65ad\u662f\u5426\u4e0e\u4e0a\u4e00\u4e2a\u76f8\u7b49, \u76f8\u7b49\u5c31\u4e0d\u67e5\u8be2, \u5982\u679c\u662f\u7b49\u4e86\u5f88\u4e45\u518d\u6309enter?\nNote.lastSearchTime = new Date();\nNote.isOver2Seconds = false;\nNote.isSameSearch = function(key) {\n    // \u5224\u65ad\u65f6\u95f4\u662f\u5426\u8d85\u8fc7\u4e861\u79d2, \u8d85\u8fc7\u4e86\u5c31\u8ba4\u4e3a\u662f\u4e0d\u540c\u7684\n    var now = new Date();\n    var duration = now.getTime() - Note.lastSearchTime.getTime();\n    Note.isOver2Seconds = duration > 2000 ? true : false;\n    if (!Note.lastKey || Note.lastKey != key || duration > 1000) {\n        Note.lastKey = key;\n        Note.lastSearchTime = now;\n        return false;\n    }\n\n    if (key == Note.lastKey) {\n        return true;\n    }\n\n    Note.lastSearchTime = now;\n    Note.lastKey = key;\n    return false;\n}\n\n// \u641c\u7d22\u7b14\u8bb0\nNote.searchSeq = 0;\n\n// for recoverState\nNote.searchNoteSys = function(val, noteId) {\n    $(\"#searchNoteInput\").val(val);\n    var me = this;\n    NoteService.searchNote(val, function(notes) {\n        if (notes) {\n            Note.searchKey = val;\n            Notebook.changeCurNotebookTitle(getMsg('Search results'), false, notes.length, false, true);\n            Note.renderNotes(notes);\n            // markdown\u4e00\u65e6setContent\u5c31focus, \u5bfc\u81f4\u641c\u7d22\u5931\u53bb\u7126\u70b9\n            setTimeout(function() {\n                $(\"#searchNoteInput\").focus();\n            })\n            if (!isEmpty(notes)) {\n                Note.renderNotesAndTargetNote(notes, noteId, false);\n            }\n        } else {\n            // abort\u7684\n        }\n    });\n};\n\nNote.searchNote = function() {\n    var val = $(\"#searchNoteInput\").val();\n    if (!val) {\n        // \u5b9a\u4f4d\u5230all\n        Notebook.changeNotebook(\"0\");\n        return;\n    }\n    // \u5224\u65ad\u662f\u5426\u4e0e\u4e0a\u4e00\u4e2a\u662f\u76f8\u540c\u7684\u641c\u7d22, \u662f\u5219\u4e0d\u641c\u7d22\n    if (Note.isSameSearch(val)) {\n        return;\n    }\n\n    // \u4e4b\u524d\u6709, \u8fd8\u6709\u7ed3\u675f\u7684\n    // if(Note.lastSearch) {\n    // Note.lastSearch.abort();\n    // }\n\n    // \u6b65\u9aa4\u4e0etag\u7684\u641c\u7d22\u4e00\u6837\n    // 1\n    Note.curChangedSaveIt();\n\n    // 2 \u5148\u6e05\u7a7a\u6240\u6709\n    Note.clearAll();\n\n    // \u53d1\u9001\u8bf7\u6c42\u4e4b\n    // \u5148\u53d6\u6d88\u4e0a\u4e00\u4e2a\n    showLoading();\n\n    Note.searchSeq++;\n    var t = Note.searchSeq;\n    NoteService.searchNote(val, function(notes) {\n        hideLoading();\n        if (t == Note.searchSeq && notes) {\n            Note.searchKey = val;\n            Notebook.changeCurNotebookTitle(getMsg('Search results'), false, notes.length, false, true);\n            Note.renderNotes(notes);\n            // markdown\u4e00\u65e6setContent\u5c31focus, \u5bfc\u81f4\u641c\u7d22\u5931\u53bb\u7126\u70b9\n            setTimeout(function() {\n                $(\"#searchNoteInput\").focus();\n            })\n            if (!isEmpty(notes)) {\n                Note.changeNote(notes[0].NoteId, false /*, true || Note.isOver2Seconds*/ ); // isShare, needSaveChanged?, \u8d85\u8fc72\u79d2\u5c31\u8981\u4fdd\u5b58\n            }\n        } else {\n            // abort\u7684\n        }\n    });\n    // Note.lastSearch.abort();\n}\n\n//---------------\n//\u8bbe\u4e3ablog/unset\n\n\nNote.setNote2Blog = function(target, isBlog) {\n    var me = Note;\n\n    var noteIds;\n    if (me.inBatch) {\n        noteIds = me.getBatchNoteIds();\n    } else {\n        noteIds = [$(target).attr('noteId')];\n    }\n    if (isEmpty(noteIds)) {\n        return;\n    }\n\n    // \u662f\u65b0\u7b14\u8bb0 \u6216 \u5f53\u524d\u7b14\u8bb0\u5c31\u662f\u5b83\u7684, \u5219\u5148\u4fdd\u5b58\u4e4b\n    Note.curChangedSaveIt(true, function() {\n        NoteService.setNote2Blog(noteIds, isBlog, function(ret) {\n            if (ret) {\n                // \u89e6\u53d1\u540c\u6b65\n                incrSync();\n            }\n        });\n    });\n};\n\n// \u8bbe\u7f6enotebook\u7684blog\u72b6\u6001\n// \u5f53\u4fee\u6539notebook\u662f\u5426\u662fblog\u65f6\u8c03\u7528\nNote.setAllNoteBlogStatus = function(notebookId, isBlog) {\n    if (!notebookId) {\n        return;\n    }\n    var notes = Note.getNotesByNotebookId(notebookId);\n    if (!isArray(notes)) {\n        return;\n    }\n    var len = notes.length;\n    if (len == 0) {\n        for (var i in Note.cache) {\n            if (Note.cache[i].NotebookId == notebookId) {\n                Note.cache[i].IsBlog = isBlog;\n            }\n        }\n    } else {\n        for (var i = 0; i < len; ++i) {\n            notes[i].IsBlog = isBlog;\n        }\n    }\n};\n\n// \u79fb\u52a8\nNote.moveNote = function(target, data) {\n    var me = Note;\n    // \u6279\u91cf\u64cd\u4f5c\n    var noteIds;\n    if (Note.inBatch) {\n        noteIds = me.getBatchNoteIds();\n    } else {\n        noteIds = [$(target).attr('noteId')];\n    }\n\n    // \u5f53\u524d\u5728\u8be5\u7b14\u8bb0\u672c\u4e0b\n    var toNotebookId = data.notebookId;\n    if (Notebook.getCurNotebookId() == toNotebookId) {\n        return;\n    }\n\n    if (noteIds.length == 1) {\n        var note = me.getNote(noteIds[0]);\n        if (!note.IsTrash && note.NotebookId == toNotebookId) {\n            return;\n        }\n    }\n\n    NoteService.moveNote(noteIds, toNotebookId, function(ret) {\n        if (ret) {\n            me.clearCacheByNotebookId(toNotebookId);\n\n            for (var i = 0; i < noteIds.length; ++i) {\n                var noteId = noteIds[i];\n                var note = me.getNote(noteId);\n                if (note) {\n                    // \u4fee\u6539\u7b14\u8bb0\u6570\u91cf\n                    if (note.NotebookId != toNotebookId) {\n                        Notebook.incrNotebookNumberNotes(toNotebookId);\n                        if (!note.IsTrash) {\n                            Notebook.minusNotebookNumberNotes(note.NotebookId);\n                        }\n                    } else if (note.IsTrash) {\n                        Notebook.incrNotebookNumberNotes(note.NotebookId);\n                    }\n\n                    me.clearCacheByNotebookId(note.NotebookId);\n\n                    // \u8bbe\u7f6e\u7f13\u5b58\n                    note.NotebookId = toNotebookId;\n                    note.IsTrash = false;\n                    note.UpdatedTime = new Date();\n                    me.setNoteCache(note);\n                }\n            }\n\n            var $actives;\n            if (noteIds.length == 1) {\n                $actives = target;\n            } else {\n                $actives = me.$itemList.find('.item-active');\n            }\n            // \u4e0d\u5728all\u4e0b, \u5c31\u5220\u9664\u4e4b\n            if (!Notebook.curActiveNotebookIsAll()) {\n                me.changeToNextSkipNotes(noteIds);\n                $actives.remove();\n            }\n            // \u5728all\u4e0b, \u4e0d\u8981\u5220\u9664\n            else {\n                // \u4e0d\u79fb\u52a8, \u90a3\u4e48\u8981\u6539\u53d8\u5176notebook title\n                $actives.find(\".note-notebook\").html(Notebook.getNotebookTitle(toNotebookId));\n\n                me.changeNote($actives.eq(0).attr('noteId'));\n            }\n        }\n    });\n\n    // \u91cd\u7f6e, \u56e0\u4e3a\u53ef\u80fd\u79fb\u52a8\u540e\u7b14\u8bb0\u4e0b\u6ca1\u7b14\u8bb0\u4e86\n    me.batch.reset();\n};\n\n// \u590d\u5236\n// data\u662f\u81ea\u52a8\u4f20\u6765\u7684, \u662fcontextmenu\u6570\u636e\nNote.copyNote = function(target, data, isShared) {\n    var me = Note;\n\n    var toNotebookId = data.notebookId;\n    var noteIds;\n    if (Note.inBatch) {\n        noteIds = me.getBatchNoteIds();\n    } else {\n        noteIds = [$(target).attr('noteId')];\n    }\n\n    // \u5f97\u5230\u9700\u8981\u590d\u5236\u7684\n    var needNoteIds = [];\n    for (var i = 0; i < noteIds.length; ++i) {\n        var noteId = noteIds[i];\n        var note = me.getNote(noteId);\n        if (note) {\n            // trash\u4e0d\u80fd\u590d\u5236, \u4e0d\u80fd\u590d\u5236\u7ed9\u81ea\u5df1\n            // \u56e0\u4e3acontexmenu\u4e0d\u80fddisable\u6709\u5b50menu\u7684\u9879, \u6240\u4ee5\u5141\u8bb8\u590d\u5236trash\n            if ( /*note.IsTrash || */ note.NotebookId == toNotebookId) {\n                continue;\n            }\n            needNoteIds.push(noteId);\n        }\n    }\n    if (needNoteIds.length == 0) {\n        return;\n    }\n\n    NoteService.copyNote(needNoteIds, toNotebookId, function(notes) {\n        if (!isEmpty(notes)) {\n            // \u91cd\u65b0\u6e05\u7a7acache \u4e4b\u540e\u7684\n            Note.clearCacheByNotebookId(toNotebookId);\n            for (var i = 0; i < notes.length; ++i) {\n                var note = notes[i];\n                if (!note.NoteId) {\n                    continue;\n                }\n                // \u6539\u53d8\u7f13\u5b58, \u6dfb\u52a0\u4e4b\n                Note.setNoteCache(note);\n\n                // \u589e\u52a0\u6570\u91cf\n                Notebook.incrNotebookNumberNotes(toNotebookId)\n            }\n        }\n    });\n};\n\n// \u5220\u9664\u7b14\u8bb0\u6807\u7b7e\n// item = {noteId => usn}\nNote.deleteNoteTag = function(item, tag) {\n    if (!item) {\n        return;\n    }\n    // noteId => note\n    for (var noteId in item) {\n        var note = Note.getNote(noteId);\n        if (note) {\n            note.Tags = note.Tags || [];\n            for (var i = 0; i < note.Tags.length; ++i) {\n                if (note.Tags[i] == tag) {\n                    note.Tags.splice(i, 1);\n                    continue;\n                }\n            }\n            // \u5982\u679c\u5f53\u524d\u7b14\u8bb0\u662f\u5c55\u793a\u7684\u7b14\u8bb0, \u5219\u91cd\u65b0renderTags\n            if (noteId == Note.curNoteId) {\n                Tag.input.setTags(note.Tags);\n            }\n\n            Note.setNoteDirty(noteId, true);\n        }\n    }\n};\n\nNote.readOnly = true; // \u9ed8\u8ba4\u4e3atrue\nLEA.readOnly = true;\n// \u5207\u6362\u53ea\u8bfb\u6a21\u5f0f\nNote.toggleReadOnly = function(needSave) {\n    var me = this;\n    var note = me.getCurNote();\n\n    // tinymce\n    var $editor = $('#editor');\n    $editor.addClass('read-only').removeClass('all-tool'); // \u4e0d\u8981\u5168\u90e8\u7684\n\n    // \u4e0d\u53ef\u5199\n    $('#editorContent').attr('contenteditable', false);\n\n    // markdown\n    $('#mdEditor').addClass('read-only');\n    $('#note').addClass('read-only-editor');\n\n    if (!note) {\n        return;\n    }\n\n    if (note.IsMarkdown) {\n        $('#mdInfoToolbar .created-time').html(goNowToDatetime(note.CreatedTime));\n        $('#mdInfoToolbar .updated-time').html(goNowToDatetime(note.UpdatedTime));\n    } else {\n        $('#infoToolbar .created-time').html(goNowToDatetime(note.CreatedTime));\n        $('#infoToolbar .updated-time').html(goNowToDatetime(note.UpdatedTime));\n    }\n\n    // \u4fdd\u5b58\u4e4b\n    if (needSave) {\n        Note.curChangedSaveIt(true);\n    }\n\n    Note.readOnly = true;\n    LEA.readOnly = true;\n\n    if (!note.IsMarkdown) {\n        // \u91cc\u9762\u7684pre\u4e5f\u8bbe\u4e3a\u4e0d\u53ef\u5199\n        $('#editorContent pre').each(function() {\n            LeaAce.setAceReadOnly($(this), true);\n        });\n    }\n};\n\n// \u5207\u6362\u5230\u7f16\u8f91\u6a21\u5f0f\nLEA.toggleWriteable = Note.toggleWriteable = function(isFromNewNote) {\n    var me = Note;\n    var note = me.getCurNote();\n    if (note) {\n        if (note.InitSync) {\n            alert('Waiting for loading content from server');\n            return;\n        }\n    }\n\n    // $('#infoToolbar').hide();\n    $('#editor').removeClass('read-only');\n    $('#note').removeClass('read-only-editor');\n    $('#editorContent').attr('contenteditable', true);\n\n    // markdown\n    $('#mdEditor').removeClass('read-only');\n\n    if (!note) {\n        return;\n    }\n\n    Note.readOnly = false;\n    LEA.readOnly = false;\n\n    if (!note.IsMarkdown) {\n        // \u91cc\u9762\u7684pre\u4e5f\u8bbe\u4e3a\u4e0d\u53ef\u5199\n        $('#editorContent pre').each(function() {\n            LeaAce.setAceReadOnly($(this), false);\n        });\n\n        isFromNewNote || tinymce.activeEditor.focus();\n    } else {\n        if (MD) {\n            isFromNewNote || MD.focus();\n            MD.onResize();\n        }\n    }\n};\n\nNote.toggleWriteableAndReadOnly = function() {\n    if (LEA.readOnly) {\n        Note.toggleWriteable();\n    } else {\n        Note.toggleReadOnly(true);\n    }\n};\n\n// \u6e32\u67d3\u5217\u8868\nNote.starNotes = [];\nNote.starItemT = '<li data-id=\"?\"><a>?<span class=\"delete-star\" title=\"' + getMsg('Remove') + '\">X</span></a></li>';\nNote.starNotesO = $('#starNotes');\nNote.renderStars = function(notes) {\n    var me = this;\n    var notes = notes || me.starNotes;\n    me.starNotes = notes;\n    me.starNotesO.html('');\n    for (var i = 0; i < notes.length; ++i) {\n        var note = notes[i];\n        var t = tt(me.starItemT, note.NoteId, trimTitle(note.Title) || getMsg('Untitled'));\n        me.starNotesO.append(t);\n    }\n\n    if (notes.length == 0) {\n        me.starNotesO.html('<p class=\"no-info\">' + getMsg('No Starred Note') + '</p>');\n    }\n};\n\n// \u70b9\u51fb\u7b14\u8bb0, \u5224\u65ad\u662f\u5426\u5728star\u4e2d, \u5982\u679c\u5728, \u5219\u4e5f\u9009\u4e2d\nNote.selectStar = function(noteId) {\n    var me = this;\n    var target = me.starNotesO.find('li[data-id=\"' + noteId + '\"]');\n    me.starNotesO.find('li').removeClass('selected');\n    target.addClass('selected');\n};\n\n// \u70b9\u51fb, note\nNote.renderStarNote = function(target) {\n    var me = this;\n    var noteId = target.data('id');\n    // \u5982\u679c\u6ca1\u6709target, \u5219\u9009\u7b2c\u4e00\u4e2a\n    if (!noteId) {\n        target = me.starNotesO.find('li').eq(0);\n    }\n    var noteId = target.data('id');\n    if (!noteId) {\n        return;\n    }\n    me.starNotesO.find('li').removeClass('selected');\n    target.addClass('selected');\n\n\n    // \u5927BUG start\n    // \u5148\u4fdd\u5b58\u73b0\u6709\u7684\u554a\n    me.curChangedSaveIt();\n\n    // \u628a\u5f53\u524d\u7b14\u8bb0\u653e\u5728\u7b2c\u4e00\u4f4d\n    me.clearAll();\n\n    // \u5982\u679c\u6570\u636e\u6539\u4e86, me.starNotes \u7684content\u4e0d\u662f\u6700\u65b0\u7684\n    me.starNotes || (me.starNotes = []);\n    for (var i = 0; i < me.starNotes.length; ++i) {\n        me.starNotes[i] = me.getNote(me.starNotes[i].NoteId);\n    }\n    // \u5927BUG end\n\n    me.renderNotes(me.starNotes);\n    me.changeNoteForPjax(noteId, true, false);\n    me.directToNote(noteId);\n\n    // $('#curNotebookForLisNote').text(\"Starred\");\n    Notebook.changeCurNotebookTitle(getMsg('Starred'), true);\n};\n\n// \u7b14\u8bb0\u6807\u9898\u6539\u4e86\u540e, \u5982\u679c\u5728star\u4e2d, \u5219\u4e5f\u8981\u6539\u6807\u9898\nNote.changeStarNoteTitle = function(noteId, title) {\n    var me = this;\n    var cacheNote = me.getNote(noteId);\n    /*\n    if(!cacheNote.Star) {\n    \treturn;\n    }\n    */\n\n    var target = me.starNotesO.find('li[data-id=\"' + noteId + '\"]');\n    if (target.length == 1) {\n        target.find('a').html((title || 'Untitled') + '<span class=\"delete-star\" title=\"' + getMsg('Remove') + '\">X</span>');\n    }\n};\n\n// \u53d6\u6d88star, note delete/trash\u65f6\u53d6\u6d88star\nNote.unStar = function(noteId) {\n    var me = this;\n\n    // \u5220\u9664\u8be5stars\n    var has = false;\n    for (var i = 0; i < me.starNotes.length; ++i) {\n        var tNote = me.starNotes[i];\n        if (tNote.NoteId == noteId) {\n            var has = true;\n            me.starNotes.splice(i, 1);\n            break;\n        }\n    }\n\n    if (has) {\n        // \u91cd\u65b0\u6e32\u67d3\u4e4b\n        me.renderStars(me.starNotes);\n    }\n};\n\n// \u6536\u85cf\u6216\u53d6\u6d88\u6536\u85cf\nNote.star = function(noteId) {\n    var me = this;\n    var note = me.getNote(noteId);\n    if (!note || note.IsTrash) {\n        return;\n    }\n    var $target = $('[noteId=\"' + noteId + '\"]');\n    NoteService.star(noteId, function(ok, isStarred) {\n        if (ok) {\n            note.Star = isStarred;\n            if (isStarred) {\n                me.starNotes.unshift(note);\n                $target.addClass('item-is-star');\n            } else {\n                $target.removeClass('item-is-star');\n                // \u5220\u9664\u8be5stars\n                for (var i = 0; i < me.starNotes.length; ++i) {\n                    var tNote = me.starNotes[i];\n                    if (tNote.NoteId == noteId) {\n                        me.starNotes.splice(i, 1);\n                        break;\n                    }\n                }\n            }\n\n            // \u91cd\u65b0\u6e32\u67d3\u4e4b\n            me.renderStars(me.starNotes);\n        }\n    });\n};\n\n// \u663e\u793a\nNote._curFixNoteId = ''; // \u5f53\u524d\u8981\u5904\u7406\u7684\nNote._curFixNoteTarget = '';\nNote._conflictTipsElem = $('#conflictTips');\nNote._showConflictInfoInited = false;\n// \u521d\u59cb\u5316\u4e8b\u4ef6\nNote._initshowConflictInfo = function() {\n    var me = this;\n\n    // \u70b9\u51fb\u4e0e\u4e4b\u51b2\u7a81\u7684\u7b14\u8bb0, \u5219\u5c06\u8be5\u7b14\u8bb0\u663e\u793a\u5230\u5b83\u524d\u9762, \u5e76\u9009\u4e2d\n    Note._conflictTipsElem.find('.conflict-title').click(function() {\n        var conflictNoteId = $(this).data('id');\n        var conflictNote = me.getNote(conflictNoteId);\n        if (!conflictNote) {\n            alert('The note is not exists');\n            return;\n        }\n        // \u662f\u5426\u5728\u8be5\u5217\u8868\u4e2d?\n        var target = $(tt('#noteItemList [noteId=\"?\"]', conflictNoteId)); //\n        // \u5982\u679c\u5f53\u524d\u7b14\u8bb0\u5728\u7b14\u8bb0\u5217\u8868\u4e2d, \u90a3\u4e48\u751f\u6210\u4e00\u4e2a\u65b0\u7b14\u8bb0\u653e\u5728\u8fd9\u4e2a\u7b14\u8bb0\u4e0a\u9762\n        if (target.length > 0) {} else {\n            target = me._getNoteHtmlObjct(conflictNote);\n        }\n        // console.log(\">....>\");\n        // console.log(me._curFixNoteTarget);\n        // console.log(target);\n\n        target.insertAfter(me._curFixNoteTarget);\n        // alert(3);\n        // me._curFixNoteTarget.insertBefore(target);\n        // \u9009\u4e2d\u4e0e\u4e4b\u51b2\u7a81\u7684\u7b14\u8bb0\n        me.changeNote(conflictNoteId);\n    });\n};\nNote.showConflictInfo = function(target, e) {\n    var me = this;\n\n    var $li = $(target).closest('li');\n    var noteId = $li.attr('noteId');\n\n    var note = me.getNote(noteId);\n    if (!note) {\n        return;\n    }\n    var conflictNoteId = note.ConflictNoteId;\n\n    function conflictIsFixed() {\n        // \u53bb\u6389item-confict class\n        // \u5e76\u4e14\u6539\u53d8\n        $li.removeClass('item-conflict');\n        note.ConflictNoteId = \"\";\n        NoteService.conflictIsFixed(noteId);\n    }\n    if (!conflictNoteId) {\n        return conflictIsFixed();\n    }\n\n    var conflictNote = me.getNote(conflictNoteId);\n    if (!conflictNote) {\n        return conflictIsFixed();\n    }\n\n    me._curFixNoteId = noteId;\n    me._curFixNoteTarget = $li;\n\n    if (!me._showConflictInfoInited) {\n        me._showConflictInfoInited = true;\n        me._initshowConflictInfo();\n    }\n\n    // \u521d\u59cb\u5316\u6570\u636e\n    var titleElem = Note._conflictTipsElem.find('.conflict-title');\n    titleElem.text(conflictNote.Title);\n    titleElem.data('id', conflictNoteId);\n    Note._conflictTipsElem.find('.conflict-resolved').prop('checked', false);\n\n    ContextTips.show('#conflictTips', e, function() {\n        if (Note._conflictTipsElem.find('.conflict-resolved').prop('checked')) {\n            conflictIsFixed();\n        }\n    });\n};\n\n// \u5185\u5bb9\u5df2\u540c\u6b65\u6210\u529f\nNote.contentSynced = function(noteId, content) {\n    var me = this;\n    var note = me.getNote(noteId);\n    if (!note) {\n        // \u53ef\u80fd\u4e4b\u524d\u8fd8\u6ca1\u6709\n        // me.setNoteCache(noteId, {Content: content});\n        return;\n    }\n    if (note.InitSync) {\n        // \u91cd\u65b0render\u5185\u5bb9\n        note.InitSync = false;\n        note.Content = content;\n        if (me.curNoteId == noteId || me.inChangeNoteId == noteId) {\n            // alert(note.Title);\n            // \u91cd\u65b0\u6e32\u67d3\n            // alert(me.curNoteId == noteId); false\n            // alert(me.inChangeNoteId == noteId); true\n            Note.reRenderNote(noteId);\n        } else {\n            // \u751f\u6210desc\n            me.renderNoteDesc(note);\n        }\n    }\n};\n\n//------------------------\n// \u5f02\u6b65\u52a0\u8f7dnote content\n\n// \u6c60, \u6700\u592710\u4e2a\nNote._loadContentPool = [];\nNote._loadContentPoolSeq = 0;\nNote._startedGetNoteContentLazy = false;\nNote._stopGetNoteContentLazy = false;\n\nNote._loadContentRunSeq = 0;\n\nNote._loadContentStarted = {};\n\n// \u5728render notes\u65f6\n// \u5ef6\u8fdf\u52a0\u8f7d\u5185\u5bb9\n\n// \u91cd\u65b0render notes\u65f6, \u91cd\u7f6epool\nNote.resetGetNoteContentLazy = function() {\n    var me = this;\n    me._loadContentPool = [];\n    me._loadContentPoolSeq = 0;\n    me._stopGetNoteContentLazy = false;\n    me._startedGetNoteContentLazy = false;\n    me._loadContentRunSeq++;\n};\n\n// \u6dfb\u52a0\u5230\u6c60\u5b50\u4e2d\nNote.addGetNoteContentLazy = function(noteId) {\n    var me = this;\n    Note._loadContentPool.push(noteId);\n    me.startGetNoteContentLazy();\n};\n\n// render notes\u540e,\n// \u5f00\u59cb\u52a0\u8f7d\nNote.startGetNoteContentLazy = function() {\n    var me = this;\n\n    if (me._loadContentStarted[me._loadContentRunSeq]) {\n        return;\n    }\n    me._loadContentStarted[me._loadContentRunSeq] = true;\n\n    me.getNoteContentLazy(me._loadContentRunSeq);\n};\n\n// \u5f97\u5230\u4e0b\u4e00\u4e2a\u8981\u5904\u7406\u7684noteId\nNote._getNextNoteId = function() {\n    var me = this;\n    var noteId = me._loadContentPool[me._loadContentPoolSeq];\n    me._loadContentPoolSeq++;\n    return noteId;\n};\n\nNote.getNoteContentLazy = function(runSeq) {\n    var me = this;\n\n    // // \u6682\u505c\u4e86\n    // if (me._stopGetNoteContentLazy) {\n    // \treturn;\n    // }\n\n    // \u4e0d\u662f\u4e00\u4e2a\u65f6\u5019\u4e86\n    if (runSeq != me._loadContentRunSeq) {\n        console.log('\u4e0d\u662f\u4e00\u4e2a\u65f6\u5019\u4e86 ' + runSeq + '_' + me._loadContentRunSeq);\n        return;\n    }\n\n    var noteId = me._getNextNoteId();\n    if (!noteId) {\n        return;\n    }\n\n    var note = me.getNote(noteId);\n    if (note && !note.InitSync) {\n        console.log('\u4e0d\u7528\u52a0\u8f7d');\n        me.getNoteContentLazy(runSeq);\n        return;\n    }\n\n    console.log('\u6b63\u5728\u52a0\u8f7d....' + noteId);\n\n    setTimeout(function() {\n        NoteService.getNoteContent(noteId, function(contentO) {\n            if (typeof contentO == 'object') {\n                Note.contentSynced(noteId, contentO.Content);\n                me.getNoteContentLazy(runSeq);\n            }\n        });\n    }, 800);\n};\n\nNote.stopGetNoteContentLazy = function() {\n    var me = this;\n    me._stopGetNoteContentLazy = true;\n};\n\nNote.target = null; // \u5f53\u524d\u5904\u7406\u7684note\nNote.menuItemsForMove = {}; // notebookId => menu\nNote.menuItemsForCopy = {}; // notebookId => menu\nNote.getContextNotebooksSys = function(notebooks) {\n\n    var submenuMoves = new gui.Menu();\n    var submenuCopys = new gui.Menu();\n\n    for (var i in notebooks) {\n        (function(j) {\n            var notebook = notebooks[j];\n\n            var moveMenu = {\n                label: notebook.Title,\n                click: function() {\n                    Note.moveNote(Note.target, { notebookId: notebook.NotebookId });\n                }\n            };\n            var copyMenu = {\n                label: notebook.Title,\n                click: function() {\n                    Note.copyNote(Note.target, { notebookId: notebook.NotebookId });\n                }\n            };\n\n            if (!isEmpty(notebook.Subs)) {\n                var mc = Note.getContextNotebooksSys(notebook.Subs);\n                moveMenu.submenu = mc[0];\n                moveMenu.type = 'submenu';\n                copyMenu.submenu = mc[1];\n                copyMenu.type = 'submenu';\n            }\n\n            var move = new gui.MenuItem(moveMenu);\n            var copy = new gui.MenuItem(copyMenu);\n\n            Note.menuItemsForMove[notebook.NotebookId] = move;\n            Note.menuItemsForCopy[notebook.NotebookId] = copy;\n\n            submenuMoves.append(move);\n            submenuCopys.append(copy);\n\n        })(i);\n    }\n    return [submenuMoves, submenuCopys];\n};\n\n// Notebook\u8c03\u7528\nNote.contextmenu = null;\nNote.notebooksCopy = []; // share\u4f1a\u7528\u5230\nNote.initContextmenu = function() {\n    var self = Note;\n    var notebooks = Notebook.everNotebooks;\n\n    //-------------------\n    // \u53f3\u952e\u83dc\u5355\n    function noteMenu() {\n\n        var me = this;\n        // this.target = '';\n        this.menu = new gui.Menu();\n        this.del = new gui.MenuItem({\n            label: getMsg(\"Delete\"),\n            click: function(e) {\n                Note.deleteNote(self.target);\n            }\n        });\n\n        this.publicBlog = new gui.MenuItem({\n            label: getMsg(\"Public as blog\"),\n            click: function(e) {\n                Note.setNote2Blog(self.target, true);\n            }\n        });\n        this.unPublicBlog = new gui.MenuItem({\n            label: getMsg(\"Cancel public\"),\n            click: function(e) {\n                Note.setNote2Blog(self.target, false);\n            }\n        });\n\n        // var ms = Note.getContextNotebooksSys(notebooks);\n        // this.move.submenu = ms[0];\n        // this.copy.submenu = ms[1];\n\n        this.move = new gui.MenuItem({\n            label: getMsg(\"Move\"),\n            click: function(e) {\n                dialogOperateNotes({ notebooks: notebooks, func: 'move' });\n            }\n        });\n        this.copy = new gui.MenuItem({\n            label: getMsg(\"Copy\"),\n            click: function(e) {\n                dialogOperateNotes({ notebooks: notebooks, func: 'copy' });\n            }\n        });\n\n        function dialogOperateNotes(options) {\n            $(\"#leanoteDialog #modalTitle\").html(getMsg(\"selectNotebook\"));\n\n            $(\"#leanoteDialog .modal-body\").html('<p><strong>' + getMsg(\"doubleClick\") + '</strong></p><ul id=\"notebookTree\" class=\"ztree showIcon\"></ul>');\n            $(\"#leanoteDialog .modal-footer\").html('\\\n            \t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">' + getMsg(\"Close\") + '</button>\\\n            \t');\n            var callback;\n            if ('move' == options.func) {\n                callback = function(notebookId) {\n                    Note.moveNote(Note.target, { notebookId: notebookId });\n                }\n            } else if ('copy' == options.func) {\n                callback = function(notebookId) {\n                    Note.copyNote(Note.target, { notebookId: notebookId });\n                }\n            }\n            var notebookTree = $.fn.zTree.init($(\"#notebookTree\"), Notebook.getSimpleTreeSetting({ callback: callback }), options.notebooks);\n            delete options.title;\n            options.show = true;\n            $(\"#leanoteDialog\").modal(options);\n        }\n\n        // \u672c\u5730\u7b14\u8bb0\u4e0d\u80fd\u516c\u5f00\u4e3a\u535a\u5ba2\n        if (!UserInfo.IsLocal) {\n            this.menu.append(this.publicBlog);\n            this.menu.append(this.unPublicBlog);\n            this.menu.append(gui.getSeparatorMenu());\n        }\n\n        this.menu.append(this.del);\n        this.menu.append(gui.getSeparatorMenu());\n\n        this.menu.append(this.move);\n        this.menu.append(this.copy);\n\n        // \u5bfc\u51fa\n        var exportsSubMenus = new gui.Menu();\n        var exportMenus = Api.getExportMenus() || [];\n        for (var i = 0; i < exportMenus.length; ++i) {\n            (function(j) {\n\n                var menu = exportMenus[j];\n                var clickBac = menu.click;\n\n                var menuItem = new gui.MenuItem({\n                    label: menu.label,\n                    click: function(e) {\n                        if (Note.inBatch) {\n                            var noteIds = Note.getBatchNoteIds();\n                        } else {\n                            var noteIds = [$(self.target).attr('noteId')];\n                        }\n                        // var note = Note.getNote();\n                        clickBac && clickBac(noteIds);\n                    }\n                });\n\n                exportMenus[i].menu = menuItem;\n\n                exportsSubMenus.append(menuItem);\n            })(i);\n        }\n\n        if (exportMenus.length > 0) {\n            this.exports = new gui.MenuItem({\n                label: getMsg('Export'),\n                submenu: exportsSubMenus,\n                click: function(e) {}\n            });\n\n            this.menu.append(gui.getSeparatorMenu());\n            this.menu.append(this.exports);\n        }\n\n        this.enable = function(name, ok) {\n                this[name].enabled = ok;\n            }\n            // \u63a7\u5236disable\n        this.popup = function(e, target) {\n            self.target = target;\n            var noteIds;\n            if (Note.inBatch) {\n                noteIds = Note.getBatchNoteIds();\n            } else {\n                noteIds = [$(target).attr(\"noteId\")];\n            }\n\n            // \u5bfc\u51fa\u7684enabled\n            for (var i = 0; i < exportMenus.length; ++i) {\n                exportMenus[i].menu.enabled = exportMenus[i].enabled(noteIds);\n            }\n\n            // \u6279\u91cf, \u9664\u4e86\u5bfc\u51fapdf\u90fd\u53ef\u4ee5\u64cd\u4f5c\n            if (Note.inBatch) {\n                this.copy.enabled = true;\n                this.move.enabled = true;\n                this.publicBlog.enabled = true;\n                this.unPublicBlog.enabled = true;\n            } else {\n                var note = Note.getNote(noteIds[0]);\n                if (!note) {\n                    return;\n                }\n\n                if (note.IsTrash || Notebook.curNotebookIsTrash()) {\n                    this.copy.enabled = false; // \u6ca1\u7528\n                    this.publicBlog.enabled = false;\n                    this.unPublicBlog.enabled = false;\n                } else {\n                    this.copy.enabled = true;\n\n                    if (note.IsBlog) {\n                        this.publicBlog.enabled = false;\n                        this.unPublicBlog.enabled = true;\n                    } else {\n                        this.publicBlog.enabled = true;\n                        this.unPublicBlog.enabled = false;\n                    }\n                }\n            }\n\n            // this.menu.popup(gui.getCurrentWindow(), e.originalEvent.x, e.originalEvent.y);\n            this.menu.popup(gui.getCurrentWindow(), e.pageX, e.pageY);\n        }\n    }\n\n    var noteMenuSys = new noteMenu();\n\n    Note.noteMenuSys = noteMenuSys;\n};\n\n// \u9644\u4ef6\n// \u7b14\u8bb0\u7684\u9644\u4ef6\u9700\u8981ajax\u83b7\u53d6\n// \u5efa\u4e00\u5f20\u9644\u4ef6\u8868? attachId, noteId, \u5176\u5b83\u4fe1\u606f\n// note\u91cc\u6709attach_nums\u5b57\u6bb5\u8bb0\u5f55\u4e2a\u6570\n// [ok]\nvar Attach = {\n    loadedNoteAttachs: {}, // noteId => [attch1Info, attach2Info...] // \u6309\u7b14\u8bb0\n    attachsMap: {}, // attachId => attachInfo\n    getAttach: function(attachId) {\n        return this.attachsMap[attachId];\n    },\n    init: function() {\n        var self = this;\n        var me = this;\n        // \u663e\u793aattachs\n        $(\"#showAttach\").click(function() {\n            self.renderAttachs(Note.curNoteId);\n        });\n        // \u9632\u6b62\u70b9\u51fb\u9690\u85cf\n        self.attachListO.click(function(e) {\n            e.stopPropagation();\n        });\n        // \u5220\u9664\n        self.attachListO.on(\"click\", \".delete-attach\", function(e) {\n            e.stopPropagation();\n            var attachId = $(this).closest('li').data(\"id\");\n            var t = this;\n            if (confirm(getMsg(\"Are you sure to delete it ?\"))) {\n                // $(t).button(\"loading\");\n                self.deleteAttach(attachId);\n                // $(t).button(\"reset\");\n            }\n        });\n        // \u4e0b\u8f7d\n        var curAttachId = '';\n        self.attachListO.on(\"click\", \".download-attach\", function(e) {\n            e.stopPropagation();\n            var $li = $(this).closest('li');\n            var attachId = $li.data(\"id\");\n            var title = $li.find('.attach-title').text();\n\n            gui.dialog.showSaveDialog(gui.getCurrentWindow(), { title: title, defaultPath: gui.app.getPath('userDesktop') + '/' + title }, function(targetPath) {\n                if (targetPath) {\n                    var curAttach = me.getAttach(attachId);\n                    if (curAttach) {\n                        FileService.download(curAttach.Path, targetPath, function(ok, msg) {\n                            if (!ok) {\n                                Notify.show({ type: 'warning', title: 'Warning', body: 'File saved failed!' });\n                            } else {\n                                Notify.show({ title: 'Info', body: 'File saved successful!' });\n                            }\n                        });\n                    } else {\n                        alert('error');\n                    }\n                } else {}\n            });\n        });\n\n        // make link\n        self.attachListO.on(\"click\", \".link-attach\", function(e) {\n            e.stopPropagation();\n            var attachId = $(this).closest('li').data(\"id\");\n            var attach = self.attachsMap[attachId];\n            var src = EvtService.getAttachLocalUrl(attachId); // + \"/attach/download?attachId=\" + attachId;\n            // http://leanote.com/attach/download?attachId=54f7481638f4112ff000170f\n\n            Note.toggleWriteable();\n            if (LEA.isMarkdownEditor() && MD) {\n                MD.insertLink(src, attach.Title);\n            } else {\n                tinymce.activeEditor.insertContent('<a target=\"_blank\" href=\"' + src + '\">' + attach.Title + '</a>');\n            }\n        });\n\n        // \u6dfb\u52a0Attach\n        $('#chooseFile').click(function() {\n            gui.dialog.showOpenDialog(gui.getCurrentWindow(), {\n                    defaultPath: gui.app.getPath('userDesktop'),\n                    properties: ['openFile', 'multiSelections']\n                },\n                function(paths) {\n                    if (!paths) {\n                        return;\n                    }\n\n                    // \u5982\u679c\u662f\u65b0\u5efa\u7684\u7b14\u8bb0, \u5fc5\u987b\u5148\u4fdd\u5b58note\n                    var note = Note.getCurNote();\n                    if (note && note.IsNew) {\n                        Note.curChangedSaveIt(true);\n                    }\n\n                    FileService.addAttach(paths, Note.curNoteId, function(files) {\n                        if (files) {\n                            me.addAttachs(files);\n                        }\n                    });\n                }\n            );\n        });\n    },\n    attachListO: $(\"#attachList\"),\n    attachNumO: $(\"#attachNum\"),\n    attachDropdownO: $(\"#attachDropdown\"),\n    downloadAllBtnO: $(\"#downloadAllBtn\"),\n    linkAllBtnO: $(\"#linkAllBtn\"),\n    // \u6dfb\u52a0\u7b14\u8bb0\u65f6\n    clearNoteAttachNum: function() {\n        var self = this;\n        self.attachNumO.html(\"\").hide();\n    },\n    renderNoteAttachNum: function(noteId, needHide) {\n        var self = this;\n        var note = Note.getNote(noteId);\n        var attachs = note.Attachs;\n        var attachNum = attachs ? attachs.length : 0;\n        if (attachNum) {\n            self.attachNumO.html(\"(\" + attachNum + \")\").show();\n            self.downloadAllBtnO.show();\n            self.linkAllBtnO.show();\n        } else {\n            self.attachNumO.hide();\n            self.downloadAllBtnO.hide();\n            self.linkAllBtnO.hide();\n        }\n\n        // \u9690\u85cf\u6389\n        if (needHide) {\n            self.attachDropdownO.removeClass(\"open\");\n        }\n    },\n    _renderAttachs: function(attachs) {\n        var self = this;\n        // foreach \u5faa\u73af\u4e4b\n        /*\n        <li class=\"clearfix\">\n        \t<div class=\"attach-title\">leanote\u5b98abcefedafadfadfadfadfad\u65b9\u6587\u6863.doc</div>\n        \t<div class=\"attach-process\">\n        \t\t<button class=\"btn btn-sm btn-warning\">Delete</button>\n        \t\t<button class=\"btn btn-sm btn-deafult\">Download</button>\n        \t</div>\n        </li>\n        */\n        var html = \"\";\n        var attachNum = attachs.length;\n        // console.log(attachs);\n        for (var i = 0; i < attachNum; ++i) {\n            var each = attachs[i];\n            var path = each.Path;\n            // \u672c\u5730\u662f\u5426\u6709, \u6ca1\u6709, \u662f\u5426\u662f\u5728\u663e\u793a\u7684\u65f6\u5019\u624d\u53bb\u4ece\u670d\u52a1\u5668\u4e0a\u6293? \u4e0d\n            var disabled = '';\n            if (path) {\n                var d = '<i class=\"fa fa-download\"></i>';\n            } else {\n                d = '...'\n                disabled = 'disabled';\n                // \u901a\u8fc7\u540e\u7aef\u53bb\u4e0b\u8f7d\n                NoteService.downloadAttachFromServer(Note.curNoteId, each.ServerFileId, each.FileId);\n            }\n            html += '<li class=\"clearfix\" data-id=\"' + each.FileId + '\">' +\n                '<div class=\"attach-title\">' + each.Title + '</div>' +\n                '<div class=\"attach-process\"> ' +\n                '\t  <button class=\"btn btn-sm btn-warning delete-attach\" data-loading-text=\"...\" title=\"' + getMsg('Delete') + '\"><i class=\"fa fa-trash-o\"></i></button> ' +\n                '\t  <button type=\"button\" class=\"btn btn-sm btn-primary download-attach\" ' + disabled + ' title=\"' + getMsg('Save as') + '\">' + d + '</button> ' +\n                '\t  <button type=\"button\" class=\"btn btn-sm btn-default link-attach\" title=\"' + getMsg('Insert link into content') + '\"><i class=\"fa fa-link\"></i></button> ' +\n                '</div>' +\n                '</li>';\n            self.attachsMap[each.FileId] = each;\n        }\n        self.attachListO.html(html);\n\n        // \u8bbe\u7f6e\u6570\u91cf\n        var note = Note.getCurNote();\n        if (note) {\n            note.AttachNum = attachNum;\n            self.renderNoteAttachNum(note.NoteId, false);\n        }\n    },\n    // \u6e32\u67d3noteId\u7684\u9644\u4ef6\n    // \u5f53\u70b9\u51fb\"\u9644\u4ef6\"\u65f6\u52a0\u8f7d,\n    // TODO \u5224\u65ad\u662f\u5426\u5df2loaded\n    // note\u6dfb\u52a0\u4e00\u4e2aAttachs\n    renderAttachs: function(noteId) {\n        var self = this;\n        var note = Note.getNote(noteId);\n        note.Attachs = note.Attachs || [];\n        self.loadedNoteAttachs[noteId] = note.Attachs; // \u4e00\u4e2a\u5bf9\u8c61\n        self._renderAttachs(note.Attachs);\n        return;\n        /*\n\n        if(self.loadedNoteAttachs[noteId]) {\n        \tself._renderAttachs(self.loadedNoteAttachs[noteId]);\n        \treturn;\n        }\n        // \u663e\u793aloading\n        self.attachListO.html('<li class=\"loading\"><img src=\"public/images/loading-24.gif\"/></li>');\n        // ajax\u83b7\u53d6noteAttachs\n        ajaxGet(\"/attach/getAttachs\", {noteId: noteId}, function(ret) {\n        \tvar list = [];\n        \tif(ret.Ok) {\n        \t\tlist = ret.List;\n        \t\tif(!list) {\n        \t\t\tlist = [];\n        \t\t}\n        \t}\n        \t// \u6dfb\u52a0\u5230\u7f13\u5b58\u4e2d\n        \tself.loadedNoteAttachs[noteId] = list;\n        \tself._renderAttachs(list);\n        });\n        */\n    },\n    // \u6dfb\u52a0\u9644\u4ef6, attachment_upload\u4e0a\u4f20\u8c03\u7528\n    addAttach: function(attachInfo) {\n        var self = this;\n        self.loadedNoteAttachs[attachInfo.NoteId].push(attachInfo);\n        self.renderAttachs(attachInfo.NoteId);\n        // TOOD \u66f4\u65b0Note\u8868\n        self.updateAttachToDB(attachInfo.NoteId);\n    },\n    addAttachs: function(attachInfos) {\n        var self = this;\n        var noteId = '';\n        for (var i in attachInfos) {\n            var attachInfo = attachInfos[i];\n            noteId = attachInfo.NoteId;\n            self.loadedNoteAttachs[noteId].push(attachInfo);\n        }\n        self.renderAttachs(attachInfo.NoteId);\n        // TOOD \u66f4\u65b0Note\u8868\n        self.updateAttachToDB(noteId);\n    },\n    // \u5220\u9664\n    deleteAttach: function(attachId) {\n        var self = this;\n        var noteId = Note.curNoteId;\n        var attachs = self.loadedNoteAttachs[noteId];\n        for (var i = 0; i < attachs.length; ++i) {\n            if (attachs[i].FileId == attachId) {\n                // \u5220\u9664\u4e4b, \u5e76render\u4e4b\n                attachs.splice(i, 1);\n                break;\n            }\n        }\n        // self.loadedNoteAttachs[noteId] = attachs;\n        self.renderAttachs(noteId);\n        // TODO \u66f4\u65b0\n        self.updateAttachToDB(noteId);\n    },\n\n    // \u66f4\u65b0\u5230Note\u8868\u4e2d\n    updateAttachToDB: function(noteId) {\n        var self = this;\n        var attachs = self.loadedNoteAttachs[noteId]\n        NoteService.updateAttach(noteId, attachs);\n    },\n\n    // \u4e0b\u8f7d\n    downloadAttach: function(fileId) {\n        var self = this;\n    },\n    downloadAll: function() {},\n\n    // \u670d\u52a1\u5668\u7aef\u540c\u6b65\u6210\u529f\u540e\u8c03\u7528\n    attachSynced: function(attachs, attach, noteId) {\n        var me = this;\n        var fileId = attach.FileId;\n        var note = Note.getNote(noteId);\n        if (note) {\n            note.Attachs = attachs;\n            me.attachsMap[fileId] = attach;\n            if (noteId == Note.curNoteId) {\n                // \u91cd\u65b0render\u4e4b\n                me.renderAttachs(noteId);\n            }\n        }\n    }\n};\n\n//===============\n\n// \u6279\u91cf\u64cd\u4f5c\nNote.inBatch = false;\nNote.getBatchNoteIds = function() {\n    var noteIds = [];\n    var items = Note.$itemList.find('.item-active');\n    for (var i = 0; i < items.length; ++i) {\n        noteIds.push(items.eq(i).attr('noteId'));\n    }\n    return noteIds;\n};\nNote.batch = {\n    $noteItemList: $(\"#noteItemList\"),\n\n    cancelInBatch: function() {\n        Note.inBatch = false;\n        this.$body.removeClass('batch');\n    },\n    setInBatch: function() {\n        Note.inBatch = true;\n        this.$body.addClass('batch');\n    },\n\n    // \u662f\u5426\u662f\u591a\u9009, \u81f3\u5c11\u9009\u4e862\u4e2a\n    isInBatch: function() {\n        var me = this;\n        var items = me.$noteItemList.find('.item-active');\n        if (items.length >= 2) {\n            return true;\n        }\n        return false;\n    },\n\n    // \u5f97\u5230\u5f00\u59cb\u7684\u7b14\u8bb0\n    _startNoteO: null, // \u5f00\u59cb\u9009\u62e9\u7684\u7b14\u8bb0\n    getStartNoteO: function() {\n        var me = this;\n        if (!me._startNoteO) {\n            me._startNoteO = me.getCurSelected();\n        }\n        return me._startNoteO;\n    },\n\n    // \u6e05\u7a7a\u4ee5start\u5f00\u5934\u5df2\u9009\u62e9\u7684\n    // \u7528\u4e8eshift\n    _selectByStart: {}, // start.NoteId => [target1, target2]\n    clearByStart: function(noteId) {\n        var me = this;\n        if (!noteId) {\n            return;\n        }\n        var targets = this._selectByStart[noteId];\n        if (isEmpty(targets)) {\n            return;\n        }\n        for (var i = 0; i < targets.length; ++i) {\n            me.clearTarget(targets[i]);\n        }\n    },\n    selectTo: function($to) {\n        var $start = this.getStartNoteO();\n\n        var startSeq = +$start.data('seq');\n        var toSeq = +$to.data('seq');\n\n        var $start2, $to2, startSeq2, toSeq2;\n        if (startSeq < toSeq) {\n            $start2 = $start;\n            $to2 = $to;\n            startSeq2 = startSeq;\n            toSeq2 = toSeq;\n        } else {\n            $start2 = $to;\n            $to2 = $start;\n            startSeq2 = toSeq;\n            toSeq2 = startSeq;\n        }\n\n        // \u5148\u6e05\u7a7a\u4e4b\n        // \u6e05\u7a7a\u4ee5$start\u4e3a\u9996\u7684, \u5df2\u9009\u7684\u7b14\u8bb0\n        var startNoteId = $start.attr('noteId');\n        this.clearByStart(startNoteId);\n\n        var $now = $start2;\n        this._selectByStart[startNoteId] = [];\n        for (var i = startSeq2; i <= toSeq2; ++i) {\n            this.selectTarget($now);\n            this._selectByStart[startNoteId].push($now);\n            $now = $now.next();\n        }\n    },\n\n    selectAll: function() {\n        this.$noteItemList.find('li').addClass('item-active');\n    },\n\n    clearAllSelect: function() {\n        Note.clearSelect();\n    },\n\n    selectTarget: function($target) {\n        if ($target) {\n            $target.addClass('item-active');\n        }\n    },\n    clearTarget: function($target) {\n        if ($target) {\n            $target.removeClass('item-active');\n        }\n    },\n\n    // multi\u64cd\u4f5c\n    // \u9009\u62e9\u4e4b\u67d0\u4e00\n    // \u5982\u679c\u4e4b\u524d\u5df2\u9009\u62e9\u4e86, \u5219\u53d6\u6d88\u9009\u62e9\n    select: function($target) {\n        var me = this;\n        // \u4e4b\u524d\u5df2\u9009\u4e2d\n        if ($target.hasClass('item-active')) {\n            var isInBatch = this.isInBatch();\n            if (isInBatch) {\n                $target.removeClass('item-active');\n            }\n        } else {\n            me._startNoteO = $target;\n            this.selectTarget($target);\n        }\n    },\n\n    // \u5f97\u5230\u5f53\u524d\u9009\u4e2d\u7684\u5143\u7d20\n    getCurSelected: function() {\n        return this.$noteItemList.find('.item-active');\n    },\n\n    // \u5f53\u91cd\u65b0render\u540e\n    reset: function() {\n        this.cancelInBatch();\n        this._selectByStart = {};\n        this._startMove = false;\n        this._startNoteO = null;\n        this.clearRender();\n    },\n\n    // \u53ef\u4ee5\u591a\u9009\n    canBatch: function() {\n        return !Writting.isWriting();\n    },\n\n    init: function() {\n        var me = this;\n        me.$noteItemList.on(\"click\", \".item\", function(e) {\n            var $this = $(this);\n            var noteId = $this.attr(\"noteId\");\n            if (!noteId) {\n                return;\n            }\n\n            var isMulti = false;\n            var isConti = false;\n            if (me.canBatch()) {\n                if (e.shiftKey) {\n                    isConti = true;\n                } else {\n                    isMulti = e.metaKey || e.ctrlKey;\n                }\n            }\n\n            //----------\n            // \u591a\u9009\u64cd\u4f5c\n            //----------\n\n            if (isMulti || isConti) {\n                Note.curChangedSaveIt();\n            }\n\n            // \u591a\u9009\n            if (isMulti) {\n                me.select($this);\n\n                // \u8fde\u7eed\u9009\n            } else if (isConti) {\n                // \u9009\u62e9 \u5f00\u59cb\u4f4d\u7f6e\u5230\u7ed3\u675f\u4f4d\u7f6e\n                // \u5f53\u524d\u70b9\u51fb\u7684\u662f\u7ed3\u675f\u4f4d\u7f6e\n                me.selectTo($this);\n            }\n\n            //---------\n            // \u5355\u9009\n            //---------\n\n            // \u5426\u5219, \u4e0d\u662f\u591a\u9009, \u6e05\u7a7aitem-active\n            else {\n                Note.selectTarget($this);\n            }\n\n            me.finalFix();\n        });\n\n        //----------\n\n        // \u9f20\u6807\u62d6\u52a8\u5f00\u59cb\n        me._startMove = false;\n        me.$noteItemList.on(\"mousedown\", \".item\", function(e) {\n            if (!me.canBatch()) {\n                return;\n            }\n\n            // \u53f3\u952e\n            if (me.isContextMenu(e)) {\n                return;\n            }\n\n            if (!me._startMove && (e.metaKey || e.ctrlKey || e.shiftKey)) {\n                return;\n            }\n\n            me._startNoteO = $(this);\n            me._startMove = true;\n        });\n\n        // \u9f20\u6807\u6b63\u5728\u62d6\u52a8\n        me.$noteItemList.on(\"mousemove\", \".item\", function(e) {\n            if (me.canBatch() && me._startMove) {\n\n                Note.curChangedSaveIt();\n\n                me.clearAllSelect();\n\n                me.selectTo($(this));\n\n                me.finalFix(true);\n            }\n        });\n\n        var $body = $('body');\n        $body.on('mouseup', function() {\n            me._startMove = false;\n        });\n\n        // ctrl + all\n        $body.keydown(function(e) {\n            if (e.target && e.target.nodeName === 'BODY') {\n                if ((e.ctrlKey || e.metaKey) && e.which === 65) {\n                    e.preventDefault();\n\n                    if (me.canBatch()) {\n                        Note.curChangedSaveIt();\n\n                        me.selectAll();\n                        me.finalFix();\n                    }\n                }\n            }\n        });\n\n        // \u4e0d\u8ba9\u62d6\u52a8\n        me.$noteItemList.on(\"dragstart\", function(e) {\n            e.preventDefault();\n            e.stopPropagation();\n        });\n\n        me.initContextmenu();\n        me.initBatchStatus();\n    },\n\n    initContextmenu: function() {\n        var me = this;\n\n        me.$batchMask.on('contextmenu', function(e) {\n            e.preventDefault();\n            Note.noteMenuSys.popup(e, null);\n        });\n\n        me.$batchMask.find('.batch-info .fa').click(function(e) {\n            e.preventDefault();\n\n            e.pageX -= 70;\n            e.pageY += 10;\n\n            e.stopPropagation();\n            // \u6240\u4ee5\n            $(document).click();\n            Note.noteMenuSys.popup(e, null);\n        });\n    },\n\n    $body: $('body'),\n    finalFix: function(isMove) {\n        var me = this;\n        // \u9009\u62e9\u4e86\u51e0\u4e2a? \u5982\u679c >= 2\u5219\u662f\u6279\u91cf\u64cd\u4f5c\n        if (me.isInBatch()) {\n            // \u6e05\u7a7a\u5f53\u524d\u7b14\u8bb0, \u4e0d\u8ba9\u81ea\u52a8\u4fdd\u5b58\n            Note.clearCurNoteId();\n\n            me.renderBatchNotes();\n            me.setInBatch();\n\n            // \u5355\u4e2a\u5904\u7406\n        } else {\n            me.clearRender();\n            me.cancelInBatch();\n\n            // \u4e3a\u4ec0\u4e48\u8fd8\u8981\u5f97\u5230\u5f53\u524d\u9009\u4e2d\u7684, \u56e0\u4e3a\u6709\u53ef\u80fd\u662f\u53d6\u6d88\u9009\u62e9\n            // \u5f97\u5230\u5f53\u524d\u9009\u4e2d\u7684\n            var $target = me.getCurSelected();\n            if ($target) {\n                var noteId = $target.attr('noteId');\n\n                if (!isMove) {\n                    me._startNoteO = $target;\n                }\n\n                // \u624b\u673a\u7aef\u5904\u7406\n                Mobile.changeNote(noteId);\n                // \u5f53\u524d\u7684\u548c\u6240\u9009\u7684\u662f\u4e00\u4e2a, \u4e0d\u6539\u53d8\n                if (Note.curNoteId != noteId) {\n                    // \u4e0d\u7528\u91cd\u5b9a\u5411\u5230notebook\n                    Note.changeNoteForPjax(noteId, true, false);\n                }\n            }\n        }\n    },\n\n    // \u5224\u65ad\u662f\u5426\u662f\u53f3\u51fb\n    isContextMenu: function(evt) {\n        if ((evt.which != undefined && evt.which == 1) || evt.button == 1)\n            return false;\n        else if ((evt.which != undefined && evt.which == 3) || evt.button == 2)\n            return true;\n        return false;\n    },\n\n    //==========\n    _notes: {},\n    clearRender: function() {\n        this._notes = {};\n        this.$batchCtn.html('');\n        this.hideMask();\n    },\n    showMask: function() {\n        this.$batchMask.css({ 'z-index': 99 }).show();\n    },\n    hideMask: function() {\n        this.$batchMask.css({ 'z-index': -2 }).hide();\n    },\n    renderBatchNotes: function() {\n        var me = this;\n        me.showMask();\n\n        var selectedTargets = me.$noteItemList.find('.item-active');\n        me.$batchNum.html(selectedTargets.length);\n\n        var ids = {};\n        for (var i = 0; i < selectedTargets.length; ++i) {\n            var noteId = selectedTargets.eq(i).attr('noteId');\n            me.addTo(noteId);\n            ids[noteId] = 1;\n        }\n        for (var noteId in me._notes) {\n            if (!ids[noteId]) {\n                var $tmp = me._notes[noteId];\n                $tmp.css({ 'margin-left': '-800px' /*, 'margin-top': '100px'*/ });\n                setTimeout(function() {\n                    $tmp.remove();\n                }, 500);\n                delete me._notes[noteId];\n            }\n        }\n    },\n    $batchMask: $('#batchMask'),\n    $batchCtn: $('#batchCtn'),\n\n    initBatchStatus: function() {\n        $('#batchMask .batch-status').html(getMsg('<span></span> notes selected'));\n        this.$batchNum = $('#batchMask .batch-info span');\n    },\n\n    _i: 1,\n    getRotate: function() {\n        var me = this;\n        var time = me._i++;\n        var e = time % 2 === 0 ? 1 : -1;\n        var rotate = e * Math.random() * 70;\n        var margins = [0, 10, 20, 30, 40];\n        var margin = e * margins[time % 5] * 3;\n        // if (e < 0) {\n        margin -= 80;\n        // }\n        return [e * Math.random() * 30, margin];\n    },\n    addTo: function(noteId) {\n        var me = this;\n        if (me._notes[noteId]) {\n            return;\n        }\n        var note = Note.getNote(noteId);\n        var title = note.Title || getMsg('unTitled');\n        var desc = note.Desc || '...';\n        // desc = substr(note.Content, 0, 200);\n\n        var $note = $('<div class=\"batch-note\"><div class=\"title\">' + title + '</div><div class=\"content\">' + desc + '</div></div>');\n        me._notes[noteId] = $note;\n        var rotate = me.getRotate();\n        me.$batchCtn.append($note);\n        setTimeout(function() {\n            $note.css({ transform: 'rotate(' + rotate[0] + 'deg)', 'margin-left': rotate[1] + 'px' });\n        });\n    }\n};\n\n//------------------- \u4e8b\u4ef6\n$(function() {\n    // \u9644\u4ef6\u521d\u59cb\u5316\n    Attach.init();\n\n    Note.batch.init();\n\n    //------------------\n    // \u65b0\u5efa\u7b14\u8bb0\n    // 1. \u76f4\u63a5\u70b9\u51fb\u65b0\u5efa OR\n    // 2. \u70b9\u51fbnav for new note\n    $(\"#newNoteBtn, #editorMask .note\").click(function() {\n        var notebookId = $(\"#curNotebookForNewNote\").attr('notebookId');\n        Note.newNote(notebookId);\n    });\n    $(\"#newNoteMarkdownBtn, #editorMask .markdown\").click(function() {\n        var notebookId = $(\"#curNotebookForNewNote\").attr('notebookId');\n        Note.newNote(notebookId, false, \"\", true);\n    });\n    $(\"#notebookNavForNewNote\").on(\"click\", \"li div\", function() {\n        var notebookId = $(this).attr(\"notebookId\");\n        if ($(this).hasClass(\"new-note-right\")) {\n            Note.newNote(notebookId, false, \"\", true);\n        } else {\n            Note.newNote(notebookId);\n        }\n    });\n    $(\"#searchNotebookForAdd\").click(function(e) {\n        e.stopPropagation();\n    });\n    $(\"#searchNotebookForAdd\").keyup(function() {\n        var key = $(this).val();\n        Notebook.searchNotebookForAddNote(key);\n    });\n    $(\"#searchNotebookForList\").keyup(function() {\n        var key = $(this).val();\n        Notebook.searchNotebookForList(key);\n    });\n\n    // \u5207\u6362\u5217\u8868\u89c6\u56fe\n    $(\"#viewModeDropdown\").click(function() {\n        var noteViewMenus = new gui.Menu();\n        noteViewMenus.append(new gui.MenuItem({\n            checked: Config.view === \"snippet\",\n            label: Api.getMsg(\"Snippet View\"),\n            type: \"checkbox\",\n            click: function() {\n                Note.switchView('snippet');\n            }\n        }));\n        noteViewMenus.append(new gui.MenuItem({\n            checked: Config.view === \"list\",\n            label: Api.getMsg(\"List View\"),\n            type: \"checkbox\",\n            click: function() {\n                Note.switchView('list');\n            }\n        }));\n        noteViewMenus.append(new gui.MenuItem({type: \"separator\"}));\n        noteViewMenus.append(new gui.MenuItem({\n            checked: Config.sortType == \"dateCreatedASC\",\n            label: Api.getMsg(\"Date Created - ASC\"),\n            type: \"checkbox\",\n            click: function() {\n            \tNote.setNotesSorter('dateCreatedASC');\n            }\n        }));\n        noteViewMenus.append(new gui.MenuItem({\n            checked: Config.sortType == \"dateCreatedDESC\",\n            label: Api.getMsg(\"Date Created - DESC\"),\n            type: \"checkbox\",\n            click: function() {\n            \tNote.setNotesSorter('dateCreatedDESC');\n            }\n        }));\n        noteViewMenus.append(new gui.MenuItem({type: \"separator\"}));\n        noteViewMenus.append(new gui.MenuItem({\n            checked: Config.sortType == \"dateUpdatedASC\",\n            label: Api.getMsg(\"Date Updated - ASC\"),\n            type: \"checkbox\",\n            click: function() {\n            \tNote.setNotesSorter('dateUpdatedASC');\n            }\n        }));\n        noteViewMenus.append(new gui.MenuItem({\n            checked: !Config.sortType || Config.sortType == \"dateUpdatedDESC\",\n            label: Api.getMsg(\"Date Updated - DESC\"),\n            type: \"checkbox\",\n            click: function() {\n            \tNote.setNotesSorter('dateUpdatedDESC');\n            }\n        }));\n        noteViewMenus.append(new gui.MenuItem({type: \"separator\"}));\n        noteViewMenus.append(new gui.MenuItem({\n            checked: Config.sortType == \"titleASC\",\n            label: Api.getMsg(\"Title - ASC\"),\n            type: \"checkbox\",\n            click: function() {\n            \tNote.setNotesSorter('titleASC');\n            }\n        }));\n        noteViewMenus.append(new gui.MenuItem({\n            checked: Config.sortType == \"titleDESC\",\n            label: Api.getMsg(\"Title - DESC\"),\n            type: \"checkbox\",\n            click: function() {\n            \tNote.setNotesSorter('titleDESC');\n            }\n        }));\n\n        var $this = $(this);\n        var x = $this.offset().left;\n        var y = $this.offset().top + $this.height();\n        noteViewMenus.popup(gui.getCurrentWindow(), Math.round(x), Math.round(y));\n    });\n\n\n    //---------------------------\n    // \u641c\u7d22, \u6309enter\u624d\u641c\u7d22\n    /*\n    $(\"#searchNoteInput\").on(\"keyup\", function(e) {\n    \tNote.searchNote();\n    });\n    */\n    $(\"#searchNoteInput\").on(\"keydown\", function(e) {\n        var theEvent = e; // window.event || arguments.callee.caller.arguments[0];\n        if (theEvent.keyCode == 13 || theEvent.keyCode == 108) {\n            theEvent.preventDefault();\n            Note.searchNote();\n            return false;\n        }\n    });\n\n    $(\"#saveBtn\").click(function() {\n        Note.curChangedSaveIt(true);\n    });\n\n    // blog\n    $(\"#noteItemList\").on(\"click\", \".item-blog\", function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        // \u5f97\u5230ID\n        var noteId = $(this).closest('li').attr('noteId');\n        var note = Note.getNote(noteId);\n        if (note.ServerNoteId) {\n            openExternal(UserInfo.Host + '/blog/post/' + note.ServerNoteId);\n        }\n    });\n\n    // note setting\n    $(\"#noteItemList\").on(\"click\", \".item-setting\", function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        Note.noteMenuSys.popup(e, $(this).closest('li'));\n    });\n    $(\"#noteItemList\").on(\"contextmenu\", \"li\", function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        Note.noteMenuSys.popup(e, $(this));\n    });\n\n    // \u6536\u85cf\n    $(\"#noteItemList\").on(\"click\", \".item-star\", function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        var $li = $(this).closest('li');\n        var noteId = $li.attr('noteId');\n        Note.star(noteId);\n    });\n\n    Note.starNotesO = $('#starNotes');\n    // \u53d6\u6d88\u6536\u85cf\n    Note.starNotesO.on('click', '.delete-star', function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        var $li = $(this).closest('li');\n        var noteId = $li.data('id');\n        Note.star(noteId);\n    });\n    Note.starNotesO.on('click', 'a', function(e) {\n        var $li = $(this).closest('li');\n        Note.renderStarNote($li);\n    });\n\n    $(\"#noteItemList\").on(\"click\", \".item-conflict-info\", function(e) {\n        Note.showConflictInfo(this, e);\n    });\n\n    $(\"#noteItemList\").on(\"click\", \".item-warning\", function(e) {\n        var $li = $(this).closest('li');\n        var noteId = $li.attr('noteId');\n        var note = Note.getNote(noteId);\n        if (!note) {\n            return;\n        }\n        if (!note.Err) {\n            $li.removeClass('item-err');\n            return;\n        }\n        var err = note.Err;\n        var msg = getMsg('Sync error') + '\\n';\n        err.err && (msg = getMsg('Error') + ': ' + err.err + '\\n')\n        err.msg && (msg += getMsg('Message') + ': ' + getMsg(err.msg));\n        alert(msg);\n    });\n\n    Note._syncRefreshE = $('#syncRefresh');\n    Note._syncWarningE = $('#syncWarning');\n    // sync\n    Note._syncRefreshE.click(function() {\n        incrSync(true);\n    });\n\n    Note._syncWarningE.click(function() {\n        Note.fixNetOrAuthError();\n    });\n\n    // readony\n    // \u4fee\u6539\n    // $('.toolbar-update').click(function() {\n    // \tNote.toggleWriteable();\n    // });\n    $(\"#editBtn\").click(function() {\n        Note.toggleWriteableAndReadOnly();\n    });\n\n    // note title \u91cc\u6309tab, \u5207\u6362\u5230\u7f16\u8f91\u533a\n    $('#noteTitle').on(\"keydown\", function(e) {\n        var keyCode = e.keyCode || e.witch;\n        // tab\n        if (keyCode == 9) {\n            // \u4e00\u4e3e\u4e24\u5f97, \u5373\u5207\u6362\u5230\u4e86writable, \u53c8focus\u4e86\n            Note.toggleWriteable();\n            e.preventDefault();\n        }\n    });\n\n});\n\n// \u5b9a\u65f6\u5668\u542f\u52a8\nNote.startInterval();\n\n//----------------------\n// \u51b2\u7a81\u89e3\u51b3, \u589e\u91cfsync\u65f6\n// note\u662f\u670d\u52a1\u5668\u7aef\u7684\u7b14\u8bb0, newNote\u662f\u672c\u5730\u590d\u5236\u540e\u7684\u7b14\u8bb0\nNote.fixSyncConflict = function(note, newNote) {\n    // Note.cache[note.NoteId] = note;\n    // Note.cache[newNote.NoteId] = newNote;\n    Note.addNoteCache(note);\n    Note.addNoteCache(newNote);\n\n    var target = $(tt('#noteItemList [noteId=\"?\"]', note.NoteId)); //\n    // \u5982\u679c\u5f53\u524d\u7b14\u8bb0\u5728\u7b14\u8bb0\u5217\u8868\u4e2d, \u90a3\u4e48\u751f\u6210\u4e00\u4e2a\u65b0\u7b14\u8bb0\u653e\u5728\u8fd9\u4e2a\u7b14\u8bb0\u4e0a\u9762\n    if (target.length > 0) {\n        var newHtmlObject = Note._getNoteHtmlObjct(note);\n        if (newHtmlObject) {\n            $(newHtmlObject).insertBefore(target);\n        }\n    }\n    // \u5f53\u524d\u8fd9\u4e2a\u6362\u6210\u65b0\u590d\u5236\u7684\n    target.attr('noteId', newNote.NoteId);\n    target.addClass('item-conflict');\n    // \u91cd\u65b0render \u5de6\u4fa7\u4e0b, \u56e0\u4e3a\u6709\u51b2\u7a81\u4e86, \u4e0d\u8981render\u5185\u5bb9\u554a\n\n    // \u5982\u679c\u5f53\u524d\u7f16\u8f91\u7684\u662f\u8fd9\u4e2a\u7b14\u8bb0, \u90a3\u5207\u6362\u5230newNote\u4e0a\u6765\n    if (Note.curNoteId == note.NoteId) {\n        Note.setCurNoteId(newNote.NoteId);\n    }\n};\n\n// \u8bbe\u7f6e\u535a\u5ba2\u662f\u5426\u53ef\u4ee5\u89c1\nNote.setNoteBlogVisible = function(noteId, isBlog) {\n    var target = $(tt('#noteItemList [noteId=\"?\"]', noteId));\n    if (target.length) {\n        if (isBlog) {\n            target.addClass('item-b');\n        } else {\n            target.removeClass('item-b');\n        }\n    }\n};\n\n// \u4e3a\u4e86\u535a\u5ba2\n// \u670d\u52a1\u5668\u4e0a\u66f4\u65b0\u4e86, \u524d\u7aef\u4e5f\u6765\u66f4\u65b0\n// changeAdds \u6709\u4e86serverId\n// updates...\nNote.updateNoteCacheForServer = function(notes) {\n    if (isEmpty(notes)) {\n        return;\n    }\n    for (var i in notes) {\n        var note = notes[i];\n        if (note && !note.IsTrash && !note.IsDeleted) {\n            Note.setNoteCache({\n                NoteId: note.NoteId,\n                ServerNoteId: note.ServerNoteId,\n                IsBlog: note.IsBlog,\n            });\n            Note.setNoteBlogVisible(note.NoteId, note.IsBlog);\n        }\n    }\n};\n\n// \u66f4\u65b0\n// push\n// --> send changes\nNote.updateSync = function(notes) {\n    if (isEmpty(notes)) {\n        return;\n    }\n\n    var curNotebookIsTrash = Notebook.curNotebookIsTrash();\n\n    var currentIsDeleted = false;\n\n    for (var i = 0; i < notes.length; ++i) {\n        var note = notes[i];\n        note.InitSync = true; // \u9700\u8981\u91cd\u65b0\u83b7\u53d6\u5185\u5bb9\n        Note.addNoteCache(note);\n\n        // \u5982\u679c\u5f53\u524d\u4fee\u6539\u7684\u662f\u672c\u7b14\u8bb0, \u90a3\u4e48\u91cd\u65b0render\u4e4b\n        /*\n        \u8fd9\u91cc\u662f\u4e00\u4e2a\u91cd\u5927BUG\n        \t\u8fdc\u7a0b\u7b14\u8bb0sync -> \u672c\u5730\n        \t\u662ftrash\u64cd\u4f5c, \u5219\u524d\u7aef\u5148\u5220\u9664, delete cache, toggle next\n        \t\u4f46\u662f\u4f1a\u5f02\u6b65\u53d6content, \u53d6\u5230\u540e, reRender\u73b0\u6709\u7b14\u8bb0 -> renderContent, \u90a3\u4e48\u91cd\u7f6e\u4e3a\u5f53\u524d\u7b14\u8bb0\n        */\n        if (Note.curNoteId == note.NoteId && !(!curNotebookIsTrash && note.IsTrash)) {\n            Note.reRenderNote(Note.curNoteId);\n        }\n\n        // \u4e0d\u662fdirty\u7684\n        Note.setNoteDirty(note.NoteId, false);\n\n        // \u8bbe\u7f6e\u5f53\u524d\u662f\u5426\u662f\u535a\u5ba2\n        // alert(note.NoteId + \" \" + note.IsBlog);\n        Note.setNoteBlogVisible(note.NoteId, note.IsBlog);\n\n        // \u5982\u679c\u662ftrash, \u4e14\u5f53\u524d\u4e0d\u5728trash\u76ee\u5f55\u4e0b, \u4e14\u6709\u8be5\u7b14\u8bb0, \u5219\u5220\u9664\u4e4b\n        if (!curNotebookIsTrash && note.IsTrash) {\n\n            // \u524d\u7aef\u7f13\u5b58\u4e5f\u8981\u5220\u9664!!\n            // \u5148\u5220\u9664, \u4e0d\u7136changeToNext()\u4e4b\u524d\u4f1a\u5148\u4fdd\u5b58\u73b0\u5728\u7684, \u5bfc\u81f4\u50f5\u5c38note\n            Note.deleteCache(note.NoteId);\n\n            var target = $(tt('#noteItemList [noteId=\"?\"]', note.NoteId));\n\n            // \u5f53\u524d\u7b14\u8bb0\u8981\u5220\u9664\u4e86, \u5982\u679c\u6709\u591a\u4e2a\u7b14\u8bb0\u8981\u5220\u9664, \u8fd9\u5c31\u6709\u95ee\u9898\u4e86\n            // \u521a\u4e00\u5207\u6362\u5230\u4e0b\u4e00\u4e2a, \u5c31\u88ab\u5220\u9664\u4e86, \u5bfc\u81f4\u6ca1\u6709\u88ab\u9009\u4e2d\n            if (target.length) {\n                if (Note.curNoteId == note.NoteId) {\n                    currentIsDeleted = true;\n                    Note.changeToNext(target);\n                }\n                target.remove();\n            }\n        }\n    }\n\n    // \u6700\u540e\u518d\u5220\u9664\n    if (currentIsDeleted) {\n        // Note.changeToNext(target);\n        setTimeout(function() {\n            Note.checkHasSelectedNote();\n        }, 100);\n    }\n};\n\nNote.checkHasSelectedNote = function() {\n    if (!$('#noteItemList .item-active').length) {\n        if ($('#noteItemList .item').length > 0) {\n            Note.changeNote($('#noteItemList .item').eq(0).attr(\"noteId\"));\n        } else {\n            Note.showEditorMask();\n        }\n    }\n};\n\n// pull\n// \u6dfb\u52a0\u540c\u6b65\u7684notes\n// <-- server\nNote.addSync = function(notes) {\n    if (isEmpty(notes)) {\n        return;\n    }\n    for (var i in notes) {\n        var note = notes[i];\n        // \u907f\u514dtrash\u7684\u4e5f\u52a0\u8fdb\u6765\n        if (!note.IsDeleted) {\n            if (\n                (note.IsTrash && Notebook.curNotebookIsTrash()) || !note.IsTrash) {\n\n                Note.addNoteCache(note);\n\n                // \u5f88\u53ef\u80fd\u5176\u7b14\u8bb0\u672c\u4e5f\u662f\u65b0\u6dfb\u52a0\u7684, \u6b64\u65f6\u91cd\u65b0render notebooks' numberNotes\n                Notebook.reRenderNotebookNumberNotesIfIsNewNotebook(note.NotebookId);\n\n                // alert(note.ServerNoteId);\n                // \u6dfb\u52a0\u5230\u5f53\u524d\u7684\u7b14\u8bb0\u5217\u8868\u4e2d\n                var newHtmlObject = Note._getNoteHtmlObjct(note);\n                if (newHtmlObject) {\n                    $('#noteItemList').prepend(newHtmlObject);\n                    Note.setNoteBlogVisible(note.NoteId, note.IsBlog);\n                }\n            }\n        }\n    }\n};\n\n// \u5220\u9664\nNote.deleteSync = function(notes) {\n    if (isEmpty(notes)) {\n        return;\n    }\n    for (var i in notes) {\n        var noteId = notes[i];\n        note = Note.getNote(noteId);\n        if (note) {\n            Note.clearCacheByNotebookId(note.NotebookId);\n            delete Note.cache[noteId];\n            // \u5982\u679c\u5728\u7b14\u8bb0\u5217\u8868\u4e2d\u5219\u5220\u9664\n            $(tt('#noteItemList [noteId=\"?\"]', note.NoteId)).remove();\n        }\n\n        // \u524d\u7aef\u7f13\u5b58\u4e5f\u8981\u5220\u9664!!\n        Note.deleteCache(noteId);\n    }\n};\n\n// push\n\n// \u53d1\u9001\u6210\u529f\u6dfb\u52a0\u4e86\u7684\nNote.updateChangeAdds = function(notes) {\n    if (isEmpty(notes)) {\n        return;\n    }\n    for (var i = 0; i < notes.length; ++i) {\n        var note = notes[i];\n        this.setNoteDirty(note.NoteId, false);\n    }\n};\n\n// \u53d1\u9001\u6539\u53d8\u6210\u529f\u4e86\u7684\nNote.updateChangeUpdates = function(notes) {\n    this.updateChangeAdds(notes);\n};\n\n// \u8fd4\u56de {err:'', msg: ''}\nNote._getError = function(err, ret) {\n    var Err = {};\n    try {\n        if (err && typeof err == 'object') {\n            Err.err = err.toString();\n        }\n    } catch (e) {}\n    if (typeof ret == 'object' && 'Msg' in ret) {\n        Err.msg = ret.Msg;\n    } else {\n        Err.msg = ret + '';\n    }\n    return Err;\n};\nNote.updateErrors = function(errs) {\n    if (isEmpty(errs)) {\n        return;\n    }\n    for (var i = 0; i < errs.length; ++i) {\n        var err = errs[i]; // {err: err, ret: ret, note: note}\n        var note = err.note;\n        if (!note || !note.NoteId) {\n            continue;\n        }\n        var Err = this._getError(err.err, err.ret);\n        this.setNoteCache({ NoteId: note.NoteId, Err: Err }, false);\n\n        var $leftNoteNav = $(tt('#noteItemList [noteId=\"?\"]', note.NoteId));\n        $leftNoteNav.addClass('item-err');\n    }\n}\n"], "filenames": ["public/js/app/note.js"], "buggy_code_start_loc": [958], "buggy_code_end_loc": [2001], "fixing_code_start_loc": [959], "fixing_code_end_loc": [2003], "type": "CWE-79", "message": "Leanote-desktop version v2.5 is vulnerable to a XSS which leads to code execution due to enabled node integration", "other": {"cve": {"id": "CVE-2017-1000492", "sourceIdentifier": "cve@mitre.org", "published": "2018-01-03T01:29:00.313", "lastModified": "2018-01-17T17:58:13.707", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Leanote-desktop version v2.5 is vulnerable to a XSS which leads to code execution due to enabled node integration"}, {"lang": "es", "value": "Leanote-desktop v2.5 es vulnerable to XSS, que conduce a la ejecuci\u00f3n de c\u00f3digo debido a la integraci\u00f3n de nodos habilitada."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:leanote:desktop:2.5:*:*:*:*:*:*:*", "matchCriteriaId": "F995F91D-AF29-465F-B0B3-F230F0CCFD8A"}]}]}], "references": [{"url": "https://github.com/leanote/desktop-app/commit/a2ed226637f8e66c9b089784b5e58eccf2e2fb30", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://github.com/leanote/leanote/issues/695", "source": "cve@mitre.org", "tags": ["Issue Tracking", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/leanote/desktop-app/commit/a2ed226637f8e66c9b089784b5e58eccf2e2fb30"}}