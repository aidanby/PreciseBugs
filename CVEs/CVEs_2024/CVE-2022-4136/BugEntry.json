{"buggy_code": ["<?php\n/**\n * \u6838\u5fc3\u6587\u4ef6\n * @link http://www.Leadshop.com/\n * @copyright Copyright (c) 2020 Leadshop Software LLC\n * @license http://www.Leadshop.com/license/\n */\nini_set(\"display_errors\", \"Off\");\nerror_reporting(E_ALL);\n//\u5f00\u542fSession\nsession_start();\n//\u5f53\u524d\u6587\u4ef6\u540d\u79f0\ndefine('LE_SCRIPT_NAME', basename(__FILE__));\n//\u7ad9\u70b9\u6839\u76ee\u5f55\u8def\u5f84\ndefine('LE_PACKAGE_BASE', dirname(__DIR__));\n//\u8bbe\u7f6e\u5f53\u524d\u8fd0\u884c\u6a21\u5f0f\ndefine('LE_OPERATION_MODE', 'production');\n//\u81ea\u52a8\u5316\u64cd\u4f5c\u7c7b\nclass automation\n{\n    /**\n     * \u6267\u884c\u66f4\u65b0\u811a\u672c\n     * include\n     * data\n     * meta\n     */\n    public function run()\n    {\n        //\u8bfb\u53d6\u53c2\u6570\u6570\u636e\n        $include = isset($_GET['include']) ? $_GET['include'] : \"\";\n        $data    = isset($_GET['data']) ? $_GET['data'] : \"\";\n        $meta    = isset($_GET['meta']) ? $_GET['meta'] : \"\";\n        //\u6267\u884c\u6570\u636e\u65b9\u6cd5\n        if ($include) {\n            return call_user_func_array([$this, $include], [$meta, $data]);\n        } else {\n            //\u7528\u4e8e\u5224\u65ad\u662f\u5426\u975e\u6cd5\u64cd\u4f5c\n            $token = isset($_GET['token']) ? $_GET['token'] : \"\";\n            $html  = get_oss_url('index.html');\n            //\u5224\u65ad\u9501\u6587\u4ef6\u662f\u5426\u5b58\u5728\uff0c\u5b58\u5728\u5219\u662f\u8981\u6267\u884c\u66f4\u65b0\n            if (@file_exists(dirname(__DIR__) . \"/install.lock\")) {\n                if (@file_get_contents(dirname(__DIR__) . \"/install.lock\") === $token) {\n                    if (!isset($_SESSION['self_update'])) {\n                        //\u6267\u884c\u66f4\u65b0\u81ea\u8eab\n                        $this->SilentSelfUpdate();\n                    }\n                    //\u6267\u884c\u66f4\u65b0\u64cd\u4f5c\n                    $version = get_version();\n                    $body    = $this->DownloadFile($html);\n                    echo str_replace('{$version}', $version, $body);\n                } else {\n                    die(\"\u68c0\u6d4b\u5230\u975e\u6cd5Token\uff0c\u8bf7\u767b\u5f55\u540e\u53f0\u8fdb\u5165\u66f4\u65b0\u754c\u9762\");\n                }\n            } else {\n                $version = get_version();\n                $body    = $this->DownloadFile($html);\n                echo str_replace('{$version}', $version, $body);\n            }\n        }\n\n    }\n\n    /**\n     * \u52a8\u6001\u8c03\u7528\n     *\n     * @param $method\n     * @param $params\n     * @return mixed\n     */\n    public function __call($method, $params)\n    {\n        return call_user_func_array([self::connect(), $method], $params);\n    }\n\n    /**\n     * \u8c03\u7528\u9a71\u52a8\u7c7b\u7684\u65b9\u6cd5\n     * @access public\n     * @param  string $method \u65b9\u6cd5\u540d\n     * @param  array  $params \u53c2\u6570\n     * @return mixed\n     */\n    public static function __callStatic($method, $params)\n    {\n        return call_user_func_array([self::connect(), $method], $params);\n    }\n\n    /**\n     * \u8bbe\u7f6e\u94fe\u63a5\n     * @return [type] [description]\n     */\n    public static function connect()\n    {\n        return new leadshops();\n    }\n\n}\n\nclass leadshops\n{\n    /**\n     * \u6267\u884c\u66f4\u65b0\u811a\u672c\n     */\n    public function Update($params, $data)\n    {\n        $token = isset($_GET['token']) ? $_GET['token'] : \"\";\n        if (@file_exists(dirname(__DIR__) . \"/install.lock\")) {\n            if (@file_get_contents(dirname(__DIR__) . \"/install.lock\") == $token) {\n                if ($params == 1) {\n                    //\u83b7\u53d6\u7248\u672c\u53f7\n                    $version = get_version();\n                    //\u4fdd\u5b58\u672c\u5730\u7248\u672c\n                    $_SESSION['local_version'] = $version;\n                    if (!isset($_SESSION['version'])) {\n                        list($need_upgrade, $self_replaced, $remote_version) = $this->DoSelfUpdate();\n                        if (isset($_GET['remote_version']) && $_GET['remote_version']) {\n                            //\u4fdd\u5b58\u7248\u672c\u53f7\n                            $_SESSION['version'] = $_GET['remote_version'];\n                        } else {\n                            $_SESSION['version'] = $remote_version;\n                        }\n                    }\n                    //\u5224\u65ad\u7248\u672c\u53f7\u662f\u5426\u76f8\u540c\n                    if ($_SESSION['version'] == $version) {\n                        //\u53cd\u9988\u6267\u884c\u7ed3\u679c\n                        $data = [\n                            \"code\"    => 0,\n                            \"step\"    => 2,\n                            \"message\" => \"\u60a8\u5f53\u524d\u7248\u672c{$version}\u5df2\u662f\u6700\u65b0\u7248\u672c\u3002\",\n                        ];\n                        echo json_encode($data, JSON_UNESCAPED_UNICODE);\n                        exit();\n                    }\n                    //\u8bfb\u53d6\u66f4\u65b0\u8bb0\u5f55\n                    if (!isset($_SESSION['updateStep'])) {\n                        $_SESSION['updateStep'] = 0;\n                    }\n                    //\u8bfb\u53d6\u66f4\u65b0\u8bb0\u5f55\n                    if (!isset($_SESSION['upgrade'])) {\n                        //\u8bfb\u53d6\u7248\u672c\u53f7\n                        $version = $_SESSION['version'];\n                        //\u83b7\u53d6\u66f4\u65b0\u8bb0\u5f55\n                        $_SESSION['upgrade'] = $this->DownloadJson(\"https://qmxq.oss-cn-hangzhou.aliyuncs.com/V{$version}/upgrade.txt\");\n                    }\n                    //\u5904\u7406\u66f4\u65b0\u6587\u4ef6\u83b7\u53d6\n                    if (!isset($_SESSION['updateFile'])) {\n                        $dir1 = dirname(__DIR__);\n                        //\u6267\u884c\u66f4\u6587\u4ef6\n                        $data = $_SESSION['upgrade'];\n                        //\u5bf9\u4e0d\u83b7\u53d6\u66f4\u65b0\u6587\u4ef6\n                        $update_data             = get_folder_md5($dir1, $dir1, $data);\n                        $_SESSION['updateFile']  = $update_data;\n                        $_SESSION['updatePlan']  = count($update_data);\n                        $_SESSION['updateTotal'] = count($update_data);\n                    }\n                    // P(['updateFile', $_SESSION['updateFile']]);\n                    // P(['updateTotal', $_SESSION['updateTotal']]);\n                    // P(['updatePlan', $_SESSION['updatePlan']]);\n                    // P(['updateStep', $_SESSION['updateStep']]);\n                    //\u83b7\u53d6\u66f4\u65b0\u9a8c\u8bc1\u6587\u4ef6\n                    if ($_SESSION['updateFile'] && $_SESSION['updateTotal'] && $_SESSION['updatePlan'] > 0 && $_SESSION['updateStep'] === 0) {\n                        $data = [\n                            \"code\"    => 0,\n                            \"step\"    => 1,\n                            \"message\" => \"\u7b49\u5f85\u66f4\u65b0\u6267\u884c\",\n                            \"data\"    => [\n                                'total' => $_SESSION['updateTotal'],\n                                'plan'  => $_SESSION['updatePlan'],\n                                'step'  => $_SESSION['updateStep'],\n                            ],\n                        ];\n                        $_SESSION['updateStep']++;\n                        echo json_encode($data, JSON_UNESCAPED_UNICODE);\n                        exit();\n                    }\n                    //\u9010\u6b65\u6267\u884c\n                    //[key] => ae7ba26e3f9e2c19f1ae227d5dc8e898\n                    //[path] => /api/DemoController.php\n                    if ($_SESSION['updateFile'] && $_SESSION['updateTotal'] && $_SESSION['updatePlan'] >= 0 && $_SESSION['updateStep'] > 0) {\n                        //\u6b64\u5904\u5f00\u59cb\u6267\u884c\u6587\u4ef6\n                        $first = array_shift($_SESSION['updateFile']);\n                        $dir1  = dirname(__DIR__);\n                        //\u62fc\u63a5URL\u5730\u5740\u4fe1\u606f\n                        $url    = \"https://qmxq.oss-cn-hangzhou.aliyuncs.com/V{$_SESSION['version']}\" . $first['path'];\n                        $data   = $this->DownloadFile($url);\n                        $status = -1;\n                        $snull  = base64url_decode(\"Tm9TdWNoS2V5\");\n                        //\u5224\u65adOSS\u4e2d\u6587\u4ef6\u662f\u5426\u5b58\u5728\n                        $path = $dir1 . $first['path'];\n                        //\u6267\u884c\u6570\u636e\u5199\u5165 f09cb7eae8785c1a40287eaea6303c02\n                        // if (strpos($data, $snull) === false) {\n                        //     $path   = $dir1 . $first['path'];\n                        //     $status = $this->ToMkdir($path, $data, true, true);\n                        // }\n                        $path   = $dir1 . $first['path'];\n                        $status = $this->ToMkdir($path, $data, true, true);\n                        //\u53cd\u9988\u6267\u884c\u7ed3\u679c\n                        $data = [\n                            \"code\"    => 0,\n                            \"step\"    => 1,\n                            \"status\"  => $status,\n                            \"message\" => \"\u7b49\u5f85\u66f4\u65b0\u6267\u884c\",\n                            \"data\"    => [\n                                'file'  => $first['path'],\n                                'path'  => $path,\n                                'url'   => $url,\n                                'oss'   => strpos($data, $snull),\n                                'total' => $_SESSION['updateTotal'],\n                                'plan'  => $_SESSION['updatePlan'],\n                                'step'  => $_SESSION['updateStep'],\n                            ],\n                        ];\n                        $_SESSION['updatePlan']--;\n                        $_SESSION['updateStep']++;\n                        echo json_encode($data, JSON_UNESCAPED_UNICODE);\n                        exit();\n                    }\n                    //\u6267\u884cSQL\u8bed\u53e5\n                    if (!$_SESSION['updateFile'] && $_SESSION['updateTotal'] && $_SESSION['updatePlan'] === 0 && $_SESSION['updateStep'] > 0) {\n                        //\u53cd\u9988\u6267\u884c\u7ed3\u679c\n                        $data = [\n                            \"code\"    => 0,\n                            \"step\"    => 1,\n                            \"message\" => \"\u6b63\u5728\u6267\u884cSQL\",\n                            \"data\"    => [\n                                'file'  => '',\n                                'total' => $_SESSION['updateTotal'],\n                                'plan'  => $_SESSION['updatePlan'],\n                                'step'  => $_SESSION['updateStep'],\n                            ],\n                        ];\n                        //\u83b7\u53d6\u5f53\u524d\u7248\u672c\u53f7\n                        $version = $_SESSION['local_version'];\n                        //\u5904\u7406\u6570\u636e\u5e93\u6587\u4ef6\u66f4\u65b0\n                        $this->UpdateSql($version);\n                        $_SESSION['updatePlan'] = -1;\n                        echo json_encode($data, JSON_UNESCAPED_UNICODE);\n                        exit();\n                    }\n                    //\u66f4\u65b0\u5b8c\u6210\n                    if (!$_SESSION['updateFile'] && $_SESSION['updateTotal'] && $_SESSION['updatePlan'] === -1 && $_SESSION['updateStep'] > 0) {\n                        //\u53cd\u9988\u6267\u884c\u7ed3\u679c\n                        $data = [\n                            \"code\"    => 0,\n                            \"step\"    => 0,\n                            \"message\" => \"\u66f4\u65b0\u5b8c\u6210\",\n                            \"data\"    => [\n                                'file'  => '',\n                                'total' => $_SESSION['updateTotal'],\n                                'plan'  => $_SESSION['updatePlan'],\n                                'step'  => $_SESSION['updateStep'],\n                            ],\n                        ];\n                        //\u5904\u7406\u65b0\u7684\u7248\u672c\u53f7\n                        $versionData = [\n                            \"version\" => $_SESSION['version'],\n                        ];\n                        //\u5904\u7406\u7248\u672c\u53f7\u66f4\u65b0\u95ee\u9898\n                        $this->ToMkdir(__DIR__ . \"/version.json\", json_encode($versionData, JSON_UNESCAPED_UNICODE), true, true);\n                        $_SESSION = [];\n                        echo json_encode($data, JSON_UNESCAPED_UNICODE);\n                        exit();\n                    }\n                    //\u5904\u7406\u9a8c\u8bc1\n                    if ($_SESSION['updateTotal'] === 0 && $_SESSION['updatePlan'] === 0 && $_SESSION['updateStep'] === 0) {\n                        //\u53cd\u9988\u6267\u884c\u7ed3\u679c\n                        $data = [\n                            \"code\"    => 0,\n                            \"step\"    => 0,\n                            \"message\" => \"\u5f53\u524d\u7248\u672c\u5df2\u662f\u6700\u65b0\",\n                            \"data\"    => [\n                                'file'  => '',\n                                'total' => $_SESSION['updateTotal'],\n                                'plan'  => $_SESSION['updatePlan'],\n                                'step'  => $_SESSION['updateStep'],\n                            ],\n                        ];\n                        //\u5904\u7406\u65b0\u7684\u7248\u672c\u53f7\n                        $versionData = [\n                            \"version\" => $_SESSION['version'],\n                        ];\n                        //\u5904\u7406\u7248\u672c\u53f7\u66f4\u65b0\u95ee\u9898\n                        $this->ToMkdir(__DIR__ . \"/version.json\", json_encode($versionData, JSON_UNESCAPED_UNICODE), true, true);\n                        $_SESSION = [];\n                        echo json_encode($data, JSON_UNESCAPED_UNICODE);\n                        exit();\n                    }\n                }\n                if ($params == 2) {\n                    $_SESSION = [];\n                }\n            } else {\n                $data = [\n                    \"code\"    => -1,\n                    \"message\" => \"\u68c0\u6d4b\u5230\u975e\u6cd5Token\uff0c\u8bf7\u767b\u5f55\u540e\u53f0\u8fdb\u5165\u66f4\u65b0\u754c\u9762\",\n                ];\n                echo json_encode($data, JSON_UNESCAPED_UNICODE);\n            }\n        }\n    }\n\n    /**\n     * \u6267\u884c\u5b89\u88c5\u811a\u672c\n     */\n    public function Install($params, $data)\n    {\n        if ($params == 1) {\n            $data = [\n                \"code\" => 0,\n                \"data\" => [\n                    $this->FunctionCheck(),\n                    $this->ExtensionCheck(),\n                    $this->PreCheck(),\n                    $this->DirCheck(),\n                ],\n            ];\n            echo json_encode($data, JSON_UNESCAPED_UNICODE);\n        }\n        if ($params == 2) {\n            echo json_encode($this->CheckDatabase(), JSON_UNESCAPED_UNICODE);\n        }\n    }\n\n    /**\n     * \u4ee5get\u65b9\u5f0f\u63d0\u4ea4\u8bf7\u6c42\n     * @param $url\n     * @return bool|mixed\n     */\n    public function HttpGet($url)\n    {\n        $curl = curl_init();\n        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);\n        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);\n        curl_setopt($curl, CURLOPT_SSLVERSION, 1);\n        curl_setopt($curl, CURLOPT_URL, $url);\n        curl_setopt($curl, CURLOPT_TIMEOUT, 30);\n        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);\n        list($content, $status) = array(curl_exec($curl), curl_getinfo($curl), curl_close($curl));\n        return (intval($status[\"http_code\"]) === 200) ? $content : false;\n    }\n\n    /**\n     * \u521b\u5efa\u76ee\u5f55\n     * @param    string    $path     \u76ee\u5f55\u540d\u79f0\uff0c\u5982\u679c\u662f\u6587\u4ef6\u5e76\u4e14\u4e0d\u5b58\u5728\u7684\u60c5\u51b5\u4e0b\u4f1a\u81ea\u52a8\u521b\u5efa\n     * @param    string    $data     \u5199\u5165\u6570\u636e\n     * @param    bool    $is_full  \u5b8c\u6574\u8def\u5f84\uff0c\u9ed8\u8ba4False\n     * @param    bool    $is_cover \u5f3a\u5236\u8986\u76d6\uff0c\u9ed8\u8ba4False\n     * @return   bool    True|False\n     */\n    public function ToMkdir($path = null, $data = null, $is_full = false, $is_cover = false)\n    {\n        #\u975e\u5b8c\u6574\u8def\u5f84\u8fdb\u884c\u7ec4\u5408\n        if (!$is_full) {\n            $path = dirname(__DIR__) . '/' . ltrim(ltrim($path, './'), '/');\n        }\n        $file = $path;\n        #\u68c0\u6d4b\u662f\u5426\u4e3a\u6587\u4ef6\n        $file_suffix = pathinfo($path, PATHINFO_EXTENSION);\n        if ($file_suffix) {\n            $path = pathinfo($path, PATHINFO_DIRNAME);\n        } else {\n            $path = rtrim($path, '/');\n        }\n\n        #\u6267\u884c\u76ee\u5f55\u521b\u5efa\n        if (!is_dir($path)) {\n            if (!mkdir($path, 0777, true)) {\n                return false;\n            }\n            chmod($path, 0777);\n        }\n        #\u6587\u4ef6\u5219\u8fdb\u884c\u6587\u4ef6\u521b\u5efa\n        if ($file_suffix) {\n            if (!is_file($file)) {\n                if (!file_put_contents($file, $data)) {\n                    return false;\n                }\n            } else {\n                #\u5f3a\u5236\u8986\u76d6\n                if ($is_cover) {\n                    if (!file_put_contents($file, $data)) {\n                        return false;\n                    }\n                } else {\n                    return false;\n                }\n            }\n        }\n        return true;\n    }\n\n    /**\n     * \u6267\u884c\u6570\u636e\u5e93\u66f4\u65b0\n     * @param string $version [description]\n     */\n    public function UpdateSql($version = '')\n    {\n        try {\n            $db   = require dirname(__DIR__) . DIRECTORY_SEPARATOR . 'config/db.php';\n            $pdo  = new PDO($db['dsn'], $db['username'], $db['password']); //\u521d\u59cb\u5316\u4e00\u4e2aPDO\u5bf9\u8c61\n            $sql  = \"SELECT * FROM {$db['tablePrefix']}store_setting WHERE keyword = :version\";\n            $stmt = $pdo->prepare($sql);\n            $stmt->execute(['version' => 'mysql_version']);\n            $row = $stmt->fetch(PDO::FETCH_ASSOC);\n\n            $db_version = '1.2.0';\n            if (isset($row['content'])) {\n                $db_version = empty($row['content']) ? '1.2.0' : $row['content'];\n            }\n            $version_list = json_decode($this->httpGet(base64url_decode('aHR0cHM6Ly9jbG91ZC5sZWFkc2hvcC52aXAvbWFsbC91cGRhdGUvbGlzdA,,')), true);\n            if ($version_list['code'] === 0) {\n                $version_list = $version_list['data'];\n                foreach ($version_list as $key => $value) {\n                    if ($value['version'] == $db_version) {\n                        //\u83b7\u53d6\u4e0b\u4e00\u4e2a\u66f4\u65b0\u7248\u672c\n                        $data = @$version_list[$key + 1];\n                        if ($data) {\n                            $sql_data = @$this->httpGet(\"https://qmxq.oss-cn-hangzhou.aliyuncs.com/V{$data['version']}/sql.txt\");\n                            if ($sql_data) {\n                                $sql_data = str_replace('heshop_initialize_prefix_', $db['tablePrefix'], $sql_data);\n                                $res      = $pdo->exec($sql_data);\n                            }\n                            //\u4ee5\u4e0b\u662f\u4fee\u6539\u7248\u672c\u4fe1\u606f\u5185\u5bb9\n                            $sql  = \"UPDATE {$db['tablePrefix']}store_setting SET content = '{$data['version']}' WHERE keyword = 'mysql_version'\";\n                            $stmt = $pdo->prepare($sql);\n                            $stmt->execute();\n                        }\n                    }\n                }\n                return true;\n            } else {\n                return -2;\n            }\n        } catch (PDOException $e) {\n            return -3;\n        }\n    }\n\n    /**\n     * \u6267\u884c\u6587\u4ef6\u4e0b\u8f7d\n     * @param  [type]  $url              [description]\n     * @param  boolean $ignore_ssl_error [description]\n     * @return [type]                    [description]\n     */\n    public function DownloadFile($url, $ignore_ssl_error = false)\n    {\n        if (!function_exists('curl_init')) {\n            throw new Exception(\"curl\u6269\u5c55\u672a\u542f\u7528\");\n        }\n        $ch = curl_init();\n        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);\n        curl_setopt($ch, CURLOPT_HEADER, 0);\n        curl_setopt($ch, CURLOPT_URL, $url);\n        curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36');\n        if ($ignore_ssl_error) {\n            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);\n            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);\n        } else {\n            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);\n            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 1);\n        }\n\n        $response = curl_exec($ch);\n\n        if ($response === false) {\n            $error_no = curl_errno($ch);\n            throw new Exception(\"\u4e0b\u8f7d $url \u9519\u8bef\uff0ccode($error_no)\uff0c\u9519\u8bef\u4fe1\u606f\uff1a\" . curl_error($ch));\n        }\n        curl_close($ch);\n        return $response;\n    }\n\n    /**\n     * \u6267\u884c\u4e0b\u8f7dJSON\n     * @param  [type] $url [description]\n     * @return [type]      [description]\n     */\n    public function DownloadJson($url)\n    {\n        $pkg_str = $this->DownloadFile($url);\n        if ($pkg_str === false) {\n            throw new Exception(\"\u4e0b\u8f7d\u9519\u8bef: \" . $url);\n        }\n        $json = json_decode($pkg_str, true);\n        if ($json === null) {\n            throw new Exception(\"${pkg_str} \u65e0\u6cd5\u88ab\u89e3\u6790\u6210 json\");\n        }\n        return $json;\n    }\n\n    /**\n     * \u79fb\u9664\u76ee\u5f55\n     * @param  [type] $path [description]\n     * @return [type]       [description]\n     */\n    public function RemoveDir($path)\n    {\n        if (empty($path) || !$path) {\n            return false;\n        }\n        return is_file($path) ?\n        @unlink($path) :\n        array_map(__FUNCTION__, glob($path . '/*')) == @rmdir($path);\n    }\n\n    /**\n     * \u76d1\u6d4b\u662f\u5426\u662fHTTPS\n     * @return boolean [description]\n     */\n    public function IsHttps()\n    {\n        if (isset($_SERVER[\"HTTPS\"]) && strtolower($_SERVER[\"HTTPS\"]) != \"off\") {\n            return true;\n        }\n        if (isset($_SERVER[\"HTTP_X_FORWARDED_PROTO\"]) && strtolower($_SERVER[\"HTTP_X_FORWARDED_PROTO\"]) == \"https\") {\n            return true;\n        }\n        if (isset($_SERVER[\"HTTP_SCHEME\"]) && strtolower($_SERVER[\"HTTP_SCHEME\"]) == \"https\") {\n            return true;\n        }\n        if (isset($_SERVER[\"HTTP_FROM_HTTPS\"]) && strtolower($_SERVER[\"HTTP_FROM_HTTPS\"]) != \"off\") {\n            return true;\n        }\n        if (isset($_SERVER[\"SERVER_PORT\"]) && $_SERVER[\"SERVER_PORT\"] == 443) {\n            return true;\n        }\n        return false;\n    }\n\n    /**\n     * \u83b7\u53d6GET\u53c2\u6570\n     * @param  [type] $var [description]\n     * @return [type]      [description]\n     */\n    public static function getVar($var)\n    {\n        if (!isset($_GET[$var])) {\n            if (!isset($_POST[$var])) {\n                $_POST = json_decode(file_get_contents(\"php://input\"), true);\n                if (!isset($_POST[$var])) {\n                    return false;\n                }\n            }\n            $ret = $_POST[$var];\n        } else {\n            $ret = $_GET[$var];\n        }\n        return htmlspecialchars($ret);\n    }\n\n    /**\n     * [PreCheck description]\n     */\n    public function DirCheck()\n    {\n        //\u7528\u6237\u68c0\u67e5WEB\u76ee\u5f55\n        $dir       = __DIR__;\n        $base_name = basename($dir);\n        if ($base_name !== 'web') {\n            $LANG['base_name'] = array(\n                \"status\"  => 0,\n                \"data\"    => __DIR__,\n                \"message\" => \"\u68c0\u67e5\u5f53\u524d\u76ee\u5f55 $dir \u76ee\u5f55\u540d\u79f0\u662f\u5426\u4e3a web\",\n            );\n        } else {\n            $LANG['base_name'] = array(\n                \"status\"  => 1,\n                \"data\"    => __DIR__,\n                \"message\" => \"\u68c0\u67e5\u5f53\u524d\u76ee\u5f55 $dir \u76ee\u5f55\u540d\u79f0\u662f\u5426\u4e3a web\",\n            );\n        }\n\n        //\u7528\u6237\u68c0\u67e5\u6839\u76ee\u5f55\u9009\u9879\n        $dir_name = dirname($dir);\n        if (!$dir_name || $dir_name === \"/\" || preg_match(\"/^[a-z|A-Z]:[\\/|\\\\\\]?$/m\", $dir_name)) {\n            $LANG['dir_name'] = array(\n                \"status\"  => 0,\n                \"data\"    => $dir_name,\n                \"message\" => \"\u68c0\u67e5\u4e0a\u7ea7\u76ee\u5f55 $dir_name \u4e0d\u80fd\u4e3a\u6839\u76ee\u5f55\",\n            );\n        } else {\n            $LANG['dir_name'] = array(\n                \"status\"  => 1,\n                \"data\"    => $dir_name,\n                \"message\" => \"\u68c0\u67e5\u4e0a\u7ea7\u76ee\u5f55 $dir_name \u4e0d\u80fd\u4e3a\u6839\u76ee\u5f55\",\n            );\n        }\n        return $LANG;\n    }\n\n    /**\n     * \u76ee\u5f55\u68c0\u67e5\n     * @return [type] [description]\n     */\n    public function PreCheck()\n    {\n        $LANG           = array();\n        $needed_dirlist = array(\n            '/config', '/stores', '/web', '/web/assets',\n        );\n\n        //\u5faa\u73af\u68c0\u67e5\u76ee\u5f55\u662f\u5426\u53ef\u5199\n        foreach ($needed_dirlist as $dir) {\n            $key        = md5($dir);\n            $LANG[$key] = array(\n                \"status\"  => 1,\n                \"message\" => \"\u68c0\u6d4b\" . $dir . \"\u76ee\u5f55\u53ef\u5199\",\n            );\n            if (@!$this->WritableCheck(dirname(__DIR__) . $dir)) {\n                $LANG[$key] = array(\n                    \"status\"  => 0,\n                    \"message\" => \"\u68c0\u67e5\u5f53\u524d\u76ee\u5f55\" . $dir . \"\u662f\u5426\u53ef\u5199\",\n                );\n            }\n        }\n        return $LANG;\n    }\n\n    /**\n     * \u6269\u5c55\u76d1\u6d4b\n     * @return [type] [description]\n     */\n    public function ExtensionCheck()\n    {\n        $LANG              = array();\n        $needed_extensions = array(\n            'curl', 'gd', 'json', 'openssl', 'pdo', 'pdo_mysql', 'xml', 'zip',\n        );\n        foreach ($needed_extensions as $ext) {\n            $key        = 'function_' . $ext;\n            $LANG[$key] = array(\n                \"status\"  => 1,\n                \"message\" => $ext . \"\u6269\u5c55\u68c0\u6d4b\u53ef\u7528\",\n            );\n            if (!extension_loaded($ext)) {\n                $LANG[$key] = array(\n                    \"status\"  => 0,\n                    \"message\" => \"PHP\u6269\u5c55\u8981\u6c42\u652f\u6301 \" . $ext,\n                );\n            }\n        }\n        return $LANG;\n    }\n\n    /**\n     * \u51fd\u6570\u76d1\u6d4b\n     * @return [type] [description]\n     */\n    public function FunctionCheck()\n    {\n        $LANG             = array();\n        $needed_functions = array(\n            'symlink', 'realpath',\n        );\n        foreach ($needed_functions as $func) {\n            $key        = 'function_' . $func;\n            $LANG[$key] = array(\n                \"status\"  => 1,\n                \"message\" => $func . \"\u51fd\u6570\u68c0\u6d4b\u53ef\u7528\",\n            );\n            if (!function_exists($func)) {\n                $LANG[$key] = array(\n                    \"status\"  => 0,\n                    \"message\" => \"PHP\u51fd\u6570\u8981\u6c42\u542f\u7528 \" . $func,\n                );\n            }\n        }\n        return $LANG;\n    }\n\n    /**\n     * \u6267\u884c\u6570\u636e\u5e93\u8868\u5355\n     * @return [type] [description]\n     */\n    public function CheckDatabase()\n    {\n        //\u8868\u793a\u662f\u63d0\u4ea4\u7684\u8868\u5355\n        $action = true;\n        //\u7f51\u7ad9\u6807\u9898\n        $forumTitle = self::getVar('forumTitle');\n        //MySQL \u670d\u52a1\u5668\u5730\u5740\n        $mysqlHost = self::getVar('mysqlHost') . \":\" . self::getVar('mysqlPort') ?? \"3306\";\n        //\u6570\u636e\u5e93\u540d\u79f0\n        $mysqlDatabase = self::getVar('mysqlDatabase');\n        //MySQL \u7528\u6237\u540d\n        $mysqlUsername = self::getVar('mysqlUsername');\n        //MySQL \u5bc6\u7801\n        $mysqlPassword = self::getVar('mysqlPassword');\n        //\u8868\u524d\u7f00(\u53ef\u9009)\n        $tablePrefix = trim(self::getVar('tablePrefix'));\n        //\u8bbe\u7f6e\u7ba1\u7406\u5458\u624b\u673a\u53f7\n        $adminUsername = self::getVar('adminUsername');\n        //\u8bbe\u7f6e\u7ba1\u7406\u5458\u5bc6\u7801\n        $adminPassword = self::getVar('adminPassword');\n        //\u7ba1\u7406\u5458\u5bc6\u7801\u786e\u8ba4\n        $adminPasswordConfirmation = self::getVar('adminPasswordConfirmation');\n\n        // \u5224\u65ad\u6bcf\u4e2a\u5b57\u6bb5\u662f\u5426\u5408\u6cd5\n        $forumTitleInvalid    = $action && !$forumTitle;\n        $mysqlHostInvalid     = $action && !$mysqlHost;\n        $mysqlDatabaseInvalid = $action && !$mysqlDatabase;\n        $mysqlUsernameInvalid = $action && !$mysqlUsername;\n        $mysqlPasswordInvalid = $action && !$mysqlPassword;\n        $tablePrefixInvalid   = $action && $tablePrefix && !preg_match(\"/^\\w+$/\", $tablePrefix);\n        $adminUsernameInvalid = $action && !$adminUsername;\n        $adminPasswordInvalid = $action && (!$adminPassword || !$adminPasswordConfirmation || ($adminPasswordConfirmation != $adminPassword));\n\n        // \u9700\u8981\u68c0\u67e5\u6570\u636e\u5e93\u8fde\u63a5\n        $mysqlConnectCheck = $action && !$mysqlHostInvalid && !$mysqlUsernameInvalid && !$mysqlPasswordInvalid;\n\n        $mysqlVersionInvalid       = true;\n        $mysqlConnectInvalid       = true;\n        $mysqlUserPassInvalid      = true;\n        $mysqlDatabaseDbInvalid    = true;\n        $mysqlDatabaseDbInvalidMsg = \"\";\n        $mysqlVersionInvalidMsg    = \"\";\n\n        if ($mysqlConnectCheck) {\n            $r                    = check_mysql_connection($mysqlHost, $mysqlUsername, $mysqlPassword);\n            $mysqlConnectInvalid  = ($r === -1) || $r === false;\n            $mysqlUserPassInvalid = ($r === -2);\n            $mysqlHostInvalid     = $mysqlHostInvalid || $mysqlConnectInvalid;\n\n            if ($mysqlUserPassInvalid) {\n                $mysqlUsernameInvalid = true;\n                $mysqlPasswordInvalid = true;\n            }\n\n            if (!$mysqlConnectInvalid && !$mysqlUserPassInvalid) {\n                // \u5982\u679c\u6570\u636e\u5e93\u53ef\u8fde\u63a5\n                $r = check_mysql_version($mysqlHost, $mysqlUsername, $mysqlPassword);\n                if ($r !== true) {\n                    // \u5982\u679c\u6570\u636e\u5e93\u7248\u672c\u9519\u8bef\uff0c\u4e5f\u6807\u8bb0mysqlHost\u5b57\u6bb5\u4e0d\u5408\u6cd5\n                    $mysqlHostInvalid       = true;\n                    $mysqlVersionInvalid    = true;\n                    $mysqlVersionInvalidMsg = $r;\n                } else {\n                    $mysqlVersionInvalid = false;\n                }\n                if (!$mysqlDatabaseInvalid) {\n                    // \u5982\u679c\u8f93\u5165\u4e86\u6570\u636e\u5e93\u540d\u79f0\n                    $r = check_mysql_database($mysqlHost, $mysqlUsername, $mysqlPassword, $mysqlDatabase);\n                    if ($r !== true) {\n                        $mysqlDatabaseInvalid      = true;\n                        $mysqlDatabaseDbInvalidMsg = $r;\n                        $mysqlDatabaseDbInvalid    = true;\n                    }\n                }\n            }\n        }\n\n        $LANG = array();\n\n        if ($action && !$forumTitle) {\n            $LANG['forumTitle'] = \"\u7ad9\u70b9\u540d\u79f0\u4e0d\u80fd\u4e3a\u7a7a\";\n        }\n\n        if ($action && !$mysqlHost) {\n            $LANG['mysqlHost'] = \"MySQL \u670d\u52a1\u5668\u4e0d\u80fd\u4e3a\u7a7a\";\n        }\n\n        if ($mysqlConnectCheck && $mysqlConnectInvalid) {\n            $LANG['mysqlConnectInvalid'] = \"MySQL \u670d\u52a1\u5668\u65e0\u6cd5\u8fde\u63a5\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u5668\u7684IP\u4e0e\u7aef\u53e3(\u53ef\u7528:\u6307\u5b9a\u7aef\u53e3\u53f7)\";\n        }\n\n        if ($mysqlConnectCheck && $mysqlVersionInvalid && $mysqlVersionInvalidMsg) {\n            $LANG['mysqlVersionInvalid'] = $mysqlVersionInvalidMsg;\n        }\n\n        if ($mysqlConnectCheck && $mysqlDatabaseInvalid && $mysqlDatabaseDbInvalidMsg) {\n            $LANG['mysqlDatabaseInvalid'] = $mysqlDatabaseDbInvalidMsg;\n        }\n\n        if ($action && !$mysqlUsername) {\n            $LANG['mysqlUsername'] = \"MySQL \u7528\u6237\u540d\u4e0d\u80fd\u4e3a\u7a7a\";\n        }\n\n        if ($action && $mysqlUserPassInvalid) {\n            $LANG['mysqlUserPassInvalid'] = \"\u4f7f\u7528\u60a8\u8f93\u5165\u7684 MySQL \u7528\u6237\u540d\u5bc6\u7801\u7ec4\u5408\u65e0\u6cd5\u8fde\u63a5\u5230\u6570\u636e\u5e93\";\n        }\n\n        if ($action && !$mysqlPassword) {\n            $LANG['mysqlPassword'] = \"MySQL \u5bc6\u7801\u4e0d\u80fd\u4e3a\u7a7a\";\n        }\n\n        if ($action && $mysqlUserPassInvalid) {\n            $LANG['mysqlUserPassInvalid'] = \"\u4f7f\u7528\u60a8\u8f93\u5165\u7684 MySQL \u7528\u6237\u540d\u5bc6\u7801\u7ec4\u5408\u65e0\u6cd5\u8fde\u63a5\u5230\u6570\u636e\u5e93\";\n        }\n\n        if ($action && !$adminUsername) {\n            $LANG['adminUsername'] = \"\u7ba1\u7406\u5458\u7528\u6237\u540d\u4e0d\u80fd\u4e3a\u7a7a\";\n        }\n\n        if ($action && !$adminPassword) {\n            $LANG['adminPassword'] = \"\u7ba1\u7406\u5458\u5bc6\u7801\u4e0d\u80fd\u4e3a\u7a7a\";\n        } else if ($action && ($adminPassword != $adminPasswordConfirmation)) {\n            $LANG['adminPasswordConfirmation'] = \"\u7ba1\u7406\u5458\u5bc6\u7801\u4e24\u6b21\u8f93\u5165\u4e0d\u4e00\u81f4\";\n        }\n\n        if ($action && !$adminPasswordConfirmation) {\n            $LANG['adminPasswordConfirmation'] = \"\u7ba1\u7406\u5458\u5bc6\u7801\u786e\u8ba4\u4e0d\u80fd\u4e3a\u7a7a\";\n        } else if ($action && ($adminPassword != $adminPasswordConfirmation)) {\n            $LANG['adminPasswordConfirmation'] = \"\u7ba1\u7406\u5458\u5bc6\u7801\u4e24\u6b21\u8f93\u5165\u4e0d\u4e00\u81f4\";\n        }\n\n        if (strpos($mysqlDatabase, '-') !== false) {\n            $LANG['mysqlDatabase'] = \"\u6570\u636e\u5e93\u540d\u79f0\u4e2d\u4e0d\u80fd\u5305\u542b-\";\n        }\n\n        $ready_to_install = $action && !$forumTitleInvalid && !$mysqlHostInvalid && !$mysqlDatabaseInvalid && !$mysqlUsernameInvalid\n        && !$mysqlPasswordInvalid && !$tablePrefixInvalid && !$adminUsernameInvalid && !$adminPasswordInvalid && !$mysqlUserPassInvalid;\n\n        //\u6267\u884c\u6570\u636e\u5e93\u5199\u5165\u64cd\u4f5c\n        if ($ready_to_install) {\n            $md5Password = md5($adminPassword);\n            $table       = $tablePrefix . \"account\";\n            $inuser      = \"insert into {$table}(mobile,password,nickname) values('{$adminUsername}','{$md5Password}','\u7ba1\u7406\u5458')\";\n            $data        = install_database($mysqlHost, $mysqlUsername, $mysqlPassword, $tablePrefix, $mysqlDatabase, $inuser);\n            if ($data['code'] === 0) {\n                //\u521b\u5efa\u914d\u7f6e\u6587\u4ef6\n                $returned = install_config($mysqlHost, $mysqlUsername, $mysqlPassword, $tablePrefix, $mysqlDatabase);\n                if ($returned && $this->MakeLockFile()) {\n                    return [\n                        'code' => 0,\n                        'msg'  => \"\u5b89\u88c5\u6210\u529f\",\n                    ];\n                } else {\n                    return [\n                        'code' => -1,\n                        'msg'  => \"\u8bf7\u68c0\u67e5\u76ee\u5f55\u662f\u5426\u53ef\u5199\",\n                    ];\n                }\n            } else {\n                return $data;\n            }\n        } else {\n            return [\n                'code' => -1,\n                'msg'  => $LANG,\n            ];\n        }\n    }\n\n    /**\n     * \u521b\u5efa\u9501\u5b9a\u6587\u4ef6\n     */\n    public function MakeLockFile()\n    {\n        $key = MD5(time());\n        @file_put_contents(dirname(__DIR__) . \"/install.lock\", \"locked\" . $key);\n        return true;\n    }\n\n    /**\n     * \u5199\u5165\u76d1\u6d4b\n     * @param  [type] $dir [description]\n     * @return [type]      [description]\n     */\n    public function WritableCheck($dir)\n    {\n        try {\n            $tmpfile = $dir . \"/\" . uniqid('test', true);\n            if (!is_writable($dir)) {\n                return false;\n            }\n            if (file_put_contents($tmpfile, \"hello\") === false) {\n                return false;\n            }\n            if (!file_exists($tmpfile)) {\n                return false;\n            }\n            return unlink($tmpfile);\n        } catch (Exception $e) {\n            return false;\n        }\n    }\n\n    /**\n     * \u81ea\u5df1\u5347\u7ea7\u81ea\u5df1\n     */\n    public function SilentSelfUpdate()\n    {\n        $dir = __DIR__;\n        if ($this->WritableCheck($dir)) {\n            if (is_writable(__FILE__)) {\n                try {\n                    list($need_upgrade, $self_replaced, $remote_version) = $this->DoSelfUpdate();\n                    if ($need_upgrade && $self_replaced) {\n                        echo \"<script language=JavaScript>document.location.reload();</script>\";\n                    }\n                } catch (Exception $e) {\n                    exit(\"\u8bf7\u68c0\u67e5WEB\u662f\u5426\u53ef\u5199\");\n                }\n            }\n        }\n    }\n\n    /**\n     * \u5347\u7ea7\u81ea\u8eab\u6587\u4ef6\n     */\n    public function DoSelfUpdate()\n    {\n        $SELF_VERSION   = get_version();\n        $self_replaced  = false;\n        $need_upgrade   = false;\n        $remote_version = trim($this->DownloadFile(get_oss_url('latest_le_ver.txt')));\n        if ($remote_version !== $SELF_VERSION) {\n            $need_upgrade = true;\n            $new_file     = $this->DownloadFile(get_oss_url('leadshop.php'));\n            $new_file_md5 = trim($this->DownloadFile(get_oss_url('latest_le_md5.txt')));\n            if (md5($new_file) === $new_file_md5) {\n                if (file_put_contents(__FILE__, $new_file)) {\n                    $self_replaced           = true;\n                    $_SESSION['self_update'] = true;\n                }\n            }\n        }\n        return array($need_upgrade, $self_replaced, $remote_version);\n    }\n}\n/**\n * \u83b7\u53d6URL\u5730\u5740\n * @param  [type] $name [description]\n * @return [type]       [description]\n */\nfunction get_oss_url($name)\n{\n    $url = \"https://qmxq.oss-cn-hangzhou.aliyuncs.com\";\n    return $url . \"/leadshop/\" . LE_OPERATION_MODE . \"/\" . $name;\n}\n/**\n * \u6253\u5370\u8f93\u51fa\u6570\u636e\n * @Author   Sean       Yan\n * @DateTime 2018-09-07\n * @param    [type]     $name [description]\n * @param    integer    $type [description]\n */\nfunction P($name, $type = 1)\n{\n\n    switch ($type) {\n        case 1:\n            echo \"<pre style='position:relative;z-index:1000;padding:10px;border-radius:5px;background:#F5F5F5;border:1px solid #aaa;font-size:14px;line-height:18px;opacity:0.9;'>\" . print_r($name, true) . \"</pre>\";\n            break;\n        case 2:\n            $name = unhtml($name);\n            echo \"<pre style='position:relative;z-index:1000;padding:10px;border-radius:5px;background:#F5F5F5;border:1px solid #aaa;font-size:14px;line-height:18px;opacity:0.9;'>\" . print_r($name, true) . \"</pre>\";\n            break;\n        case 3:\n            echo \"<pre>\" . print_r($name, true) . \"</pre>\";\n            break;\n        default:\n            # code...\n            break;\n    }\n\n}\n\n/**\n * \u9012\u5f52\u8c03\u7528\u83b7\u53d6md5\n * @param string $dir1        \u8def\u5f841\uff0c\u662f\u6807\u51c6\n */\nfunction get_folder_md5($dir1, $dirPath, &$data)\n{\n    if (is_dir($dir1)) {\n        $arr = scandir($dir1);\n        foreach ($arr as $entry) {\n            if (($entry != \".\") && ($entry != \"..\") && ($entry != \".svn\") && ($entry != \"runtime\") && ($entry != \".DS_Store\")) {\n                $new = $dir1 . \"/\" . $entry; //$new\u662f\u5b8c\u6574\u6587\u4ef6\u540d\u6216\u6587\u4ef6\u5939\u540d\n                //\u5982\u679c\u4e0d\u60f3\u663e\u793a\u6587\u4ef6\u540d\u53ef\u4ee5\u6ce8\u91ca\u4e0b\u9762\u8fd9\u53e5\n                //echo $entry . \"\\n\";\n                if (is_dir($new)) {\n                    get_folder_md5($new, $dirPath, $data);\n                } else {\n                    $md5_dir = str_replace($dirPath, \"\", $new);\n                    $_key    = md5($md5_dir);\n                    //\u8bfb\u4e66\u6570\u636e\u503c\n                    $md5_key = @md5_file($new);\n                    if (@$data[$_key]) {\n                        if ($data[$_key]['key'] == $md5_key) {\n                            unset($data[$_key]);\n                        } elseif ($data[$_key]['path'] == '/web/install.php') {\n                            unset($data[$_key]);\n                        }\n                    }\n                }\n            }\n        }\n    }\n    return $data;\n}\n\n/**\n * \u68c0\u67e5\u6570\u636e\u5e93\u94fe\u63a5\n * @param  [type] $host     [description]\n * @param  [type] $username [description]\n * @param  [type] $password [description]\n * @return [type]           [description]\n */\nfunction check_mysql_connection($host, $username, $password)\n{\n    $port = 3306;\n    if (strpos($host, \":\") !== false) {\n        list($host, $port) = explode(\":\", $host);\n    }\n    try {\n        $conn = \"mysql:host=$host;port=$port;charset=utf8mb4\";\n        return new PDO($conn, $username, $password);\n    } catch (PDOException $e) {\n        if ($e->getCode() === 2002) {\n            return -1; // -1 \u8868\u793a\u8fde\u63a5\u88ab\u62d2\u7edd\n        }\n        if ($e->getCode() === 1045) {\n            return -2; // -2 \u8868\u793a\u7528\u6237\u540d/\u5bc6\u7801\u9519\u8bef\n        }\n        return false;\n    }\n}\n\n/**\n * \u68c0\u67e5\u6570\u636e\u5e93\u662f\u5426\u53ef\u4ee5\u6b63\u5e38\u94fe\u63a5\n * @param  [type] $host     [description]\n * @param  [type] $username [description]\n * @param  [type] $password [description]\n * @param  [type] $database [description]\n * @return [type]           [description]\n */\nfunction check_mysql_database($host, $username, $password, $database)\n{\n\n    $port = 3306;\n    if (strpos($host, \":\") !== false) {\n        list($host, $port) = explode(\":\", $host);\n    }\n\n    //\u7528\u4e8e\u68c0\u67e5\u7aef\u53e3\u53f7\n\n    // $pdo = check_mysql_connection($host, $username, $password);\n    // $res = $pdo->prepare(\"show global variables like 'port'\"); //\u51c6\u5907\u67e5\u8be2\u8bed\u53e5\n    // $res->execute();\n    // $result = $res->fetchAll(PDO::FETCH_ASSOC);\n    // if ($result && $result[0]['Value']) {\n    //     if ($port !== $result[0]['Value']) {\n    //         return \"\u76d1\u6d4b\u5230\u7aef\u53e3\u4e3a[\" . $result[0]['Value'] . \"],\u8bf7\u6b63\u786e\u586b\u5199\u7aef\u53e3\u53f7\";\n    //     }\n    // }\n\n    $database = addslashes($database);\n    $pdo      = check_mysql_connection($host, $username, $password);\n    if ($pdo === false) {\n        return \"\u6570\u636e\u5e93\u65e0\u6cd5\u8fde\u63a5\";\n    }\n    if ($pdo->exec(\"USE $database\") !== false) {\n        if ($pdo->query(\"SHOW TABLES\")->rowCount() > 0) {\n            return \"\u6570\u636e\u5e93 $database \u4e0d\u4e3a\u7a7a\uff0c\u8bf7\u6e05\u7a7a\u540e\u91cd\u8bd5\";\n        }\n        return true;\n    } else {\n        if ($q = $pdo->query(\"SHOW DATABASES LIKE '$database'\")) {\n            if ($q->rowCount() > 0) {\n                return \"\u65e0\u6cd5\u5207\u6362\u5230\u6570\u636e\u5e93 $database\";\n            }\n            if ($pdo->query(\"CREATE DATABASE $database DEFAULT CHARACTER SET = `utf8mb4` DEFAULT COLLATE = `utf8mb4_unicode_ci`\") === false) {\n                return \"\u65e0\u6cd5\u521b\u5efa\u6570\u636e\u5e93 $database \uff0c\u8bf7\u68c0\u67e5\u7528\u6237\u6743\u9650\";\n            }\n            return true;\n        }\n        return \"\u65e0\u6cd5\u83b7\u53d6\u6570\u636e\u5e93\u5217\u8868\";\n    }\n}\n\nfunction base64url_decode($plainText)\n{\n    $base64url = strtr($plainText, '-_,', '+/=');\n    $base64    = base64_decode($base64url);\n    return $base64;\n}\n\n/**\n * \u6570\u636e\u5e93\u7248\u672c\u68c0\u67e5\n * @param  [type] $host     [description]\n * @param  [type] $username [description]\n * @param  [type] $password [description]\n * @return [type]           [description]\n */\nfunction check_mysql_version($host, $username, $password)\n{\n    $pdo = check_mysql_connection($host, $username, $password);\n    if ($pdo === false) {\n        return \"\u6570\u636e\u5e93\u65e0\u6cd5\u8fde\u63a5\";\n    }\n    if ($q = $pdo->query('SELECT VERSION()')) {\n        $version = $q->fetchColumn();\n        if (strpos($version, 'MariaDB') !== false) {\n            if (version_compare($version, '10.2.0', '>=')) {\n                return true;\n            }\n        } else {\n            if (version_compare($version, '5.6.0', '>=')) {\n                return true;\n            }\n        }\n    }\n    if ($q = $pdo->query(\"SELECT @@global.innodb_default_row_format\")) {\n        $rowformat = $q->fetchColumn();\n        if ($rowformat != \"dynamic\") {\n            return \"MySQL\u914d\u7f6e\u4e0d\u6b63\u786e\uff0c\u8bf7\u786e\u8ba4innodb_default_row_format\u914d\u7f6e\u4e3adynamic\";\n        }\n    } else {\n        return \"MySQL\u7248\u672c\u592a\u4f4e\uff0c\u8bf7\u4f7f\u7528MySQL5.6.50\u7248\u672c\u4ee5\u4e0a\u6216MariaDB10.2\u4ee5\u4e0a\";\n    }\n    return true;\n}\n\nfunction install_database($host, $username, $password, $prefix, $database, $inuser = null)\n{\n    try {\n        $port = 3306;\n        if (stripos($host, ':') !== false) {\n            list($host, $port) = explode(':', $host, 2);\n        }\n        $dbms = 'mysql';\n        $dsn  = \"$dbms:host=$host;port=$port;dbname=$database\";\n\n        $pdo = new PDO($dsn, $username, $password); //\u521d\u59cb\u5316\u4e00\u4e2aPDO\u5bf9\u8c61\n        $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);\n\n        //\u7528\u4e8e\u521b\u5efa\u6570\u636e\u8868\n        $sql = sprintf('CREATE DATABASE IF NOT EXISTS `%s`  DEFAULT CHARACTER SET = `utf8mb4` DEFAULT COLLATE = `utf8mb4_unicode_ci`', $database);\n        $res = $pdo->exec($sql);\n        //\u8bbe\u7f6e\u6570\u636e\u5e93\u8868\n        $str = \"use $database\";\n        $pdo->exec($str);\n\n        //\u6267\u884c\u8bbe\u7f6e\u6570\u636e\u8868\n        $sqlfile = dirname(__DIR__) . DIRECTORY_SEPARATOR . 'forms/install/install.sql';\n        $sql     = file_get_contents($sqlfile);\n        $sql     = str_replace('heshop_initialize_prefix_', $prefix, $sql);\n        $res     = $pdo->exec($sql);\n\n        //\u5199\u5165\u7528\u6237\u4fe1\u606f\n        if ($inuser) {\n            $res = $pdo->exec($inuser);\n        }\n        return [\n            'code' => 0,\n            'msg'  => \"ok\",\n        ];\n    } catch (PDOException $e) {\n        return [\n            'code' => -2,\n            'msg'  => [$e->getMessage()],\n        ];\n    }\n}\n\nfunction install_config($host, $username, $password, $prefix, $database)\n{\n    $port = 3306;\n\n    $defaultConfig = <<<ETF\n<?php\nreturn [\n    'class'       => 'yii\\db\\Connection',\n    'dsn'         => 'mysql:host=DummyDbHost;port=DummyDbPort;dbname=DummyDbDatabase',\n    'username'    => 'DummyDbUsername',\n    'password'    => 'DummyDbPassword',\n    'charset'     => 'utf8mb4',\n    'tablePrefix' => 'DummyDbPrefix',\n    'attributes'  => [\n        PDO::ATTR_STRINGIFY_FETCHES => false,\n        PDO::ATTR_EMULATE_PREPARES  => false,\n    ],\n];\nETF;\n\n    if (stripos($host, ':') !== false) {\n        list($host, $port) = explode(':', $host, 2);\n    }\n\n    $stub = str_replace([\n        'DummyDbHost',\n        'DummyDbPort',\n        'DummyDbDatabase',\n        'DummyDbUsername',\n        'DummyDbPassword',\n        'DummyDbPrefix',\n    ], [\n        $host,\n        $port,\n        $database,\n        $username,\n        $password,\n        $prefix,\n    ], $defaultConfig);\n\n    $dbfile = dirname(__DIR__) . DIRECTORY_SEPARATOR . 'config/db.php';\n    return file_put_contents($dbfile, $stub);\n}\n\n/**\n * \u83b7\u53d6\u7248\u672c\u53f7\n * @param  string $value [description]\n * @return [type]        [description]\n */\nfunction get_version()\n{\n    $json_string = file_get_contents('./version.json');\n    // \u7528\u53c2\u6570true\u628aJSON\u5b57\u7b26\u4e32\u5f3a\u5236\u8f6c\u6210PHP\u6570\u7ec4\n    $data = json_decode($json_string, true);\n    return $data['version'];\n}\n\n/**\n * \u6570\u636e\u6267\u884c\n */\n(new automation())->run();\n"], "fixing_code": ["<?php\n/**\n * \u6838\u5fc3\u6587\u4ef6\n * @link http://www.Leadshop.com/\n * @copyright Copyright (c) 2020 Leadshop Software LLC\n * @license http://www.Leadshop.com/license/\n */\nini_set(\"display_errors\", \"Off\");\nerror_reporting(E_ALL);\n//\u5f00\u542fSession\nsession_start();\n//\u5f53\u524d\u6587\u4ef6\u540d\u79f0\ndefine('LE_SCRIPT_NAME', basename(__FILE__));\n//\u7ad9\u70b9\u6839\u76ee\u5f55\u8def\u5f84\ndefine('LE_PACKAGE_BASE', dirname(__DIR__));\n//\u8bbe\u7f6e\u5f53\u524d\u8fd0\u884c\u6a21\u5f0f\ndefine('LE_OPERATION_MODE', 'production');\n//\u81ea\u52a8\u5316\u64cd\u4f5c\u7c7b\nclass automation\n{\n    /**\n     * \u6267\u884c\u66f4\u65b0\u811a\u672c\n     * include\n     * data\n     * meta\n     */\n    public function run()\n    {\n        //\u8bfb\u53d6\u53c2\u6570\u6570\u636e\n        $include = isset($_GET['include']) ? $_GET['include'] : \"\";\n        $data    = isset($_GET['data']) ? $_GET['data'] : \"\";\n        $meta    = isset($_GET['meta']) ? $_GET['meta'] : \"\";\n        //\u6267\u884c\u6570\u636e\u65b9\u6cd5\n        if ($include) {\n            if($include===\"Update\")\n            //$this->ToMkdir(\"/web/log.txt\", 1, false, true);\n            return call_user_func_array([$this, $include], [$meta, $data]);\n            else\n            die(\"\u68c0\u6d4b\u5230\u975e\u6cd5\u4f20\u53c2\uff0c\u8bf7\u767b\u5f55\u540e\u53f0\u8fdb\u5165\u66f4\u65b0\u754c\u9762\");\n            \n        } else {\n            //\u7528\u4e8e\u5224\u65ad\u662f\u5426\u975e\u6cd5\u64cd\u4f5c\n            $token = isset($_GET['token']) ? $_GET['token'] : \"\";\n            $html  = get_oss_url('index.html');\n            //\u5224\u65ad\u9501\u6587\u4ef6\u662f\u5426\u5b58\u5728\uff0c\u5b58\u5728\u5219\u662f\u8981\u6267\u884c\u66f4\u65b0\n            if (@file_exists(dirname(__DIR__) . \"/install.lock\")) {\n                if (@file_get_contents(dirname(__DIR__) . \"/install.lock\") === $token) {\n                    if (!isset($_SESSION['self_update'])) {\n                        //\u6267\u884c\u66f4\u65b0\u81ea\u8eab\n                        $this->SilentSelfUpdate();\n                    }\n                    //\u6267\u884c\u66f4\u65b0\u64cd\u4f5c\n                    $version = get_version();\n                    $body    = $this->DownloadFile($html);\n                    echo str_replace('{$version}', $version, $body);\n                } else {\n                    die(\"\u68c0\u6d4b\u5230\u975e\u6cd5Token\uff0c\u8bf7\u767b\u5f55\u540e\u53f0\u8fdb\u5165\u66f4\u65b0\u754c\u9762\");\n                }\n            } else {\n                $version = get_version();\n                $body    = $this->DownloadFile($html);\n                echo str_replace('{$version}', $version, $body);\n            }\n        }\n\n    }\n\n    /**\n     * \u52a8\u6001\u8c03\u7528\n     *\n     * @param $method\n     * @param $params\n     * @return mixed\n     */\n    public function __call($method, $params)\n    {\n        return call_user_func_array([self::connect(), $method], $params);\n    }\n\n    /**\n     * \u8c03\u7528\u9a71\u52a8\u7c7b\u7684\u65b9\u6cd5\n     * @access public\n     * @param  string $method \u65b9\u6cd5\u540d\n     * @param  array  $params \u53c2\u6570\n     * @return mixed\n     */\n    public static function __callStatic($method, $params)\n    {\n        return call_user_func_array([self::connect(), $method], $params);\n    }\n\n    /**\n     * \u8bbe\u7f6e\u94fe\u63a5\n     * @return [type] [description]\n     */\n    public static function connect()\n    {\n        return new leadshops();\n    }\n\n}\n\nclass leadshops\n{\n    /**\n     * \u6267\u884c\u66f4\u65b0\u811a\u672c\n     */\n    public function Update($params, $data)\n    {\n        $token = isset($_GET['token']) ? $_GET['token'] : \"\";\n        if (@file_exists(dirname(__DIR__) . \"/install.lock\")) {\n            if (@file_get_contents(dirname(__DIR__) . \"/install.lock\") == $token) {\n                if ($params == 1) {\n                    //\u83b7\u53d6\u7248\u672c\u53f7\n                    $version = get_version();\n                    //$this->ToMkdir(\"/web/log.txt\", $version, false, true);\n                    //$version = \"1.4.14\";//test version update\n                    //\u4fdd\u5b58\u672c\u5730\u7248\u672c\n                    $_SESSION['local_version'] = $version;\n                    if (!isset($_SESSION['version'])) {\n                        list($need_upgrade, $self_replaced, $remote_version) = $this->DoSelfUpdate();\n                        if (isset($_GET['remote_version']) && $_GET['remote_version']) {\n                            //\u4fdd\u5b58\u7248\u672c\u53f7\n                            $_SESSION['version'] = $_GET['remote_version'];\n                        } else {\n                            $_SESSION['version'] = $remote_version;\n                        }\n                    }\n                    //\u5224\u65ad\u7248\u672c\u53f7\u662f\u5426\u76f8\u540c\n                    if ($_SESSION['version'] == $version) {\n                        //\u53cd\u9988\u6267\u884c\u7ed3\u679c\n                        $data = [\n                            \"code\"    => 0,\n                            \"step\"    => 2,\n                            \"message\" => \"\u60a8\u5f53\u524d\u7248\u672c{$version}\u5df2\u662f\u6700\u65b0\u7248\u672c\u3002\",\n                        ];\n                        echo json_encode($data, JSON_UNESCAPED_UNICODE);\n                        exit();\n                    }\n                    //\u8bfb\u53d6\u66f4\u65b0\u8bb0\u5f55\n                    if (!isset($_SESSION['updateStep'])) {\n                        $_SESSION['updateStep'] = 0;\n                    }\n                    //\u8bfb\u53d6\u66f4\u65b0\u8bb0\u5f55\n                    if (!isset($_SESSION['upgrade'])) {\n                        //\u8bfb\u53d6\u7248\u672c\u53f7\n                        $version = $_SESSION['version'];\n                        //\u83b7\u53d6\u66f4\u65b0\u8bb0\u5f55\n                        $_SESSION['upgrade'] = $this->DownloadJson(\"https://qmxq.oss-cn-hangzhou.aliyuncs.com/V{$version}/upgrade.txt\");\n                    }\n                    //\u5904\u7406\u66f4\u65b0\u6587\u4ef6\u83b7\u53d6\n                    if (!isset($_SESSION['updateFile'])) {\n                        $dir1 = dirname(__DIR__);\n                        //\u6267\u884c\u66f4\u6587\u4ef6\n                        $data = $_SESSION['upgrade'];\n                        //\u5bf9\u4e0d\u83b7\u53d6\u66f4\u65b0\u6587\u4ef6\n                        $update_data             = get_folder_md5($dir1, $dir1, $data);\n                        $_SESSION['updateFile']  = $update_data;\n                        $_SESSION['updatePlan']  = count($update_data);\n                        $_SESSION['updateTotal'] = count($update_data);\n                    }\n                    // P(['updateFile', $_SESSION['updateFile']]);\n                    // P(['updateTotal', $_SESSION['updateTotal']]);\n                    // P(['updatePlan', $_SESSION['updatePlan']]);\n                    // P(['updateStep', $_SESSION['updateStep']]);\n                    //\u83b7\u53d6\u66f4\u65b0\u9a8c\u8bc1\u6587\u4ef6\n                    if ($_SESSION['updateFile'] && $_SESSION['updateTotal'] && $_SESSION['updatePlan'] > 0 && $_SESSION['updateStep'] === 0) {\n                        $data = [\n                            \"code\"    => 0,\n                            \"step\"    => 1,\n                            \"message\" => \"\u7b49\u5f85\u66f4\u65b0\u6267\u884c\",\n                            \"data\"    => [\n                                'total' => $_SESSION['updateTotal'],\n                                'plan'  => $_SESSION['updatePlan'],\n                                'step'  => $_SESSION['updateStep'],\n                            ],\n                        ];\n                        $_SESSION['updateStep']++;\n                        echo json_encode($data, JSON_UNESCAPED_UNICODE);\n                        exit();\n                    }\n                    //\u9010\u6b65\u6267\u884c\n                    //[key] => ae7ba26e3f9e2c19f1ae227d5dc8e898\n                    //[path] => /api/DemoController.php\n                    if ($_SESSION['updateFile'] && $_SESSION['updateTotal'] && $_SESSION['updatePlan'] >= 0 && $_SESSION['updateStep'] > 0) {\n                        //\u6b64\u5904\u5f00\u59cb\u6267\u884c\u6587\u4ef6\n                        $first = array_shift($_SESSION['updateFile']);\n                        $dir1  = dirname(__DIR__);\n                        //\u62fc\u63a5URL\u5730\u5740\u4fe1\u606f\n                        $url    = \"https://qmxq.oss-cn-hangzhou.aliyuncs.com/V{$_SESSION['version']}\" . $first['path'];\n                        $data   = $this->DownloadFile($url);\n                        $status = -1;\n                        $snull  = base64url_decode(\"Tm9TdWNoS2V5\");\n                        //\u5224\u65adOSS\u4e2d\u6587\u4ef6\u662f\u5426\u5b58\u5728\n                        $path = $dir1 . $first['path'];\n                        //\u6267\u884c\u6570\u636e\u5199\u5165 f09cb7eae8785c1a40287eaea6303c02\n                        // if (strpos($data, $snull) === false) {\n                        //     $path   = $dir1 . $first['path'];\n                        //     $status = $this->ToMkdir($path, $data, true, true);\n                        // }\n                        $path   = $dir1 . $first['path'];\n                        $status = $this->ToMkdir($path, $data, true, true);\n                        //\u53cd\u9988\u6267\u884c\u7ed3\u679c\n                        $data = [\n                            \"code\"    => 0,\n                            \"step\"    => 1,\n                            \"status\"  => $status,\n                            \"message\" => \"\u7b49\u5f85\u66f4\u65b0\u6267\u884c\",\n                            \"data\"    => [\n                                'file'  => $first['path'],\n                                'path'  => $path,\n                                'url'   => $url,\n                                'oss'   => strpos($data, $snull),\n                                'total' => $_SESSION['updateTotal'],\n                                'plan'  => $_SESSION['updatePlan'],\n                                'step'  => $_SESSION['updateStep'],\n                            ],\n                        ];\n                        $_SESSION['updatePlan']--;\n                        $_SESSION['updateStep']++;\n                        echo json_encode($data, JSON_UNESCAPED_UNICODE);\n                        exit();\n                    }\n                    //\u6267\u884cSQL\u8bed\u53e5\n                    if (!$_SESSION['updateFile'] && $_SESSION['updateTotal'] && $_SESSION['updatePlan'] === 0 && $_SESSION['updateStep'] > 0) {\n                        //\u53cd\u9988\u6267\u884c\u7ed3\u679c\n                        $data = [\n                            \"code\"    => 0,\n                            \"step\"    => 1,\n                            \"message\" => \"\u6b63\u5728\u6267\u884cSQL\",\n                            \"data\"    => [\n                                'file'  => '',\n                                'total' => $_SESSION['updateTotal'],\n                                'plan'  => $_SESSION['updatePlan'],\n                                'step'  => $_SESSION['updateStep'],\n                            ],\n                        ];\n                        //\u83b7\u53d6\u5f53\u524d\u7248\u672c\u53f7\n                        $version = $_SESSION['local_version'];\n                        //\u5904\u7406\u6570\u636e\u5e93\u6587\u4ef6\u66f4\u65b0\n                        $this->UpdateSql($version);\n                        $_SESSION['updatePlan'] = -1;\n                        echo json_encode($data, JSON_UNESCAPED_UNICODE);\n                        exit();\n                    }\n                    //\u66f4\u65b0\u5b8c\u6210\n                    if (!$_SESSION['updateFile'] && $_SESSION['updateTotal'] && $_SESSION['updatePlan'] === -1 && $_SESSION['updateStep'] > 0) {\n                        //\u53cd\u9988\u6267\u884c\u7ed3\u679c\n                        $data = [\n                            \"code\"    => 0,\n                            \"step\"    => 0,\n                            \"message\" => \"\u66f4\u65b0\u5b8c\u6210\",\n                            \"data\"    => [\n                                'file'  => '',\n                                'total' => $_SESSION['updateTotal'],\n                                'plan'  => $_SESSION['updatePlan'],\n                                'step'  => $_SESSION['updateStep'],\n                            ],\n                        ];\n                        //\u5904\u7406\u65b0\u7684\u7248\u672c\u53f7\n                        $versionData = [\n                            \"version\" => $_SESSION['version'],\n                        ];\n                        //\u5904\u7406\u7248\u672c\u53f7\u66f4\u65b0\u95ee\u9898\n                        $this->ToMkdir(__DIR__ . \"/version.json\", json_encode($versionData, JSON_UNESCAPED_UNICODE), true, true);\n                        $_SESSION = [];\n                        echo json_encode($data, JSON_UNESCAPED_UNICODE);\n                        exit();\n                    }\n                    //\u5904\u7406\u9a8c\u8bc1\n                    if ($_SESSION['updateTotal'] === 0 && $_SESSION['updatePlan'] === 0 && $_SESSION['updateStep'] === 0) {\n                        //\u53cd\u9988\u6267\u884c\u7ed3\u679c\n                        $data = [\n                            \"code\"    => 0,\n                            \"step\"    => 0,\n                            \"message\" => \"\u5f53\u524d\u7248\u672c\u5df2\u662f\u6700\u65b0\",\n                            \"data\"    => [\n                                'file'  => '',\n                                'total' => $_SESSION['updateTotal'],\n                                'plan'  => $_SESSION['updatePlan'],\n                                'step'  => $_SESSION['updateStep'],\n                            ],\n                        ];\n                        //\u5904\u7406\u65b0\u7684\u7248\u672c\u53f7\n                        $versionData = [\n                            \"version\" => $_SESSION['version'],\n                        ];\n                        //\u5904\u7406\u7248\u672c\u53f7\u66f4\u65b0\u95ee\u9898\n                        $this->ToMkdir(__DIR__ . \"/version.json\", json_encode($versionData, JSON_UNESCAPED_UNICODE), true, true);\n                        $_SESSION = [];\n                        echo json_encode($data, JSON_UNESCAPED_UNICODE);\n                        exit();\n                    }\n                }\n                if ($params == 2) {\n                    $_SESSION = [];\n                }\n            } else {\n                $data = [\n                    \"code\"    => -1,\n                    \"message\" => \"\u68c0\u6d4b\u5230\u975e\u6cd5Token\uff0c\u8bf7\u767b\u5f55\u540e\u53f0\u8fdb\u5165\u66f4\u65b0\u754c\u9762\",\n                ];\n                echo json_encode($data, JSON_UNESCAPED_UNICODE);\n            }\n        }\n    }\n\n    /**\n     * \u6267\u884c\u5b89\u88c5\u811a\u672c\n     */\n    public function Install($params, $data)\n    {\n        if ($params == 1) {\n            $data = [\n                \"code\" => 0,\n                \"data\" => [\n                    $this->FunctionCheck(),\n                    $this->ExtensionCheck(),\n                    $this->PreCheck(),\n                    $this->DirCheck(),\n                ],\n            ];\n            echo json_encode($data, JSON_UNESCAPED_UNICODE);\n        }\n        if ($params == 2) {\n            echo json_encode($this->CheckDatabase(), JSON_UNESCAPED_UNICODE);\n        }\n    }\n\n    /**\n     * \u4ee5get\u65b9\u5f0f\u63d0\u4ea4\u8bf7\u6c42\n     * @param $url\n     * @return bool|mixed\n     */\n    public function HttpGet($url)\n    {\n        $curl = curl_init();\n        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);\n        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);\n        curl_setopt($curl, CURLOPT_SSLVERSION, 1);\n        curl_setopt($curl, CURLOPT_URL, $url);\n        curl_setopt($curl, CURLOPT_TIMEOUT, 30);\n        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);\n        list($content, $status) = array(curl_exec($curl), curl_getinfo($curl), curl_close($curl));\n        return (intval($status[\"http_code\"]) === 200) ? $content : false;\n    }\n\n    /**\n     * \u521b\u5efa\u76ee\u5f55\n     * @param    string    $path     \u76ee\u5f55\u540d\u79f0\uff0c\u5982\u679c\u662f\u6587\u4ef6\u5e76\u4e14\u4e0d\u5b58\u5728\u7684\u60c5\u51b5\u4e0b\u4f1a\u81ea\u52a8\u521b\u5efa\n     * @param    string    $data     \u5199\u5165\u6570\u636e\n     * @param    bool    $is_full  \u5b8c\u6574\u8def\u5f84\uff0c\u9ed8\u8ba4False\n     * @param    bool    $is_cover \u5f3a\u5236\u8986\u76d6\uff0c\u9ed8\u8ba4False\n     * @return   bool    True|False\n     */\n    public function ToMkdir($path = null, $data = null, $is_full = false, $is_cover = false)\n    {\n        #\u975e\u5b8c\u6574\u8def\u5f84\u8fdb\u884c\u7ec4\u5408\n        if (!$is_full) {\n            $path = dirname(__DIR__) . '/' . ltrim(ltrim($path, './'), '/');\n        }\n        $file = $path;\n        #\u68c0\u6d4b\u662f\u5426\u4e3a\u6587\u4ef6\n        $file_suffix = pathinfo($path, PATHINFO_EXTENSION);\n        if ($file_suffix) {\n            $path = pathinfo($path, PATHINFO_DIRNAME);\n        } else {\n            $path = rtrim($path, '/');\n        }\n\n        #\u6267\u884c\u76ee\u5f55\u521b\u5efa\n        if (!is_dir($path)) {\n            if (!mkdir($path, 0777, true)) {\n                return false;\n            }\n            chmod($path, 0777);\n        }\n        #\u6587\u4ef6\u5219\u8fdb\u884c\u6587\u4ef6\u521b\u5efa\n        if ($file_suffix) {\n            if (!is_file($file)) {\n                if (!file_put_contents($file, $data)) {\n                    return false;\n                }\n            } else {\n                #\u5f3a\u5236\u8986\u76d6\n                if ($is_cover) {\n                    if (!file_put_contents($file, $data)) {\n                        return false;\n                    }\n                } else {\n                    return false;\n                }\n            }\n        }\n        return true;\n    }\n\n    /**\n     * \u6267\u884c\u6570\u636e\u5e93\u66f4\u65b0\n     * @param string $version [description]\n     */\n    public function UpdateSql($version = '')\n    {\n        try {\n            $db   = require dirname(__DIR__) . DIRECTORY_SEPARATOR . 'config/db.php';\n            $pdo  = new PDO($db['dsn'], $db['username'], $db['password']); //\u521d\u59cb\u5316\u4e00\u4e2aPDO\u5bf9\u8c61\n            $sql  = \"SELECT * FROM {$db['tablePrefix']}store_setting WHERE keyword = :version\";\n            $stmt = $pdo->prepare($sql);\n            $stmt->execute(['version' => 'mysql_version']);\n            $row = $stmt->fetch(PDO::FETCH_ASSOC);\n\n            $db_version = '1.2.0';\n            if (isset($row['content'])) {\n                $db_version = empty($row['content']) ? '1.2.0' : $row['content'];\n            }\n            $version_list = json_decode($this->httpGet(base64url_decode('aHR0cHM6Ly9jbG91ZC5sZWFkc2hvcC52aXAvbWFsbC91cGRhdGUvbGlzdA,,')), true);\n            if ($version_list['code'] === 0) {\n                $version_list = $version_list['data'];\n                foreach ($version_list as $key => $value) {\n                    if ($value['version'] == $db_version) {\n                        //\u83b7\u53d6\u4e0b\u4e00\u4e2a\u66f4\u65b0\u7248\u672c\n                        $data = @$version_list[$key + 1];\n                        if ($data) {\n                            $sql_data = @$this->httpGet(\"https://qmxq.oss-cn-hangzhou.aliyuncs.com/V{$data['version']}/sql.txt\");\n                            if ($sql_data) {\n                                $sql_data = str_replace('heshop_initialize_prefix_', $db['tablePrefix'], $sql_data);\n                                $res      = $pdo->exec($sql_data);\n                            }\n                            //\u4ee5\u4e0b\u662f\u4fee\u6539\u7248\u672c\u4fe1\u606f\u5185\u5bb9\n                            $sql  = \"UPDATE {$db['tablePrefix']}store_setting SET content = '{$data['version']}' WHERE keyword = 'mysql_version'\";\n                            $stmt = $pdo->prepare($sql);\n                            $stmt->execute();\n                        }\n                    }\n                }\n                return true;\n            } else {\n                return -2;\n            }\n        } catch (PDOException $e) {\n            return -3;\n        }\n    }\n\n    /**\n     * \u6267\u884c\u6587\u4ef6\u4e0b\u8f7d\n     * @param  [type]  $url              [description]\n     * @param  boolean $ignore_ssl_error [description]\n     * @return [type]                    [description]\n     */\n    public function DownloadFile($url, $ignore_ssl_error = false)\n    {\n        if (!function_exists('curl_init')) {\n            throw new Exception(\"curl\u6269\u5c55\u672a\u542f\u7528\");\n        }\n        $ch = curl_init();\n        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);\n        curl_setopt($ch, CURLOPT_HEADER, 0);\n        curl_setopt($ch, CURLOPT_URL, $url);\n        curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36');\n        if ($ignore_ssl_error) {\n            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);\n            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);\n        } else {\n            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);\n            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 1);\n        }\n\n        $response = curl_exec($ch);\n\n        if ($response === false) {\n            $error_no = curl_errno($ch);\n            throw new Exception(\"\u4e0b\u8f7d $url \u9519\u8bef\uff0ccode($error_no)\uff0c\u9519\u8bef\u4fe1\u606f\uff1a\" . curl_error($ch));\n        }\n        curl_close($ch);\n        return $response;\n    }\n\n    /**\n     * \u6267\u884c\u4e0b\u8f7dJSON\n     * @param  [type] $url [description]\n     * @return [type]      [description]\n     */\n    public function DownloadJson($url)\n    {\n        $pkg_str = $this->DownloadFile($url);\n        if ($pkg_str === false) {\n            throw new Exception(\"\u4e0b\u8f7d\u9519\u8bef: \" . $url);\n        }\n        $json = json_decode($pkg_str, true);\n        if ($json === null) {\n            throw new Exception(\"${pkg_str} \u65e0\u6cd5\u88ab\u89e3\u6790\u6210 json\");\n        }\n        return $json;\n    }\n\n    /**\n     * \u79fb\u9664\u76ee\u5f55\n     * @param  [type] $path [description]\n     * @return [type]       [description]\n     */\n    public function RemoveDir($path)\n    {\n        if (empty($path) || !$path) {\n            return false;\n        }\n        return is_file($path) ?\n        @unlink($path) :\n        array_map(__FUNCTION__, glob($path . '/*')) == @rmdir($path);\n    }\n\n    /**\n     * \u76d1\u6d4b\u662f\u5426\u662fHTTPS\n     * @return boolean [description]\n     */\n    public function IsHttps()\n    {\n        if (isset($_SERVER[\"HTTPS\"]) && strtolower($_SERVER[\"HTTPS\"]) != \"off\") {\n            return true;\n        }\n        if (isset($_SERVER[\"HTTP_X_FORWARDED_PROTO\"]) && strtolower($_SERVER[\"HTTP_X_FORWARDED_PROTO\"]) == \"https\") {\n            return true;\n        }\n        if (isset($_SERVER[\"HTTP_SCHEME\"]) && strtolower($_SERVER[\"HTTP_SCHEME\"]) == \"https\") {\n            return true;\n        }\n        if (isset($_SERVER[\"HTTP_FROM_HTTPS\"]) && strtolower($_SERVER[\"HTTP_FROM_HTTPS\"]) != \"off\") {\n            return true;\n        }\n        if (isset($_SERVER[\"SERVER_PORT\"]) && $_SERVER[\"SERVER_PORT\"] == 443) {\n            return true;\n        }\n        return false;\n    }\n\n    /**\n     * \u83b7\u53d6GET\u53c2\u6570\n     * @param  [type] $var [description]\n     * @return [type]      [description]\n     */\n    public static function getVar($var)\n    {\n        if (!isset($_GET[$var])) {\n            if (!isset($_POST[$var])) {\n                $_POST = json_decode(file_get_contents(\"php://input\"), true);\n                if (!isset($_POST[$var])) {\n                    return false;\n                }\n            }\n            $ret = $_POST[$var];\n        } else {\n            $ret = $_GET[$var];\n        }\n        return htmlspecialchars($ret);\n    }\n\n    /**\n     * [PreCheck description]\n     */\n    public function DirCheck()\n    {\n        //\u7528\u6237\u68c0\u67e5WEB\u76ee\u5f55\n        $dir       = __DIR__;\n        $base_name = basename($dir);\n        if ($base_name !== 'web') {\n            $LANG['base_name'] = array(\n                \"status\"  => 0,\n                \"data\"    => __DIR__,\n                \"message\" => \"\u68c0\u67e5\u5f53\u524d\u76ee\u5f55 $dir \u76ee\u5f55\u540d\u79f0\u662f\u5426\u4e3a web\",\n            );\n        } else {\n            $LANG['base_name'] = array(\n                \"status\"  => 1,\n                \"data\"    => __DIR__,\n                \"message\" => \"\u68c0\u67e5\u5f53\u524d\u76ee\u5f55 $dir \u76ee\u5f55\u540d\u79f0\u662f\u5426\u4e3a web\",\n            );\n        }\n\n        //\u7528\u6237\u68c0\u67e5\u6839\u76ee\u5f55\u9009\u9879\n        $dir_name = dirname($dir);\n        if (!$dir_name || $dir_name === \"/\" || preg_match(\"/^[a-z|A-Z]:[\\/|\\\\\\]?$/m\", $dir_name)) {\n            $LANG['dir_name'] = array(\n                \"status\"  => 0,\n                \"data\"    => $dir_name,\n                \"message\" => \"\u68c0\u67e5\u4e0a\u7ea7\u76ee\u5f55 $dir_name \u4e0d\u80fd\u4e3a\u6839\u76ee\u5f55\",\n            );\n        } else {\n            $LANG['dir_name'] = array(\n                \"status\"  => 1,\n                \"data\"    => $dir_name,\n                \"message\" => \"\u68c0\u67e5\u4e0a\u7ea7\u76ee\u5f55 $dir_name \u4e0d\u80fd\u4e3a\u6839\u76ee\u5f55\",\n            );\n        }\n        return $LANG;\n    }\n\n    /**\n     * \u76ee\u5f55\u68c0\u67e5\n     * @return [type] [description]\n     */\n    public function PreCheck()\n    {\n        $LANG           = array();\n        $needed_dirlist = array(\n            '/config', '/stores', '/web', '/web/assets',\n        );\n\n        //\u5faa\u73af\u68c0\u67e5\u76ee\u5f55\u662f\u5426\u53ef\u5199\n        foreach ($needed_dirlist as $dir) {\n            $key        = md5($dir);\n            $LANG[$key] = array(\n                \"status\"  => 1,\n                \"message\" => \"\u68c0\u6d4b\" . $dir . \"\u76ee\u5f55\u53ef\u5199\",\n            );\n            if (@!$this->WritableCheck(dirname(__DIR__) . $dir)) {\n                $LANG[$key] = array(\n                    \"status\"  => 0,\n                    \"message\" => \"\u68c0\u67e5\u5f53\u524d\u76ee\u5f55\" . $dir . \"\u662f\u5426\u53ef\u5199\",\n                );\n            }\n        }\n        return $LANG;\n    }\n\n    /**\n     * \u6269\u5c55\u76d1\u6d4b\n     * @return [type] [description]\n     */\n    public function ExtensionCheck()\n    {\n        $LANG              = array();\n        $needed_extensions = array(\n            'curl', 'gd', 'json', 'openssl', 'pdo', 'pdo_mysql', 'xml', 'zip',\n        );\n        foreach ($needed_extensions as $ext) {\n            $key        = 'function_' . $ext;\n            $LANG[$key] = array(\n                \"status\"  => 1,\n                \"message\" => $ext . \"\u6269\u5c55\u68c0\u6d4b\u53ef\u7528\",\n            );\n            if (!extension_loaded($ext)) {\n                $LANG[$key] = array(\n                    \"status\"  => 0,\n                    \"message\" => \"PHP\u6269\u5c55\u8981\u6c42\u652f\u6301 \" . $ext,\n                );\n            }\n        }\n        return $LANG;\n    }\n\n    /**\n     * \u51fd\u6570\u76d1\u6d4b\n     * @return [type] [description]\n     */\n    public function FunctionCheck()\n    {\n        $LANG             = array();\n        $needed_functions = array(\n            'symlink', 'realpath',\n        );\n        foreach ($needed_functions as $func) {\n            $key        = 'function_' . $func;\n            $LANG[$key] = array(\n                \"status\"  => 1,\n                \"message\" => $func . \"\u51fd\u6570\u68c0\u6d4b\u53ef\u7528\",\n            );\n            if (!function_exists($func)) {\n                $LANG[$key] = array(\n                    \"status\"  => 0,\n                    \"message\" => \"PHP\u51fd\u6570\u8981\u6c42\u542f\u7528 \" . $func,\n                );\n            }\n        }\n        return $LANG;\n    }\n\n    /**\n     * \u6267\u884c\u6570\u636e\u5e93\u8868\u5355\n     * @return [type] [description]\n     */\n    public function CheckDatabase()\n    {\n        //\u8868\u793a\u662f\u63d0\u4ea4\u7684\u8868\u5355\n        $action = true;\n        //\u7f51\u7ad9\u6807\u9898\n        $forumTitle = self::getVar('forumTitle');\n        //MySQL \u670d\u52a1\u5668\u5730\u5740\n        $mysqlHost = self::getVar('mysqlHost') . \":\" . self::getVar('mysqlPort') ?? \"3306\";\n        //\u6570\u636e\u5e93\u540d\u79f0\n        $mysqlDatabase = self::getVar('mysqlDatabase');\n        //MySQL \u7528\u6237\u540d\n        $mysqlUsername = self::getVar('mysqlUsername');\n        //MySQL \u5bc6\u7801\n        $mysqlPassword = self::getVar('mysqlPassword');\n        //\u8868\u524d\u7f00(\u53ef\u9009)\n        $tablePrefix = trim(self::getVar('tablePrefix'));\n        //\u8bbe\u7f6e\u7ba1\u7406\u5458\u624b\u673a\u53f7\n        $adminUsername = self::getVar('adminUsername');\n        //\u8bbe\u7f6e\u7ba1\u7406\u5458\u5bc6\u7801\n        $adminPassword = self::getVar('adminPassword');\n        //\u7ba1\u7406\u5458\u5bc6\u7801\u786e\u8ba4\n        $adminPasswordConfirmation = self::getVar('adminPasswordConfirmation');\n\n        // \u5224\u65ad\u6bcf\u4e2a\u5b57\u6bb5\u662f\u5426\u5408\u6cd5\n        $forumTitleInvalid    = $action && !$forumTitle;\n        $mysqlHostInvalid     = $action && !$mysqlHost;\n        $mysqlDatabaseInvalid = $action && !$mysqlDatabase;\n        $mysqlUsernameInvalid = $action && !$mysqlUsername;\n        $mysqlPasswordInvalid = $action && !$mysqlPassword;\n        $tablePrefixInvalid   = $action && $tablePrefix && !preg_match(\"/^\\w+$/\", $tablePrefix);\n        $adminUsernameInvalid = $action && !$adminUsername;\n        $adminPasswordInvalid = $action && (!$adminPassword || !$adminPasswordConfirmation || ($adminPasswordConfirmation != $adminPassword));\n\n        // \u9700\u8981\u68c0\u67e5\u6570\u636e\u5e93\u8fde\u63a5\n        $mysqlConnectCheck = $action && !$mysqlHostInvalid && !$mysqlUsernameInvalid && !$mysqlPasswordInvalid;\n\n        $mysqlVersionInvalid       = true;\n        $mysqlConnectInvalid       = true;\n        $mysqlUserPassInvalid      = true;\n        $mysqlDatabaseDbInvalid    = true;\n        $mysqlDatabaseDbInvalidMsg = \"\";\n        $mysqlVersionInvalidMsg    = \"\";\n\n        if ($mysqlConnectCheck) {\n            $r                    = check_mysql_connection($mysqlHost, $mysqlUsername, $mysqlPassword);\n            $mysqlConnectInvalid  = ($r === -1) || $r === false;\n            $mysqlUserPassInvalid = ($r === -2);\n            $mysqlHostInvalid     = $mysqlHostInvalid || $mysqlConnectInvalid;\n\n            if ($mysqlUserPassInvalid) {\n                $mysqlUsernameInvalid = true;\n                $mysqlPasswordInvalid = true;\n            }\n\n            if (!$mysqlConnectInvalid && !$mysqlUserPassInvalid) {\n                // \u5982\u679c\u6570\u636e\u5e93\u53ef\u8fde\u63a5\n                $r = check_mysql_version($mysqlHost, $mysqlUsername, $mysqlPassword);\n                if ($r !== true) {\n                    // \u5982\u679c\u6570\u636e\u5e93\u7248\u672c\u9519\u8bef\uff0c\u4e5f\u6807\u8bb0mysqlHost\u5b57\u6bb5\u4e0d\u5408\u6cd5\n                    $mysqlHostInvalid       = true;\n                    $mysqlVersionInvalid    = true;\n                    $mysqlVersionInvalidMsg = $r;\n                } else {\n                    $mysqlVersionInvalid = false;\n                }\n                if (!$mysqlDatabaseInvalid) {\n                    // \u5982\u679c\u8f93\u5165\u4e86\u6570\u636e\u5e93\u540d\u79f0\n                    $r = check_mysql_database($mysqlHost, $mysqlUsername, $mysqlPassword, $mysqlDatabase);\n                    if ($r !== true) {\n                        $mysqlDatabaseInvalid      = true;\n                        $mysqlDatabaseDbInvalidMsg = $r;\n                        $mysqlDatabaseDbInvalid    = true;\n                    }\n                }\n            }\n        }\n\n        $LANG = array();\n\n        if ($action && !$forumTitle) {\n            $LANG['forumTitle'] = \"\u7ad9\u70b9\u540d\u79f0\u4e0d\u80fd\u4e3a\u7a7a\";\n        }\n\n        if ($action && !$mysqlHost) {\n            $LANG['mysqlHost'] = \"MySQL \u670d\u52a1\u5668\u4e0d\u80fd\u4e3a\u7a7a\";\n        }\n\n        if ($mysqlConnectCheck && $mysqlConnectInvalid) {\n            $LANG['mysqlConnectInvalid'] = \"MySQL \u670d\u52a1\u5668\u65e0\u6cd5\u8fde\u63a5\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u5668\u7684IP\u4e0e\u7aef\u53e3(\u53ef\u7528:\u6307\u5b9a\u7aef\u53e3\u53f7)\";\n        }\n\n        if ($mysqlConnectCheck && $mysqlVersionInvalid && $mysqlVersionInvalidMsg) {\n            $LANG['mysqlVersionInvalid'] = $mysqlVersionInvalidMsg;\n        }\n\n        if ($mysqlConnectCheck && $mysqlDatabaseInvalid && $mysqlDatabaseDbInvalidMsg) {\n            $LANG['mysqlDatabaseInvalid'] = $mysqlDatabaseDbInvalidMsg;\n        }\n\n        if ($action && !$mysqlUsername) {\n            $LANG['mysqlUsername'] = \"MySQL \u7528\u6237\u540d\u4e0d\u80fd\u4e3a\u7a7a\";\n        }\n\n        if ($action && $mysqlUserPassInvalid) {\n            $LANG['mysqlUserPassInvalid'] = \"\u4f7f\u7528\u60a8\u8f93\u5165\u7684 MySQL \u7528\u6237\u540d\u5bc6\u7801\u7ec4\u5408\u65e0\u6cd5\u8fde\u63a5\u5230\u6570\u636e\u5e93\";\n        }\n\n        if ($action && !$mysqlPassword) {\n            $LANG['mysqlPassword'] = \"MySQL \u5bc6\u7801\u4e0d\u80fd\u4e3a\u7a7a\";\n        }\n\n        if ($action && $mysqlUserPassInvalid) {\n            $LANG['mysqlUserPassInvalid'] = \"\u4f7f\u7528\u60a8\u8f93\u5165\u7684 MySQL \u7528\u6237\u540d\u5bc6\u7801\u7ec4\u5408\u65e0\u6cd5\u8fde\u63a5\u5230\u6570\u636e\u5e93\";\n        }\n\n        if ($action && !$adminUsername) {\n            $LANG['adminUsername'] = \"\u7ba1\u7406\u5458\u7528\u6237\u540d\u4e0d\u80fd\u4e3a\u7a7a\";\n        }\n\n        if ($action && !$adminPassword) {\n            $LANG['adminPassword'] = \"\u7ba1\u7406\u5458\u5bc6\u7801\u4e0d\u80fd\u4e3a\u7a7a\";\n        } else if ($action && ($adminPassword != $adminPasswordConfirmation)) {\n            $LANG['adminPasswordConfirmation'] = \"\u7ba1\u7406\u5458\u5bc6\u7801\u4e24\u6b21\u8f93\u5165\u4e0d\u4e00\u81f4\";\n        }\n\n        if ($action && !$adminPasswordConfirmation) {\n            $LANG['adminPasswordConfirmation'] = \"\u7ba1\u7406\u5458\u5bc6\u7801\u786e\u8ba4\u4e0d\u80fd\u4e3a\u7a7a\";\n        } else if ($action && ($adminPassword != $adminPasswordConfirmation)) {\n            $LANG['adminPasswordConfirmation'] = \"\u7ba1\u7406\u5458\u5bc6\u7801\u4e24\u6b21\u8f93\u5165\u4e0d\u4e00\u81f4\";\n        }\n\n        if (strpos($mysqlDatabase, '-') !== false) {\n            $LANG['mysqlDatabase'] = \"\u6570\u636e\u5e93\u540d\u79f0\u4e2d\u4e0d\u80fd\u5305\u542b-\";\n        }\n\n        $ready_to_install = $action && !$forumTitleInvalid && !$mysqlHostInvalid && !$mysqlDatabaseInvalid && !$mysqlUsernameInvalid\n        && !$mysqlPasswordInvalid && !$tablePrefixInvalid && !$adminUsernameInvalid && !$adminPasswordInvalid && !$mysqlUserPassInvalid;\n\n        //\u6267\u884c\u6570\u636e\u5e93\u5199\u5165\u64cd\u4f5c\n        if ($ready_to_install) {\n            $md5Password = md5($adminPassword);\n            $table       = $tablePrefix . \"account\";\n            $inuser      = \"insert into {$table}(mobile,password,nickname) values('{$adminUsername}','{$md5Password}','\u7ba1\u7406\u5458')\";\n            $data        = install_database($mysqlHost, $mysqlUsername, $mysqlPassword, $tablePrefix, $mysqlDatabase, $inuser);\n            if ($data['code'] === 0) {\n                //\u521b\u5efa\u914d\u7f6e\u6587\u4ef6\n                $returned = install_config($mysqlHost, $mysqlUsername, $mysqlPassword, $tablePrefix, $mysqlDatabase);\n                if ($returned && $this->MakeLockFile()) {\n                    return [\n                        'code' => 0,\n                        'msg'  => \"\u5b89\u88c5\u6210\u529f\",\n                    ];\n                } else {\n                    return [\n                        'code' => -1,\n                        'msg'  => \"\u8bf7\u68c0\u67e5\u76ee\u5f55\u662f\u5426\u53ef\u5199\",\n                    ];\n                }\n            } else {\n                return $data;\n            }\n        } else {\n            return [\n                'code' => -1,\n                'msg'  => $LANG,\n            ];\n        }\n    }\n\n    /**\n     * \u521b\u5efa\u9501\u5b9a\u6587\u4ef6\n     */\n    public function MakeLockFile()\n    {\n        $key = MD5(time());\n        @file_put_contents(dirname(__DIR__) . \"/install.lock\", \"locked\" . $key);\n        return true;\n    }\n\n    /**\n     * \u5199\u5165\u76d1\u6d4b\n     * @param  [type] $dir [description]\n     * @return [type]      [description]\n     */\n    public function WritableCheck($dir)\n    {\n        try {\n            $tmpfile = $dir . \"/\" . uniqid('test', true);\n            if (!is_writable($dir)) {\n                return false;\n            }\n            if (file_put_contents($tmpfile, \"hello\") === false) {\n                return false;\n            }\n            if (!file_exists($tmpfile)) {\n                return false;\n            }\n            return unlink($tmpfile);\n        } catch (Exception $e) {\n            return false;\n        }\n    }\n\n    /**\n     * \u81ea\u5df1\u5347\u7ea7\u81ea\u5df1\n     */\n    public function SilentSelfUpdate()\n    {\n        $dir = __DIR__;\n        if ($this->WritableCheck($dir)) {\n            if (is_writable(__FILE__)) {\n                try {\n                    list($need_upgrade, $self_replaced, $remote_version) = $this->DoSelfUpdate();\n                    if ($need_upgrade && $self_replaced) {\n                        echo \"<script language=JavaScript>document.location.reload();</script>\";\n                    }\n                } catch (Exception $e) {\n                    exit(\"\u8bf7\u68c0\u67e5WEB\u662f\u5426\u53ef\u5199\");\n                }\n            }\n        }\n    }\n\n    /**\n     * \u5347\u7ea7\u81ea\u8eab\u6587\u4ef6\n     */\n    public function DoSelfUpdate()\n    {\n        $SELF_VERSION   = get_version();\n        $self_replaced  = false;\n        $need_upgrade   = false;\n        $remote_version = trim($this->DownloadFile(get_oss_url('latest_le_ver.txt')));\n        if ($remote_version !== $SELF_VERSION) {\n            $need_upgrade = true;\n            $new_file     = $this->DownloadFile(get_oss_url('leadshop.php'));\n            $new_file_md5 = trim($this->DownloadFile(get_oss_url('latest_le_md5.txt')));\n            if (md5($new_file) === $new_file_md5) {\n                if (file_put_contents(__FILE__, $new_file)) {\n                    $self_replaced           = true;\n                    $_SESSION['self_update'] = true;\n                }\n            }\n        }\n        return array($need_upgrade, $self_replaced, $remote_version);\n    }\n}\n/**\n * \u83b7\u53d6URL\u5730\u5740\n * @param  [type] $name [description]\n * @return [type]       [description]\n */\nfunction get_oss_url($name)\n{\n    $url = \"https://qmxq.oss-cn-hangzhou.aliyuncs.com\";\n    return $url . \"/leadshop/\" . LE_OPERATION_MODE . \"/\" . $name;\n}\n/**\n * \u6253\u5370\u8f93\u51fa\u6570\u636e\n * @Author   Sean       Yan\n * @DateTime 2018-09-07\n * @param    [type]     $name [description]\n * @param    integer    $type [description]\n */\nfunction P($name, $type = 1)\n{\n\n    switch ($type) {\n        case 1:\n            echo \"<pre style='position:relative;z-index:1000;padding:10px;border-radius:5px;background:#F5F5F5;border:1px solid #aaa;font-size:14px;line-height:18px;opacity:0.9;'>\" . print_r($name, true) . \"</pre>\";\n            break;\n        case 2:\n            $name = unhtml($name);\n            echo \"<pre style='position:relative;z-index:1000;padding:10px;border-radius:5px;background:#F5F5F5;border:1px solid #aaa;font-size:14px;line-height:18px;opacity:0.9;'>\" . print_r($name, true) . \"</pre>\";\n            break;\n        case 3:\n            echo \"<pre>\" . print_r($name, true) . \"</pre>\";\n            break;\n        default:\n            # code...\n            break;\n    }\n\n}\n\n/**\n * \u9012\u5f52\u8c03\u7528\u83b7\u53d6md5\n * @param string $dir1        \u8def\u5f841\uff0c\u662f\u6807\u51c6\n */\nfunction get_folder_md5($dir1, $dirPath, &$data)\n{\n    if (is_dir($dir1)) {\n        $arr = scandir($dir1);\n        foreach ($arr as $entry) {\n            if (($entry != \".\") && ($entry != \"..\") && ($entry != \".svn\") && ($entry != \"runtime\") && ($entry != \".DS_Store\")) {\n                $new = $dir1 . \"/\" . $entry; //$new\u662f\u5b8c\u6574\u6587\u4ef6\u540d\u6216\u6587\u4ef6\u5939\u540d\n                //\u5982\u679c\u4e0d\u60f3\u663e\u793a\u6587\u4ef6\u540d\u53ef\u4ee5\u6ce8\u91ca\u4e0b\u9762\u8fd9\u53e5\n                //echo $entry . \"\\n\";\n                if (is_dir($new)) {\n                    get_folder_md5($new, $dirPath, $data);\n                } else {\n                    $md5_dir = str_replace($dirPath, \"\", $new);\n                    $_key    = md5($md5_dir);\n                    //\u8bfb\u4e66\u6570\u636e\u503c\n                    $md5_key = @md5_file($new);\n                    if (@$data[$_key]) {\n                        if ($data[$_key]['key'] == $md5_key) {\n                            unset($data[$_key]);\n                        } elseif ($data[$_key]['path'] == '/web/install.php') {\n                            unset($data[$_key]);\n                        }\n                    }\n                }\n            }\n        }\n    }\n    return $data;\n}\n\n/**\n * \u68c0\u67e5\u6570\u636e\u5e93\u94fe\u63a5\n * @param  [type] $host     [description]\n * @param  [type] $username [description]\n * @param  [type] $password [description]\n * @return [type]           [description]\n */\nfunction check_mysql_connection($host, $username, $password)\n{\n    $port = 3306;\n    if (strpos($host, \":\") !== false) {\n        list($host, $port) = explode(\":\", $host);\n    }\n    try {\n        $conn = \"mysql:host=$host;port=$port;charset=utf8mb4\";\n        return new PDO($conn, $username, $password);\n    } catch (PDOException $e) {\n        if ($e->getCode() === 2002) {\n            return -1; // -1 \u8868\u793a\u8fde\u63a5\u88ab\u62d2\u7edd\n        }\n        if ($e->getCode() === 1045) {\n            return -2; // -2 \u8868\u793a\u7528\u6237\u540d/\u5bc6\u7801\u9519\u8bef\n        }\n        return false;\n    }\n}\n\n/**\n * \u68c0\u67e5\u6570\u636e\u5e93\u662f\u5426\u53ef\u4ee5\u6b63\u5e38\u94fe\u63a5\n * @param  [type] $host     [description]\n * @param  [type] $username [description]\n * @param  [type] $password [description]\n * @param  [type] $database [description]\n * @return [type]           [description]\n */\nfunction check_mysql_database($host, $username, $password, $database)\n{\n\n    $port = 3306;\n    if (strpos($host, \":\") !== false) {\n        list($host, $port) = explode(\":\", $host);\n    }\n\n    //\u7528\u4e8e\u68c0\u67e5\u7aef\u53e3\u53f7\n\n    // $pdo = check_mysql_connection($host, $username, $password);\n    // $res = $pdo->prepare(\"show global variables like 'port'\"); //\u51c6\u5907\u67e5\u8be2\u8bed\u53e5\n    // $res->execute();\n    // $result = $res->fetchAll(PDO::FETCH_ASSOC);\n    // if ($result && $result[0]['Value']) {\n    //     if ($port !== $result[0]['Value']) {\n    //         return \"\u76d1\u6d4b\u5230\u7aef\u53e3\u4e3a[\" . $result[0]['Value'] . \"],\u8bf7\u6b63\u786e\u586b\u5199\u7aef\u53e3\u53f7\";\n    //     }\n    // }\n\n    $database = addslashes($database);\n    $pdo      = check_mysql_connection($host, $username, $password);\n    if ($pdo === false) {\n        return \"\u6570\u636e\u5e93\u65e0\u6cd5\u8fde\u63a5\";\n    }\n    if ($pdo->exec(\"USE $database\") !== false) {\n        if ($pdo->query(\"SHOW TABLES\")->rowCount() > 0) {\n            return \"\u6570\u636e\u5e93 $database \u4e0d\u4e3a\u7a7a\uff0c\u8bf7\u6e05\u7a7a\u540e\u91cd\u8bd5\";\n        }\n        return true;\n    } else {\n        if ($q = $pdo->query(\"SHOW DATABASES LIKE '$database'\")) {\n            if ($q->rowCount() > 0) {\n                return \"\u65e0\u6cd5\u5207\u6362\u5230\u6570\u636e\u5e93 $database\";\n            }\n            if ($pdo->query(\"CREATE DATABASE $database DEFAULT CHARACTER SET = `utf8mb4` DEFAULT COLLATE = `utf8mb4_unicode_ci`\") === false) {\n                return \"\u65e0\u6cd5\u521b\u5efa\u6570\u636e\u5e93 $database \uff0c\u8bf7\u68c0\u67e5\u7528\u6237\u6743\u9650\";\n            }\n            return true;\n        }\n        return \"\u65e0\u6cd5\u83b7\u53d6\u6570\u636e\u5e93\u5217\u8868\";\n    }\n}\n\nfunction base64url_decode($plainText)\n{\n    $base64url = strtr($plainText, '-_,', '+/=');\n    $base64    = base64_decode($base64url);\n    return $base64;\n}\n\n/**\n * \u6570\u636e\u5e93\u7248\u672c\u68c0\u67e5\n * @param  [type] $host     [description]\n * @param  [type] $username [description]\n * @param  [type] $password [description]\n * @return [type]           [description]\n */\nfunction check_mysql_version($host, $username, $password)\n{\n    $pdo = check_mysql_connection($host, $username, $password);\n    if ($pdo === false) {\n        return \"\u6570\u636e\u5e93\u65e0\u6cd5\u8fde\u63a5\";\n    }\n    if ($q = $pdo->query('SELECT VERSION()')) {\n        $version = $q->fetchColumn();\n        if (strpos($version, 'MariaDB') !== false) {\n            if (version_compare($version, '10.2.0', '>=')) {\n                return true;\n            }\n        } else {\n            if (version_compare($version, '5.6.0', '>=')) {\n                return true;\n            }\n        }\n    }\n    if ($q = $pdo->query(\"SELECT @@global.innodb_default_row_format\")) {\n        $rowformat = $q->fetchColumn();\n        if ($rowformat != \"dynamic\") {\n            return \"MySQL\u914d\u7f6e\u4e0d\u6b63\u786e\uff0c\u8bf7\u786e\u8ba4innodb_default_row_format\u914d\u7f6e\u4e3adynamic\";\n        }\n    } else {\n        return \"MySQL\u7248\u672c\u592a\u4f4e\uff0c\u8bf7\u4f7f\u7528MySQL5.6.50\u7248\u672c\u4ee5\u4e0a\u6216MariaDB10.2\u4ee5\u4e0a\";\n    }\n    return true;\n}\n\nfunction install_database($host, $username, $password, $prefix, $database, $inuser = null)\n{\n    try {\n        $port = 3306;\n        if (stripos($host, ':') !== false) {\n            list($host, $port) = explode(':', $host, 2);\n        }\n        $dbms = 'mysql';\n        $dsn  = \"$dbms:host=$host;port=$port;dbname=$database\";\n\n        $pdo = new PDO($dsn, $username, $password); //\u521d\u59cb\u5316\u4e00\u4e2aPDO\u5bf9\u8c61\n        $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);\n\n        //\u7528\u4e8e\u521b\u5efa\u6570\u636e\u8868\n        $sql = sprintf('CREATE DATABASE IF NOT EXISTS `%s`  DEFAULT CHARACTER SET = `utf8mb4` DEFAULT COLLATE = `utf8mb4_unicode_ci`', $database);\n        $res = $pdo->exec($sql);\n        //\u8bbe\u7f6e\u6570\u636e\u5e93\u8868\n        $str = \"use $database\";\n        $pdo->exec($str);\n\n        //\u6267\u884c\u8bbe\u7f6e\u6570\u636e\u8868\n        $sqlfile = dirname(__DIR__) . DIRECTORY_SEPARATOR . 'forms/install/install.sql';\n        $sql     = file_get_contents($sqlfile);\n        $sql     = str_replace('heshop_initialize_prefix_', $prefix, $sql);\n        $res     = $pdo->exec($sql);\n\n        //\u5199\u5165\u7528\u6237\u4fe1\u606f\n        if ($inuser) {\n            $res = $pdo->exec($inuser);\n        }\n        return [\n            'code' => 0,\n            'msg'  => \"ok\",\n        ];\n    } catch (PDOException $e) {\n        return [\n            'code' => -2,\n            'msg'  => [$e->getMessage()],\n        ];\n    }\n}\n\nfunction install_config($host, $username, $password, $prefix, $database)\n{\n    $port = 3306;\n\n    $defaultConfig = <<<ETF\n<?php\nreturn [\n    'class'       => 'yii\\db\\Connection',\n    'dsn'         => 'mysql:host=DummyDbHost;port=DummyDbPort;dbname=DummyDbDatabase',\n    'username'    => 'DummyDbUsername',\n    'password'    => 'DummyDbPassword',\n    'charset'     => 'utf8mb4',\n    'tablePrefix' => 'DummyDbPrefix',\n    'attributes'  => [\n        PDO::ATTR_STRINGIFY_FETCHES => false,\n        PDO::ATTR_EMULATE_PREPARES  => false,\n    ],\n];\nETF;\n\n    if (stripos($host, ':') !== false) {\n        list($host, $port) = explode(':', $host, 2);\n    }\n\n    $stub = str_replace([\n        'DummyDbHost',\n        'DummyDbPort',\n        'DummyDbDatabase',\n        'DummyDbUsername',\n        'DummyDbPassword',\n        'DummyDbPrefix',\n    ], [\n        $host,\n        $port,\n        $database,\n        $username,\n        $password,\n        $prefix,\n    ], $defaultConfig);\n\n    $dbfile = dirname(__DIR__) . DIRECTORY_SEPARATOR . 'config/db.php';\n    return file_put_contents($dbfile, $stub);\n}\n\n/**\n * \u83b7\u53d6\u7248\u672c\u53f7\n * @param  string $value [description]\n * @return [type]        [description]\n */\nfunction get_version()\n{\n    $json_string = file_get_contents('./version.json');\n    // \u7528\u53c2\u6570true\u628aJSON\u5b57\u7b26\u4e32\u5f3a\u5236\u8f6c\u6210PHP\u6570\u7ec4\n    $data = json_decode($json_string, true);\n    return $data['version'];\n}\n\n/**\n * \u6570\u636e\u6267\u884c\n */\n(new automation())->run();\n"], "filenames": ["web/leadshop.php"], "buggy_code_start_loc": [34], "buggy_code_end_loc": [110], "fixing_code_start_loc": [35], "fixing_code_end_loc": [118], "type": "NVD-CWE-Other", "message": "Dangerous method exposed which can lead to RCE in qmpass/leadshop v1.4.15 allows an attacker to control the target host by calling any function in leadshop.php via the GET method.", "other": {"cve": {"id": "CVE-2022-4136", "sourceIdentifier": "security@huntr.dev", "published": "2022-11-24T08:15:09.173", "lastModified": "2022-11-30T19:52:49.420", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Dangerous method exposed which can lead to RCE in qmpass/leadshop v1.4.15 allows an attacker to control the target host by calling any function in leadshop.php via the GET method."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.8, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.9, "impactScore": 5.9}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:H/A:L", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "HIGH", "availabilityImpact": "LOW", "baseScore": 8.6, "baseSeverity": "HIGH"}, "exploitabilityScore": 3.9, "impactScore": 4.7}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "NVD-CWE-Other"}]}, {"source": "security@huntr.dev", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-749"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:leadshop:leadshop:1.4.15:*:*:*:*:*:*:*", "matchCriteriaId": "0048661E-1344-411D-8D87-D3DBAF6F5104"}]}]}], "references": [{"url": "https://github.com/qmpaas/leadshop/commit/f27e9ca5c93eaadda1097396b65c234b16186d67", "source": "security@huntr.dev", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://huntr.dev/bounties/fe418ae1-7c80-4d91-8a5a-923d60ba78c3", "source": "security@huntr.dev", "tags": ["Exploit", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/qmpaas/leadshop/commit/f27e9ca5c93eaadda1097396b65c234b16186d67"}}