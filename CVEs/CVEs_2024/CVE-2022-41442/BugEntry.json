{"buggy_code": ["<?php\n\t/**\n\t * Created by PhpStorm.\n\t * User: Bruce Xie\n\t * Date: 2019-04-13\n\t * Time: 02:37\n\t */\n\nnamespace settings;\n\nuse uploader\\UploadOnedrive;\nuse uploader\\UploadGoogledrive;\n\nclass SettingController extends Controller {\n\tpublic $settings;\n\tpublic $storageTypes;\n\tpublic $storagesDir;\n\t\n\tpublic function __construct ()\n\t{\n\t\tif(is_file(APP_PATH.'/config/.config.json')){\n\t\t\t$settings = json_decode(file_get_contents(APP_PATH.'/config/.config.json'), true);\n\t\t}else{\n\t\t\tif(is_file(APP_PATH.'/config/config-local.php')){\n\t\t\t\t$settings = require(APP_PATH.'/config/config-local.php');\n\t\t\t}else if(is_file(APP_PATH.'/config/config.php')){\n\t\t\t\t$settings = require(APP_PATH.'/config/config.php');\n\t\t\t}else{\n\t\t\t\tthrow new \\Exception('No config-local.php or config.php found in \"config/\" directory!');\n\t\t\t}\n\t\t}\n\t\t$this->settings = $settings;\n\t\t$this->storageTypes = $settings['storageTypes'];\n\t\t$this->storagesDir = APP_PATH.'/config/.settings';\n\t}\n\t\n\t/**\n\t * \u83b7\u53d6\u5b58\u50a8\u5f15\u64ce\u53c2\u6570\n\t * @param $params\n\t *\n\t * @return false|string\n\t * @throws \\GuzzleHttp\\Exception\\GuzzleException\n\t */\n\tpublic function getStorageParams($params){\n\t\t$key = $params['key'];\n\t\t$jsonFile = $this->storagesDir.'/storage-'.$key.'.json';\n\t\tif(is_file($jsonFile)){\n\t\t\t$columns = json_decode(file_get_contents($jsonFile), true);\n\t\t\t$code = 0;\n\t\t}else{\n\t\t\t$columns = [];\n\t\t\tif(isset($this->storageTypes[$key])){\n\t\t\t\t$columns = $this->storageTypes[$key];\n\t\t\t}\n\t\t\t$code = 1;\n\t\t}\n\t\tunset($columns['name']);\n\t\t\n\t\t$returnArr = [\n\t\t\t'code' => $code,\n\t\t\t'data' => $columns,\n\t\t];\n\t\t//\u6682\u65f6\u7528false\n\t\t$authorized = false;\n\t\tif(in_array($key, ['onedrive', 'googledrive', 'dropbox', 'imgur', 'azure', 'flickr'])){\n\t\t\t$config = $this->getMergeSettings();\n\t\t\t$constructorParams = ['config' => $config, 'argv' => '', 'uploadServer' => $key];\n\t\t\t$uploader = 'uploader\\\\Upload' . ucfirst($key);\n\t\t\t/** @var UploadOnedrive $upload */\n\t\t\t$upload = new $uploader($constructorParams);\n\t\t\t$token = $upload->getAccessToken();\n\t\t\t$authUrl = '';\n\t\t\tif($token){\n\t\t\t\t$authorized = true;\n\t\t\t}else{\n\t\t\t\t$authUrl = $upload->getAuthorizationUrl();\n\t\t\t}\n\t\t\t\n\t\t\t$returnArr['oauth'] = [\n\t\t\t\t'authorized' => $authorized,\n\t\t\t\t'authUrl' => $authUrl,\n\t\t\t];\n\t\t}\n\t\treturn json_encode($returnArr);\n\t}\n\t\n\t/**\n\t * \u4fdd\u5b58\u5b58\u50a8\u5f15\u64ce\u53c2\u6570\n\t *\n\t * @param $params\n\t *\n\t * @return false|string\n\t */\n\tpublic function setStorageParams($params){\n\t\t$key = $params['key'];\n\t\tunset($_POST['key']);\n\t\tforeach($_POST as &$val){\n\t\t\t$val = trim($val);\n\t\t}\n\t\tif(in_array($key, ['github', 'gitee', 'gitlab'])){\n\t\t\t$arr = explode('/', $_POST['repo']);\n\t\t\t$_POST['repo'] = rtrim($arr[0]) . '/' . ltrim($arr[1]);\n\t\t}\n\t\t!is_dir($this->storagesDir) && mkdir($this->storagesDir, 0777);\n\t\t$jsonFile = $this->storagesDir.'/storage-'.$key.'.json';\n        $config = json_encode($_POST, JSON_UNESCAPED_SLASHES);\n        //\u5728Win\u4e2d\uff0c\u5982\u679c\u4ece\"\u6587\u4ef6\u2192\u5c5e\u6027\u2192\u5b89\u5168\u2192\u5bf9\u8c61\u540d\u79f0\"\u4e2d\u590d\u5236\u8def\u5f84\uff0c\u4f1a\u591a\u51fa\u4e00\u4e2a\u4f60\u770b\u4e0d\u89c1\u7684\u5b57\u7b26\"\\u202a\"\uff0c\u53ea\u6709\u53d8\u6210\n        //json\u540e\u624d\u770b\u7684\u89c1\u5b83\u7684unicode\uff0c\u8fd9\u6837\u4f1a\u5bfc\u81f4\u8def\u5f84\u660e\u660e\u5b58\u5728\u7a0b\u5e8f\u5374\u8bf4\u4e0d\u5b58\u5728\u7684\u60c5\u51b5\uff0c\u6240\u4ee5\u8981\u628a\u8fd9\u4e2a\u5b57\u7b26\u5728json\u4e2d\u53bb\u6389\n        $config = str_replace('\\u202a', '', $config);\n\t\tfile_put_contents($jsonFile, $config);\n\t\treturn json_encode([\n\t\t\t'code' => 0,\n\t\t\t'msg' => '\u4fdd\u5b58\u6210\u529f\uff01',\n\t\t], JSON_UNESCAPED_UNICODE);\n\t}\n\t\n\t/**\n\t * \u540e\u53f0\u83b7\u53d6\u914d\u7f6e\n\t *\n\t * @return false|string\n\t */\n\tpublic function getGeneralSettings(){\n\t\t//\u4ee5\u4e0b\u914d\u7f6e\u5355\u72ec\u5b58\u50a8\u6587\u4ef6\uff0c\u662f\u56e0\u4e3a\u4ed6\u4eec\u662f\u53ef\u9009\u7684\uff0c\u662f\u4e3a\u4e86\u9632\u6b62\u672a\u9009\u62e9\u5b83\u4eec\u65f6\u5bfc\u81f4\u4e4b\u524d\u4fdd\u5b58\u7684\u6570\u636e\u4e22\u5931\n\t\t\n\t\t//=========================== \u901a\u7528\u8bbe\u7f6e \u5f00\u59cb ===============================\n\t\t//\u901a\u7528\u8bbe\u7f6e\uff0c\u5373storageTypes,watermark,customFormat\u5916\u7684\u90e8\u5206\uff0c\n\t\t//\u56e0\u4e3astorageTypes,watermark,customFormat\u662f\u53ef\u9009\u90e8\u5206\uff0c\u6bcf\u4e2akey\u90fd\u5355\u72ec\u5b58\u4e00\u4e2a\u6587\u4ef6\n\t\t$generalSettingsFile = $this->storagesDir . '/general-settings.json';\n\t\t\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u8bbe\u7f6e\u8fc7\uff0c\u90a3\u4e48\u4f1a\u5b58\u5728\u8be5\u6587\u4ef6\n\t\tif(is_file($generalSettingsFile)){\n\t\t\t$generalSettings = json_decode(file_get_contents($generalSettingsFile), true);\n\t\t\t//\u5bf9\u6bd4\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u9879\u4e0e\u5355\u72ec\u4fdd\u5b58\u7684json\u6587\u4ef6\u4e2d\u7684\u9879\uff0c\u5982\u679c\u914d\u7f6e\u6587\u4ef6\u4e2d\u6709\u65b0\u589e\uff0c\u5219\u6dfb\u52a0\u8fdb\u53bb\n\t\t\t$storageTypeFromWebConfig = array_keys($generalSettings['storageType']);\n\t\t\t$storageTypeFromConfigFile = array_keys($this->settings['storageTypes']);\n\t\t\t$diffKeys = array_diff($storageTypeFromConfigFile, $storageTypeFromWebConfig);\n\t\t\tif(!empty($diffKeys)){\n\t\t\t\tforeach ($diffKeys as $diffKey){\n\t\t\t\t\t$tmpStorageTypes = $this->settings['storageTypes'][$diffKey];\n\t\t\t\t\t$generalSettings['storageType'][$diffKey] = [\n\t\t\t\t\t\t'name' => isset($tmpStorageTypes['name']) ? $tmpStorageTypes['name'] : $diffKey\n\t\t\t\t\t];\n\t\t\t\t}\n\t\t\t}\n\t\t}else{\n\t\t\t//\u5982\u679c\u540e\u53f0\u672a\u8bbe\u7f6e\uff0c\u5219\u4ececonfig\u76ee\u5f55\u4e0b\u7684config.php/config-local.php\u4e2d\u8bfb\u53d6\uff0c\n\t\t\t//\u5f53config-local.php\u5b58\u5728\u65f6\uff0cconfig.php\u65e0\u6548\uff0c\u5426\u5219\u624d\u4f1a\u8bfb\u53d6config.php\u4e2d\u7684\u914d\u7f6e\n\t\t\t$generalSettings = $this->settings;\n\t\t\t\n\t\t\t//\u5904\u7406\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u5b58\u50a8\u5f15\u64ce\u6570\u636e\u4e3a\u540e\u53f0\u53ef\u7528\u6570\u636e\n\t\t\t$storageType = [];\n\t\t\tforeach($this->storageTypes as $key=>$val){\n\t\t\t\t$storageType[$key] = [\n\t\t\t\t\t'isActive' => strpos(strtolower($this->settings['storageType']), $key)===false ? '0' : '1',\n\t\t\t\t\t'name' => (isset($val['name']) && $val['name']) ? $val['name'] : $key,\n\t\t\t\t];\n\t\t\t}\n\t\t\t$generalSettings['storageType'] = $storageType;\n\t\t}\n\t\t\n\t\t//=========================== \u901a\u7528\u8bbe\u7f6e \u7ed3\u675f ===============================\n\t\t\n\t\t//=========================== \u56fe\u7247\u6c34\u5370\u8bbe\u7f6e \u5f00\u59cb ===============================\n\t\t//\u56fe\u7247\u6c34\u5370\u8bbe\u7f6e\n\t\t$imageWatermarkFile = $this->storagesDir . '/image-watermark.json';\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u4fdd\u5b58\u5219\u4f7f\u7528\u540e\u53f0\u7684\n\t\tif(is_file($imageWatermarkFile)){\n\t\t\t$imageWatermark = json_decode(file_get_contents($imageWatermarkFile), true);\n\t\t}else{\n\t\t\t//\u5426\u5219\u76f4\u63a5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\uff0c\u4f46\u8981\u5904\u7406\u6c34\u5370\u56fe\u7247\u7684\u8def\u5f84\u4e3a\u540e\u53f0\u53ef\u7528\u8def\u5f84\n\t\t\t$this->settings['watermark']['image']['watermark'] = '/static/watermark/'.$this->settings['watermark']['image']['watermark'];\n\t\t\t$imageWatermark = $this->settings['watermark']['image'];\n\t\t}\n\t\t//=========================== \u56fe\u7247\u6c34\u5370\u8bbe\u7f6e \u7ed3\u675f ===============================\n\t\t\n\t\t//=========================== \u6587\u5b57\u6c34\u5370\u8bbe\u7f6e \u5f00\u59cb ===============================\n\t\t//\u6587\u5b57\u6c34\u5370\u8bbe\u7f6e\n\t\t$textWatermarkFile = $this->storagesDir . '/text-watermark.json';\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u4fdd\u5b58\u5219\u4f7f\u7528\u540e\u53f0\u7684\n\t\tif(is_file($textWatermarkFile)){\n\t\t\t$textWatermark = json_decode(file_get_contents($textWatermarkFile), true);\n\t\t}else{\n\t\t\t//\u5426\u5219\u76f4\u63a5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\uff0c\u4f46\u8981\u5904\u7406\u6c34\u5370\u5b57\u4f53\u6587\u4ef6\u8def\u5f84\u4e3a\u540e\u53f0\u53ef\u7528\u8def\u5f84\uff0c\n\t\t\t//\u4ee5\u53ca\u6c34\u5370\u6587\u4ef6\u540d\u914d\u7f6e\u6587\u4ef6\u4e2d\u662f\u4e0d\u4fdd\u5b58\u7684\uff0c\u4f46\u540e\u53f0\u53c8\u9700\u8981\uff0c\u6240\u4ee5\u9700\u8981\u5728\u8fd9\u91cc\u6dfb\u52a0\n\t\t\t$this->settings['watermark']['text']['fontFileName'] = $this->settings['watermark']['text']['fontFile'];\n\t\t\t$this->settings['watermark']['text']['fontFile'] = '/static/watermark/'.$this->settings['watermark']['text']['fontFile'];\n\t\t\t$textWatermark = $this->settings['watermark']['text'];\n\t\t}\n\t\t//=========================== \u6587\u5b57\u6c34\u5370\u8bbe\u7f6e \u5f00\u59cb ===============================\n\t\t\n\t\t//=========================== \u81ea\u5b9a\u4e49\u8fd4\u56de\u94fe\u63a5\u683c\u5f0f \u5f00\u59cb ===============================\n\t\t//\u81ea\u5b9a\u4e49\u8fd4\u56de\u94fe\u63a5\u683c\u5f0f\n\t\t$customFormatFile = $this->storagesDir . '/customFormat.json';\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u4fdd\u5b58\u5219\u4f7f\u7528\u540e\u53f0\u7684\n\t\tif(is_file($customFormatFile)){\n\t\t\t$customFormat = json_decode(file_get_contents($customFormatFile), true);\n\t\t}else{\n\t\t\t//\u540e\u53f0\u6ca1\u6709\u5219\u76f4\u63a5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684(config-local.php\u5b58\u5728\u4f1a\u4f18\u5148\u8bfb\u53d6\uff0c\u5426\u5219\u8bfb\u53d6config.php)\n\t\t\t$customFormat = $this->settings['customFormat'];\n\t\t}\n\t\t//=========================== \u81ea\u5b9a\u4e49\u8fd4\u56de\u94fe\u63a5\u683c\u5f0f \u7ed3\u675f ===============================\n\t\t\n\t\t//=========================== \u5e38\u7528\u76ee\u5f55 \u5f00\u59cb ===============================\n\t\t//\u81ea\u5b9a\u4e49\u8fd4\u56de\u94fe\u63a5\u683c\u5f0f\n\t\t$commonUsedDirFile = $this->storagesDir . '/common-used-dir.json';\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u4fdd\u5b58\u5219\u4f7f\u7528\u540e\u53f0\u7684\n\t\tif(is_file($commonUsedDirFile)){\n\t\t\t$commonUsedDir = json_decode(file_get_contents($commonUsedDirFile), true);\n\t\t}else{\n\t\t\t//\u540e\u53f0\u6ca1\u6709\u5219\u76f4\u63a5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684(config-local.php\u5b58\u5728\u4f1a\u4f18\u5148\u8bfb\u53d6\uff0c\u5426\u5219\u8bfb\u53d6config.php)\n\t\t\t$commonUsedDir = $this->settings['commonUsedDirs'];\n\t\t}\n\t\t//=========================== \u5e38\u7528\u76ee\u5f55 \u7ed3\u675f ===============================\n\t\t\n\t\t//\u628a\u4ee5\u4e0a\u914d\u7f6e\u5408\u5e76\u5230\u901a\u7528\u914d\u7f6e\u4e2d\n\t\t$generalSettings['customFormat'] = $customFormat;\n\t\t$generalSettings['videoFormat'] = isset($generalSettings['videoFormat']) ? $generalSettings['videoFormat'] : $this->settings['videoFormat'];\n\t\t$generalSettings['audioFormat'] = isset($generalSettings['audioFormat']) ? $generalSettings['audioFormat'] : $this->settings['audioFormat'];\n\t\t$generalSettings['watermark']['image'] = $imageWatermark;\n\t\t$generalSettings['watermark']['text'] = $textWatermark;\n\t\t$generalSettings['commonUsedDirs'] = $commonUsedDir;\n\t\t\n\t\treturn json_encode([\n\t\t\t'code' => 0,\n\t\t\t'data' => $generalSettings,\n\t\t], JSON_UNESCAPED_SLASHES);\n\t}\n\t\n\t/**\n\t * \u540e\u53f0\u4fdd\u5b58\u8bbe\u7f6e\n\t * @return false|string\n\t */\n\tpublic function setGeneralSettings(){\n\t\t!is_dir($this->storagesDir) && mkdir($this->storagesDir, 0777);\n\t\t$generalSettingsFile = $this->storagesDir.'/general-settings.json';\n\t\t$textWatermarkFile = $this->storagesDir.'/text-watermark.json';\n\t\t$imageWatermarkFile = $this->storagesDir.'/image-watermark.json';\n\t\t$customFormatFile = $this->storagesDir.'/customFormat.json';\n\t\t$commonUsedDirFile = $this->storagesDir . '/common-used-dir.json';\n\t\t\n\t\t$textWatermarkJson = json_encode($_POST['watermark']['text'], JSON_UNESCAPED_UNICODE);\n\t\t$imageWatermarkJson = json_encode($_POST['watermark']['image'], JSON_UNESCAPED_UNICODE);\n\t\t$customFormatJson = json_encode($_POST['customFormat'], JSON_UNESCAPED_UNICODE);\n\t\t\n\t\t$commonUsedDir = trim($_POST['commonUsedDir']);\n\t\t$commonUsedDirs = [];\n\t\tif($commonUsedDir){\n\t\t\t$commonUsedDirs = explode(\"\\n\", $commonUsedDir);\n\t\t\t//\u628a\u6bcf\u4e2a\u5143\u7d20\u53bb\u9664\u4e24\u7aef\u7a7a\u683c\uff0c\u5982\u679c\u662f\u7a7a\u503c\u5219\u5220\u9664\n\t\t\tarray_walk($commonUsedDirs, function(&$val, $key) use (&$commonUsedDirs){\n\t\t\t\t$val = trim($val);\n\t\t\t\tif($val == ''){\n\t\t\t\t\tunset($commonUsedDirs[$key]);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\t$commonUsedDirJson = json_encode(array_values($commonUsedDirs), JSON_UNESCAPED_UNICODE);\n\t\t\n\t\tunset($_POST['watermark']['text']);\n\t\tunset($_POST['watermark']['image']);\n\t\tunset($_POST['customFormat']);\n\t\tunset($_POST['commonUsedDir']);\n\t\t\n\t\t!isset($_POST['storageType']) && $_POST['storageType'] = [];\n\t\t!isset($_POST['watermark']['useWatermark']) && $_POST['watermark']['useWatermark'] = 0;\n\t\t!isset($_POST['watermark']['type']) && $_POST['watermark']['type'] = '';\n\t\tforeach($_POST as &$val){\n\t\t\tif(is_string($val)){\n\t\t\t\t$val = trim($val);\n\t\t\t}\n\t\t}\n\t\t$generalSettingsJson = json_encode($_POST, JSON_UNESCAPED_UNICODE);\n\t\t\n\t\tfile_put_contents($textWatermarkFile, $textWatermarkJson);\n\t\tfile_put_contents($imageWatermarkFile, $imageWatermarkJson);\n\t\tfile_put_contents($customFormatFile, $customFormatJson);\n\t\tfile_put_contents($generalSettingsFile, $generalSettingsJson);\n\t\tfile_put_contents($commonUsedDirFile, $commonUsedDirJson);\n\t\t\n\t\treturn json_encode([\n\t\t\t'code' => 0,\n\t\t\t'msg' => '\u4fdd\u5b58\u6210\u529f',\n\t\t], JSON_UNESCAPED_UNICODE);\n\t}\n\t\n\t/**\n\t * \u5408\u5e76\u83b7\u53d6\u540e\u53f0\u8bbe\u7f6e\u7684\u914d\u7f6e\u53ca\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u914d\u7f6e\n\t * @return mixed\n\t */\n\tpublic function getMergeSettings(){\n\t\t//================\u83b7\u53d6\u5b58\u50a8\u5f15\u64ce\u914d\u7f6e \u5f00\u59cb===============\n\t\t$storagesFiles = glob(APP_PATH.'/config/.settings/storage-*');\n\t\t$storageTypes = [];\n\t\tif(!empty($storagesFiles)){\n\t\t\t//\u540e\u53f0\u4fdd\u5b58\u7684\u5b58\u50a8\u5f15\u64ce\n\t\t\t$backendStorageKeys = [];\n\t\t\tforeach($storagesFiles as $storagesFile){\n\t\t\t\t$key = str_replace('.json', '', substr($storagesFile, strrpos($storagesFile,'-') + 1));\n\t\t\t\t$backendStorageKeys[] = $key;\n\t\t\t\t$storageTypes[$key] = json_decode(file_get_contents($storagesFile), true);\n\t\t\t}\n\t\t\t$configStorageKeys = array_keys($this->settings['storageTypes']);\n\t\t\t//\u5bf9\u6bd4\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u5b58\u50a8\u5f15\u64ce\uff0c\u5982\u679c\u5176\u4e2d\u6709\u67d0\u4e2a\u5b58\u50a8\u5f15\u64ce\u5728\u540e\u53f0\u914d\u7f6e\u4e2d\u4e0d\u5b58\u5728\uff0c\u5219\u628a\u5b83\u5408\u5e76\u5230\u540e\u53f0\u7684\u914d\u7f6e\u4e2d(\u5f53\u7136\u53ea\u662f\u5408\u5e76\u8f93\u51fa\uff0c\u5e76\u672a\u5b58\u50a8\u5230\u540e\u53f0)\n\t\t\t$storageKeys = array_diff($configStorageKeys, $backendStorageKeys);\n\t\t\tif(!empty($storageKeys)){\n\t\t\t\tforeach ($storageKeys as $storageKey){\n\t\t\t\t\t$storageTypes[$storageKey] = $this->settings['storageTypes'][$storageKey];\n\t\t\t\t}\n\t\t\t}\n\t\t}else{\n\t\t\t//\u5426\u5219\u76f4\u63a5\u4ece\u914d\u7f6e\u6587\u4ef6\u4e2d\u83b7\u53d6\uff08\u4f18\u5148\u83b7\u53d6config-local.php\uff0c\u6ca1\u6709\u5219\u83b7\u53d6local.php\uff09\n\t\t\t$storageTypes = $this->settings['storageTypes'];\n\t\t}\n\t\t//\u66ff\u6362\u5e74\u6708\u65e5\u4f4d\u7b26\u4e3a\u5f53\u524d\u5e74\u6708\u65e5\n\t\tforeach($storageTypes as $key => $storageType){\n\t\t\tif(isset($storageTypes[$key]['directory']) && $storageTypes[$key]['directory']){\n\t\t\t\t\t$storageTypes[$key]['directory'] = strtr($storageTypes[$key]['directory'], ['{Y}'=>date('Y'), '{m}'=>date('m'), '{d}'=>date('d')]);\n\t\t\t}\n\t\t}\n\t\t//================\u83b7\u53d6\u5b58\u50a8\u5f15\u64ce\u914d\u7f6e \u7ed3\u675f===============\n\t\t\n\t\t//================\u83b7\u53d6\u901a\u7528\u914d\u7f6e \u5f00\u59cb===============\n\t\t$generalSettingsFile = $this->storagesDir . '/general-settings.json';\n\t\t\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u8bbe\u7f6e\u8fc7\uff0c\u90a3\u4e48\u4f1a\u5b58\u5728\u8be5\u6587\u4ef6\n\t\tif(is_file($generalSettingsFile)){\n\t\t\t$generalSettings = json_decode(file_get_contents($generalSettingsFile), true);\n\t\t\t//\u628a\u540e\u53f0\u4fdd\u5b58\u7684\u901a\u7528\u914d\u7f6e\u5904\u7406\u4e3a\u5b9e\u9645\u53ef\u7528\u683c\u5f0f\n\t\t\t$tmpStorageType = '';\n\t\t\tforeach($generalSettings['storageType'] as $key=>$val){\n\t\t\t\tif(isset($val['isActive']) && $val['isActive']==\"1\"){\n\t\t\t\t\t$tmpStorageType .= ucfirst($key).',';\n\t\t\t\t}\n\t\t\t}\n\t\t\t$generalSettings['storageType'] = rtrim($tmpStorageType, ',');\n\t\t}else{\n\t\t\t//\u5426\u5219\u76f4\u63a5\u4f7f\u7528config-local.php\u6216config.php\u4e2d\u7684\u914d\u7f6e\n\t\t\t$generalSettings = $this->settings;\n\t\t}\n\t\t//=====================\u83b7\u53d6\u901a\u7528\u914d\u7f6e \u7ed3\u675f======================\n\t\t\n\t\t//=====================\u83b7\u53d6\u6587\u5b57\u6c34\u5370\u914d\u7f6e \u5f00\u59cb==================\n\t\t$textWatermarkFile = $this->storagesDir . '/text-watermark.json';\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u4fdd\u5b58\u5219\u4f7f\u7528\u540e\u53f0\u7684\n\t\tif(is_file($textWatermarkFile)){\n\t\t\t$textWatermark = json_decode(file_get_contents($textWatermarkFile), true);\n\t\t}else{\n\t\t\t//\u5426\u5219\u76f4\u63a5\u4f7f\u7528config-local.php\u6216config.php\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\uff0c\u4f46\u8981\u5904\u7406\u6c34\u5370\u5b57\u4f53\u6587\u4ef6\u8def\u5f84\u4e3a\u6b63\u786e\u76f8\u5bf9\u8def\u5f84\n\t\t\t$this->settings['watermark']['text']['fontFile'] = '/static/watermark/'.$this->settings['watermark']['text']['fontFile'];\n\t\t\t$textWatermark = $this->settings['watermark']['text'];\n\t\t}\n\t\t//=====================\u83b7\u53d6\u6587\u5b57\u6c34\u5370\u914d\u7f6e \u7ed3\u675f====================\n\t\t\n\t\t//=====================\u83b7\u53d6\u56fe\u7247\u6c34\u5370\u914d\u7f6e \u5f00\u59cb====================\n\t\t$imageWatermarkFile = $this->storagesDir . '/image-watermark.json';\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u4fdd\u5b58\u5219\u4f7f\u7528\u540e\u53f0\u7684\n\t\tif(is_file($imageWatermarkFile)){\n\t\t\t$imageWatermark = json_decode(file_get_contents($imageWatermarkFile), true);\n\t\t}else{\n\t\t\t//\u5426\u5219\u76f4\u63a5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\uff0c\u4f46\u8981\u5904\u7406\u6c34\u5370\u56fe\u7247\u7684\u8def\u5f84\u4e3a\u6b63\u786e\u7684\u76f8\u5bf9\u8def\u5f84\n\t\t\t$this->settings['watermark']['image']['watermark'] = '/static/watermark/'.$this->settings['watermark']['image']['watermark'];\n\t\t\t$imageWatermark = $this->settings['watermark']['image'];\n\t\t}\n\t\t//====================\u83b7\u53d6\u56fe\u7247\u6c34\u5370\u914d\u7f6e \u7ed3\u675f====================\n\t\t\n\t\t//================\u83b7\u53d6\u81ea\u5b9a\u4e49\u8fd4\u56de\u94fe\u63a5\u683c\u5f0f\u914d\u7f6e \u5f00\u59cb===============\n\t\t$customFormatFile = $this->storagesDir . '/customFormat.json';\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u4fdd\u5b58\u5219\u4f7f\u7528\u540e\u53f0\u7684\n\t\tif(is_file($customFormatFile)){\n\t\t\t$customFormat = json_decode(file_get_contents($customFormatFile), true);\n\t\t}else{\n\t\t\t//\u540e\u53f0\u6ca1\u6709\u5219\u76f4\u63a5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684(config-local.php\u5b58\u5728\u4f1a\u4f18\u5148\u8bfb\u53d6\uff0c\u5426\u5219\u8bfb\u53d6config.php)\n\t\t\t$customFormat = $this->settings['customFormat'];\n\t\t}\n\t\t//================\u83b7\u53d6\u81ea\u5b9a\u4e49\u8fd4\u56de\u94fe\u63a5\u683c\u5f0f\u914d\u7f6e \u7ed3\u675f===============\n\t\t\n\t\t//\u5408\u5e76\u914d\u7f6e\n\t\t$config = $generalSettings;\n\t\t$config['storageTypes'] = $storageTypes;\n\t\t\n\t\t$watermark = $generalSettings['watermark'];\n\t\t$watermark['text'] = $textWatermark;\n\t\t$watermark['image'] = $imageWatermark;\n\t\t$config['watermark'] = $watermark;\n\t\t\n\t\t$config['customFormat'] = $customFormat;\n\t\treturn $config;\n\t}\n\t\n\t/**\n\t * \u4e0a\u4f20\u6c34\u5370\u56fe\u7247\n\t *\n\t * @return false|string\n\t */\n\tpublic function uploadWatermarkImage(){\n\t\tif(!isset($_FILES['watermark']['tmp_name'])){\n\t\t\treturn json_encode([\n\t\t\t\t'code' => -1,\n\t\t\t\t'msg' => '\u4e0a\u4f20\u51fa\u9519',\n\t\t\t]);\n\t\t}\n\t\t$file = $_FILES['watermark'];\n\t\tif($path = $this->uploadFile($file)){\n\t\t\treturn json_encode([\n\t\t\t\t'code' => 0,\n\t\t\t\t'msg' => '\u4e0a\u4f20\u529f\u80fd',\n\t\t\t\t'path' => $path,\n\t\t\t\t'name' => $file['name'],\n\t\t\t]);\n\t\t}\n\t\treturn json_encode([\n\t\t\t'code' => -1,\n\t\t\t'msg' => '\u4e0a\u4f20\u51fa\u9519'\n\t\t]);\n\t}\n\t\n\t\n\t/**\n\t * \u4e0a\u4f20\u6587\u5b57\u6c34\u5370\u5b57\u4f53\u6587\u4ef6\n\t * @return false|string\n\t */\n\tpublic function uploadFontFile(){\n\t\tif(!isset($_FILES['font-file']['tmp_name'])){\n\t\t\treturn json_encode([\n\t\t\t\t'code' => -1,\n\t\t\t\t'msg' => 'upload faild',\n\t\t\t]);\n\t\t}\n\t\t$file = $_FILES['font-file'];\n\t\tif($path = $this->uploadFile($file)){\n\t\t\treturn json_encode([\n\t\t\t\t'code' => 0,\n\t\t\t\t'msg' => 'upload success!',\n\t\t\t\t'path' => $path,\n\t\t\t\t'name' => $file['name'],\n\t\t\t]);\n\t\t}\n\t\treturn json_encode([\n\t\t\t'code' => -1,\n\t\t\t'msg' => 'upload faild!'\n\t\t]);\n\t}\n\t\n\t/**\n\t * \u4e0a\u4f20\u6587\u4ef6\n\t * @param $file\n\t *\n\t * @return bool|string\n\t */\n\tpublic function uploadFile($file){\n\t\t$ext = mb_substr($file['name'], strrpos($file['name'], '.'));\n\t\t$newName = md5(uniqid(microtime(true))).$ext;\n\t\t$relativeDir = '/uploads/'.date('Y/m/d');\n\t\t$absDir = APP_PATH . $relativeDir;\n\t\t!is_dir($absDir) && mkdir($absDir, 0777, true);\n\t\t$path = $absDir.'/'.$newName;\n\t\tif(!move_uploaded_file($file['tmp_name'], $path)){\n\t\t\treturn false;\n\t\t}\n\t\treturn $relativeDir.'/'.$newName;\n\t}\n\t\n\t/**\n\t * \u83b7\u53d6\u6570\u636e\u5e93\u914d\u7f6e\n\t * @return array\n\t */\n\tpublic function getDatabaseConfig(){\n\t\t$database = [];\n\t\t$generalSettingsFile = $this->storagesDir.'/general-settings.json';\n\t\tif(!is_file($generalSettingsFile)){\n\t\t\tif(isset($this->settings['database'])){\n\t\t\t\t$database = $this->settings['database'];\n\t\t\t}\n\t\t}else{\n\t\t\t$generalSettings = json_decode(file_get_contents($generalSettingsFile), true);\n\t\t\tif(isset($generalSettings['database'])){\n\t\t\t\t$database = $generalSettings['database'];\n\t\t\t}\n\t\t}\n\t\t\n\t\treturn $database;\n\t}\n\t\n\t/**\n\t * \u83b7\u53d6\u5e38\u7528\u76ee\u5f55\n\t * @return false|string\n\t */\n\tpublic function getCommonUsedDir() {\n\t\t//\u81ea\u5b9a\u4e49\u8fd4\u56de\u94fe\u63a5\u683c\u5f0f\n\t\t$commonUsedDirsFile = $this->storagesDir . '/common-used-dir.json';\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u4fdd\u5b58\u5219\u4f7f\u7528\u540e\u53f0\u7684\n\t\tif(is_file($commonUsedDirsFile)){\n\t\t\t$commonUsedDirs = json_decode(file_get_contents($commonUsedDirsFile), true);\n\t\t}else{\n\t\t\t//\u540e\u53f0\u6ca1\u6709\u5219\u76f4\u63a5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684(config-local.php\u5b58\u5728\u4f1a\u4f18\u5148\u8bfb\u53d6\uff0c\u5426\u5219\u8bfb\u53d6config.php)\n\t\t\t$commonUsedDirs = $this->settings['commonUsedDirs'];\n\t\t}\n\t\t\n\t\t$curVal = '';\n\t\t$commonUsedDirsFile = $this->storagesDir . '/upload-dest-dir.json';\n\t\tif(is_file($commonUsedDirsFile)){\n\t\t\t$curVal = file_get_contents($commonUsedDirsFile);\n\t\t}\n\t\t\n\t\treturn json_encode([\n\t\t\t'code' => 0,\n\t\t\t'data' => [\n\t\t\t\t'commonUsedDirs' => $commonUsedDirs,\n\t\t\t\t'curVal' => $curVal,\n\t\t\t],\n\t\t], JSON_UNESCAPED_SLASHES);\n\t}\n\t\n\t/**\n\t * \u8bbe\u7f6e\u6240\u6709\u4e91\u670d\u52a1\u5668\u7684\u4e0a\u4f20\u76ee\u5f55\uff08smms,imgur,weibo\u7b49\u4e0d\u53ef\u8bbe\u7f6e\u7684\u9664\u5916\uff09\n\t * @return false|string\n\t */\n\tpublic function setAllStorageTypeDirectory() {\n\t\t$directory = trim($_POST['directory']);\n\t\t\n\t\t$storagesFiles = glob($this->storagesDir . '/storage-*');\n\t\t$storageTypes = [];\n\t\tif(!empty($storagesFiles)){\n\t\t\t//\u540e\u53f0\u4fdd\u5b58\u7684\u5b58\u50a8\u5f15\u64ce\n\t\t\t$backendStorageKeys = [];\n\t\t\tforeach($storagesFiles as $storagesFile){\n\t\t\t\t$key = str_replace('.json', '', substr($storagesFile, strrpos($storagesFile,'-') + 1));\n\t\t\t\t$backendStorageKeys[] = $key;\n\t\t\t\t$storageTypes[$key] = json_decode(file_get_contents($storagesFile), true);\n\t\t\t}\n\t\t\t$configStorageKeys = array_keys($this->settings['storageTypes']);\n\t\t\t//\u5bf9\u6bd4\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u5b58\u50a8\u5f15\u64ce\uff0c\u5982\u679c\u5176\u4e2d\u6709\u67d0\u4e2a\u5b58\u50a8\u5f15\u64ce\u5728\u540e\u53f0\u914d\u7f6e\u4e2d\u4e0d\u5b58\u5728\uff0c\u5219\u628a\u5b83\u5408\u5e76\u5230\u540e\u53f0\u7684\u914d\u7f6e\u4e2d(\u5f53\u7136\u53ea\u662f\u5408\u5e76\u8f93\u51fa\uff0c\u5e76\u672a\u5b58\u50a8\u5230\u540e\u53f0)\n\t\t\t$storageKeys = array_diff($configStorageKeys, $backendStorageKeys);\n\t\t\tif(!empty($storageKeys)){\n\t\t\t\tforeach ($storageKeys as $storageKey){\n\t\t\t\t\t$storageTypes[$storageKey] = $this->settings['storageTypes'][$storageKey];\n\t\t\t\t}\n\t\t\t}\n\t\t}else{\n\t\t\t//\u5426\u5219\u76f4\u63a5\u4ece\u914d\u7f6e\u6587\u4ef6\u4e2d\u83b7\u53d6\uff08\u4f18\u5148\u83b7\u53d6config-local.php\uff0c\u6ca1\u6709\u5219\u83b7\u53d6local.php\uff09\n\t\t\t$storageTypes = $this->settings['storageTypes'];\n\t\t}\n\t\t\n\t\tforeach ($storageTypes as $key => $storageType){\n\t\t\tif(in_array($key, ['smms', 'imgur', 'weibo'])){\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\t$jsonFile = $this->storagesDir . '/storage-' . $key . '.json';\n\t\t\t$storageType['directory'] = $directory;\n\t\t\tfile_put_contents($jsonFile, json_encode($storageType, JSON_UNESCAPED_SLASHES));\n\t\t}\n\t\t\n\t\tfile_put_contents($this->storagesDir . '/upload-dest-dir.json', $directory);\n\t\t\n\t\t//\u540c\u65f6\u4fee\u6539\u6240\u6709\u5b58\u50a8\u670d\u52a1\u5668\u7684\u4e0a\u4f20\u8def\u5f84\n\t\treturn json_encode([\n\t\t\t'code' => 0,\n\t\t\t'msg' => 'success',\n\t\t]);\n\t}\n\t\n\t/**\n\t *\n\t * @param $data\n\t *\n\t * @return false|string\n\t * @throws \\Exception\n\t */\n\tpublic function getAuthUrl($data){\n\t\t$config = $this->getMergeSettings();\n\t\t$key = ucfirst($data['key']);\n\t\t$constructorParams = ['config' => $config, 'argv' => '', 'uploadServer' => $key];\n\t\t$uploader = 'uploader\\\\Upload' . $key;\n\t\t/** @var UploadOnedrive $uploader */\n\t\t/** @var UploadGoogledrive $uploader */\n\t\t$authUrl = (new $uploader($constructorParams))->getAuthorizationUrl();\n\t\t!session_id() && session_start();\n\t\t$_SESSION[$key]['redirectUri'] = $data['uri'];\n\t\treturn json_encode([\n\t\t\t'code' => 0,\n\t\t\t'authUrl' => $authUrl,\n\t\t\t'msg' => 'Please redirect to authUrl to ask for authorization.',\n\t\t]);\n\t}\n}"], "fixing_code": ["<?php\n\t/**\n\t * Created by PhpStorm.\n\t * User: Bruce Xie\n\t * Date: 2019-04-13\n\t * Time: 02:37\n\t */\n\nnamespace settings;\n\nuse uploader\\UploadOnedrive;\nuse uploader\\UploadGoogledrive;\n\nclass SettingController extends Controller {\n\tpublic $settings;\n\tpublic $storageTypes;\n\tpublic $storagesDir;\n\t\n\tpublic function __construct ()\n\t{\n\t\tif(is_file(APP_PATH.'/config/.config.json')){\n\t\t\t$settings = json_decode(file_get_contents(APP_PATH.'/config/.config.json'), true);\n\t\t}else{\n\t\t\tif(is_file(APP_PATH.'/config/config-local.php')){\n\t\t\t\t$settings = require(APP_PATH.'/config/config-local.php');\n\t\t\t}else if(is_file(APP_PATH.'/config/config.php')){\n\t\t\t\t$settings = require(APP_PATH.'/config/config.php');\n\t\t\t}else{\n\t\t\t\tthrow new \\Exception('No config-local.php or config.php found in \"config/\" directory!');\n\t\t\t}\n\t\t}\n\t\t$this->settings = $settings;\n\t\t$this->storageTypes = $settings['storageTypes'];\n\t\t$this->storagesDir = APP_PATH.'/config/.settings';\n\t}\n\t\n\t/**\n\t * \u83b7\u53d6\u5b58\u50a8\u5f15\u64ce\u53c2\u6570\n\t * @param $params\n\t *\n\t * @return false|string\n\t * @throws \\GuzzleHttp\\Exception\\GuzzleException\n\t */\n\tpublic function getStorageParams($params){\n\t\t$key = $params['key'];\n\t\t$jsonFile = $this->storagesDir.'/storage-'.$key.'.json';\n\t\tif(is_file($jsonFile)){\n\t\t\t$columns = json_decode(file_get_contents($jsonFile), true);\n\t\t\t$code = 0;\n\t\t}else{\n\t\t\t$columns = [];\n\t\t\tif(isset($this->storageTypes[$key])){\n\t\t\t\t$columns = $this->storageTypes[$key];\n\t\t\t}\n\t\t\t$code = 1;\n\t\t}\n\t\tunset($columns['name']);\n\t\t\n\t\t$returnArr = [\n\t\t\t'code' => $code,\n\t\t\t'data' => $columns,\n\t\t];\n\t\t//\u6682\u65f6\u7528false\n\t\t$authorized = false;\n\t\tif(in_array($key, ['onedrive', 'googledrive', 'dropbox', 'imgur', 'azure', 'flickr'])){\n\t\t\t$config = $this->getMergeSettings();\n\t\t\t$constructorParams = ['config' => $config, 'argv' => '', 'uploadServer' => $key];\n\t\t\t$uploader = 'uploader\\\\Upload' . ucfirst($key);\n\t\t\t/** @var UploadOnedrive $upload */\n\t\t\t$upload = new $uploader($constructorParams);\n\t\t\t$token = $upload->getAccessToken();\n\t\t\t$authUrl = '';\n\t\t\tif($token){\n\t\t\t\t$authorized = true;\n\t\t\t}else{\n\t\t\t\t$authUrl = $upload->getAuthorizationUrl();\n\t\t\t}\n\t\t\t\n\t\t\t$returnArr['oauth'] = [\n\t\t\t\t'authorized' => $authorized,\n\t\t\t\t'authUrl' => $authUrl,\n\t\t\t];\n\t\t}\n\t\treturn json_encode($returnArr);\n\t}\n\t\n\t/**\n\t * \u4fdd\u5b58\u5b58\u50a8\u5f15\u64ce\u53c2\u6570\n\t *\n\t * @param $params\n\t *\n\t * @return false|string\n\t */\n\tpublic function setStorageParams($params){\n\t\t$key = $params['key'];\n\t\tunset($_POST['key']);\n\t\tforeach($_POST as &$val){\n\t\t\t$val = trim($val);\n\t\t}\n\t\tif(in_array($key, ['github', 'gitee', 'gitlab'])){\n\t\t\t$arr = explode('/', $_POST['repo']);\n\t\t\t$_POST['repo'] = rtrim($arr[0]) . '/' . ltrim($arr[1]);\n\t\t}\n\t\t!is_dir($this->storagesDir) && mkdir($this->storagesDir, 0777);\n\t\t$jsonFile = $this->storagesDir.'/storage-'.$key.'.json';\n\t\t$post = [];\n\t\tforeach($_POST as $key=>$val){\n\t\t\t$post[$key] = htmlspecialchars($val);\n\t\t}\n        $config = json_encode($post, JSON_UNESCAPED_SLASHES);\n        //\u5728Win\u4e2d\uff0c\u5982\u679c\u4ece\"\u6587\u4ef6\u2192\u5c5e\u6027\u2192\u5b89\u5168\u2192\u5bf9\u8c61\u540d\u79f0\"\u4e2d\u590d\u5236\u8def\u5f84\uff0c\u4f1a\u591a\u51fa\u4e00\u4e2a\u4f60\u770b\u4e0d\u89c1\u7684\u5b57\u7b26\"\\u202a\"\uff0c\u53ea\u6709\u53d8\u6210\n        //json\u540e\u624d\u770b\u7684\u89c1\u5b83\u7684unicode\uff0c\u8fd9\u6837\u4f1a\u5bfc\u81f4\u8def\u5f84\u660e\u660e\u5b58\u5728\u7a0b\u5e8f\u5374\u8bf4\u4e0d\u5b58\u5728\u7684\u60c5\u51b5\uff0c\u6240\u4ee5\u8981\u628a\u8fd9\u4e2a\u5b57\u7b26\u5728json\u4e2d\u53bb\u6389\n        $config = str_replace('\\u202a', '', $config);\n\t\tfile_put_contents($jsonFile, $config);\n\t\treturn json_encode([\n\t\t\t'code' => 0,\n\t\t\t'msg' => '\u4fdd\u5b58\u6210\u529f\uff01',\n\t\t], JSON_UNESCAPED_UNICODE);\n\t}\n\t\n\t/**\n\t * \u540e\u53f0\u83b7\u53d6\u914d\u7f6e\n\t *\n\t * @return false|string\n\t */\n\tpublic function getGeneralSettings(){\n\t\t//\u4ee5\u4e0b\u914d\u7f6e\u5355\u72ec\u5b58\u50a8\u6587\u4ef6\uff0c\u662f\u56e0\u4e3a\u4ed6\u4eec\u662f\u53ef\u9009\u7684\uff0c\u662f\u4e3a\u4e86\u9632\u6b62\u672a\u9009\u62e9\u5b83\u4eec\u65f6\u5bfc\u81f4\u4e4b\u524d\u4fdd\u5b58\u7684\u6570\u636e\u4e22\u5931\n\t\t\n\t\t//=========================== \u901a\u7528\u8bbe\u7f6e \u5f00\u59cb ===============================\n\t\t//\u901a\u7528\u8bbe\u7f6e\uff0c\u5373storageTypes,watermark,customFormat\u5916\u7684\u90e8\u5206\uff0c\n\t\t//\u56e0\u4e3astorageTypes,watermark,customFormat\u662f\u53ef\u9009\u90e8\u5206\uff0c\u6bcf\u4e2akey\u90fd\u5355\u72ec\u5b58\u4e00\u4e2a\u6587\u4ef6\n\t\t$generalSettingsFile = $this->storagesDir . '/general-settings.json';\n\t\t\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u8bbe\u7f6e\u8fc7\uff0c\u90a3\u4e48\u4f1a\u5b58\u5728\u8be5\u6587\u4ef6\n\t\tif(is_file($generalSettingsFile)){\n\t\t\t$generalSettings = json_decode(file_get_contents($generalSettingsFile), true);\n\t\t\t//\u5bf9\u6bd4\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u9879\u4e0e\u5355\u72ec\u4fdd\u5b58\u7684json\u6587\u4ef6\u4e2d\u7684\u9879\uff0c\u5982\u679c\u914d\u7f6e\u6587\u4ef6\u4e2d\u6709\u65b0\u589e\uff0c\u5219\u6dfb\u52a0\u8fdb\u53bb\n\t\t\t$storageTypeFromWebConfig = array_keys($generalSettings['storageType']);\n\t\t\t$storageTypeFromConfigFile = array_keys($this->settings['storageTypes']);\n\t\t\t$diffKeys = array_diff($storageTypeFromConfigFile, $storageTypeFromWebConfig);\n\t\t\tif(!empty($diffKeys)){\n\t\t\t\tforeach ($diffKeys as $diffKey){\n\t\t\t\t\t$tmpStorageTypes = $this->settings['storageTypes'][$diffKey];\n\t\t\t\t\t$generalSettings['storageType'][$diffKey] = [\n\t\t\t\t\t\t'name' => isset($tmpStorageTypes['name']) ? $tmpStorageTypes['name'] : $diffKey\n\t\t\t\t\t];\n\t\t\t\t}\n\t\t\t}\n\t\t}else{\n\t\t\t//\u5982\u679c\u540e\u53f0\u672a\u8bbe\u7f6e\uff0c\u5219\u4ececonfig\u76ee\u5f55\u4e0b\u7684config.php/config-local.php\u4e2d\u8bfb\u53d6\uff0c\n\t\t\t//\u5f53config-local.php\u5b58\u5728\u65f6\uff0cconfig.php\u65e0\u6548\uff0c\u5426\u5219\u624d\u4f1a\u8bfb\u53d6config.php\u4e2d\u7684\u914d\u7f6e\n\t\t\t$generalSettings = $this->settings;\n\t\t\t\n\t\t\t//\u5904\u7406\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u5b58\u50a8\u5f15\u64ce\u6570\u636e\u4e3a\u540e\u53f0\u53ef\u7528\u6570\u636e\n\t\t\t$storageType = [];\n\t\t\tforeach($this->storageTypes as $key=>$val){\n\t\t\t\t$storageType[$key] = [\n\t\t\t\t\t'isActive' => strpos(strtolower($this->settings['storageType']), $key)===false ? '0' : '1',\n\t\t\t\t\t'name' => (isset($val['name']) && $val['name']) ? $val['name'] : $key,\n\t\t\t\t];\n\t\t\t}\n\t\t\t$generalSettings['storageType'] = $storageType;\n\t\t}\n\t\t\n\t\t//=========================== \u901a\u7528\u8bbe\u7f6e \u7ed3\u675f ===============================\n\t\t\n\t\t//=========================== \u56fe\u7247\u6c34\u5370\u8bbe\u7f6e \u5f00\u59cb ===============================\n\t\t//\u56fe\u7247\u6c34\u5370\u8bbe\u7f6e\n\t\t$imageWatermarkFile = $this->storagesDir . '/image-watermark.json';\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u4fdd\u5b58\u5219\u4f7f\u7528\u540e\u53f0\u7684\n\t\tif(is_file($imageWatermarkFile)){\n\t\t\t$imageWatermark = json_decode(file_get_contents($imageWatermarkFile), true);\n\t\t}else{\n\t\t\t//\u5426\u5219\u76f4\u63a5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\uff0c\u4f46\u8981\u5904\u7406\u6c34\u5370\u56fe\u7247\u7684\u8def\u5f84\u4e3a\u540e\u53f0\u53ef\u7528\u8def\u5f84\n\t\t\t$this->settings['watermark']['image']['watermark'] = '/static/watermark/'.$this->settings['watermark']['image']['watermark'];\n\t\t\t$imageWatermark = $this->settings['watermark']['image'];\n\t\t}\n\t\t//=========================== \u56fe\u7247\u6c34\u5370\u8bbe\u7f6e \u7ed3\u675f ===============================\n\t\t\n\t\t//=========================== \u6587\u5b57\u6c34\u5370\u8bbe\u7f6e \u5f00\u59cb ===============================\n\t\t//\u6587\u5b57\u6c34\u5370\u8bbe\u7f6e\n\t\t$textWatermarkFile = $this->storagesDir . '/text-watermark.json';\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u4fdd\u5b58\u5219\u4f7f\u7528\u540e\u53f0\u7684\n\t\tif(is_file($textWatermarkFile)){\n\t\t\t$textWatermark = json_decode(file_get_contents($textWatermarkFile), true);\n\t\t}else{\n\t\t\t//\u5426\u5219\u76f4\u63a5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\uff0c\u4f46\u8981\u5904\u7406\u6c34\u5370\u5b57\u4f53\u6587\u4ef6\u8def\u5f84\u4e3a\u540e\u53f0\u53ef\u7528\u8def\u5f84\uff0c\n\t\t\t//\u4ee5\u53ca\u6c34\u5370\u6587\u4ef6\u540d\u914d\u7f6e\u6587\u4ef6\u4e2d\u662f\u4e0d\u4fdd\u5b58\u7684\uff0c\u4f46\u540e\u53f0\u53c8\u9700\u8981\uff0c\u6240\u4ee5\u9700\u8981\u5728\u8fd9\u91cc\u6dfb\u52a0\n\t\t\t$this->settings['watermark']['text']['fontFileName'] = $this->settings['watermark']['text']['fontFile'];\n\t\t\t$this->settings['watermark']['text']['fontFile'] = '/static/watermark/'.$this->settings['watermark']['text']['fontFile'];\n\t\t\t$textWatermark = $this->settings['watermark']['text'];\n\t\t}\n\t\t//=========================== \u6587\u5b57\u6c34\u5370\u8bbe\u7f6e \u5f00\u59cb ===============================\n\t\t\n\t\t//=========================== \u81ea\u5b9a\u4e49\u8fd4\u56de\u94fe\u63a5\u683c\u5f0f \u5f00\u59cb ===============================\n\t\t//\u81ea\u5b9a\u4e49\u8fd4\u56de\u94fe\u63a5\u683c\u5f0f\n\t\t$customFormatFile = $this->storagesDir . '/customFormat.json';\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u4fdd\u5b58\u5219\u4f7f\u7528\u540e\u53f0\u7684\n\t\tif(is_file($customFormatFile)){\n\t\t\t$customFormat = json_decode(file_get_contents($customFormatFile), true);\n\t\t}else{\n\t\t\t//\u540e\u53f0\u6ca1\u6709\u5219\u76f4\u63a5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684(config-local.php\u5b58\u5728\u4f1a\u4f18\u5148\u8bfb\u53d6\uff0c\u5426\u5219\u8bfb\u53d6config.php)\n\t\t\t$customFormat = $this->settings['customFormat'];\n\t\t}\n\t\t//=========================== \u81ea\u5b9a\u4e49\u8fd4\u56de\u94fe\u63a5\u683c\u5f0f \u7ed3\u675f ===============================\n\t\t\n\t\t//=========================== \u5e38\u7528\u76ee\u5f55 \u5f00\u59cb ===============================\n\t\t//\u81ea\u5b9a\u4e49\u8fd4\u56de\u94fe\u63a5\u683c\u5f0f\n\t\t$commonUsedDirFile = $this->storagesDir . '/common-used-dir.json';\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u4fdd\u5b58\u5219\u4f7f\u7528\u540e\u53f0\u7684\n\t\tif(is_file($commonUsedDirFile)){\n\t\t\t$commonUsedDir = json_decode(file_get_contents($commonUsedDirFile), true);\n\t\t}else{\n\t\t\t//\u540e\u53f0\u6ca1\u6709\u5219\u76f4\u63a5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684(config-local.php\u5b58\u5728\u4f1a\u4f18\u5148\u8bfb\u53d6\uff0c\u5426\u5219\u8bfb\u53d6config.php)\n\t\t\t$commonUsedDir = $this->settings['commonUsedDirs'];\n\t\t}\n\t\t//=========================== \u5e38\u7528\u76ee\u5f55 \u7ed3\u675f ===============================\n\t\t\n\t\t//\u628a\u4ee5\u4e0a\u914d\u7f6e\u5408\u5e76\u5230\u901a\u7528\u914d\u7f6e\u4e2d\n\t\t$generalSettings['customFormat'] = $customFormat;\n\t\t$generalSettings['videoFormat'] = isset($generalSettings['videoFormat']) ? $generalSettings['videoFormat'] : $this->settings['videoFormat'];\n\t\t$generalSettings['audioFormat'] = isset($generalSettings['audioFormat']) ? $generalSettings['audioFormat'] : $this->settings['audioFormat'];\n\t\t$generalSettings['watermark']['image'] = $imageWatermark;\n\t\t$generalSettings['watermark']['text'] = $textWatermark;\n\t\t$generalSettings['commonUsedDirs'] = $commonUsedDir;\n\t\t\n\t\treturn json_encode([\n\t\t\t'code' => 0,\n\t\t\t'data' => $generalSettings,\n\t\t], JSON_UNESCAPED_SLASHES);\n\t}\n\t\n\t/**\n\t * \u540e\u53f0\u4fdd\u5b58\u8bbe\u7f6e\n\t * @return false|string\n\t */\n\tpublic function setGeneralSettings(){\n\t\t!is_dir($this->storagesDir) && mkdir($this->storagesDir, 0777);\n\t\t$generalSettingsFile = $this->storagesDir.'/general-settings.json';\n\t\t$textWatermarkFile = $this->storagesDir.'/text-watermark.json';\n\t\t$imageWatermarkFile = $this->storagesDir.'/image-watermark.json';\n\t\t$customFormatFile = $this->storagesDir.'/customFormat.json';\n\t\t$commonUsedDirFile = $this->storagesDir . '/common-used-dir.json';\n\t\t\n\t\t$textWatermarkJson = json_encode($_POST['watermark']['text'], JSON_UNESCAPED_UNICODE);\n\t\t$imageWatermarkJson = json_encode($_POST['watermark']['image'], JSON_UNESCAPED_UNICODE);\n\t\t$customFormatJson = json_encode($_POST['customFormat'], JSON_UNESCAPED_UNICODE);\n\t\t\n\t\t$commonUsedDir = trim($_POST['commonUsedDir']);\n\t\t$commonUsedDirs = [];\n\t\tif($commonUsedDir){\n\t\t\t$commonUsedDirs = explode(\"\\n\", $commonUsedDir);\n\t\t\t//\u628a\u6bcf\u4e2a\u5143\u7d20\u53bb\u9664\u4e24\u7aef\u7a7a\u683c\uff0c\u5982\u679c\u662f\u7a7a\u503c\u5219\u5220\u9664\n\t\t\tarray_walk($commonUsedDirs, function(&$val, $key) use (&$commonUsedDirs){\n\t\t\t\t$val = trim($val);\n\t\t\t\tif($val == ''){\n\t\t\t\t\tunset($commonUsedDirs[$key]);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\t$commonUsedDirJson = json_encode(array_values($commonUsedDirs), JSON_UNESCAPED_UNICODE);\n\t\t\n\t\tunset($_POST['watermark']['text']);\n\t\tunset($_POST['watermark']['image']);\n\t\tunset($_POST['customFormat']);\n\t\tunset($_POST['commonUsedDir']);\n\t\t\n\t\t!isset($_POST['storageType']) && $_POST['storageType'] = [];\n\t\t!isset($_POST['watermark']['useWatermark']) && $_POST['watermark']['useWatermark'] = 0;\n\t\t!isset($_POST['watermark']['type']) && $_POST['watermark']['type'] = '';\n\t\tforeach($_POST as &$val){\n\t\t\tif(is_string($val)){\n\t\t\t\t$val = trim($val);\n\t\t\t}\n\t\t}\n\t\t$generalSettingsJson = json_encode($_POST, JSON_UNESCAPED_UNICODE);\n\t\t\n\t\tfile_put_contents($textWatermarkFile, $textWatermarkJson);\n\t\tfile_put_contents($imageWatermarkFile, $imageWatermarkJson);\n\t\tfile_put_contents($customFormatFile, $customFormatJson);\n\t\tfile_put_contents($generalSettingsFile, $generalSettingsJson);\n\t\tfile_put_contents($commonUsedDirFile, $commonUsedDirJson);\n\t\t\n\t\treturn json_encode([\n\t\t\t'code' => 0,\n\t\t\t'msg' => '\u4fdd\u5b58\u6210\u529f',\n\t\t], JSON_UNESCAPED_UNICODE);\n\t}\n\t\n\t/**\n\t * \u5408\u5e76\u83b7\u53d6\u540e\u53f0\u8bbe\u7f6e\u7684\u914d\u7f6e\u53ca\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u914d\u7f6e\n\t * @return mixed\n\t */\n\tpublic function getMergeSettings(){\n\t\t//================\u83b7\u53d6\u5b58\u50a8\u5f15\u64ce\u914d\u7f6e \u5f00\u59cb===============\n\t\t$storagesFiles = glob(APP_PATH.'/config/.settings/storage-*');\n\t\t$storageTypes = [];\n\t\tif(!empty($storagesFiles)){\n\t\t\t//\u540e\u53f0\u4fdd\u5b58\u7684\u5b58\u50a8\u5f15\u64ce\n\t\t\t$backendStorageKeys = [];\n\t\t\tforeach($storagesFiles as $storagesFile){\n\t\t\t\t$key = str_replace('.json', '', substr($storagesFile, strrpos($storagesFile,'-') + 1));\n\t\t\t\t$backendStorageKeys[] = $key;\n\t\t\t\t$storageTypes[$key] = json_decode(file_get_contents($storagesFile), true);\n\t\t\t}\n\t\t\t$configStorageKeys = array_keys($this->settings['storageTypes']);\n\t\t\t//\u5bf9\u6bd4\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u5b58\u50a8\u5f15\u64ce\uff0c\u5982\u679c\u5176\u4e2d\u6709\u67d0\u4e2a\u5b58\u50a8\u5f15\u64ce\u5728\u540e\u53f0\u914d\u7f6e\u4e2d\u4e0d\u5b58\u5728\uff0c\u5219\u628a\u5b83\u5408\u5e76\u5230\u540e\u53f0\u7684\u914d\u7f6e\u4e2d(\u5f53\u7136\u53ea\u662f\u5408\u5e76\u8f93\u51fa\uff0c\u5e76\u672a\u5b58\u50a8\u5230\u540e\u53f0)\n\t\t\t$storageKeys = array_diff($configStorageKeys, $backendStorageKeys);\n\t\t\tif(!empty($storageKeys)){\n\t\t\t\tforeach ($storageKeys as $storageKey){\n\t\t\t\t\t$storageTypes[$storageKey] = $this->settings['storageTypes'][$storageKey];\n\t\t\t\t}\n\t\t\t}\n\t\t}else{\n\t\t\t//\u5426\u5219\u76f4\u63a5\u4ece\u914d\u7f6e\u6587\u4ef6\u4e2d\u83b7\u53d6\uff08\u4f18\u5148\u83b7\u53d6config-local.php\uff0c\u6ca1\u6709\u5219\u83b7\u53d6local.php\uff09\n\t\t\t$storageTypes = $this->settings['storageTypes'];\n\t\t}\n\t\t//\u66ff\u6362\u5e74\u6708\u65e5\u4f4d\u7b26\u4e3a\u5f53\u524d\u5e74\u6708\u65e5\n\t\tforeach($storageTypes as $key => $storageType){\n\t\t\tif(isset($storageTypes[$key]['directory']) && $storageTypes[$key]['directory']){\n\t\t\t\t\t$storageTypes[$key]['directory'] = strtr($storageTypes[$key]['directory'], ['{Y}'=>date('Y'), '{m}'=>date('m'), '{d}'=>date('d')]);\n\t\t\t}\n\t\t}\n\t\t//================\u83b7\u53d6\u5b58\u50a8\u5f15\u64ce\u914d\u7f6e \u7ed3\u675f===============\n\t\t\n\t\t//================\u83b7\u53d6\u901a\u7528\u914d\u7f6e \u5f00\u59cb===============\n\t\t$generalSettingsFile = $this->storagesDir . '/general-settings.json';\n\t\t\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u8bbe\u7f6e\u8fc7\uff0c\u90a3\u4e48\u4f1a\u5b58\u5728\u8be5\u6587\u4ef6\n\t\tif(is_file($generalSettingsFile)){\n\t\t\t$generalSettings = json_decode(file_get_contents($generalSettingsFile), true);\n\t\t\t//\u628a\u540e\u53f0\u4fdd\u5b58\u7684\u901a\u7528\u914d\u7f6e\u5904\u7406\u4e3a\u5b9e\u9645\u53ef\u7528\u683c\u5f0f\n\t\t\t$tmpStorageType = '';\n\t\t\tforeach($generalSettings['storageType'] as $key=>$val){\n\t\t\t\tif(isset($val['isActive']) && $val['isActive']==\"1\"){\n\t\t\t\t\t$tmpStorageType .= ucfirst($key).',';\n\t\t\t\t}\n\t\t\t}\n\t\t\t$generalSettings['storageType'] = rtrim($tmpStorageType, ',');\n\t\t}else{\n\t\t\t//\u5426\u5219\u76f4\u63a5\u4f7f\u7528config-local.php\u6216config.php\u4e2d\u7684\u914d\u7f6e\n\t\t\t$generalSettings = $this->settings;\n\t\t}\n\t\t//=====================\u83b7\u53d6\u901a\u7528\u914d\u7f6e \u7ed3\u675f======================\n\t\t\n\t\t//=====================\u83b7\u53d6\u6587\u5b57\u6c34\u5370\u914d\u7f6e \u5f00\u59cb==================\n\t\t$textWatermarkFile = $this->storagesDir . '/text-watermark.json';\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u4fdd\u5b58\u5219\u4f7f\u7528\u540e\u53f0\u7684\n\t\tif(is_file($textWatermarkFile)){\n\t\t\t$textWatermark = json_decode(file_get_contents($textWatermarkFile), true);\n\t\t}else{\n\t\t\t//\u5426\u5219\u76f4\u63a5\u4f7f\u7528config-local.php\u6216config.php\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\uff0c\u4f46\u8981\u5904\u7406\u6c34\u5370\u5b57\u4f53\u6587\u4ef6\u8def\u5f84\u4e3a\u6b63\u786e\u76f8\u5bf9\u8def\u5f84\n\t\t\t$this->settings['watermark']['text']['fontFile'] = '/static/watermark/'.$this->settings['watermark']['text']['fontFile'];\n\t\t\t$textWatermark = $this->settings['watermark']['text'];\n\t\t}\n\t\t//=====================\u83b7\u53d6\u6587\u5b57\u6c34\u5370\u914d\u7f6e \u7ed3\u675f====================\n\t\t\n\t\t//=====================\u83b7\u53d6\u56fe\u7247\u6c34\u5370\u914d\u7f6e \u5f00\u59cb====================\n\t\t$imageWatermarkFile = $this->storagesDir . '/image-watermark.json';\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u4fdd\u5b58\u5219\u4f7f\u7528\u540e\u53f0\u7684\n\t\tif(is_file($imageWatermarkFile)){\n\t\t\t$imageWatermark = json_decode(file_get_contents($imageWatermarkFile), true);\n\t\t}else{\n\t\t\t//\u5426\u5219\u76f4\u63a5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\uff0c\u4f46\u8981\u5904\u7406\u6c34\u5370\u56fe\u7247\u7684\u8def\u5f84\u4e3a\u6b63\u786e\u7684\u76f8\u5bf9\u8def\u5f84\n\t\t\t$this->settings['watermark']['image']['watermark'] = '/static/watermark/'.$this->settings['watermark']['image']['watermark'];\n\t\t\t$imageWatermark = $this->settings['watermark']['image'];\n\t\t}\n\t\t//====================\u83b7\u53d6\u56fe\u7247\u6c34\u5370\u914d\u7f6e \u7ed3\u675f====================\n\t\t\n\t\t//================\u83b7\u53d6\u81ea\u5b9a\u4e49\u8fd4\u56de\u94fe\u63a5\u683c\u5f0f\u914d\u7f6e \u5f00\u59cb===============\n\t\t$customFormatFile = $this->storagesDir . '/customFormat.json';\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u4fdd\u5b58\u5219\u4f7f\u7528\u540e\u53f0\u7684\n\t\tif(is_file($customFormatFile)){\n\t\t\t$customFormat = json_decode(file_get_contents($customFormatFile), true);\n\t\t}else{\n\t\t\t//\u540e\u53f0\u6ca1\u6709\u5219\u76f4\u63a5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684(config-local.php\u5b58\u5728\u4f1a\u4f18\u5148\u8bfb\u53d6\uff0c\u5426\u5219\u8bfb\u53d6config.php)\n\t\t\t$customFormat = $this->settings['customFormat'];\n\t\t}\n\t\t//================\u83b7\u53d6\u81ea\u5b9a\u4e49\u8fd4\u56de\u94fe\u63a5\u683c\u5f0f\u914d\u7f6e \u7ed3\u675f===============\n\t\t\n\t\t//\u5408\u5e76\u914d\u7f6e\n\t\t$config = $generalSettings;\n\t\t$config['storageTypes'] = $storageTypes;\n\t\t\n\t\t$watermark = $generalSettings['watermark'];\n\t\t$watermark['text'] = $textWatermark;\n\t\t$watermark['image'] = $imageWatermark;\n\t\t$config['watermark'] = $watermark;\n\t\t\n\t\t$config['customFormat'] = $customFormat;\n\t\treturn $config;\n\t}\n\t\n\t/**\n\t * \u4e0a\u4f20\u6c34\u5370\u56fe\u7247\n\t *\n\t * @return false|string\n\t */\n\tpublic function uploadWatermarkImage(){\n\t\tif(!isset($_FILES['watermark']['tmp_name'])){\n\t\t\treturn json_encode([\n\t\t\t\t'code' => -1,\n\t\t\t\t'msg' => '\u4e0a\u4f20\u51fa\u9519',\n\t\t\t]);\n\t\t}\n\t\t$file = $_FILES['watermark'];\n\t\tif($path = $this->uploadFile($file)){\n\t\t\treturn json_encode([\n\t\t\t\t'code' => 0,\n\t\t\t\t'msg' => '\u4e0a\u4f20\u529f\u80fd',\n\t\t\t\t'path' => $path,\n\t\t\t\t'name' => $file['name'],\n\t\t\t]);\n\t\t}\n\t\treturn json_encode([\n\t\t\t'code' => -1,\n\t\t\t'msg' => '\u4e0a\u4f20\u51fa\u9519'\n\t\t]);\n\t}\n\t\n\t\n\t/**\n\t * \u4e0a\u4f20\u6587\u5b57\u6c34\u5370\u5b57\u4f53\u6587\u4ef6\n\t * @return false|string\n\t */\n\tpublic function uploadFontFile(){\n\t\tif(!isset($_FILES['font-file']['tmp_name'])){\n\t\t\treturn json_encode([\n\t\t\t\t'code' => -1,\n\t\t\t\t'msg' => 'upload faild',\n\t\t\t]);\n\t\t}\n\t\t$file = $_FILES['font-file'];\n\t\tif($path = $this->uploadFile($file)){\n\t\t\treturn json_encode([\n\t\t\t\t'code' => 0,\n\t\t\t\t'msg' => 'upload success!',\n\t\t\t\t'path' => $path,\n\t\t\t\t'name' => $file['name'],\n\t\t\t]);\n\t\t}\n\t\treturn json_encode([\n\t\t\t'code' => -1,\n\t\t\t'msg' => 'upload faild!'\n\t\t]);\n\t}\n\t\n\t/**\n\t * \u4e0a\u4f20\u6587\u4ef6\n\t * @param $file\n\t *\n\t * @return bool|string\n\t */\n\tpublic function uploadFile($file){\n\t\t$ext = mb_substr($file['name'], strrpos($file['name'], '.'));\n\t\t$newName = md5(uniqid(microtime(true))).$ext;\n\t\t$relativeDir = '/uploads/'.date('Y/m/d');\n\t\t$absDir = APP_PATH . $relativeDir;\n\t\t!is_dir($absDir) && mkdir($absDir, 0777, true);\n\t\t$path = $absDir.'/'.$newName;\n\t\tif(!move_uploaded_file($file['tmp_name'], $path)){\n\t\t\treturn false;\n\t\t}\n\t\treturn $relativeDir.'/'.$newName;\n\t}\n\t\n\t/**\n\t * \u83b7\u53d6\u6570\u636e\u5e93\u914d\u7f6e\n\t * @return array\n\t */\n\tpublic function getDatabaseConfig(){\n\t\t$database = [];\n\t\t$generalSettingsFile = $this->storagesDir.'/general-settings.json';\n\t\tif(!is_file($generalSettingsFile)){\n\t\t\tif(isset($this->settings['database'])){\n\t\t\t\t$database = $this->settings['database'];\n\t\t\t}\n\t\t}else{\n\t\t\t$generalSettings = json_decode(file_get_contents($generalSettingsFile), true);\n\t\t\tif(isset($generalSettings['database'])){\n\t\t\t\t$database = $generalSettings['database'];\n\t\t\t}\n\t\t}\n\t\t\n\t\treturn $database;\n\t}\n\t\n\t/**\n\t * \u83b7\u53d6\u5e38\u7528\u76ee\u5f55\n\t * @return false|string\n\t */\n\tpublic function getCommonUsedDir() {\n\t\t//\u81ea\u5b9a\u4e49\u8fd4\u56de\u94fe\u63a5\u683c\u5f0f\n\t\t$commonUsedDirsFile = $this->storagesDir . '/common-used-dir.json';\n\t\t//\u5982\u679c\u540e\u53f0\u6709\u4fdd\u5b58\u5219\u4f7f\u7528\u540e\u53f0\u7684\n\t\tif(is_file($commonUsedDirsFile)){\n\t\t\t$commonUsedDirs = json_decode(file_get_contents($commonUsedDirsFile), true);\n\t\t}else{\n\t\t\t//\u540e\u53f0\u6ca1\u6709\u5219\u76f4\u63a5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684(config-local.php\u5b58\u5728\u4f1a\u4f18\u5148\u8bfb\u53d6\uff0c\u5426\u5219\u8bfb\u53d6config.php)\n\t\t\t$commonUsedDirs = $this->settings['commonUsedDirs'];\n\t\t}\n\t\t\n\t\t$curVal = '';\n\t\t$commonUsedDirsFile = $this->storagesDir . '/upload-dest-dir.json';\n\t\tif(is_file($commonUsedDirsFile)){\n\t\t\t$curVal = file_get_contents($commonUsedDirsFile);\n\t\t}\n\t\t\n\t\treturn json_encode([\n\t\t\t'code' => 0,\n\t\t\t'data' => [\n\t\t\t\t'commonUsedDirs' => $commonUsedDirs,\n\t\t\t\t'curVal' => $curVal,\n\t\t\t],\n\t\t], JSON_UNESCAPED_SLASHES);\n\t}\n\t\n\t/**\n\t * \u8bbe\u7f6e\u6240\u6709\u4e91\u670d\u52a1\u5668\u7684\u4e0a\u4f20\u76ee\u5f55\uff08smms,imgur,weibo\u7b49\u4e0d\u53ef\u8bbe\u7f6e\u7684\u9664\u5916\uff09\n\t * @return false|string\n\t */\n\tpublic function setAllStorageTypeDirectory() {\n\t\t$directory = trim($_POST['directory']);\n\t\t\n\t\t$storagesFiles = glob($this->storagesDir . '/storage-*');\n\t\t$storageTypes = [];\n\t\tif(!empty($storagesFiles)){\n\t\t\t//\u540e\u53f0\u4fdd\u5b58\u7684\u5b58\u50a8\u5f15\u64ce\n\t\t\t$backendStorageKeys = [];\n\t\t\tforeach($storagesFiles as $storagesFile){\n\t\t\t\t$key = str_replace('.json', '', substr($storagesFile, strrpos($storagesFile,'-') + 1));\n\t\t\t\t$backendStorageKeys[] = $key;\n\t\t\t\t$storageTypes[$key] = json_decode(file_get_contents($storagesFile), true);\n\t\t\t}\n\t\t\t$configStorageKeys = array_keys($this->settings['storageTypes']);\n\t\t\t//\u5bf9\u6bd4\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u5b58\u50a8\u5f15\u64ce\uff0c\u5982\u679c\u5176\u4e2d\u6709\u67d0\u4e2a\u5b58\u50a8\u5f15\u64ce\u5728\u540e\u53f0\u914d\u7f6e\u4e2d\u4e0d\u5b58\u5728\uff0c\u5219\u628a\u5b83\u5408\u5e76\u5230\u540e\u53f0\u7684\u914d\u7f6e\u4e2d(\u5f53\u7136\u53ea\u662f\u5408\u5e76\u8f93\u51fa\uff0c\u5e76\u672a\u5b58\u50a8\u5230\u540e\u53f0)\n\t\t\t$storageKeys = array_diff($configStorageKeys, $backendStorageKeys);\n\t\t\tif(!empty($storageKeys)){\n\t\t\t\tforeach ($storageKeys as $storageKey){\n\t\t\t\t\t$storageTypes[$storageKey] = $this->settings['storageTypes'][$storageKey];\n\t\t\t\t}\n\t\t\t}\n\t\t}else{\n\t\t\t//\u5426\u5219\u76f4\u63a5\u4ece\u914d\u7f6e\u6587\u4ef6\u4e2d\u83b7\u53d6\uff08\u4f18\u5148\u83b7\u53d6config-local.php\uff0c\u6ca1\u6709\u5219\u83b7\u53d6local.php\uff09\n\t\t\t$storageTypes = $this->settings['storageTypes'];\n\t\t}\n\t\t\n\t\tforeach ($storageTypes as $key => $storageType){\n\t\t\tif(in_array($key, ['smms', 'imgur', 'weibo'])){\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\t$jsonFile = $this->storagesDir . '/storage-' . $key . '.json';\n\t\t\t$storageType['directory'] = $directory;\n\t\t\tfile_put_contents($jsonFile, json_encode($storageType, JSON_UNESCAPED_SLASHES));\n\t\t}\n\t\t\n\t\tfile_put_contents($this->storagesDir . '/upload-dest-dir.json', $directory);\n\t\t\n\t\t//\u540c\u65f6\u4fee\u6539\u6240\u6709\u5b58\u50a8\u670d\u52a1\u5668\u7684\u4e0a\u4f20\u8def\u5f84\n\t\treturn json_encode([\n\t\t\t'code' => 0,\n\t\t\t'msg' => 'success',\n\t\t]);\n\t}\n\t\n\t/**\n\t *\n\t * @param $data\n\t *\n\t * @return false|string\n\t * @throws \\Exception\n\t */\n\tpublic function getAuthUrl($data){\n\t\t$config = $this->getMergeSettings();\n\t\t$key = ucfirst($data['key']);\n\t\t$constructorParams = ['config' => $config, 'argv' => '', 'uploadServer' => $key];\n\t\t$uploader = 'uploader\\\\Upload' . $key;\n\t\t/** @var UploadOnedrive $uploader */\n\t\t/** @var UploadGoogledrive $uploader */\n\t\t$authUrl = (new $uploader($constructorParams))->getAuthorizationUrl();\n\t\t!session_id() && session_start();\n\t\t$_SESSION[$key]['redirectUri'] = $data['uri'];\n\t\treturn json_encode([\n\t\t\t'code' => 0,\n\t\t\t'authUrl' => $authUrl,\n\t\t\t'msg' => 'Please redirect to authUrl to ask for authorization.',\n\t\t]);\n\t}\n}"], "filenames": ["settings/SettingController.php"], "buggy_code_start_loc": [106], "buggy_code_end_loc": [107], "fixing_code_start_loc": [106], "fixing_code_end_loc": [111], "type": "CWE-79", "message": "PicUploader v2.6.3 was discovered to contain cross-site scripting (XSS) vulnerability via the setStorageParams function in SettingController.php.", "other": {"cve": {"id": "CVE-2022-41442", "sourceIdentifier": "cve@mitre.org", "published": "2022-10-07T22:15:18.167", "lastModified": "2022-10-11T17:10:46.820", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "PicUploader v2.6.3 was discovered to contain cross-site scripting (XSS) vulnerability via the setStorageParams function in SettingController.php."}, {"lang": "es", "value": "Se ha detectado que PicUploader versi\u00f3n v2.6.3, contiene una vulnerabilidad de tipo cross-site scripting (XSS) por medio de la funci\u00f3n setStorageParams en el archivo SettingController.php"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:picuploader_project:picuploader:2.6.3:*:*:*:*:*:*:*", "matchCriteriaId": "9FBB4CBD-45D3-4117-8510-4048A5E321B7"}]}]}], "references": [{"url": "https://github.com/xiebruce/PicUploader/commit/2b0411bddb7942e0ace136a82d4ccde0fe66f263", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/xiebruce/PicUploader/issues/80", "source": "cve@mitre.org", "tags": ["Exploit", "Issue Tracking", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/xiebruce/PicUploader/commit/2b0411bddb7942e0ace136a82d4ccde0fe66f263"}}