{"buggy_code": ["<?php\n\n// Init\n//error_reporting(NULL);\n\n\ninclude($_SERVER['DOCUMENT_ROOT'].\"/inc/main.php\");\ninclude($_SERVER['DOCUMENT_ROOT'].\"/file_manager/fm_core.php\");\n\n\n// todo: set in session?\nif (empty($panel)) {\n    $command = VESTA_CMD.\"v-list-user '\".$user.\"' 'json'\";\n    exec ($command, $output, $return_var);\n    if ( $return_var > 0 ) {\n        header(\"Location: /error/\");\n        exit;\n    }\n    $panel = json_decode(implode('', $output), true);\n}\n\n$fm = new FileManager($user);\n$fm->setRootDir($panel[$user]['HOME']);\n\n$_REQUEST['action'] = empty($_REQUEST['action']) ? '' : $_REQUEST['action'];\n\nswitch ($_REQUEST['action']) {\n    case 'cd':\n        $dir = $_REQUEST['dir'];\n        print json_encode($fm->ls($dir));\n        break;\n\n    case 'check_file_type':\n        $dir = $_REQUEST['dir'];\n        print json_encode($fm->checkFileType($dir));\n        break;\n\n    case 'rename_file':\n        $dir = $_REQUEST['dir'];\n        $item = $dir . '/' . $_REQUEST['item'];\n        $target_name = $dir . '/' . $_REQUEST['target_name'];\n        print json_encode($fm->renameFile($item, $target_name));\n        break;\n\n    case 'rename_directory':\n        $dir = $_REQUEST['dir'];\n        $item = $dir.$_REQUEST['item'];\n        $target_name = $dir.$_REQUEST['target_name'];\n\n        print json_encode($fm->renameDirectory($item, $target_name));\n        break;\n\n    case 'move_file':\n        $item = $_REQUEST['item'];\n        $target_name = $_REQUEST['target_name'];\n        print json_encode($fm->renameFile($item, $target_name));\n        break;\n\n    case 'move_directory':\n        $item = $_REQUEST['item'];\n        $target_name = $_REQUEST['target_name'];\n        print json_encode($fm->renameDirectory($item, $target_name));\n        break;\n\n    case 'delete_files':\n        $dir = $_REQUEST['dir'];\n        $item = $_REQUEST['item'];\n        print json_encode($fm->deleteItem($dir, $item));\n        break;\n\n    case 'create_file':\n        $dir = $_REQUEST['dir'];\n        $filename = $_REQUEST['filename'];\n        print json_encode($fm->createFile($dir, $filename));\n        break;\n\n    case 'create_dir':\n        $dir = $_REQUEST['dir'];\n        $dirname = $_REQUEST['dirname'];\n        print json_encode($fm->createDir($dir, $dirname));\n        break;\n\n    case 'open_file':\n        $dir = $_REQUEST['dir'];\n        print json_encode($fm->open_file($dir));\n        break;\n\n    case 'copy_file':\n        $dir = $_REQUEST['dir'];\n        $target_dir = $_REQUEST['dir_target'];\n        $filename   = $_REQUEST['filename'];\n        $item       = $_REQUEST['item'];\n        print json_encode($fm->copyFile($item, $dir, $target_dir, $filename));\n        break;\n\n    case 'copy_directory':\n        $dir = $_REQUEST['dir'];\n        $target_dir = $_REQUEST['dir_target'];\n        $filename   = $_REQUEST['filename'];\n        $item       = $_REQUEST['item'];\n        print json_encode($fm->copyDirectory($item, $dir, $target_dir, $filename));\n        break;\n\n    case 'unpack_item':\n        $dir = $_REQUEST['dir'];\n        $target_dir = $_REQUEST['dir_target'];\n        $filename   = $_REQUEST['filename'];\n        $item       = $_REQUEST['item'];\n        print json_encode($fm->unpackItem($item, $dir, $target_dir, $filename));\n        break;\n\n    case 'pack_item':\n        $items      = $_REQUEST['items'];\n        $dst_item   = $_REQUEST['dst_item'];\n        print json_encode($fm->packItem($items, $dst_item));\n        break;\n\n    case 'backup':\n        $path = $_REQUEST['path'];\n        print json_encode($fm->backupItem($path));\n        break;\n\n    case 'chmod_item':\n        $dir = $_REQUEST['dir'];\n        $item = $_REQUEST['item'];\n        $permissions = $_REQUEST['permissions'];\n        print json_encode($fm->chmodItem($dir, $item, $permissions));\n        break;\n\n    default:\n        //print json_encode($fm->init());\n        break;\n}\n"], "fixing_code": ["<?php\n// Init\n//error_reporting(NULL);\n\nheader('Content-Type: application/json');\n\ninclude($_SERVER['DOCUMENT_ROOT'].\"/inc/main.php\");\ninclude($_SERVER['DOCUMENT_ROOT'].\"/file_manager/fm_core.php\");\n\n\n// todo: set in session?\nif (empty($panel)) {\n    $command = VESTA_CMD.\"v-list-user '\".$user.\"' 'json'\";\n    exec ($command, $output, $return_var);\n    if ( $return_var > 0 ) {\n        header(\"Location: /error/\");\n        exit;\n    }\n    $panel = json_decode(implode('', $output), true);\n}\n\n$fm = new FileManager($user);\n$fm->setRootDir($panel[$user]['HOME']);\n\n$_REQUEST['action'] = empty($_REQUEST['action']) ? '' : $_REQUEST['action'];\n\nswitch ($_REQUEST['action']) {\n    case 'cd':\n        $dir = $_REQUEST['dir'];\n        print json_encode($fm->ls($dir));\n        break;\n\n    case 'check_file_type':\n        $dir = $_REQUEST['dir'];\n        print json_encode($fm->checkFileType($dir));\n        break;\n\n    case 'rename_file':\n        $dir = $_REQUEST['dir'];\n        $item = $dir . '/' . $_REQUEST['item'];\n        $target_name = $dir . '/' . $_REQUEST['target_name'];\n        print json_encode($fm->renameFile($item, $target_name));\n        break;\n\n    case 'rename_directory':\n        $dir = $_REQUEST['dir'];\n        $item = $dir.$_REQUEST['item'];\n        $target_name = $dir.$_REQUEST['target_name'];\n\n        print json_encode($fm->renameDirectory($item, $target_name));\n        break;\n\n    case 'move_file':\n        $item = $_REQUEST['item'];\n        $target_name = $_REQUEST['target_name'];\n        print json_encode($fm->renameFile($item, $target_name));\n        break;\n\n    case 'move_directory':\n        $item = $_REQUEST['item'];\n        $target_name = $_REQUEST['target_name'];\n        print json_encode($fm->renameDirectory($item, $target_name));\n        break;\n\n    case 'delete_files':\n        $dir = $_REQUEST['dir'];\n        $item = $_REQUEST['item'];\n        print json_encode($fm->deleteItem($dir, $item));\n        break;\n\n    case 'create_file':\n        $dir = $_REQUEST['dir'];\n        $filename = $_REQUEST['filename'];\n        print json_encode($fm->createFile($dir, $filename));\n        break;\n\n    case 'create_dir':\n        $dir = $_REQUEST['dir'];\n        $dirname = $_REQUEST['dirname'];\n        print json_encode($fm->createDir($dir, $dirname));\n        break;\n\n    case 'open_file':\n        $dir = $_REQUEST['dir'];\n        print json_encode($fm->open_file($dir));\n        break;\n\n    case 'copy_file':\n        $dir = $_REQUEST['dir'];\n        $target_dir = $_REQUEST['dir_target'];\n        $filename   = $_REQUEST['filename'];\n        $item       = $_REQUEST['item'];\n        print json_encode($fm->copyFile($item, $dir, $target_dir, $filename));\n        break;\n\n    case 'copy_directory':\n        $dir = $_REQUEST['dir'];\n        $target_dir = $_REQUEST['dir_target'];\n        $filename   = $_REQUEST['filename'];\n        $item       = $_REQUEST['item'];\n        print json_encode($fm->copyDirectory($item, $dir, $target_dir, $filename));\n        break;\n\n    case 'unpack_item':\n        $dir = $_REQUEST['dir'];\n        $target_dir = $_REQUEST['dir_target'];\n        $filename   = $_REQUEST['filename'];\n        $item       = $_REQUEST['item'];\n        print json_encode($fm->unpackItem($item, $dir, $target_dir, $filename));\n        break;\n\n    case 'pack_item':\n        $items      = $_REQUEST['items'];\n        $dst_item   = $_REQUEST['dst_item'];\n        print json_encode($fm->packItem($items, $dst_item));\n        break;\n\n    case 'backup':\n        $path = $_REQUEST['path'];\n        print json_encode($fm->backupItem($path));\n        break;\n\n    case 'chmod_item':\n        $dir = $_REQUEST['dir'];\n        $item = $_REQUEST['item'];\n        $permissions = $_REQUEST['permissions'];\n        print json_encode($fm->chmodItem($dir, $item, $permissions));\n        break;\n\n    default:\n        //print json_encode($fm->init());\n        break;\n}\n"], "filenames": ["web/file_manager/fm_api.php"], "buggy_code_start_loc": [2], "buggy_code_end_loc": [5], "fixing_code_start_loc": [1], "fixing_code_end_loc": [6], "type": "CWE-79", "message": "Vesta Control Panel 0.9.8-23 allows XSS via a crafted URL.", "other": {"cve": {"id": "CVE-2019-9841", "sourceIdentifier": "cve@mitre.org", "published": "2019-04-19T19:29:00.407", "lastModified": "2019-04-22T13:10:52.413", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Vesta Control Panel 0.9.8-23 allows XSS via a crafted URL."}, {"lang": "es", "value": "Vesta Control Panel versi\u00f3n 0.9.8-23 permite XSS mediante una URL creada."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:vestacp:control_panel:0.9.8-23:*:*:*:*:*:*:*", "matchCriteriaId": "5C959D4C-27D5-4077-BB53-507D8D7DFF78"}]}]}], "references": [{"url": "https://cardaci.xyz/advisories/2019/04/15/vesta-control-panel-0.9.8-23-reflected-xss-in-file-manager-api/", "source": "cve@mitre.org", "tags": ["Exploit", "Third Party Advisory"]}, {"url": "https://forum.vestacp.com/viewtopic.php?f=25&t=18599&sid=fc1a48fd2f43815b2dc69c3f64caed36", "source": "cve@mitre.org", "tags": ["Release Notes", "Vendor Advisory"]}, {"url": "https://github.com/serghey-rodin/vesta/commit/c28c5d29a3c61bc8110c11349e3f2309cd537cfa", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/serghey-rodin/vesta/commit/c28c5d29a3c61bc8110c11349e3f2309cd537cfa"}}