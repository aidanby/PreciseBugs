{"buggy_code": ["<?php\n/* Copyright (C) 2014 Laurent Destailleur  <eldy@users.sourceforge.net>\n *\n * This program is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program. If not, see <https://www.gnu.org/licenses/>.\n * or see https://www.gnu.org/\n */\n\n/**\n *\t\\file\t\t\thtdocs/core/actions_setnotes.inc.php\n *  \\brief\t\t\tCode for actions on setting notes of object page\n */\n\n\n// $action must be defined\n// $permissionnote must be defined to permission to edit object\n// $object must be defined (object is loaded in this file with fetch)\n// $id must be defined (object is loaded in this file with fetch)\n\n// Set public note\nif ($action == 'setnote_public' && !empty($permissionnote) && !GETPOST('cancel', 'alpha')) {\n\tif (empty($action) || !is_object($object) || empty($id)) {\n\t\tdol_print_error('', 'Include of actions_setnotes.inc.php was done but required variable was not set before');\n\t}\n\tif (empty($object->id)) {\n\t\t$object->fetch($id); // Fetch may not be already done\n\t}\n\n\t$result_update = $object->update_note(dol_html_entity_decode(GETPOST('note_public', 'restricthtml'), ENT_QUOTES | ENT_HTML5, 'UTF-8', 1), '_public');\n\n\tif ($result_update < 0) {\n\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t} elseif (in_array($object->table_element, array('supplier_proposal', 'propal', 'commande_fournisseur', 'commande', 'facture_fourn', 'facture'))) {\n\t\t// Define output language\n\t\tif (empty($conf->global->MAIN_DISABLE_PDF_AUTOUPDATE)) {\n\t\t\t$outputlangs = $langs;\n\t\t\t$newlang = '';\n\t\t\tif ($conf->global->MAIN_MULTILANGS && empty($newlang) && GETPOST('lang_id', 'aZ09')) {\n\t\t\t\t$newlang = GETPOST('lang_id', 'aZ09');\n\t\t\t}\n\t\t\tif ($conf->global->MAIN_MULTILANGS && empty($newlang)) {\n\t\t\t\t$newlang = $object->thirdparty->default_lang;\n\t\t\t}\n\t\t\tif (!empty($newlang)) {\n\t\t\t\t$outputlangs = new Translate(\"\", $conf);\n\t\t\t\t$outputlangs->setDefaultLang($newlang);\n\t\t\t}\n\t\t\t$model = $object->model_pdf;\n\t\t\t$hidedetails = (GETPOST('hidedetails', 'int') ? GETPOST('hidedetails', 'int') : (!empty($conf->global->MAIN_GENERATE_DOCUMENTS_HIDE_DETAILS) ? 1 : 0));\n\t\t\t$hidedesc = (GETPOST('hidedesc', 'int') ? GETPOST('hidedesc', 'int') : (!empty($conf->global->MAIN_GENERATE_DOCUMENTS_HIDE_DESC) ? 1 : 0));\n\t\t\t$hideref = (GETPOST('hideref', 'int') ? GETPOST('hideref', 'int') : (!empty($conf->global->MAIN_GENERATE_DOCUMENTS_HIDE_REF) ? 1 : 0));\n\n\t\t\t$result = $object->generateDocument($model, $outputlangs, $hidedetails, $hidedesc, $hideref);\n\n\t\t\tif ($result < 0) {\n\t\t\t\tdol_print_error($db, $result);\n\t\t\t}\n\t\t}\n\t}\n} elseif ($action == 'setnote_private' && !empty($permissionnote) && !GETPOST('cancel', 'alpha')) {\n\t// Set public note\n\tif (empty($action) || !is_object($object) || empty($id)) {\n\t\tdol_print_error('', 'Include of actions_setnotes.inc.php was done but required variable was not set before');\n\t}\n\tif (empty($object->id)) {\n\t\t$object->fetch($id); // Fetch may not be already done\n\t}\n\t$result = $object->update_note(dol_html_entity_decode(GETPOST('note_private', 'restricthtml'), ENT_QUOTES | ENT_HTML5), '_private');\n\tif ($result < 0) {\n\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t}\n}\n"], "fixing_code": ["<?php\n/* Copyright (C) 2014 Laurent Destailleur  <eldy@users.sourceforge.net>\n *\n * This program is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program. If not, see <https://www.gnu.org/licenses/>.\n * or see https://www.gnu.org/\n */\n\n/**\n *\t\\file\t\t\thtdocs/core/actions_setnotes.inc.php\n *  \\brief\t\t\tCode for actions on setting notes of object page\n */\n\n\n// $action must be defined\n// $permissionnote must be defined to permission to edit object\n// $object must be defined (object is loaded in this file with fetch)\n// $id must be defined (object is loaded in this file with fetch)\n\n// Set public note\nif ($action == 'setnote_public' && !empty($permissionnote) && !GETPOST('cancel', 'alpha')) {\n\tif (empty($action) || !is_object($object) || empty($id)) {\n\t\tdol_print_error('', 'Include of actions_setnotes.inc.php was done but required variable was not set before');\n\t}\n\tif (empty($object->id)) {\n\t\t$object->fetch($id); // Fetch may not be already done\n\t}\n\n\t$result_update = $object->update_note(dol_html_entity_decode(GETPOST('note_public', 'restricthtml'), ENT_QUOTES | ENT_HTML5, 'UTF-8', 1), '_public');\n\n\tif ($result_update < 0) {\n\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t} elseif (in_array($object->table_element, array('supplier_proposal', 'propal', 'commande_fournisseur', 'commande', 'facture_fourn', 'facture'))) {\n\t\t// Define output language\n\t\tif (empty($conf->global->MAIN_DISABLE_PDF_AUTOUPDATE)) {\n\t\t\t$outputlangs = $langs;\n\t\t\t$newlang = '';\n\t\t\tif ($conf->global->MAIN_MULTILANGS && empty($newlang) && GETPOST('lang_id', 'aZ09')) {\n\t\t\t\t$newlang = GETPOST('lang_id', 'aZ09');\n\t\t\t}\n\t\t\tif ($conf->global->MAIN_MULTILANGS && empty($newlang)) {\n\t\t\t\t$newlang = $object->thirdparty->default_lang;\n\t\t\t}\n\t\t\tif (!empty($newlang)) {\n\t\t\t\t$outputlangs = new Translate(\"\", $conf);\n\t\t\t\t$outputlangs->setDefaultLang($newlang);\n\t\t\t}\n\t\t\t$model = $object->model_pdf;\n\t\t\t$hidedetails = (GETPOST('hidedetails', 'int') ? GETPOST('hidedetails', 'int') : (!empty($conf->global->MAIN_GENERATE_DOCUMENTS_HIDE_DETAILS) ? 1 : 0));\n\t\t\t$hidedesc = (GETPOST('hidedesc', 'int') ? GETPOST('hidedesc', 'int') : (!empty($conf->global->MAIN_GENERATE_DOCUMENTS_HIDE_DESC) ? 1 : 0));\n\t\t\t$hideref = (GETPOST('hideref', 'int') ? GETPOST('hideref', 'int') : (!empty($conf->global->MAIN_GENERATE_DOCUMENTS_HIDE_REF) ? 1 : 0));\n\n\t\t\t$result = $object->generateDocument($model, $outputlangs, $hidedetails, $hidedesc, $hideref);\n\n\t\t\tif ($result < 0) {\n\t\t\t\tdol_print_error($db, $result);\n\t\t\t}\n\t\t}\n\t}\n} elseif ($action == 'setnote_private' && !empty($permissionnote) && !GETPOST('cancel', 'alpha')) {\t// Set public note\n\tif (empty($user->socid)) {\n\t\t// Private notes (always hidden to external users)\n\t\tif (empty($action) || !is_object($object) || empty($id)) {\n\t\t\tdol_print_error('', 'Include of actions_setnotes.inc.php was done but required variable was not set before');\n\t\t}\n\t\tif (empty($object->id)) {\n\t\t\t$object->fetch($id); // Fetch may not be already done\n\t\t}\n\t\t$result = $object->update_note(dol_html_entity_decode(GETPOST('note_private', 'restricthtml'), ENT_QUOTES | ENT_HTML5), '_private');\n\t\tif ($result < 0) {\n\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t}\n\t}\n}\n"], "filenames": ["htdocs/core/actions_setnotes.inc.php"], "buggy_code_start_loc": [70], "buggy_code_end_loc": [81], "fixing_code_start_loc": [70], "fixing_code_end_loc": [83], "type": "CWE-863", "message": "In \u201cDolibarr\u201d application, 2.8.1 to 13.0.4 don\u2019t restrict or incorrectly restricts access to a resource from an unauthorized actor. A low privileged attacker can modify the Private Note which only an administrator has rights to do, the affected field is at \u201c/adherents/note.php?id=1\u201d endpoint.", "other": {"cve": {"id": "CVE-2021-25954", "sourceIdentifier": "vulnerabilitylab@mend.io", "published": "2021-08-09T17:15:07.307", "lastModified": "2022-10-25T16:02:45.437", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In \u201cDolibarr\u201d application, 2.8.1 to 13.0.4 don\u2019t restrict or incorrectly restricts access to a resource from an unauthorized actor. A low privileged attacker can modify the Private Note which only an administrator has rights to do, the affected field is at \u201c/adherents/note.php?id=1\u201d endpoint."}, {"lang": "es", "value": "En la aplicaci\u00f3n Dolibarr, versiones 2.8.1 hasta 13.0.4, no se restringe o se restringe incorrectamente el acceso a un recurso de un actor no autorizado. Un atacante poco privilegiado puede modificar la Nota Privada que s\u00f3lo un administrador tiene derechos para hacer, el campo afectado se encuentra en el endpoint \"/adherents/note.php?id=1\""}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 4.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 1.4}, {"source": "vulnerabilitylab@mend.io", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 4.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 1.4}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-863"}]}, {"source": "vulnerabilitylab@mend.io", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-284"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:dolibarr:dolibarr:*:*:*:*:*:*:*:*", "versionStartIncluding": "2.8.1", "versionEndIncluding": "13.0.4", "matchCriteriaId": "EEDBE20F-CD40-424A-9E8E-A8A941B5BFCB"}]}]}], "references": [{"url": "https://github.com/Dolibarr/dolibarr/commit/8cc100012d46282799fb19f735a53b7101569377", "source": "vulnerabilitylab@mend.io", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://www.whitesourcesoftware.com/vulnerability-database/CVE-2021-25954", "source": "vulnerabilitylab@mend.io", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/Dolibarr/dolibarr/commit/8cc100012d46282799fb19f735a53b7101569377"}}