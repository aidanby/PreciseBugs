{"buggy_code": ["(module awful-salmonella-tar\n\n  (awful-salmonella-tar\n   cache-dir\n   salmonella-reports-dir\n   salmonella-report-dir\n   report-tar-filename\n   report-compressor\n   report-tar-contains-compressed-files?)\n\n(import scheme)\n(cond-expand\n  (chicken-4\n   (import chicken)\n   ;; Core units\n   (use data-structures extras files irregex posix srfi-1 srfi-13 utils)\n   ;; Eggs\n   (use awful intarweb spiffy))\n  (chicken-5\n   (import (chicken base)\n           (chicken condition)\n           (chicken errno)\n           (chicken file)\n           (chicken file posix)\n           (chicken format)\n           (chicken irregex)\n           (chicken pathname)\n           (chicken process)\n           (chicken string)\n           (chicken sort)\n           (chicken time posix))\n   (import awful intarweb spiffy srfi-1 srfi-13)\n   (define (file-read-access? file)\n     (handle-exceptions exn\n       (if (= (errno) errno/noent)\n           #f\n           (abort exn))\n       (file-readable? file))))\n  (else\n   (error \"Unsupported CHICKEN version.\")))\n\n\n(define cache-dir (make-parameter \"cache\"))\n\n(define salmonella-reports-dir (make-parameter \"\"))\n\n(define salmonella-report-dir (make-parameter \"salmonella-report\"))\n\n(define report-tar-filename (make-parameter \"salmonella-report.tar.gz\"))\n\n(define report-compressor\n  ;; #f specifies no compression (plain tar file)\n  (make-parameter 'gzip\n                  (lambda (v)\n                    (if (or (not v)\n                            (member v '(gzip bzip2)))\n                        v\n                        (error 'report-compressor \"Unsupported compressor\" v)))))\n\n(define report-tar-contains-compressed-files?\n  (make-parameter #f))\n\n(define (index-file)\n  (if (report-tar-contains-compressed-files?)\n      \"index.htmlz\"\n      \"index.html\"))\n\n(define (path-join parts)\n  (string-intersperse parts \"/\"))\n\n(define (path-split path)\n  (string-split path \"/\"))\n\n(define safe-path?\n  ;; Just in case, since we are using the external program tar\n  (let ((safe-chars\n         (string->list \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-+/:._\")))\n    (lambda (path)\n      (and (not (substring-index \"..\" path))\n           (let ((path-chars (string->list path)))\n             (every (lambda (path-char)\n                      (memq path-char safe-chars))\n                    path-chars))))))\n\n(define (requested-path->tar-file requested-file-path)\n  (define (tar-file-path path-parts)\n    (make-pathname (list (root-path)\n                         (salmonella-reports-dir)\n                         (path-join path-parts))\n                   (report-tar-filename)))\n  (let ((path-parts (path-split requested-file-path)))\n    (if (or (null? path-parts)\n            (null? (cdr path-parts))\n            (not (safe-path? requested-file-path)))\n        #f\n        (cond ((equal? (index-file) (last path-parts))\n               (tar-file-path (drop-right path-parts 2)))\n              ((equal? (salmonella-report-dir) (last path-parts))\n               (tar-file-path (butlast path-parts)))\n              (else\n               (let ((dir-part (last (butlast path-parts))))\n                 (case (string->symbol dir-part)\n                   ((salmonella-report)\n                    (tar-file-path (butlast path-parts)))\n                   ((dep-graphs install ranks rev-dep-graphs test)\n                    (tar-file-path (drop-right path-parts 3)))\n                   (else #f))))))))\n\n(define (split-by-salmonella-report requested-file-path)\n  ;; Given /<branch>/<c-compiler>/<os>/<arch>/<yyyy>/<mm>/<dd>/salmonella-report/<report-path>,\n  ;; return (/<branch>/<c-compiler>/<os>/<arch>/<yyyy>/<mm>/<dd> . salmonella-report/<report-path>)\n  (let ((parts (path-split requested-file-path)))\n    (let-values (((pre post) (split-at parts\n                                       (list-index (lambda (elt)\n                                                     (equal? elt (salmonella-report-dir)))\n                                                   parts))))\n      (cons (path-join pre)\n            (path-join post)))))\n\n(define (tar-get requested-file-path)\n  ;; FIXME: this code is subject to race conditions\n  (let ((cache-file (make-pathname (cache-dir) requested-file-path)))\n    (if (file-read-access? cache-file)\n        cache-file\n        (and-let* ((tar-file (requested-path->tar-file requested-file-path))\n                   (pre/post (split-by-salmonella-report requested-file-path))\n                   (pre (car pre/post))\n                   (post (cdr pre/post)))\n          (and (file-exists? tar-file)\n               (handle-exceptions exn\n                 #f\n                 (let* ((out-dir (make-pathname (cache-dir) pre))\n                        ;; Ugly.  Maybe use some tar implementation in\n                        ;; scheme (e.g., snowtar, or port the tar egg to\n                        ;; chicken 4)\n                        (cmd (sprintf \"tar x~af ~a -C ~a ~a\"\n                                      (case (report-compressor)\n                                        ((gzip) \"z\")\n                                        ((bzip2) \"j\")\n                                        (else \"\"))\n                                      tar-file\n                                      out-dir\n                                      (qs post))))\n                   (create-directory out-dir 'with-parents)\n                   (system* cmd)\n                   (make-pathname out-dir post))))))))\n\n;; As I understand it, configuring mime-type-map shouldn't be\n;; necessary.  However, it seems that (content-type #(text/html\n;; ((charset . utf-8)))) is not being set by with-headers in\n;; send-gzipped-file\n(mime-type-map\n (append\n  (mime-type-map)\n  '((\"logz\"  . text/plain)\n    (\"svg\"   . image/svg+xml)\n    (\"svgz\"  . image/svg+xml)\n    (\"htmlz\" . text/html))))\n\n(define (send-gzipped-file file)\n  (if (memq 'gzip (header-values 'accept-encoding\n                                 (request-headers (current-request))))\n        (with-headers '((content-type #(text/html ((charset . utf-8))))\n                        (content-encoding gzip))\n           (lambda ()\n             (send-static-file file)))\n      (send-response\n       code: 406\n       body: \"<h1>406 - Only gzip-compressed content is available</h1>\")))\n\n(define (send-file file)\n  (if (string-suffix? \"z\" file)\n      (send-gzipped-file file)\n      (send-static-file file)))\n\n(define (send-file-from-cache file-path)\n  (parameterize ((root-path (pathname-directory file-path)))\n    (let ((filename (pathname-strip-directory file-path)))\n      (send-file filename))))\n\n\n(define (render-dir web-dir fs-dir)\n  `(div (@ (id \"content\"))\n        (h2 \"Index of \" (code ,web-dir) \":\")\n        (p (a (@ (href ,(pathname-directory web-dir)))\n              \"Go to parent directory\"))\n        ,(let ((dir-content (directory fs-dir)))\n           `(table\n             ,@(map (lambda (f)\n                      (let* ((fs-file (make-pathname fs-dir f))\n                             (salmonella-report-dir?\n                              (equal? f (salmonella-report-dir)))\n                             (dir? (or salmonella-report-dir?\n                                       (directory? fs-file))))\n                        `(tr\n                          (td (a (@ (href ,(make-pathname web-dir f)))\n                                 ,(if dir?\n                                      (string-append f \"/\")\n                                      f)))\n                          (td ,(if salmonella-report-dir?\n                                   \"---\"\n                                   (file-size fs-file)))\n                          (td ,(if salmonella-report-dir?\n                                   \"---\"\n                                   (seconds->string (file-modification-time fs-file)))))))\n                    (sort\n                     (if (member (report-tar-filename) dir-content)\n                         (cons (salmonella-report-dir) dir-content)\n                         dir-content)\n                     string<))))))\n\n(define (default-app-settings handler)\n  (parameterize ((page-css \"//wiki.call-cc.org/chicken.css\"))\n    (handler)))\n\n(define (awful-salmonella-tar base-path #!key (awful-settings default-app-settings))\n\n  (define base-path-pattern\n    (irregex (string-append (string-chomp base-path \"/\") \"(/.*)*\")))\n\n  (define-app awful-salmonella-tar\n    matcher: (lambda (path)\n               (irregex-match base-path-pattern path))\n    handler-hook: (lambda (handler)\n                    (parameterize ((app-root-path base-path))\n                      (awful-settings handler)))\n\n    (create-directory (cache-dir) 'with-parents)\n\n    (define-page (irregex (string-append base-path \".*\"))\n      (lambda (req-path)\n        (let ((fs-path (make-pathname (list (root-path)\n                                            (salmonella-reports-dir))\n                                      req-path)))\n          (if (directory? fs-path)\n              (render-dir req-path fs-path)\n              (lambda ()\n                (let ((not-found (lambda ()\n                                   (send-status 'not-found))))\n                  (handle-exceptions exn\n                    (not-found)\n                    (cond ((equal? (pathname-strip-directory req-path)\n                                   (salmonella-report-dir))\n                           (redirect-to (string-append req-path \"/\")))\n                          ((equal? (pathname-strip-directory (string-chomp req-path \"/\"))\n                                   (salmonella-report-dir))\n                           (cond ((tar-get (make-pathname req-path (index-file)))\n                                  => send-file-from-cache)\n                                 (else (not-found))))\n                          ((tar-get req-path) => send-file-from-cache)\n                          (else\n                           (if (file-exists? (make-pathname (list (root-path)\n                                                                  (salmonella-reports-dir))\n                                                            req-path))\n                               (parameterize ((root-path (salmonella-reports-dir)))\n                                 (send-file req-path))\n                               (not-found)))))))))))\n    ) ;; end define-app\n  ) ;; end awful-salmonella-tar\n) ;; end module\n"], "fixing_code": ["(module awful-salmonella-tar\n\n  (awful-salmonella-tar\n   cache-dir\n   salmonella-reports-dir\n   salmonella-report-dir\n   report-tar-filename\n   report-compressor\n   report-tar-contains-compressed-files?)\n\n(import scheme)\n(cond-expand\n  (chicken-4\n   (import chicken)\n   ;; Core units\n   (use data-structures extras files irregex posix srfi-1 srfi-13 utils)\n   ;; Eggs\n   (use awful intarweb spiffy))\n  (chicken-5\n   (import (chicken base)\n           (chicken condition)\n           (chicken errno)\n           (chicken file)\n           (chicken file posix)\n           (chicken format)\n           (chicken irregex)\n           (chicken pathname)\n           (chicken process)\n           (chicken string)\n           (chicken sort)\n           (chicken time posix))\n   (import awful intarweb spiffy srfi-1 srfi-13)\n   (define (file-read-access? file)\n     (handle-exceptions exn\n       (if (= (errno) errno/noent)\n           #f\n           (abort exn))\n       (file-readable? file))))\n  (else\n   (error \"Unsupported CHICKEN version.\")))\n\n\n(define cache-dir (make-parameter \"cache\"))\n\n(define salmonella-reports-dir (make-parameter \"\"))\n\n(define salmonella-report-dir (make-parameter \"salmonella-report\"))\n\n(define report-tar-filename (make-parameter \"salmonella-report.tar.gz\"))\n\n(define report-compressor\n  ;; #f specifies no compression (plain tar file)\n  (make-parameter 'gzip\n                  (lambda (v)\n                    (if (or (not v)\n                            (member v '(gzip bzip2)))\n                        v\n                        (error 'report-compressor \"Unsupported compressor\" v)))))\n\n(define report-tar-contains-compressed-files?\n  (make-parameter #f))\n\n(define (index-file)\n  (if (report-tar-contains-compressed-files?)\n      \"index.htmlz\"\n      \"index.html\"))\n\n(define (path-join parts)\n  (string-intersperse parts \"/\"))\n\n(define (path-split path)\n  (string-split path \"/\"))\n\n(define safe-path?\n  ;; Just in case, since we are using the external program tar\n  (let ((safe-chars\n         (string->list \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-+/:._\")))\n    (lambda (path)\n      (and (not (substring-index \"..\" path))\n           (let ((path-chars (string->list path)))\n             (every (lambda (path-char)\n                      (memq path-char safe-chars))\n                    path-chars))))))\n\n(define (requested-path->tar-file requested-file-path)\n  (define (tar-file-path path-parts)\n    (make-pathname (list (root-path)\n                         (salmonella-reports-dir)\n                         (path-join path-parts))\n                   (report-tar-filename)))\n  (let ((path-parts (path-split requested-file-path)))\n    (if (or (null? path-parts)\n            (null? (cdr path-parts))\n            (not (safe-path? requested-file-path)))\n        #f\n        (cond ((equal? (index-file) (last path-parts))\n               (tar-file-path (drop-right path-parts 2)))\n              ((equal? (salmonella-report-dir) (last path-parts))\n               (tar-file-path (butlast path-parts)))\n              (else\n               (let ((dir-part (last (butlast path-parts))))\n                 (case (string->symbol dir-part)\n                   ((salmonella-report)\n                    (tar-file-path (butlast path-parts)))\n                   ((dep-graphs install ranks rev-dep-graphs test)\n                    (tar-file-path (drop-right path-parts 3)))\n                   (else #f))))))))\n\n(define (split-by-salmonella-report requested-file-path)\n  ;; Given /<branch>/<c-compiler>/<os>/<arch>/<yyyy>/<mm>/<dd>/salmonella-report/<report-path>,\n  ;; return (/<branch>/<c-compiler>/<os>/<arch>/<yyyy>/<mm>/<dd> . salmonella-report/<report-path>)\n  (let ((parts (path-split requested-file-path)))\n    (let-values (((pre post) (split-at parts\n                                       (list-index (lambda (elt)\n                                                     (equal? elt (salmonella-report-dir)))\n                                                   parts))))\n      (cons (path-join pre)\n            (path-join post)))))\n\n(define (tar-get requested-file-path)\n  ;; FIXME: this code is subject to race conditions\n  (let ((cache-file (make-pathname (cache-dir) requested-file-path)))\n    (if (file-read-access? cache-file)\n        cache-file\n        (and-let* ((tar-file (requested-path->tar-file requested-file-path))\n                   (pre/post (split-by-salmonella-report requested-file-path))\n                   (pre (car pre/post))\n                   (post (cdr pre/post)))\n          (and (file-exists? tar-file)\n               (handle-exceptions exn\n                 #f\n                 (let* ((out-dir (make-pathname (cache-dir) pre))\n                        ;; Ugly.  Maybe use some tar implementation in\n                        ;; scheme (e.g., snowtar, or port the tar egg to\n                        ;; chicken 4)\n                        (cmd (sprintf \"tar x~af ~a -C ~a ~a\"\n                                      (case (report-compressor)\n                                        ((gzip) \"z\")\n                                        ((bzip2) \"j\")\n                                        (else \"\"))\n                                      tar-file\n                                      out-dir\n                                      (qs post))))\n                   (create-directory out-dir 'with-parents)\n                   (system* cmd)\n                   (make-pathname out-dir post))))))))\n\n;; As I understand it, configuring mime-type-map shouldn't be\n;; necessary.  However, it seems that (content-type #(text/html\n;; ((charset . utf-8)))) is not being set by with-headers in\n;; send-gzipped-file\n(mime-type-map\n (append\n  (mime-type-map)\n  '((\"logz\"  . text/plain)\n    (\"svg\"   . image/svg+xml)\n    (\"svgz\"  . image/svg+xml)\n    (\"htmlz\" . text/html))))\n\n(define (send-gzipped-file file)\n  (if (memq 'gzip (header-values 'accept-encoding\n                                 (request-headers (current-request))))\n        (with-headers '((content-type #(text/html ((charset . utf-8))))\n                        (content-encoding gzip))\n           (lambda ()\n             (send-static-file file)))\n      (send-response\n       code: 406\n       body: \"<h1>406 - Only gzip-compressed content is available</h1>\")))\n\n(define (send-file file)\n  (if (string-suffix? \"z\" file)\n      (send-gzipped-file file)\n      (send-static-file file)))\n\n(define (send-file-from-cache file-path)\n  (parameterize ((root-path (pathname-directory file-path)))\n    (let ((filename (pathname-strip-directory file-path)))\n      (send-file filename))))\n\n\n(define (render-dir web-dir fs-dir)\n  `(div (@ (id \"content\"))\n        (h2 \"Index of \" (code ,web-dir) \":\")\n        (p (a (@ (href ,(pathname-directory web-dir)))\n              \"Go to parent directory\"))\n        ,(let ((dir-content (directory fs-dir)))\n           `(table\n             ,@(map (lambda (f)\n                      (let* ((fs-file (make-pathname fs-dir f))\n                             (salmonella-report-dir?\n                              (equal? f (salmonella-report-dir)))\n                             (dir? (or salmonella-report-dir?\n                                       (directory? fs-file))))\n                        `(tr\n                          (td (a (@ (href ,(make-pathname web-dir f)))\n                                 ,(if dir?\n                                      (string-append f \"/\")\n                                      f)))\n                          (td ,(if salmonella-report-dir?\n                                   \"---\"\n                                   (file-size fs-file)))\n                          (td ,(if salmonella-report-dir?\n                                   \"---\"\n                                   (seconds->string (file-modification-time fs-file)))))))\n                    (sort\n                     (if (member (report-tar-filename) dir-content)\n                         (cons (salmonella-report-dir) dir-content)\n                         dir-content)\n                     string<))))))\n\n(define (default-app-settings handler)\n  (parameterize ((page-css \"//wiki.call-cc.org/chicken.css\"))\n    (handler)))\n\n(define (awful-salmonella-tar base-path #!key (awful-settings default-app-settings))\n\n  (define base-path-pattern\n    (irregex (string-append (string-chomp base-path \"/\") \"(/.*)*\")))\n\n  (define-app awful-salmonella-tar\n    matcher: (lambda (path)\n               (irregex-match base-path-pattern path))\n    handler-hook: (lambda (handler)\n                    (parameterize ((app-root-path base-path))\n                      (awful-settings handler)))\n\n    (create-directory (cache-dir) 'with-parents)\n\n    (define-page (irregex (string-append base-path \".*\"))\n      (lambda (req-path)\n        (let ((fs-path (make-pathname (list (root-path)\n                                            (salmonella-reports-dir))\n                                      req-path))\n              (not-found (lambda ()\n                           (send-status 'not-found))))\n          (cond ((not (safe-path? req-path))\n                 (lambda ()\n                   (not-found)))\n                ((directory? fs-path)\n                 (render-dir req-path fs-path))\n                (else\n                 (lambda ()\n                   (handle-exceptions exn\n                     (not-found)\n                     (cond ((equal? (pathname-strip-directory req-path)\n                                    (salmonella-report-dir))\n                            (redirect-to (string-append req-path \"/\")))\n                           ((equal? (pathname-strip-directory (string-chomp req-path \"/\"))\n                                    (salmonella-report-dir))\n                            (cond ((tar-get (make-pathname req-path (index-file)))\n                                   => send-file-from-cache)\n                                  (else (not-found))))\n                           ((tar-get req-path) => send-file-from-cache)\n                           (else\n                            (if (file-exists? (make-pathname (list (root-path)\n                                                                   (salmonella-reports-dir))\n                                                             req-path))\n                                (parameterize ((root-path (salmonella-reports-dir)))\n                                  (send-file req-path))\n                                (not-found)))))))))))\n    ) ;; end define-app\n  ) ;; end awful-salmonella-tar\n) ;; end module\n"], "filenames": ["awful-salmonella-tar.scm"], "buggy_code_start_loc": [234], "buggy_code_end_loc": [258], "fixing_code_start_loc": [234], "fixing_code_end_loc": [262], "type": "CWE-22", "message": "A ..%2F path traversal vulnerability exists in the path handler of awful-salmonella-tar before 0.0.4. Attackers can only list directories (not read files). This occurs because the safe-path? Scheme predicate is not used for directories.", "other": {"cve": {"id": "CVE-2022-25358", "sourceIdentifier": "cve@mitre.org", "published": "2022-02-18T22:15:13.640", "lastModified": "2022-03-01T19:07:39.237", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A ..%2F path traversal vulnerability exists in the path handler of awful-salmonella-tar before 0.0.4. Attackers can only list directories (not read files). This occurs because the safe-path? Scheme predicate is not used for directories."}, {"lang": "es", "value": "Se presenta una vulnerabilidad en el manejo de rutas de awful-salmonella-tar versiones anteriores a 0.0.4. Los atacantes s\u00f3lo pueden listar directorios (no leer archivos). Esto ocurre porque el predicado safe-path? no es usado para los directorios"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 5.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 3.9, "impactScore": 1.4}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:N/C:P/I:N/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 5.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 10.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-22"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:awful-salmonella-tar_project:awful-salmonella-tar:*:*:*:*:*:*:*:*", "versionEndExcluding": "0.0.4", "matchCriteriaId": "146FAB8E-42AE-42A7-96B4-E471A68ACE19"}]}]}], "references": [{"url": "https://github.com/mario-goulart/awful-salmonella-tar/commit/f705c881769b7610745cd4b4d8ae8b41b3f4f845", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://wiki.call-cc.org/eggref/5/awful-salmonella-tar", "source": "cve@mitre.org", "tags": ["Product", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/mario-goulart/awful-salmonella-tar/commit/f705c881769b7610745cd4b4d8ae8b41b3f4f845"}}