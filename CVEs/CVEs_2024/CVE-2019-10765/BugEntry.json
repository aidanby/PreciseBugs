{"buggy_code": ["![Logo](admin/admin.png)\n# ioBroker.admin\n===================\n\n[![NPM version](http://img.shields.io/npm/v/iobroker.admin.svg)](https://www.npmjs.com/package/iobroker.admin)\n[![Downloads](https://img.shields.io/npm/dm/iobroker.admin.svg)](https://www.npmjs.com/package/iobroker.admin)\n[![Stable](http://iobroker.live/badges/admin-stable.svg)](http://iobroker.live/badges/admin-stable.svg)\n[![installed](http://iobroker.live/badges/admin-installed.svg)](http://iobroker.live/badges/admin-installed.svg)\n\n[![NPM](https://nodei.co/npm/iobroker.admin.png?downloads=true)](https://nodei.co/npm/iobroker.admin/)\n\n\nUser interface for configuration and administration.\n\n## Using common.localLink\n\n- %ip% - ioBroker ip address (address of the admin)\n- %secure% or %protocol% - read from native.secure the value and use http or https\n- %web_protocol% - looking for the first instance of web (e.g. web.0) and get \"native.secure\" from \"system.adapter.web.0\"\n- %instance% - instance of the adapter\n- %someField% - get someField from \"native\" of this adapter instance\n- %web.0_bind% - get native.bind from \"system.adapter.web.0\"\n- %native_someField% - get someField from \"native\" of this adapter instance\n\n## Scheduled restart\nSome adapters re not stable or connection disappear after one or two days.\nTo fix this there is a scheduled restart setting.\nTo activate scheduled restart just define CRON condition when to restart adapter.\n\nIt is suggested to restart in the night, when no one use the adapter, e.g. \"0 3 * * *\" - at 3:00 every day.\n\n## Let's Encrypt Certificates\nLet\u2019s Encrypt is a free, automated, and open certificate authority brought to you by the non-profit Internet Security Research Group (ISRG).\n\nYou can read about Let\u2019s Encrypt [here](https://letsencrypt.org/).\n\nSome installations use Dynamic DNS and Co to get the domain name and to reach under this domain name own web sites.\nioBroker supports automatic request and renew of certificates from Let\u2019s Encrypt Organisation.\n\nThere is an option to activate free certificates from Let\u2019s Encrypt almost in every adapter, that can start some web server and supports HTTPS.\n\nIf you just enable the using of certificates and will not activate an automatic update the instance will try to use stored certificates.\n\nIf the automatic update is activated the instance will try to request certificates from Let\u2019s Encrypt and will automatically update it.\n\nThe certificates will be first requested when the given domain address will be accessed. E.g you have \"sub.domain.com\" as address, when you try to access https://sub.domain.com the certificates will be first requested and it can last a little before first answer will come.\n\nThe issuing of certificates is rather complex procedure, but if you will follow the explanation you will easy get free certificates.\n\nDescription:\n\n1. The new account will be created with given email address (you must set it up in system settings)\n2. Some random key will be created as password for the account.\n3. After the account is created the system starts on port 80 the small web site to confirm the domain.\n4. Let's encrypt use **always** port **80** to check the domain.\n5. If port 80 is occupied by other service see point 4.\n6. After the small web server is up the request to get certificates for given domains (system settings) will be sent to the Let's encrypt server.\n7. Let's encrypt server sends back some challenge phrase as answer on the request and after a while tries to read this challenge phrase on \"http://yourdomain:80/.well-known/acme-challenge/<CHALLENGE>\"\n8. If challenge phrase from our side comes back the Let's encrypt server send us the certificates. They will be stored in the given directory (system settings).\n\nSounds complex, but everything what you must do is to activate checkboxes and specify your email and domain in system settings.\n\nThe received certificates are valid ca. 90 days.\nAfter the certificates are received the special task will be started to automatically renew the certificates.\n\nThe topic is rather complex and 1000 things can go wrong. If you cannot get certificates please use cloud service to reach your installation from internet.\n\n**Let's encrypt works only from node.js version>=4.5**\n\n## Todo\n- move html tooltips to materialize tooltips\n- tiles for hosts (additionally to table - low prior)\n- tiles for instances (additionally to table - low prior)\n\n## Used icons\nThis project uses some icons from [Flaticon](https://www.flaticon.com/):\n- <img src=\"src/img/rooms/006-double-bed.svg\" height=\"48\" /> - designed by [smalllikeart](https://www.flaticon.com/authors/smalllikeart) from [Flaticon](https://www.flaticon.com/)\n- <img src=\"src/img/rooms/016-armchair-1.svg\" height=\"48\" /> - designed by [smalllikeart](https://www.flaticon.com/authors/smalllikeart) from [Flaticon](https://www.flaticon.com/)\n- <img src=\"src/img/rooms/022-armchair-1.svg\" height=\"48\" /> - designed by [smalllikeart](https://www.flaticon.com/authors/smalllikeart) from [Flaticon](https://www.flaticon.com/)\n- <img src=\"src/img/devices/light-bulb.svg\" height=\"48\" /> - Icons made by [Vectors Market](https://www.flaticon.com/authors/vectors-market) from [Flaticon](https://www.flaticon.com/) is licensed by [CC 3.0 BY](http://creativecommons.org/licenses/by/3.0/).\n- <img src=\"src/img/rooms/garage.svg\" height=\"48\" /> - designed by [Pause08](https://www.flaticon.com/authors/Pause08) from [Flaticon](https://www.flaticon.com/)\n- <img src=\"src/img/rooms/toilet.svg\" height=\"48\" /> - Icons made by [Freepik](http://www.freepik.com) from [www.flaticon.com](https://www.flaticon.com/) is licensed by [CC 3.0 BY](http://creativecommons.org/licenses/by/3.0/)\n\n## Changelog\n### 3.6.7 (2019-09-24)\n* (ldittmar) Add Node.JS version check to popup messages\n\n### 3.6.6 (2019-09-18)\n* (SchumyHao) Update Chinese translation\n* (tmikulski) Update translations.json\n\n### 3.6.5 (2019-09-02)\n* (ldittmar) Fix anoying popups from info adapter\n\n### 3.6.4 (2019-06-03)\n* (bluefox) Update nodejs recommendation message and check to recommend nodejs 10\n\n### 3.6.3 (2019-06-02)\n* (bluefox) Added deleteFile internal function (required for lovelace)\n* (bluefox) Added yaml editor (required for lovelace)\n* (bluefox) try to fix auto-fill option\n* (dobis) Update italian translations\n\n### 3.6.2 (2019-05-05)\n* (bluefox) Added onSave handler for custom dialogs\n\n### 3.6.1 (2019-04-18)\n* (ldittmar) Better integration for ioBroker.info (1.3.7)\n* (ldittmar) Update Gulp to v4\n* (ldittmar) Update materialize-css to v 1.0.0\n\n### 3.6.0 (2018-11-08)\n* (foxriver76) New update states added in info channel\n* (foxriver76) Take respect to async when creating info states\n* (SchumyHao) Added chinese translations\n\n### 3.5.10 (2018-09-22)\n* (bluefox) Disable too many debug outputs\n\n### 3.5.9 (2018-09-12)\n* (bluefox) The log output problem was fixed\n\n### 3.5.8 (2018-09-03)\n* (bluefox) Google map was replaces with \"open street map\"\n\n### 3.5.7 (2018-08-30)\n* (bluefox) Edit of the table entries in configuration dialog was corrected.\n\n### 3.5.6 (2018-08-22)\n* (bluefox) Import and export of the instance configuration was implemented.\n\n### 3.5.5 (2018-08-21)\n* (bluefox) Fix upload of files\n\n### 3.5.3 (2018-08-18)\n* (bluefox) Dropdown was fixed on touch devices\n* (bluefox) Speedup build of instances\n\n### 3.5.1 (2018-08-11)\n* (bluefox) Error in custom settings was fixed\n\n### 3.5.0 (2018-08-03)\n* (bluefox) Editing of enums was changed\n* (bluefox) Logo was updated\n* (bluefox) The function icons were added\n\n### 3.4.9 (2018-07-17)\n* (bluefox) Support of the custom login screen background\n* (bluefox) show tooltip about refresh on instances page\n* (bluefox) Destroy tabs after they left\n\n### 3.4.8 (2018-07-17)\n* (bluefox) fix error with add new enum\n* (bluefox) try to fix error with custom settings\n* (bluefox) place all titles at the top in the config\n* (bluefox) add expert mode to common\n* (bluefox) allow edit of enum's names in many languages\n\n### 3.4.7 (2018-06-25)\n* (bluefox) add getInterfaces function\n* (bluefox) save scroll position for some tables\n* (bluefox) add info about \"filtered out\"\n\n### 3.4.6 (2018-06-18)\n* (bluefox) Minor GUI fixes\n\n### 3.4.5 (2018-06-12)\n* (bluefox) Minor GUI fixes\n\n### 3.4.4 (2018-06-04)\n* (bluefox) add touch support for draggable and droppable\n* (bluefox) edit raw value and not escaped in selectID.js\n* (bluefox) allow edit of empty names in selectID.less\n* (bluefox) add change with ack=true to selectID\n* (bluefox) fix select for admin3 in configuration dialog\n* (bluefox) add autocomplete for configs\n* (bluefox) fix enums\n\n### 3.4.3 (2018-05-13)\n* (bluefox) The button in selectID was fixed\n* (bluefox) disk info was added\n* (bluefox) The filter in table mode on adapter tab was showed\n* (bluefox) memAvailable for RAM monitoring is used\n* (bluefox) fix select problem in config dialog\n* (bluefox) added the asking about unsaved scripts\n\n### 3.4.2 (2018-05-04)\n* (BuZZy1337) fix wrong height calculation in select id dialog\n\n### 3.4.1 (2018-05-03)\n* (bluefox) fix wait popup\n* (bluefox) fix button name in config dialog\n* (BuZZy1337) escape html from log entries\n* (bluefox) fix objects counter\n* (BuZZy1337) show current Tab in Page-Title\n* (BuZZy1337) escape HTML Tags from selectID.js\n* (bluefox) GUI bugfixes\n* (BuZZy1337) Fix: Unable to scroll trough Dropdown on Touchscreens\n* (BuZZy1337) Enhancement: Show current Tab in Pagetitle\n\n### 3.4.0 (2018-04-23)\n* (bluefox) show error about not activated admin for cloud\n* (bluefox) handle mutlilanguage names\n* (bluefox) show number of objects\n* (BuZZy1337) always addChips when input blurs\n* (bluefox) fix select ID dialog for old styles\n* (bluefox) add states view for object tab\n\n### 3.3.9 (2018-04-12)\n* (bluefox) The user and groups deletion was corrected\n* (bluefox) Force using of socket.io 2.1.0\n\n### 3.3.8 (2018-04-10)\n* (bluefox) Hosts selection is improved\n\n### 3.3.7 (2018-04-10)\n* (bluefox) small UI corrections\n\n### 3.3.5 (2018-03-25)\n* (bondrogeen) info for server redesigned\n* (bondrogeen) hosts list redesigned\n* (bluefox) small UI corrections\n\n### 3.3.4 (2018-03-17)\n* (bluefox) small UI corrections\n\n### 3.3.3 (2018-03-15)\n* (bluefox) small UI corrections\n\n### 3.3.1 (2018-03-11)\n* (bluefox) Corrections for scenes\n* (bluefox) move from socket.io 2.0.4 to 1.5.1 because of bug\n* (bluefox) small fix for hosts\n\n### 3.3.0 (2018-03-10)\n* (bluefox) Overview page was added\n* (bluefox) Many bugs were fixed\n\n### 3.2.4 (2018-03-04)\n* (bluefox) Adjust layout on mobile devices\n\n### 3.2.1 (2018-03-03)\n* (bluefox) Many UI fixes\n\n### 3.2.0 (2018-02-09)\n* (bluefox) The select ID dialog was fixed\n\n### 3.1.12 (2018-02-05)\n* (bondrogeen) Configuration dialog updated\n* (bondrogeen) Open menu button is fixed\n\n### 3.1.11 (2018-02-04)\n* (bluefox) Connection LED fixed\n\n### 3.1.10 (2018-02-02)\n* (bluefox) update material CSS\n* (bluefox) fix permission error\n* (bluefox) fix filter of adapters\n\n### 3.1.7 (2018-01-31)\n* (bluefox) Fixing the role selection\n* (bluefox) It runs even in IE10\n\n### 3.1.6 (2018-01-30)\n* (bluefox) Fixes for Firefox and MS-EDGE\n\n### 3.1.2 (2018-01-25)\n* (bluefox) GUI corrections\n\n### 3.0.12 (2018-01-19)\n* (bluefox) Old configuration dialogs fixed\n* (bluefox) convert strings to booleans by object edit\n* (DeepCoreSystem) Updates in english, german and french translations\n* (bluefox) buttons layout fixed\n* (bluefox) event fixes\n\n### 3.0.11 (2018-01-11)\n* (DeepCoreSystem) French update\n* (bluefox) fix error with empty ID \n* (bluefox) add sort by \"recently updated\"\n* (ldittmar) add readme and issues viewer\n\n### 3.0.10 (2018-01-06)\n* (bluefox) Update indication\n* (ldittmar) Use jQuery3\n* (AlCalzone) German translations\n\n### 3.0.7 (2018-01-01)\n* (soef) update instances, objects and other lists\n* (bluefox) rewrite interface with materialize \n\n### 2.0.11 (2017-10-23)\n* (bluefox) Configurable event update disable threshold\n\n### 2.0.10 (2017-10-22)\n* (soef) added use of delete-key in the objects view\n\n### 2.0.8 (2017-10-12)\n* (soef) fix quickEdit: number with boolean value\n\n### 2.0.7 (2017-10-11)\n* (soef) Sort option added to object view\n\n### 2.0.5 (2017-10-06)\n* (bluefox) Show the history charts if the web server has the https option on too\n\n### 2.0.3 (2017-08-13)\n* (bluefox) Fix user access rights for sendToHost\n\n### 2.0.2 (2017-08-12)\n* (bluefox) Add the editing of the default access rights\n\n### 2.0.1 (2017-08-07)\n* (bluefox) Allow access via iobroker.pro\n* (bluefox) Add node.js version recommendation\n\n### 1.8.3 (2017-07-24)\n* (bluefox) allow access on tmp directory\n\n### 1.8.0 (2017-06-02)\n* (bluefox) split into modules\n\n### 1.7.6 (2017-06-01)\n* (bluefox) Fix edit of the enum name\n\n### 1.7.5 (2017-05-20)\n* (bluefox) catch error if translated object is not text\n* (bluefox) update selectID.js\n* (bluefox) do not open configuration dialog for instances with no config\n* (Steiger04) select multiple auch bei data-name=\"[eigner-name]\"\n\n### 1.7.3 (2017-03-25)\n* (bluefox) fix license dialog\n* (bluefox) change color of tooltip text\n* (ykuendig) update german translation\n* (bluefox) add docs\n\n### 1.7.2 (2017-03-15)\n* (bluefox) add statistics selector for no-city\n* (bluefox) support of discovery by first start\n\n### 1.7.1 (2017-03-11)\n* (apollon77) fix save button functionality\n* (ykuendig) Update german translations\n* (bluefox) patch repositories to support stable\n\n### 1.7.0 (2017-03-08)\n* (bluefox) fix log\n* (bluefox) show jQuery button for role button\n* (apollon77) update testing setup.js\n* (bluefox) fix wetty loading\n* (bluefox) fix add/delete tabs\n* (bluefox) implement hints for configuration dialog\n* (bluefox) redirect if IP address changes\n* (bluefox) add tooltip instruction\n* (bluefox) wizard support\n* (bluefox) fix acl error\n* (bluefox) fix license agree button\n\n## License\n\nThe MIT License (MIT)\n\nCopyright (c) 2014-2019 bluefox <dogafox@gmail.com>\n", "'use strict';\n\nconst less        = require('gulp-less');\nconst sass        = require('gulp-sass');\nconst gulp        = require('gulp');\nconst colors      = require('ansi-colors');\nconst log         = require('fancy-log');\nconst uglify      = require('gulp-terser');\nconst htmlmin     = require('gulp-htmlmin');\nconst concat      = require('gulp-concat');\nconst sourcemaps  = require('gulp-sourcemaps');\nconst materialize = require.resolve('materialize-css');\nconst cleanCSS    = require('gulp-clean-css');\nconst pkg         = require('./package.json');\nconst iopackage   = require('./io-package.json');\nconst babel       = require('gulp-babel');\nconst fs          = require('fs');\n\nconst fileName = 'words.js';\nconst noSort   = false;\n\n/* How to work with language scripts\n--------------------------------------------------------\n    you can use for edit this tool https://github.com/ldittmar81/ioBroker-i18n-editor\n    to do that you can convert words from words.js into 6 json files, that i18n editor can understand. Use \"www (words.js => json).\n\n    To combine from json files the words.js again, just call www (json => words.js)\n\n    wwwWords2languages - converts src/js/words.js into 6 different json files in src/i18n/xxx/translations.json\n    wwwLanguages2words - converts 6 different json files from src/i18n/xxx/translations.json into src/js/words.js\n--------------------------------------------------------\n    You can export just a flat texts and translate them with e.g. google translator.\n    to do that you can convert words from words.js into 7 txt files. www (words.js => flat)\n\n    To combine from json files the words.js again, just call www (flat => words.js)\n\n    wwwWords2languagesFlat - converts src/js/words.js into 6 different txt files in src/i18n/xxx/flat.txt. Additionally it creates extra files with keys in src/i18n/flat.txt\n    wwwLanguagesFlat2words - converts src/i18n/xxx/flat.txt into src/js/words.js\n\n    adminWordsXXx is just the same, but for /admin/words.js\n */\n\nfunction lang2data(lang, isFlat) {\n    var str = isFlat ? '' : '{\\r\\n';\n    var count = 0;\n    for (var w in lang) {\n        if (lang.hasOwnProperty(w)) {\n            count++;\n            if (isFlat) {\n                str += (lang[w] === '' ? (isFlat[w] || w) : lang[w]) + '\\r\\n';\n            } else {\n                var key = '  \"' + w.replace(/\"/g, '\\\\\"') + '\": ';\n                str += /*padRight(*/key/*, 42)*/ +  '\"' + lang[w].replace(/\"/g, '\\\\\"') + '\",\\r\\n';\n            }\n        }\n    }\n    if (!count) return isFlat ? '' : '{\\r\\n}';\n    if (isFlat) {\n        return str;\n    } else {\n        return str.substring(0, str.length - 3) + '\\r\\n}\\r\\n';\n    }\n}\n\nfunction readWordJs(src) {\n    try {\n        var words;\n        if (fs.existsSync(src + 'js/' + fileName)) {\n            words = fs.readFileSync(src + 'js/' + fileName).toString();\n        } else {\n            words = fs.readFileSync(src + fileName).toString();\n        }\n\n        var lines = words.split(/\\r\\n|\\r|\\n/g);\n        var i = 0;\n        while (!lines[i].match(/^systemDictionary = {/)) {\n            i++;\n        }\n        lines.splice(0, i);\n\n        // remove last empty lines\n        i = lines.length - 1;\n        while (!lines[i]) {\n            i--;\n        }\n        if (i < lines.length - 1) {\n            lines.splice(i + 1);\n        }\n\n        lines[0] = lines[0].replace('systemDictionary = ', '');\n        lines[lines.length - 1] = lines[lines.length - 1].trim().replace(/};$/, '}');\n        words = lines.join('\\n');\n        var resultFunc = new Function('return ' + words + ';');\n\n        return resultFunc();\n    } catch (e) {\n        return null;\n    }\n}\nfunction padRight(text, totalLength) {\n    return text + (text.length < totalLength ? new Array(totalLength - text.length).join(' ') : '');\n}\nfunction writeWordJs(data, src) {\n    var text = '// DO NOT EDIT THIS FILE!!! IT WILL BE AUTOMATICALLY GENERATED FROM src/i18n\\n';\n    text += '/*global systemDictionary:true */\\n';\n    text += '\\'use strict\\';\\n\\n';\n    text += 'systemDictionary = {\\n';\n    for (var word in data) {\n        if (data.hasOwnProperty(word)) {\n            text += '    ' + padRight('\"' + word.replace(/\"/g, '\\\\\"') + '\": {', 50);\n            var line = '';\n            for (var lang in data[word]) {\n                if (data[word].hasOwnProperty(lang)) {\n                    line += '\"' + lang + '\": \"' + padRight(data[word][lang].replace(/\"/g, '\\\\\"') + '\",', 50) + ' ';\n                }\n            }\n            if (line) {\n                line = line.trim();\n                line = line.substring(0, line.length - 1);\n            }\n            text += line + '},\\n';\n        }\n    }\n    text += '};\\n';\n    if (src.indexOf('admin') === -1) {\n        fs.writeFileSync(src + 'js/' + fileName, text);\n    } else {\n        fs.writeFileSync(src + fileName, text);\n    }\n}\n\nconst EMPTY = '';\n\nfunction words2languages(src) {\n    var langs =  {\n        'en': {},\n        'de': {},\n        'ru': {},\n        'pt': {},\n        'nl': {},\n        'fr': {},\n        'it': {},\n        'es': {},\n        'pl': {},\n        'zh-cn': {}\n    };\n    var data = readWordJs(src);\n    if (data) {\n        for (var word in data) {\n            if (data.hasOwnProperty(word)) {\n                for (var lang in data[word]) {\n                    if (data[word].hasOwnProperty(lang)) {\n                        langs[lang][word] = data[word][lang];\n                        //  pre-fill all other languages\n                        for (var j in langs) {\n                            if (langs.hasOwnProperty(j)) {\n                                langs[j][word] = langs[j][word] || EMPTY;\n                            }\n                        }\n                    }\n                }\n            }\n        }\n        if (!fs.existsSync(src + 'i18n/')) {\n            fs.mkdirSync(src + 'i18n/');\n        }\n        for (var l in langs) {\n            var keys = Object.keys(langs[l]);\n            if (!noSort) keys.sort();\n            var obj = {};\n            for (var k = 0; k < keys.length; k++) {\n                obj[keys[k]] = langs[l][keys[k]];\n            }\n            if (!fs.existsSync(src + 'i18n/' + l)) {\n                fs.mkdirSync(src + 'i18n/' + l);\n            }\n\n            fs.writeFileSync(src + 'i18n/' + l + '/translations.json', lang2data(obj));\n        }\n    } else {\n        console.error('Cannot read or parse ' + fileName);\n    }\n}\nfunction words2languagesFlat(src) {\n    var langs =  {\n        'en': {},\n        'de': {},\n        'ru': {},\n        'pt': {},\n        'nl': {},\n        'fr': {},\n        'it': {},\n        'es': {},\n        'pl': {},\n        'zh-cn': {}\n    };\n    var data = readWordJs(src);\n    if (data) {\n        for (var word in data) {\n            if (data.hasOwnProperty(word)) {\n                for (var lang in data[word]) {\n                    if (data[word].hasOwnProperty(lang)) {\n                        langs[lang][word] = data[word][lang];\n                        //  pre-fill all other languages\n                        for (var j in langs) {\n                            if (langs.hasOwnProperty(j)) {\n                                langs[j][word] = langs[j][word] || EMPTY;\n                            }\n                        }\n                    }\n                }\n            }\n        }\n        var keys = Object.keys(langs.en);\n        if (!noSort) keys.sort();\n        for (var l in langs) {\n            var obj = {};\n            for (var k = 0; k < keys.length; k++) {\n                obj[keys[k]] = langs[l][keys[k]];\n            }\n            langs[l] = obj;\n        }\n        if (!fs.existsSync(src + 'i18n/')) {\n            fs.mkdirSync(src + 'i18n/');\n        }\n        for (var ll in langs) {\n            if (!fs.existsSync(src + 'i18n/' + ll)) {\n                fs.mkdirSync(src + 'i18n/' + ll);\n            }\n\n            fs.writeFileSync(src + 'i18n/' + ll + '/flat.txt', lang2data(langs[ll], langs.en));\n        }\n        fs.writeFileSync(src + 'i18n/flat.txt', keys.join('\\n'));\n    } else {\n        console.error('Cannot read or parse ' + fileName);\n    }\n}\nfunction languagesFlat2words(src) {\n    var dirs = fs.readdirSync(src + 'i18n/');\n    var langs = {};\n    var bigOne = {};\n    var order = ['en', 'de', 'ru', 'pt', 'nl', 'fr', 'it', 'es', 'pl', 'zh-cn'];\n    dirs.sort(function (a, b) {\n        var posA = order.indexOf(a);\n        var posB = order.indexOf(b);\n        if (posA === -1 && posB === -1) {\n            if (a > b) return 1;\n            if (a < b) return -1;\n            return 0;\n        } else if (posA === -1) {\n            return -1;\n        } else if (posB === -1) {\n            return 1;\n        } else {\n            if (posA > posB) return 1;\n            if (posA < posB) return -1;\n            return 0;\n        }\n    });\n    var keys = fs.readFileSync(src + 'i18n/flat.txt').toString().split(/\\r\\n|\\n|\\r/);\n\n    for (var l = 0; l < dirs.length; l++) {\n        if (dirs[l] === 'flat.txt') continue;\n        var lang = dirs[l];\n        var values = fs.readFileSync(src + 'i18n/' + lang + '/flat.txt').toString().split(/\\r\\n|\\n|\\r/);\n        langs[lang] = {};\n        keys.forEach(function (word, i) {\n             langs[lang][word] = values[i];\n        });\n\n        var words = langs[lang];\n        for (var word in words) {\n            if (words.hasOwnProperty(word)) {\n                bigOne[word] = bigOne[word] || {};\n                if (words[word] !== EMPTY) {\n                    bigOne[word][lang] = words[word];\n                }\n            }\n        }\n    }\n    // read actual words.js\n    var aWords = readWordJs();\n\n    var temporaryIgnore = ['flat.txt'];\n    if (aWords) {\n        // Merge words together\n        for (var w in aWords) {\n            if (aWords.hasOwnProperty(w)) {\n                if (!bigOne[w]) {\n                    console.warn('Take from actual ' + fileName + ': ' + w);\n                    bigOne[w] = aWords[w];\n                }\n                dirs.forEach(function (lang) {\n                    if (temporaryIgnore.indexOf(lang) !== -1) return;\n                    if (!bigOne[w][lang]) {\n                        console.warn('Missing \"' + lang + '\": ' + w);\n                    }\n                });\n            }\n        }\n\n    }\n\n    writeWordJs(bigOne, src);\n}\nfunction languages2words(src) {\n    var dirs = fs.readdirSync(src + 'i18n/');\n    var langs = {};\n    var bigOne = {};\n    var order = ['en', 'de', 'ru', 'pt', 'nl', 'fr', 'it', 'es', 'pl', 'zh-cn'];\n    dirs.sort(function (a, b) {\n        var posA = order.indexOf(a);\n        var posB = order.indexOf(b);\n        if (posA === -1 && posB === -1) {\n            if (a > b) return 1;\n            if (a < b) return -1;\n            return 0;\n        } else if (posA === -1) {\n            return -1;\n        } else if (posB === -1) {\n            return 1;\n        } else {\n            if (posA > posB) return 1;\n            if (posA < posB) return -1;\n            return 0;\n        }\n    });\n    for (var l = 0; l < dirs.length; l++) {\n        if (dirs[l] === 'flat.txt' || dirs[l] === '.i18n-editor-metadata') continue;\n        var lang = dirs[l];\n        langs[lang] = fs.readFileSync(src + 'i18n/' + lang + '/translations.json').toString();\n        langs[lang] = JSON.parse(langs[lang]);\n        var words = langs[lang];\n        for (var word in words) {\n            if (words.hasOwnProperty(word)) {\n                bigOne[word] = bigOne[word] || {};\n                if (words[word] !== EMPTY) {\n                    bigOne[word][lang] = words[word].replace(/<\\/ i>/g, '</i>').replace(/<\\/ b>/g, '</b>').replace(/<\\/ span>/g, '</span>').replace(/% s/g, ' %s');\n                }\n            }\n        }\n    }\n    // read actual words.js\n    var aWords = readWordJs();\n\n    var temporaryIgnore = [];\n    if (aWords) {\n        // Merge words together\n        for (var w in aWords) {\n            if (aWords.hasOwnProperty(w)) {\n                if (!bigOne[w]) {\n                    console.warn('Take from actual ' + fileName + ': ' + w);\n                    bigOne[w] = aWords[w];\n                }\n                dirs.forEach(function (lang) {\n                    if (temporaryIgnore.indexOf(lang) !== -1) return;\n                    if (!bigOne[w][lang]) {\n                        console.warn('Missing \"' + lang + '\": ' + w);\n                    }\n                });\n            }\n        }\n\n    }\n\n    writeWordJs(bigOne, src);\n}\n\ngulp.task('www (words.js => json)', done => {\n    words2languages('./src/');\n    done();\n});\n\ngulp.task('www (words.js => flat)', done => {\n    words2languagesFlat('./src/');\n    done();\n});\n\ngulp.task('www (flat => words.js)', done => {\n    languagesFlat2words('./src/');\n    done();\n});\n\ngulp.task('www (json => words.js)', done => {\n    languages2words('./src/');\n    done();\n});\n\ngulp.task('admin (words.js => json)', done => {\n    words2languages('./admin/');\n    done();\n});\n\ngulp.task('admin (words.js => flat)', done => {\n    words2languagesFlat('./admin/');\n    done();\n});\n\ngulp.task('admin (flat => words.js)', done => {\n    languagesFlat2words('./admin/');\n    done();\n});\n\ngulp.task('admin (json => words.js)', done => {\n    languages2words('./admin/');\n    done();\n});\n\ngulp.task('updatePackages', done => {\n    iopackage.common.version = pkg.version;\n    iopackage.common.news = iopackage.common.news || {};\n    if (!iopackage.common.news[pkg.version]) {\n        var news = iopackage.common.news;\n        var newNews = {};\n\n        newNews[pkg.version] = {\n            en: 'news',\n            de: 'neues',\n            ru: '\u043d\u043e\u0432\u043e\u0435',\n            pt: 'novidades',\n            nl: 'nieuws',\n            fr: 'nouvelles',\n            it: 'notizie',\n            es: 'noticias',\n            pl: 'aktualno\u015bci',\n            'zh-cn': '\u6d88\u606f'\n        };\n        iopackage.common.news = Object.assign(newNews, news);\n    }\n    fs.writeFileSync('io-package.json', JSON.stringify(iopackage, null, 4));\n    done();\n});\n\ngulp.task('updateReadme', done => {\n    var readme = fs.readFileSync('README.md').toString();\n    var pos = readme.indexOf('## Changelog\\n');\n    if (pos !== -1) {\n        var readmeStart = readme.substring(0, pos + '## Changelog\\n'.length);\n        var readmeEnd   = readme.substring(pos + '## Changelog\\n'.length);\n\n        if (readme.indexOf(version) === -1) {\n            var timestamp = new Date();\n            var date = timestamp.getFullYear() + '-' +\n                ('0' + (timestamp.getMonth() + 1).toString(10)).slice(-2) + '-' +\n                ('0' + (timestamp.getDate()).toString(10)).slice(-2);\n\n            var news = '';\n            if (iopackage.common.news && iopackage.common.news[pkg.version]) {\n                news += '* ' + iopackage.common.news[pkg.version].en;\n            }\n\n            fs.writeFileSync('README.md', readmeStart + '### ' + version + ' (' + date + ')\\n' + (news ? news + '\\n\\n' : '\\n') + readmeEnd);\n        }\n    }\n    done();\n});\n\ngulp.task('materializeCSS', () => {\n    return gulp.src(['./src/materialize-css/sass/**/*.scss'])\n        .pipe(sass({\n            paths: [ ]\n        }))\n        .pipe(concat('materialize.css'))\n        .pipe(cleanCSS({compatibility: 'ie8'}))\n        .pipe(gulp.dest('./www/lib/css'));\n\n});\n\ngulp.task('materializeJS', () => {\n    return gulp.src([\n        './src/materialize-css/js/global.js',\n        './src/materialize-css/js/component.js',\n        './src/materialize-css/js/anime.min.js',\n        './src/materialize-css/js/cash.js',\n        './src/materialize-css/js/cards.js',\n        './src/materialize-css/js/tabs.js',\n        './src/materialize-css/js/dropdown.js',\n        './src/materialize-css/js/toasts.js',\n        './src/materialize-css/js/modal.js',\n        './src/materialize-css/js/select.js',\n        './src/materialize-css/js/forms.js',\n        './src/materialize-css/js/range.js',\n        './src/materialize-css/js/collapsible.js',\n        './src/materialize-css/js/chips.js',\n        './src/materialize-css/js/datepicker.js',\n        './src/materialize-css/js/autocomplete.js',\n        './src/materialize-css/js/timepicker.js',\n        './src/materialize-css/js/tooltip.js',\n        './src/materialize-css/js/autocomplete.js',\n        './src/colorpicker/js/materialize-colorpicker.js'\n    ])\n    .pipe(sourcemaps.init())\n    .pipe(concat('materialize.js'))\n    .pipe(babel({\n        plugins: [\n            'transform-es2015-arrow-functions',\n            'transform-es2015-block-scoping',\n            'transform-es2015-classes',\n            'transform-es2015-template-literals'\n        ]\n    }))\n    .pipe(uglify())    \n    .pipe(sourcemaps.write('.'))\n    .pipe(gulp.dest('./www/lib/js'));\n});\n\ngulp.task('configCSS', () => {\n    return gulp.src([\n        './src/lib/css/iob/selectID.less',\n        './src/less/adapter.less',\n        './src/less/materializeCorrect.less'\n    ])\n        .pipe(sourcemaps.init())\n        .pipe(less({\n            paths: [ ]\n        }))\n        .pipe(concat('adapter.css'))\n        .pipe(cleanCSS({compatibility: 'ie8'}))\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/css'));\n});\n\ngulp.task('iobCSS', () => {\n    return gulp.src(['./src/lib/css/iob/*.less'])\n        .pipe(sourcemaps.init())\n        .pipe(less({\n            paths: [ ]\n        }))\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/lib/css/iob'));\n});\n\n// for older selectID\ngulp.task('adminCSS', () => {\n    return gulp.src(['./src/less/admin.less'])\n        .pipe(sourcemaps.init())\n        .pipe(less({\n            paths: [ ]\n        }))\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/css/'));\n});\n\ngulp.task('treeTableCSS', () => {\n    return gulp.src(['./src/lib/css/jquery.treetable.theme.less'])\n        .pipe(sourcemaps.init())\n        .pipe(less({\n            paths: [ ]\n        }))\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/lib/css'));\n});\n\ngulp.task('fancyTreeJS', () => {\n    return gulp.src([\n        './src/lib/js/jquery.fancytree-all.js'\n    ])\n        .pipe(sourcemaps.init())\n        .pipe(concat('jquery.fancytree-all.min.js'))\n        .pipe(uglify())\n        .on('error', function (err) {\n            log.error(colors.red('[Error] ') + err.toString());\n        })\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/lib/js'));\n});\n\ngulp.task('appJS', () => {\n    return gulp.src([\n        './src/js/*.js',\n        '!./src/js/adapter-settings.js'\n    ])\n        .pipe(sourcemaps.init())\n        .pipe(concat('app.js'))\n        .pipe(uglify())\n        .on('error', function (err) {\n            log.error(colors.red('[Error] ') + err.toString());\n        })\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/js'));\n});\n\ngulp.task('appHTML', () => {\n    return gulp.src([\n        './src/indexStart.html',\n        './src/admin*.html',\n        './src/indexEnd.html'\n    ])\n        .pipe(sourcemaps.init())\n        .pipe(concat('index.html'))\n        .pipe(htmlmin({collapseWhitespace: true, removeComments: true}))\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/'));\n});\n\ngulp.task('appCSS', () => {\n    return gulp.src([\n        './src/less/*.less',\n        './src/colorpicker/less/*.less',\n        '!./src/less/adapter.less'\n    ])\n        .pipe(sourcemaps.init())\n        .pipe(less({\n            paths: [ ]\n        }))\n        .pipe(concat('app.css'))\n        .pipe(cleanCSS({compatibility: 'ie8'}))\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/css'));\n});\n\ngulp.task('vendorJS', () => {\n    return gulp.src([\n        './src/lib/js/jquery-3.2.1.min.js',\n        './src/lib/js/jquery-migrate-3.0.1.js',\n        './src/lib/js/jquery-ui.min.js',\n        './src/lib/js/colResizable-1.6.js',\n        './src/lib/js/jquery.multiselect-1.13.min.js',\n        './src/lib/js/semver.min.js',\n        './src/lib/js/ace-1.2.0/ace.js',\n        './src/lib/js/loStorage.js',\n        './src/lib/js/translate.js',\n        './src/lib/js/jquery.fancytree-all.js',\n        './src/lib/js/jquery.treetable.js',\n        './src/lib/js/jquery.ui.touch-punch.min.js',\n        './src/lib/js/selectID.js',\n        './src/lib/js/cron/jquery.cron.locale.js',\n        './src/lib/js/cron/jquery.cron.words.js',\n        './src/lib/js/cron/jquery.cron.js',\n        './src/lib/js/cron/cron2text.js',\n        './src/lib/js/showdown.min.js'\n    ])\n        .pipe(sourcemaps.init())\n        .pipe(concat('vendor.js'))\n        .pipe(uglify())\n        .on('error', function (err) {\n            log.error(colors.red('[Error] ') + err.toString());\n        })\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/lib/js'));\n});\n\ngulp.task('colorpick.min', () => {\n    return gulp.src([\n        './src/lib/js/colResizable-1.6.js'\n    ])\n        .pipe(sourcemaps.init())\n        .pipe(concat('colResizable-1.6.min.js'))\n        .pipe(uglify())\n        .on('error', function (err) {\n            log.error(colors.red('[Error] ') + err.toString());\n        })\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/lib/js'));\n});\n\ngulp.task('appCopy', gulp.series('colorpick.min', () => {\n    return gulp.src([\n        './src/**/*.*',\n        '!./src/i18n/**/*',\n        '!./src/*.html',\n        '!./src/lib/js/jquery.migrate-3.0.1.js',\n        '!./src/lib/js/jquery.fancytree-all.js',\n        '!./src/lib/js/colResizable-1.6.js',\n        '!./src/**/*.less',\n        '!./src/js/**/admin*.js',\n        '!./src/js/**/words.js',\n        '!./src/materialize-css/**/*',\n        '!./src/colorpicker/**/*'\n    ])\n    .pipe(gulp.dest('./www'));\n    })\n);\n\ngulp.task('colorpickerCopy', () => {\n    return gulp.src([\n        './src/colorpicker/**/*.png'\n    ])\n        .pipe(gulp.dest('./www'));\n});\ngulp.task('aceCopy', () => {\n    return gulp.src([\n        './src/lib/js/ace-1.2.0/mode-json.js',\n        './src/lib/js/ace-1.2.0/worker-json.js'\n    ],  {base: './src/lib/js/ace-1.2.0/'})\n    .pipe(gulp.dest('./www'));\n});\ngulp.task('copy', gulp.parallel('appCopy', 'aceCopy', 'colorpickerCopy'));\n\ngulp.task('watch', () => {\n    gulp.watch('./src/css/*.less', ['lessApp']);\n    gulp.watch('./src/lib/css/iob/*.less', ['lessApp']);\n    gulp.watch(['./src/materialize-css/sass/**/*.scss'], ['sassMaterialize']);\n    gulp.watch(['./src/js/*.js'], ['compressApp']);\n});\n\ngulp.task('beta', done => {\n    var ioPack = require('./io-package.json');\n    var pack = require('./package.json');\n    ioPack.common.name = 'admin-beta';\n    ioPack.common.title = 'Admin Beta';\n    ioPack.native.port = 9081;\n    fs.writeFileSync('./io-package.json', JSON.stringify(ioPack, null, 2));\n    pack.name = 'iobroker.admin-beta';\n    fs.writeFileSync('./package.json', JSON.stringify(pack, null, 2));\n    done();\n});\n\ngulp.task('1_words',  gulp.parallel('www (json => words.js)', 'admin (json => words.js)'));\ngulp.task('2_css',    gulp.parallel('iobCSS', 'adminCSS', 'appCSS', 'treeTableCSS', 'configCSS', 'materializeCSS'));\ngulp.task('3_js',     gulp.parallel('vendorJS', 'materializeJS', 'appJS', 'fancyTreeJS')); //compressApp is last, to give the time for 1_words to be finshed. Because words.js is used in app.js\ngulp.task('4_static', gulp.parallel('appHTML', 'aceCopy', 'colorpickerCopy', 'appCopy'));\n\ngulp.task('default', gulp.series(\n    '1_words',\n    '2_css',\n    '3_js',\n    '4_static'));\n", "{\n  \"common\": {\n    \"name\": \"admin\",\n    \"title\": \"Admin\",\n    \"version\": \"3.6.7\",\n    \"news\": {\n      \"3.6.7\": {\n        \"en\": \"Add Node.JS version check to popup messages\",\n        \"de\": \"Node.JS-Versionspr\u00fcfung zu Popup-Nachrichten hinzuf\u00fcgen\",\n        \"ru\": \"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0443 \u0432\u0435\u0440\u0441\u0438\u0438 Node.JS \u0432\u043e \u0432\u0441\u043f\u043b\u044b\u0432\u0430\u044e\u0449\u0438\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\",\n        \"pt\": \"Adicione a verifica\u00e7\u00e3o da vers\u00e3o do Node.JS \u00e0s mensagens pop-up\",\n        \"nl\": \"Voeg Node.JS versiecontrole toe aan pop-upberichten\",\n        \"fr\": \"Ajouter la v\u00e9rification de la version de Node.JS aux messages contextuels\",\n        \"it\": \"Aggiungi il controllo versione Node.JS ai messaggi popup\",\n        \"es\": \"Agregar verificaci\u00f3n de versi\u00f3n de Node.JS a mensajes emergentes\",\n        \"pl\": \"Dodaj sprawdzanie wersji Node.JS do wyskakuj\u0105cych wiadomo\u015bci\",\n        \"zh-cn\": \"\u5c06Node.JS\u7248\u672c\u68c0\u67e5\u6dfb\u52a0\u5230\u5f39\u51fa\u6d88\u606f\"\n      },\n      \"3.6.6\": {\n        \"en\": \"update some words translation\",\n        \"de\": \"Aktualisieren Sie einige W\u00f6rter \u00dcbersetzung\",\n        \"ru\": \"\u043e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u043f\u0435\u0440\u0435\u0432\u043e\u0434 \u043d\u0435\u043a\u043e\u0442\u043e\u0440\u044b\u0445 \u0441\u043b\u043e\u0432\",\n        \"pt\": \"atualizar algumas palavras tradu\u00e7\u00e3o\",\n        \"nl\": \"update enkele woorden vertaling\",\n        \"fr\": \"mettre \u00e0 jour la traduction de quelques mots\",\n        \"it\": \"aggiorna la traduzione di alcune parole\",\n        \"es\": \"actualizar algunas palabras traducci\u00f3n\",\n        \"pl\": \"zaktualizuj t\u0142umaczenie niekt\u00f3rych s\u0142\u00f3w\",\n        \"zh-cn\": \"\u66f4\u65b0\u4e00\u4e9b\u5355\u8bcd\u7ffb\u8bd1\"\n      },\n      \"3.6.5\": {\n        \"en\": \"Fix anoying popups from info adapter\",\n        \"de\": \"Beheben Sie \u00e4rgerliche Popups vom Info-Adapter\",\n        \"ru\": \"\u0418\u0441\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u0432\u0441\u043f\u043b\u044b\u0432\u0430\u044e\u0449\u0438\u0445 \u0432\u0441\u043f\u043b\u044b\u0432\u0430\u044e\u0449\u0438\u0445 \u043e\u043a\u043e\u043d \u0438\u0437 \u0430\u0434\u0430\u043f\u0442\u0435\u0440\u0430\",\n        \"pt\": \"Corrija pop-ups irritantes do adaptador de informa\u00e7\u00f5es\",\n        \"nl\": \"Bevestig vervelende pop-ups van de info-adapter\",\n        \"fr\": \"Corrige les popups ennuyeux depuis l'adaptateur info\",\n        \"it\": \"Correggi i popup di anoying dall'adattatore informazioni\",\n        \"es\": \"Arreglar ventanas emergentes molestas desde el adaptador de informaci\u00f3n\",\n        \"pl\": \"Napraw wyskakuj\u0105ce okienka z adaptera informacyjnego\",\n        \"zh-cn\": \"\u4ece\u4fe1\u606f\u9002\u914d\u5668\u4fee\u590d\u607c\u4eba\u7684\u5f39\u51fa\u7a97\u53e3\"\n      },\n      \"3.6.4\": {\n        \"en\": \"Update nodejs recommendation message and check to recommend nodejs 10\",\n        \"ru\": \"\u041e\u0431\u043d\u043e\u0432\u0438\u0442\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435 \u0441 \u0440\u0435\u043a\u043e\u043c\u0435\u043d\u0434\u0430\u0446\u0438\u0435\u0439 nodejs \u0438 \u043f\u0440\u043e\u0432\u0435\u0440\u044c\u0442\u0435, \u0447\u0442\u043e\u0431\u044b \u0440\u0435\u043a\u043e\u043c\u0435\u043d\u0434\u043e\u0432\u0430\u0442\u044c nodejs 10\",\n        \"de\": \"Aktualisieren der Empfehlungsnachricht von nodejs, um nodejs 10 zu empfehlen\",\n        \"fr\": \"Mettre \u00e0 jour le message de recommandation nodejs et v\u00e9rifier pour recommander nodejs 10\",\n        \"nl\": \"Update nodejs aanbevelingsbericht en controleer om nodejs 10 aan te bevelen\",\n        \"it\": \"Aggiorna il messaggio di raccomandazione nodejs e verifica per raccomandare nodejs 10\",\n        \"pl\": \"Zaktualizuj wiadomo\u015b\u0107 rekomendacji nodejs anc sprawd\u017a, aby poleci\u0107 nodejs 10\",\n        \"es\": \"Actualice el mensaje de recomendaci\u00f3n de nodejs y revise para recomendar nodejs 10\",\n        \"pt\": \"Atualize a mensagem de recomenda\u00e7\u00e3o do nodejs e cheque para recomendar o nodejs 10\",\n        \"zh-cn\": \"\u66f4\u65b0nodejs\u63a8\u8350\u6d88\u606f\u548c\u68c0\u67e5\u4ee5\u63a8\u8350nodejs 10\"\n      },\n      \"3.6.3\": {\n        \"en\": \"Added deleteFile internal function\",\n        \"de\": \"Interne Funktion deleteFile hinzugef\u00fcgt\",\n        \"ru\": \"\u0414\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u0430 \u200b\u200b\u0432\u043d\u0443\u0442\u0440\u0435\u043d\u043d\u044f\u044f \u0444\u0443\u043d\u043a\u0446\u0438\u044f deleteFile\",\n        \"pt\": \"Adicionado fun\u00e7\u00e3o interna deleteFile\",\n        \"nl\": \"De interne functie deleteFile toegevoegd\",\n        \"fr\": \"Ajout de la fonction interne deleteFile\",\n        \"it\": \"Aggiunta la funzione interna deleteFile\",\n        \"es\": \"Agregada funci\u00f3n interna deleteFile\",\n        \"pl\": \"Dodano funkcj\u0119 wewn\u0119trzn\u0105 deleteFile\",\n        \"zh-cn\": \"\u6dfb\u52a0\u4e86deleteFile\u5185\u90e8\u51fd\u6570\"\n      },\n      \"3.6.2\": {\n        \"en\": \"Added onSave handler for custom dialogs\",\n        \"de\": \"OnSave-Handler f\u00fcr benutzerdefinierte Dialoge hinzugef\u00fcgt\",\n        \"ru\": \"\u0414\u043e\u0431\u0430\u0432\u043b\u0435\u043d \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0447\u0438\u043a onSave \u0434\u043b\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c\u0441\u043a\u0438\u0445 \u0434\u0438\u0430\u043b\u043e\u0433\u043e\u0432\",\n        \"pt\": \"Adicionado manipulador onSave para di\u00e1logos personalizados\",\n        \"nl\": \"Toegevoegd onSave handler voor aangepaste dialogen\",\n        \"fr\": \"Ajout du gestionnaire onSave pour les bo\u00eetes de dialogue personnalis\u00e9es\",\n        \"it\": \"Aggiunto il gestore onSave per le finestre di dialogo personalizzate\",\n        \"es\": \"A\u00f1adido onSave handler para di\u00e1logos personalizados\",\n        \"pl\": \"Dodano obs\u0142ug\u0119 onSave dla niestandardowych okien dialogowych\",\n        \"zh-cn\": \"\u4e3a\u81ea\u5b9a\u4e49\u5bf9\u8bdd\u6846\u6dfb\u52a0\u4e86onSave\u5904\u7406\u7a0b\u5e8f\"\n      },\n      \"3.6.1\": {\n        \"en\": \"Info adpater integration\",\n        \"de\": \"Integration des Informationsadapters\",\n        \"ru\": \"\u0418\u043d\u0442\u0435\u0433\u0440\u0430\u0446\u0438\u044f \u0441 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u043e\u043d\u043d\u044b\u043c \u0430\u0434\u0430\u043f\u0442\u0435\u0440\u043e\u043c\",\n        \"pt\": \"Integra\u00e7\u00e3o do adaptador de informa\u00e7\u00f5es\",\n        \"nl\": \"Integratie van infodapter\",\n        \"fr\": \"Int\u00e9gration de l'adaptateur d'informations\",\n        \"it\": \"Integrazione dell'adattatore di informazioni\",\n        \"es\": \"Integraci\u00f3n del adaptador de informaci\u00f3n\",\n        \"pl\": \"Integracja adaptera informacyjnego\",\n        \"zh-cn\": \"\u4fe1\u606f\u9002\u914d\u5668\u96c6\u6210\"\n      },    \n      \"3.6.0\": {\n        \"en\": \"Added Chinese translations\\nNew informative states added about updates\",\n        \"de\": \"Chinesische \u00dcbersetzungen hinzugef\u00fcgt\\nNeue Informationsst\u00e4nde zu Updates hinzugef\u00fcgt\",\n        \"ru\": \"\u0414\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u044b \u043a\u0438\u0442\u0430\u0439\u0441\u043a\u0438\u0435 \u043f\u0435\u0440\u0435\u0432\u043e\u0434\u044b\\n\u0414\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u044b \u043d\u043e\u0432\u044b\u0435 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u043e\u043d\u043d\u044b\u0435 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u044f \u043e\u0431 \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u044f\u0445\",\n        \"pt\": \"Adicionado tradu\u00e7\u00f5es chinesas\\nNovos estados informativos adicionados sobre atualiza\u00e7\u00f5es\",\n        \"nl\": \"Chinese vertalingen toegevoegd\\nNieuwe informatieve staten toegevoegd over updates\",\n        \"fr\": \"Ajout de traductions chinoises\\nNouveaux \u00e9tats informatifs ajout\u00e9s \u00e0 propos des mises \u00e0 jour\",\n        \"it\": \"Aggiunte traduzioni in cinese\\nNuovi stati informativi aggiunti sugli aggiornamenti\",\n        \"es\": \"Traducciones en chino a\u00f1adido\\nNuevos estados informativos a\u00f1adidos sobre actualizaciones.\",\n        \"pl\": \"Dodano chi\u0144skie t\u0142umaczenia\\nDodano nowe informacje informacyjne o aktualizacjach\",\n        \"zh-cn\": \"\u589e\u52a0\u4e86\u4e2d\u6587\u7ffb\u8bd1\\n\u65b0\u7684\u4fe1\u606f\u72b6\u6001\u589e\u52a0\u4e86\u66f4\u65b0\"\n      },\n      \"3.5.10\": {\n        \"en\": \"Too many debug outputs were disabled\",\n        \"de\": \"Zu viele Debug-Ausgaben wurden deaktiviert\",\n        \"ru\": \"\u041e\u0442\u043a\u043b\u044e\u0447\u0435\u043d\u0430 \u043e\u0442\u043b\u0430\u0434\u043e\u0447\u043d\u0430\u044f \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044f\",\n        \"pt\": \"Muitas sa\u00eddas de depura\u00e7\u00e3o foram desativadas\",\n        \"nl\": \"Te veel foutopsporingsuitgangen waren uitgeschakeld\",\n        \"fr\": \"Trop de sorties de d\u00e9bogage ont \u00e9t\u00e9 d\u00e9sactiv\u00e9es\",\n        \"it\": \"Troppe uscite di debug sono state disabilitate\",\n        \"es\": \"Demasiadas salidas de depuraci\u00f3n fueron deshabilitadas\",\n        \"pl\": \"Zbyt wiele wynik\u00f3w debugowania zosta\u0142o wy\u0142\u0105czonych\"\n      },\n      \"3.5.0\": {\n        \"en\": \"Editing of enums was changed\\nLogo was updated\\nThe function icons were added\",\n        \"de\": \"Die Bearbeitung der Enums wurde ge\u00e4ndert\\nDas Logo wurde aktualisiert\\nDie Funktionssymbole wurden hinzugef\u00fcgt\",\n        \"ru\": \"\u0418\u0437\u043c\u0435\u043d\u0435\u043d\u043e \u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u043f\u0435\u0440\u0435\u0447\u0438\u0441\u043b\u0435\u043d\u0438\u0439\\n\u041b\u043e\u0433\u043e\u0442\u0438\u043f \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\\n\u0417\u043d\u0430\u0447\u043a\u0438 \u0444\u0443\u043d\u043a\u0446\u0438\u0439 \u0434\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u044b\",\n        \"pt\": \"Edi\u00e7\u00e3o de enums foi alterada\\nLogo foi atualizado\\nOs \u00edcones de fun\u00e7\u00e3o foram adicionados\",\n        \"nl\": \"Het bewerken van de enums is gewijzigd\\nLogo is bijgewerkt\\nDe functiepictogrammen zijn toegevoegd\",\n        \"fr\": \"L'\u00e9dition des \u00e9num\u00e9rations a \u00e9t\u00e9 modifi\u00e9e\\nLe logo a \u00e9t\u00e9 mis \u00e0 jour\\nLes ic\u00f4nes de fonctions ont \u00e9t\u00e9 ajout\u00e9es\",\n        \"it\": \"La modifica delle enumerazioni \u00e8 stata modificata\\nIl logo \u00e8 stato aggiornato\\nLe icone delle funzioni sono state aggiunte\",\n        \"es\": \"Se modific\u00f3 la edici\u00f3n de enumeraciones\\nLogotipo fue actualizado\\nSe agregaron los \u00edconos de funci\u00f3n\",\n        \"pl\": \"Zmieniono edycj\u0119 wylicze\u0144\\nLogo zosta\u0142o zaktualizowane\\nDodano ikony funkcji\"\n      },\n      \"2.0.11\": {\n        \"en\": \"Configurable event update disable threshold\",\n        \"de\": \"Konfigurierbar Schwellenwert f\u00fcr Ereignisses\",\n        \"ru\": \"\u041d\u0430\u0441\u0442\u0440\u0430\u0438\u0432\u0430\u0435\u043c\u043e\u0435 \u043f\u043e\u0440\u043e\u0433\u043e\u0432\u043e\u0435 \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 \u043e\u0442\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u044f \u0441\u043e\u0431\u044b\u0442\u0438\u0439\",\n        \"pt\": \"Limite configur\u00e1vel para o n\u00famero de eventos\"\n      }\n    },\n    \"desc\": {\n      \"en\": \"The configuration of ioBroker via Web-Interface\",\n      \"de\": \"Die Konfiguration von ioBroker \u00fcber das Web-Interface\",\n      \"ru\": \"\u041a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u044f ioBroker \u0447\u0435\u0440\u0435\u0437 \u0432\u0435\u0431-\u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\",\n      \"pt\": \"A configura\u00e7\u00e3o do ioBroker via Web-Interface\",\n      \"fr\": \"La configuration de ioBroker via Web-Interface\",\n      \"nl\": \"De configuratie van ioBroker via de webinterface\",\n      \"it\": \"La configurazione di ioBroker tramite interfaccia Web\",\n      \"zh-cn\": \"\u914d\u7f6eioBroker\u7684Web\u754c\u9762\"\n    },\n    \"docs\": {\n      \"en\": \"docs/en/admin.md\",\n      \"ru\": \"docs/ru/admin.md\",\n      \"de\": [\n        \"docs/de/admin.md\",\n        \"docs/de/admin/tab-adapters.md\",\n        \"docs/de/admin/tab-instances.md\",\n        \"docs/de/admin/tab-objects.md\",\n        \"docs/de/admin/tab-states.md\",\n        \"docs/de/admin/tab-groups.md\",\n        \"docs/de/admin/tab-users.md\",\n        \"docs/de/admin/tab-events.md\",\n        \"docs/de/admin/tab-hosts.md\",\n        \"docs/de/admin/tab-enums.md\",\n        \"docs/de/admin/tab-log.md\",\n        \"docs/de/admin/tab-system.md\"\n      ],\n      \"pt\": \"docs/pt/admin.md\",\n      \"nl\": \"docs/nl/admin.md\",\n      \"es\": \"docs/es/admin.md\",\n      \"fr\": \"docs/fr/admin.md\",\n      \"it\": \"docs/it/admin.md\",\n      \"pl\": \"docs/pl/admin.md\",\n      \"zh-cn\": \"docs/zh-cn/admin.md\"            \n    },\n    \"materialize\": true,\n    \"mode\": \"daemon\",\n    \"platform\": \"Javascript/Node.js\",\n    \"loglevel\": \"info\",\n    \"icon\": \"admin.png\",\n    \"messagebox\": true,\n    \"enabled\": true,\n    \"extIcon\": \"https://raw.githubusercontent.com/ioBroker/ioBroker.admin/master/admin/admin.png\",\n    \"keywords\": [\n      \"setup\",\n      \"config\",\n      \"update\",\n      \"upgrade\",\n      \"system\",\n      \"konfiguration\",\n      \"administration\",\n      \"einrichtung\",\n      \"wartung\"\n    ],\n    \"compact\": true,\n    \"readme\": \"https://github.com/ioBroker/ioBroker.admin/blob/master/README.md\",\n    \"authors\": [\n      \"bluefox <bluefox@ccu.io>\",\n      \"hobbyquaker <hq@ccu.io>\"\n    ],\n    \"dependencies\": [\n      {\n        \"js-controller\": \">=1.2.0\"\n      }\n    ],\n    \"type\": \"general\",\n    \"license\": \"MIT\",\n    \"logTransporter\": true,\n    \"stopBeforeUpdate\": true,\n    \"wwwDontUpload\": true,\n    \"nogit\": true,\n    \"welcomeScreenPro\": {\n      \"link\": \"admin/index.html\",\n      \"name\": \"Admin\",\n      \"img\": \"admin/img/admin.png\",\n      \"color\": \"pink\",\n      \"order\": 5,\n      \"localLink\": true\n    },\n    \"localLink\": \"%protocol%://%ip%:%port%\"\n  },\n  \"native\": {\n    \"port\": 8081,\n    \"auth\": false,\n    \"secure\": false,\n    \"bind\": \"0.0.0.0\",\n    \"cache\": false,\n\n    \"certPublic\": \"\",\n    \"certPrivate\": \"\",\n    \"certChained\": \"\",\n\n    \"ttl\": 3600,\n    \"defaultUser\": \"admin\",\n    \"tmpPath\": \"/tmp\",\n    \"tmpPathAllow\": false,\n    \"thresholdValue\": 200,\n\n    \"leEnabled\": false,\n    \"leUpdate\": false,\n    \"leCheckPort\": 80,\n\n    \"loginBackgroundColor\": \"\",\n    \"loginBackgroundImage\": false,\n    \"loginHideLogo\": false,\n    \"loginMotto\": \"\"\n  },\n  \"objects\": [],\n  \"instanceObjects\": [\n    {\n      \"_id\": \"info\",\n      \"type\": \"channel\",\n      \"common\": {\n        \"name\": \"Information\"\n      },\n      \"native\": {}\n    },\n    {\n      \"_id\": \"\",\n      \"type\": \"meta\",\n      \"common\": {\n        \"name\": \"user files and images for background image\",\n        \"type\": \"meta.user\"\n      },\n      \"native\": {}\n    },\n    {\n      \"_id\": \"connected\",\n      \"type\": \"state\",\n      \"common\": {\n        \"name\": \"Info about connected socket clients\",\n        \"type\": \"string\",\n        \"read\":  true,\n        \"write\": false,\n        \"role\":  \"text\"\n      }\n    }\n  ]\n}\n", "/* jshint -W097 */\r\n/* jshint strict: false */\r\n/* jslint node: true */\r\n/* jshint -W061 */\r\n'use strict';\r\n\r\nconst socketio = require('socket.io');\r\nconst request  = require('request');\r\nconst path     = require('path');\r\nconst fs       = require('fs');\r\n\r\nfunction IOSocket(server, settings, adapter, objects, states, store) {\r\n    if (!(this instanceof IOSocket)) return new IOSocket(server, settings, adapter, objects, states, store);\r\n\r\n    const userKey = 'connect.sid'; // const\r\n    const cmdSessions = {};\r\n    const that = this;\r\n    this.server = null;\r\n    this.subscribes = {};\r\n    let cookieParser;\r\n    let passport;\r\n\r\n    if (settings.auth) {\r\n        cookieParser = require('cookie-parser');\r\n        passport     = require('passport');\r\n    }\r\n\r\n    const passportSocketIo = require('passport.socketio');\r\n\r\n    // do not send too many state updates\r\n    const eventsThreshold = {\r\n        count: 0,\r\n        timeActivated: 0,\r\n        active: false,\r\n        accidents: 0,\r\n        repeatSeconds: 3,   // how many seconds continuously must be number of events > value\r\n        value: parseInt(settings.thresholdValue, 10) || 200, // how many events allowed in one check interval\r\n        checkInterval: 1000 // duration of one check interval\r\n    };\r\n\r\n    // static information\r\n    const commandsPermissions = {\r\n        getObject:          {type: 'object',    operation: 'read'},\r\n        getObjects:         {type: 'object',    operation: 'list'},\r\n        getObjectView:      {type: 'object',    operation: 'list'},\r\n        setObject:          {type: 'object',    operation: 'write'},\r\n        requireLog:         {type: 'object',    operation: 'write'}, // just mapping to some command\r\n        delObject:          {type: 'object',    operation: 'delete'},\r\n        extendObject:       {type: 'object',    operation: 'write'},\r\n        getHostByIp:        {type: 'object',    operation: 'list'},\r\n        subscribeObjects:   {type: 'object',    operation: 'read'},\r\n        unsubscribeObjects: {type: 'object',    operation: 'read'},\r\n\r\n        getStates:          {type: 'state',     operation: 'list'},\r\n        getState:           {type: 'state',     operation: 'read'},\r\n        setState:           {type: 'state',     operation: 'write'},\r\n        delState:           {type: 'state',     operation: 'delete'},\r\n        createState:        {type: 'state',     operation: 'create'},\r\n        subscribe:          {type: 'state',     operation: 'read'},\r\n        unsubscribe:        {type: 'state',     operation: 'read'},\r\n        getStateHistory:    {type: 'state',     operation: 'read'},\r\n        getVersion:         {type: '',          operation: ''},\r\n\r\n        addUser:            {type: 'users',     operation: 'create'},\r\n        delUser:            {type: 'users',     operation: 'delete'},\r\n        addGroup:           {type: 'users',     operation: 'create'},\r\n        delGroup:           {type: 'users',     operation: 'delete'},\r\n        changePassword:     {type: 'users',     operation: 'write'},\r\n\r\n        httpGet:            {type: 'other',     operation: 'http'},\r\n        cmdExec:            {type: 'other',     operation: 'execute'},\r\n        sendTo:             {type: 'other',     operation: 'sendto'},\r\n        sendToHost:         {type: 'other',     operation: 'sendto'},\r\n        readLogs:           {type: 'other',     operation: 'execute'},\r\n\r\n        readDir:            {type: 'file',      operation: 'list'},\r\n        createFile:         {type: 'file',      operation: 'create'},\r\n        writeFile:          {type: 'file',      operation: 'write'},\r\n        readFile:           {type: 'file',      operation: 'read'},\r\n        deleteFile:         {type: 'file',      operation: 'delete'},\r\n        readFile64:         {type: 'file',      operation: 'read'},\r\n        writeFile64:        {type: 'file',      operation: 'write'},\r\n        unlink:             {type: 'file',      operation: 'delete'},\r\n        rename:             {type: 'file',      operation: 'write'},\r\n        mkdir:              {type: 'file',      operation: 'write'},\r\n        chmodFile:          {type: 'file',      operation: 'write'},\r\n\r\n        authEnabled:        {type: '',          operation: ''},\r\n        disconnect:         {type: '',          operation: ''},\r\n        listPermissions:    {type: '',          operation: ''},\r\n        getUserPermissions: {type: 'object',    operation: 'read'}\r\n    };\r\n\r\n    function addUser(user, pw, options, callback) {\r\n        if (typeof options === 'function') {\r\n            callback = options;\r\n            options = null;\r\n        }\r\n\r\n        if (!user.match(/^[-.A-Za-z\u00fc\u00e4\u00f6\u00df\u00d6\u00c4\u00dc\u0430-\u044f\u0410-\u042f@+$\u00a70-9=?!&# ]+$/)) {\r\n            if (typeof callback === 'function') {\r\n                callback('Invalid characters in the name. Only following special characters are allowed: -@+$\u00a7=?!&# and letters');\r\n            }\r\n            return;\r\n        }\r\n\r\n        adapter.getForeignObject('system.user.' + user, options, function (err, obj) {\r\n            if (obj) {\r\n                if (typeof callback === 'function') {\r\n                    callback('User yet exists');\r\n                }\r\n            } else {\r\n                adapter.setForeignObject('system.user.' + user, {\r\n                    type: 'user',\r\n                    common: {\r\n                        name: user,\r\n                        enabled: true,\r\n                        groups: []\r\n                    }\r\n                }, options, function () {\r\n                    adapter.setPassword(user, pw, callback);\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    function delUser(user, options, callback) {\r\n        adapter.getForeignObject('system.user.' + user, options, function (err, obj) {\r\n            if (err || !obj) {\r\n                if (typeof callback === 'function') {\r\n                    callback('User does not exist');\r\n                }\r\n            } else {\r\n                if (obj.common.dontDelete) {\r\n                    if (typeof callback === 'function') {\r\n                        callback('Cannot delete user, while is system user');\r\n                    }\r\n                } else {\r\n                    adapter.delForeignObject('system.user.' + user, options, function (err) {\r\n                        // Remove this user from all groups in web client\r\n                        if (typeof callback === 'function') {\r\n                            callback(err);\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    function addGroup(group, desc, acl, options, callback) {\r\n        let name = group;\r\n        if (typeof acl === 'function') {\r\n            callback = acl;\r\n            acl = null;\r\n        }\r\n        if (typeof desc === 'function') {\r\n            callback = desc;\r\n            desc = null;\r\n        }\r\n        if (typeof options === 'function') {\r\n            callback = options;\r\n            options = null;\r\n        }\r\n        if (name && name.substring(0, 1) !== name.substring(0, 1).toUpperCase()) {\r\n            name = name.substring(0, 1).toUpperCase() + name.substring(1);\r\n        }\r\n        group = group.substring(0, 1).toLowerCase() + group.substring(1);\r\n\r\n        if (!group.match(/^[-.A-Za-z\u00fc\u00e4\u00f6\u00df\u00d6\u00c4\u00dc\u0430-\u044f\u0410-\u042f@+$\u00a70-9=?!&#_ ]+$/)) {\r\n            if (typeof callback === 'function') {\r\n                callback('Invalid characters in the group name. Only following special characters are allowed: -@+$\u00a7=?!&# and letters');\r\n            }\r\n            return;\r\n        }\r\n\r\n        adapter.getForeignObject('system.group.' + group, options, function (err, obj) {\r\n            if (obj) {\r\n                if (typeof callback === 'function') {\r\n                    callback('Group yet exists');\r\n                }\r\n            } else {\r\n                obj = {\r\n                    _id:  'system.group.' + group,\r\n                    type: 'group',\r\n                    common: {\r\n                        name: name,\r\n                        desc: desc,\r\n                        members: [],\r\n                        acl: acl\r\n                    }\r\n                };\r\n                adapter.setForeignObject('system.group.' + group, obj, options, function (err) {\r\n                    if (typeof callback === 'function') {\r\n                        callback(err, obj);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    function delGroup(group, options, callback) {\r\n        adapter.getForeignObject('system.group.' + group, options, (err, obj) => {\r\n            if (err || !obj) {\r\n                if (typeof callback === 'function') {\r\n                    callback('Group does not exist');\r\n                }\r\n            } else {\r\n                if (obj.common.dontDelete) {\r\n                    if (typeof callback === 'function') {\r\n                        callback('Cannot delete group, while is system group');\r\n                    }\r\n                } else {\r\n                    adapter.delForeignObject('system.group.' + group, options, err =>\r\n                        // Remove this group from all users in web client\r\n                        typeof callback === 'function' && callback(err));\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    // update session ID, but not ofter than 60 seconds\r\n    function updateSession(socket) {\r\n        if (socket._sessionID) {\r\n            const time = (new Date()).getTime();\r\n            if (socket._lastActivity && time - socket._lastActivity > adapter.config.ttl * 1000) {\r\n                socket.emit('reauthenticate');\r\n                return false;\r\n            }\r\n            socket._lastActivity = time;\r\n            if (!socket._sessionTimer) {\r\n                socket._sessionTimer = setTimeout(() => {\r\n                    socket._sessionTimer = null;\r\n                    adapter.getSession(socket._sessionID, obj => {\r\n                        if (obj) {\r\n                            adapter.setSession(socket._sessionID, adapter.config.ttl, obj);\r\n                        } else {\r\n                            socket.emit('reauthenticate');\r\n                        }\r\n                    });\r\n                }, 60000);\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n\r\n    function checkPermissions(socket, command, callback, arg) {\r\n        if (socket._acl.user !== 'system.user.admin') {\r\n            // type: file, object, state, other\r\n            // operation: create, read, write, list, delete, sendto, execute, sendToHost, readLogs\r\n            if (commandsPermissions[command]) {\r\n                // If permission required\r\n                if (commandsPermissions[command].type) {\r\n                    if (socket._acl[commandsPermissions[command].type] &&\r\n                        socket._acl[commandsPermissions[command].type][commandsPermissions[command].operation]) {\r\n                        return true;\r\n                    } else {\r\n                        adapter.log.warn('No permission for \"' + socket._acl.user + '\" to call ' + command + '. Need \"' + commandsPermissions[command].type + '\".\"' + commandsPermissions[command].operation + '\"');\r\n                    }\r\n                } else {\r\n                    return true;\r\n                }\r\n            } else {\r\n                adapter.log.warn('No rule for command: ' + command);\r\n            }\r\n\r\n            if (typeof callback === 'function') {\r\n                callback('permissionError');\r\n            } else {\r\n                if (commandsPermissions[command]) {\r\n                    socket.emit('permissionError', {\r\n                        command: command,\r\n                        type: commandsPermissions[command].type,\r\n                        operation: commandsPermissions[command].operation,\r\n                        arg: arg\r\n                    });\r\n                } else {\r\n                    socket.emit('permissionError', {\r\n                        command: command,\r\n                        arg: arg\r\n                    });\r\n                }\r\n            }\r\n            return false;\r\n        } else {\r\n            return true;\r\n        }\r\n    }\r\n\r\n    function checkObject(id, options, flag) {\r\n        // read rights of object\r\n        if (!objects[id] || !objects[id].common || !objects[id].acl || flag === 'list') {\r\n            return true;\r\n        }\r\n\r\n        if (options.user !== 'system.user.admin' &&\r\n            options.groups.indexOf('system.group.administrator') === -1) {\r\n            if (objects[id].acl.owner !== options.user) {\r\n                // Check if the user is in the group\r\n                if (options.groups.indexOf(objects[id].acl.ownerGroup) !== -1) {\r\n                    // Check group rights\r\n                    if (!(objects[id].acl.object & (flag << 4))) {\r\n                        return false\r\n                    }\r\n                } else {\r\n                    // everybody\r\n                    if (!(objects[id].acl.object & flag)) {\r\n                        return false\r\n                    }\r\n                }\r\n            } else {\r\n                // Check group rights\r\n                if (!(objects[id].acl.object & (flag << 8))) {\r\n                    return false\r\n                }\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n\r\n    function getAllObjects(socket, callback) {\r\n        if (updateSession(socket) && checkPermissions(socket, 'getObjects', callback)) {\r\n            if (socket._acl &&\r\n                socket._acl.user !== 'system.user.admin' &&\r\n                socket._acl.groups.indexOf('system.group.administrator') === -1) {\r\n                const result = {};\r\n                for (const ob in objects) {\r\n                    if (objects.hasOwnProperty(ob) && checkObject(ob, socket._acl, 4 /* 'read' */)) {\r\n                        result[ob] = objects[ob];\r\n                    }\r\n                }\r\n                callback(null, result);\r\n            } else {\r\n                if (typeof callback === 'function') {\r\n                    callback(null, objects);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    function pattern2RegEx(pattern) {\r\n        if (!pattern) {\r\n            return null;\r\n        }\r\n        if (pattern !== '*') {\r\n            if (pattern[0] === '*' && pattern[pattern.length - 1] !== '*') pattern += '$';\r\n            if (pattern[0] !== '*' && pattern[pattern.length - 1] === '*') pattern = '^' + pattern;\r\n        }\r\n        pattern = pattern.replace(/\\./g, '\\\\.');\r\n        pattern = pattern.replace(/\\*/g, '.*');\r\n        pattern = pattern.replace(/\\[/g, '\\\\[');\r\n        pattern = pattern.replace(/]/g, '\\\\]');\r\n        pattern = pattern.replace(/\\(/g, '\\\\(');\r\n        pattern = pattern.replace(/\\)/g, '\\\\)');\r\n        return pattern;\r\n    }\r\n\r\n    this.subscribe = function (socket, type, pattern) {\r\n        //console.log((socket._name || socket.id) + ' subscribe ' + pattern);\r\n        if (socket) {\r\n            socket._subscribe = socket._subscribe || {};\r\n        }\r\n        if (!this.subscribes[type]) this.subscribes[type] = {};\r\n\r\n        let s;\r\n        if (socket) {\r\n            s = socket._subscribe[type] = socket._subscribe[type] || [];\r\n            for (let i = 0; i < s.length; i++) {\r\n                if (s[i].pattern === pattern) return;\r\n            }\r\n        }\r\n\r\n        let p = pattern2RegEx(pattern);\r\n        if (p === null) {\r\n            adapter.log.warn('Empty pattern!');\r\n            return;\r\n        }\r\n        if (socket) {\r\n            s.push({pattern: pattern, regex: new RegExp(p)});\r\n        }\r\n\r\n        if (this.subscribes[type][pattern] === undefined) {\r\n            this.subscribes[type][pattern] = 1;\r\n            if (type === 'stateChange') {\r\n                adapter.log.debug('Subscribe STATES: ' + pattern);\r\n                adapter.subscribeForeignStates(pattern);\r\n            } else if (type === 'objectChange') {\r\n                adapter.log.debug('Subscribe OBJECTS: ' + pattern);\r\n                adapter.subscribeForeignObjects && adapter.subscribeForeignObjects(pattern);\r\n            } else if (type === 'log') {\r\n                adapter.log.debug('Subscribe LOGS');\r\n                adapter.requireLog && adapter.requireLog(true);\r\n            }\r\n        } else {\r\n            this.subscribes[type][pattern]++;\r\n        }\r\n    };\r\n\r\n    function showSubscribes(socket, type) {\r\n        if (socket && socket._subscribe) {\r\n            const s = socket._subscribe[type] || [];\r\n            const ids = [];\r\n            for (let i = 0; i < s.length; i++) {\r\n                ids.push(s[i].pattern);\r\n            }\r\n            adapter.log.debug('Subscribes: ' + ids.join(', '));\r\n        } else {\r\n            adapter.log.debug('Subscribes: no subscribes');\r\n        }\r\n    }\r\n\r\n    function updateConnectedInfo() {\r\n        if (that.infoTimeout) {\r\n            clearTimeout(that.infoTimeout);\r\n            that.infoTimeout = null;\r\n        }\r\n        if (that.server.sockets) {\r\n            let text = '';\r\n            let cnt = 0;\r\n            if (that.server) {\r\n                let clients = that.server.sockets.connected;\r\n\r\n                for (let i in clients) {\r\n                    if (clients.hasOwnProperty(i)) {\r\n                        text += (text ? ', ' : '') + (clients[i]._name || 'noname');\r\n                        cnt++;\r\n                    }\r\n                }\r\n            }\r\n            text = '[' + cnt + ']' + text;\r\n            adapter.setState('connected', text, true);\r\n        }\r\n    }\r\n\r\n    this.unsubscribe = function (socket, type, pattern) {\r\n        //console.log((socket._name || socket.id) + ' unsubscribe ' + pattern);\r\n        if (!this.subscribes[type]) this.subscribes[type] = {};\r\n\r\n        if (socket) {\r\n            if (!socket._subscribe || !socket._subscribe[type]) return;\r\n            for (let i = socket._subscribe[type].length - 1; i >= 0; i--) {\r\n                if (socket._subscribe[type][i].pattern === pattern) {\r\n\r\n                    // Remove pattern from global list\r\n                    if (this.subscribes[type][pattern] !== undefined) {\r\n                        this.subscribes[type][pattern]--;\r\n                        if (this.subscribes[type][pattern] <= 0) {\r\n                            if (type === 'stateChange') {\r\n                                adapter.log.debug('Unsubscribe STATES: ' + pattern);\r\n                                //console.log((socket._name || socket.id) + ' unsubscribeForeignStates ' + pattern);\r\n                                adapter.unsubscribeForeignStates(pattern);\r\n                            } else if (type === 'objectChange') {\r\n                                adapter.log.debug('Unsubscribe OBJECTS: ' + pattern);\r\n                                //console.log((socket._name || socket.id) + ' unsubscribeForeignObjects ' + pattern);\r\n                                if (adapter.unsubscribeForeignObjects) adapter.unsubscribeForeignObjects(pattern);\r\n                            } else if (type === 'log') {\r\n                                //console.log((socket._name || socket.id) + ' requireLog false');\r\n                                adapter.log.debug('Unsubscribe LOGS');\r\n                                if (adapter.requireLog) adapter.requireLog(false);\r\n                            }\r\n                            delete this.subscribes[type][pattern];\r\n                        }\r\n                    }\r\n\r\n                    delete socket._subscribe[type][i];\r\n                    socket._subscribe[type].splice(i, 1);\r\n                    return;\r\n                }\r\n            }\r\n        } else {\r\n            // Remove pattern from global list\r\n            if (this.subscribes[type][pattern] !== undefined) {\r\n                this.subscribes[type][pattern]--;\r\n                if (this.subscribes[type][pattern] <= 0) {\r\n                    if (type === 'stateChange') {\r\n                        adapter.log.debug('Unsubscribe STATES: ' + pattern);\r\n                        adapter.unsubscribeForeignStates(pattern);\r\n                    } else if (type === 'objectChange') {\r\n                        adapter.log.debug('Unsubscribe OBJECTS: ' + pattern);\r\n                        if (adapter.unsubscribeForeignObjects) adapter.unsubscribeForeignObjects(pattern);\r\n                    } else if (type === 'log') {\r\n                        adapter.log.debug('Unsubscribe LOGS');\r\n                        if (adapter.requireLog) adapter.requireLog(false);\r\n                    }\r\n                    delete this.subscribes[type][pattern];\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    this.unsubscribeAll = function () {\r\n        if (that.server && that.server.sockets) {\r\n            for (const s in that.server.sockets) {\r\n                if (that.server.sockets.hasOwnProperty(s)) {\r\n                    this.unsubscribe(s, 'stateChange');\r\n                    this.unsubscribe(s, 'objectChange');\r\n                    this.unsubscribe(s, 'log');\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    function unsubscribeSocket(socket, type) {\r\n        if (!socket._subscribe || !socket._subscribe[type]) return;\r\n\r\n        for (let i = 0; i < socket._subscribe[type].length; i++) {\r\n            const pattern = socket._subscribe[type][i].pattern;\r\n            if (that.subscribes[type][pattern] !== undefined) {\r\n                that.subscribes[type][pattern]--;\r\n                if (that.subscribes[type][pattern] <= 0) {\r\n                    if (type === 'stateChange') {\r\n                        adapter.log.debug('Unsubscribe STATES: ' + pattern);\r\n                        adapter.unsubscribeForeignStates(pattern);\r\n                    } else if (type === 'objectChange') {\r\n                        adapter.log.debug('Unsubscribe OBJECTS: ' + pattern);\r\n                        adapter.unsubscribeForeignObjects && adapter.unsubscribeForeignObjects(pattern);\r\n                    } else if (type === 'log') {\r\n                        adapter.log.debug('Unsubscribe LOGS: ' + pattern);\r\n                        adapter.requireLog && adapter.requireLog(false);\r\n                    }\r\n                    delete that.subscribes[type][pattern];\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    function subscribeSocket(socket, type) {\r\n        //console.log((socket._name || socket.id) + ' subscribeSocket');\r\n        if (!socket._subscribe || !socket._subscribe[type]) return;\r\n\r\n        for (let i = 0; i < socket._subscribe[type].length; i++) {\r\n            const pattern = socket._subscribe[type][i].pattern;\r\n            if (that.subscribes[type][pattern] === undefined){\r\n                that.subscribes[type][pattern] = 1;\r\n                if (type === 'stateChange') {\r\n                    adapter.log.debug('Subscribe STATES: ' + pattern);\r\n                    adapter.subscribeForeignStates(pattern);\r\n                } else if (type === 'objectChange') {\r\n                    adapter.log.debug('Subscribe OBJECTS: ' + pattern);\r\n                    adapter.subscribeForeignObjects && adapter.subscribeForeignObjects(pattern);\r\n                } else if (type === 'log') {\r\n                    adapter.log.debug('Subscribe LOGS');\r\n                    if (adapter.requireLog) adapter.requireLog(true);\r\n                }\r\n            } else {\r\n                that.subscribes[type][pattern]++;\r\n            }\r\n        }\r\n    }\r\n\r\n    function socketEvents(socket) {\r\n        if (socket.conn.request.sessionID) {\r\n            socket._secure = true;\r\n            socket._sessionID = socket.conn.request.sessionID;\r\n            // Get user for session\r\n            adapter.getSession(socket.conn.request.sessionID, function (obj) {\r\n                if (!obj || !obj.passport) {\r\n                    socket._acl.user = '';\r\n                    socket.emit('reauthenticate');\r\n                }\r\n            });\r\n        }\r\n\r\n        if (!that.infoTimeout) {\r\n            that.infoTimeout = setTimeout(updateConnectedInfo, 1000);\r\n        }\r\n\r\n        // Enable logging, while some browser is connected\r\n        /*if (adapter.requireLog) {\r\n            adapter.requireLog(true);\r\n        }*/\r\n\r\n        if (socket.conn) {\r\n            subscribeSocket(socket, 'stateChange');\r\n            subscribeSocket(socket, 'objectChange');\r\n            subscribeSocket(socket, 'log');\r\n        }\r\n\r\n        socket.on('name', function (name) {\r\n            updateSession(socket);\r\n            if (this._name === undefined) {\r\n                this._name = name;\r\n                if (!that.infoTimeout) {\r\n                    that.infoTimeout = setTimeout(updateConnectedInfo, 1000);\r\n                }\r\n            } else if (this._name !== name) {\r\n                adapter.log.warn('socket ' + this.id + ' changed socket name from ' + this._name + ' to ' + name);\r\n                this._name = name;\r\n            }\r\n        });\r\n        /*\r\n         *      objects\r\n         */\r\n        socket.on('getObject', function (id, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getObject', callback, id)) {\r\n                adapter.getForeignObject(id, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('getObjects', function (callback) {\r\n            return getAllObjects(socket, callback);\r\n        });\r\n        socket.on('getForeignObjects', function (pattern, type, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getObjects', callback)) {\r\n                if (typeof type === 'function') {\r\n                    callback = type;\r\n                    type = undefined;\r\n                }\r\n\r\n                adapter.getForeignObjects(pattern, type, function (err, objs) {\r\n                    if (typeof callback === 'function') {\r\n                        callback(err, objs);\r\n                    } else {\r\n                        adapter.log.warn('[getObjects] Invalid callback')\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        // Identical to getObjects\r\n        socket.on('getAllObjects', function (callback) {\r\n            return getAllObjects(socket, callback);\r\n        });\r\n\r\n        socket.on('getObjectView', function (design, search, params, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getObjectView', callback, search)) {\r\n                adapter.objects.getObjectView(design, search, params, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('setObject', function (id, obj, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'setObject', callback, id)) {\r\n                adapter.setForeignObject(id, obj, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('delObject', function (id, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'delObject', callback, id)) {\r\n                adapter.delForeignObject(id, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('extendObject', function (id, obj, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'extendObject', callback, id)) {\r\n                adapter.extendForeignObject(id, obj, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('getHostByIp', function (ip, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getHostByIp', ip)) {\r\n                adapter.objects.getObjectView('system', 'host', {}, {user: this._acl.user}, function (err, data) {\r\n                    if (data.rows.length) {\r\n                        for (let i = 0; i < data.rows.length; i++) {\r\n                            if (data.rows[i].value.common.hostname === ip) {\r\n                                if (typeof callback === 'function') {\r\n                                    callback(ip, data.rows[i].value);\r\n                                } else {\r\n                                    adapter.log.warn('[getHostByIp] Invalid callback')\r\n                                }\r\n                                return;\r\n                            }\r\n                            if (data.rows[i].value.native.hardware && data.rows[i].value.native.hardware.networkInterfaces) {\r\n                                const net = data.rows[i].value.native.hardware.networkInterfaces;\r\n                                for (const eth in net) {\r\n                                    if (!net.hasOwnProperty(eth)) continue;\r\n                                    for (let j = 0; j < net[eth].length; j++) {\r\n                                        if (net[eth][j].address === ip) {\r\n                                            if (typeof callback === 'function') {\r\n                                                callback(ip, data.rows[i].value);\r\n                                            } else {\r\n                                                adapter.log.warn('[getHostByIp] Invalid callback')\r\n                                            }\r\n                                            return;\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    if (typeof callback === 'function') {\r\n                        callback(ip, null);\r\n                    } else {\r\n                        adapter.log.warn('[getHostByIp] Invalid callback');\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        /*\r\n         *      states\r\n         */\r\n        socket.on('getStates', function (callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getStates', callback)) {\r\n                if (typeof callback === 'function') {\r\n                    callback(null, states);\r\n                } else {\r\n                    adapter.log.warn('[getStates] Invalid callback')\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('getState', function (id, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getState', callback, id)) {\r\n                if (typeof callback === 'function') {\r\n                    callback(null, states[id]);\r\n                } else {\r\n                    adapter.log.warn('[getState] Invalid callback')\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('getForeignStates', function (pattern, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getStates', callback)) {\r\n                adapter.getForeignStates(pattern, function (err, objs) {\r\n                    if (typeof callback === 'function') {\r\n                        callback(err, objs);\r\n                    } else {\r\n                        adapter.log.warn('[getForeignStates] Invalid callback')\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        socket.on('setState', function (id, state, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'setState', callback, id)) {\r\n                if (typeof state !== 'object') {\r\n                    state = {val: state};\r\n                }\r\n\r\n                adapter.setForeignState(id, state, {user: this._acl.user}, function (err, res) {\r\n                    if (typeof callback === 'function') {\r\n                        callback(err, res);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        socket.on('delState', function (id, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'delState', callback, id)) {\r\n                adapter.delForeignState(id, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('requireLog', function (isEnabled, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'setObject', callback)) {\r\n                if (isEnabled) {\r\n                    that.subscribe(this, 'log', 'dummy');\r\n                } else {\r\n                    that.unsubscribe(this, 'log', 'dummy');\r\n                }\r\n\r\n                if (adapter.log.level === 'debug') showSubscribes(socket, 'log');\r\n\r\n                if (typeof callback === 'function') {\r\n                    setImmediate(callback, null);\r\n                }\r\n            }\r\n        });\r\n        /*\r\n         *      History\r\n         */\r\n        socket.on('getStateHistory', function (id, options, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getStateHistory', callback)) {\r\n                options.user = this._acl.user;\r\n                options.aggregate = options.aggregate || 'none';\r\n                adapter.getHistory(id, options, callback);\r\n            }\r\n        });\r\n        socket.on('getHistory', function (id, options, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getStateHistory', callback)) {\r\n                options.user = this._acl.user;\r\n                options.aggregate = options.aggregate || 'none';\r\n                adapter.getHistory(id, options, callback);\r\n            }\r\n        });\r\n        /*\r\n         *      user/group\r\n         */\r\n        socket.on('addUser', function (user, pass, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'addUser', callback, user)) {\r\n                addUser(user, pass, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('delUser', function (user, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'delUser', callback, user)) {\r\n                delUser(user, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('addGroup', function (group, desc, acl, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'addGroup', callback, group)) {\r\n                addGroup(group, desc, acl, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('delGroup', function (group, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'delGroup', callback, group)) {\r\n                delGroup(group, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('changePassword', function (user, pass, callback) {\r\n            if (updateSession(socket)) {\r\n                if (user === socket._acl.user || checkPermissions(socket, 'changePassword', callback, user)) {\r\n                    adapter.setPassword(user, pass, {user: this._acl.user}, callback);\r\n                }\r\n            }\r\n        });\r\n\r\n        // HTTP\r\n        socket.on('httpGet', function (url, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'httpGet', callback, url)) {\r\n                request(url, callback);\r\n            }\r\n        });\r\n\r\n        // commands will be executed on host/controller\r\n        // following response commands are expected: cmdStdout, cmdStderr, cmdExit\r\n        socket.on('cmdExec', function (host, id, cmd, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'cmdExec', callback, cmd)) {\r\n                console.log('cmdExec on ' + host + '(' + id + '): ' + cmd);\r\n                // remember socket for this ID.\r\n                cmdSessions[id] = {socket: socket};\r\n                adapter.sendToHost(host, 'cmdExec', {data: cmd, id: id});\r\n            }\r\n        });\r\n\r\n        socket.on('readDir', function (_adapter, path, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'readDir', callback, path)) {\r\n                adapter.readDir(_adapter, path, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('writeFile', function (_adapter, filename, data, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'writeFile', callback, filename)) {\r\n                adapter.writeFile(_adapter, filename, data, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('readFile', function (_adapter, filename, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'readFile', callback, filename)) {\r\n                adapter.readFile(_adapter, filename, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('deleteFile', function (_adapter, filename, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'deleteFile', callback, filename)) {\r\n                adapter.unlink(_adapter, filename, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('readFile64', function (_adapter, filename, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'readFile64', callback, filename)) {\r\n                adapter.readFile(_adapter, filename, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('sendTo', function (adapterInstance, command, message, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'sendTo', callback, command)) {\r\n                adapter.sendTo(adapterInstance, command, message, function (res) {\r\n                    if (typeof callback === 'function') {\r\n                        setTimeout(function () {\r\n                            callback(res);\r\n                        }, 0);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        // following commands are protected and require the extra permissions\r\n        const protectedCommands = ['cmdExec', 'getLocationOnDisk', 'getDiagData', 'getDevList', 'delLogs', 'writeDirAsZip', 'writeObjectsAsZip', 'readObjectsAsZip', 'checkLogging', 'updateMultihost'];\r\n\r\n        socket.on('sendToHost', function (host, command, message, callback) {\r\n            // host can answer following commands: cmdExec, getRepository, getInstalled, getInstalledAdapter, getVersion, getDiagData, getLocationOnDisk, getDevList, getLogs, getHostInfo,\r\n            // delLogs, readDirAsZip, writeDirAsZip, readObjectsAsZip, writeObjectsAsZip, checkLogging, updateMultihost\r\n            if (updateSession(socket) && checkPermissions(socket, protectedCommands.indexOf(command) !== -1 ? 'cmdExec' : 'sendToHost', callback, command)) {\r\n                adapter.sendToHost(host, command, message, res =>\r\n                    typeof callback === 'function' && setTimeout(() => callback(res), 0));\r\n            }\r\n        });\r\n\r\n        socket.on('authEnabled', function (callback) {\r\n            if (typeof callback === 'function') {\r\n                callback(adapter.config.auth, socket._acl.user.replace(/^system\\.user\\./, ''));\r\n            }\r\n        });\r\n\r\n        socket.on('disconnect', function () {\r\n            unsubscribeSocket(this, 'stateChange');\r\n            unsubscribeSocket(this, 'objectChange');\r\n            unsubscribeSocket(this, 'log');\r\n            if (!that.infoTimeout) {\r\n                that.infoTimeout = setTimeout(updateConnectedInfo, 1000);\r\n            }\r\n\r\n            // Disable logging if no one browser is connected\r\n            if (adapter.requireLog) {\r\n                adapter.log.debug('Disable logging, because no one socket connected');\r\n                adapter.requireLog(!!that.server.engine.clientsCount);\r\n            }\r\n        });\r\n\r\n        socket.on('listPermissions', function (callback) {\r\n            if (updateSession(socket)) {\r\n                if (typeof callback === 'function') {\r\n                    callback(commandsPermissions);\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('getUserPermissions', function (callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getUserPermissions', callback)) {\r\n                if (typeof callback === 'function') {\r\n                    callback(null, socket._acl);\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('eventsThreshold', function (isActive) {\r\n            if (!isActive) {\r\n                disableEventThreshold(true);\r\n            } else {\r\n                enableEventThreshold();\r\n            }\r\n        });\r\n\r\n        socket.on('eventsThreshold', function (isActive) {\r\n            if (!isActive) {\r\n                disableEventThreshold(true);\r\n            } else {\r\n                enableEventThreshold();\r\n            }\r\n        });\r\n\r\n        socket.on('subscribe', function (pattern, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'subscribe', callback, pattern)) {\r\n                if (pattern && typeof pattern === 'object' && pattern instanceof Array) {\r\n                    for (let p = 0; p < pattern.length; p++) {\r\n                        that.subscribe(this, 'stateChange', pattern[p]);\r\n                    }\r\n                } else {\r\n                    that.subscribe(this, 'stateChange', pattern);\r\n                }\r\n                if (adapter.log.level === 'debug') showSubscribes(socket, 'stateChange');\r\n                if (typeof callback === 'function') {\r\n                    setImmediate(callback, null);\r\n                }\r\n            }\r\n        });\r\n        // same as 'subscribe'\r\n        socket.on('subscribeStates', function (pattern, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'subscribe', callback, pattern)) {\r\n                if (pattern && typeof pattern === 'object' && pattern instanceof Array) {\r\n                    for (let p = 0; p < pattern.length; p++) {\r\n                        that.subscribe(this, 'stateChange', pattern[p]);\r\n                    }\r\n                } else {\r\n                    that.subscribe(this, 'stateChange', pattern);\r\n                }\r\n                if (adapter.log.level === 'debug') showSubscribes(socket, 'stateChange');\r\n                if (typeof callback === 'function') {\r\n                    setImmediate(callback, null);\r\n                }\r\n            }\r\n        });\r\n\r\n\r\n        socket.on('unsubscribe', function (pattern, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'unsubscribe', callback, pattern)) {\r\n                if (pattern && typeof pattern === 'object' && pattern instanceof Array) {\r\n                    for (let p = 0; p < pattern.length; p++) {\r\n                        that.unsubscribe(this, 'stateChange', pattern[p]);\r\n                    }\r\n                } else {\r\n                    that.unsubscribe(this, 'stateChange', pattern);\r\n                }\r\n                if (adapter.log.level === 'debug') showSubscribes(socket, 'stateChange');\r\n                if (typeof callback === 'function') {\r\n                    setImmediate(callback, null);\r\n                }\r\n            }\r\n        });\r\n\r\n        // same as 'unsubscribe'\r\n        socket.on('unsubscribeStates', function (pattern, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'unsubscribe', callback, pattern)) {\r\n                if (pattern && typeof pattern === 'object' && pattern instanceof Array) {\r\n                    for (let p = 0; p < pattern.length; p++) {\r\n                        that.unsubscribe(this, 'stateChange', pattern[p]);\r\n                    }\r\n                } else {\r\n                    that.unsubscribe(this, 'stateChange', pattern);\r\n                }\r\n                if (adapter.log.level === 'debug') showSubscribes(socket, 'stateChange');\r\n                if (typeof callback === 'function') {\r\n                    setImmediate(callback, null);\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('subscribeObjects', function (pattern, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'subscribeObjects', callback, pattern)) {\r\n                if (pattern && typeof pattern === 'object' && pattern instanceof Array) {\r\n                    for (let p = 0; p < pattern.length; p++) {\r\n                        that.subscribe(this, 'objectChange', pattern[p]);\r\n                    }\r\n                } else {\r\n                    that.subscribe(this, 'objectChange', pattern);\r\n                }\r\n                if (typeof callback === 'function') {\r\n                    setImmediate(callback, null);\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('unsubscribeObjects', function (pattern, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'unsubscribeObjects', callback, pattern)) {\r\n                if (pattern && typeof pattern === 'object' && pattern instanceof Array) {\r\n                    for (let p = 0; p < pattern.length; p++) {\r\n                        that.unsubscribe(this, 'objectChange', pattern[p]);\r\n                    }\r\n                } else {\r\n                    that.unsubscribe(this, 'objectChange', pattern);\r\n                }\r\n                if (typeof callback === 'function') {\r\n                    setImmediate(callback, null);\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('readLogs', function (callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'readLogs', callback)) {\r\n                let result = {list: []};\r\n\r\n                // deliver file list\r\n                try {\r\n                    const config = adapter.systemConfig;\r\n                    // detect file log\r\n                    if (config && config.log && config.log.transport) {\r\n                        for (const transport in config.log.transport) {\r\n                            if (config.log.transport.hasOwnProperty(transport) && config.log.transport[transport].type === 'file') {\r\n                                let filename = config.log.transport[transport].filename || 'log/';\r\n                                const parts = filename.replace(/\\\\/g, '/').split('/');\r\n                                parts.pop();\r\n                                filename = parts.join('/');\r\n                                if (filename[0] !== '/' && !filename.match(/^\\W:/)) {\r\n                                    filename = path.normalize(__dirname + '/../../../') + filename;\r\n                                }\r\n                                if (fs.existsSync(filename)) {\r\n                                    const files = fs.readdirSync(filename);\r\n                                    for (let f = 0; f < files.length; f++) {\r\n                                        try {\r\n                                            if (!fs.lstatSync(filename + '/' + files[f]).isDirectory()) {\r\n                                                result.list.push('log/' + transport + '/' + files[f]);\r\n                                            }\r\n                                        } catch (e) {\r\n                                            // push unchecked\r\n                                            // result.list.push('log/' + transport + '/' + files[f]);\r\n                                            adapter.log.error('Cannot check file: ' + filename + '/' + files[f]);\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    } else {\r\n                        result = {error: 'no file loggers'};\r\n                    }\r\n                } catch (e) {\r\n                    adapter.log.error(e);\r\n                    result = {error: e};\r\n                }\r\n                if (typeof callback === 'function') {\r\n                    callback(result.error, result.list);\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('getVersion', callback => {\r\n            if (typeof callback === 'function') {\r\n                let version = '';\r\n                try {\r\n                    const pack = require('../io-package.json');\r\n                    version = pack && pack.common && pack.common.version;\r\n                } catch (e) {\r\n                    version = 'unknown';\r\n                }\r\n                callback(null, version)\r\n            }\r\n        });\r\n    }\r\n\r\n    function onAuthorizeSuccess(data, accept) {\r\n        adapter.log.info('successful connection to socket.io from ' + data.connection.remoteAddress);\r\n        //adapter.log.info(JSON.stringify(data));\r\n\r\n        accept();\r\n    }\r\n\r\n    function onAuthorizeFail(data, message, error, accept) {\r\n        if (error) {\r\n            adapter.log.error('failed connection to socket.io from ' + data.connection.remoteAddress + ':', message);\r\n        }\r\n\r\n        if (error) {\r\n            accept(new Error(message));\r\n        } else {\r\n            accept('failed connection to socket.io: ' + message);//null, false);\r\n        }\r\n        // this error will be sent to the user as a special error-package\r\n        // see: http://socket.io/docs/client-api/#socket > error-object\r\n    }\r\n\r\n    function initSocket(socket) {\r\n        disableEventThreshold();\r\n\r\n        if (adapter.config.auth) {\r\n            adapter.config.ttl = parseInt(adapter.config.ttl, 10) || 3600;\r\n            getUserFromSocket(socket, function (err, user) {\r\n                if (err || !user) {\r\n                    adapter.log.error('socket.io ' + err);\r\n                } else {\r\n                    adapter.log.debug('socket.io client ' + user + ' connected');\r\n                    adapter.calculatePermissions(user, commandsPermissions, function (acl) {\r\n                        socket._acl = acl;\r\n                        socketEvents(socket);\r\n                    });\r\n                }\r\n            });\r\n        } else {\r\n            adapter.calculatePermissions(adapter.config.defaultUser || 'system.user.admin', commandsPermissions, function (acl) {\r\n                socket._acl = acl;\r\n                socketEvents(socket);\r\n            });\r\n        }\r\n    }\r\n\r\n    // Extract user name from socket\r\n    function getUserFromSocket(socket, callback) {\r\n        let wait = false;\r\n        try {\r\n            if (socket.conn.request.sessionID) {\r\n                wait = true;\r\n                if (store) {\r\n                    store.get(socket.conn.request.sessionID, function (err, obj) {\r\n                        if (obj && obj.passport && obj.passport.user) {\r\n                            if (typeof callback === 'function') {\r\n                                callback(null, obj.passport.user ? 'system.user.' + obj.passport.user : '');\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        } catch (e) {\r\n\r\n        }\r\n        if (!wait && callback) {\r\n            callback('Cannot detect user');\r\n        }\r\n    }\r\n\r\n    function disableEventThreshold(readAll) {\r\n        if (eventsThreshold.active) {\r\n            eventsThreshold.accidents = 0;\r\n            eventsThreshold.count = 0;\r\n            eventsThreshold.active = false;\r\n            eventsThreshold.timeActivated = 0;\r\n            adapter.log.info('Subscribe on all states again');\r\n\r\n            setTimeout(function () {\r\n                if (readAll) {\r\n                    adapter.getForeignStates('*', function (err, res) {\r\n                        adapter.log.info('received all states');\r\n                        for (const id in res) {\r\n                            if (res.hasOwnProperty(id) && JSON.stringify(states[id]) !== JSON.stringify(res[id])) {\r\n                                that.server.sockets.emit('stateChange', id, res[id]);\r\n                                states[id] = res[id];\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n\r\n                that.server.sockets.emit('eventsThreshold', false);\r\n                adapter.unsubscribeForeignStates('system.adapter.*');\r\n                adapter.subscribeForeignStates('*');\r\n            }, 50);\r\n        }\r\n    }\r\n\r\n    function enableEventThreshold() {\r\n        if (!eventsThreshold.active) {\r\n            eventsThreshold.active = true;\r\n\r\n            setTimeout(function () {\r\n                adapter.log.info('Unsubscribe from all states, except system\\'s, because over ' + eventsThreshold.repeatSeconds + ' seconds the number of events is over ' + eventsThreshold.value + ' (in last second ' + eventsThreshold.count + ')');\r\n                eventsThreshold.timeActivated = new Date().getTime();\r\n\r\n                that.server.sockets.emit('eventsThreshold', true);\r\n                adapter.unsubscribeForeignStates('*');\r\n                adapter.subscribeForeignStates('system.adapter.*');\r\n            }, 100);\r\n        }\r\n    }\r\n\r\n    this.repoUpdated = function () {\r\n        if (that.server && that.server.sockets) {\r\n            that.server.sockets.emit('repoUpdated');\r\n        }\r\n    };\r\n\r\n    this.objectChange = function (id, obj) {\r\n        const clients = that.server.sockets.connected;\r\n\r\n        for (const i in clients) {\r\n            if (clients.hasOwnProperty(i)) {\r\n                updateSession(clients[i]);\r\n            }\r\n        }\r\n        that.server.sockets.emit('objectChange', id, obj);\r\n    };\r\n\r\n    this.sendCommand = function (obj) {\r\n        if (cmdSessions[obj.message.id]) {\r\n            if (that.server) {\r\n                that.server.sockets.emit(obj.command, obj.message.id, obj.message.data);\r\n            }\r\n            // we cannot save the socket, because if it takes a bit time, the socket will be invalid\r\n            //cmdSessions[obj.message.id].socket.emit(obj.command, obj.message.id, obj.message.data);\r\n            if (obj.command === 'cmdExit') {\r\n                delete cmdSessions[obj.message.id];\r\n            }\r\n        }\r\n    };\r\n\r\n    this.sendLog = function (obj) {\r\n        // TODO Build in some threshold\r\n        if (that.server && that.server.sockets) {\r\n            that.server.sockets.emit('log', obj);\r\n        }\r\n    };\r\n\r\n    this.stateChange = function (id, state) {\r\n        const clients = that.server.sockets.connected;\r\n\r\n        if (!eventsThreshold.active) {\r\n            eventsThreshold.count++;\r\n        }\r\n        for (const i in clients) {\r\n            if (clients.hasOwnProperty(i)) {\r\n                updateSession(clients[i]);\r\n            }\r\n        }\r\n        that.server.sockets.emit('stateChange', id, state);\r\n    };\r\n\r\n    (function __constructor() {\r\n        // detect event bursts\r\n        setInterval(function () {\r\n            if (!eventsThreshold.active) {\r\n                if (eventsThreshold.count > eventsThreshold.value) {\r\n                    eventsThreshold.accidents++;\r\n\r\n                    if (eventsThreshold.accidents >= eventsThreshold.repeatSeconds) {\r\n                        enableEventThreshold();\r\n                    }\r\n                } else {\r\n                    eventsThreshold.accidents = 0;\r\n                }\r\n                eventsThreshold.count = 0;\r\n            } else if (new Date().getTime() - eventsThreshold.timeActivated > 60000) {\r\n                disableEventThreshold();\r\n            }\r\n        }, eventsThreshold.checkInterval);\r\n\r\n        /*server.server.set('logger', {\r\n         debug: function(obj) {adapter.log.debug('socket.io: ' + obj)},\r\n         info:  function(obj) {adapter.log.debug('socket.io: ' + obj)} ,\r\n         error: function(obj) {adapter.log.error('socket.io: ' + obj)},\r\n         warn:  function(obj) {adapter.log.warn('socket.io: ' + obj)}\r\n         });*/\r\n        // it can be used as client too for cloud\r\n        if (!settings.clientid) {\r\n            if (!server.__inited) {\r\n                that.server = socketio.listen(server);\r\n                server.__inited = true;\r\n            }\r\n        } else {\r\n            that.server = server;\r\n        }\r\n\r\n        that.server.on('connection', initSocket);\r\n\r\n        if (settings.auth && that.server) {\r\n            that.server.use(passportSocketIo.authorize({\r\n                passport:     passport,\r\n                cookieParser: cookieParser,\r\n                key:          userKey,             // the name of the cookie where express/connect stores its session_id\r\n                secret:       settings.secret,     // the session_secret to parse the cookie\r\n                store:        store,               // we NEED to use a sessionstore. no memorystore please\r\n                success:      onAuthorizeSuccess,  // *optional* callback on success - read more below\r\n                fail:         onAuthorizeFail      // *optional* callback on fail/error - read more below\r\n            }));\r\n        }\r\n\r\n        if (!that.infoTimeout) {\r\n            that.infoTimeout = setTimeout(updateConnectedInfo, 1000);\r\n        }\r\n    })();\r\n\r\n    return this;\r\n}\r\nmodule.exports = IOSocket;", "/* jshint -W097 */\r\n/* jshint strict: false */\r\n/* jslint node: true */\r\n/* jshint -W061 */\r\n'use strict';\r\nconst Stream \t= require('stream');\r\nconst utils \t= require('@iobroker/adapter-core'); // Get common adapter utils\r\nconst LE \t    = require(utils.controllerDir + '/lib/letsencrypt.js');\r\nconst express \t= require('express');\r\nconst fs        = require('fs');\r\nlet path        = require('path');\r\n\r\nlet session;\r\nlet bodyParser;\r\nlet AdapterStore;\r\nlet password;\r\nlet passport;\r\nlet LocalStrategy;\r\nlet flash;\r\nlet cookieParser;\r\nlet fileUpload;\r\nlet socketIoFile;\r\n\r\nfunction Web(settings, adapter, onReady) {\r\n    if (!(this instanceof Web)) return new Web(settings, adapter, onReady);\r\n    const server = {\r\n        app:       null,\r\n        server:    null\r\n    };\r\n    const bruteForce  = {};\r\n    let store       = null;\r\n    let loginPage;\r\n    this.server = server;\r\n\r\n    this.close = () => server.server && server.server.close();\r\n\r\n    function decorateLogFile(filename) {\r\n        const prefix = '<html><head>' +\r\n        '<style>\\n' +\r\n        '   table {' +\r\n        '       font-family: monospace;\\n' +\r\n        '       font-size: 14px;\\n' +\r\n        '   }\\n' +\r\n        '   .info {\\n' +\r\n        '       background: white;' +\r\n        '   }\\n' +\r\n        '   .type {\\n' +\r\n        '       font-weight: bold;' +\r\n        '   }\\n' +\r\n        '   .silly {\\n' +\r\n        '       background: #b3b3b3;' +\r\n        '   }\\n' +\r\n        '   .debug {\\n' +\r\n        '       background: lightgray;' +\r\n        '   }\\n' +\r\n        '   .warn {\\n' +\r\n        '       background: #ffdb75;' +\r\n        '       color: white;' +\r\n        '   }\\n' +\r\n        '   .error {\\n' +\r\n        '       background: #ff6a5b;' +\r\n        '   }\\n' +\r\n        '</style>\\n' +\r\n            '<script>\\n' +\r\n            'function decorate (line) {\\n' +\r\n            '   var className = \"info\";\\n' +\r\n            '   line = line.replace(/\\\\x1B\\\\[39m/g, \"</span>\");\\n' +\r\n            '   if (line.indexOf(\"[32m\") !== -1) {\\n' +\r\n            '       className = \"info\";\\n'+\r\n            '       line = line.replace(/\\\\x1B\\\\[32m/g, \"<span class=\\\\\"type\\\\\">\");\\n' +\r\n            '   } else \\n' +\r\n            '   if (line.indexOf(\"[34m\") !== -1) {\\n' +\r\n            '       className = \"debug\";\\n'+\r\n            '       line = line.replace(/\\\\x1B\\\\[34m/g, \"<span class=\\\\\"type\\\\\">\");\\n' +\r\n            '   } else \\n' +\r\n            '   if (line.indexOf(\"[33m\") !== -1) {\\n' +\r\n            '       className = \"warn\";\\n'+\r\n            '       line = line.replace(/\\\\x1B\\\\[33m/g, \"<span class=\\\\\"type\\\\\">\");\\n' +\r\n            '   } else \\n' +\r\n            '   if (line.indexOf(\"[31m\") !== -1) {\\n' +\r\n            '       className = \"error\";\\n'+\r\n            '       line = line.replace(/\\\\x1B\\\\[31m/g, \"<span class=\\\\\"type\\\\\">\");\\n' +\r\n            '   } else \\n' +\r\n            '   if (line.indexOf(\"[35m\") !== -1) {\\n' +\r\n            '       className = \"silly\";\\n'+\r\n            '       line = line.replace(/\\\\x1B\\\\[35m/g, \"<span class=\\\\\"type\\\\\">\");\\n' +\r\n            '   } else {\\n' +\r\n            '   }\\n' +\r\n            '   return \"<tr class=\\\\\"\" + className + \"\\\\\"><td>\" + line + \"</td></tr>\";\\n'+\r\n            '}\\n' +\r\n            'document.addEventListener(\"DOMContentLoaded\", function () { \\n' +\r\n            '  var text = document.body.innerHTML;\\n' +\r\n            '  var lines = text.split(\"\\\\n\");\\n' +\r\n            '  text = \"<table>\";\\n' +\r\n            '  for (var i = 0; i < lines.length; i++) {\\n' +\r\n            '       if (lines[i]) text += decorate(lines[i]);\\n' +\r\n            '  }\\n' +\r\n            '  text += \"</table>\";\\n' +\r\n            '  document.body.innerHTML = text;\\n' +\r\n            '  window.scrollTo(0,document.body.scrollHeight);\\n' +\r\n            '});\\n' +\r\n            '</script>\\n</head>\\n<body>\\n';\r\n        const suffix = '</body></html>';\r\n        const log = fs.readFileSync(filename).toString();\r\n        return prefix + log + suffix;\r\n    }\r\n\r\n    function prepareLoginTemplate() {\r\n        let def = 'background: #64b5f6;\\n';\r\n        let template = fs.readFileSync(__dirname + '/../www/login/index.html').toString('utf8');\r\n        if (adapter.config.loginBackgroundColor) {\r\n            def = 'background-color: ' + adapter.config.loginBackgroundColor + ';\\n'\r\n        }\r\n        if (adapter.config.loginBackgroundImage) {\r\n            def += '            background-image: url(../' + adapter.namespace + '/login-bg.png);\\n';\r\n        }\r\n        if (adapter.config.loginHideLogo) {\r\n            template = template.replace('.logo { display: block }', '.logo { display: none }');\r\n        }\r\n        if (adapter.config.loginMotto) {\r\n            template = template.replace('Discover awesome. <a href=\"http://iobroker.net/\" target=\"_blank\">ioBroker</a>', adapter.config.loginMotto);\r\n        }\r\n        return template.replace('background: #64b5f6;', def);\r\n    }\r\n\r\n    //settings: {\r\n    //    \"port\":   8080,\r\n    //    \"auth\":   false,\r\n    //    \"secure\": false,\r\n    //    \"bind\":   \"0.0.0.0\", // \"::\"\r\n    //    \"cache\":  false\r\n    //}\r\n    (function __construct () {\r\n        if (settings.port) {\r\n            server.app = express();\r\n\r\n            server.app.disable('x-powered-by');\r\n\r\n            // enable use of i-frames together with HTTPS\r\n            server.app.get('/*', (req, res, next) => {\r\n                res.header('X-Frame-Options', 'SAMEORIGIN');\r\n                next(); // http://expressjs.com/guide.html#passing-route control\r\n            });\r\n\r\n            if (settings.auth) {\r\n                session =           require('express-session');\r\n                cookieParser =      require('cookie-parser');\r\n                bodyParser =        require('body-parser');\r\n                AdapterStore =      require(utils.controllerDir + '/lib/session.js')(session, settings.ttl);\r\n                password =          require(utils.controllerDir + '/lib/password.js');\r\n                passport =          require('passport');\r\n                LocalStrategy =     require('passport-local').Strategy;\r\n                flash =             require('connect-flash'); // TODO report error to user\r\n\r\n                store = new AdapterStore({adapter: adapter});\r\n\r\n                passport.use(new LocalStrategy(\r\n                    (username, password, done) => {\r\n                        if (bruteForce[username] && bruteForce[username].errors > 4) {\r\n                            let minutes = (new Date().getTime() - bruteForce[username].time);\r\n                            if (bruteForce[username].errors < 7) {\r\n                                if ((new Date().getTime() - bruteForce[username].time) < 60000) {\r\n                                    minutes = 1;\r\n                                } else {\r\n                                    minutes = 0;\r\n                                }\r\n                            } else\r\n                            if (bruteForce[username].errors < 10) {\r\n                                if ((new Date().getTime() - bruteForce[username].time) < 180000) {\r\n                                    minutes = Math.ceil((180000 - minutes) / 60000);\r\n                                } else {\r\n                                    minutes = 0;\r\n                                }\r\n                            } else\r\n                            if (bruteForce[username].errors < 15) {\r\n                                if ((new Date().getTime() - bruteForce[username].time) < 600000) {\r\n                                    minutes = Math.ceil((600000 - minutes) / 60000);\r\n                                } else {\r\n                                    minutes = 0;\r\n                                }\r\n                            } else\r\n                            if ((new Date().getTime() - bruteForce[username].time) < 3600000) {\r\n                                minutes = Math.ceil((3600000 - minutes) / 60000);\r\n                            } else {\r\n                                minutes = 0;\r\n                            }\r\n\r\n                            if (minutes) {\r\n                                return done('Too many errors. Try again in ' + minutes + ' ' + (minutes === 1 ? 'minute' : 'minutes') + '.', false);\r\n                            }\r\n                        }\r\n                        adapter.checkPassword(username, password, res => {\r\n                            if (!res) {\r\n                                bruteForce[username] = bruteForce[username] || {errors: 0};\r\n                                bruteForce[username].time = new Date().getTime();\r\n                                bruteForce[username].errors++;\r\n                            } else if (bruteForce[username]) {\r\n                                delete bruteForce[username];\r\n                            }\r\n\r\n                            if (res) {\r\n                                return done(null, username);\r\n                            } else {\r\n                                return done(null, false);\r\n                            }\r\n                        });\r\n\r\n                    }\r\n                ));\r\n                passport.serializeUser((user, done) => done(null, user));\r\n\r\n                passport.deserializeUser((user, done) => done(null, user));\r\n\r\n                server.app.use(cookieParser());\r\n                server.app.use(bodyParser.urlencoded({\r\n                    extended: true\r\n                }));\r\n                server.app.use(bodyParser.json());\r\n                server.app.use(session({\r\n                    secret:             settings.secret,\r\n                    saveUninitialized:  true,\r\n                    resave:             true,\r\n                    cookie:             {\r\n                        maxAge: adapter.config.ttl * 1000\r\n                    },\r\n                    store:  store\r\n                }));\r\n                server.app.use(passport.initialize());\r\n                server.app.use(passport.session());\r\n                server.app.use(flash());\r\n\r\n                server.app.post('/login', (req, res, next) => {\r\n                    let redirect = '/';\r\n                    if (req.body.origin) {\r\n                        const parts = req.body.origin.match(/href=(.+)$/);\r\n                        if (parts && parts[1]) {\r\n                            redirect = decodeURIComponent(parts[1]);\r\n                        }\r\n                    }\r\n                    passport.authenticate('local', {\r\n                        successRedirect: redirect,\r\n                        failureRedirect: '/login/index.html' + req.body.origin + (req.body.origin ? '&error' : '?error'),\r\n                        failureFlash:    'Invalid username or password.'\r\n                    })(req, res, next);\r\n                });\r\n\r\n                server.app.get('/logout', (req, res) => {\r\n                    req.logout();\r\n                    res.redirect('/login/index.html');\r\n                });\r\n\r\n                server.app.get('/login/index.html', (req, res) => {\r\n                    loginPage = loginPage || prepareLoginTemplate();\r\n                    res.contentType('text/html');\r\n                    res.status(200).send(loginPage);\r\n                });\r\n\r\n                // route middleware to make sure a user is logged in\r\n                server.app.use((req, res, next) => {\r\n                    if (!req.isAuthenticated()) {\r\n                        if (/admin\\.\\d+\\/login-bg\\.png(\\?.*)?$/.test(req.originalUrl)) {\r\n                            // Read names of files for gong\r\n                            adapter.objects.readFile(adapter.namespace, 'login-bg.png', null, (err, file) => {\r\n                                if (!err && file) {\r\n                                    res.set('Content-Type', 'image/png');\r\n                                    res.status(200).send(file);\r\n                                } else {\r\n                                   res.status(404).send();\r\n                                }\r\n                            });\r\n                        } else if (/^\\/login\\//.test(req.originalUrl) ||\r\n                                   /\\.ico(\\?.*)?$/.test(req.originalUrl)) {\r\n                            return next();\r\n                        } else {\r\n                            res.redirect('/login/index.html?href=' + encodeURIComponent(req.originalUrl));\r\n                        }\r\n                    } else {\r\n                        // special solution for socket.io\r\n                        if (socketIoFile !== false && (req.url.startsWith('socket.io.js') || req.url.match(/\\/socket\\.io\\.js(\\?.*)?$/))) {\r\n                            if (socketIoFile) {\r\n                                res.contentType('text/javascript');\r\n                                res.status(200).send(socketIoFile);\r\n                                return\r\n                            } else {\r\n                                try {\r\n                                    const dir = require.resolve('socket.io-client');\r\n                                    const fileDir = path.join(path.dirname(dir), '../dist/');\r\n                                    if (fs.existsSync(fileDir + 'socket.io.min.js')) {\r\n                                        socketIoFile = fs.readFileSync(fileDir + 'socket.io.min.js');\r\n                                    } else {\r\n                                        socketIoFile = fs.readFileSync(fileDir + 'socket.io.js');\r\n                                    }\r\n                                } catch (e) {\r\n                                    try {\r\n                                        socketIoFile = fs.readFileSync(path.join(__dirname, '../www/lib/js/socket.io.js'));\r\n                                    } catch (e) {\r\n                                        adapter.log.error('Cannot read socket.io.js: ' + e);\r\n                                        socketIoFile = false;\r\n                                    }\r\n                                }\r\n                                if (socketIoFile) {\r\n                                    res.contentType('text/javascript');\r\n                                    res.status(200).send(socketIoFile);\r\n                                    return\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                        return next();\r\n                    }\r\n                });\r\n            } else {\r\n                server.app.get('/login', (req, res) => {\r\n                    res.redirect('/');\r\n                });\r\n                server.app.get('/logout', (req, res) => {\r\n                    res.redirect('/');\r\n                });\r\n            }\r\n\r\n            server.app.get('/zip/*', (req, res) => {\r\n                let parts = req.url.split('/');\r\n                let filename = parts.pop();\r\n\r\n                adapter.getBinaryState('system.host.' + adapter.host + '.zip.' + filename, (err, buff) => {\r\n                    if (err) {\r\n                        res.status(500).send(err);\r\n                    } else {\r\n                        if (!buff) {\r\n                            res.status(404).send('File package.zip not found');\r\n                        } else {\r\n                            // remove file\r\n                            adapter.delBinaryState && adapter.delBinaryState('system.host.' + adapter.host + '.zip.' + filename);\r\n                            res.set('Content-Type', 'application/zip');\r\n                            res.send(buff);\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n\r\n            // send log files\r\n            server.app.get('/log/*', (req, res) => {\r\n                let parts = req.url.split('/');\r\n                parts = parts.splice(2);\r\n                const transport = parts.shift();\r\n                let filename = parts.join('/');\r\n                const config = adapter.systemConfig;\r\n                // detect file log\r\n                if (config && config.log && config.log.transport) {\r\n                    if (config.log.transport.hasOwnProperty(transport) && config.log.transport[transport].type === 'file') {\r\n                        if (config.log.transport[transport].filename) {\r\n                            parts = config.log.transport[transport].filename.replace(/\\\\/g, '/').split('/');\r\n                            parts.pop();\r\n                            filename = path.join(parts.join('/'), filename);\r\n                        } else {\r\n                            filename = path.join('log/', filename) ;\r\n                        }\r\n\r\n                        if (filename[0] !== '/' && !filename.match(/^\\W:/)) {\r\n                            filename = path.normalize(__dirname + '/../../../') + filename;\r\n                        }\r\n\r\n                        if (fs.existsSync(filename)) {\r\n                            const stat = fs.lstatSync(filename);\r\n                            if (stat.size > 2 * 1024 * 1024) {\r\n                                res.sendFile(filename);\r\n                            } else {\r\n                                res.send(decorateLogFile(filename));\r\n                            }\r\n\r\n                            return;\r\n                        }\r\n                    }\r\n                }\r\n                res.status(404).send('File ' + filename + ' not found');\r\n            });\r\n            const appOptions = {};\r\n            if (settings.cache) {\r\n                appOptions.maxAge = 30758400000;\r\n            }\r\n\r\n            if (settings.tmpPathAllow && settings.tmpPath) {\r\n                server.app.use('/tmp/', express.static(settings.tmpPath, {maxAge: 0}));\r\n                fileUpload = fileUpload || require('express-fileupload');\r\n                server.app.use(fileUpload({\r\n                    useTempFiles: true,\r\n                    tempFilePath: settings.tmpPath\r\n                }));\r\n                server.app.post('/upload', (req, res) => {\r\n                    if (!req.files) {\r\n                        return res.status(400).send('No files were uploaded.');\r\n                    }\r\n\r\n                    // The name of the input field (i.e. \"sampleFile\") is used to retrieve the uploaded file\r\n                    let myFile;\r\n                    for (const name in req.files) {\r\n                        if (req.files.hasOwnProperty(name)) {\r\n                            myFile = req.files[name];\r\n                            break;\r\n                        }\r\n                    }\r\n\r\n                    if (myFile) {\r\n                        if (myFile.data && myFile.data.length > 600 * 1024 * 1024) {\r\n                            return res.status(500).send('File is too big. (Max 600MB)');\r\n                        }\r\n                        // Use the mv() method to place the file somewhere on your server\r\n                        myFile.mv(settings.tmpPath + '/restore.iob', err =>  {\r\n                            if (err) {\r\n                                res.status(500).send(err);\r\n                            } else {\r\n                                res.send('File uploaded!');\r\n                            }\r\n                        });\r\n                    } else {\r\n                        return res.status(500).send('File not uploaded');\r\n                    }\r\n                });\r\n            }\r\n\r\n            if (!fs.existsSync(__dirname + '/../www')) {\r\n                server.app.use('/', (req, res) => {\r\n                    res.send('This adapter cannot be installed directly from github.<br>You must install it from npm.<br>Write for that <i>\"npm install iobroker.admin\"</i> in according directory.');\r\n                });\r\n            } else {\r\n                server.app.use('/', express.static(__dirname + '/../www', appOptions));\r\n            }\r\n\r\n            // reverse proxy with url rewrite for couchdb attachments in <adapter-name>.admin\r\n            server.app.use('/adapter/', (req, res) => {\r\n\r\n                // Example: /example/?0\r\n                let url = req.url;\r\n\r\n                // add index.html\r\n                url = url.replace(/\\/($|\\?|#)/, '/index.html$1');\r\n\r\n                // Read config files for admin from /adapters/admin/admin/...\r\n                if (url.substring(0, '/' + adapter.name + '/'.length) === '/' + adapter.name + '/') {\r\n                    url = url.replace('/' + adapter.name + '/', __dirname + '/../admin/');\r\n                    url = url.replace(/\\?[0-9]*/, '');\r\n\r\n                    try {\r\n                        if (fs.existsSync(url)) {\r\n                            fs.createReadStream(url).pipe(res);\r\n                        } else {\r\n                            const ss = new Stream();\r\n                            ss.pipe = dest => dest.write('File not found');\r\n\r\n                            ss.pipe(res);\r\n                        }\r\n                    } catch (e) {\r\n                        const s = new Stream();\r\n                        s.pipe = dest => dest.write('File not found: ' + e);\r\n\r\n                        s.pipe(res);\r\n                    }\r\n                    return;\r\n                }\r\n                url = url.split('/');\r\n                // Skip first /\r\n                url.shift();\r\n                // Get ID\r\n                const id = url.shift() + '.admin';\r\n                url = url.join('/');\r\n                const pos = url.indexOf('?');\r\n                if (pos !== -1) {\r\n                    url = url.substring(0, pos);\r\n                }\r\n                adapter.readFile(id, url, null, (err, buffer, mimeType) => {\r\n                    if (!buffer || err) {\r\n                        res.contentType('text/html');\r\n                        res.status(404).send('File ' + url + ' not found');\r\n                    } else {\r\n                        if (mimeType) {\r\n                            res.contentType(mimeType['content-type'] || mimeType);\r\n                        } else {\r\n                            res.contentType('text/javascript');\r\n                        }\r\n                        res.send(buffer);\r\n                    }\r\n                });\r\n            });\r\n\r\n            server.server = LE.createServer(server.app, settings, adapter.config.certificates, adapter.config.leConfig, adapter.log);\r\n            server.server.__server = server;\r\n        } else {\r\n            adapter.log.error('port missing');\r\n            adapter.terminate ? adapter.terminate('port missing', 1) : process.exit(1);\r\n        }\r\n\r\n        if (server.server) {\r\n            settings.port = parseInt(settings.port, 10);\r\n\r\n            adapter.getPort(settings.port, port => {\r\n                if (port !== settings.port && !adapter.config.findNextPort) {\r\n                    adapter.log.error('port ' + settings.port + ' already in use');\r\n                    adapter.terminate ? adapter.terminate('port ' + settings.port + ' already in use', 1) : process.exit(1);\r\n                }\r\n                server.server.listen(port, (!settings.bind || settings.bind === '0.0.0.0') ? undefined : settings.bind || undefined);\r\n\r\n                adapter.log.info('http' + (settings.secure ? 's' : '') + ' server listening on port ' + port);\r\n                adapter.log.info('Use link \"http' + (settings.secure ? 's' : '') + '://localhost:' + port + '\" to configure.');\r\n\r\n                if (typeof onReady === 'function') {\r\n                    onReady(server.server, store);\r\n                }\r\n            });\r\n        }\r\n\r\n        if (server.server) {\r\n            return server;\r\n        } else {\r\n            return null;\r\n        }\r\n    })();\r\n\r\n    return this;\r\n}\r\n\r\nmodule.exports = Web;\r\n", "/**\r\n *      Admin backend\r\n *\r\n *      Controls Adapter-Processes\r\n *\r\n *      Copyright 2014-2019 bluefox <dogafox@gmail.com>,\r\n *      MIT License\r\n *\r\n */\r\n\r\n/* jshint -W097 */\r\n/* jshint strict: false */\r\n/* jslint node: true */\r\n'use strict';\r\n\r\nconst adapterName = require('./package.json').name.split('.').pop();\r\nconst utils = require('@iobroker/adapter-core'); // Get common adapter utils\r\nconst tools \t  = require(utils.controllerDir + '/lib/tools.js');\r\nconst SocketIO    = require('./lib/socket');\r\nconst Web         = require('./lib/web');\r\n\r\nlet socket      = null;\r\nlet webServer   = null;\r\n\r\nlet objects     = {};\r\nlet states      = {};\r\nlet secret      = 'Zgfr56gFe87jJOM'; // Will be generated by first start\r\nlet adapter;\r\n\r\nfunction startAdapter(options) {\r\n    options = options || {};\r\n\tObject.assign(options, {\r\n\t    name:           adapterName, // adapter name\r\n\t    dirname:        __dirname,   // say own position\r\n\t    logTransporter: true,        // receive the logs\r\n\t    systemConfig:   true,\r\n\t    install:        callback => typeof callback === 'function' && callback()\r\n\t});\r\n\r\n    adapter = new utils.Adapter(options);\r\n\r\n    adapter.on('objectChange', (id, obj) => {\r\n        if (obj) {\r\n            //console.log('objectChange: ' + id);\r\n            objects[id] = obj;\r\n\r\n            if (id === 'system.repositories') {\r\n                writeUpdateInfo();\r\n            }\r\n        } else {\r\n            //console.log('objectDeleted: ' + id);\r\n            if (objects[id]) {\r\n                delete objects[id];\r\n            }\r\n        }\r\n\r\n        // TODO Build in some threshold of messages\r\n        if (socket) {\r\n            socket.objectChange(id, obj);\r\n        }\r\n    });\r\n\r\n    adapter.on('stateChange', (id, state) => {\r\n        if (!state) {\r\n            if (states[id]) {\r\n                delete states[id];\r\n            }\r\n        } else {\r\n            states[id] = state;\r\n        }\r\n        if (socket) {\r\n            socket.stateChange(id, state);\r\n        }\r\n    });\r\n\r\n    adapter.on('ready', () => {\r\n        adapter.getForeignObject('system.config', (err, obj) => {\r\n            if (!err && obj) {\r\n                obj.native = obj.native || {};\r\n                if (!obj.native.secret) {\r\n                    require('crypto').randomBytes(24, (ex, buf) => {\r\n                        adapter.config.secret = buf.toString('hex');\r\n                        adapter.extendForeignObject('system.config', {native: {secret: adapter.config.secret}});\r\n                        main();\r\n                    });\r\n                } else {\r\n                    adapter.config.secret = obj.native.secret;\r\n                    main();\r\n                }\r\n            } else {\r\n                adapter.config.secret = secret;\r\n                adapter.log.error('Cannot find object system.config');\r\n            }\r\n        });\r\n    });\r\n\r\n    adapter.on('message', obj => {\r\n        if (!obj || !obj.message) {\r\n            return false;\r\n        }\r\n\r\n        if (socket) {\r\n            socket.sendCommand(obj);\r\n        }\r\n\r\n        return true;\r\n    });\r\n\r\n    adapter.on('unload', callback => {\r\n        if (socket) {\r\n            // unsubscribe all\r\n            socket.unsubscribeAll();\r\n        }\r\n\r\n        try {\r\n            adapter.log.info('terminating http' + (adapter.config.secure ? 's' : '') + ' server on port ' + adapter.config.port);\r\n            webServer.close();\r\n            callback();\r\n        } catch (e) {\r\n            callback();\r\n        }\r\n    });\r\n\r\n// obj = {message: msg, severity: level, from: this.namespace, ts: (new Date()).getTime()}\r\n    adapter.on('log', obj => socket && socket.sendLog(obj));\r\n\r\n    return adapter;\r\n}\r\n\r\nfunction createUpdateInfo() {\r\n    // create connected object and state\r\n    let updatesNumberObj = objects[adapter.namespace + '.info.updatesNumber'];\r\n\r\n    if (!updatesNumberObj || !updatesNumberObj.common || updatesNumberObj.common.type !== 'number') {\r\n        let obj = {\r\n            _id:  'info.updatesNumber',\r\n            type: 'state',\r\n            common: {\r\n                role:  'indicator.updates',\r\n                name:  'Number of adapters to update',\r\n                type:  'number',\r\n                read:  true,\r\n                write: false,\r\n                def:   0\r\n            },\r\n            native: {}\r\n        };\r\n\r\n        adapter.setObject(obj._id, obj);\r\n    }\r\n\r\n    let updatesListObj = objects[adapter.namespace + '.info.updatesList'];\r\n\r\n    if (!updatesListObj || !updatesListObj.common || updatesListObj.common.type !== 'string') {\r\n        let obj = {\r\n            _id:  'info.updatesList',\r\n            type: 'state',\r\n            common: {\r\n                role:  'indicator.updates',\r\n                name:  'List of adapters to update',\r\n                type:  'string',\r\n                read:  true,\r\n                write: false,\r\n                def:   ''\r\n            },\r\n            native: {}\r\n        };\r\n\r\n        adapter.setObject(obj._id, obj);\r\n    }\r\n\r\n    let newUpdatesObj = objects[adapter.namespace + '.info.newUpdates'];\r\n\r\n    if (!newUpdatesObj || !newUpdatesObj.common || newUpdatesObj.common.type !== 'boolean') {\r\n        let obj = {\r\n            _id:  'info.newUpdates',\r\n            type: 'state',\r\n            common: {\r\n                role:  'indicator.updates',\r\n                name:  'Indicator if new adapter updates are available',\r\n                type:  'boolean',\r\n                read:  true,\r\n                write: false,\r\n                def:   false\r\n            },\r\n            native: {}\r\n        };\r\n\r\n        adapter.setObject(obj._id, obj);\r\n    }\r\n\r\n    let updatesJsonObj = objects[adapter.namespace + '.info.updatesJson'];\r\n\r\n    if (!updatesJsonObj || !updatesJsonObj.common || updatesJsonObj.common.type !== 'string') {\r\n        let obj = {\r\n            _id:  'info.updatesJson',\r\n            type: 'state',\r\n            common: {\r\n                role:  'indicator.updates',\r\n                name:  'JSON string with adapter update information',\r\n                type:  'string',\r\n                read:  true,\r\n                write: false,\r\n                def:   '{}'\r\n            },\r\n            native: {}\r\n        };\r\n\r\n        adapter.setObject(obj._id, obj);\r\n    }\r\n\r\n    let lastUpdateCheckObj = objects[adapter.namespace + '.info.lastUpdateCheck'];\r\n\r\n    if (!lastUpdateCheckObj || !lastUpdateCheckObj.common || lastUpdateCheckObj.common.type !== 'string') {\r\n        let obj = {\r\n            _id:  'info.lastUpdateCheck',\r\n            type: 'state',\r\n            common: {\r\n                role:  'value.datetime',\r\n                name:  'Timestamp of last update check',\r\n                type:  'string',\r\n                read:  true,\r\n                write: false,\r\n                def:   '{}'\r\n            },\r\n            native: {}\r\n        };\r\n\r\n        adapter.setObject(obj._id, obj);\r\n    }\r\n}\r\n\r\n// Helper methods\r\nfunction upToDate(a, b) {\r\n    a = a.split('.');\r\n    b = b.split('.');\r\n    a[0] = parseInt(a[0], 10);\r\n    b[0] = parseInt(b[0], 10);\r\n    if (a[0] > b[0]) {\r\n        return false;\r\n    } else if (a[0] < b[0]) {\r\n        return true;\r\n    } else if (a[0] === b[0]) {\r\n        a[1] = parseInt(a[1], 10);\r\n        b[1] = parseInt(b[1], 10);\r\n        if (a[1] > b[1]) {\r\n            return false;\r\n        } else if (a[1] < b[1]) {\r\n            return true;\r\n        } else if (a[1] === b[1]) {\r\n            a[2] = parseInt(a[2], 10);\r\n            b[2] = parseInt(b[2], 10);\r\n            return a[2] <= b[2];\r\n        }\r\n    } else {\r\n        return true;\r\n    }\r\n}\r\n\r\nfunction writeUpdateInfo(sources) {\r\n    if (!sources) {\r\n        let obj = objects['system.repositories'];\r\n        if (!objects['system.config'] || !objects['system.config'].common) {\r\n            adapter.log.warn('Repository cannot be read. Invalid \"system.config\" object.');\r\n            return;\r\n        }\r\n\r\n        const activeRepo = objects['system.config'].common.activeRepo;\r\n\r\n        if (obj && obj.native && obj.native.repositories && obj.native.repositories[activeRepo] &&\r\n            obj.native.repositories[activeRepo].json) {\r\n            sources = obj.native.repositories[activeRepo].json;\r\n        } else {\r\n            adapter.setState('info.updatesNumber', 0, true);\r\n            adapter.setState('info.updatesList',  '', true);\r\n            adapter.setState('info.newUpdates', false, true);\r\n            adapter.setState('info.updatesJson', '{}', true);\r\n            let updateTime = new Date();\r\n            adapter.setState('info.lastUpdateCheck', new Date(updateTime - updateTime.getTimezoneOffset() * 60000).toISOString(), true);\r\n            if (obj && obj.native && obj.native.repositories && obj.native.repositories[activeRepo]) {\r\n                adapter.log.warn('Repository cannot be read');\r\n            } else {\r\n                adapter.log.warn('No repository source configured');\r\n            }\r\n            return;\r\n        }\r\n    }\r\n\r\n    let installed = tools.getInstalledInfo();\r\n    let list  = [];\r\n    let updatesJson = {};\r\n    let newUpdateIndicator = false;\r\n    adapter.getState('info.updatesJson', (err, state) => {\r\n        let oldUpdates;\r\n        if (state && state.val) oldUpdates = JSON.parse(state.val) || {};\r\n        else oldUpdates = {};\r\n        for (let name in sources) {\r\n            if (!sources.hasOwnProperty(name)) continue;\r\n            if (installed[name] && installed[name].version && sources[name].version) {\r\n                if (sources[name].version !== installed[name].version &&\r\n                    !upToDate(sources[name].version, installed[name].version)) {\r\n                    // Check if updates are new or already known to user\r\n                    if (!oldUpdates || !oldUpdates[name] || oldUpdates[name].availableVersion !== sources[name].version) {\r\n                        newUpdateIndicator = true;\r\n                    } // endIf\r\n                    updatesJson[name] = {\r\n                        availableVersion: sources[name].version,\r\n                        installedVersion: installed[name].version\r\n                    };\r\n                    // remove first part of the name\r\n                    const n = name.indexOf('.');\r\n                    list.push(n === -1 ? name : name.substring(n + 1));\r\n                }\r\n            }\r\n        }\r\n        adapter.setState('info.updatesNumber', list.length, true);\r\n        adapter.setState('info.updatesList', list.join(', '), true);\r\n        adapter.setState('info.newUpdates', newUpdateIndicator, true);\r\n        adapter.setState('info.updatesJson', JSON.stringify(updatesJson), true);\r\n        let updateTime = new Date();\r\n        adapter.setState('info.lastUpdateCheck', new Date(updateTime - updateTime.getTimezoneOffset() * 60000).toISOString(), true);\r\n    });\r\n\r\n}\r\n\r\n// to do => remove it later, when all repositories patched.\r\nfunction patchRepos(callback) {\r\n    return callback && callback();\r\n    // do not patch any more. Delete it later 2018.04.23\r\n    /*\r\n    adapter.getForeignObject('system.repositories', (err, obj) => {\r\n        let changed = false;\r\n        if (obj && obj.native && obj.native.repositories) {\r\n            // default link should point to stable\r\n            if (!obj.native.repositories.default || obj.native.repositories.default.link !== 'http://download.iobroker.net/sources-dist.json') {\r\n                changed = true;\r\n                obj.native.repositories.default = {\r\n                    link: 'http://download.iobroker.net/sources-dist.json'\r\n                };\r\n            }\r\n            // latest link should point to latest\r\n            if (!obj.native.repositories.latest) {\r\n                obj.native.repositories.latest = {\r\n                    link: 'http://download.iobroker.net/sources-dist-latest.json'\r\n                };\r\n                changed = true;\r\n            }\r\n\r\n            // change URL of raw sources from ioBroker.js-controller to ioBroker.repositories\r\n            for (let r in obj.native.repositories) {\r\n                if (obj.native.repositories.hasOwnProperty(r) &&\r\n                    obj.native.repositories[r].link === 'https://raw.githubusercontent.com/ioBroker/ioBroker.js-controller/master/conf/sources-dist.json') {\r\n                    obj.native.repositories[r].link = 'https://raw.githubusercontent.com/ioBroker/ioBroker.repositories/master/sources-dist.json';\r\n                    changed = true;\r\n                }\r\n            }\r\n        }\r\n        if (changed) {\r\n            adapter.setForeignObject(obj._id, obj, function () {\r\n                callback && callback();\r\n            });\r\n        } else {\r\n            callback && callback();\r\n        }\r\n    });*/\r\n}\r\n\r\nfunction initSocket(server, store) {\r\n    socket = new SocketIO(server, adapter.config, adapter, objects, states, store);\r\n    socket.subscribe(null, 'objectChange', '*');\r\n}\r\n\r\nfunction main() {\r\n    // adapter.subscribeForeignStates('*');\r\n    // adapter.subscribeForeignObjects('*');\r\n\r\n    adapter.config.defaultUser = adapter.config.defaultUser || 'admin';\r\n    if (!adapter.config.defaultUser.match(/^system\\.user\\./)) {\r\n        adapter.config.defaultUser = 'system.user.' + adapter.config.defaultUser;\r\n    }\r\n\r\n    if (adapter.config.secure) {\r\n        // Load certificates\r\n        adapter.getCertificates((err, certificates, leConfig) => {\r\n            adapter.config.certificates = certificates;\r\n            adapter.config.leConfig     = leConfig;\r\n\r\n            getData(() => webServer = new Web(adapter.config, adapter, initSocket));\r\n        });\r\n    } else {\r\n        getData(() => webServer = new Web(adapter.config, adapter, initSocket));\r\n    }\r\n\r\n    patchRepos(() => {\r\n        // By default update repository every 24 hours\r\n        if (adapter.config.autoUpdate === undefined) {\r\n            adapter.config.autoUpdate = 24;\r\n        }\r\n        adapter.config.autoUpdate = parseInt(adapter.config.autoUpdate, 10) || 0;\r\n        if (adapter.config.autoUpdate) {\r\n            setInterval(() => updateRegister(), adapter.config.autoUpdate * 3600000);\r\n            updateRegister();\r\n        }\r\n    });\r\n}\r\n\r\nfunction getData(callback) {\r\n    adapter.log.info('requesting all states');\r\n    let tasks = 0;\r\n    tasks++;\r\n    adapter.getForeignStates('*', (err, res) => {\r\n        adapter.log.info('received all states');\r\n        states = res;\r\n        !--tasks && callback && callback();\r\n    });\r\n    adapter.log.info('requesting all objects');\r\n    tasks++;\r\n    adapter.objects.getObjectList({include_docs: true}, (err, res) => {\r\n        adapter.log.info('received all objects');\r\n        if (res) {\r\n            res = res.rows;\r\n            objects = {};\r\n            let tmpPath = '';\r\n            for (let i = 0; i < res.length; i++) {\r\n                objects[res[i].doc._id] = res[i].doc;\r\n                if (res[i].doc.type === 'instance' && res[i].doc.common && res[i].doc.common.tmpPath) {\r\n                    tmpPath && adapter.log.warn('tmpPath has multiple definitions!!');\r\n                    tmpPath = res[i].doc.common.tmpPath;\r\n                }\r\n            }\r\n\r\n            // Some adapters want access on specified tmp directory\r\n            if (tmpPath) {\r\n                adapter.config.tmpPath = tmpPath;\r\n                adapter.config.tmpPathAllow = true;\r\n            }\r\n\r\n            createUpdateInfo();\r\n            writeUpdateInfo();\r\n        }\r\n\r\n        !--tasks && callback && callback();\r\n    });\r\n}\r\n\r\n// read repository information from active repository\r\nfunction updateRegister() {\r\n    adapter.log.info('Request actual repository...');\r\n    adapter.getForeignObject('system.config', (err, data) => {\r\n        if (data && data.common) {\r\n            adapter.sendToHost(adapter.host, 'getRepository', {\r\n                repo:   data.common.activeRepo,\r\n                update: true\r\n            }, _repository => {\r\n                if (_repository === 'permissionError') {\r\n                    adapter.log.error('May not read \"getRepository\"');\r\n                } else {\r\n                    adapter.log.info('Repository received successfully.');\r\n\r\n                    socket && socket.repoUpdated();\r\n                }\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n// If started as allInOne mode => return function to create instance\r\nif (module && module.parent) {\r\n    module.exports = startAdapter;\r\n} else {\r\n    // or start the instance directly\r\n    startAdapter();\r\n}\r\n", "{\n  \"name\": \"iobroker.admin\",\n  \"description\": \"The adapter opens a webserver for the ioBroker admin UI.\",\n  \"version\": \"3.6.7\",\n  \"contributors\": [\n    \"bluefox <dogafox@gmail.com>\",\n    \"apollon77\",\n    \"soef <soef@gmx.net>\",\n    \"hobbyquaker <hq@ccu.io>\"\n  ],\n  \"homepage\": \"https://github.com/ioBroker/ioBroker.admin\",\n  \"repository\": {\n    \"type\": \"git\",\n    \"url\": \"https://github.com/ioBroker/ioBroker.admin\"\n  },\n  \"license\": \"MIT\",\n  \"keywords\": [\n    \"ioBroker\",\n    \"setup\"\n  ],\n  \"dependencies\": {\n    \"body-parser\": \"^1.18.2\",\n    \"connect-flash\": \"^0.1.1\",\n    \"cookie-parser\": \"^1.4.3\",\n    \"express\": \"^4.16.3\",\n    \"express-fileupload\": \"https://github.com/screenmeet/express-fileupload/tarball/8d8f5d9b7cec2d7c17e6d85654edf1c0aaa5fa82\",\n    \"express-session\": \"^1.15.6\",\n    \"passport\": \"^0.4.0\",\n    \"passport-local\": \"^1.0.0\",\n    \"passport.socketio\": \"^3.7.0\",\n    \"request\": \"^2.85.0\",\n    \"socket.io\": \"1.7.2\",\n    \"xtend\": \"^4.0.1\",\n    \"@iobroker/adapter-core\": \"^1.0.3\"\n  },\n  \"devDependencies\": {\n    \"@iobroker/testing\": \"^1.2.0\",\n    \"babel-core\": \"^6.26.3\",\n    \"babel-plugin-transform-es2015-arrow-functions\": \"^6.22.0\",\n    \"babel-plugin-transform-es2015-block-scoping\": \"^6.26.0\",\n    \"babel-plugin-transform-es2015-classes\": \"^6.24.1\",\n    \"babel-plugin-transform-es2015-template-literals\": \"^6.22.0\",\n    \"chai\": \"^4.1.2\",\n    \"gulp\": \"^4.0.0\",\n    \"gulp-babel\": \"^7.0.1\",\n    \"gulp-clean-css\": \"^3.9.4\",\n    \"gulp-concat\": \"^2.6.1\",\n    \"gulp-htmlmin\": \"^4.0.0\",\n    \"gulp-less\": \"^4.0.0\",\n    \"gulp-sass\": \"^3.1.0\",\n    \"gulp-sourcemaps\": \"^2.6.4\",\n    \"gulp-terser\": \"^1.1.7\",\n    \"fancy-log\": \"^1.3.3\",\n    \"ansi-colors\": \"^3.2.4\",\n    \"materialize-css\": \"^1.0.0\",\n    \"mocha\": \"^6.1.4\"\n  },\n  \"bugs\": {\n    \"url\": \"https://github.com/ioBroker/ioBroker.admin/issues\"\n  },\n  \"main\": \"main.js\",\n  \"scripts\": {\n    \"test\": \"npm run test:package && npm run test:unit\",\n    \"prepare\": \"node node_modules/gulp/bin/gulp default\",\n    \"test:package\": \"mocha test/package --exit\",\n    \"test:unit\": \"mocha test/unit --exit\",\n    \"test:integration\": \"mocha test/integration --exit\"\n  },\n  \"author\": \"bluefox <dogafox@gmail.com>\"\n}\n", "/* jshint -W097 */\n/* jshint strict:true */\n/* jslint vars: true */\n/* global io:false */\n/* global jQuery:false */\n/* jslint browser:true */\n/* jshint browser:true */\n/* global _ */\n/* global ace */\n/* global console */\n/* global alert */\n/* global confirm */\n/* global systemLang: true */\n/* global license */\n/* global translateAll */\n/* global initGridLanguage, M, storage, decodeURI, States */\n'use strict';\n\n//if (typeof Worker === 'undefined') alert('your browser does not support WebWorkers :-(');\n\nArray.prototype.remove = function () {\n    var what;\n    var a = arguments;\n    var L = a.length;\n    var ax;\n    while (L && this.length) {\n        what = a[--L];\n        while ((ax = this.indexOf(what)) !== -1) {\n            this.splice(ax, 1);\n        }\n    }\n    return this;\n};\n// for IE\nif (!console.debug) {\n    console.debug = console.log;\n}\nif (typeof Number === 'undefined') {\n    console.log('define Number');\n    Number = function (obj) {\n        return parseFloat(obj);\n    };\n}\nif (!Object.assign) {\n    Object.assign = $.extend;\n}\n\nasync function asyncForEach(array, callback) {\n    for (let index = 0; index < array.length; index++) {\n        await callback(array [index], index, array);\n    }\n}\n\nvar $iframeDialog = null; // used in adapter settings window\nvar configNotSaved = null; // used in adapter settings window\nvar showConfig = null; // used in adapter settings window\nvar defaults = {};\nvar customPostInits = {};\nvar customPostOnSave = {};\nvar FORBIDDEN_CHARS = /[\\]\\[*,;'\"`<>\\\\\\s?]/g;\n\n// used in adapter settings window\nvar adapterRedirect = function (redirect, timeout) {\n    if (redirect) {\n        setTimeout(function () {\n            redirect += document.location.pathname;\n            redirect += document.location.hash;\n            document.location.href = redirect;\n        }, timeout || 5000);\n    }\n};\nvar gMain = null; // for google maps\n\nfunction detectIE() {\n    var ua = window.navigator.userAgent;\n\n    var msie = ua.indexOf('MSIE ');\n    if (msie > 0) {\n        // IE 10 or older => return version number\n        return parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10);\n    }\n\n    var trident = ua.indexOf('Trident/');\n    if (trident > 0) {\n        // IE 11 => return version number\n        var rv = ua.indexOf('rv:');\n        return parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10);\n    }\n\n    var edge = ua.indexOf('Edge/');\n    if (edge > 0) {\n        // Edge (IE 12+) => return version number\n        return parseInt(ua.substring(edge + 5, ua.indexOf('.', edge)), 10);\n    }\n\n    // other browser\n    return false;\n}\n\n(function ($) {\n$(document).ready(function () {\n    var path = location.pathname + 'socket.io';\n    if (location.pathname.match(/^\\/admin\\//)) {\n        path = '/socket.io';\n    }\n\n    var allTabs = {};\n\n    var main = {\n        objects:        {},\n        states:         {},\n        currentHost:    '',\n        currentTab:     null,\n        currentDialog:  null,\n        currentUser:    '',\n        subscribesStates: {},\n        subscribesObjects: {},\n        subscribesLogs: 0,\n        socket:         io.connect('/', {path: path}),\n        systemConfig:   null,\n        instances:      null,\n        objectsLoaded:  false,\n        waitForRestart: false,\n        tabs:           null,\n        dialogs:        {},\n        selectId:       null,\n        config:         {},\n        //ignoreJSupdate: false, // set to true after some global script updated and till system.adapter.javascript.x updated\n        addEventMessage: function (id, stateOrObj, isMessage, isState) {\n            // cannot directly use tabs.events.add, because to init time not available.\n            tabs.events.add(id, stateOrObj, isMessage, isState);\n        },\n        saveConfig:     function (attr, value) {\n            if (attr) main.config[attr] = value;\n\n            if (typeof storage !== 'undefined') {\n                storage.set('adminConfig', JSON.stringify(main.config));\n            }\n        },\n        saveTabs:       function () {\n            this.socket.emit ('setObject', 'system.config', this.systemConfig, function (err) {\n                err && this.showError(err);\n            });\n        },\n\n        // Helper methods\n        upToDate:       function (_new, old) {\n            _new = _new.split('.');\n            old = old.split('.');\n            _new[0] = parseInt(_new[0], 10);\n            old[0] = parseInt(old[0], 10);\n            if (_new[0] > old[0]) {\n                return false;\n            } else if (_new[0] === old[0]) {\n                _new[1] = parseInt(_new[1], 10);\n                old[1] = parseInt(old[1], 10);\n                if (_new[1] > old[1]) {\n                    return false;\n                } else if (_new[1] === old[1]) {\n                    _new[2] = parseInt(_new[2], 10);\n                    old[2] = parseInt(old[2], 10);\n                    return (_new[2] <= old[2]);\n                } else {\n                    return true;\n                }\n            } else {\n                return true;\n            }\n        },\n\n        // Methods\n        cmdExec:        function (host, cmd, callback) {\n            host = host || main.currentHost;\n            $stdout.val('');\n\n            $dialogCommand.modal('open');\n\n            stdout = '$ ./iobroker ' + cmd;\n            $dialogCommand.data('finished', false).find('.btn').html(_('In background'));\n            $dialogCommand.find('.command').html(stdout);\n            $dialogCommand.find('.progress-dont-close').removeClass('disabled');\n            $adminSideMain.find('.button-command').removeClass('error').addClass('in-progress');\n            $dialogCommand.data('max', null);\n            $dialogCommand.data('error', '');\n            $dialogCommandProgress.addClass('indeterminate').removeClass('determinate');\n\n            if (cmd.match(/^upload /)) {\n                $dialogCommand.find('.progress-text').html(_('Upload started...')).removeClass('error');\n            } else if (cmd.match(/^del [-_\\w\\d]+\\.[\\d]+$/)) {\n                $dialogCommand.find('.progress-text').html(_('Removing of instance...')).removeClass('error');\n            } else if (cmd.match(/^del /)) {\n                $dialogCommand.find('.progress-text').html(_('Removing of adapter...')).removeClass('error');\n            } else if (cmd.match(/^url /)) {\n                $dialogCommand.find('.progress-text').html(_('Install or update from URL...')).removeClass('error');\n            }  else if (cmd.match(/^add /)) {\n                $dialogCommand.find('.progress-text').html(_('Add instance...')).removeClass('error');\n            } else{\n                $dialogCommand.find('.progress-text').html(_('Started...')).removeClass('error');\n            }\n\n            $stdout.val(stdout);\n            // generate the unique id to coordinate the outputs\n            activeCmdId = Math.floor(Math.random() * 0xFFFFFFE) + 1;\n            cmdCallback = callback;\n            main.socket.emit('cmdExec', host, activeCmdId, cmd, function (err) {\n                if (err) {\n                    stdout += '\\n' + _(err);\n                    $stdout.val(stdout);\n                    cmdCallback = null;\n                    callback(err);\n                } else {\n                    if (callback) callback();\n                }\n            });\n        },\n        confirmMessage: function (message, title, icon, buttons, callback) {\n            // if standard buttons\n            if (typeof buttons === 'function') {\n                callback = buttons;\n                $dialogConfirm.find('.modal-footer').html(\n                    '<a class=\"modal-action modal-close waves-effect waves-green btn-flat translate\" data-result=\"true\">' + _('Ok') + '</a>' +\n                    '<a class=\"modal-action modal-close waves-effect waves-green btn-flat translate\">' + _('Cancel') + '</a>');\n                $dialogConfirm.find('.modal-footer .modal-action').on('click', function () {\n                    var cb = $dialogConfirm.data('callback');\n                    cb && cb($(this).data('result'));\n                });\n            } else if (typeof buttons === 'object') {\n                var tButtons = '';\n                for (var b = buttons.length - 1; b >= 0; b--) {\n                    tButtons += '<a class=\"modal-action modal-close waves-effect waves-green btn-flat translate\" data-id=\"' + b + '\">' + buttons[b] + '</a>';\n                }\n                $dialogConfirm.find('.modal-footer').html(tButtons);\n                $dialogConfirm.find('.modal-footer .modal-action').on('click', function () {\n                    var cb = $dialogConfirm.data('callback');\n                    cb && cb($(this).data('id'));\n                });\n            }\n\n            $dialogConfirm.find('.dialog-title').text(title || _('Please confirm'));\n            if (icon) {\n                $dialogConfirm.find('.dialog-icon')\n                    .show()\n                    .html(icon);\n            } else {\n                $dialogConfirm.find('.dialog-icon').hide();\n            }\n            $dialogConfirm.find('.dialog-text').html(message);\n            $dialogConfirm.data('callback', callback);\n            $dialogConfirm.modal('open');\n        },\n        showMessage:    function (message, title, icon) {\n            $dialogMessage.find('.dialog-title').text(title || _('Message'));\n            if (icon) {\n                $dialogMessage.find('.dialog-icon')\n                    .show()\n                    .html(icon);\n            } else {\n                $dialogMessage.find('.dialog-icon').hide();\n            }\n            $dialogMessage.find('.dialog-text').html(message);\n            $dialogMessage.modal('open');\n        },\n        showError:      function (error) {\n            main.showMessage(_(error),  _('Error'), 'error_outline');\n        },\n        showToast:      function (parent, message, icon, duration, isError, classes) {\n            if (parent && parent instanceof jQuery) {\n                parent = parent[0];\n            }\n            classes = classes || [];\n\n            if (typeof classes === 'string') {\n                classes = [classes];\n            }\n            isError && classes.push('dropZone-error');\n\n            M.toast({\n                parentSelector: parent || $('body')[0],\n                html:           message + (icon ? '<i class=\"material-icons\">' + icon + '</i>' : ''),\n                displayLength:  duration || 3000,\n                classes:        classes\n            });\n        },\n        formatDate:     function (dateObj, justTime) {\n            //return dateObj.getFullYear() + '-' +\n            //    (\"0\" + (dateObj.getMonth() + 1).toString(10)).slice(-2) + '-' +\n            //    (\"0\" + (dateObj.getDate()).toString(10)).slice(-2) + ' ' +\n            //    (\"0\" + (dateObj.getHours()).toString(10)).slice(-2) + ':' +\n            //    (\"0\" + (dateObj.getMinutes()).toString(10)).slice(-2) + ':' +\n            //    (\"0\" + (dateObj.getSeconds()).toString(10)).slice(-2);\n            // Following implementation is 5 times faster\n            if (!dateObj) return '';\n            var text = typeof dateObj;\n            if (text === 'string') {\n                if (justTime) {\n                    return dateObj.substring(8);\n                } else {\n                    return dateObj;\n                }\n            }\n            // if less 2000.01.01 00:00:00\n            if (text !== 'object') dateObj = dateObj < 946681200000 ? new Date(dateObj * 1000) : new Date(dateObj);\n\n            var v;\n            if (!justTime) {\n                text = dateObj.getFullYear();\n                v = dateObj.getMonth() + 1;\n                if (v < 10) {\n                    text += '-0' + v;\n                } else {\n                    text += '-' + v;\n                }\n\n                v = dateObj.getDate();\n                if (v < 10) {\n                    text += '-0' + v;\n                } else {\n                    text += '-' + v;\n                }\n            } else {\n                v = dateObj.getDate();\n                if (v < 10) {\n                    text = '0' + v;\n                } else {\n                    text = v;\n                }\n            }\n\n            v = dateObj.getHours();\n            if (v < 10) {\n                text += ' 0' + v;\n            } else {\n                text += ' ' + v;\n            }\n            v = dateObj.getMinutes();\n            if (v < 10) {\n                text += ':0' + v;\n            } else {\n                text += ':' + v;\n            }\n\n            v = dateObj.getSeconds();\n            if (v < 10) {\n                text += ':0' + v;\n            } else {\n                text += ':' + v;\n            }\n\n            v = dateObj.getMilliseconds();\n            if (v < 10) {\n                text += '.00' + v;\n            } else if (v < 100) {\n                text += '.0' + v;\n            } else {\n                text += '.' + v;\n            }\n\n            return text;\n        },\n        /*initSelectId:   function () {\n            if (main.selectId) return main.selectId;\n            main.selectId = $('#dialog-select-member').selectId('init',  {\n                objects: main.objects,\n                states:  main.states,\n                filter: {type: 'state'},\n                name:   'admin-select-member',\n                texts: {\n                    select:   _('Select'),\n                    cancel:   _('Cancel'),\n                    all:      _('All'),\n                    id:       _('ID'),\n                    name:     _('Name'),\n                    role:     _('Role'),\n                    room:     _('Room'),\n                    value:    _('Value'),\n                    selectid: _('Select ID'),\n                    from:     _('From'),\n                    lc:       _('Last changed'),\n                    ts:       _('Time stamp'),\n                    wait:     _('Processing...'),\n                    ack:      _('Acknowledged')\n                },\n                columns: ['image', 'name', 'role', 'room', 'value']\n            });\n            return main.selectId;\n        },*/\n        updateWizard:   function () {\n            var $wizard = $('#button-wizard');\n            if (main.objects['system.adapter.discovery.0']) {\n                if (!$wizard.data('inited')) {\n                    $wizard.data('inited', true);\n                    $wizard/*.button({\n                        icons: {primary: ' ui-icon-search'},\n                        text: false\n                    })*/.on('click', function () {\n                        // open configuration dialog\n                        main.navigate({\n                            tab: 'instances',\n                            dialog: 'config',\n                            params: 'system.adapter.discovery.0'\n                        });\n                    }).attr('title', _('Device discovery'));\n                }\n                $wizard.show();\n\n                // Show wizard dialog\n                if (!main.systemConfig.common.wizard && main.systemConfig.common.licenseConfirmed) {\n                    $wizard.trigger('click');\n                }\n            } else {\n                $wizard.hide();\n            }\n        },\n        getUser:        function () {\n            if (!main.currentUser) {\n                main.socket.emit('authEnabled', function (auth, user) {\n                    main.currentUser = 'system.user.' + user;\n                    if (!auth) {\n                        $('#button-logout').remove();\n                    } else {\n                        main._lastTimer = (new Date()).getTime();\n                        monitor();\n                    }\n                });\n            } else if (main.objects[main.currentUser]) {\n                var obj = main.objects[main.currentUser];\n                var name = '';\n                if (!obj || !obj.common || !obj.common.name) {\n                    name = main.currentUser.replace(/^system\\.user\\./);\n                    name = name[0].toUpperCase() + name.substring(1).toLowerCase();\n                } else {\n                    name = translateName(obj.common.name);\n                }\n                if (obj && obj.common && obj.common.icon) {\n                    var objs = {};\n                    objs[main.currentUser] = obj;\n                    $('#current-user-icon').html(main.getIcon(main.currentUser, null, objs));\n                } else {\n                    $('#current-user-icon').html('<i class=\"large material-icons\">account_circle</i>');\n                }\n                $('#current-user').html(name);\n                var groups = [];\n                for (var i = 0; i < tabs.users.groups.length; i++) {\n                    var group = main.objects[tabs.users.groups[i]];\n                    if (group && group.common && group.common.members && group.common.members.indexOf(main.currentUser) !== -1) {\n                        groups.push(_(translateName(group.common.name)));\n                    }\n                }\n                $('#current-group').html(groups.join(', '));\n            }\n        },\n\n        // Delete objects\n        _delObject:     function (idOrList, callback) {\n            var id;\n            if (!Array.isArray(idOrList)) {\n                if (typeof idOrList !== 'string') return callback && callback('invalid idOrList parameter');\n                idOrList = [idOrList];\n            }\n\n            function doIt() {\n                if (idOrList.length === 0) {\n                    return callback && setTimeout(callback, 0, null, id);\n                }\n                id = idOrList.pop();\n                if (main.objects[id] && main.objects[id].common && (main.objects[id].common['object-non-deletable'] || main.objects[id].common.dontDelete)) {\n                    main.showMessage (_ ('Cannot delete \"%s\" because not allowed', id), '', 'notifications');\n                    setTimeout(doIt, 0);\n                } else {\n                    var obj = main.objects[id];\n                    main.socket.emit('delObject', id, function (err) {\n                        if (err && err !== 'Not exists') {\n                            main.showError (err);\n                            return callback(err);\n                        }\n                        if (obj && obj.type === 'state') {\n                            main.socket.emit ('delState', id, function (err) {\n                                if (err && err !== 'Not exists') {\n                                    main.showError (err);\n                                    return callback(err);\n                                }\n                                setTimeout(doIt, 0);\n                            });\n                        } else {\n                            setTimeout(doIt, 0);\n                        }\n                    });\n                }\n            }\n            doIt();\n        },     \n        _delObjects:    function (rootId, isAll, callback) {\n            if (!isAll) {\n                this._delObject(rootId, callback);\n            } else {\n                var list = [];\n                for (var id in main.objects) {\n                    if (main.objects.hasOwnProperty(id) && id.substring(0, rootId.length + 1) === rootId + '.') {\n                        list.push(id);\n                    }\n                }\n                list.push(rootId);\n                list.sort();\n\n                this._delObject(list, function () {\n                    if (callback) callback();\n                });\n            }\n        },\n        delObject:      function ($tree, id, callback) {\n            var leaf = $tree ? $tree.selectId('getTreeInfo', id) : null;\n            if (main.objects[id]) {\n                if (leaf && leaf.children) {\n                    // ask if only object must be deleted or just this one\n                    main.confirmMessage(_('Do you want to delete just <span style=\"color: blue\">one object</span> or <span style=\"color: red\">all</span> children of %s too?', id), null, 'help_outline', [_('_All'), _('Only one'), _('Cancel')], function (result) {\n                        // If all\n                        if (result === 0) {\n                            main._delObjects(id, true, callback);\n                        } else\n                        // if only one object\n                        if (result === 1) {\n                            main._delObjects(id, false, callback);\n                        } // else do nothing\n                    });\n                } else {\n                    main.confirmMessage(_('Are you sure to delete %s?', id), null, 'help_outline', function (result) {\n                        // If all\n                        if (result) main._delObjects(id, true, callback);\n                    });\n                }\n            } else if (leaf && leaf.children) {\n                main.confirmMessage(_('Are you sure to delete all children of %s?', id), null, 'help_outline', function (result) {\n                    // If all\n                    if (result) main._delObjects(id, true, callback);\n                });\n            } else {\n                main.showMessage(_('Object \"<b>%s</b>\" does not exists. Update the page.', id), _('Error'), 'help_outline', function (result) {\n                    // If all\n                    if (result) main._delObjects(id, true, callback);\n                });\n            }\n        }\n    };\n\n    gMain = main; // for google maps\n\n    var tabs = {\n        hosts:      new Hosts(main), // must be first to read the list of hosts\n        objects:    new Objects(main),\n        adapters:   new Adapters(main),\n        instances:  new Instances(main),\n        users:      new Users(main),\n        enums:      new Enums(main),\n        events:     new Events(main),\n        logs:       new Logs(main),\n        states:     null,\n        intro:      new Intro(main),\n        info:       new InfoAdapter(main)\n    };\n\n    if (typeof States !== 'undefined') {\n        tabs.states = new States(main);\n    }\n\n    main.instances     = tabs.instances.list;\n    main.tabs          = tabs;\n    main.dialogs       = {\n        system:     new System(main),\n        customs:    new Customs(main),\n        config:     new Config(main),\n        editobject: new EditObject(main),\n        issue:      new Issue(main),\n        readme:     new Readme(main)\n    };\n\n    var stdout;\n    var cmdCallback    = null;\n    var activeCmdId    = null;\n    var $stdout        = $('#stdout');\n\n    var $dialogCommand = $('#dialog-command');\n    var $dialogLicense = $('#dialog-license-main');\n    var $dialogMessage = $('#dialog-message');\n    var $dialogConfirm = $('#dialog-confirm');\n    var $dialogCommandProgress = $dialogCommand.find('.progress div');\n\n    var $adminSideMenu = $('#admin_sidemenu_menu');\n    var $adminSideMain = $('#admin_sidemenu_main');\n\n    var firstConnect   = true;\n\n    // detect touch devices\n    if (!('ontouchstart' in window || navigator.maxTouchPoints)) {\n        $('body').addClass('desktop-screen');\n    }\n    if (navigator.userAgent.indexOf('Safari') !== -1 &&\n        navigator.userAgent.indexOf('Chrome') === -1 &&\n        navigator.userAgent.indexOf('Android') === -1) {\n        $('body').addClass('safari');\n        main.browser = 'safari';\n        main.noSelect = true;\n    } else if (detectIE()) {\n        $('body').addClass('ie');\n        // workaround\n        main.browser = 'ie';\n        main.browserVersion = detectIE();\n        main.noSelect = true;\n        $('#host-adapters-btn').css('margin-top', '10px');\n    }\n\n    // Read all positions, selected widgets for every view,\n    // Selected view, selected menu page,\n    // Selected widget or view page\n    // Selected filter\n    if (typeof storage !== 'undefined') {\n        try {\n            main.config = storage.get('adminConfig');\n            if (main.config) {\n                main.config = JSON.parse(main.config);\n            } else {\n                main.config = {};\n            }\n        } catch (e) {\n            console.log('Cannot load edit config');\n            main.config = {};\n        }\n    }\n\n    function globalClickHandler(event){\n        $('#admin_sidemenu_dialog').html('');\n        $('html').off('click', globalClickHandler);\n    }\n\n    function initHtmlButtons() {\n        main.socket.emit('getVersion', function (err, version) {\n\t\t\tvar $versionBtn = $('.button-version');\n\t        if (!$versionBtn.hasClass('vendor')) {\n\t            $versionBtn.text('ioBroker.admin ' + version);\n\t        }\n        });\n\n        $('.choose-tabs-config-button').off('click').on('click', function(event) {\n            var $dialog = $('#admin_sidemenu_dialog');\n            var html = $dialog.html();\n            if (html) {\n                $dialog.html('');\n                // disable global handler\n                $('html').off('click', globalClickHandler);\n                return;\n            }\n            setTimeout(function () {\n                // enable global handler\n                $('html').on('click', globalClickHandler);\n            }, 100);\n            var $e = $(event.target);\n            var offs = $e.offset();\n            offs.top += $e.height() - 2;\n\n            var text =\n                '<dialog open class=\"tab-selector m\" style=\"top: ' + offs.top + 'px; left: ' + offs.left + 'px;\">' + // style=\"overflow: visible; z-index: 999; \">'\n                '<div>' +\n                '<ul style=\"\">';\n\n            var $lis = $adminSideMenu;\n            for (var tid in allTabs) {\n                var name = allTabs[tid];\n                var found = $adminSideMenu.find('.admin-sidemenu-items[data-tab=\"' + tid + '\"]').length;\n                // TABS\n                /*$adminSideMenu.each(function (i, e) {\n                    if (tid === $(e).attr('aria-controls')) {\n                        found = $(e);\n                        return false;\n                    }\n                });*/\n                var id = 'chk-' + tid;\n                text +=\n                    '<li><input ' + (found ? 'checked' : 'unchecked') + ' class=\"chk-tab filled-in\" type=\"checkbox\" id=\"' + id + '\" />' +\n                    '<span for=\"' + id + '\">' + _(name) + '</span></id>';\n            }\n            text += '' +\n                '</ul>' +\n                '</div>' +\n                '</dialog>';\n            $dialog.append(text);\n\n            $dialog.find('.chk-tab').off('change').on('change', function (event) {\n                var id = $(this).attr('id').substr(4);\n                if ($(this).prop('checked')) {\n                    main.systemConfig.common.tabs.push(id);\n                } else {\n                    var pos = main.systemConfig.common.tabs.indexOf(id);\n                    if (id !== -1) {\n                        main.systemConfig.common.tabs.splice(pos, 1);\n                    }\n                }\n                main.saveTabs();\n                initTabs();\n            });\n            // workaround for materialize checkbox problem\n            $dialog.find('input[type=\"checkbox\"]+span').off('click').on('click', function () {\n                var $input = $(this).prev();\n                if (!$input.prop('disabled')) {\n                    $input.prop('checked', !$input.prop('checked')).trigger('change');\n                }\n            });\n        });\n\n        main.updateWizard();\n        \n        $('#button-logout').on('click', function () {\n            window.location.href = '/logout/';\n        });\n        \n        setTimeout(function () {\n            main.tabs.info.init();\n        }, 5000);\n\n        window.onhashchange = function () {\n            main.navigateDo();\n        };\n        main.navigateDo();\n    }\n\n    function initHtmlTabs() {\n        // jQuery UI initializations\n        initSideNav();\n\n        if (!main.tabsInited) {\n            main.tabsInited = true;\n\n            initHtmlButtons();\n\n            $('#events_threshold').on('click', function () {\n                main.socket.emit('eventsThreshold', false);\n            });\n        } else {\n            var $menu = $adminSideMenu;\n            var panelSelector = $menu.data('problem-link');\n            if (panelSelector) {\n                var $panel = $(panelSelector);\n                // Init source for iframe\n                if ($panel.length) {\n                    var link = $panel.data('src');\n                    if (link && link.indexOf('%') === -1) {\n                        var $iframe = $panel.find('iframe');\n                        if ($iframe.length && !$iframe.attr('src')) {\n                            $iframe.attr('src', link);\n                            $menu.data('problem-link', null);\n                        }\n                    }\n                }\n            }\n            // show current tab\n            main.currentHash = null;\n            main.navigateDo();\n        }\n    }\n\n    function initTabs() {\n        // extract all additional instances\n        var text     = '';\n        var list     = [];\n        var addTabs = [];\n\n        allTabs = {};\n        for (var i = 0; i < main.instances.length; i++) {\n            var instance = main.instances[i];\n            var instanceObj = main.objects[instance];\n            if (!instanceObj.common || !instanceObj.common.adminTab) continue;\n            if (instanceObj.common.adminTab.singleton) {\n                var isFound = false;\n                var inst1 = instance.replace(/\\.(\\d+)$/, '.');\n                for (var j = 0; j < addTabs.length; j++) {\n                    var inst2 = addTabs[j].replace(/\\.(\\d+)$/, '.');\n                    if (inst1 === inst2) {\n                        isFound = true;\n                        break;\n                    }\n                }\n                if (!isFound) addTabs.push(instance);\n            } else {\n                addTabs.push(instance);\n            }\n        }\n\n        // Build the standard tabs together\n        $('.admin-tab').each(function () {\n            var $this = $(this);\n            var id = $this.attr('id');\n            list.push(id);\n            allTabs[id] = $this.data('name');\n        });\n\n        // Look for adapter tabs\n        for (var a = 0; a < addTabs.length; a++) {\n            var tab   = main.objects[addTabs[a]];\n            var name  = 'tab-' + tab.common.name;\n\n            var link  = tab.common.adminTab.link || '/adapter/' + tab.common.name + '/tab.html';\n            if (tab.common.materializeTab) {\n                link  = tab.common.adminTab.link || '/adapter/' + tab.common.name + '/tab_m.html';\n            }\n\n            var parts = addTabs[a].split('.');\n            var buttonName;\n\n            if (tab.common.adminTab.name) {\n                if (typeof tab.common.adminTab.name === 'object') {\n                    if (tab.common.adminTab.name[systemLang]) {\n                        buttonName = tab.common.adminTab.name[systemLang];\n                    } else if (tab.common.adminTab.name.en) {\n                        buttonName = _(tab.common.adminTab.name.en);\n                    } else {\n                        buttonName = _(tab.common.name);\n                    }\n                } else {\n                    buttonName = _(tab.common.adminTab.name);\n                }\n            } else {\n                buttonName = _(tab.common.name);\n            }\n\n            if (!tab.common.adminTab.singleton) {\n                if (link.indexOf('?') !== -1) {\n                    link += '&instance=' + parts[3];\n                } else {\n                    link += '?instance=' + parts[3];\n                }\n                buttonName += '.' + parts[3];\n                name += '-' + parts[3];\n            } else {\n                parts[3] = 0;\n            }\n\n            list.push(name);\n            allTabs[name] = buttonName;\n\n            if (!main.systemConfig.common.tabs || main.systemConfig.common.tabs.indexOf(name) !==-1) {\n                var isReplace = false;\n                if (!link) {\n                    link = '/adapter/' + parts[2] + '/tab.html';\n                    if (tab.common.materilizeTab) {\n                        link = '/adapter/' + parts[2] + '/tab_m.html';\n                    }\n                } else {\n                    isReplace = link.indexOf('%') !== -1;\n                }\n\n                text += '<li><a href=\"#' + name + '\">' + buttonName + '</a></li>\\n';\n\n                // noinspection JSJQueryEfficiency\n                if (!$('#' + name).length) {\n                    var div = '<div id=\"' + name + '\" data-name=\"' + buttonName + '\" class=\"tab-custom ' + (isReplace ? 'link-replace' : '') + '\" data-adapter=\"' + parts[2] + '\" data-instance=\"' + parts[3] + '\" data-src=\"' + link + '\">' +\n                        '<iframe class=\"iframe-in-tab\" style=\"border: 0; solid #FFF; display: block; left: 0; top: 0; width: 100%; height: 100%\"' +\n                        '></iframe></div>';\n                    $(div).hide().appendTo($('body'));\n\n                    // TODO: temporary, until other tab will be adapted\n                    $('#' + name).find ('.iframe-in-tab').on('load', function () {\n                        var elem = $ (this).contents ().find('body>header');\n                        if (!elem || !elem.length) elem = $(this).contents ().find('head');\n                        if (elem && elem.length) elem.append('<link rel=\"stylesheet\" type=\"text/css\" href=\"../../lib/css/iob/selectID.css\"/>');\n                    });\n                } else {\n                    $('#' + name).hide().appendTo($('body'));\n                }\n            } else {\n                $('#' + name).hide().appendTo($('body'));\n            }\n        }\n        $('.tab-custom').each(function () {\n            if (list.indexOf($(this).attr('id')) === -1) {\n                $('#' + $(this).attr('id')).remove();\n            }\n        });\n\n        if (!main.systemConfig.common.tabs) main.systemConfig.common.tabs = list;\n\n        if ($('.link-replace').length) {\n            var countLink = 0;\n\n            // If some objects cannot be read => go by timeout\n            var loadTimeout = setTimeout(function() {\n                loadTimeout = null;\n                initHtmlTabs(/*showTabs*/);\n            }, 100);\n\n            $('.link-replace').each(function () {\n                // convert \"http://%ip%:%port%\" to \"http://localhost:1880\"\n                countLink++;\n                main.tabs.instances._replaceLinks($(this).data('src'), $(this).data('adapter'), $(this).data('instance'), $(this).attr('id'), function (link, adapter, instance, arg) {\n                    $('#' + arg).data('src', link).removeClass('link-replace');\n                    if (!--countLink) {\n                        if (loadTimeout) {\n                            clearTimeout(loadTimeout);\n                            loadTimeout = null;\n                            initHtmlTabs(/*showTabs*/);\n                        }\n                    }\n                });\n            });\n        } else {\n            initHtmlTabs();\n        }\n    }\n\n    main.initHostsList = function (isFirstInit) {\n        // fill the host list (select) on adapter tab\n        var $selHosts = $('#host-adapters');\n        if (isFirstInit && $selHosts.data('inited')) {\n            return;\n        }\n\n        $selHosts.data('inited', true);\n\n        main.currentHost = main.currentHost || main.config.currentHost || '';\n\n        var lines = [];\n        var color;\n        var curId;\n        for (var i = 0; i < main.tabs.hosts.list.length; i++) {\n            lines.push('<li><a data-value=\"' + main.tabs.hosts.list[i].name + '\">' + main.getHostIcon(main.objects[main.tabs.hosts.list[i].id], 'imgHost left') + main.tabs.hosts.list[i].name + '</a></li>');\n            if (!main.currentHost) {\n                main.currentHost = main.tabs.hosts.list[i].name;\n            }\n            if (main.currentHost === main.tabs.hosts.list[i].name) {\n                curId = main.tabs.hosts.list[i].id;\n            }\n        }\n        $selHosts.html(lines);\n\n        var $selBtn = $('#host-adapters-btn').show();\n        $selBtn\n            .text(_('Host:') + ' ' + main.currentHost)\n            .dropdown();\n\n        if (main.objects[curId] && main.objects[curId].common) {\n            color = main.objects[curId].common.color;\n        }\n\n        $selBtn.append($(main.getHostIcon(main.objects[curId], 'imgHost left')));\n        if (color) {\n            // set color of button\n        }\n\n        if (main.tabs.hosts.list.length < 2) {\n            $selBtn.addClass('disabled');\n        } else {\n            $selBtn.removeClass('disabled');\n        }\n\n        // host selector\n        $selHosts.find('a').on('click', function () {\n            var val = $(this).data('value');\n            var id  = 'system.host.' + val + '.alive';\n            if (!main.states[id] || !main.states[id].val || main.states[id].val === 'null') {\n                main.showMessage(_('Host %s is offline', $(this).val()));\n                return;\n            }\n\n            main.currentHost = val;\n\n            $('#host-adapters-btn')\n                .text(_('Host:') + ' ' + main.currentHost)\n                .append($(this).find('.imgHost').clone());\n            // destroy current view and load anew\n            console.log(main.currentTab);\n            if (tabsInfo['tab-' + main.currentTab] && tabsInfo['tab-' + main.currentTab].host) {\n                // destroy actual tab\n                if (main.tabs[main.currentTab] && typeof main.tabs[main.currentTab].destroy === 'function') {\n                    main.tabs[main.currentTab].destroy();\n                }\n\n                // init new tab\n                if (main.tabs[main.currentTab] && typeof main.tabs[main.currentTab].init === 'function') {\n                    main.tabs[main.currentTab].init();\n                }\n            }\n\n            main.saveConfig('currentHost', main.currentHost);\n        });\n    };\n\n    // Use the function for this because it must be done after the language was read\n    function initAllDialogs() {\n        // todo delete it because jqgrid does not used any more\n        if (typeof initGridLanguage === 'function') {\n            initGridLanguage(main.systemConfig.common.language);\n        }\n\n        $dialogCommand.modal({\n            dismissible: false\n        });\n        $dialogMessage.modal();\n        $dialogConfirm.modal({\n            dismissible: false\n        });\n\n        $dialogCommand.find('.progress-show-more').off('change').on('change', function () {\n            var val = $(this).prop('checked');\n            main.saveConfig('progressMore', val);\n            if (val) {\n                $dialogCommand.find('.textarea').show();\n            } else {\n                $dialogCommand.find('.textarea').hide();\n            }\n        });\n        if (main.config.progressClose === undefined) {\n            main.config.progressClose = true;\n        }\n        $dialogCommand.find('.progress-dont-close input').on('change', function () {\n            main.saveConfig('progressClose', $(this).prop('checked'));\n        });\n        // workaround for materialize checkbox problem\n        $dialogCommand.find('input[type=\"checkbox\"]+span').off('click').on('click', function () {\n            var $input = $(this).prev();\n            // ignore switch\n            if ($input.parent().parent().hasClass('switch')) return;\n\n            if (!$input.prop('disabled')) {\n                $input.prop('checked', !$input.prop('checked')).trigger('change');\n            }\n        });\n        $dialogCommand.find('.progress-dont-close input').prop('checked', main.config.progressClose);\n        $dialogCommand.find('.progress-show-more').prop('checked', !!main.config.progressMore).trigger('change');\n        $dialogCommand.find('.btn').on('click', function () {\n            if ($dialogCommand.data('finished')) {\n                $adminSideMain.find('.button-command').hide();\n            } else {\n                $adminSideMain.find('.button-command').show();\n            }\n        });\n\n        $adminSideMain.find('.button-command').on('click', function () {\n            $dialogCommand.modal('open');\n        });\n    }\n\n    function checkNodeJsVersions(hosts, index) {\n        index = index || 0;\n        if (hosts && index < hosts.length) {\n            main.socket.emit('sendToHost', hosts[index].name, 'getHostInfo', null, function (result) {\n                if (result && result['Node.js']) {\n                    var major = parseInt(result['Node.js'].split('.').shift().replace('v', ''), 10);\n                    if (major < 6 || major === 7 || major === 9  || major === 11 ) { // we allow 6, 8, 10 and 12+\n                        main.showMessage(_('This version of node.js \"%s\" on \"%s\" is deprecated. Please install node.js 6, 8 or newer', result['Node.js'], hosts[index].name), _('Suggestion'), 'error_outline');\n                    }\n                }\n                setTimeout(function () {\n                    checkNodeJsVersions(hosts, index + 1);\n                }, 100);\n            });\n        }\n    }\n\n    // ----------------------------- Objects show and Edit ------------------------------------------------\n    function getObjects(callback) {\n        main.socket.emit('getAllObjects', function (err, res) {\n            if (err) {\n                // following errors are possible\n                // permissionError\n                // Admin is not enabled in cloud settings!\n                window.alert(_(err));\n                return;\n            }\n\n            setTimeout(function () {\n                var obj;\n                main.objects = res;\n                for (var id in main.objects) {\n                    if (!main.objects.hasOwnProperty(id) || id.slice(0, 7) === '_design') continue;\n\n                    obj = main.objects[id];\n\n                    if (obj.type === 'instance') main.instances.push(id);\n                    if (obj.type === 'enum')     tabs.enums.list.push(id);\n                    if (obj.type === 'user')     tabs.users.list.push(id);\n                    if (obj.type === 'group')    tabs.users.groups.push(id);\n                    if (obj.type === 'adapter')  tabs.adapters.list.push(id);\n                    if (obj.type === 'host')     tabs.hosts.addHost(obj);\n\n                    // convert obj.history into obj.custom\n                    if (obj.common && obj.common.history) {\n                        obj.common.custom = JSON.parse(JSON.stringify(obj.common.history));\n                        delete obj.common.history;\n                    }\n                }\n                main.objectsLoaded = true;\n                main.initHostsList(true);\n\n                initTabs();\n                // init dialogs\n                for (var dialog in main.dialogs) {\n                    if (main.dialogs.hasOwnProperty(dialog) && typeof main.dialogs[dialog].prepare === 'function') {\n                        main.dialogs[dialog].prepare();\n                    }\n                }\n\n                // Detect node.js version\n                checkNodeJsVersions(tabs.hosts.list);\n\n                main.getUser();\n\n                if (typeof callback === 'function') callback();\n            }, 0);\n        });\n    }\n    // ----------------------------- States show and Edit ------------------------------------------------\n\n    function getStates(callback) {\n        if (tabs.states) tabs.states.clear();\n        main.socket.emit('getStates', function (err, res) {\n            main.states = res;\n            if (typeof callback === 'function') {\n                setTimeout(function () {\n                    callback();\n                }, 0);\n            }\n        });\n    }\n\n    function stateChange(id, state) {\n        id = id ? id.replace(/\\s/g, '_') : '';\n\n        if (!id || !id.match(/\\.messagebox$/)) {\n            if (tabs.states) {\n                tabs.states.stateChange(id, state);\n            }\n            tabs.objects.stateChange(id, state);\n            tabs.hosts.stateChange(id, state);\n\n            // Update alive and connected of main.instances\n            tabs.instances.stateChange(id, state);\n            tabs.adapters.stateChange(id, state);\n            main.dialogs.customs.stateChange(id, state);\n\n            if (main.selectId) {\n                main.selectId.selectId('state', id, state);\n            }\n            main.addEventMessage(id, state, false, true);\n        } else {\n            main.addEventMessage(id, state, true, true);\n        }\n    }\n\n    function objectChange(id, obj) {\n        //var changed = false;\n        var oldObj = null;\n        var action = 'update';\n\n        oldObj = main.objects[id];\n\n        // update main.objects cache\n        if (obj) {\n            if (obj._rev && main.objects[id]) main.objects[id]._rev = obj._rev;\n            if (!main.objects[id]) {\n                action = 'add';\n            }\n            if (action === 'add' || JSON.stringify(main.objects[id]) !== JSON.stringify(obj)) {\n                main.objects[id] = obj;\n            }\n        } else if (main.objects[id]) {\n            action = 'delete';\n            delete main.objects[id];\n        }\n\n        // update to event table\n        main.addEventMessage(id, obj, false, false);\n\n        tabs.objects.objectChange(id, obj, action);\n\n        main.selectId && main.selectId.selectId('object', id, obj, action);\n\n        tabs.enums.objectChange(id, obj, action);\n        tabs.intro.objectChange(id, obj, action);\n\n        // If system config updated\n        if (id === 'system.config') {\n            // Check language\n            if (main.systemConfig.common.language !== obj.common.language) {\n                window.location.reload();\n            }\n\n            main.systemConfig = obj;\n            initTabs();\n        }\n\n        if (id === 'system.adapter.discovery.0') {\n            main.updateWizard();\n        }\n\n        if (id.match(/^system\\.host\\.[-\\w]+$/)) {\n            main.initHostsList();\n        }\n\n        tabs.instances.objectChange(id, obj, action);\n\n        //if (id.match(/^script\\.js\\.global\\..*/)) {\n        //    main.ignoreJSupdate = true;\n        //}\n\n        if (obj && id.match(/^system\\.adapter\\.[\\w-]+\\.[0-9]+$/)) {\n            if (obj.common &&\n                obj.common.adminTab &&\n                !obj.common.adminTab.ignoreConfigUpdate\n            ) {\n                // Detect enable/disable change and do not update tabs (To able to work with global scripts normally)\n                var ignore = false;\n                // try to detect if javascript just enabled or disabled\n                if (oldObj && obj) {\n                    if (oldObj.common && obj.common) {\n                        var newObj = JSON.parse(JSON.stringify(obj));\n                        newObj.common.enabled = oldObj.common.enabled;\n                        newObj.ts = 0;\n                        oldObj.ts = 0;\n                        console.log(JSON.stringify(newObj));\n                        console.log(JSON.stringify(oldObj));\n                        if (JSON.stringify(newObj) === JSON.stringify(oldObj)) {\n                            ignore = true;\n                        }\n                    }\n                }\n                !ignore && initTabs();\n                /*} else {\n                    main.ignoreJSupdate = false;\n                }*/\n            }\n\n            if (obj && obj.type === 'instance' && obj.common.supportCustoms) {\n                // Update all states if customs enabled or disabled\n                tabs.objects.reinit();\n            }\n        }\n\n        tabs.hosts.objectChange(id, obj, action);\n\n        // Update users\n        tabs.users.objectChange(id, obj, action);\n\n        // update user in side menu\n        if (id === main.currentUser) {\n            main.getUser();\n        }\n    }\n\n    function monitor() {\n        if (main._timer) return;\n        var ts = (new Date()).getTime();\n        if (ts - main._lastTimer > 30000) {\n            // It seems, that PC was in a sleep => Reload page to request authentication anew\n            location.reload();\n        } else {\n            main._lastTimer = ts;\n        }\n        main._timer = setTimeout(function () {\n            main._timer = null;\n            monitor();\n        }, 10000);\n    }\n\n    // ---------------------------- Subscribes ---------------------------------------------\n    main.resubscribeStates = function () {\n        for (var pattern in main.subscribesStates) {\n            if (main.subscribesStates.hasOwnProperty(pattern) && main.subscribesStates[pattern]) {\n                console.debug('Re-Subscribe: ' + pattern);\n                main.socket.emit('subscribe', pattern);\n            }\n        }\n    };\n\n    main.resubscribeObjects = function () {\n        for (var pattern in main.subscribesObjects) {\n            if (main.subscribesObjects.hasOwnProperty(pattern) && main.subscribesObjects[pattern]) {\n                main.socket.emit('subscribeObjects', pattern);\n            }\n        }\n    };\n\n    main.resubscribeLogs = function () {\n        if (main.subscribesLogs) {\n            console.debug('Subscribe LOG');\n            main.socket.emit('requireLog', true);\n        }\n    };\n\n    main.subscribeStates = function (patterns) {\n        if (!patterns) return;\n        if (typeof patterns === 'object') {\n            for (var s = 0; s < patterns.length; s++) {\n                main.subscribesStates[patterns[s]] = main.subscribesStates[patterns[s]] || 0;\n                main.subscribesStates[patterns[s]]++;\n                if (main.subscribesStates[patterns[s]] === 1) {\n                    console.debug('Subscribe: ' + patterns[s]);\n                    main.socket.emit('subscribe', patterns[s]);\n                }\n            }\n        } else {\n            main.subscribesStates[patterns] = main.subscribesStates[patterns] || 0;\n            main.subscribesStates[patterns]++;\n            if (main.subscribesStates[patterns] === 1) {\n                console.debug('Subscribe: ' + patterns);\n                main.socket.emit('subscribe', patterns);\n            }\n        }\n    };\n\n    main.unsubscribeStates = function (patterns) {\n        if (!patterns) return;\n        if (typeof patterns === 'object') {\n            for (var s = 0; s < patterns.length; s++) {\n                if (main.subscribesStates[patterns[s]]) {\n                    main.subscribesStates[patterns[s]]--;\n                }\n                if (main.subscribesStates[patterns[s]] === 0) {\n                    console.debug('Unsibscribe: ' + patterns[s]);\n                    main.socket.emit('unsubscribe', patterns[s]);\n                    delete main.subscribesStates[patterns[s]];\n                }\n            }\n        } else {\n            if (main.subscribesStates[patterns]) {\n                main.subscribesStates[patterns]--;\n            }\n            if (main.subscribesStates[patterns] === 0) {\n                console.debug('Unsibscribe: ' + patterns);\n                main.socket.emit('unsubscribe', patterns);\n                delete main.subscribesStates[patterns];\n            }\n        }\n    };\n\n    main.subscribeObjects = function (patterns) {\n        if (!patterns) return;\n        if (typeof patterns === 'object') {\n            for (var s = 0; s < patterns.length; s++) {\n                main.subscribesObjects[patterns[s]] = main.subscribesObjects[patterns[s]] || 0;\n                main.subscribesObjects[patterns[s]]++;\n                if (main.subscribesObjects[patterns[s]] === 1) {\n                    main.socket.emit('subscribeObjects', patterns[s]);\n                }\n            }\n        } else {\n            main.subscribesObjects[patterns] = main.subscribesObjects[patterns] || 0;\n            main.subscribesObjects[patterns]++;\n            if (main.subscribesObjects[patterns] === 1) {\n                main.socket.emit('subscribeObjects', patterns);\n            }\n        }\n    };\n\n    main.unsubscribeObjects = function (patterns) {\n        if (!patterns) return;\n        if (typeof patterns === 'object') {\n            for (var s = 0; s < patterns.length; s++) {\n                if (main.subscribesObjects[patterns[s]]) {\n                    main.subscribesObjects[patterns[s]]--;\n                }\n                if (main.subscribesObjects[patterns[s]] === 0) {\n                    main.socket.emit('unsubscribeObjects', patterns[s]);\n                    delete main.subscribesObjects[patterns[s]];\n                }\n            }\n        } else {\n            if (main.subscribesObjects[patterns]) {\n                main.subscribesObjects[patterns]--;\n            }\n            if (main.subscribesObjects[patterns] === 0) {\n                main.socket.emit('unsubscribeObjects', patterns);\n                delete main.subscribesObjects[patterns];\n            }\n        }\n    };\n\n    main.subscribeLogs = function (isSubscribe) {\n        if (isSubscribe) {\n            main.subscribesLogs++;\n            if (main.subscribesLogs === 1) {\n                console.debug('Subscribe Logs');\n                main.socket.emit('requireLog', true);\n            }\n        } else {\n            main.subscribesLogs--;\n            if (main.subscribesLogs <= 0) {\n                main.subscribesLogs = 0;\n                console.debug('Unsubscribe Logs');\n                main.socket.emit('requireLog', false);\n            }\n        }\n    };\n\n    // ---------------------------- Navigation ---------------------------------------------\n    main.navigateCheckDialog = function (callback) {\n        if (main.currentDialog && main.dialogs[main.currentDialog] && typeof main.dialogs[main.currentDialog].allStored === 'function') {\n            if (main.dialogs[main.currentDialog].allStored() === false) {\n                return main.confirmMessage(_('Some data are not stored. Discard?'), _('Please confirm'), null, function (result) {\n                    callback(!result);\n                });\n            }\n        } else {\n            if (configNotSaved) {\n                return main.confirmMessage(_('Some data are not stored. Discard?'), _('Please confirm'), null, function (result) {\n                    callback(!result);\n                });\n            }\n        }\n        callback(false);\n    };\n\n    main.navigateGetParams = function () {\n        var parts = decodeURI(window.location.hash).split('/');\n        return parts[2] ? decodeURIComponent(parts[2]) : null;\n    };\n\n    main.navigate = function (options) {\n        if (!options) {\n            options = {};\n        }\n        if (typeof options === 'string') {\n            options = {\n                tab:    options,\n                dialog: '',\n                params: ''\n            };\n        }\n\n        // get actual tab\n        if (!options.tab) {\n            var parts   = decodeURI(window.location.hash).split('/');\n            options.tab = parts[0].replace(/^#/, '').replace(/^tab-/, '');\n        }\n\n        window.location.hash = '#tab-' + encodeURIComponent(options.tab) + (options.dialog ? '/' + options.dialog + (options.params ? '/' + encodeURIComponent(options.params) : '') : '');\n    };\n\n    // Router\n    main.navigateDo = function () {\n        // ignore if hash not changed\n        if (window.location.hash === main.currentHash) {\n            return;\n        }\n        // if config dialog opened and has some unsaved data\n        main.navigateCheckDialog(function (err) {\n            if (!err) {\n                configNotSaved = null;\n                main.currentHash = window.location.hash;\n                // hash has following structure => #tabName/dialogName/ids\n                var parts  = main.currentHash.split('/');\n                var tab    = parts[0].replace(/^#/, '').replace(/^tab-/, '');\n                var dialog = parts[1];\n                var params = decodeURIComponent(parts[2]);\n\n                // set default page\n                if (!tab || tab === '!') {\n                    if (!main.systemConfig.common.tabs || main.systemConfig.common.tabs.indexOf('tab-intro') !== -1) {\n                        tab = 'intro';\n                    } else if (main.systemConfig.common.tabs.indexOf('tab-adapters') !== -1) {\n                        tab = 'adapters';\n                    } else {\n                        tab = main.systemConfig.common.tabs[0].replace(/^#/, '').replace(/^tab-/, '');\n                    }\n                }\n                // do tab is not found\n\n                var $adminBody = $('.admin-sidemenu-body');\n                var $actualTab = $adminBody.find('.admin-sidemenu-body-content');\n                var $panel     = $('#tab-' + tab);\n\n                $adminBody.find('.admin-preloader').remove();\n\n                if (!$panel.length) {\n                    tab = 'intro';\n                }\n\n                // if tab was changed\n                if (main.currentTab !== tab || !$actualTab.length) {\n                    var link;\n                    // destroy actual tab\n                    if (main.currentTab && tabs[main.currentTab] && typeof tabs[main.currentTab].destroy === 'function') {\n                        tabs[main.currentTab].destroy();\n                    } else if (main.currentTab) {\n                        var $oldPanel = $('#tab-' + main.currentTab);\n                        // destroy current iframe\n                        if ($oldPanel.length && (link = $oldPanel.data('src'))) {\n                            var $iframe_ = $oldPanel.find('>iframe');\n                            if ($iframe_.attr('src')) {\n                                console.log('clear');\n                                $iframe_.attr('src', '');\n                            }\n                        }\n                    }\n                    main.currentTab = tab;\n\n                    $actualTab.hide().appendTo('body');\n                    if (!dialog) {\n                        $panel.addClass('admin-sidemenu-body-content').show().appendTo($adminBody);\n                        $actualTab = $panel;\n                    }\n\n                    // init new tab\n                    if (tabs[tab] && typeof tabs[tab].init === 'function') {\n                        tabs[tab].init();\n                    }\n\n                    // if iframe like node-red\n                    if ($panel.length && (link = $panel.data('src'))) {\n                        if (link.indexOf('%') === -1) {\n                            var $iframe = $panel.find('>iframe');\n                            if ($iframe.length && !$iframe.attr('src')) {\n                                $iframe.attr('src', link);\n                            }\n                        } else {\n                            $adminSideMenu.data('problem-link', 'tab-' + tab);\n                        }\n                    }\n                }\n\n                // select menu element\n                var  $tab = $adminSideMenu.find('.admin-sidemenu-items[data-tab=\"tab-' + tab + '\"]');\n                $adminSideMenu.find('.admin-sidemenu-items').not($tab).removeClass('admin-sidemenu-active');\n                $tab.addClass('admin-sidemenu-active');\n\n                if (tabsInfo['tab-' + tab] && tabsInfo['tab-' + tab].host) {\n                    $('#host-adapters-btn').css('opacity', 1);\n                } else {\n                    $('#host-adapters-btn').css('opacity', 0.3);\n                }\n                document.title = tab + ' - ioBroker';\n                // if some dialog opened or must be shown\n                if (main.currentDialog !== dialog) {\n                    // destroy it\n                    if (main.dialogs[main.currentDialog] && typeof main.dialogs[main.currentDialog].destroy === 'function') {\n                        main.dialogs[main.currentDialog].destroy();\n                    }\n                    main.currentDialog = dialog;\n                    if (dialog && main.dialogs[dialog]) {\n                        if (typeof main.dialogs[dialog].init === 'function') {\n                            main.dialogs[dialog].init(params ? params.split(',') : undefined);\n                        }\n                        tabs[main.currentTab] && tabs[main.currentTab].saveScroll && tabs[main.currentTab].saveScroll();\n                        $actualTab.hide().appendTo('body');\n                        $('#dialog-' + dialog).addClass('admin-sidemenu-body-content').show().appendTo($adminBody);\n                    } else if ($actualTab.attr('id') !== $panel.attr('id')) {\n                        $actualTab.hide().appendTo('body');\n                        $panel.addClass('admin-sidemenu-body-content').show().appendTo($adminBody);\n                        tabs[main.currentTab] && tabs[main.currentTab].restoreScroll && tabs[main.currentTab].restoreScroll();\n                    }\n                }\n            } else {\n                // restore hash link\n                window.location.hash = main.currentHash || '';\n            }\n        });\n    };\n\n    function getIconHtml(obj, classes) {\n        var icon;\n        var alt;\n        var isCommon = obj && obj.common;\n\n        if (isCommon.icon) {\n            if (!isCommon.icon.match(/^data:image\\//)) {\n                if (isCommon.icon.indexOf('.') !== -1) {\n                    var instance;\n                    if (obj.type === 'instance') {\n                        icon = '/adapter/' + obj.common.name + '/' + obj.common.icon;\n                    } else if (obj._id.match(/^system\\.adapter\\./)) {\n                        instance = obj._id.split('.', 3);\n                        if (isCommon.icon[0] === '/') {\n                            instance[2] += isCommon.icon;\n                        } else {\n                            instance[2] += '/' + isCommon.icon;\n                        }\n                        icon = '/adapter/' + instance[2];\n                    } else {\n                        instance = obj._id.split('.', 2);\n                        if (isCommon.icon[0] === '/') {\n                            instance[0] += isCommon.icon;\n                        } else {\n                            instance[0] += '/' + isCommon.icon;\n                        }\n                        icon = '/adapter/' + instance[0];\n                    }\n                } else {\n                    return '<i class=\"material-icons ' + (classes || 'treetable-icon') + '\">' + isCommon.icon + '</i>';\n                }\n\n            } else {\n                icon = isCommon.icon;\n            }\n            alt = obj.type;\n        }\n        return {icon: icon, alt: alt};\n    }\n\n    main.getIconFromObj = function (obj, imgPath, classes) {\n        var icon     = '';\n        var alt      = '';\n        if (obj && obj.common) {\n            if (obj.common.icon) {\n                var result = getIconHtml(obj);\n                icon = result.icon;\n                alt = result.alt;\n            } else {\n                imgPath = imgPath || 'lib/css/fancytree/';\n                if (obj.type === 'device') {\n                    icon = imgPath + 'device.png';\n                    alt  = 'device';\n                } else if (obj.type === 'channel') {\n                    icon = imgPath + 'channel.png';\n                    alt  = 'channel';\n                } else if (obj.type === 'state') {\n                    icon = imgPath + 'state.png';\n                    alt  = 'state';\n                }\n            }\n        }\n\n        if (icon) return '<img class=\"' + (classes || 'treetable-icon') + '\" src=\"' + icon + '\" alt=\"' + (alt || '') + '\" />';\n        return '';\n    };\n\n    // static, just used from many places\n    main.getIcon = function(id, imgPath, objects, classes) {\n        return main.getIconFromObj((objects || main.objects)[id], imgPath, classes);\n    };\n\n    main.getHostIcon = function (obj, classes) {\n        var icon     = '';\n        var alt      = '';\n\n        if (obj && obj.common && obj.common.icon) {\n            var result = getIconHtml(obj);\n            icon = result.icon;\n            alt = result.alt;\n        }\n        icon = icon || 'img/no-image.png';\n        alt  = alt  || '';\n\n        return '<img class=\"' + (classes || 'treetable-icon') + '\" src=\"' + icon + '\" alt=\"' + alt + '\" />';\n    };\n\n    main.formatBytes = function (bytes) {\n        if (Math.abs(bytes) < 1024) {\n            return bytes + ' B';\n        }\n        var units = ['KiB','MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];\n        var u = -1;\n        do {\n            bytes /= 1024;\n            ++u;\n        } while (Math.abs(bytes) >= 1024 && u < units.length - 1);\n        return bytes.toFixed(1) + ' ' + units[u];\n    };\n\n    // https://stackoverflow.com/questions/35969656/how-can-i-generate-the-opposite-color-according-to-current-color\n    main.invertColor = function (hex) {\n        if (hex.indexOf('#') === 0) {\n            hex = hex.slice(1);\n        }\n        // convert 3-digit hex to 6-digits.\n        if (hex.length === 3) {\n            hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];\n        }\n        if (hex.length !== 6) {\n            return false;\n        }\n        var r = parseInt(hex.slice(0, 2), 16),\n            g = parseInt(hex.slice(2, 4), 16),\n            b = parseInt(hex.slice(4, 6), 16);\n        // http://stackoverflow.com/a/3943023/112731\n        return (r * 0.299 + g * 0.587 + b * 0.114) <= 186;\n    };\n\n    var tabsInfo = {\n        'tab-intro':            {order: 1,    icon: 'apps'},\n        'tab-info':             {order: 5,    icon: 'info',              host: true},\n        'tab-adapters':         {order: 10,   icon: 'store',             host: true},\n        'tab-instances':        {order: 15,   icon: 'subtitles',         host: true},\n        'tab-objects':          {order: 20,   icon: 'view_list'},\n        'tab-enums':            {order: 25,   icon: 'art_track'},\n        'tab-devices':          {order: 27,   icon: 'dvr',               host: true},\n        'tab-logs':             {order: 30,   icon: 'view_headline',     host: true},\n        'tab-scenes':           {order: 35,   icon: 'subscriptions'},\n        'tab-events':           {order: 40,   icon: 'flash_on'},\n        'tab-users':            {order: 45,   icon: 'person_outline'},\n        'tab-javascript':       {order: 50,   icon: 'code'},\n        'tab-text2command-0':   {order: 55,   icon: 'ac_unit'},\n        'tab-text2command-1':   {order: 56,   icon: 'ac_unit'},\n        'tab-text2command-2':   {order: 57,   icon: 'ac_unit'},\n        'tab-node-red-0':       {order: 60,   icon: 'device_hub'},\n        'tab-node-red-1':       {order: 61,   icon: 'device_hub'},\n        'tab-node-red-2':       {order: 62,   icon: 'device_hub'},        \n        'tab-fullcalendar-0':   {order: 65,   icon: 'perm_contact_calendar'},\n        'tab-fullcalendar-1':   {order: 66,   icon: 'perm_contact_calendar'},\n        'tab-fullcalendar-2':   {order: 67,   icon: 'perm_contact_calendar'},\n        'tab-hosts':            {order: 100,  icon: 'storage'},\n    };\n\n    function initSideNav() {\n        var lines = '';\n\n        var elements = [];\n        $('.admin-tab').each(function () {\n            var id = $(this).attr('id');\n            if (!main.systemConfig.common.tabs || main.systemConfig.common.tabs.indexOf(id) !== -1) {\n                elements.push({\n                    line: '<li class=\"admin-sidemenu-items\" data-tab=\"' + id + '\"><a href=\"#' + id + '\">' +\n                            (tabsInfo[id] && tabsInfo[id].icon ? '<i class=\"material-icons left\">' + tabsInfo[id].icon + '</i>' : '<i class=\"material-icons left\">live_help</i>') +\n                            _($(this).data('name')) + '</a></li>',\n                    id: id\n                });\n            }\n        });\n        $('.tab-custom').each(function () {\n            var id = $(this).attr('id');\n            if (!main.systemConfig.common.tabs || main.systemConfig.common.tabs.indexOf(id) !== -1) {\n                var icon;\n                if (tabsInfo[id] && tabsInfo[id].icon) {\n                    icon = tabsInfo[id].icon;\n                } else {\n                    var _id = 'system.adapter.' + id.substring(4);\n\t\t    if (main.objects[_id] && main.objects[_id].common.adminTab && main.objects[_id].common.adminTab['fa-icon']) {\n                        icon = main.objects[_id].common.adminTab['fa-icon'];\n                    }\n                }\n\n                elements.push({\n                    line: '<li class=\"admin-sidemenu-items\" data-tab=\"' + id + '\"><a href=\"#' + id + '\">' +\n                    (icon ? '<i class=\"material-icons left\">' + icon + '</i>' : '<i class=\"material-icons left\">live_help</i>') +\n                    $(this).data('name') + '</a></li>',\n                    id: id\n                });\n            }\n        });\n\n        elements.sort(function (a, b) {\n            if (!tabsInfo[a.id] && !tabsInfo[b.id]) return 0;\n            if (!tabsInfo[a.id]) return 1;\n            if (!tabsInfo[b.id]) return -1;\n            if (tabsInfo[a.id].order < tabsInfo[b.id].order) return -1;\n            if (tabsInfo[a.id].order > tabsInfo[b.id].order) return 1;\n            return 0;\n        });\n\n        for (var e = 0; e < elements.length; e++) {\n            lines += elements[e].line;\n        }\n        $adminSideMenu.find('.admin-sidemenu-menu').html(lines);\n\n        $('.admin-sidemenu-close').off('click').on('click', function () {\n            $adminSideMain.toggleClass('admin-sidemenu-closed');\n            $adminSideMenu.toggleClass('admin-sidemenu-closed');\n            $('.admin-sidemenu-close i').toggleClass('hide');\n\n            setTimeout(function () {\n                //resizeGrids();\n                $(window).trigger('resize');\n            }, 400);\n        });\n\n        $('.admin-sidemenu-items').off('click').on('click', function (e) {\n            e.preventDefault();\n            e.stopPropagation();\n            window.location.hash = '#' + $(this).data('tab');\n        });\n        $('.admin-sidemenu-items a').off('click').on('click', function (e) {\n            e.preventDefault();\n            e.stopPropagation();\n            window.location.hash = '#' + $(this).parent().data('tab');\n        });\n\n        // Show if update available\n        tabs.hosts.updateCounter();\n        tabs.adapters.updateCounter();\n    }\n\n    // ---------------------------- Socket.io methods ---------------------------------------------\n    main.socket.on('log',               function (message) {\n        tabs.logs.add(message);\n    });\n    main.socket.on('error',             function (error) {\n        console.log(error);\n    });\n    main.socket.on('permissionError',   function (err) {\n        main.showMessage(_('Has no permission to %s %s %s', err.operation, err.type, (err.id || '')));\n    });\n    main.socket.on('stateChange',       function (id, obj) {\n        setTimeout(stateChange, 0, id, obj);\n    });\n    main.socket.on('objectChange',      function (id, obj) {\n        setTimeout(objectChange, 0, id, obj);\n    });\n    main.socket.on('cmdStdout',         function (_id, text) {\n        if (activeCmdId === _id) {\n            var m = text.match(/^upload \\[(\\d+)]/);\n            if (m) {\n                if ($dialogCommand.data('max') === null) {\n                    $dialogCommand.data('max', parseInt(m[1], 10));\n                    $dialogCommandProgress.removeClass('indeterminate').addClass('determinate');\n                }\n                var max = $dialogCommand.data('max');\n                var value = parseInt(m[1], 10);\n                $dialogCommandProgress.css('width', (100 - Math.round((value / max) * 100)) + '%');\n            } else {\n                m = text.match(/^got [-_:\\/\\\\.\\w\\d]+\\/admin$/);\n                if (m) {\n                    // upload of admin\n                    $dialogCommand.find('.progress-text').html(_('Upload admin started'));\n                    $dialogCommand.data('max', null);\n                } else {\n                    // got ..../www\n                    m = text.match(/^got [-_:\\/\\\\.\\w\\d]+\\/www$/);\n                    if (m) {\n                        // upload of www\n                        $dialogCommand.find('.progress-text').html(_('Upload www started'));\n                        $dialogCommand.data('max', null);\n                    } else {\n\n                    }\n                }\n            }\n\n            stdout += '\\n' + text;\n            $stdout.val(stdout);\n            $stdout.scrollTop($stdout[0].scrollHeight - $stdout.height());\n        }\n    });\n    main.socket.on('cmdStderr',         function (_id, text) {\n        if (activeCmdId === _id) {\n            if (!$dialogCommand.data('error')) {\n                $dialogCommand.data('error', text);\n            }\n            stdout += '\\nERROR: ' + text;\n            $stdout.val(stdout);\n            $stdout.scrollTop($stdout[0].scrollHeight - $stdout.height());\n        }\n    });\n    main.socket.on('cmdExit',           function (_id, exitCode) {\n        if (activeCmdId === _id) {\n\n            exitCode = parseInt(exitCode, 10);\n            stdout += '\\n' + (exitCode !== 0 ? 'ERROR: ' : '') + 'process exited with code ' + exitCode;\n            $stdout.val(stdout);\n            $stdout.scrollTop($stdout[0].scrollHeight - $stdout.height());\n\n            $dialogCommand.find('.progress-dont-close').addClass('disabled');\n            $dialogCommandProgress.removeClass('indeterminate').css({'width': '100%'});\n            $dialogCommand.find('.btn').html(_('Close'));\n            $dialogCommand.data('finished', true);\n            $dialogCommand.data('max', true);\n            var $backButton = $adminSideMain.find('.button-command');\n            $backButton.removeClass('in-progress');\n\n            if (!exitCode) {\n                $dialogCommand.find('.progress-text').html(_('Success!'));\n                $backButton.hide();\n                if ($dialogCommand.find('.progress-dont-close input').prop('checked')) {\n                    setTimeout(function () {\n                        $dialogCommand.modal('close');\n                    }, 1500);\n                }\n            } else {\n                var error = $dialogCommand.data('error');\n                if (error) {\n                    var m = error.match(/error: (.*)$/);\n                    if (m) {\n                        error = m[1];\n                    }\n\n                    $dialogCommand.find('.progress-text').html(_('Done with error: %s', _(error))).addClass('error');\n                } else {\n                    $dialogCommand.find('.progress-text').html(_('Done with error')).addClass('error');\n                }\n                $backButton.addClass('error');\n                $backButton.show();\n            }\n            if (cmdCallback) {\n                cmdCallback(exitCode);\n                cmdCallback = null;\n            }\n        }\n    });\n    main.socket.on('eventsThreshold',   function (isActive) {\n        if (isActive) {\n            $('#events_threshold').show();\n        } else {\n            $('#events_threshold').hide();\n        }\n    });\n    main.socket.on('connect',           function () {\n        $('#connecting').hide();\n        if (firstConnect) {\n            firstConnect = false;\n\n            main.getUser();\n\n            main.socket.emit('getUserPermissions', function (err, acl) {\n                main.acl = acl;\n                // Read system configuration\n                main.socket.emit('getObject', 'system.config', function (errConfig, data) {\n                    main.systemConfig = data;\n\n                    // set logo and set branding\n                    if (data && data.native && data.native.vendor) {\n                        var vendor = data.native.vendor;\n                        if (vendor.icon) {\n                            $('.admin-sidemenu-header .button-icon img').attr('src', data.native.vendor.icon);\n                        }\n                        if (vendor.name) {\n                            $('.admin-sidemenu-header .button-version').html(data.native.vendor.name).addClass('vendor');\n                        }\n                        if (vendor.admin && vendor.admin.noCustomInstall) {\n                            $('#btn_filter_custom_url').hide();\n                        }\n                        if (vendor.admin && vendor.admin.css) {\n                            if (vendor.admin.css.sideNavUser) {\n                                $('.side-nav .user-view').css(vendor.admin.css.sideNavUser);\n                            }\n                            if (vendor.admin.css.sideNavMenu) {\n                                $('.side-nav').css(vendor.admin.css.sideNavMenu);\n                            }\n                            if (vendor.admin.css.header) {\n                                $adminSideMain.find('.admin-sidemenu-header nav').css(vendor.admin.css.header);\n                            }\n                            // apply rules\n                            if (vendor.admin.css.rules) {\n                                for (var r = 0; r < vendor.admin.css.rules.length; r++) {\n                                    $(vendor.admin.css.rules[r].selector).css(vendor.admin.css.rules[r].css);\n                                }\n                            }\n                            if (vendor.admin.styles) {\n                                $('head').append('<style type=\"text/css\">' + vendor.admin.styles + '</style>');\n                            }\n                        }\n                    }\n\n                    // rename log => logs (back compatibility)\n                    if (main.systemConfig && main.systemConfig.common && main.systemConfig.common.tabs) {\n                        var pos = main.systemConfig.common.tabs.indexOf('tab-log');\n                        if (pos !== -1) {\n                            main.systemConfig.common.tabs[pos] = 'tab-logs';\n                        }\n                    }\n\n                    main.socket.emit('getObject', 'system.repositories', function (errRepo, repo) {\n                        main.dialogs.system.systemRepos = repo;\n                        main.socket.emit('getObject', 'system.certificates', function (errCerts, certs) {\n                            setTimeout(function () {\n                                main.dialogs.system.systemCerts = certs;\n                                if (errConfig === 'permissionError') {\n                                    main.systemConfig = {common: {language: systemLang}, error: 'permissionError'};\n                                } else {\n                                    if (!errConfig && main.systemConfig && main.systemConfig.common) {\n                                        systemLang = main.systemConfig.common.language || systemLang;\n                                        main.systemConfig.common.city      = main.systemConfig.common.city      || '';\n                                        main.systemConfig.common.country   = main.systemConfig.common.country   || '';\n                                        main.systemConfig.common.longitude = main.systemConfig.common.longitude || '';\n                                        main.systemConfig.common.latitude  = main.systemConfig.common.latitude  || '';\n\n                                        if (!main.systemConfig.common.licenseConfirmed) {\n                                            // Show license agreement\n                                            var language = (main.systemConfig.common.language || window.navigator.userLanguage || window.navigator.language || '').substring(0, 2);\n                                            if (language !== 'en' && language !== 'de' && language !== 'ru') language = 'en';\n\n                                            systemLang = language;\n\n                                            $dialogLicense.find('.license_text').html(license[language] || license.en);\n\n                                            $dialogLicense.find('.license_checkbox').prop('checked', false);\n\n                                            // on language change\n                                            $dialogLicense.find('.license_language')\n                                                .data('licenseConfirmed', false)\n                                                .val(language)\n                                                .on('change', function () {\n                                                    language = $(this).val();\n                                                    $dialogLicense.find('.license_language_label').html(translateWord('Select language', language));\n                                                    $dialogLicense.find('.license_text').html(license[language] || license.en);\n                                                    $dialogLicense.find('.license_checkbox').html(translateWord('license_checkbox', language));\n                                                    $dialogLicense.find('.license_agree .translate').html(translateWord('agree', language));\n                                                    $dialogLicense.find('.license_non_agree .translate').html(translateWord('not agree', language));\n                                                    $dialogLicense.find('.license_terms').html(translateWord('License terms', language));\n                                                    $dialogLicense.find('.license_agreement_label').html(translateWord('license agreement', language));\n                                                }).select();\n\n                                            $dialogLicense.find('.license_diag').on('change', function () {\n                                                if ($(this).prop('checked')) {\n                                                    $dialogLicense.find('.license_agree').removeClass('disabled');\n                                                } else {\n                                                    $dialogLicense.find('.license_agree').addClass('disabled');\n                                                }\n                                            });\n\n                                            // workaround for materialize checkbox problem\n                                            $dialogLicense.find('input[type=\"checkbox\"]+span').off('click').on('click', function () {\n                                                var $input = $(this).prev();\n                                                if (!$input.prop('disabled')) {\n                                                    $input.prop('checked', !$input.prop('checked')).trigger('change');\n                                                }\n                                            });\n\n                                            $dialogLicense.modal({\n                                                dismissible: false,\n                                                complete: function () {\n                                                    $dialogLicense.find('.license_text').html('');\n                                                    location.reload();\n                                                }\n                                            }).modal('open');\n\n                                            $dialogLicense.find('.license_agree').addClass('disabled').off('click').on('click', function (e) {\n                                                e.preventDefault();\n                                                e.stopPropagation();\n\n                                                main.socket.emit('getObject', 'system.config', function (err, obj) {\n                                                    if (err || !obj) {\n                                                        main.showError(_('Cannot confirm: ' + err));\n                                                        return;\n                                                    }\n                                                    obj.common = obj.common || {};\n                                                    obj.common.licenseConfirmed = true;\n                                                    obj.common.language = language;\n                                                    main.socket.emit('setObject', 'system.config', obj, function (err) {\n                                                        if (err) {\n                                                            main.showError(err);\n                                                        }\n                                                        $dialogLicense.modal('close');\n                                                        $dialogLicense.find('.license_agree').off('click');\n                                                        $dialogLicense.find('.license_non_agree').off('click');\n                                                    });\n                                                });\n                                            });\n                                            $dialogLicense.find('.license_non_agree').off('click').on('click', function (e) {\n                                                location.reload();\n                                            });\n                                        }\n                                    } else {\n                                        main.systemConfig = {\n                                            type: 'config',\n                                            common: {\n                                                name:             'system.config',\n                                                city:             '',           // City for weather\n                                                country:          '',           // Country for weather\n                                                longitude:        '',           // longitude for javascript\n                                                latitude:         '',           // longitude for javascript\n                                                language:         '',           // Default language for adapters. Adapters can use different values.\n                                                tempUnit:         '\u00b0C',         // Default temperature units.\n                                                currency:         '',           // Default currency sign.\n                                                dateFormat:       'DD.MM.YYYY', // Default date format.\n                                                isFloatComma:     true,         // Default float divider ('.' - false, ',' - true)\n                                                licenseConfirmed: false,        // If license agreement confirmed,\n                                                infoAdapterInstall: false,      // Asked if user wants to install the info adapter\n                                                defaultHistory:   '',           // Default history instance\n                                                tabs: [                         // Show by default only these tabs\n                                                    'tab-intro',\n                                                    'tab-info',\n                                                    'tab-adapters',\n                                                    'tab-instances',\n                                                    'tab-objects',\n                                                    'tab-logs',\n                                                    'tab-scenes',\n                                                    'tab-javascript',\n                                                    'tab-text2command-0'\n                                                ]\n                                            }\n                                        };\n                                        main.systemConfig.common.language = window.navigator.userLanguage || window.navigator.language;\n\n                                        if (main.systemConfig.common.language !== 'en' && main.systemConfig.common.language !== 'de' && main.systemConfig.common.language !== 'ru') {\n                                            main.systemConfig.common.language = 'en';\n                                        }\n                                    }\n                                }\n\n                                translateCron();\n                                translateAll();\n\n                                // Here we go!\n                                initAllDialogs();\n                                // call prepare\n                                for (var t in tabs) {\n                                    if (tabs.hasOwnProperty(t) && tabs[t] && typeof tabs[t].prepare === 'function') {\n                                        tabs[t].prepare();\n                                    }\n                                }\n                                // TABS\n                                // resizeGrids();\n\n                                getStates(getObjects);\n                            }, 0);\n                        });\n                    });\n                });\n            });\n        } else {\n            main.resubscribeStates();\n            main.resubscribeObjects();\n            main.resubscribeLogs();\n        }\n        if (main.waitForRestart) {\n            location.reload();\n        }\n    });\n    main.socket.on('disconnect',        function () {\n        $('#connecting').show();\n    });\n    main.socket.on('reconnect',         function () {\n        $('#connecting').hide();\n        if (main.waitForRestart) {\n            location.reload();\n        }\n    });\n    main.socket.on('repoUpdated',       function () {\n        setTimeout(function () {\n            tabs.adapters.init(true);\n        }, 0);\n    });\n    main.socket.on('reauthenticate',    function () {\n        location.reload();\n    });\n\n    });\n})(jQuery);", "function Adapters(main) {\n    'use strict';\n\n    var that = this;\n\n    this.curRepository     = null;\n    this.curRepoLastUpdate = null;\n    this.curInstalled      = null;\n    this.curRepoLastHost   = null;\n\n    this.list   = [];\n    this.$tab   = $('#tab-adapters');\n    this.$grid  = this.$tab.find('#grid-adapters');\n    this.$tiles = this.$tab.find('#grid-adapters-tiles');\n    this.$installDialog = $('#dialog-install-url');\n    this.main   = main;\n    this.tree   = [];\n    this.data   = {};\n    this.urls   = {};\n    this.groupImages = {\n        'common adapters_group':  'img/common.png',\n        'general_group':          'img/common.png',\n        'hardware_group':         'img/hardware.png',\n        'lighting_group':         'img/hardware.png',\n        'energy_group':           'img/hardware.png',\n        'household_group':        'img/hardware.png',\n        'iot-systems_group':      'img/hardware.png',\n        'climate-control_group':  'img/hardware.png',\n        'infrastructure_group':   'img/hardware.png',\n        'garden_group':           'img/hardware.png',\n        'alarm_group':            'img/hardware.png',\n        'script_group':           'img/script.png',\n        'logic_group':            'img/script.png',\n        'media_group':            'img/media.png',\n        'multimedia_group':       'img/media.png',\n        'communication_group':    'img/communication.png',\n        'protocols_group':        'img/communication.png',\n        'network_group':          'img/communication.png',\n        'messaging_group':        'img/communication.png',\n        'visualisation_group':    'img/visualisation.png',\n        'visualization_group':    'img/visualisation.png',\n        'visualization-icons_group': 'img/visualisation.png',\n        'visualization-widgets_group': 'img/visualisation.png',\n        'storage_group':          'img/storage.png',\n        'weather_group':          'img/weather.png',\n        'schedule_group':         'img/schedule.png',\n        'vis_group':              'img/vis.png',\n        'date-and-time_group':    'img/service.png',\n        'geoposition_group':      'img/service.png',\n        'utility_group':          'img/service.png',\n        'misc-data_group':        'img/service.png',\n        'service_group':          'img/service.png',\n        'third-party_group':      'img/service.png'\n    };\n    this.inited = false;\n\n    this.isList        = false;\n    this.filterVals    = {length: 0};\n    this.onlyInstalled = false;\n    this.onlyUpdatable = false;\n    this.currentFilter = '';\n    this.currentType   = '';\n    this.isCollapsed   = {};\n    this.isTiles       = true;\n\n    this.types = {\n        occ:          'schedule'\n    };\n\n    function getVersionClass(version) {\n        if (version) {\n            var tmp = version.split ('.');\n            if (tmp[0] === '0' && tmp[1] === '0' && tmp[2] === '0') {\n                version = 'planned';\n            } else if (tmp[0] === '0' && tmp[1] === '0') {\n                version = 'alpha';\n            } else if (tmp[0] === '0') {\n                version = 'beta'\n            } else if (version === 'npm error') {\n                version = 'error';\n            } else {\n                version = 'stable';\n            }\n        }\n        return version;\n    }\n\n    function prepareTable() {\n        that.$grid.show();\n        that.$tiles.html('').hide();\n        that.$tab.find('#main-toolbar-table-types-btn').hide();\n\n        if (!that.$grid.data('inited')) {\n            that.$grid.data('inited', true);\n            that.$grid.fancytree({\n                extensions: ['table', 'gridnav', 'filter', 'themeroller'],\n                checkbox:   false,\n                strings: {\n                    noData: _('No data')\n                },\n                table: {\n                    indentation: 5      // indent 20px per node level\n                },\n                show: function (currentId, filter, onSuccess) {\n                    that.sortTree();\n                },\n                source:     that.tree,\n                renderColumns: function(event, data) {\n                    var node = data.node;\n                    var $tdList = $(node.tr).find('>td');\n                    var obj = that.data[node.key];\n\n                    function ellipsis(txt) {\n                        return '<div class=\"text-ellipsis\">' + txt + '</div>';\n                    }\n\n                    if (!obj) {\n                        $tdList.eq(0).css({'font-weight': 'bold'});\n                        $tdList.eq(0).find('img').remove();\n                        $tdList.eq(0).find('span.fancytree-title').attr('style', 'padding-left: 0px !important');\n\n                        // Calculate total count of adapter and count of installed adapter\n                        for (var c = 0; c < that.tree.length; c++) {\n                            if (that.tree[c].key === node.key) {\n                                $tdList.eq(1).html(that.tree[c].desc || '').css({'overflow': 'hidden', 'white-space': 'nowrap', position: 'relative'});\n                                var installed = 0;\n                                for (var k = 0; k < that.tree[c].children.length; k++) {\n                                    if (that.data[that.tree[c].children[k].key].installed) installed++;\n                                }\n                                that.tree[c].installed = installed;\n                                node.data.installed = installed;\n                                var title;\n                                //if (!that.onlyInstalled && !that.onlyUpdatable) {\n                                title = '[<span title=\"' + _('Installed from group') + '\">' + installed + '</span> / <span title=\"' + _('Total count in group') + '\">' + that.tree[c].children.length + '</span>]';\n                                $tdList.eq(1).html(ellipsis('<span class=\"dark-green\">' + installed + '</span> ' + _('of') + '<span class=\"dark-blue\"> ' + that.tree[c].children.length + '</span> ' + _('Adapters from this Group installed')));\n                                break;\n                            }\n                        }\n                        return;\n                    }\n\n                    $tdList.eq(0).css({'overflow': 'hidden', 'white-space': 'nowrap'});\n\n                    function setHtml(no, html) {\n                        return $tdList.eq(no).html(ellipsis(html));\n                    }\n\n                    var idx = obj.desc.indexOf('<div');\n                    var desc = idx >= 0 ? obj.desc.substr(0, idx) : obj.desc;\n                    $tdList.eq(1).html(ellipsis(obj.desc))\n                        .attr('title', desc)\n                        .css({'white-space': 'nowrap', position: 'relative', 'font-weight': obj.bold ? 'bold' : null}).find('>div>div')\n                        .css('height: 22px !important')\n                    ;\n\n                    setHtml(2, obj.keywords).attr('title', obj.keywords);\n\n                    $tdList.eq(3).html(obj.installed);\n                    $tdList.eq(4).html(obj.version); //.css({ position: 'relative'});\n\n                    // setHtml(5, obj.platform);// actually there is only one platform\n                    setHtml(5, obj.license);\n                    setHtml(6, obj.install);\n\n                    that.initButtons(node.key);\n                    // If we render this element, that means it is expanded\n                    if (that.isCollapsed[obj.group]) {\n                        that.isCollapsed[obj.group] = false;\n                        that.main.saveConfig('adaptersIsCollapsed', JSON.stringify(that.isCollapsed));\n                    }\n                },\n                gridnav: {\n                    autofocusInput:   false,\n                    handleCursorKeys: true\n                },\n                filter: {\n                    mode: 'hide',\n                    autoApply: true\n                },\n                collapse: function(event, data) {\n                    if (that.isCollapsed[data.node.key]) return;\n                    that.isCollapsed[data.node.key] = true;\n                    that.main.saveConfig('adaptersIsCollapsed', JSON.stringify(that.isCollapsed));\n                }\n            });\n\n            that.$tab.find('#btn_collapse_adapters').show().off('click').on('click', function () {\n                that.$tab.find('.process-adapters').show();\n                setTimeout(function () {\n                    that.$grid.fancytree('getRootNode').visit(function (node) {\n                        if (!that.filterVals.length || node.match || node.subMatch) node.setExpanded(false);\n                    });\n                    that.$tab.find('.process-adapters').hide();\n                }, 100);\n            });\n\n            that.$tab.find('#btn_expand_adapters').show().off('click').on('click', function () {\n                that.$tab.find('.process-adapters').show();\n                setTimeout(function () {\n                    that.$grid.fancytree('getRootNode').visit(function (node) {\n                        if (!that.filterVals.length || node.match || node.subMatch)\n                            node.setExpanded(true);\n                    });\n                    that.$tab.find('.process-adapters').hide();\n                }, 100);\n            });\n\n            that.$tab.find('#btn_list_adapters').show().off('click').on('click', function () {\n                var $processAdapters = that.$tab.find('.process-adapters');\n                $processAdapters.show();\n                that.isList = !that.isList;\n                if (that.isList) {\n                    that.$tab.find('#btn_list_adapters').addClass('red lighten-3');\n                    that.$tab.find('#btn_expand_adapters').hide();\n                    that.$tab.find('#btn_collapse_adapters').hide();\n                    $(this).attr('title', _('list'));\n                } else {\n                    that.$tab.find('#btn_list_adapters').removeClass('red lighten-3');\n                    that.$tab.find('#btn_expand_adapters').show();\n                    that.$tab.find('#btn_collapse_adapters').show();\n                    $(this).attr('title', _('tree'));\n                }\n                that.main.saveConfig('adaptersIsList', that.isList);\n                $processAdapters.show();\n\n                setTimeout(function () {\n                    that._postInit(true);\n                    $processAdapters.hide();\n                }, 200);\n            });\n        } else {\n            that.$tab.find('#btn_collapse_adapters').show();\n            that.$tab.find('#btn_expand_adapters').show();\n            that.$tab.find('#btn_list_adapters').show();\n        }\n\n        if (that.isList) {\n            that.$tab.find('#btn_list_adapters').addClass('red lighten-3').attr('title', _('tree'));\n            that.$tab.find('#btn_expand_adapters').hide();\n            that.$tab.find('#btn_collapse_adapters').hide();\n        } else {\n            that.$tab.find('#btn_list_adapters').removeClass('red lighten-3').attr('title', _('list'));\n            that.$tab.find('#btn_expand_adapters').show();\n            that.$tab.find('#btn_collapse_adapters').show();\n        }\n\n        that.$tab.find('.filter-input').trigger('change');\n    }\n\n    function prepareTiles() {\n        that.$grid.hide();\n        that.$tiles.show();\n        that.$tab.find('#main-toolbar-table-types-btn').show();\n        that.$tab.find('#btn_list_adapters').hide();\n        that.$tab.find('#btn_collapse_adapters').hide();\n        that.$tab.find('#btn_expand_adapters').hide();\n        that.$tab.find('.filter-input').trigger('change');\n    }\n\n    function onOnlyUpdatableChanged() {\n        if (that.onlyUpdatable) {\n            that.$tab.find('#btn_filter_updates').addClass('red lighten-3');\n            that.$tab.find('#btn_upgrade_all').show();\n        } else {\n            that.$tab.find('#btn_upgrade_all').hide();\n            that.$tab.find('#btn_filter_updates').removeClass('red lighten-3');\n        }\n    }\n\n    function onExpertmodeChanged() {\n        if (that.main.config.expertMode) {\n            that.$tab.find('#btn_adapters_expert_mode').addClass('red lighten-3');\n            that.$tab.find('#btn_upgrade_all').show();\n        } else {\n            that.$tab.find('#btn_adapters_expert_mode').removeClass('red lighten-3');\n            onOnlyUpdatableChanged();\n        }\n    }\n\n    function filterTiles() {\n        var anyVisible = false;\n        // filter\n        if (that.currentFilter) {\n            that.$tiles.find('.tile').each(function () {\n                var $this = $(this);\n                if (that.currentType && !$this.hasClass('class-' + that.currentType)) {\n                    $this.hide();\n                    return;\n                }\n\n                if (customFilter({key: $this.data('id')})) {\n                    anyVisible = true;\n                    $this.show();\n                } else {\n                    $this.hide();\n                }\n            });\n        } else {\n            if (!that.currentType) {\n                that.$tiles.find('.tile')\n                    .show()\n                    .each(function () {\n                        if ($(this).is(':visible')) {\n                            anyVisible = true;\n                            return false;\n                        }\n                    });\n            } else {\n                that.$tiles.find('.tile').hide();\n                that.$tiles.find('.class-' + that.currentType).show();\n                that.$tiles.find('.tile').each(function () {\n                    if ($(this).is(':visible')) {\n                        anyVisible = true;\n                        return false;\n                    }\n                });\n            }\n        }\n\n        if (anyVisible) {\n            that.$tiles.find('.filtered-out').hide();\n        } else {\n            that.$tiles.find('.filtered-out').show();\n        }\n    }\n\n    this.prepare = function () {\n        this.$tab.find('#btn_switch_adapters').off('click').on('click', function () {\n            that.$tab.find('.process-adapters').show();\n            that.isTiles = !that.isTiles;\n\n            if (that.isTiles) {\n                that.$tab.removeClass('view-table').addClass('view-tiles');\n                $(this).find('i').text('view_list');\n            } else {\n                $(this).find('i').text('view_module');\n                that.$tab.removeClass('view-tiles').addClass('view-table');\n            }\n\n            that.main.saveConfig('adaptersIsTiles', that.isTiles);\n\n            setTimeout(function () {\n                if (that.isTiles) {\n                    prepareTiles();\n                } else {\n                    prepareTable();\n                }\n                that._postInit(true);\n                that.$tab.find('.process-adapters').hide();\n            }, 50);\n        });\n\n        this.$tab.find('#btn_filter_adapters').off('click').on('click', function () {\n            that.$tab.find('.process-adapters').show();\n            that.onlyInstalled = !that.onlyInstalled;\n            if (that.onlyInstalled) {\n                that.$tab.find('#btn_filter_adapters').addClass('red lighten-3');\n            } else {\n                that.$tab.find('#btn_filter_adapters').removeClass('red lighten-3');\n            }\n            that.main.saveConfig('adaptersOnlyInstalled', that.onlyInstalled);\n\n            setTimeout(function () {\n                that._postInit(true);\n                that.$tab.find('.process-adapters').hide();\n            }, 50);\n        });\n\n        this.$tab.find('#btn_filter_updates').off('click').on('click', function () {\n            that.$tab.find('.process-adapters').show();\n            that.onlyUpdatable = !that.onlyUpdatable;\n            onOnlyUpdatableChanged();\n\n            that.main.saveConfig('adaptersOnlyUpdatable', that.onlyUpdatable);\n\n            setTimeout(function () {\n                that._postInit(true);\n                that.$tab.find('.process-adapters').hide();\n            }, 200);\n        });\n\n        this.$tab.find('#btn_filter_custom_url')\n            .off('click')\n            .on('click', function () {\n                // prepare adapters\n                var data = {};\n                var order = [];\n                var url;\n                for (url in that.urls) {\n                    if (that.urls.hasOwnProperty(url)) {\n                        order.push(url);\n                    }\n                }\n                order.sort();\n\n                for (var o = 0; o < order.length; o++) {\n                    var user = that.urls[order[o]].match(/\\.com\\/([-_$\u00a7A-Za-z0-9]+)\\/([-._$\u00a7A-Za-z0-9]+)\\//);\n                    if (user && user.length >= 2 && (that.main.config.expertMode || order[o].indexOf('js-controller') === -1)) {\n                        //text += '<option value=\"https://github.com/' + user[1] + '/ioBroker.' + order[o] + '/tarball/master ' + order[o] + '\">' + order[o] + '</option>';\n                        data[order[o] + ' [' + user[1] + ']'] = null;\n\n                    }\n                }\n                that.$installDialog.find('#install-github-link').mautocomplete({\n                    data: data,\n                    minLength: 0,\n                    sortFunction: function (a, b, inputString) {\n                        return a.indexOf(inputString) - b.indexOf(inputString);\n                    }\n                });\n\n                that.$installDialog.modal();\n\n                that.$installDialog.find('.btn-install').off('click').on('click', function () {\n                    var isCustom = !that.$installDialog.find('a[href=\"#tabs-install-github\"]').hasClass('active');//!!that.$installDialog.find('#tabs-install').tabs('option', 'active');\n                    var url;\n                    var debug;\n                    var adapter;\n                    if (isCustom) {\n                        url     = that.$installDialog.find('#install-url-link').val();\n                        debug   = that.$installDialog.find('#install-url-debug').prop('checked') ? ' --debug' : '';\n                        adapter = '';\n                    } else {\n                        var parts = that.$installDialog.find('#install-github-link').val().split(' ');\n                        url     = 'https://github.com/' + parts[1].replace(/^\\[|]$/g, '') + '/ioBroker.' + parts[0] + '/tarball/master';\n                        debug   = that.$installDialog.find('#install-github-debug').prop('checked') ? ' --debug' : '';\n                        adapter = ' ' + parts[0];\n                    }\n\n                    if (!url) {\n                        that.main.showError(_('Invalid link'));\n                        return;\n                    }\n\n                    that.main.cmdExec(null, 'url \"' + url + '\"' + adapter + debug, function (exitCode) {\n                        if (!exitCode) {\n                            that.init(true, true);\n                        }\n                    });\n                });\n                // workaround for materialize checkbox problem\n                that.$installDialog.find('input[type=\"checkbox\"]+span').off('click').on('click', function () {\n                    var $input = $(this).prev();\n                    if (!$input.prop('disabled')) {\n                        $input.prop('checked', !$input.prop('checked')).trigger('change');\n                    }\n                });\n                that.$installDialog.modal('open');\n                that.$installDialog.find('.tabs').mtabs({\n                    nShow: function (tab)  {\n                        if (!tab) return;\n                        that.main.saveConfig('adaptersInstallTab', $(tab).attr('id'));\n                    }\n                });\n\n                if (that.main.config.adaptersInstallTab && !that.main.noSelect) {\n                    that.$installDialog.find('.tabs').mtabs('select', that.main.config.adaptersInstallTab);\n                }\n            });\n\n        this.$tab.find('#btn_upgrade_all').off('click').on('click', function () {\n            that.main.confirmMessage(_('Do you want to upgrade all adapters?'), _('Please confirm'), 'help', function (result) {\n                if (result) {\n                    that.main.cmdExec(null, 'upgrade', function (exitCode) {\n                        if (!exitCode) that._postInit(true);\n                    });\n                }\n            });\n        });\n\n        this.$tab.find('#btn_adapters_expert_mode').on('click', function () {\n            that.main.config.expertMode = !that.main.config.expertMode;\n            that.main.saveConfig('expertMode', that.main.config.expertMode);\n            that.updateExpertMode();\n            that.main.tabs.instances.updateExpertMode();\n        });\n\n        if (that.main.config.expertMode) {\n            that.$tab.find('#btn_adapters_expert_mode').addClass('red lighten-3');\n        }\n\n        // save last selected adapter\n        this.$installDialog.find('#install-github-link').on('change', function () {\n            that.main.saveConfig('adaptersGithub', $(this).val());\n        });\n        this.$installDialog.find('#install-url-link').on('keyup', function (event) {\n            if (event.which === 13) {\n                that.$installDialog.find('#dialog-install-url-button').trigger('click');\n            }\n        });\n\n        // Load settings\n        this.isTiles       = (this.main.config.adaptersIsTiles !== undefined && this.main.config.adaptersIsTiles !== null) ? this.main.config.adaptersIsTiles : true;\n        this.isList        = this.main.config.adaptersIsList        || false;\n        this.onlyInstalled = this.main.config.adaptersOnlyInstalled || false;\n        this.onlyUpdatable = this.main.config.adaptersOnlyUpdatable || false;\n        this.currentFilter = this.main.config.adaptersCurrentFilter || '';\n        this.currentType   = this.main.config.adaptersCurrentType   || '';\n        this.currentOrder  = this.main.config.adaptersCurrentOrder  || 'a-z';\n        this.isCollapsed   = this.main.config.adaptersIsCollapsed ? JSON.parse(this.main.config.adaptersIsCollapsed) : {};\n        if (this.currentFilter) {\n            this.$tab.find('.filter-input').addClass('input-not-empty').val(that.currentFilter);\n            this.$tab.find('.filter-clear').show();\n        } else {\n            this.$tab.find('.filter-clear').hide();\n        }\n\n        if (this.onlyInstalled) {\n            this.$tab.find('#btn_filter_adapters').addClass('red lighten-3');\n        } else {\n            this.$tab.find('#btn_filter_adapters').removeClass('red lighten-3');\n        }\n\n        if (this.onlyUpdatable) {\n            this.$tab.find('#btn_filter_updates').addClass('red lighten-3');\n        } else {\n            this.$tab.find('#btn_filter_updates').removeClass('red lighten-3');\n        }\n\n        // fix for IE\n        if (this.main.browser === 'ie' && this.main.browserVersion <= 10) {\n            this.isTiles = false;\n            this.$tab.find('#btn_switch_adapters').hide();\n        }\n\n        onExpertmodeChanged();\n\n        this.$tab.find('#btn_refresh_adapters').on('click', function () {\n            that.init(true, true);\n        });\n\n        // add filter processing\n        this.$tab.find('.filter-input').on('keyup', function () {\n            $(this).trigger('change');\n        }).on('change', function (event) {\n            if (that.filterTimer) {\n                clearTimeout(that.filterTimer);\n            }\n            that.filterTimer = setTimeout(function () {\n                that.filterTimer = null;\n                that.currentFilter = that.$tab.find('.filter-input').val().toLowerCase();\n                event && event.target && $(event.target)[that.currentFilter ? 'addClass' : 'removeClass']('input-not-empty');\n                if (that.currentFilter) {\n                    that.$tab.find('.filter-clear').show();\n                } else {\n                    that.$tab.find('.filter-clear').hide();\n                }\n\n                that.main.saveConfig('adaptersCurrentFilter', that.currentFilter);\n                if (that.isTiles) {\n                    filterTiles();\n                } else {\n                    that.$grid.fancytree('getTree').filterNodes(customFilter, false);\n                }\n            }, 400);\n        });\n\n        this.$tab.find('.filter-clear').on('click', function () {\n            that.$tab.find('.filter-input').val('').trigger('change');\n        });\n\n        if (this.isTiles) {\n            this.$tab.find('#btn_switch_adapters').find('i').text('view_list');\n            that.$tab.removeClass('view-table').addClass('view-tiles');\n            prepareTiles();\n        } else {\n            that.$tab.removeClass('view-tiles').addClass('view-table');\n            prepareTable();\n        }\n    };\n\n    this.updateExpertMode = function () {\n        this.init(true);\n        onExpertmodeChanged();\n    };\n\n    function customFilter(node) {\n        //if (node.parent && node.parent.match) return true;\n\n        if (that.currentFilter) {\n             if (!that.data[node.key]) return false;\n\n             var title = that.data[node.key].title;\n             if (title && typeof title === 'object') {\n                 title = title[systemLang] || title.en;\n             }\n            var desc = that.data[node.key].desc;\n            if (desc && typeof desc === 'object') {\n                desc = desc[systemLang] || desc.en;\n            }\n\n            if ((that.data[node.key].name      && that.data[node.key].name.toLowerCase().indexOf(that.currentFilter)     !== -1) ||\n                 (title                        && title.toLowerCase().indexOf(that.currentFilter)                        !== -1) ||\n                 (that.data[node.key].keywords && that.data[node.key].keywords.toLowerCase().indexOf(that.currentFilter) !== -1) ||\n                 (desc                         && desc.toLowerCase().indexOf(that.currentFilter)                         !== -1)){\n                return true;\n             } else {\n                 return false;\n             }\n        } else {\n            return true;\n        }\n    }\n\n    this.getAdaptersInfo = function (host, update, updateRepo, callback) {\n        if (!host) return;\n\n        if (!callback) throw 'Callback cannot be null or undefined';\n        if (update) {\n            // Do not update too often\n            if (!this.curRepoLastUpdate || ((new Date()).getTime() - this.curRepoLastUpdate > 1000)) {\n                this.curRepository = null;\n                this.curInstalled  = null;\n            }\n        }\n\n        if (this.curRunning) {\n            this.curRunning.push(callback);\n            return;\n        }\n\n        if (!this.curRepository || this.curRepoLastHost !== host) {\n            this.curRepository = null;\n            this.main.socket.emit('sendToHost', host, 'getRepository', {repo: this.main.systemConfig.common.activeRepo, update: updateRepo}, function (_repository) {\n                if (_repository === 'permissionError') {\n                    console.error('May not read \"getRepository\"');\n                    _repository = {};\n                }\n\n                that.curRepository = _repository || {};\n                if (that.curRepository && that.curInstalled && that.curRunning) {\n                    that.curRepoLastUpdate = (new Date()).getTime();\n                    setTimeout(function () {\n                        for (var c = 0; c < that.curRunning.length; c++) {\n                            that.curRunning[c](that.curRepository, that.curInstalled);\n                        }\n                        that.curRunning = null;\n                    }, 0);\n                }\n            });\n        }\n        if (!this.curInstalled || this.curRepoLastHost !== host) {\n            this.curInstalled = null;\n            this.main.socket.emit('sendToHost', host, 'getInstalled', null, function (_installed) {\n                if (_installed === 'permissionError') {\n                    console.error('May not read \"getInstalled\"');\n                    _installed = {};\n                }\n\n                that.curInstalled = _installed || {};\n                if (that.curRepository && that.curInstalled) {\n                    that.curRepoLastUpdate = (new Date()).getTime();\n                    setTimeout(function () {\n                        for (var c = 0; c < that.curRunning.length; c++) {\n                            that.curRunning[c](that.curRepository, that.curInstalled);\n                        }\n                        that.curRunning = null;\n                    }, 0);\n                }\n            });\n        }\n\n        this.curRepoLastHost = host;\n\n        if (this.curInstalled && this.curRepository) {\n            setTimeout(function () {\n                if (that.curRunning) {\n                    for (var c = 0; c < that.curRunning.length; c++) {\n                        that.curRunning[c](that.curRepository, that.curInstalled);\n                    }\n                    that.curRunning = null;\n                }\n                if (callback) callback(that.curRepository, that.curInstalled);\n            }, 0);\n        } else {\n            this.curRunning = [callback];\n        }\n    };\n\n    this.enableColResize = function () {\n        if (!$.fn.colResizable) return;\n        if (this.$grid.is(':visible')) {\n            this.$grid.colResizable({liveDrag: true});\n        }\n    };\n\n    function getNews(actualVersion, adapter) {\n        var text = '';\n        if (adapter.news) {\n            for (var v in adapter.news) {\n                if (adapter.news.hasOwnProperty(v)) {\n                    if (systemLang === v) text += (text ? '\\n' : '') + adapter.news[v];\n                    if (v === 'en' || v === 'ru'  || v === 'de') continue;\n                    if (v === actualVersion) break;\n                    text += (text ? '\\n' : '') + (adapter.news[v][systemLang] || adapter.news[v].en);\n                }\n            }\n        }\n        return text;\n    }\n\n    function checkDependencies(dependencies) {\n        if (!dependencies) return '';\n        // like [{\"js-controller\": \">=0.10.1\"}]\n        var adapters;\n        if (dependencies instanceof Array) {\n            adapters = {};\n            for (var a = 0; a < dependencies.length; a++) {\n                if (typeof dependencies[a] === 'string') continue;\n                for (var b in dependencies[a]) {\n                    if (dependencies[a].hasOwnProperty(b)) {\n                        adapters[b] = dependencies[a][b];\n                    }\n                }\n            }\n        } else {\n            adapters = dependencies;\n        }\n\n        for (var adapter in adapters) {\n            if (adapters.hasOwnProperty(adapter)) {\n                if (adapter === 'js-controller') {\n                    if (!semver.satisfies(that.main.objects['system.host.' + that.main.currentHost].common.installedVersion, adapters[adapter])) return _('Invalid version of %s. Required %s', adapter, adapters[adapter]);\n                } else {\n                    if (!that.main.objects['system.adapter.' + adapter] || !that.main.objects['system.adapter.' + adapter].common || !that.main.objects['system.adapter.' + adapter].common.installedVersion) return _('No version of %s', adapter);\n                    if (!semver.satisfies(that.main.objects['system.adapter.' + adapter].common.installedVersion, adapters[adapter])) return _('Invalid version of %s', adapter);\n                }\n            }\n        }\n        return '';\n    }\n\n    this.sortTree = function() {\n        function sort(c1, c2) {\n            //var d1 = that.data[c1.key], d2 = that.data[c1.key];\n            var inst1 = c1.data.installed || 0, inst2 = c2.data.installed || 0;\n            var ret = inst2 - inst1;\n            if (ret) return ret;\n            var t1 = c1.titleLang || c1.title || '';\n            if (typeof t1 === 'object') {\n                t1 = t1[systemLang] || t1.en;\n            }\n            var t2 = c2.titleLang || c2.title || '';\n            if (typeof t2 === 'object') {\n                t2 = t2[systemLang] || t2.en;\n            }\n\n            t1 = t1.toLowerCase();\n            t2 = t2.toLowerCase();\n            if (t1 > t2) return 1;\n            if (t1 < t2) return -1;\n            return 0;\n        }\n        that.$grid.fancytree('getRootNode').sortChildren(sort, true);\n    };\n\n    function getInterval(time, todayText, yesterdayText, x1DayAgoText, x2DaysAgoText, x5DaysAgoText, now) {\n        now = now || Date.now();\n        if (!time) return '';\n        if (typeof time === 'string' || typeof time === 'number') {\n            time = new Date(time);\n        }\n        var interval = now.getTime() - time.getTime();\n        var days = Math.floor(interval / (24 * 3600000));\n        if (days === 0) {\n            if (now.getDate() === time.getDate()) {\n                return todayText;\n            } else {\n                return yesterdayText;\n            }\n        } else if (days === 1) {\n            if (now.getDate() - time.getDate() === 1) {\n                return yesterdayText;\n            } else {\n                return x2DaysAgoText.replace('%d', days + 1);\n            }\n        } else {\n            var t  = days % 10;\n            var tt = days % 100;\n            // 2, 3, 4, 22, 23, 24, 32, 33, 34, 111, ...x2, x3, h4\n            if ((tt < 10 || tt > 20) && t >= 2 && t <= 4) {\n                return x2DaysAgoText.replace('%d', days);\n            } else\n            // 1, 21, 31, 41, 121....\n            if ((tt < 10 || tt > 20) && t === 1) {\n                return x1DayAgoText.replace('%d', days);\n            } else {\n                return x5DaysAgoText.replace('%d', days);\n            }\n        }\n    }\n\n    this._postInit = function (update, updateRepo) {\n        if (typeof this.$grid !== 'undefined') {\n\n            that.$tab.find('.process-adapters').show();\n\n            this.$grid.find('tbody').html('');\n\n            this.getAdaptersInfo(this.main.currentHost, update, updateRepo, function (repository, installedList) {\n                var obj;\n                var version;\n                var rawVersion;\n                var adapter;\n                var adaptersToUpdate = 0;\n\n                var listInstalled = [];\n                var listNonInstalled = [];\n                var nowObj = new Date();\n                var localTexts = {\n                    'add instance':             _('add instance'),\n                    'update':                   _('update'),\n                    'upload':                   _('upload'),\n                    'Available version:':       _('Available version:'),\n                    'Active instances':         _('Active instances'),\n                    'Installed version':        _('Installed version'),\n                    'readme':                   _('readme'),\n                    'delete adapter':           _('delete adapter'),\n                    'install specific version': _('install specific version'),\n                    'all':                      _('all'),\n                    'Last update':              _('Last update'),\n                    'Installations counter':    _('Installation counter'),\n                    'today':                    _('today'),\n                    'yesterday':                _('yesterday'),\n                    '1 %d days ago':            _('1 %d days ago'),\n                    '2 %d days ago':            _('2 %d days ago'),\n                    '5 %d days ago':            _('5 %d days ago')\n                };\n\n                if (installedList) {\n                    for (adapter in installedList) {\n                        if (!installedList.hasOwnProperty(adapter)) continue;\n                        obj = installedList[adapter];\n                        if (!obj || obj.controller || adapter === 'hosts') continue;\n                        listInstalled.push(adapter);\n                    }\n                    listInstalled.sort();\n                }\n\n                that.urls = {};\n                // List of adapters for repository\n                for (adapter in repository) {\n                    if (!repository.hasOwnProperty(adapter)) continue;\n                    if (installedList && installedList[adapter] && !installedList[adapter].versionDate) {\n                        installedList[adapter].versionDate = repository[adapter].versionDate;\n                    }\n\n                    // it is not possible to install this adapter from git\n                    if (!repository[adapter].nogit) {\n                        that.urls[adapter] = repository[adapter].meta;\n                    }\n                    obj = repository[adapter];\n                    if (!obj || obj.controller) continue;\n                    version = '';\n                    if (installedList && installedList[adapter]) continue;\n                    listNonInstalled.push(adapter);\n                }\n                listNonInstalled.sort();\n\n                function getVersionString(version, updatable, news, updatableError) {\n                    //var span = getVersionSpan(version);\n                    var color = getVersionClass(version);\n                    var title = color + '\\n\\r' + (news || '');\n                    //version = '<table style=\"min-width: 80px; width: 100%; text-align: center; border: 0; border-spacing: 0px;' + (news ? 'font-weight: bold;' : '') + '\" cellspacing=\"0\" cellpadding=\"0\" class=\"ui-widget\">' +\n                    version = //'<div style=\"height: 100% !important;\">' +\n                        '<table style=\"cursor: alias; width: 100%; text-align: center; border: 0; border-spacing: 0;' + (news ? 'color: blue;' : '') + '\" cellspacing=\"0\" cellpadding=\"0\" class=\"ui-widget\">' +\n                        '<tr class=\"' + color + 'Bg\">' +\n                        '<td title=\"' + localTexts['Available version:'] + ' ' + title + '\" class=\"actual-version\">' + version + '</td>' +\n                        '<td style=\"border: 0; padding: 0; width: 30px\" class=\"update-version\">';\n                    if (updatable) {    //xxx\n                        version += '<button class=\"adapter-update-submit small-button m\" data-adapter-name=\"' + adapter + '\" ' + (updatableError ? ' disabled title=\"' + updatableError + '\"' : 'title=\"' + localTexts['update'] + '\"') + '><i class=\"material-icons\">refresh</i></button>';\n                    }\n                    version += '</td></tr></table>';\n                    return version;\n                }\n\n                that.tree = [];\n                that.data = {};\n\n                // list of the installed adapters\n                for (var i = 0; i < listInstalled.length; i++) {\n                    adapter = listInstalled[i];\n\n                    obj = installedList ? installedList[adapter] : null;\n\n                    if (!obj || obj.controller || adapter === 'hosts') continue;\n                    var installed = '';\n                    var rawInstalled = '';\n                    var icon = obj.icon;\n                    version = '';\n\n                    if (repository[adapter] && repository[adapter].version) version = repository[adapter].version;\n\n                    if (repository[adapter] && repository[adapter].extIcon) icon = repository[adapter].extIcon;\n\n                    var _instances = 0;\n                    var _enabled   = 0;\n                    if (obj.version) {\n                        var news = '';\n                        var updatable = false;\n                        var updatableError = '';\n                        if (!that.main.upToDate(version, obj.version)) {\n                            news = getNews(obj.version, repository[adapter]);\n                            // check if version is compatible with current adapters and js-controller\n                            updatable = true;\n                            updatableError = checkDependencies(repository[adapter].dependencies);\n                            adaptersToUpdate++;\n                        }\n                        // TODO: move style to class\n                        installed = '<table style=\"min-width: 80px; text-align: center; border: 0; border-spacing: 0;\" cellspacing=\"0\" cellpadding=\"0\" class=\"ui-widget\">' +\n                            '<tr>';\n\n                        // Show information about installed and enabled instances\n                        for (var z = 0; z < that.main.instances.length; z++) {\n                            if (that.main.objects[that.main.instances[z]] &&\n                                that.main.objects[that.main.instances[z]].common.name === adapter) {\n                                _instances++;\n                                if (that.main.objects[that.main.instances[z]].common.enabled) _enabled++;\n                            }\n                        }\n\n                        if (_instances) {\n                            // TODO: move style to class\n                            installed += '<td style=\"border: 0; text-align: center; padding: 0; width: 40px\">';\n                            if (_enabled !== _instances) {\n                                installed += '<span title=\"' + _ ('Installed instances') + '\">' + _instances + '</span>';\n                                if (_enabled) installed += ' ~ ';\n                            }\n                            if (_enabled) installed += '<span title=\"' + localTexts['Active instances'] + '\" class=\"true\">' + _enabled + '</span>';\n                            installed += '</td>';\n                        } else {\n                            // TODO: move style to class\n                            installed += '<td style=\"border: 0; padding: 0; width: 40px\"></td>';\n                        }\n                        // TODO: move style to class\n                        installed += '<td style=\"border: 0; padding: 0; width: 50px\" title=\"' + localTexts['Installed version'] + '\">' + obj.version + '</td>';\n                        rawInstalled = '<span class=\"installed\" title=\"' + localTexts['Installed version'] + '\">' + obj.version + '</span>';\n\n                        //tmp = installed.split('.');\n                        // if (updatable) {    //xxx\n                        //     //TODO\n                        //     // installed += '<td style=\"border: 0; padding: 0; width: 30px\"><button class=\"adapter-update-submit\" data-adapter-name=\"' + adapter + '\" ' + (updatableError ? ' disabled title=\"' + updatableError + '\"' : 'title=\"' + _('update') + '\"')+ '></button></td>';\n                        //     // version = version.replace('class=\"', 'class=\"updateReady ');\n                        //     // $('a[href=\"#tab-adapters\"]').addClass('updateReady');\n                        // } else if (that.onlyUpdatable) {\n                        //     continue;\n                        // }\n\n\n                        // Use different pathes for installed and non installed adapters\n                        icon = obj.localIcon || icon;\n\n                        installed += '</tr></table>';\n                        if (!updatable && that.onlyUpdatable) continue;\n                    }\n                    rawVersion = version;\n                    version = getVersionString(version, updatable, news, updatableError);\n\n                    var group = (obj.type || that.types[adapter] || 'common adapters') + '_group';\n                    var desc  = (typeof obj.desc === 'object') ? (obj.desc[systemLang] || obj.desc.en) : obj.desc;\n                    desc = desc || '';\n                    desc += showUploadProgress(group, adapter, that.main.states['system.adapter.' + adapter + '.upload'] ? that.main.states['system.adapter.' + adapter + '.upload'].val : 0);\n                    var title = obj.titleLang || obj.title;\n                    title = (typeof title === 'object') ? (title[systemLang] || title.en) : title;\n\n                    that.data[adapter] = {\n                        image:      icon ? '<img onerror=\"this.src=\\'img/info-big.png\\';\" src=\"' + icon + '\" class=\"adapter-table-icon\" />' : '',\n                        icon:       icon || '',\n                        stat:        repository[adapter] ? repository[adapter].stat : 0,\n                        name:       adapter,\n                        title:      (title || '').replace('ioBroker Visualisation - ', ''),\n                        desc:       desc,\n                        news:       news,\n                        updatableError: updatableError,\n                        keywords:   obj.keywords ? obj.keywords.join(' ') : '',\n                        version:    version,\n                        installed:  installed,\n                        rawVersion: rawVersion,\n                        instances:  _instances,\n                        rawInstalled: rawInstalled,\n                        versionDate: obj.versionDate,\n                        updatable:  updatable,\n                        bold:       obj.highlight || false,\n                        install: '<button data-adapter-name=\"' + adapter + '\" class=\"adapter-install-submit small-button m\" title=\"' + localTexts['add instance'] + '\" data-adapter-desc=\"' + desc + '\"><i class=\"material-icons\">add_circle_outline</i></button>' +\n                        '<button ' + (obj.readme ? '' : 'disabled=\"disabled\" ') + 'data-adapter-name=\"' + adapter + '\" data-adapter-url=\"' + (obj.readme || '') + '\" class=\"adapter-readme-submit small-button\" title=\"' + localTexts['readme'] + '\"><i class=\"material-icons\">help_outline</i></button>' +\n                        ((that.main.config.expertMode) ? '<button data-adapter-name=\"' + adapter + '\" class=\"adapter-upload-submit small-button\" title=\"' + localTexts['upload'] + '\"><i class=\"material-icons\">file_upload</i></button>' : '') +\n                        '<button ' + (installed ? '' : 'disabled=\"disabled\" ') + 'data-adapter-name=\"' + adapter + '\" class=\"adapter-delete-submit small-button\" title=\"' + localTexts['delete adapter'] + '\"><i class=\"material-icons\">delete_forever</i></button>' +\n                        ((that.main.config.expertMode) ? '<button data-adapter-name=\"' + adapter + '\" data-target=\"adapters-menu\" class=\"adapter-update-custom-submit small-button\" title=\"' + localTexts['install specific version'] + '\"><i class=\"material-icons\">add_to_photos</i></button>' : ''),\n                        // platform:   obj.platform, actually there is only one platform\n                        group:      group,\n                        license:    obj.license || '',\n                        licenseUrl: obj.licenseUrl || ''\n                    };\n\n                    if (!obj.type) console.log('\"' + adapter + '\": \"common adapters\",');\n                    if (obj.type && that.types[adapter]) console.log('Adapter \"' + adapter + '\" has own type. Remove from admin.');\n\n                    if (!that.isList) {\n                        var iGroup = -1;\n                        for (var jj = 0; jj < that.tree.length; jj++) {\n                            if (that.tree[jj].key === that.data[adapter].group) {\n                                iGroup = jj;\n                                break;\n                            }\n                        }\n                        if (iGroup < 0) {\n                            if (!localTexts[that.data[adapter].group]) localTexts[that.data[adapter].group] = _(that.data[adapter].group);\n                            that.tree.push({\n                                title:    localTexts[that.data[adapter].group],\n                                desc:     showUploadProgress(group),\n                                key:      that.data[adapter].group,\n                                folder:   true,\n                                expanded: !that.isCollapsed[that.data[adapter].group],\n                                children: [],\n                                icon:     that.groupImages[that.data[adapter].group]\n                            });\n                            iGroup = that.tree.length - 1;\n                        }\n                        that.tree[iGroup].children.push({\n                            icon:     icon,\n                            title:    that.data[adapter].title || adapter,\n                            key:      adapter\n                        });\n                    } else {\n                        that.tree.push({\n                            icon:     icon,\n                            title:    that.data[adapter].title || adapter,\n                            key:      adapter\n                        });\n                    }\n                }\n                //that.sortTree();\n\n                if (!that.onlyInstalled && !that.onlyUpdatable) {\n                    for (i = 0; i < listNonInstalled.length; i++) {\n                        adapter = listNonInstalled[i];\n\n                        obj = repository[adapter];\n                        if (!obj || obj.controller) continue;\n                        version = '';\n                        if (installedList && installedList[adapter]) continue;\n\n                        if (obj && obj.version) {\n                            version = obj.version;\n                            rawVersion = version;\n                            version = getVersionString(version);\n                        }\n\n                        var group = (obj.type || that.types[adapter] || 'common adapters') + '_group';\n                        var desc = (typeof obj.desc === 'object') ? (obj.desc[systemLang] || obj.desc.en) : obj.desc;\n                        desc = desc || '';\n                        desc += showUploadProgress(group, adapter, that.main.states['system.adapter.' + adapter + '.upload'] ? that.main.states['system.adapter.' + adapter + '.upload'].val : 0);\n\n                        title = obj.titleLang || obj.title;\n                        title = (typeof title === 'object') ? (title[systemLang] || title.en) : title;\n\n                        that.data[adapter] = {\n                            image:      obj.extIcon ? '<img onerror=\"this.src=\\'img/info-big.png\\';\" src=\"' + obj.extIcon + '\" class=\"adapter-table-icon\" />' : '',\n                            icon:       obj.extIcon,\n                            stat:       obj.stat,\n                            name:       adapter,\n                            title:      (title || '').replace('ioBroker Visualisation - ', ''),\n                            desc:       desc,\n                            keywords:   obj.keywords ? obj.keywords.join(' ') : '',\n                            rawVersion: rawVersion,\n                            version:    version,\n                            bold:       obj.highlight,\n                            installed:  '',\n                            versionDate: obj.versionDate,\n                            install: '<button data-adapter-name=\"' + adapter + '\" class=\"adapter-install-submit small-button\" title=\"' + localTexts['add instance'] + '\" data-adapter-desc=\"' + desc + '\"><i class=\"material-icons\">add_circle_outline</i></button>' +\n                            '<button ' + (obj.readme ? '' : 'disabled=\"disabled\" ') + ' data-adapter-name=\"' + adapter + '\" data-adapter-url=\"' + (obj.readme || '') + '\" class=\"adapter-readme-submit small-button\" title=\"' + localTexts['readme'] + '\"><i class=\"material-icons\">help_outline</i></button>' +\n                            '<button data-adapter-name=\"' + adapter + '\" class=\"adapter-delete-submit small-button hide\" title=\"' + localTexts['delete adapter'] + '\"><i class=\"material-icons\">delete_forever</i></button>' +\n                            ((that.main.config.expertMode) ? '<button data-adapter-name=\"' + adapter + '\" data-target=\"adapters-menu\" class=\"adapter-update-custom-submit small-button\" title=\"' + localTexts['install specific version'] + '\"><i class=\"material-icons\">add_to_photos</i></button>' : ''),\n                            // TODO do not show adapters not for this platform\n                            // platform:   obj.platform, // actually there is only one platform\n                            license:    obj.license    || '',\n                            licenseUrl: obj.licenseUrl || '',\n                            group:      group\n                        };\n\n                        if (!obj.type) console.log('\"' + adapter + '\": \"common adapters\",');\n                        if (obj.type && that.types[adapter]) console.log('Adapter \"' + adapter + '\" has own type. Remove from admin.');\n\n                        if (!that.isList) {\n                            var igroup = -1;\n                            for (var j = 0; j < that.tree.length; j++){\n                                if (that.tree[j].key === that.data[adapter].group) {\n                                    igroup = j;\n                                    break;\n                                }\n                            }\n                            if (igroup < 0) {\n                                if (!localTexts[that.data[adapter].group]) localTexts[that.data[adapter].group] = _(that.data[adapter].group);\n                                that.tree.push({\n                                    title:    localTexts[that.data[adapter].group],\n                                    key:      that.data[adapter].group,\n                                    folder:   true,\n                                    expanded: !that.isCollapsed[that.data[adapter].group],\n                                    children: [],\n                                    icon:     that.groupImages[that.data[adapter].group]\n                                });\n                                igroup = that.tree.length - 1;\n                            }\n                            that.tree[igroup].children.push({\n                                title:    that.data[adapter].title || adapter,\n                                icon:     obj.extIcon,\n                                desc:     showUploadProgress(group),\n                                key:      adapter\n                            });\n                        } else {\n                            that.tree.push({\n                                icon:     obj.extIcon,\n                                title:    that.data[adapter].title || adapter,\n                                key:      adapter\n                            });\n                        }\n                    }\n                }\n\n                if (that.currentOrder === 'popular' || that.currentOrder === 'updated') {\n                    var akeys = Object.keys(that.data);\n\n                    if (that.currentOrder === 'popular') {\n                        akeys.sort(function (a, b) {\n                            if (that.data[a].stat > that.data[b].stat) return -1;\n                            if (that.data[a].stat < that.data[b].stat) return 1;\n                            return 0;\n                        });\n                    } else if (that.currentOrder === 'updated') {\n                        akeys.sort(function (a, b) {\n                            if (that.data[a].versionDate && !that.data[b].versionDate) return -1;\n                            if (!that.data[a].versionDate && that.data[b].versionDate) return 1;\n                            if (that.data[a].versionDate > that.data[b].versionDate) return -1;\n                            if (that.data[a].versionDate < that.data[b].versionDate) return 1;\n                            if (a > b) return -1;\n                            if (a < b) return 1;\n                            return 0;\n                        });\n                    }\n                    var newData = {};\n                    for (var u = 0; u < akeys.length; u++) {\n                        newData[akeys[u]] = that.data[akeys[u]];\n                    }\n                    that.data = newData;\n                }\n\n                // build tiles\n                if (that.isTiles && (that.main.browser !== 'ie' || that.main.browserVersion > 10)) {\n                    var text = '';\n                    var types = [];\n                    for (var a in that.data) {\n                        if (!that.data.hasOwnProperty(a)) continue;\n                        var ad = that.data[a];\n                        if (types.indexOf(ad.group) === -1) {\n                            types.push(ad.group);\n                        }\n//                        text += '<div class=\"tile class-' + ad.group + '\" data-id=\"' + ad.name + '\">';\n//                        text += '   <div class=\"card-header\">';\n//                        text += '       <div class=\"title\">' + ad.title + '</div>';\n//                        if (that.currentOrder === 'popular' && ad.stat) {\n//                            text += '   <div class=\"stat\" title=\"' + localTexts['Installations counter'] + '\">' + ad.stat + '</div>';\n//                        } else if (that.currentOrder === 'updated' && ad.versionDate) {\n//                            text += '   <div class=\"last-update\" title=\"' + localTexts['Last update'] + '\">' + getInterval(ad.versionDate, localTexts['today'], localTexts['yesterday'], localTexts['1 %d days ago'], localTexts['2 %d days ago'], localTexts['5 %d days ago'], nowObj) + '</div>';\n//                        }\n//                        text += '    </div>';\n//                        text += '    <div class=\"card-body\">';\n//                        text += '       <img onerror=\"this.src=\\'img/info-big.png\\';\" class=\"icon\" src=\"' + ad.icon + '\" />';\n//                        text += '       <div class=\"desc\">' + ad.desc + '</div>';\n//                        text += '    </div>';\n//                        text += '    <div class=\"card-action\">';\n//                        text += '       <div class=\"version\"><table><tr><td>' + ad.version + (ad.installed ? '</td><td class=\"installed\">' + ad.rawInstalled : '')  + '</td></tr></table></div>';\n//                        text += '       <div class=\"buttons\">' + ad.install + '</div>';\n//                        text += '    </div>';\n//                        text += '</div>';\n\n                        text += '<div class=\"col s12 m6 l4 xl3 tile class-' + ad.group + '\" data-id=\"' + ad.name + '\">';\n                        text += '   <div class=\"card hoverable card-adapters\">';\n                        text += '       <div class=\"card-header ' + (ad.updatable ? 'updatable' : (ad.installed ? 'installed' : '')) + '\"></div>';\n                        text += '       <div class=\"card-content\">';\n                        text += '           <img onerror=\"this.src=\\'img/info-big.png\\';\" class=\"card-profile-image\" src=\"' + ad.icon + '\">';\n                        text += '           <span class=\"card-title grey-text text-darken-4\">' + ad.title + '</span>';\n                        text += '           <a title=\"info\" class=\"btn-floating activator btnUp blue lighten-2 z-depth-3\"><i class=\"material-icons\">more_vert</i></a>';\n                        text += '           <ul class=\"ver\">';\n                        text += '               <li>' + localTexts['Available version:']  + ' <span class=\"data ' + (ad.updatable ? 'updatable' : '') + '\" ' + (ad.news ? ' title=\"' + ad.news + '\"' : '') + '>' + ad.rawVersion + '</span>' +\n                            (ad.updatable ? '<button class=\"adapter-update-submit small-button\" data-adapter-name=\"' + a + '\" ' + (updatableError ? ' disabled title=\"' + ad.updatableError + '\"' : 'title=\"' + localTexts['update'] + '\"') + '><i class=\"material-icons\">refresh</i></button>' : '') +\n                            '</li>';\n                        if (ad.installed) {\n                            text += '           <li>' + localTexts['Installed version'] + ': <span class=\"data\">'+ ad.rawInstalled + '</span></li>';\n                        }\n                        if (ad.instances) {\n                            text += '           <li>' + _('Installed instances') + ': <span class=\"data\">' + ad.instances + '</span></li>';\n                        }\n                        text += '           </ul>';\n                        text += '       </div>';\n                        text += '       <div class=\"footer right-align\"></div>';\n                        text += '       <div class=\"card-reveal\">';\n                        text += '           <i class=\"card-title material-icons right\">close</i>';\n                        text += '           <p>' + ad.desc + '</p>';\n                        text += '           <div class=\"card-reveal-buttons\">';\n                        text += ad.install;\n                        text += '           </div>';\n                        text += '       </div>';\n\n                        if (that.currentOrder === 'popular' && ad.stat) {\n                            text += '   <div class=\"stat\" title=\"' + localTexts['Installations counter'] + '\">' + ad.stat + '</div>';\n                        } else if (that.currentOrder === 'updated' && ad.versionDate) {\n                            text += '   <div class=\"last-update\" title=\"' + localTexts['Last update'] + '\">' + getInterval(ad.versionDate, localTexts['today'], localTexts['yesterday'], localTexts['1 %d days ago'], localTexts['2 %d days ago'], localTexts['5 %d days ago'], nowObj) + '</div>';\n                        }\n\n\n                        text += '   </div>';\n                        text += '</div>';\n                    }\n\n\n                    // Add filtered out tile\n                    text += '<div class=\"col s12 m6 l4 xl3 filtered-out\">';\n                    text += '   <div class=\"card hoverable card-adapters\">';\n                    text += '       <div class=\"card-header\"></div>';\n                    text += '       <div class=\"card-content\">';\n                    //text += '           <img onerror=\"this.src=\\'img/info-big.png\\';\" class=\"card-profile-image\" src=\"' + ad.icon + '\">';\n                    text += '           <span class=\"card-title grey-text text-darken-4\">' + _('Filtered out') + '</span>';\n                    text += '       </div>';\n                    text += '       <div class=\"footer right-align\"></div>';\n                    text += '   </div>';\n                    text += '</div>';\n\n                    that.$tiles.html(text);\n                    // init buttons\n                    for (var b in that.data) {\n                        if (that.data.hasOwnProperty(b)) {\n                            that.initButtons(b);\n                        }\n                    }\n\n                    var tTypes = '<li class=\"main-toolbar-table-types-item\" data-type=\"\"><a>' + localTexts['all'] + '</a></li>\\n';\n                    for (var g = 0; g < types.length; g++) {\n                        tTypes += '<li class=\"main-toolbar-table-types-item\" data-type=\"' + types[g] + '\"><a>' + _(types[g]) + '</a></li>\\n';\n                    }\n                    var $types = that.$tab.find('#main-toolbar-table-types');\n                    $types.html(tTypes);\n                    $types.find('.main-toolbar-table-types-item').show().off('click').on('click', function () {\n                        that.currentType = $(this).data('type') || '';\n                        filterTiles();\n                        that.$tab.find('#main-toolbar-table-types-btn').html(_(that.currentType || 'all'));\n                        that.main.saveConfig('adaptersCurrentType', that.currentType);\n                    });\n                    if (that.currentType && !localTexts[that.currentType]) localTexts[that.currentType] = _(that.currentType);\n                    that.$tab.find('#main-toolbar-table-types-btn').html(localTexts[that.currentType || 'all']).dropdown({\n                        constrainWidth: false, // Does not change width of dropdown to that of the activator\n                        // hover: true, // Activate on hover\n                        gutter: 0\n                    });\n\n                    $types = that.$tab.find('#main-toolbar-table-order');\n                    $types.find('.main-toolbar-table-order-item').off('click').on('click', function () {\n                        that.currentOrder = $(this).data('type') || '';\n                        //filterTiles();\n                        that.$tab.find('#main-toolbar-table-order-btn').html(_(that.currentOrder || 'a-z'));\n                        that.main.saveConfig('adaptersCurrentOrder', that.currentOrder);\n                        that._postInit();\n                    });\n                    if (that.currentOrder && !localTexts[that.currentOrder]) localTexts[that.currentOrder] = _(that.currentOrder);\n                    that.$tab.find('#main-toolbar-table-order-btn').show().html(localTexts[that.currentOrder || 'a-z']).dropdown({\n                        constrainWidth: false, // Does not change width of dropdown to that of the activator\n                        // hover: true, // Activate on hover\n                        gutter: 0\n                    });\n\n                    filterTiles();\n                } else {\n                    that.$tab.find('#main-toolbar-table-types-btn').hide();\n                    that.$tab.find('#main-toolbar-table-order-btn').hide();\n                    // build tree\n                    that.$grid.fancytree('getTree').reload(that.tree);\n                    that.$grid.find('.fancytree-icon').each(function () {\n                        if ($(this).attr('src')) {\n                            $(this).css({width: 18, height: 18});\n                        }\n\n                        $(this).on('hover', function () {\n                            var text = '<div class=\"icon-large\" style=\"' +\n                                'left: ' + Math.round($(this).position().left + $(this).width() + 5) + 'px;\"><img onerror=\"this.src=\\'img/info-big.png\\';\" src=\"' + $(this).attr('src') + '\"/></div>';\n                            var $big = $(text);\n                            $big.insertAfter($(this));\n                            $(this).data('big', $big[0]);\n                            var h   = parseFloat($big.height());\n                            var top = Math.round($(this).position().top - ((h - parseFloat($(this).height())) / 2));\n                            if (h + top > (window.innerHeight || document.documentElement.clientHeight)) {\n                                top = (window.innerHeight || document.documentElement.clientHeight) - h;\n                            }\n                            $big.css({top: top});\n\n                        }, function () {\n                            var big = $(this).data('big');\n                            $(big).remove();\n                            $(this).data('big', undefined);\n                        });\n                    });\n\n                    if (that.currentFilter) {\n                        that.$grid.fancytree('getTree').filterNodes(customFilter, false);\n                    }\n\n                    that.sortTree();\n                    that.enableColResize();\n                    var classes = [\n                        'tab-adapters-table-name',\n                        'tab-adapters-table-description',\n                        'tab-adapters-table-keywords',\n                        'tab-adapters-table-installed',\n                        'tab-adapters-table-available',\n                        'tab-adapters-table-license',\n                        'tab-adapters-table-install'\n                    ];\n                    that.$grid.find('tbody tr').each(function () {\n                        var i = 0;\n                        $(this).find('td').each(function () {\n                            $(this).addClass(classes[i]);\n                            i++;\n                        });\n                    })\n                }\n                that.$tab.find('.grid-main-div').removeClass('order-a-z order-popular order-updated').addClass(that.currentOrder ? 'order-' + that.currentOrder : '');\n                that.$tab.find('.process-adapters').hide();\n                that.updateCounter(adaptersToUpdate);\n            });\n        } else {\n            this.enableColResize();\n        }\n        this.restoreScroll();\n    };\n    this.saveScroll         = function () {\n        this.scrollTop = this.$tab.find('.grid-main-div').scrollTop();\n    };\n    this.restoreScroll         = function () {\n        if (this.scrollTop) {\n            this.$tab.find('.grid-main-div').scrollTop(this.scrollTop);\n        }\n    };\n\n    this.updateCounter = function (counter) {\n        if (counter === undefined) {\n            this.getAdaptersInfo(this.main.currentHost, false, false, function (repository, installedList) {\n                var adaptersToUpdate = 0;\n\n                for (var adapter in installedList) {\n                    if (!installedList.hasOwnProperty(adapter)) continue;\n                    var obj = installedList ? installedList[adapter] : null;\n                    if (!obj || obj.controller || adapter === 'hosts') continue;\n\n                    var version = '';\n                    if (repository[adapter] && repository[adapter].version) version = repository[adapter].version;\n\n                    if (obj.version && !that.main.upToDate(version, obj.version)) {\n                        adaptersToUpdate++;\n                    }\n                }\n                that.updateCounter(adaptersToUpdate);\n            });\n        } else if (counter) {\n            var $updates = $('#updates-for-adapters');\n            if ($updates.length) {\n                $updates.text(counter);\n            } else {\n                $('<span id=\"updates-for-adapters\" title=\"' + _('updates') + '\" class=\"new badge updates-for-adapters\" data-badge-caption=\"\">' + counter + '</span>').appendTo('.admin-sidemenu-items[data-tab=\"tab-adapters\"] a');\n            }\n        } else {\n            $('#updates-for-adapters').remove();\n        }\n    };\n\n    // ----------------------------- Adapters show and Edit ------------------------------------------------\n    this.init = function (update, updateRepo) {\n        if (this.inited && !update) {\n            return;\n        }\n\n        if (!this.main.objectsLoaded) {\n            setTimeout(function () {\n                that.init(update, updateRepo);\n            }, 250);\n            return;\n        }\n\n        // update info\n        // Required is list of hosts and repository (done in getAdaptersInfo)\n        if (!this.inited) {\n            this.inited = true;\n            this.main.subscribeObjects('system.host.*');\n            this.main.subscribeStates('system.host.*');\n        }\n        this.main.tabs.hosts.getHosts(function () {\n            that._postInit(update, updateRepo);\n        });\n    };\n\n    this.destroy = function () {\n        if (this.inited) {\n            this.saveScroll();\n            this.inited = false;\n            this.main.unsubscribeObjects('system.host.*');\n            this.main.unsubscribeStates('system.host.*');\n        }\n    };\n\n    function showAddInstanceDialog(adapter, desc, callback) {\n        if (that.main.tabs.hosts.list.length <= 1 && !that.main.config.expertMode) {\n            return callback(true, that.main.currentHost, '');\n        }\n\n        var $dialogAddInstance = $('#dialog-add-instance');\n        $dialogAddInstance.find('.dialog-add-instance-name').html(adapter);\n        $dialogAddInstance.find('.dialog-add-description').html(desc);\n\n        // fill the hosts\n        var text = '';\n        for (var h = 0; h < that.main.tabs.hosts.list.length; h++) {\n            var host = that.main.tabs.hosts.list[h];\n            text += '<option ' + (host.name === that.main.currentHost ? 'selected' : '') + ' value=\"' + host.name + '\">' + host.name + '</option>';\n        }\n\n        if (that.main.tabs.hosts.list.length <= 1) {\n            $dialogAddInstance.find('.dialog-add-instance-host').addClass('disabled').prop('disabled', true);\n        } else {\n            $dialogAddInstance.find('.dialog-add-instance-host').removeClass('disabled').prop('disabled', false);\n        }\n        $dialogAddInstance.find('.dialog-add-instance-host').html(text).select();\n\n        // find free instance numbers\n        var min = -1;\n        var used = [];\n        for (var i = 0; i < that.main.tabs.instances.list.length; i++) {\n            var parts = that.main.tabs.instances.list[i].split('.');\n            if (parts[parts.length - 2] === adapter) {\n                var index = parseInt(parts[parts.length - 1], 10);\n                used.push(index);\n                if (index > min) {\n                    min = index;\n                }\n            }\n        }\n        min += 10;\n        text = '<option selected value=\"\">' + _('auto') + '</option>';\n        for (var m = 0; m < min; m++) {\n            if (used.indexOf(m) !== -1) continue;\n            text += '<option value=\"' + m + '\">' + m + '</option>';\n        }\n        $dialogAddInstance.find('.dialog-add-instance-number').html(text).select();\n        $dialogAddInstance.find('.dialog-add-install-btn').off('click').on('click', function (e) {\n            if (callback) {\n                callback(true, $dialogAddInstance.find('.dialog-add-instance-host').val(), $dialogAddInstance.find('.dialog-add-instance-number').val());\n                callback = null;\n            }\n            $dialogAddInstance.find('.dialog-add-cancel-btn').off('click');\n            $dialogAddInstance.find('.dialog-add-instance-number').off('click');\n        });\n\n        $dialogAddInstance.find('.dialog-add-cancel-btn').off('click').on('click', function (e) {\n            if (callback) {\n                callback(false);\n                callback = null;\n            }\n            $dialogAddInstance.find('.dialog-add-cancel-btn').off('click');\n            $dialogAddInstance.find('.dialog-add-instance-number').off('click');\n        });\n        $dialogAddInstance.modal({\n            dismissible: false,\n            complete: function () {\n                $dialogAddInstance.find('.dialog-add-instance-name').html('');\n            }\n        }).modal('open');\n    }\n\n    function showLicenseDialog(adapter, callback) {\n        var $dialogLicense = $('#dialog-license');\n        // Is adapter installed\n        if (that.data[adapter].installed || !that.data[adapter].licenseUrl) {\n            callback(true);\n            return;\n        }\n\n        var timeout = setTimeout(function () {\n            timeout = null;\n            callback(true);\n        }, 10000);\n\n        if (!that.data[adapter].licenseUrl) {\n            that.data[adapter].licenseUrl = 'https://raw.githubusercontent.com/ioBroker/ioBroker.' + (that.data[adapter].name || adapter) + '/master/LICENSE';\n        }\n        if (typeof that.data[adapter].licenseUrl === 'object') {\n            that.data[adapter].licenseUrl = that.data[adapter].licenseUrl[systemLang] || that.data[adapter].licenseUrl.en;\n        }\n        // Workaround\n        // https://github.com/ioBroker/ioBroker.vis/blob/master/LICENSE =>\n        // https://raw.githubusercontent.com/ioBroker/ioBroker.vis/master/LICENSE\n        if (that.data[adapter].licenseUrl.indexOf('github.com') !== -1) {\n            that.data[adapter].licenseUrl = that.data[adapter].licenseUrl.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');\n        }\n\n        that.main.socket.emit('httpGet', that.data[adapter].licenseUrl, function (error, response, body) {\n            if (timeout) {\n                clearTimeout(timeout);\n                timeout = null;\n\n                if (!error && body) {\n                    $dialogLicense.css({'z-index': 200});\n                    body = body.toString().replace(/\\r\\n/g, '<br>');\n                    body = body.replace(/\\n/g, '<br>');\n                    $dialogLicense.find('.license_text').html(body);\n                    $dialogLicense.find('.license_agreement_name').text(_(' for %s', adapter));\n\n                    $dialogLicense.modal({\n                        dismissible: false,\n                        complete: function () {\n                            $dialogLicense.find('.license_text').html('');\n                        }\n                    }).modal('open');\n\n                    $dialogLicense.find('.license_agree').off('click').on('click', function (e) {\n                        if (callback) {\n                            callback(true);\n                            callback = null;\n                        }\n                        $dialogLicense.find('.license_agree').off('click');\n                        $dialogLicense.find('.license_non_agree').off('click');\n                    });\n\n                    $dialogLicense.find('.license_non_agree').off('click').on('click', function (e) {\n                        if (callback) {\n                            callback(false);\n                            callback = null;\n                        }\n                        $dialogLicense.find('.license_agree').off('click');\n                        $dialogLicense.find('.license_non_agree').off('click');\n                    });\n                } else {\n                    callback && callback(true);\n                    callback = null;\n                }\n            }\n        });\n    }\n\n    this.initButtons = function (adapter) {\n        this.$tab.find('.adapter-install-submit[data-adapter-name=\"' + adapter + '\"]').off('click').on('click', function () {\n            var adapter = $(this).attr('data-adapter-name');\n            var desc = $(this).attr('data-adapter-desc');\n\n            // show config dialog\n            showAddInstanceDialog(adapter, desc, function (result, host, index) {\n                if (!result) return;\n\n                that.getAdaptersInfo(host, false, false, function (repo, installed) {\n                    var obj = repo[adapter];\n\n                    if (!obj) obj = installed[adapter];\n\n                    if (!obj) return;\n\n                    if (obj.license && obj.license !== 'MIT') {\n                        // Show license dialog!\n                        showLicenseDialog(adapter, function (isAgree) {\n                            if (isAgree) {\n                                that.main.cmdExec(null, 'add ' + adapter + ' ' + index + ' --host ' + host, function (exitCode) {\n                                    if (!exitCode) that._postInit(true);\n                                });\n                            }\n                        });\n                    } else {\n                        that.main.cmdExec(null, 'add ' + adapter + ' ' + index + ' --host ' + host, function (exitCode) {\n                            if (!exitCode) that._postInit(true);\n                        });\n                    }\n                });\n            });\n        });\n\n        this.$tab.find('.adapter-delete-submit[data-adapter-name=\"' + adapter + '\"]').off('click').on('click', function () {\n            var name = $(this).attr('data-adapter-name');\n            that.main.confirmMessage(_('Are you sure you want to delete adapter %s?', name), _('Please confirm'), 'help', function (result) {\n                if (result) {\n                    that.main.cmdExec(null, 'del ' + name, function (exitCode) {\n                        if (!exitCode) that._postInit(true);\n                    });\n                }\n            });\n        });\n\n        this.$tab.find('.adapter-readme-submit[data-adapter-name=\"' + adapter + '\"]').off('click').on('click', function () {\n            that.main.navigate({\n                tab:    'adapters',\n                dialog: 'readme',\n                params:  $(this).data('adapter-name')\n            });\n        });\n\n        this.$tab.find('.adapter-update-submit[data-adapter-name=\"' + adapter + '\"]').off('click').on('click', function () {\n            var aName = $(this).attr('data-adapter-name');\n            if (aName === 'admin') that.main.waitForRestart = true;\n\n            that.main.cmdExec(null, 'upgrade ' + aName, function (exitCode) {\n                if (!exitCode) that._postInit(true);\n            });\n        });\n\n        this.$tab.find('.adapter-upload-submit[data-adapter-name=\"' + adapter + '\"]').off('click').on('click', function () {\n            var aName = $(this).attr('data-adapter-name');\n\n            that.main.cmdExec(null, 'upload ' + aName, function (exitCode) {\n                if (!exitCode) that._postInit(true);\n            });\n        });\n\n        var $button = this.$tab.find('.adapter-update-custom-submit[data-adapter-name=\"' + adapter + '\"]');\n        $button.off('click').on('click', function () {\n            var versions = [];\n            if (that.main.objects['system.adapter.' + adapter].common.news) {\n                var news = that.main.objects['system.adapter.' + adapter].common.news;\n                for (var id in news) {\n                    if (news.hasOwnProperty(id)) {\n                        versions.push(id);\n                    }\n                }\n            } else {\n                versions.push(that.main.objects['system.adapter.' + adapter].common.version);\n            }\n            var menu = '<div class=\"collection\">';\n            for (var v = 0; v < versions.length; v++) {\n                var nnews = (news[versions[v]] ? news[versions[v]][systemLang] || news[versions[v]].en : '');\n                menu += '<a data-version=\"' + versions[v] + '\" data-position=\"left\" data-delay=\"50\" title=\"' + nnews + '\" data-adapter-name=\"' + $(this).data('adapter-name') + '\" class=\"collection-item adapters-versions-link tooltipped\"><span class=\"adapters-versions-link-version\">' + versions[v] + '</span> - <div class=\"adapters-versions-link-history\">' + nnews + '</div></a>';\n            }\n            menu += '</div>';\n\n            var $adaptersMenu = $('#adapters-menu');\n            if (!$adaptersMenu.length) {\n                //$adaptersMenu = $('<div id=\"adapters-menu\" class=\"dropdown-content m\"></div>');\n                $adaptersMenu = $('<div id=\"adapters-menu\" class=\"modal modal-fixed-footer\"><div class=\"modal-content\">' +\n                    '<h4>Modal Header</h4><p></p></div><div class=\"modal-footer\">' +\n                    '<a class=\"modal-action modal-close waves-effect waves-green btn-flat \">' + _('Close') + '</a></div></div>');\n                $adaptersMenu.appendTo($('.materialize-dialogs').first());\n                $adaptersMenu.modal();\n            }\n            $adaptersMenu.data('trigger', this);\n\n            $adaptersMenu.find('p').html(menu);\n            $adaptersMenu.find('h4').html(_('Versions of %s', adapter));\n\n            $adaptersMenu.find('.adapters-versions-link').off('click').on('click', function () {\n                //if ($(this).data('link')) window.open($(this).data('link'), $(this).data('instance-id'));\n                $adaptersMenu.modal('close');\n                var adapter = $(this).data('adapter-name');\n                var version = $(this).data('version');\n                if (version && adapter) {\n                    that.main.cmdExec(null, 'upgrade ' + adapter + '@' + version, function (exitCode) {\n                        if (!exitCode) that._postInit(true);\n                    });\n                }\n            });\n\n            /*$(this).dropdown({\n                onCloseEnd: function () {\n                    var $adaptersMenu = $('#adapters-menu');\n                    var trigger = $adaptersMenu.data('trigger');\n                    $(trigger).dropdown('close').dropdown('destroy');\n                    $adaptersMenu.data('trigger', null).hide();\n                    $adaptersMenu.remove();\n                }\n            }).dropdown('open');*/\n            $adaptersMenu.modal('open');\n\n\n            // does not work... must be fixed.\n            //$adaptersMenu.find('.tooltipped').tooltip();\n        });\n\n        if (!that.main.objects['system.adapter.' + adapter]) {\n            $button.hide();//addClass('disabled');\n        }\n    };\n\n    this.objectChange = function (id, obj) {\n        // Update Adapter Table\n        if (id.match(/^system\\.adapter\\.[a-zA-Z0-9-_]+$/)) {\n            if (obj) {\n                if (this.list.indexOf(id) === -1) this.list.push(id);\n            } else {\n                var j = this.list.indexOf(id);\n                if (j !== -1) {\n                    this.list.splice(j, 1);\n                }\n            }\n\n            if (typeof this.$grid !== 'undefined' && this.$grid[0]._isInited) {\n                this.init(true);\n            }\n        }\n    };\n\n    function showUploadProgress(group, adapter, percent) {\n        var text = '';\n        var opened;\n        if (adapter || typeof group === 'string') {\n            if (adapter) {\n               // text += '<div class=\"adapter-upload-progress\" data-adapter-name=\"' + adapter + '\"';\n            } else {\n                text += '<div class=\"group-upload-progress\"';\n            }\n            //text += ' data-adapter-group=\"' + group + '\" style=\"position: absolute; width: 100%; height: 100%; opacity: ' + (percent ? 0.7 : 0) + '; top: 0; left: 0\">';\n            opened = true;\n        } else {\n            percent = group;\n            group = null;\n        }\n        //percent = 80;\n        if (percent) {\n            text +=\n                '<table style=\"height: 3px; \" title=\"' + _('Upload') + ' ' + percent + '%\" class=\"no-space\" style=\"width:100%; height: 100%; opacity: 0.7\">' +\n                    '<tr style=\"height: 100%\" class=\"no-space\">' +\n                        '<td class=\"no-space\" style=\"width:' + percent + '%;background: blue\"></td>' +\n                        '<td style=\"width:' + (100 - percent) + '%;opacity: 0.1\" class=\"no-space\"></td>' +\n                    '</tr>' +\n                '</table>'\n            ;\n        }\n        //text += percent ? '<table title=\"' + _('Upload') + ' ' + percent + '%\" class=\"no-space\" style=\"width:100%; height: 100%; opacity: 0.7\"><tr style=\"height: 100%\" class=\"no-space\"><td class=\"no-space\" style=\"width:' + percent + '%;background: blue\"></td><td style=\"width:' + (100 - percent) + '%;opacity: 0.1\" class=\"no-space\"></td></tr></table>' : '';\n\n        if (opened) {\n            //text += '</div>';\n        }\n        return text;\n    }\n\n    this.stateChange = function (id, state) {\n        if (id && state) {\n            var adapter = id.match(/^system\\.adapter\\.([\\w\\d-]+)\\.upload$/);\n            if (adapter) {\n                var $adapter = this.$tab.find('.adapter-upload-progress[data-adapter-name=\"' + adapter[1] + '\"]');\n                var text = showUploadProgress(state.val);\n                $adapter.html(text).css({opacity: state.val ? 0.7 : 0});\n                this.$tab.find('.group-upload-progress[data-adapter-group=\"' + $adapter.data('adapter-group') + '\"]').html(text).css({opacity: state.val ? 0.7 : 0});\n            }\n        }\n    };\n}\n", "<html>\n<head>\n    <style>\n        * {\n            box-sizing:border-box;\n        }\n\n        body {\n            font-family: Helvetica;\n            background: #64b5f6;\n            -webkit-font-smoothing: antialiased;\n            background-size: 100% auto;\n        }\n\n        .logo { display: block }\n\n        @media only screen and (orientation: portrait) {\n            body {\n                background-size: auto 100%;\n            }\n        }\n\n        header {\n            text-align:center;\n            margin-top: 4em;\n        }\n\n        /*h1, h3 { font-weight: 300; }*/\n\n        h1 {\n            color:          white;\n            font-weight:    bold;\n            text-transform: uppercase;\n        }\n\n        h3 { color: #4a89dc; }\n\n        form {\n            width:          380px;\n            margin:         4em auto;\n            padding:        3em 2em 2em 2em;\n            background:     #fafafa;\n            border:         1px solid #ebebeb;\n            box-shadow:     rgba(0,0,0,0.14902) 0 1px 1px 0,rgba(0,0,0,0.09804) 0 1px 2px 0;\n            border-radius:  2px;\n        }\n\n        .group {\n            position: relative;\n            margin-bottom: 45px;\n        }\n\n        input {\n            font-size: 18px;\n            padding: 10px 10px 10px 5px;\n            -webkit-appearance: none;\n            display: block;\n            background: #fafafa;\n            color: #636363;\n            width: 100%;\n            border: none;\n            border-radius: 0;\n            border-bottom: 1px solid #757575;\n        }\n\n        input:focus { outline: none; }\n\n        /* Label */\n\n        label {\n            color: #999;\n            font-size: 18px;\n            font-weight: normal;\n            position: absolute;\n            pointer-events: none;\n            left: 5px;\n            top: 10px;\n            transition: all 0.2s ease;\n        }\n\n        /* active */\n\n        input:focus ~ label, input.used ~ label {\n            top: -20px;\n            transform: scale(.75); left: -2px;\n            /* font-size: 14px; */\n            color: #4a89dc;\n        }\n\n        /* Underline */\n\n        .bar {\n            position: relative;\n            display: block;\n            width: 100%;\n        }\n\n        .bar:before, .bar:after {\n            content: '';\n            height: 2px;\n            width: 0;\n            bottom: 1px;\n            position: absolute;\n            background: #4a89dc;\n            transition: all 0.2s ease;\n        }\n\n        .bar:before { left: 50%; }\n\n        .bar:after { right: 50%; }\n\n        /* active */\n\n        input:focus ~ .bar:before, input:focus ~ .bar:after { width: 50%; }\n\n\n        /* Highlight */\n\n        .highlight {\n            position: absolute;\n            height: 60%;\n            width: 100px;\n            top: 25%;\n            left: 0;\n            pointer-events: none;\n            opacity: 0.5;\n        }\n\n\n        /* active */\n\n        input:focus ~ .highlight {\n            animation: inputHighlighter 0.3s ease;\n        }\n\n\n        /* Animations */\n\n        @keyframes inputHighlighter {\n            from { background: #4a89dc; }\n            to \t{ width: 0; background: transparent; }\n        }\n\n\n        /* Button */\n\n        .button {\n            position: relative;\n            display: inline-block;\n            padding: 12px 24px;\n            margin: .3em 0 1em 0;\n            width: 100%;\n            vertical-align: middle;\n            color: #fff;\n            font-size: 16px;\n            line-height: 20px;\n            -webkit-font-smoothing: antialiased;\n            text-align: center;\n            letter-spacing: 1px;\n            background: transparent;\n            border: 0;\n            border-bottom: 2px solid #3160B6;\n            cursor: pointer;\n            transition: all 0.15s ease;\n        }\n        .button:focus { outline: 0; }\n\n\n        /* Button modifiers */\n\n        .buttonBlue {\n            background: #2196f3;\n            text-shadow: 1px 1px 0 rgba(39, 110, 204, .5);\n            border-radius: 2px;\n        }\n\n        .buttonBlue:hover { background: #39a1f4; }\n\n\n        /* Ripples container */\n        .ripples {\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            overflow: hidden;\n            background: transparent;\n        }\n\n        /* Ripples circle */\n\n        .ripplesCircle {\n            position: absolute;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            opacity: 0;\n            width: 0;\n            height: 0;\n            border-radius: 50%;\n            background: rgba(255, 255, 255, 0.25);\n        }\n\n        .ripples.is-active .ripplesCircle {\n            animation: ripples .4s ease-in;\n        }\n\n\n        /* Ripples animation */\n\n        @keyframes ripples {\n            0% { opacity: 0; }\n\n            25% { opacity: 1; }\n\n            100% {\n                width: 200%;\n                padding-bottom: 200%;\n                opacity: 0;\n            }\n        }\n\n        footer { text-align: center; }\n\n        footer p {\n            color: white;\n            font-size: 13px;\n            letter-spacing: .4px;\n        }\n\n        footer a {\n            color: #eaeaea;\n            text-decoration: none;\n            transition: all .2s ease;\n        }\n\n        footer a:hover {\n            color: white;\n            text-decoration: underline;\n        }\n\n        footer img {\n            width: 80px;\n            transition: all .2s ease;\n        }\n\n        footer img:hover { opacity: .83; }\n\n        footer img:focus , footer a:focus { outline: none; }\n\n        .error {\n            color:          white;\n            text-align:     center;\n            padding:        0.5rem 1rem;\n            position:       absolute;\n            background:     #ef9a9a;\n            top:            10px;\n            width:          400px;\n            left:           calc(50% - 200px);\n            border-radius: 2px;\n        }\n    </style>\n</head>\n<body>\n<header>\n    <h1 id=\"login-label\">ioBroker Admin</h1>\n</header>\n<form action=\"/login\" method=\"post\">\n    <div class=\"group\">\n        <input type=\"text\" name=\"username\" id=\"username\"><span class=\"highlight\"></span><span class=\"bar\"></span>\n        <label id=\"username-label\" for=\"username\">Name</label>\n    </div>\n    <div class=\"group\">\n        <input type=\"password\" name=\"password\" id=\"password\"><span class=\"highlight\"></span><span class=\"bar\"></span>\n        <label id=\"password-label\" for=\"password\">Password</label>\n    </div>\n    <input type=\"hidden\" id=\"origin\" name=\"origin\" value=\"\"/>\n    <button type=\"submit\" class=\"button buttonBlue\" id=\"submit\"><span id=\"submit-label\">Submit</span>\n        <div class=\"ripples buttonRipples\"><span class=\"ripplesCircle\"></span></div>\n    </button>\n</form>\n<div id=\"error\" class=\"error\" style=\"display: none\"></div>\n<footer><a class=\"logo\" href=\"http://iobroker.net/\" target=\"_blank\"><img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAScwAAEnMBjCK5BwAAABl0RVh0U29mdHdhcmUAcGFpbnQubmV0IDQuMC4yMfEgaZUAACHYSURBVHhe7Z0LmB1FlcczhIisSiBzq3tmCA/dCIigZG6CUdDLdHXfhIeuCuOuiwqyGhWMMZnpqnsT4cIKKgoor2Qm6IKIuxIEFmEBl/UBopKZgQ8VBEVQw0MBeRkBA8nMnrpzIMOkApNJd1V19/l93/8L5DH1r+pTp6u6q6umEARBEARBEARBEARBEARBEARBEARBEARBEARBEC4wMtJy4Nm37DT7glvf1Nk32DW7f+DIzr6hEzpXrDmxs3/oS+X+wfNA3wJdXu4bvBr+zvfHSv1e88/U3+kbPL+zb+D0zhWDJ87uH/x0eeXgUZ2rhoK55615c7l/aLoqC0slCMIGs/sG3t25cuBM6LxXdfYP3g6d/CnouMPQQUdSFZQB5a2DBPHLZtJYOfhV+P33oi2CIExQ7r8V7tiaDmpBagSBtgiCmBTd3VNZ1HtAKZCLPS4vbz+i8Q/4J1qylAAqlcb2Xii+2xrInlK1Vp7SvXoq/hFBFJfWMO7wuTwOOvylLBSPeqEceUGt74lfh39NS5YSQHnhwmmQAJ5/sX5cPO6Fte/C7328o7p8N/xrBJF3RlpKXM5mXJwCneBW6AzDL3aKccp1AniphiH5/YJF4rQ2Xps7pdHYDv8ZQeQD1iXfCnf50yHQ79V0AK0KlABeIhbKP4DObOU9c+Gf0tsGIpuo4T10+F642/9KF+ivpKImgLGC9rvL57V6eyh3xx9FEA6jHnZx+U8QvFdPJuDHihLAGHGxAdr1ehbF3ft2N16FP5Yg3KBtQZ1BgC+HIF2rDeBJiBLAFsTFQ4zHJ5fmL2vHH08QdmgL6vsyLvtgzvqMNli3QZQAXkFcrAdd6AX1t2AxBGEGj9fe7nNxFQT1Rm1wJiBKABOVGPZ4fH0pjCtYHEGkAwTbPBaKG/SBmKwoAUxG4ia/SwZYLEEkg3o/DfP7a/VBl44oAUxeMC37PxbVD8LiCWJywLDyjdDxL4W55hYX7KQlSgDbrGFIBFe1heJNaIMgJsYuoZzOInFG80GTPrhSFyWApKTKFed38For2iGILdDdPdXj8UK4czysDyZzogSQrBgXj/m8d5H6MAltEcQmSkHcCR3/Fl3w2BAlgJTExe3gZR5aI4qOH/W8Bub5X4HA2KANGEuiBJCmxEa45ufOWNDYCS0SRcTjtRAC4nebB4h9UQIwIC7W+lwcjjaJoqA224AAOB9k/On+REUJwKC4uJBGAwXBD8SBLJR3awPBIVECMCvGxX2loP5OtEzkjkZjOy9ofrDznC4AXBMlAAviYgNMCU4rlxdOQ+tEHvCCum9qCW9SogRgUVz8ZNeKmIn2iSxTiuS74II+pL3QDosSgF3BlOCRtkgcilUgMkiLx2tLsxZ4L4gSgAPi6nWhOJH2KcwYM+ct2RGG/JdoL2pGRAnAHcFo4ApWabwWq0O4THMvPi6cWdE3WVECcEtwQ/mFP1/uiVUiXEQdrAGB9oDuAmZNlADc0+g3IrSM2Em8qojg4vxVd+GyKEoAbgqSwDNeENNZiC7BeO0YGKJl4v3+REUJwGFxuYHx+HisHmETjwv1pN/ZJb2TFSUA9wWjgZOhenR4iSVa1AXQXZg8aFsSAHTIDZ19A4909g/dpjqnOvO/s3/gnM6+oVM7Vw7VZ6+8ZQn8+QmzVw5+Qqlz5cDx8P+fhV/rzb/TN3h2edXQxeW+wevh3w7Br3+Gn/W8riyloiYAJcbFGVNGRigJmGWkBYb8Z+kuSF40kQQAHW8ddNib5/QN9UFHXjJnxcChc74+sDd0ypc9WXgyzDvzZzvOXbVmLyizCklkcefKwRWQGG6Csp4scgJQYqHsU5vJYHWJtMl751d6pQQw97w1bd2r7R+z3WiMbPe2C37u4/9qyXsCGJW4kBYMpU7+7/wv6JUSQJYoRgJojgT6KQmkiBfVvqRr+DyJcXkHi8Qp6pxBrHb2UV9iNo9OU9tx6eudG3GxQt2osOZEUvhhLLUNngPBqOaBEhdf9KP6fljd3NJare/jh+LzjIvf69oiF4JridUlksAL409Cw+bqVR90+vXqzAHWVatO6bY/lzcOjAr8SAbQDpeAntW1UcbVgzUltgXGe49UCy80DZxNcfknL5An0em2m/CjHg9GBHWYQ9+vbbNsahjqdAxWkZgMMG+cl8bJu1bExW/VmQN7VBqvxuoR41Bn/7NAHgsjgju1bZgxQew+B6NXjtUjtgZWrc2CQHhE17AZ0x1+IP7F5DB/3qVrd5x9/q1vmtM/EJZXDn6kvGJNrbNv4ItqvUC5f+g75f7B74Gu6+wbukFJ/Xfz9/oGL4Vf+zv7h74Ef6/WuWroWPj30YErb9s3jbUFW0Q9NAzq74UbwG2a9syYxBP+fPFmrBkxEeAuuTPcMe/SN2g2BMnr9608PjrN10Ldq0emdvYN7g86BjryWfArdOiBP8KvG6DDalftTVbwMzeC7ock8QPQ12ZfcOtH565ac0DlRyPpva2AtmOROAo60W90bZwVqQeeapqDtSJeltHjuYyexJukoOM/Dr/2zFqwaAesUSrAnfrL0CHX6TqrSXWuHHi6vGrwa2grFcrl/mnQrp+GjpTZESFMB25SUxysErEloLFOH994mVDzCzG5sr3SKGFVUiVLHwMlhRoZ+jz+KowIMrmoCBLYSqwKoaMUig/oGs59idvaeG0uVsMIRUwAL8C65FthRPAz/bVwWyysfRSrQYxFLRCBu+hTukZzVZDRn4GhnbSxj3yRE0ATmCr6kfgMJN91umvjqtRbrdL8uBNrQShmHqU28ZS/0DWYq4Lh/s87uuK9sQrGKXwCQPyo5/UsED/SXSNnxcU9u4RyOlaB8EPRr20oF8WFmuufbHutPiWAMahVhWFvDa5LZnaFgtHjt9F9scnUvJ+LtTBSORitW4USwOa0hcvmqLur9to5qBKPj0PrxWTGAjETLph6baZtIKfE5bXtlaVGnvBPBEoAetTQmoXiCu01dEwwYvlbKYzfiNaLxkiLF4jrdA3jlsQwXKhT01zQMxkoAbwcIy0+r9Uz8Q0JFzcXcjchxmvHaxvEIY1maPEBtOwUlABemRIXh0MHc/7NEguEQMvFQD25hQvj9usbLh5q7+opo2XnoAQwMdQeCyyUf9BeY0cE/p5tC8Wb0HLegaE/l9frGsIdibv9aPnr0bCTUAKYOOq4OEjoTu9GpBY2FWIq4AXyQ7oGcEWMxz/v4LVWtOsslAC2jubDQS5/qLvmrogF8gS0m09mVpfMgIvwsK7yLohx8UNWOT4Tp8BSAth6mqdGB/Jq3bV3RE+ww3rb0G7+gLlOn6bSbgimJX7U8xq06jyUACZHc9MRLq7UxoADgj5yCVrNF7hIY6Ou0vYlrsvaTj2UACaPSgIlHl+ujwX78rk8BK3mhhbo/DfpKmtdXNzYfkTD3G43CUEJYNsoL+yfphZ3aWPCtri4PVcPBFlU69ZW1LJYKAay+lEGJYBtRyV+GP25eWMK44+hzWyjdsaBOdd9+kralPiNqc070oASQDKoTUbgRuDel6hcPMQqjUw8kH5ZoCJLtRW0KBbKR0vvyvYabEoAybFrRcyEuHhgfJxYFxcnosVsMvruVTyqrZwlQbZ/loVLnfiib1ugBJAspSDuhFGha6tT/5rpzUQ9XjtRUymrYmH8YbSXaSgBJA/cHN4PMeLUCVQskGeivWyBd3/XPvU9G+1lHkoA6QDTw3/XxI01QR96mlUyuDgIhlMNXYWsidd+ol79oL3MQwkgJdS29IF06jN1SAJnoLtsoM62d+nuD14emREs2xXt5QJKAOnRtqDO4Abm0ENBsS4L36e8CMylevUVsSAuhtV34WgtN1ACSJe2MK5A7DizoQjcxE5Ba27TfO/vVvY8B63lCkoA6QNx/Hl9TFkQl49lYl2AY5/73p3FZb4TgRJA+jSXCzt0QGkmPheGTDWoM29cMHzzo563oa3cQQnADOoUIoil9doYMy0u73Ztb8qXwKL6QVrjNsTlV9BWLqEEYA6Ip5M2iy9LKgXiULTlHiwS/6kzbVqMiz9kZWOPyUIJwBzNPQRCcacu1kwLYvt7aMst1GIFd4ZKvf+EtnILJQCztHJ5iBcK+6sEudzgV+SeaMsdGI9jrWHDgkx9NVrKNZQAzAPx9V/j482G1NsJtOQKIy2QHe0PkWAEUuK1vdBUrqEEYJ6O6vLdYAj+tDb2TIrL+6d0r3ZnwxC/Kg7UGjUsyIxnoaXcQwnADozLk3WxZ1osqlXRkn3UYhudSaPi4qksb/CxtVACsINajAOjAAd2thbfREt2KZcXToM77yN6k+akMjNaKgSUAOzhhbXP6mLQqNQNz4VFbuq9pNagQUEC+suMBYt2QkuFgBKAPdT5AjAPf1AXiyal9tpES/aATHShzpxZieVopzBQArALxN3izePQsHhtNdqxg1orre6+WnPm9OT0SmNntFQYKAHYRQ2/bT8LUKdXWz3MxuO9oc6YUfE410t+twQlAPuUYOSpjUmDghvw+9GOecDA2eMNmZV4vq2rZw+0UygoAdgHRgEluAs/o49NY7oI7RhHnfZzj8aQOXF5GXopHJQA3ABuQt/QxqYhwQjgz1ZOEWLV2iydIZMqhXEF7RQOSgBuMLqduD4+TaktjOegHXOozQl0ZkwJhl6/Bhsto26KByUAd4CRqNU9MEqBXIZWzKE+S9SZMSYulqKVQkIJwB08Hi/UxqghsVD+EK2YoVJpbA8FPzneiDmJ59lhGdwrPUEoAbjDjAWNnWw+DISy/z7zqCU7op308QPrH/9ch1YKCyUAt4CY/M64GDUqP4i70Er6tIayR2fClPyg91i0UlgoAbiFF9Tfq4tVc6o10Er6sLB2hd5E+oL5znMzq40ZaKWwUAJwCzUE97i9w0WhX/wvWkmbkRbGxUM6E0bEReGDTUEJwD3UuhRtzJoQl381sh6gPZS7aw0YEiSfT6GVQkMJwD0Y7/2ILmaNiYv90Up6eJF8n7ZwMxp2ckNEC1ACcA91lj90wo2auDUiFsn0n43ZPD6ZheJOtFF4KAG4iReKAV3smpGBY/D8SF6lLzx9lXJ6zt9koATgJiwSp+li14Rgenwj2kgPuAvfqyvchKx++ugYlADcxOM1a5/IMy4fS/XoMLUhIgwz7ByOAHMrP2p4aKXwUAJwk+ZGIaF8ThvD6Wu4NYw70ErytIXL5mgKNSMufos2CIASgLtAvFp7DgBT9ABtJI/H46N1hZoQzG++jTYIgBKAu8Ao+XxdDJsQ4/HxaCN5WBBbewPgcbkEbRAAJQB38Xl8nDaGDQhulGegjeSBTnixrlATMvqxQwagBOAupWqtrIthE2JcXoU2kgcSwE91hZpQB6+1og0CoATgLs3vAkJh6UGguA1tJA8ML9bqC01df0ILBEIJwG0gZu8eF8NGBH30cfW9DtpIkIULp0F2eV5XaNpioTC740kGoATgNh4X1+hiOX2J4VSODPOCuq8vMH3BvGYV2iAQSgBuwyJxhi6WTaijK9571EWCtNt8sBH21tAGgVACcBu4aS3SxbIJsah+ENpIDtZVq+oKM6FWHh+NNgiEEoDb+IF8ty6WjSiS70MbyVEKxL9oCzOgUhC/E20QCCUAt7G6ajYQn0AbyeFbHNK0V+v7oA0CoQTgNmrXal0smxALpEQbyeFx+TldYSb0hlBORxsEQgnAbWYtWLSDx+18OOdH4jS0kRylMP6CrrC0xbhYr84hQBsEQgnAfbzQ1iah4jy0kBwsFGfpC0tZXDyVzsKGbEMJwH3g5vVHbUynr+RPDGah7NcUZEL3owViDJQA3IdxeYcmntMXl5eiheSAH3zRZgWZEBd3oQViDJQA3Adid0gb0ykLbtZXooXkgB9q6egjcTtaIMZACcB9IH6tfDwH0/XvoYXk8CKxWleYAa1BC8QYKAG4D8Supa9nRfJnZ1ICcAtKAO4DsWsrASR/PawlAJhHoQViDJQA3Afi19IUQF6NFpID5hXf0hWWthgXv0ILxBgoAbgPdMQ1uphOW+k8AwjFN3SFpS3G5X1ogRgDJQD3gdHr7bqYNqDL0EJyeFyeqykodcEI4FG0QIyBEoD7wM3rt7qYTlvQZ5LfQRtGAF/WFZa2oDJPd5s49jhjUAJwHxiKP6qL6bQF5fajheSAbHayrrDUxcXGPSqNV6MNAqEE4DiNxnZw07SzhV4kkt8aHLJKr64wE+qoLt0NbRAIJQC32aOyeGddLBsRFyeijeTwQ/FRbWEG1MZrc9EGgVACcJv26tJ9dLFsQn5U+wzaSA6fx0foCjMhn4vD0QaBUAJwGy+MuS6WjSiQH0IbyaG25dIWZkAw/fg02iAQSgBuw7j8iC6WjYjXQrSRHKyr9x+1hZnR6WiDQCgBuI21h+YgFi07AG0kB6s0XuuFdrY4ghFA8p83ZhxKAG4DfeWbulg2IT/q8dBGssAPf2J8YSYECeBOtEAglADcBkYAP9fFctpiXDw7Ja11M9aWNnKxvlxeOA1tEAAlAIdprgGwdrO8F10kD/zwq3WFGhEX+6MNAqAE4C4d1eW7aWPYgGAE8AO0kTw+l1/VFWpEUQqvNjIMJQB3KXFxuDaGjUh8A20kj3odpy80fbFQnok2CIASgLt4gTxJF8MmBCOAOtpIHq8qIl2hJgQJ4Ca0QQCUANzF5lQZyn4/2kieXReImbpCTUh9Fbhvd+NVaKXwUAJwlhaI1Ud0MWxCftSzH/pIhRaPi6d0BZuQH4gD0UfhoQTgJq3VurVvAGD+v37WgrN3QCvpAAXdvHnBZsS4jNFG4aEE4CZw9/+ULnZNiPH4DrSRHlDBlbrCDSn57Y4zCiUAN4EYvWxczJoTl/+FNtLDC+NPags3IPUcYOa8JTuilUJDCcA91CG2EKOP6WLXhFgQJ38s+HjaeM9cXeGmVIrEoWil0FACcA8WyoN1MWtMvDf5rwDHox4yeKF4VmvAjM5HK4WGEoB7QGyePi5Wzam5dd7indFKutj60KEpLh5Ua63RSmGhBOAc6g3ZXdqYNSAYfaT/APAFWCDP1JkwJRb1HoRWCgslALfwo/p+ulg1JRaksBPwlvAi+T6dCXOKz0YrhYUSgFuwSJyij1VDSmMbsC3RwWutas6hNWJCXD44pdLYHu0UEkoALjGihv9WDgFBDbeHcnc0YwYvFLdpjBhTKSj22wBKAO7AovpBuhg1Ji5/CzZaRt0YwgtrVk4K2iTxHbRSSCgBuAOzdG7mC2Jc9qEVc1jd9liJi/VeUPfRTuGgBOAG0yuLd4YO+DdtjBoSlH8k2jHH6HoAuW68GbMSy9FO4aAE4AbQ+RbpY9OYnjP2/n88LJJXaQyZE5dri7pXICUAB2g0toME8GttbJoSFzeiG/PAHfjjWlMm1RV/EO0UCkoA9lEPorUxaVCsS/SiHfOU5i9rt/o6sCkxAFbMPgF1AEoA9mFc/EAfk+bEqrVZaMcOMAy3tj/Ai0rjKCTHoQRgFz+qvU0biybFxe1oxx4lLj6jNWdSXPwE7RQGSgB2gZj7H20smlTgwEPw1jDusD8NABVsFEAJwB4w7ZwHsnJM3iaJYevD/xdgobhBb9KcWChvUUsy0VLuoQRgD7jhfV8Xg0bF5Rq0Yx9m8yjkMUp1S2THoARgh9ZIBrrYMy3GexehJfu0vid+ne3VUErg4e5yub8Q6wIoAVhAvfcP5a262DMpuNE9l9oJwJMF5uAX6swaF4+XoKVcQwnAPE6sewFBArgCLbmD9f3QNulJtT4BbeUWSgBmmVldMoNZPPBjrBzdF3OkBTLTnTrDpgU+LkFTuYUSgFng7n+eLtZMC6a59zm7JR7jteN1ps1LDHuBiNBWLqEEYA6Ip3kelxv0sWZWLBACbbkHqzReCyafHG/ahmAUcK8f9bwGreUOSgBmmLVg0Q7ujGzlM+2VpSW05iYsjK1uGDpWpVCcg7ZyByUAM0AcfWF8XNlTimf/J4U/X+4JRp/XV8C4hllUq6K1XEEJIH08Xnu7x4UTQ3/QMHjZH625jcfjSzUVsCMu71dPcNFabqAEkC7N6SwX92hjyoa4vBatuU8piDvBtOW10psEc7gr87ZMmBJAqqg3Wt/SxZIttXXJd6G3bADZ0/7XUmMVxD1oLRdQAkgPmMI6seDnRXH5Y7SWHZz4XnqMWCifU9s3o73MQwkgHVi07AD1tF0XQ9aU1VfakLncGgVw+eCMYNmuaC/TUAJInrYFdca4+L02dmyJy5vBWjanr6NHidv+bvqlgrndQPsRjX9Ai5mFEkCy7NvdeBV0/ht1MWNTfiQDtJhNoMNdoauYVUViddZPGKYEkCgtLIy/ro0Vi4K+cwP6yy7tlfo+UJnnxlfOvsSX0WImoQSQHDDM/pw+RmxKbCxxORstZhuojBMfUmymQC5Gi5mDEkAy4BN/p6apTXFxMVrMPurhCjT0E9qKWpUYZpE4Bm1mCkoA2w7j8kiIAVdWrb4oxsXTxk/7TRsYZi3RVda6uNhQCsUH0GZmoASwbfhcHA4x+XdtTFgWJIBT0GZ+KC/snwYNbvcYpS2ouUbAxgGL2wAlgMnDDhHzoZM9q4sF21KvIWcetWRHtJov1CsNqKR7862m1FAwO8eMUQKYHBCD72ahm51fyQ/ku9FqPoFOdpGu4k5ITQci8W9o1WkoAWw96hxJuMM6+EZqVDAKvRKt5pfmaqtQ/EXXAI5omIWxRLvOQglg62BR7wkwyrN/gM0WJdbl7sHflmBh7cP6RnBIkTx3SvfqqWjZOSgBTJBGY7sSF1/UXmOHxCJ5AjouBC0w3L5G1xCO6eoZCxbthJ6dghLAK6OWfHtcXqa5rk4JpiU/zPrK1K1m9ExB+ZiuQVwSC+WvPF57A9p2BkoAL8+MipgJ125Ad02dEpd/dTG+jKDev2sbxTExSFSlrvgwtO0ElAC2jB/1BND5/6y7ls6J1xai7WLCQnGJtmFcExcbfS5Oc+W5ACUADTCMhmu1zMXVfTrB0P974LowB9pq2aOyeGdoiPt0DeSiwOuPXXhaSwngpajToGA4fb3umrkp8YB6I4b2i00rr82Fi+fksky9xBNeID+E9q1ACWATXiTfB0P+R/XXykFxscHn8hC0TyigU31W21gui8vLbGVxSgAvntfn1OadE5NoYBWITYy0lELxXX2DuSzxFxb0Hmt61+GCJwAVK+oB8p82vx6uS1w3pbvb2fUlVlHv3JkjxzBttbj4sR/V98OqpE5n/9Dlus5oQ50rB65BW6lT4rW9oK2/r70Gjgti+948nlGRKCW+dC9oLAf3DpiIxPNwkc/a/eDaLlid9Gg0tpu7as2b56wYOK7cP3ge3IV/Anq83Dc0rOukyWhwpNw3+ASU8VMoawXoY7MvuPUt3avTfzOibg7Qxl/I1rOiTYKpytMs6j0Aq0O8HKVAHKoelOgaMgtS3zqAemfOM/5ZZ8tbVvzUO6D/tneUVw5+EDptbU7f0FnQaS+FTnsDdNhbOvsG7oLRw1rozA939g09pQR//gj82f2gu5p/p3/o/+Dfrobf/1rnioFl5VXNn3Xw2y74pT9lxOxUp7lZZyg+DR3oYV1bZ0NimAW1bqwSMRG8MF6sb8zsCIJ2rReJT6ggxmoRE6XS2L6Ni2OgDTPzinjLEsuxVsTW4PH4XH2DZktwB/u9F4hPWBgRZA51HLcfio9Cp/mNri2zJ/HNvB1LZ47u1VNZKK/UN2z21FyeGsiTvKDuYw0JpIPXWtVn2NBGD+jaLouCxH8Djf62kdEvusTNugbOqiAwnoU6XayOT8NqFpbS/LiT8fjr0PGf1rVVdiVudfVL0syBCz5+oW/ojIuL22Gqs4Qd1tuG1c09zU1hAnkC1H1I2yaZF0xfaJSXLKzS25afeaFOzVeIN5RC+bE8rhFvJvGo91iPy2shmTu7Ldc2i4u1fkXuidUmkqSta/kezQdquobPk9QrUC5+7EViaXu1vg9WP3OUwviNpSBerBIbDPHz2+lfEBcPqTpj9Yk0YF29/wiN/YfNGj/Har5ODMU3S1we19EV7+3k7jHgiVVrs8DrMXCX/3o+Xt9thaDzt2Y4WWcKtYNK4QJsjOCO+hcIuO97QfyFtijubgvq+5p82lwuL5zWMT/eW52lwHh8KiSn6+C/M7xQZxtFnd88ajoAgXeP9oIUUc15tbgL/vtataGpeqUGifJoUKiWoKo9DHYJ5fRKpbF9d3f31AbcscdK/Z76M/V3OqrLd2Nd8q3Ncxy4+Ffo5DH87HPgv6+Bjv5rSL7rNyu/qOLij2rkg2FJmEQ9GIS7YT7fDqSpZgcW616i0TX2jh7a4qrEb9SNCMORsMHuh9d2geDN1ToBUgakXmHSqz43UIuFYCTw39oLRSIlLJgG/W/re+LXYfgRTtC9empevh0guasSl/9By3sdxufiMzAlyOynxCRHxcUwxFYdQow+7HEdxmsLPLVxp+5CkkhbKRjy/40F4igMLyILqAUzLKvbi5HcERf3gPbHsCKyROs74teVQvfPhiM5Ki6vnX64ge3diDQZaYELuWT03bfmIpNIm0mdLCSWF+7AzjzTFsZz4OL+bvOLTSKNEZf3l4L4nRg2RJ6YsaCxE+Pi29oLTyJxebnamQjDhcgr6lCJ5gc1uiAgFVFPskgeC6FBr/iKgjpM0ufyKk0wkIokLq934bBXwhJeNT6aZelgSVJCUutExMdpx15iSnulUVJLPNVqL32wkHKkYcblf7LDGoXZg5GYIDASOJhx8UtN0JByIbVZp4jwchPE5qjdbprfE9BDwjzpSRYIQR/xEBNmZrUxg4XiLBguZvIwSlJTapek8+m7fWLS+FHP65trB7jYqAkwkpsaLvH4crVvIV5Ggtg24C7yFo+r7wooEbgrMQyJ+hq16hMvG0Eki/oyDKYG34Ffac8BVwSjMxilXUEdnzBGidf2YqP739MzAmsS66HzX+xH9f3wshCEWdQDJi+IT4LpwYP6ICUlLRbKP0PyPXVGsGRXvAwEYRf1iqkU1j8Ad6UfQZDSgqJ09FMvkh+atWDRDtjsBOEe7dWl+0Ai+DIMTx/SBDFpKwRTrIdBX6NhPpE9Ko3tWVSreoG8CIL5yfHBTdqSxDoY5l/ic3G4WpiFrUkQ2WWPSuPVXhi/Rz20Aj2uD/wCi4unmmv0uTxSnfOAzUYQ+UPd1SAZcLXSEO52d4IK+MygWee7S6E4B9phPi3TJQpLR3XpbjDPPQY6xEXwa35PPeZiLXT2b/lcHufPl3ti9QmCGEOLOp3X5/E/q4dfMBf+GegZbYdyWOobCtCa5mlNPD4aOzx9e08QW4s6tls9BffC2gd9Lk6DhHAl6A4XEoPq6F7zyHB5Fdzhv6g6O6vKt9KQniDSBhKD2s6qLZLvgg74kVIQL1N3XBhmXwFzbLUe4U74ffUa7WnonFvxDYNQm2Y8A//uEdW54d/eqJIO/P55MGdfzgJ5LAzjD1F39fLCfnpKTxBOMzLS0t3dPbW5K/JhvW3qTHv1pdxYtR22fA+1T+IuoZze3b16qvo3+K8JgiAIgiAIgiAIgiAIgiAIgiAIgiAIgiCITDBlyv8DBGlniQq1Wq8AAAAASUVORK5CYII=\"></a>\n    <p>Discover awesome. <a href=\"http://iobroker.net/\" target=\"_blank\">ioBroker</a></p>\n</footer>\n<script>\n    document.getElementById('origin').value = window.location.search.replace('&error', '');\n    var userLang = navigator.language || navigator.userLanguage;\n    userLang = userLang.substring(0, 2).toLowerCase();\n    var systemDictionary = {\n        \"wrongPassword\": {\n            \"en\": \"Invalid username or password\",\n            \"de\": \"Name oder Kennwort sind falsch\",\n            \"ru\": \"\u041d\u0435\u0432\u0435\u0440\u043d\u044b\u0435 \u0438\u043c\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f \u0438\u043b\u0438 \u043f\u0430\u0440\u043e\u043b\u044c\",\n            \"pt\": \"nome de usu\u00e1rio ou senha inv\u00e1lidos\",\n            \"nl\": \"ongeldige gebruikersnaam of wachtwoord\",\n            \"fr\": \"Nom d'utilisateur ou mot de passe invalide\",\n            \"it\": \"Nome utente o password errati\",\n            \"es\": \"usuario o contrase\u00f1a invalido\",\n            \"pl\": \"Nieprawid\u0142owa nazwa u\u017cytkownika lub has\u0142o\",\n            \"zh-cn\": \"\u7528\u6237\u540d\u6216\u5bc6\u7801\u65e0\u6548\"\n        },\n        \"enterLogin\": {\n            \"en\": \"Login name\",\n            \"de\": \"Loginname\",\n            \"ru\": \"\u0418\u043c\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\",\n            \"pt\": \"Nome de acesso\",\n            \"nl\": \"Inlog naam\",\n            \"fr\": \"Identifiant\",\n            \"it\": \"Nome di login\",\n            \"es\": \"Nombre de inicio de sesi\u00f3n\",\n            \"pl\": \"Nazwa u\u017cytkownika\",\n            \"zh-cn\": \"\u767b\u5f55\u540d\"\n        },\n        \"enterPassword\": {\n            \"en\": \"Password\",\n            \"de\": \"Kennwort\",\n            \"ru\": \"\u041f\u0430\u0440\u043e\u043b\u044c\",\n            \"pt\": \"Senha\",\n            \"nl\": \"Wachtwoord\",\n            \"fr\": \"Mot de passe\",\n            \"it\": \"Parola d'ordine\",\n            \"es\": \"Contrase\u00f1a\",\n            \"pl\": \"Has\u0142o\",\n            \"zh-cn\": \"\u5bc6\u7801\"\n        },\n        \"login\": {\n            \"en\": \"Log in\",\n            \"de\": \"Log in\",\n            \"ru\": \"\u0412\u043e\u0439\u0442\u0438\",\n            \"pt\": \"Entrar\",\n            \"nl\": \"Log in\",\n            \"fr\": \"S'identifier\",\n            \"it\": \"Accesso\",\n            \"es\": \"Iniciar sesi\u00f3n\",\n            \"pl\": \"Zaloguj Si\u0119\",\n            \"zh-cn\": \"\u767b\u5f55\"\n        },\n        \"title\": {\n            \"en\": \"Admin\",\n            \"de\": \"Admin\",\n            \"ru\": \"\u0412\u0445\u043e\u0434 \u0432 \u0430\u0434\u043c\u0438\u043d\"\n        }\n    };\n\n    if (window.location.search.indexOf('error') !== -1) {\n        document.getElementById('error').innerHTML      = systemDictionary.wrongPassword[userLang]  || systemDictionary.wrongPassword.en;\n        document.getElementById('error').style.display  = '';\n    }\n    document.getElementById('username-label').innerHTML = systemDictionary.enterLogin[userLang]     || systemDictionary.enterLogin.en;\n    document.getElementById('password-label').innerHTML = systemDictionary.enterPassword[userLang]  || systemDictionary.enterPassword.en;\n    document.getElementById('login-label').innerHTML    = systemDictionary.title[userLang]          || systemDictionary.title.en;\n    document.getElementById('submit-label').innerHTML   = systemDictionary.login[userLang]          || systemDictionary.login.en;\n\n    var inputs = document.getElementsByTagName('INPUT');\n    if (inputs) {\n        for (var i = 0; i < inputs.length; i++) {\n            inputs[i].addEventListener('blur', function() {\n                if (this.value) {\n                    if (this.className.indexOf('used') === -1) {\n                        this.className += ' used';\n                    }\n                } else {\n                    this.className = this.className.replace(/\\s?used/, '');\n                }\n            });\n        }\n        setTimeout(function () {\n            if (document.getElementById('username').value) {\n                document.getElementById('password').focus();\n                setTimeout(function () {\n                    if (!document.getElementById('username').value) {\n                        document.getElementById('username').focus();\n                    }\n                }, 300);\n            } else {\n                document.getElementById('username').focus();\n            }\n        }, 300);\n    }\n    document.getElementById('username').addEventListener('keydown', function (e) {\n        if (e.keyCode === 13) {\n            e.preventDefault();\n            setTimeout(function () {\n                document.getElementById('password').focus();\n            }, 100);\n        }\n    });\n    document.getElementById('password').addEventListener('keyup', function (e) {\n        if (e.keyCode === 13) {\n            document.getElementById('submit').click();\n        }\n    });\n\n    function animationEnd () {\n        this.className = this.className.replace(/\\s?is-active/, '');\n    }\n\n    var ripples = document.getElementsByClassName('ripples');\n    if (ripples) {\n        for (var r = 0; r < ripples.length; r++) {\n            ripples[r].addEventListener('click', function (e) {\n                var $parent = this.parentElement.parentElement;\n                var $offset = {top: $parent.offsetTop, left: $parent.offsetLeft};\n                var $circle = this.getElementsByClassName('ripplesCircle')[0];\n\n                var x = e.pageX - $offset.left;\n                var y = e.pageY - $offset.top;\n\n                $circle.style.top   = y + 'px';\n                $circle.style.left  = x + 'px';\n\n                if (this.className.indexOf('is-active') === -1) {\n                    this.className += ' is-active';\n                }\n            });\n\n            ripples[r].addEventListener('webkitAnimationEnd',   animationEnd);\n            ripples[r].addEventListener('mozAnimationEnd',      animationEnd);\n            ripples[r].addEventListener('MSAnimationEnd',       animationEnd);\n            ripples[r].addEventListener('oanimationend',        animationEnd);\n            ripples[r].addEventListener('animationend',         animationEnd);\n        }\n    }\n</script>\n</body>\n</html>"], "fixing_code": ["![Logo](admin/admin.png)\n# ioBroker.admin\n\n[![NPM version](http://img.shields.io/npm/v/iobroker.admin.svg)](https://www.npmjs.com/package/iobroker.admin)\n[![Downloads](https://img.shields.io/npm/dm/iobroker.admin.svg)](https://www.npmjs.com/package/iobroker.admin)\n[![Stable](http://iobroker.live/badges/admin-stable.svg)](http://iobroker.live/badges/admin-stable.svg)\n[![installed](http://iobroker.live/badges/admin-installed.svg)](http://iobroker.live/badges/admin-installed.svg)\n\n[![NPM](https://nodei.co/npm/iobroker.admin.png?downloads=true)](https://nodei.co/npm/iobroker.admin/)\n\nUser interface for configuration and administration of ioBroker.\n\n## Using common.localLink\n- %ip% - ioBroker ip address (address of the admin)\n- %secure% or %protocol% - read from native.secure the value and use http or https\n- %web_protocol% - looking for the first instance of web (e.g. web.0) and get \"native.secure\" from \"system.adapter.web.0\"\n- %instance% - instance of the adapter\n- %someField% - get someField from \"native\" of this adapter instance\n- %web.0_bind% - get native.bind from \"system.adapter.web.0\"\n- %native_someField% - get someField from \"native\" of this adapter instance\n\n## Scheduled restart\nSome adapters re not stable or connection disappear after one or two days.\nTo fix this there is a scheduled restart setting.\nTo activate scheduled restart just define CRON condition when to restart adapter.\n\nIt is suggested to restart in the night, when no one use the adapter, e.g. \"0 3 * * *\" - at 3:00 every day.\n\n## Let's Encrypt Certificates\nLet\u2019s Encrypt is a free, automated, and open certificate authority brought to you by the non-profit Internet Security Research Group (ISRG).\n\nYou can read about Let\u2019s Encrypt [here](https://letsencrypt.org/).\n\nSome installations use Dynamic DNS and Co to get the domain name and to reach under this domain name own web sites.\nioBroker supports automatic request and renew of certificates from Let\u2019s Encrypt Organisation.\n\nThere is an option to activate free certificates from Let\u2019s Encrypt almost in every adapter, that can start some web server and supports HTTPS.\n\nIf you just enable the using of certificates and will not activate an automatic update the instance will try to use stored certificates.\n\nIf the automatic update is activated the instance will try to request certificates from Let\u2019s Encrypt and will automatically update it.\n\nThe certificates will be first requested when the given domain address will be accessed. E.g you have \"sub.domain.com\" as address, when you try to access https://sub.domain.com the certificates will be first requested and it can last a little before first answer will come.\n\nThe issuing of certificates is rather complex procedure, but if you will follow the explanation you will easy get free certificates.\n\nDescription:\n\n1. The new account will be created with given email address (you must set it up in system settings)\n2. Some random key will be created as password for the account.\n3. After the account is created the system starts on port 80 the small web site to confirm the domain.\n4. Let's encrypt use **always** port **80** to check the domain.\n5. If port 80 is occupied by other service see point 4.\n6. After the small web server is up the request to get certificates for given domains (system settings) will be sent to the Let's encrypt server.\n7. Let's encrypt server sends back some challenge phrase as answer on the request and after a while tries to read this challenge phrase on \"http://yourdomain:80/.well-known/acme-challenge/<CHALLENGE>\"\n8. If challenge phrase from our side comes back the Let's encrypt server send us the certificates. They will be stored in the given directory (system settings).\n\nSounds complex, but everything what you must do is to activate checkboxes and specify your email and domain in system settings.\n\nThe received certificates are valid ca. 90 days.\nAfter the certificates are received the special task will be started to automatically renew the certificates.\n\nThe topic is rather complex and 1000 things can go wrong. If you cannot get certificates please use cloud service to reach your installation from internet.\n\n**Let's encrypt works only from node.js version>=4.5**\n\n## Todo\n- move html tooltips to materialize tooltips\n- tiles for hosts (additionally to table - low prior)\n- tiles for instances (additionally to table - low prior)\n\n## Used icons\nThis project uses some icons from [Flaticon](https://www.flaticon.com/):\n- <img src=\"src/img/rooms/006-double-bed.svg\" height=\"48\" /> - designed by [smalllikeart](https://www.flaticon.com/authors/smalllikeart) from [Flaticon](https://www.flaticon.com/)\n- <img src=\"src/img/rooms/016-armchair-1.svg\" height=\"48\" /> - designed by [smalllikeart](https://www.flaticon.com/authors/smalllikeart) from [Flaticon](https://www.flaticon.com/)\n- <img src=\"src/img/rooms/022-armchair-1.svg\" height=\"48\" /> - designed by [smalllikeart](https://www.flaticon.com/authors/smalllikeart) from [Flaticon](https://www.flaticon.com/)\n- <img src=\"src/img/devices/light-bulb.svg\" height=\"48\" /> - Icons made by [Vectors Market](https://www.flaticon.com/authors/vectors-market) from [Flaticon](https://www.flaticon.com/) is licensed by [CC 3.0 BY](http://creativecommons.org/licenses/by/3.0/).\n- <img src=\"src/img/rooms/garage.svg\" height=\"48\" /> - designed by [Pause08](https://www.flaticon.com/authors/Pause08) from [Flaticon](https://www.flaticon.com/)\n- <img src=\"src/img/rooms/toilet.svg\" height=\"48\" /> - Icons made by [Freepik](http://www.freepik.com) from [www.flaticon.com](https://www.flaticon.com/) is licensed by [CC 3.0 BY](http://creativecommons.org/licenses/by/3.0/)\n\n## Changelog\n### 3.6.8 (2019-10-09)\n* (bluefox) Log paths were sanitized\n* (bluefox) NPM packages were updated\n\n### 3.6.7 (2019-09-24)\n* (ldittmar) Add Node.JS version check to popup messages\n\n### 3.6.6 (2019-09-18)\n* (SchumyHao) Update Chinese translation\n* (tmikulski) Update translations.json\n\n### 3.6.5 (2019-09-02)\n* (ldittmar) Fix anoying popups from info adapter\n\n### 3.6.4 (2019-06-03)\n* (bluefox) Update nodejs recommendation message and check to recommend nodejs 10\n\n### 3.6.3 (2019-06-02)\n* (bluefox) Added deleteFile internal function (required for lovelace)\n* (bluefox) Added yaml editor (required for lovelace)\n* (bluefox) try to fix auto-fill option\n* (dobis) Update italian translations\n\n### 3.6.2 (2019-05-05)\n* (bluefox) Added onSave handler for custom dialogs\n\n### 3.6.1 (2019-04-18)\n* (ldittmar) Better integration for ioBroker.info (1.3.7)\n* (ldittmar) Update Gulp to v4\n* (ldittmar) Update materialize-css to v 1.0.0\n\n### 3.6.0 (2018-11-08)\n* (foxriver76) New update states added in info channel\n* (foxriver76) Take respect to async when creating info states\n* (SchumyHao) Added chinese translations\n\n### 3.5.10 (2018-09-22)\n* (bluefox) Disable too many debug outputs\n\n### 3.5.9 (2018-09-12)\n* (bluefox) The log output problem was fixed\n\n### 3.5.8 (2018-09-03)\n* (bluefox) Google map was replaces with \"open street map\"\n\n### 3.5.7 (2018-08-30)\n* (bluefox) Edit of the table entries in configuration dialog was corrected.\n\n### 3.5.6 (2018-08-22)\n* (bluefox) Import and export of the instance configuration was implemented.\n\n### 3.5.5 (2018-08-21)\n* (bluefox) Fix upload of files\n\n### 3.5.3 (2018-08-18)\n* (bluefox) Dropdown was fixed on touch devices\n* (bluefox) Speedup build of instances\n\n### 3.5.1 (2018-08-11)\n* (bluefox) Error in custom settings was fixed\n\n### 3.5.0 (2018-08-03)\n* (bluefox) Editing of enums was changed\n* (bluefox) Logo was updated\n* (bluefox) The function icons were added\n\n### 3.4.9 (2018-07-17)\n* (bluefox) Support of the custom login screen background\n* (bluefox) show tooltip about refresh on instances page\n* (bluefox) Destroy tabs after they left\n\n### 3.4.8 (2018-07-17)\n* (bluefox) fix error with add new enum\n* (bluefox) try to fix error with custom settings\n* (bluefox) place all titles at the top in the config\n* (bluefox) add expert mode to common\n* (bluefox) allow edit of enum's names in many languages\n\n### 3.4.7 (2018-06-25)\n* (bluefox) add getInterfaces function\n* (bluefox) save scroll position for some tables\n* (bluefox) add info about \"filtered out\"\n\n### 3.4.6 (2018-06-18)\n* (bluefox) Minor GUI fixes\n\n### 3.4.5 (2018-06-12)\n* (bluefox) Minor GUI fixes\n\n### 3.4.4 (2018-06-04)\n* (bluefox) add touch support for draggable and droppable\n* (bluefox) edit raw value and not escaped in selectID.js\n* (bluefox) allow edit of empty names in selectID.less\n* (bluefox) add change with ack=true to selectID\n* (bluefox) fix select for admin3 in configuration dialog\n* (bluefox) add autocomplete for configs\n* (bluefox) fix enums\n\n### 3.4.3 (2018-05-13)\n* (bluefox) The button in selectID was fixed\n* (bluefox) disk info was added\n* (bluefox) The filter in table mode on adapter tab was showed\n* (bluefox) memAvailable for RAM monitoring is used\n* (bluefox) fix select problem in config dialog\n* (bluefox) added the asking about unsaved scripts\n\n### 3.4.2 (2018-05-04)\n* (BuZZy1337) fix wrong height calculation in select id dialog\n\n### 3.4.1 (2018-05-03)\n* (bluefox) fix wait popup\n* (bluefox) fix button name in config dialog\n* (BuZZy1337) escape html from log entries\n* (bluefox) fix objects counter\n* (BuZZy1337) show current Tab in Page-Title\n* (BuZZy1337) escape HTML Tags from selectID.js\n* (bluefox) GUI bugfixes\n* (BuZZy1337) Fix: Unable to scroll trough Dropdown on Touchscreens\n* (BuZZy1337) Enhancement: Show current Tab in Pagetitle\n\n### 3.4.0 (2018-04-23)\n* (bluefox) show error about not activated admin for cloud\n* (bluefox) handle mutlilanguage names\n* (bluefox) show number of objects\n* (BuZZy1337) always addChips when input blurs\n* (bluefox) fix select ID dialog for old styles\n* (bluefox) add states view for object tab\n\n### 3.3.9 (2018-04-12)\n* (bluefox) The user and groups deletion was corrected\n* (bluefox) Force using of socket.io 2.1.0\n\n### 3.3.8 (2018-04-10)\n* (bluefox) Hosts selection is improved\n\n### 3.3.7 (2018-04-10)\n* (bluefox) small UI corrections\n\n### 3.3.5 (2018-03-25)\n* (bondrogeen) info for server redesigned\n* (bondrogeen) hosts list redesigned\n* (bluefox) small UI corrections\n\n### 3.3.4 (2018-03-17)\n* (bluefox) small UI corrections\n\n### 3.3.3 (2018-03-15)\n* (bluefox) small UI corrections\n\n### 3.3.1 (2018-03-11)\n* (bluefox) Corrections for scenes\n* (bluefox) move from socket.io 2.0.4 to 1.5.1 because of bug\n* (bluefox) small fix for hosts\n\n### 3.3.0 (2018-03-10)\n* (bluefox) Overview page was added\n* (bluefox) Many bugs were fixed\n\n### 3.2.4 (2018-03-04)\n* (bluefox) Adjust layout on mobile devices\n\n### 3.2.1 (2018-03-03)\n* (bluefox) Many UI fixes\n\n### 3.2.0 (2018-02-09)\n* (bluefox) The select ID dialog was fixed\n\n### 3.1.12 (2018-02-05)\n* (bondrogeen) Configuration dialog updated\n* (bondrogeen) Open menu button is fixed\n\n### 3.1.11 (2018-02-04)\n* (bluefox) Connection LED fixed\n\n### 3.1.10 (2018-02-02)\n* (bluefox) update material CSS\n* (bluefox) fix permission error\n* (bluefox) fix filter of adapters\n\n### 3.1.7 (2018-01-31)\n* (bluefox) Fixing the role selection\n* (bluefox) It runs even in IE10\n\n### 3.1.6 (2018-01-30)\n* (bluefox) Fixes for Firefox and MS-EDGE\n\n### 3.1.2 (2018-01-25)\n* (bluefox) GUI corrections\n\n### 3.0.12 (2018-01-19)\n* (bluefox) Old configuration dialogs fixed\n* (bluefox) convert strings to booleans by object edit\n* (DeepCoreSystem) Updates in english, german and french translations\n* (bluefox) buttons layout fixed\n* (bluefox) event fixes\n\n### 3.0.11 (2018-01-11)\n* (DeepCoreSystem) French update\n* (bluefox) fix error with empty ID\n* (bluefox) add sort by \"recently updated\"\n* (ldittmar) add readme and issues viewer\n\n### 3.0.10 (2018-01-06)\n* (bluefox) Update indication\n* (ldittmar) Use jQuery3\n* (AlCalzone) German translations\n\n### 3.0.7 (2018-01-01)\n* (soef) update instances, objects and other lists\n* (bluefox) rewrite interface with materialize\n\n### 2.0.11 (2017-10-23)\n* (bluefox) Configurable event update disable threshold\n\n### 2.0.10 (2017-10-22)\n* (soef) added use of delete-key in the objects view\n\n### 2.0.8 (2017-10-12)\n* (soef) fix quickEdit: number with boolean value\n\n### 2.0.7 (2017-10-11)\n* (soef) Sort option added to object view\n\n### 2.0.5 (2017-10-06)\n* (bluefox) Show the history charts if the web server has the https option on too\n\n### 2.0.3 (2017-08-13)\n* (bluefox) Fix user access rights for sendToHost\n\n### 2.0.2 (2017-08-12)\n* (bluefox) Add the editing of the default access rights\n\n### 2.0.1 (2017-08-07)\n* (bluefox) Allow access via iobroker.pro\n* (bluefox) Add node.js version recommendation\n\n### 1.8.3 (2017-07-24)\n* (bluefox) allow access on tmp directory\n\n### 1.8.0 (2017-06-02)\n* (bluefox) split into modules\n\n### 1.7.6 (2017-06-01)\n* (bluefox) Fix edit of the enum name\n\n### 1.7.5 (2017-05-20)\n* (bluefox) catch error if translated object is not text\n* (bluefox) update selectID.js\n* (bluefox) do not open configuration dialog for instances with no config\n* (Steiger04) select multiple auch bei data-name=\"[eigner-name]\"\n\n### 1.7.3 (2017-03-25)\n* (bluefox) fix license dialog\n* (bluefox) change color of tooltip text\n* (ykuendig) update german translation\n* (bluefox) add docs\n\n### 1.7.2 (2017-03-15)\n* (bluefox) add statistics selector for no-city\n* (bluefox) support of discovery by first start\n\n### 1.7.1 (2017-03-11)\n* (apollon77) fix save button functionality\n* (ykuendig) Update german translations\n* (bluefox) patch repositories to support stable\n\n### 1.7.0 (2017-03-08)\n* (bluefox) fix log\n* (bluefox) show jQuery button for role button\n* (apollon77) update testing setup.js\n* (bluefox) fix wetty loading\n* (bluefox) fix add/delete tabs\n* (bluefox) implement hints for configuration dialog\n* (bluefox) redirect if IP address changes\n* (bluefox) add tooltip instruction\n* (bluefox) wizard support\n* (bluefox) fix acl error\n* (bluefox) fix license agree button\n\n## License\n\nThe MIT License (MIT)\n\nCopyright (c) 2014-2019 bluefox <dogafox@gmail.com>\n", "'use strict';\n\nconst less        = require('gulp-less');\nconst sass        = require('gulp-sass');\nconst gulp        = require('gulp');\nconst colors      = require('ansi-colors');\nconst log         = require('fancy-log');\nconst uglify      = require('gulp-terser');\nconst htmlmin     = require('gulp-htmlmin');\nconst concat      = require('gulp-concat');\nconst sourcemaps  = require('gulp-sourcemaps');\nconst materialize = require.resolve('materialize-css');\nconst cleanCSS    = require('gulp-clean-css');\nconst pkg         = require('./package.json');\nconst iopackage   = require('./io-package.json');\nconst babel       = require('gulp-babel');\nconst fs          = require('fs');\n\nconst fileName = 'words.js';\nconst noSort   = false;\n\n/* How to work with language scripts\n--------------------------------------------------------\n    you can use for edit this tool https://github.com/ldittmar81/ioBroker-i18n-editor\n    to do that you can convert words from words.js into 6 json files, that i18n editor can understand. Use \"www (words.js => json).\n\n    To combine from json files the words.js again, just call www (json => words.js)\n\n    wwwWords2languages - converts src/js/words.js into 6 different json files in src/i18n/xxx/translations.json\n    wwwLanguages2words - converts 6 different json files from src/i18n/xxx/translations.json into src/js/words.js\n--------------------------------------------------------\n    You can export just a flat texts and translate them with e.g. google translator.\n    to do that you can convert words from words.js into 7 txt files. www (words.js => flat)\n\n    To combine from json files the words.js again, just call www (flat => words.js)\n\n    wwwWords2languagesFlat - converts src/js/words.js into 6 different txt files in src/i18n/xxx/flat.txt. Additionally it creates extra files with keys in src/i18n/flat.txt\n    wwwLanguagesFlat2words - converts src/i18n/xxx/flat.txt into src/js/words.js\n\n    adminWordsXXx is just the same, but for /admin/words.js\n */\n\nfunction lang2data(lang, isFlat) {\n    var str = isFlat ? '' : '{\\r\\n';\n    var count = 0;\n    for (var w in lang) {\n        if (lang.hasOwnProperty(w)) {\n            count++;\n            if (isFlat) {\n                str += (lang[w] === '' ? (isFlat[w] || w) : lang[w]) + '\\r\\n';\n            } else {\n                var key = '  \"' + w.replace(/\"/g, '\\\\\"') + '\": ';\n                str += /*padRight(*/key/*, 42)*/ +  '\"' + lang[w].replace(/\"/g, '\\\\\"') + '\",\\r\\n';\n            }\n        }\n    }\n    if (!count) return isFlat ? '' : '{\\r\\n}';\n    if (isFlat) {\n        return str;\n    } else {\n        return str.substring(0, str.length - 3) + '\\r\\n}\\r\\n';\n    }\n}\n\nfunction readWordJs(src) {\n    try {\n        var words;\n        if (fs.existsSync(src + 'js/' + fileName)) {\n            words = fs.readFileSync(src + 'js/' + fileName).toString();\n        } else {\n            words = fs.readFileSync(src + fileName).toString();\n        }\n\n        var lines = words.split(/\\r\\n|\\r|\\n/g);\n        var i = 0;\n        while (!lines[i].match(/^systemDictionary = {/)) {\n            i++;\n        }\n        lines.splice(0, i);\n\n        // remove last empty lines\n        i = lines.length - 1;\n        while (!lines[i]) {\n            i--;\n        }\n        if (i < lines.length - 1) {\n            lines.splice(i + 1);\n        }\n\n        lines[0] = lines[0].replace('systemDictionary = ', '');\n        lines[lines.length - 1] = lines[lines.length - 1].trim().replace(/};$/, '}');\n        words = lines.join('\\n');\n        var resultFunc = new Function('return ' + words + ';');\n\n        return resultFunc();\n    } catch (e) {\n        return null;\n    }\n}\nfunction padRight(text, totalLength) {\n    return text + (text.length < totalLength ? new Array(totalLength - text.length).join(' ') : '');\n}\nfunction writeWordJs(data, src) {\n    var text = '// DO NOT EDIT THIS FILE!!! IT WILL BE AUTOMATICALLY GENERATED FROM src/i18n\\n';\n    text += '/*global systemDictionary:true */\\n';\n    text += '\\'use strict\\';\\n\\n';\n    text += 'systemDictionary = {\\n';\n    for (var word in data) {\n        if (data.hasOwnProperty(word)) {\n            text += '    ' + padRight('\"' + word.replace(/\"/g, '\\\\\"') + '\": {', 50);\n            var line = '';\n            for (var lang in data[word]) {\n                if (data[word].hasOwnProperty(lang)) {\n                    line += '\"' + lang + '\": \"' + padRight(data[word][lang].replace(/\"/g, '\\\\\"') + '\",', 50) + ' ';\n                }\n            }\n            if (line) {\n                line = line.trim();\n                line = line.substring(0, line.length - 1);\n            }\n            text += line + '},\\n';\n        }\n    }\n    text += '};\\n';\n    if (src.indexOf('admin') === -1) {\n        fs.writeFileSync(src + 'js/' + fileName, text);\n    } else {\n        fs.writeFileSync(src + fileName, text);\n    }\n}\n\nconst EMPTY = '';\n\nfunction words2languages(src) {\n    var langs =  {\n        'en': {},\n        'de': {},\n        'ru': {},\n        'pt': {},\n        'nl': {},\n        'fr': {},\n        'it': {},\n        'es': {},\n        'pl': {},\n        'zh-cn': {}\n    };\n    var data = readWordJs(src);\n    if (data) {\n        for (var word in data) {\n            if (data.hasOwnProperty(word)) {\n                for (var lang in data[word]) {\n                    if (data[word].hasOwnProperty(lang)) {\n                        langs[lang][word] = data[word][lang];\n                        //  pre-fill all other languages\n                        for (var j in langs) {\n                            if (langs.hasOwnProperty(j)) {\n                                langs[j][word] = langs[j][word] || EMPTY;\n                            }\n                        }\n                    }\n                }\n            }\n        }\n        if (!fs.existsSync(src + 'i18n/')) {\n            fs.mkdirSync(src + 'i18n/');\n        }\n        for (var l in langs) {\n            var keys = Object.keys(langs[l]);\n            if (!noSort) keys.sort();\n            var obj = {};\n            for (var k = 0; k < keys.length; k++) {\n                obj[keys[k]] = langs[l][keys[k]];\n            }\n            if (!fs.existsSync(src + 'i18n/' + l)) {\n                fs.mkdirSync(src + 'i18n/' + l);\n            }\n\n            fs.writeFileSync(src + 'i18n/' + l + '/translations.json', lang2data(obj));\n        }\n    } else {\n        console.error('Cannot read or parse ' + fileName);\n    }\n}\nfunction words2languagesFlat(src) {\n    var langs =  {\n        'en': {},\n        'de': {},\n        'ru': {},\n        'pt': {},\n        'nl': {},\n        'fr': {},\n        'it': {},\n        'es': {},\n        'pl': {},\n        'zh-cn': {}\n    };\n    var data = readWordJs(src);\n    if (data) {\n        for (var word in data) {\n            if (data.hasOwnProperty(word)) {\n                for (var lang in data[word]) {\n                    if (data[word].hasOwnProperty(lang)) {\n                        langs[lang][word] = data[word][lang];\n                        //  pre-fill all other languages\n                        for (var j in langs) {\n                            if (langs.hasOwnProperty(j)) {\n                                langs[j][word] = langs[j][word] || EMPTY;\n                            }\n                        }\n                    }\n                }\n            }\n        }\n        var keys = Object.keys(langs.en);\n        if (!noSort) keys.sort();\n        for (var l in langs) {\n            var obj = {};\n            for (var k = 0; k < keys.length; k++) {\n                obj[keys[k]] = langs[l][keys[k]];\n            }\n            langs[l] = obj;\n        }\n        if (!fs.existsSync(src + 'i18n/')) {\n            fs.mkdirSync(src + 'i18n/');\n        }\n        for (var ll in langs) {\n            if (!fs.existsSync(src + 'i18n/' + ll)) {\n                fs.mkdirSync(src + 'i18n/' + ll);\n            }\n\n            fs.writeFileSync(src + 'i18n/' + ll + '/flat.txt', lang2data(langs[ll], langs.en));\n        }\n        fs.writeFileSync(src + 'i18n/flat.txt', keys.join('\\n'));\n    } else {\n        console.error('Cannot read or parse ' + fileName);\n    }\n}\nfunction languagesFlat2words(src) {\n    var dirs = fs.readdirSync(src + 'i18n/');\n    var langs = {};\n    var bigOne = {};\n    var order = ['en', 'de', 'ru', 'pt', 'nl', 'fr', 'it', 'es', 'pl', 'zh-cn'];\n    dirs.sort(function (a, b) {\n        var posA = order.indexOf(a);\n        var posB = order.indexOf(b);\n        if (posA === -1 && posB === -1) {\n            if (a > b) return 1;\n            if (a < b) return -1;\n            return 0;\n        } else if (posA === -1) {\n            return -1;\n        } else if (posB === -1) {\n            return 1;\n        } else {\n            if (posA > posB) return 1;\n            if (posA < posB) return -1;\n            return 0;\n        }\n    });\n    var keys = fs.readFileSync(src + 'i18n/flat.txt').toString().split(/\\r\\n|\\n|\\r/);\n\n    for (var l = 0; l < dirs.length; l++) {\n        if (dirs[l] === 'flat.txt') continue;\n        var lang = dirs[l];\n        var values = fs.readFileSync(src + 'i18n/' + lang + '/flat.txt').toString().split(/\\r\\n|\\n|\\r/);\n        langs[lang] = {};\n        keys.forEach(function (word, i) {\n             langs[lang][word] = values[i];\n        });\n\n        var words = langs[lang];\n        for (var word in words) {\n            if (words.hasOwnProperty(word)) {\n                bigOne[word] = bigOne[word] || {};\n                if (words[word] !== EMPTY) {\n                    bigOne[word][lang] = words[word];\n                }\n            }\n        }\n    }\n    // read actual words.js\n    var aWords = readWordJs();\n\n    var temporaryIgnore = ['flat.txt'];\n    if (aWords) {\n        // Merge words together\n        for (var w in aWords) {\n            if (aWords.hasOwnProperty(w)) {\n                if (!bigOne[w]) {\n                    console.warn('Take from actual ' + fileName + ': ' + w);\n                    bigOne[w] = aWords[w];\n                }\n                dirs.forEach(function (lang) {\n                    if (temporaryIgnore.indexOf(lang) !== -1) return;\n                    if (!bigOne[w][lang]) {\n                        console.warn('Missing \"' + lang + '\": ' + w);\n                    }\n                });\n            }\n        }\n\n    }\n\n    writeWordJs(bigOne, src);\n}\nfunction languages2words(src) {\n    var dirs = fs.readdirSync(src + 'i18n/');\n    var langs = {};\n    var bigOne = {};\n    var order = ['en', 'de', 'ru', 'pt', 'nl', 'fr', 'it', 'es', 'pl', 'zh-cn'];\n    dirs.sort(function (a, b) {\n        var posA = order.indexOf(a);\n        var posB = order.indexOf(b);\n        if (posA === -1 && posB === -1) {\n            if (a > b) return 1;\n            if (a < b) return -1;\n            return 0;\n        } else if (posA === -1) {\n            return -1;\n        } else if (posB === -1) {\n            return 1;\n        } else {\n            if (posA > posB) return 1;\n            if (posA < posB) return -1;\n            return 0;\n        }\n    });\n    for (var l = 0; l < dirs.length; l++) {\n        if (dirs[l] === 'flat.txt' || dirs[l] === '.i18n-editor-metadata') continue;\n        var lang = dirs[l];\n        langs[lang] = fs.readFileSync(src + 'i18n/' + lang + '/translations.json').toString();\n        langs[lang] = JSON.parse(langs[lang]);\n        var words = langs[lang];\n        for (var word in words) {\n            if (words.hasOwnProperty(word)) {\n                bigOne[word] = bigOne[word] || {};\n                if (words[word] !== EMPTY) {\n                    bigOne[word][lang] = words[word].replace(/<\\/ i>/g, '</i>').replace(/<\\/ b>/g, '</b>').replace(/<\\/ span>/g, '</span>').replace(/% s/g, ' %s');\n                }\n            }\n        }\n    }\n    // read actual words.js\n    var aWords = readWordJs();\n\n    var temporaryIgnore = [];\n    if (aWords) {\n        // Merge words together\n        for (var w in aWords) {\n            if (aWords.hasOwnProperty(w)) {\n                if (!bigOne[w]) {\n                    console.warn('Take from actual ' + fileName + ': ' + w);\n                    bigOne[w] = aWords[w];\n                }\n                dirs.forEach(function (lang) {\n                    if (temporaryIgnore.indexOf(lang) !== -1) return;\n                    if (!bigOne[w][lang]) {\n                        console.warn('Missing \"' + lang + '\": ' + w);\n                    }\n                });\n            }\n        }\n\n    }\n\n    writeWordJs(bigOne, src);\n}\n\ngulp.task('www (words.js => json)', done => {\n    words2languages('./src/');\n    done();\n});\n\ngulp.task('www (words.js => flat)', done => {\n    words2languagesFlat('./src/');\n    done();\n});\n\ngulp.task('www (flat => words.js)', done => {\n    languagesFlat2words('./src/');\n    done();\n});\n\ngulp.task('www (json => words.js)', done => {\n    languages2words('./src/');\n    done();\n});\n\ngulp.task('admin (words.js => json)', done => {\n    words2languages('./admin/');\n    done();\n});\n\ngulp.task('admin (words.js => flat)', done => {\n    words2languagesFlat('./admin/');\n    done();\n});\n\ngulp.task('admin (flat => words.js)', done => {\n    languagesFlat2words('./admin/');\n    done();\n});\n\ngulp.task('admin (json => words.js)', done => {\n    languages2words('./admin/');\n    done();\n});\n\ngulp.task('updatePackages', done => {\n    iopackage.common.version = pkg.version;\n    iopackage.common.news = iopackage.common.news || {};\n    if (!iopackage.common.news[pkg.version]) {\n        var news = iopackage.common.news;\n        var newNews = {};\n\n        newNews[pkg.version] = {\n            en: 'news',\n            de: 'neues',\n            ru: '\u043d\u043e\u0432\u043e\u0435',\n            pt: 'novidades',\n            nl: 'nieuws',\n            fr: 'nouvelles',\n            it: 'notizie',\n            es: 'noticias',\n            pl: 'aktualno\u015bci',\n            'zh-cn': '\u6d88\u606f'\n        };\n        iopackage.common.news = Object.assign(newNews, news);\n    }\n    fs.writeFileSync('io-package.json', JSON.stringify(iopackage, null, 4));\n    done();\n});\n\ngulp.task('updateReadme', done => {\n    var readme = fs.readFileSync('README.md').toString();\n    var pos = readme.indexOf('## Changelog\\n');\n    if (pos !== -1) {\n        var readmeStart = readme.substring(0, pos + '## Changelog\\n'.length);\n        var readmeEnd   = readme.substring(pos + '## Changelog\\n'.length);\n\n        if (readme.indexOf(version) === -1) {\n            var timestamp = new Date();\n            var date = timestamp.getFullYear() + '-' +\n                ('0' + (timestamp.getMonth() + 1).toString(10)).slice(-2) + '-' +\n                ('0' + (timestamp.getDate()).toString(10)).slice(-2);\n\n            var news = '';\n            if (iopackage.common.news && iopackage.common.news[pkg.version]) {\n                news += '* ' + iopackage.common.news[pkg.version].en;\n            }\n\n            fs.writeFileSync('README.md', readmeStart + '### ' + version + ' (' + date + ')\\n' + (news ? news + '\\n\\n' : '\\n') + readmeEnd);\n        }\n    }\n    done();\n});\n\ngulp.task('materializeCSS', () => {\n    return gulp.src(['./src/materialize-css/sass/**/*.scss'])\n        .pipe(sass({\n            paths: [ ]\n        }))\n        .pipe(concat('materialize.css'))\n        .pipe(cleanCSS({compatibility: 'ie8'}))\n        .pipe(gulp.dest('./www/lib/css'));\n\n});\n\ngulp.task('materializeJS', () => {\n    return gulp.src([\n        './src/materialize-css/js/global.js',\n        './src/materialize-css/js/component.js',\n        './src/materialize-css/js/anime.min.js',\n        './src/materialize-css/js/cash.js',\n        './src/materialize-css/js/cards.js',\n        './src/materialize-css/js/tabs.js',\n        './src/materialize-css/js/dropdown.js',\n        './src/materialize-css/js/toasts.js',\n        './src/materialize-css/js/modal.js',\n        './src/materialize-css/js/select.js',\n        './src/materialize-css/js/forms.js',\n        './src/materialize-css/js/range.js',\n        './src/materialize-css/js/collapsible.js',\n        './src/materialize-css/js/chips.js',\n        './src/materialize-css/js/datepicker.js',\n        './src/materialize-css/js/autocomplete.js',\n        './src/materialize-css/js/timepicker.js',\n        './src/materialize-css/js/tooltip.js',\n        './src/materialize-css/js/autocomplete.js',\n        './src/colorpicker/js/materialize-colorpicker.js'\n    ])\n    .pipe(sourcemaps.init())\n    .pipe(concat('materialize.js'))\n    .pipe(babel({\n        plugins: [\n            '@babel/plugin-transform-arrow-functions',\n            '@babel/plugin-transform-block-scoping',\n            '@babel/plugin-transform-classes',\n            '@babel/plugin-transform-template-literals'\n        ]\n    }))\n    .pipe(uglify())\n    .pipe(sourcemaps.write('.'))\n    .pipe(gulp.dest('./www/lib/js'));\n});\n\ngulp.task('configCSS', () => {\n    return gulp.src([\n        './src/lib/css/iob/selectID.less',\n        './src/less/adapter.less',\n        './src/less/materializeCorrect.less'\n    ])\n        .pipe(sourcemaps.init())\n        .pipe(less({\n            paths: [ ]\n        }))\n        .pipe(concat('adapter.css'))\n        .pipe(cleanCSS({compatibility: 'ie8'}))\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/css'));\n});\n\ngulp.task('iobCSS', () => {\n    return gulp.src(['./src/lib/css/iob/*.less'])\n        .pipe(sourcemaps.init())\n        .pipe(less({\n            paths: [ ]\n        }))\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/lib/css/iob'));\n});\n\n// for older selectID\ngulp.task('adminCSS', () => {\n    return gulp.src(['./src/less/admin.less'])\n        .pipe(sourcemaps.init())\n        .pipe(less({\n            paths: [ ]\n        }))\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/css/'));\n});\n\ngulp.task('treeTableCSS', () => {\n    return gulp.src(['./src/lib/css/jquery.treetable.theme.less'])\n        .pipe(sourcemaps.init())\n        .pipe(less({\n            paths: [ ]\n        }))\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/lib/css'));\n});\n\ngulp.task('fancyTreeJS', () => {\n    return gulp.src([\n        './src/lib/js/jquery.fancytree-all.js'\n    ])\n        .pipe(sourcemaps.init())\n        .pipe(concat('jquery.fancytree-all.min.js'))\n        .pipe(uglify())\n        .on('error', function (err) {\n            log.error(colors.red('[Error] ') + err.toString());\n        })\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/lib/js'));\n});\n\ngulp.task('appJS', () => {\n    return gulp.src([\n        './src/js/*.js',\n        '!./src/js/adapter-settings.js'\n    ])\n        .pipe(sourcemaps.init())\n        .pipe(concat('app.js'))\n        .pipe(uglify())\n        .on('error', function (err) {\n            log.error(colors.red('[Error] ') + err.toString());\n        })\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/js'));\n});\n\ngulp.task('appHTML', () => {\n    return gulp.src([\n        './src/indexStart.html',\n        './src/admin*.html',\n        './src/indexEnd.html'\n    ])\n        .pipe(sourcemaps.init())\n        .pipe(concat('index.html'))\n        .pipe(htmlmin({collapseWhitespace: true, removeComments: true}))\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/'));\n});\n\ngulp.task('appCSS', () => {\n    return gulp.src([\n        './src/less/*.less',\n        './src/colorpicker/less/*.less',\n        '!./src/less/adapter.less'\n    ])\n        .pipe(sourcemaps.init())\n        .pipe(less({\n            paths: [ ]\n        }))\n        .pipe(concat('app.css'))\n        .pipe(cleanCSS({compatibility: 'ie8'}))\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/css'));\n});\n\ngulp.task('vendorJS', () => {\n    return gulp.src([\n        './src/lib/js/jquery-3.2.1.min.js',\n        './src/lib/js/jquery-migrate-3.0.1.js',\n        './src/lib/js/jquery-ui.min.js',\n        './src/lib/js/colResizable-1.6.js',\n        './src/lib/js/jquery.multiselect-1.13.min.js',\n        './src/lib/js/semver.min.js',\n        './src/lib/js/ace-1.2.0/ace.js',\n        './src/lib/js/loStorage.js',\n        './src/lib/js/translate.js',\n        './src/lib/js/jquery.fancytree-all.js',\n        './src/lib/js/jquery.treetable.js',\n        './src/lib/js/jquery.ui.touch-punch.min.js',\n        './src/lib/js/selectID.js',\n        './src/lib/js/cron/jquery.cron.locale.js',\n        './src/lib/js/cron/jquery.cron.words.js',\n        './src/lib/js/cron/jquery.cron.js',\n        './src/lib/js/cron/cron2text.js',\n        './src/lib/js/showdown.min.js'\n    ])\n        .pipe(sourcemaps.init())\n        .pipe(concat('vendor.js'))\n        .pipe(uglify())\n        .on('error', function (err) {\n            log.error(colors.red('[Error] ') + err.toString());\n        })\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/lib/js'));\n});\n\ngulp.task('colorpick.min', () => {\n    return gulp.src([\n        './src/lib/js/colResizable-1.6.js'\n    ])\n        .pipe(sourcemaps.init())\n        .pipe(concat('colResizable-1.6.min.js'))\n        .pipe(uglify())\n        .on('error', function (err) {\n            log.error(colors.red('[Error] ') + err.toString());\n        })\n        .pipe(sourcemaps.write('.'))\n        .pipe(gulp.dest('./www/lib/js'));\n});\n\ngulp.task('appCopy', gulp.series('colorpick.min', () => {\n    return gulp.src([\n        './src/**/*.*',\n        '!./src/i18n/**/*',\n        '!./src/*.html',\n        '!./src/lib/js/jquery.migrate-3.0.1.js',\n        '!./src/lib/js/jquery.fancytree-all.js',\n        '!./src/lib/js/colResizable-1.6.js',\n        '!./src/**/*.less',\n        '!./src/js/**/admin*.js',\n        '!./src/js/**/words.js',\n        '!./src/materialize-css/**/*',\n        '!./src/colorpicker/**/*'\n    ])\n    .pipe(gulp.dest('./www'));\n    })\n);\n\ngulp.task('colorpickerCopy', () => {\n    return gulp.src([\n        './src/colorpicker/**/*.png'\n    ])\n        .pipe(gulp.dest('./www'));\n});\ngulp.task('aceCopy', () => {\n    return gulp.src([\n        './src/lib/js/ace-1.2.0/mode-json.js',\n        './src/lib/js/ace-1.2.0/worker-json.js'\n    ],  {base: './src/lib/js/ace-1.2.0/'})\n    .pipe(gulp.dest('./www'));\n});\ngulp.task('copy', gulp.parallel('appCopy', 'aceCopy', 'colorpickerCopy'));\n\ngulp.task('watch', () => {\n    gulp.watch('./src/css/*.less', ['lessApp']);\n    gulp.watch('./src/lib/css/iob/*.less', ['lessApp']);\n    gulp.watch(['./src/materialize-css/sass/**/*.scss'], ['sassMaterialize']);\n    gulp.watch(['./src/js/*.js'], ['compressApp']);\n});\n\ngulp.task('beta', done => {\n    var ioPack = require('./io-package.json');\n    var pack = require('./package.json');\n    ioPack.common.name = 'admin-beta';\n    ioPack.common.title = 'Admin Beta';\n    ioPack.native.port = 9081;\n    fs.writeFileSync('./io-package.json', JSON.stringify(ioPack, null, 2));\n    pack.name = 'iobroker.admin-beta';\n    fs.writeFileSync('./package.json', JSON.stringify(pack, null, 2));\n    done();\n});\n\ngulp.task('1_words',  gulp.parallel('www (json => words.js)', 'admin (json => words.js)'));\ngulp.task('2_css',    gulp.parallel('iobCSS', 'adminCSS', 'appCSS', 'treeTableCSS', 'configCSS', 'materializeCSS'));\ngulp.task('3_js',     gulp.parallel('vendorJS', 'materializeJS', 'appJS', 'fancyTreeJS')); //compressApp is last, to give the time for 1_words to be finshed. Because words.js is used in app.js\ngulp.task('4_static', gulp.parallel('appHTML', 'aceCopy', 'colorpickerCopy', 'appCopy'));\n\ngulp.task('default', gulp.series(\n    '1_words',\n    '2_css',\n    '3_js',\n    '4_static'));\n", "{\n  \"common\": {\n    \"name\": \"admin\",\n    \"title\": \"Admin\",\n    \"version\": \"3.6.8\",\n    \"news\": {\n      \"3.6.7\": {\n        \"en\": \"Add Node.JS version check to popup messages\",\n        \"de\": \"Node.JS-Versionspr\u00fcfung zu Popup-Nachrichten hinzuf\u00fcgen\",\n        \"ru\": \"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0443 \u0432\u0435\u0440\u0441\u0438\u0438 Node.JS \u0432\u043e \u0432\u0441\u043f\u043b\u044b\u0432\u0430\u044e\u0449\u0438\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\",\n        \"pt\": \"Adicione a verifica\u00e7\u00e3o da vers\u00e3o do Node.JS \u00e0s mensagens pop-up\",\n        \"nl\": \"Voeg Node.JS versiecontrole toe aan pop-upberichten\",\n        \"fr\": \"Ajouter la v\u00e9rification de la version de Node.JS aux messages contextuels\",\n        \"it\": \"Aggiungi il controllo versione Node.JS ai messaggi popup\",\n        \"es\": \"Agregar verificaci\u00f3n de versi\u00f3n de Node.JS a mensajes emergentes\",\n        \"pl\": \"Dodaj sprawdzanie wersji Node.JS do wyskakuj\u0105cych wiadomo\u015bci\",\n        \"zh-cn\": \"\u5c06Node.JS\u7248\u672c\u68c0\u67e5\u6dfb\u52a0\u5230\u5f39\u51fa\u6d88\u606f\"\n      },\n      \"3.6.7\": {\n        \"en\": \"Add Node.JS version check to popup messages\",\n        \"de\": \"Node.JS-Versionspr\u00fcfung zu Popup-Nachrichten hinzuf\u00fcgen\",\n        \"ru\": \"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0443 \u0432\u0435\u0440\u0441\u0438\u0438 Node.JS \u0432\u043e \u0432\u0441\u043f\u043b\u044b\u0432\u0430\u044e\u0449\u0438\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\",\n        \"pt\": \"Adicione a verifica\u00e7\u00e3o da vers\u00e3o do Node.JS \u00e0s mensagens pop-up\",\n        \"nl\": \"Voeg Node.JS versiecontrole toe aan pop-upberichten\",\n        \"fr\": \"Ajouter la v\u00e9rification de la version de Node.JS aux messages contextuels\",\n        \"it\": \"Aggiungi il controllo versione Node.JS ai messaggi popup\",\n        \"es\": \"Agregar verificaci\u00f3n de versi\u00f3n de Node.JS a mensajes emergentes\",\n        \"pl\": \"Dodaj sprawdzanie wersji Node.JS do wyskakuj\u0105cych wiadomo\u015bci\",\n        \"zh-cn\": \"\u5c06Node.JS\u7248\u672c\u68c0\u67e5\u6dfb\u52a0\u5230\u5f39\u51fa\u6d88\u606f\"\n      },\"3.6.6\": {\n        \"en\": \"update some words translation\",\n        \"de\": \"Aktualisieren Sie einige W\u00f6rter \u00dcbersetzung\",\n        \"ru\": \"\u043e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u043f\u0435\u0440\u0435\u0432\u043e\u0434 \u043d\u0435\u043a\u043e\u0442\u043e\u0440\u044b\u0445 \u0441\u043b\u043e\u0432\",\n        \"pt\": \"atualizar algumas palavras tradu\u00e7\u00e3o\",\n        \"nl\": \"update enkele woorden vertaling\",\n        \"fr\": \"mettre \u00e0 jour la traduction de quelques mots\",\n        \"it\": \"aggiorna la traduzione di alcune parole\",\n        \"es\": \"actualizar algunas palabras traducci\u00f3n\",\n        \"pl\": \"zaktualizuj t\u0142umaczenie niekt\u00f3rych s\u0142\u00f3w\",\n        \"zh-cn\": \"\u66f4\u65b0\u4e00\u4e9b\u5355\u8bcd\u7ffb\u8bd1\"\n      },\n      \"3.6.5\": {\n        \"en\": \"Fix anoying popups from info adapter\",\n        \"de\": \"Beheben Sie \u00e4rgerliche Popups vom Info-Adapter\",\n        \"ru\": \"\u0418\u0441\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u0432\u0441\u043f\u043b\u044b\u0432\u0430\u044e\u0449\u0438\u0445 \u0432\u0441\u043f\u043b\u044b\u0432\u0430\u044e\u0449\u0438\u0445 \u043e\u043a\u043e\u043d \u0438\u0437 \u0430\u0434\u0430\u043f\u0442\u0435\u0440\u0430\",\n        \"pt\": \"Corrija pop-ups irritantes do adaptador de informa\u00e7\u00f5es\",\n        \"nl\": \"Bevestig vervelende pop-ups van de info-adapter\",\n        \"fr\": \"Corrige les popups ennuyeux depuis l'adaptateur info\",\n        \"it\": \"Correggi i popup di anoying dall'adattatore informazioni\",\n        \"es\": \"Arreglar ventanas emergentes molestas desde el adaptador de informaci\u00f3n\",\n        \"pl\": \"Napraw wyskakuj\u0105ce okienka z adaptera informacyjnego\",\n        \"zh-cn\": \"\u4ece\u4fe1\u606f\u9002\u914d\u5668\u4fee\u590d\u607c\u4eba\u7684\u5f39\u51fa\u7a97\u53e3\"\n      },\n      \"3.6.4\": {\n        \"en\": \"Update nodejs recommendation message and check to recommend nodejs 10\",\n        \"ru\": \"\u041e\u0431\u043d\u043e\u0432\u0438\u0442\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435 \u0441 \u0440\u0435\u043a\u043e\u043c\u0435\u043d\u0434\u0430\u0446\u0438\u0435\u0439 nodejs \u0438 \u043f\u0440\u043e\u0432\u0435\u0440\u044c\u0442\u0435, \u0447\u0442\u043e\u0431\u044b \u0440\u0435\u043a\u043e\u043c\u0435\u043d\u0434\u043e\u0432\u0430\u0442\u044c nodejs 10\",\n        \"de\": \"Aktualisieren der Empfehlungsnachricht von nodejs, um nodejs 10 zu empfehlen\",\n        \"fr\": \"Mettre \u00e0 jour le message de recommandation nodejs et v\u00e9rifier pour recommander nodejs 10\",\n        \"nl\": \"Update nodejs aanbevelingsbericht en controleer om nodejs 10 aan te bevelen\",\n        \"it\": \"Aggiorna il messaggio di raccomandazione nodejs e verifica per raccomandare nodejs 10\",\n        \"pl\": \"Zaktualizuj wiadomo\u015b\u0107 rekomendacji nodejs anc sprawd\u017a, aby poleci\u0107 nodejs 10\",\n        \"es\": \"Actualice el mensaje de recomendaci\u00f3n de nodejs y revise para recomendar nodejs 10\",\n        \"pt\": \"Atualize a mensagem de recomenda\u00e7\u00e3o do nodejs e cheque para recomendar o nodejs 10\",\n        \"zh-cn\": \"\u66f4\u65b0nodejs\u63a8\u8350\u6d88\u606f\u548c\u68c0\u67e5\u4ee5\u63a8\u8350nodejs 10\"\n      },\n      \"3.6.3\": {\n        \"en\": \"Added deleteFile internal function\",\n        \"de\": \"Interne Funktion deleteFile hinzugef\u00fcgt\",\n        \"ru\": \"\u0414\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u0430 \u200b\u200b\u0432\u043d\u0443\u0442\u0440\u0435\u043d\u043d\u044f\u044f \u0444\u0443\u043d\u043a\u0446\u0438\u044f deleteFile\",\n        \"pt\": \"Adicionado fun\u00e7\u00e3o interna deleteFile\",\n        \"nl\": \"De interne functie deleteFile toegevoegd\",\n        \"fr\": \"Ajout de la fonction interne deleteFile\",\n        \"it\": \"Aggiunta la funzione interna deleteFile\",\n        \"es\": \"Agregada funci\u00f3n interna deleteFile\",\n        \"pl\": \"Dodano funkcj\u0119 wewn\u0119trzn\u0105 deleteFile\",\n        \"zh-cn\": \"\u6dfb\u52a0\u4e86deleteFile\u5185\u90e8\u51fd\u6570\"\n      },\n      \"3.6.2\": {\n        \"en\": \"Added onSave handler for custom dialogs\",\n        \"de\": \"OnSave-Handler f\u00fcr benutzerdefinierte Dialoge hinzugef\u00fcgt\",\n        \"ru\": \"\u0414\u043e\u0431\u0430\u0432\u043b\u0435\u043d \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0447\u0438\u043a onSave \u0434\u043b\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c\u0441\u043a\u0438\u0445 \u0434\u0438\u0430\u043b\u043e\u0433\u043e\u0432\",\n        \"pt\": \"Adicionado manipulador onSave para di\u00e1logos personalizados\",\n        \"nl\": \"Toegevoegd onSave handler voor aangepaste dialogen\",\n        \"fr\": \"Ajout du gestionnaire onSave pour les bo\u00eetes de dialogue personnalis\u00e9es\",\n        \"it\": \"Aggiunto il gestore onSave per le finestre di dialogo personalizzate\",\n        \"es\": \"A\u00f1adido onSave handler para di\u00e1logos personalizados\",\n        \"pl\": \"Dodano obs\u0142ug\u0119 onSave dla niestandardowych okien dialogowych\",\n        \"zh-cn\": \"\u4e3a\u81ea\u5b9a\u4e49\u5bf9\u8bdd\u6846\u6dfb\u52a0\u4e86onSave\u5904\u7406\u7a0b\u5e8f\"\n      },\n      \"3.6.1\": {\n        \"en\": \"Info adpater integration\",\n        \"de\": \"Integration des Informationsadapters\",\n        \"ru\": \"\u0418\u043d\u0442\u0435\u0433\u0440\u0430\u0446\u0438\u044f \u0441 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u043e\u043d\u043d\u044b\u043c \u0430\u0434\u0430\u043f\u0442\u0435\u0440\u043e\u043c\",\n        \"pt\": \"Integra\u00e7\u00e3o do adaptador de informa\u00e7\u00f5es\",\n        \"nl\": \"Integratie van infodapter\",\n        \"fr\": \"Int\u00e9gration de l'adaptateur d'informations\",\n        \"it\": \"Integrazione dell'adattatore di informazioni\",\n        \"es\": \"Integraci\u00f3n del adaptador de informaci\u00f3n\",\n        \"pl\": \"Integracja adaptera informacyjnego\",\n        \"zh-cn\": \"\u4fe1\u606f\u9002\u914d\u5668\u96c6\u6210\"\n      },\n      \"3.6.0\": {\n        \"en\": \"Added Chinese translations\\nNew informative states added about updates\",\n        \"de\": \"Chinesische \u00dcbersetzungen hinzugef\u00fcgt\\nNeue Informationsst\u00e4nde zu Updates hinzugef\u00fcgt\",\n        \"ru\": \"\u0414\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u044b \u043a\u0438\u0442\u0430\u0439\u0441\u043a\u0438\u0435 \u043f\u0435\u0440\u0435\u0432\u043e\u0434\u044b\\n\u0414\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u044b \u043d\u043e\u0432\u044b\u0435 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u043e\u043d\u043d\u044b\u0435 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u044f \u043e\u0431 \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u044f\u0445\",\n        \"pt\": \"Adicionado tradu\u00e7\u00f5es chinesas\\nNovos estados informativos adicionados sobre atualiza\u00e7\u00f5es\",\n        \"nl\": \"Chinese vertalingen toegevoegd\\nNieuwe informatieve staten toegevoegd over updates\",\n        \"fr\": \"Ajout de traductions chinoises\\nNouveaux \u00e9tats informatifs ajout\u00e9s \u00e0 propos des mises \u00e0 jour\",\n        \"it\": \"Aggiunte traduzioni in cinese\\nNuovi stati informativi aggiunti sugli aggiornamenti\",\n        \"es\": \"Traducciones en chino a\u00f1adido\\nNuevos estados informativos a\u00f1adidos sobre actualizaciones.\",\n        \"pl\": \"Dodano chi\u0144skie t\u0142umaczenia\\nDodano nowe informacje informacyjne o aktualizacjach\",\n        \"zh-cn\": \"\u589e\u52a0\u4e86\u4e2d\u6587\u7ffb\u8bd1\\n\u65b0\u7684\u4fe1\u606f\u72b6\u6001\u589e\u52a0\u4e86\u66f4\u65b0\"\n      },\n      \"3.5.10\": {\n        \"en\": \"Too many debug outputs were disabled\",\n        \"de\": \"Zu viele Debug-Ausgaben wurden deaktiviert\",\n        \"ru\": \"\u041e\u0442\u043a\u043b\u044e\u0447\u0435\u043d\u0430 \u043e\u0442\u043b\u0430\u0434\u043e\u0447\u043d\u0430\u044f \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044f\",\n        \"pt\": \"Muitas sa\u00eddas de depura\u00e7\u00e3o foram desativadas\",\n        \"nl\": \"Te veel foutopsporingsuitgangen waren uitgeschakeld\",\n        \"fr\": \"Trop de sorties de d\u00e9bogage ont \u00e9t\u00e9 d\u00e9sactiv\u00e9es\",\n        \"it\": \"Troppe uscite di debug sono state disabilitate\",\n        \"es\": \"Demasiadas salidas de depuraci\u00f3n fueron deshabilitadas\",\n        \"pl\": \"Zbyt wiele wynik\u00f3w debugowania zosta\u0142o wy\u0142\u0105czonych\"\n      },\n      \"3.5.0\": {\n        \"en\": \"Editing of enums was changed\\nLogo was updated\\nThe function icons were added\",\n        \"de\": \"Die Bearbeitung der Enums wurde ge\u00e4ndert\\nDas Logo wurde aktualisiert\\nDie Funktionssymbole wurden hinzugef\u00fcgt\",\n        \"ru\": \"\u0418\u0437\u043c\u0435\u043d\u0435\u043d\u043e \u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u043f\u0435\u0440\u0435\u0447\u0438\u0441\u043b\u0435\u043d\u0438\u0439\\n\u041b\u043e\u0433\u043e\u0442\u0438\u043f \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\\n\u0417\u043d\u0430\u0447\u043a\u0438 \u0444\u0443\u043d\u043a\u0446\u0438\u0439 \u0434\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u044b\",\n        \"pt\": \"Edi\u00e7\u00e3o de enums foi alterada\\nLogo foi atualizado\\nOs \u00edcones de fun\u00e7\u00e3o foram adicionados\",\n        \"nl\": \"Het bewerken van de enums is gewijzigd\\nLogo is bijgewerkt\\nDe functiepictogrammen zijn toegevoegd\",\n        \"fr\": \"L'\u00e9dition des \u00e9num\u00e9rations a \u00e9t\u00e9 modifi\u00e9e\\nLe logo a \u00e9t\u00e9 mis \u00e0 jour\\nLes ic\u00f4nes de fonctions ont \u00e9t\u00e9 ajout\u00e9es\",\n        \"it\": \"La modifica delle enumerazioni \u00e8 stata modificata\\nIl logo \u00e8 stato aggiornato\\nLe icone delle funzioni sono state aggiunte\",\n        \"es\": \"Se modific\u00f3 la edici\u00f3n de enumeraciones\\nLogotipo fue actualizado\\nSe agregaron los \u00edconos de funci\u00f3n\",\n        \"pl\": \"Zmieniono edycj\u0119 wylicze\u0144\\nLogo zosta\u0142o zaktualizowane\\nDodano ikony funkcji\"\n      },\n      \"2.0.11\": {\n        \"en\": \"Configurable event update disable threshold\",\n        \"de\": \"Konfigurierbar Schwellenwert f\u00fcr Ereignisses\",\n        \"ru\": \"\u041d\u0430\u0441\u0442\u0440\u0430\u0438\u0432\u0430\u0435\u043c\u043e\u0435 \u043f\u043e\u0440\u043e\u0433\u043e\u0432\u043e\u0435 \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 \u043e\u0442\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u044f \u0441\u043e\u0431\u044b\u0442\u0438\u0439\",\n        \"pt\": \"Limite configur\u00e1vel para o n\u00famero de eventos\"\n      }\n    },\n    \"desc\": {\n      \"en\": \"The configuration of ioBroker via Web-Interface\",\n      \"de\": \"Die Konfiguration von ioBroker \u00fcber das Web-Interface\",\n      \"ru\": \"\u041a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u044f ioBroker \u0447\u0435\u0440\u0435\u0437 \u0432\u0435\u0431-\u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\",\n      \"pt\": \"A configura\u00e7\u00e3o do ioBroker via Web-Interface\",\n      \"fr\": \"La configuration de ioBroker via Web-Interface\",\n      \"nl\": \"De configuratie van ioBroker via de webinterface\",\n      \"it\": \"La configurazione di ioBroker tramite interfaccia Web\",\n      \"zh-cn\": \"\u914d\u7f6eioBroker\u7684Web\u754c\u9762\"\n    },\n    \"docs\": {\n      \"en\": \"docs/en/admin.md\",\n      \"ru\": \"docs/ru/admin.md\",\n      \"de\": [\n        \"docs/de/admin.md\",\n        \"docs/de/admin/tab-adapters.md\",\n        \"docs/de/admin/tab-instances.md\",\n        \"docs/de/admin/tab-objects.md\",\n        \"docs/de/admin/tab-states.md\",\n        \"docs/de/admin/tab-groups.md\",\n        \"docs/de/admin/tab-users.md\",\n        \"docs/de/admin/tab-events.md\",\n        \"docs/de/admin/tab-hosts.md\",\n        \"docs/de/admin/tab-enums.md\",\n        \"docs/de/admin/tab-log.md\",\n        \"docs/de/admin/tab-system.md\"\n      ],\n      \"pt\": \"docs/pt/admin.md\",\n      \"nl\": \"docs/nl/admin.md\",\n      \"es\": \"docs/es/admin.md\",\n      \"fr\": \"docs/fr/admin.md\",\n      \"it\": \"docs/it/admin.md\",\n      \"pl\": \"docs/pl/admin.md\",\n      \"zh-cn\": \"docs/zh-cn/admin.md\"\n    },\n    \"materialize\": true,\n    \"mode\": \"daemon\",\n    \"platform\": \"Javascript/Node.js\",\n    \"loglevel\": \"info\",\n    \"icon\": \"admin.png\",\n    \"messagebox\": true,\n    \"enabled\": true,\n    \"extIcon\": \"https://raw.githubusercontent.com/ioBroker/ioBroker.admin/master/admin/admin.png\",\n    \"keywords\": [\n      \"setup\",\n      \"config\",\n      \"update\",\n      \"upgrade\",\n      \"system\",\n      \"konfiguration\",\n      \"administration\",\n      \"einrichtung\",\n      \"wartung\"\n    ],\n    \"compact\": true,\n    \"readme\": \"https://github.com/ioBroker/ioBroker.admin/blob/master/README.md\",\n    \"authors\": [\n      \"bluefox <bluefox@ccu.io>\",\n      \"hobbyquaker <hq@ccu.io>\"\n    ],\n    \"dependencies\": [\n      {\n        \"js-controller\": \">=1.2.0\"\n      }\n    ],\n    \"type\": \"general\",\n    \"license\": \"MIT\",\n    \"logTransporter\": true,\n    \"stopBeforeUpdate\": true,\n    \"wwwDontUpload\": true,\n    \"nogit\": true,\n    \"welcomeScreenPro\": {\n      \"link\": \"admin/index.html\",\n      \"name\": \"Admin\",\n      \"img\": \"admin/img/admin.png\",\n      \"color\": \"pink\",\n      \"order\": 5,\n      \"localLink\": true\n    },\n    \"localLink\": \"%protocol%://%ip%:%port%\"\n  },\n  \"native\": {\n    \"port\": 8081,\n    \"auth\": false,\n    \"secure\": false,\n    \"bind\": \"0.0.0.0\",\n    \"cache\": false,\n\n    \"certPublic\": \"\",\n    \"certPrivate\": \"\",\n    \"certChained\": \"\",\n\n    \"ttl\": 3600,\n    \"defaultUser\": \"admin\",\n    \"tmpPath\": \"/tmp\",\n    \"tmpPathAllow\": false,\n    \"thresholdValue\": 200,\n\n    \"leEnabled\": false,\n    \"leUpdate\": false,\n    \"leCheckPort\": 80,\n\n    \"loginBackgroundColor\": \"\",\n    \"loginBackgroundImage\": false,\n    \"loginHideLogo\": false,\n    \"loginMotto\": \"\"\n  },\n  \"objects\": [],\n  \"instanceObjects\": [\n    {\n      \"_id\": \"info\",\n      \"type\": \"channel\",\n      \"common\": {\n        \"name\": \"Information\"\n      },\n      \"native\": {}\n    },\n    {\n      \"_id\": \"\",\n      \"type\": \"meta\",\n      \"common\": {\n        \"name\": \"user files and images for background image\",\n        \"type\": \"meta.user\"\n      },\n      \"native\": {}\n    },\n    {\n      \"_id\": \"connected\",\n      \"type\": \"state\",\n      \"common\": {\n        \"name\": \"Info about connected socket clients\",\n        \"type\": \"string\",\n        \"read\":  true,\n        \"write\": false,\n        \"role\":  \"text\"\n      }\n    }\n  ]\n}\n", "/* jshint -W097 */\r\n/* jshint strict: false */\r\n/* jslint node: true */\r\n/* jshint -W061 */\r\n'use strict';\r\n\r\nconst socketio = require('socket.io');\r\nconst request  = require('request');\r\nconst path     = require('path');\r\nconst fs       = require('fs');\r\n\r\nfunction IOSocket(server, settings, adapter, objects, store) {\r\n    if (!(this instanceof IOSocket)) {\r\n        return new IOSocket(server, settings, adapter, objects, store);\r\n    }\r\n\r\n    const userKey = 'connect.sid'; // const\r\n    const cmdSessions = {};\r\n    const that = this;\r\n    this.server = null;\r\n    this.subscribes = {};\r\n    let cookieParser;\r\n    let passport;\r\n    let states = {};\r\n\r\n    if (settings.auth) {\r\n        cookieParser = require('cookie-parser');\r\n        passport     = require('passport');\r\n    }\r\n\r\n    const passportSocketIo = require('passport.socketio');\r\n\r\n    // do not send too many state updates\r\n    const eventsThreshold = {\r\n        count: 0,\r\n        timeActivated: 0,\r\n        active: false,\r\n        accidents: 0,\r\n        repeatSeconds: 3,   // how many seconds continuously must be number of events > value\r\n        value: parseInt(settings.thresholdValue, 10) || 200, // how many events allowed in one check interval\r\n        checkInterval: 1000 // duration of one check interval\r\n    };\r\n\r\n    // static information\r\n    const commandsPermissions = {\r\n        getObject:          {type: 'object',    operation: 'read'},\r\n        getObjects:         {type: 'object',    operation: 'list'},\r\n        getObjectView:      {type: 'object',    operation: 'list'},\r\n        setObject:          {type: 'object',    operation: 'write'},\r\n        requireLog:         {type: 'object',    operation: 'write'}, // just mapping to some command\r\n        delObject:          {type: 'object',    operation: 'delete'},\r\n        extendObject:       {type: 'object',    operation: 'write'},\r\n        getHostByIp:        {type: 'object',    operation: 'list'},\r\n        subscribeObjects:   {type: 'object',    operation: 'read'},\r\n        unsubscribeObjects: {type: 'object',    operation: 'read'},\r\n\r\n        getStates:          {type: 'state',     operation: 'list'},\r\n        getState:           {type: 'state',     operation: 'read'},\r\n        setState:           {type: 'state',     operation: 'write'},\r\n        delState:           {type: 'state',     operation: 'delete'},\r\n        createState:        {type: 'state',     operation: 'create'},\r\n        subscribe:          {type: 'state',     operation: 'read'},\r\n        unsubscribe:        {type: 'state',     operation: 'read'},\r\n        getStateHistory:    {type: 'state',     operation: 'read'},\r\n        getVersion:         {type: '',          operation: ''},\r\n\r\n        addUser:            {type: 'users',     operation: 'create'},\r\n        delUser:            {type: 'users',     operation: 'delete'},\r\n        addGroup:           {type: 'users',     operation: 'create'},\r\n        delGroup:           {type: 'users',     operation: 'delete'},\r\n        changePassword:     {type: 'users',     operation: 'write'},\r\n\r\n        httpGet:            {type: 'other',     operation: 'http'},\r\n        cmdExec:            {type: 'other',     operation: 'execute'},\r\n        sendTo:             {type: 'other',     operation: 'sendto'},\r\n        sendToHost:         {type: 'other',     operation: 'sendto'},\r\n        readLogs:           {type: 'other',     operation: 'execute'},\r\n\r\n        readDir:            {type: 'file',      operation: 'list'},\r\n        createFile:         {type: 'file',      operation: 'create'},\r\n        writeFile:          {type: 'file',      operation: 'write'},\r\n        readFile:           {type: 'file',      operation: 'read'},\r\n        deleteFile:         {type: 'file',      operation: 'delete'},\r\n        readFile64:         {type: 'file',      operation: 'read'},\r\n        writeFile64:        {type: 'file',      operation: 'write'},\r\n        unlink:             {type: 'file',      operation: 'delete'},\r\n        rename:             {type: 'file',      operation: 'write'},\r\n        mkdir:              {type: 'file',      operation: 'write'},\r\n        chmodFile:          {type: 'file',      operation: 'write'},\r\n\r\n        authEnabled:        {type: '',          operation: ''},\r\n        disconnect:         {type: '',          operation: ''},\r\n        listPermissions:    {type: '',          operation: ''},\r\n        getUserPermissions: {type: 'object',    operation: 'read'}\r\n    };\r\n\r\n    function addUser(user, pw, options, callback) {\r\n        if (typeof options === 'function') {\r\n            callback = options;\r\n            options = null;\r\n        }\r\n\r\n        if (!user.match(/^[-.A-Za-z\u00fc\u00e4\u00f6\u00df\u00d6\u00c4\u00dc\u0430-\u044f\u0410-\u042f@+$\u00a70-9=?!&# ]+$/)) {\r\n            if (typeof callback === 'function') {\r\n                callback('Invalid characters in the name. Only following special characters are allowed: -@+$\u00a7=?!&# and letters');\r\n            }\r\n            return;\r\n        }\r\n\r\n        adapter.getForeignObject('system.user.' + user, options, function (err, obj) {\r\n            if (obj) {\r\n                if (typeof callback === 'function') {\r\n                    callback('User yet exists');\r\n                }\r\n            } else {\r\n                adapter.setForeignObject('system.user.' + user, {\r\n                    type: 'user',\r\n                    common: {\r\n                        name: user,\r\n                        enabled: true,\r\n                        groups: []\r\n                    }\r\n                }, options, function () {\r\n                    adapter.setPassword(user, pw, callback);\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    function delUser(user, options, callback) {\r\n        adapter.getForeignObject('system.user.' + user, options, function (err, obj) {\r\n            if (err || !obj) {\r\n                if (typeof callback === 'function') {\r\n                    callback('User does not exist');\r\n                }\r\n            } else {\r\n                if (obj.common.dontDelete) {\r\n                    if (typeof callback === 'function') {\r\n                        callback('Cannot delete user, while is system user');\r\n                    }\r\n                } else {\r\n                    adapter.delForeignObject('system.user.' + user, options, function (err) {\r\n                        // Remove this user from all groups in web client\r\n                        if (typeof callback === 'function') {\r\n                            callback(err);\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    function addGroup(group, desc, acl, options, callback) {\r\n        let name = group;\r\n        if (typeof acl === 'function') {\r\n            callback = acl;\r\n            acl = null;\r\n        }\r\n        if (typeof desc === 'function') {\r\n            callback = desc;\r\n            desc = null;\r\n        }\r\n        if (typeof options === 'function') {\r\n            callback = options;\r\n            options = null;\r\n        }\r\n        if (name && name.substring(0, 1) !== name.substring(0, 1).toUpperCase()) {\r\n            name = name.substring(0, 1).toUpperCase() + name.substring(1);\r\n        }\r\n        group = group.substring(0, 1).toLowerCase() + group.substring(1);\r\n\r\n        if (!group.match(/^[-.A-Za-z\u00fc\u00e4\u00f6\u00df\u00d6\u00c4\u00dc\u0430-\u044f\u0410-\u042f@+$\u00a70-9=?!&#_ ]+$/)) {\r\n            if (typeof callback === 'function') {\r\n                callback('Invalid characters in the group name. Only following special characters are allowed: -@+$\u00a7=?!&# and letters');\r\n            }\r\n            return;\r\n        }\r\n\r\n        adapter.getForeignObject('system.group.' + group, options, function (err, obj) {\r\n            if (obj) {\r\n                if (typeof callback === 'function') {\r\n                    callback('Group yet exists');\r\n                }\r\n            } else {\r\n                obj = {\r\n                    _id:  'system.group.' + group,\r\n                    type: 'group',\r\n                    common: {\r\n                        name: name,\r\n                        desc: desc,\r\n                        members: [],\r\n                        acl: acl\r\n                    }\r\n                };\r\n                adapter.setForeignObject('system.group.' + group, obj, options, function (err) {\r\n                    if (typeof callback === 'function') {\r\n                        callback(err, obj);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    function delGroup(group, options, callback) {\r\n        adapter.getForeignObject('system.group.' + group, options, (err, obj) => {\r\n            if (err || !obj) {\r\n                if (typeof callback === 'function') {\r\n                    callback('Group does not exist');\r\n                }\r\n            } else {\r\n                if (obj.common.dontDelete) {\r\n                    if (typeof callback === 'function') {\r\n                        callback('Cannot delete group, while is system group');\r\n                    }\r\n                } else {\r\n                    adapter.delForeignObject('system.group.' + group, options, err =>\r\n                        // Remove this group from all users in web client\r\n                        typeof callback === 'function' && callback(err));\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    // update session ID, but not ofter than 60 seconds\r\n    function updateSession(socket) {\r\n        if (socket._sessionID) {\r\n            const time = (new Date()).getTime();\r\n            if (socket._lastActivity && time - socket._lastActivity > adapter.config.ttl * 1000) {\r\n                socket.emit('reauthenticate');\r\n                return false;\r\n            }\r\n            socket._lastActivity = time;\r\n            if (!socket._sessionTimer) {\r\n                socket._sessionTimer = setTimeout(() => {\r\n                    socket._sessionTimer = null;\r\n                    adapter.getSession(socket._sessionID, obj => {\r\n                        if (obj) {\r\n                            adapter.setSession(socket._sessionID, adapter.config.ttl, obj);\r\n                        } else {\r\n                            socket.emit('reauthenticate');\r\n                        }\r\n                    });\r\n                }, 60000);\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n\r\n    function checkPermissions(socket, command, callback, arg) {\r\n        if (socket._acl.user !== 'system.user.admin') {\r\n            // type: file, object, state, other\r\n            // operation: create, read, write, list, delete, sendto, execute, sendToHost, readLogs\r\n            if (commandsPermissions[command]) {\r\n                // If permission required\r\n                if (commandsPermissions[command].type) {\r\n                    if (socket._acl[commandsPermissions[command].type] &&\r\n                        socket._acl[commandsPermissions[command].type][commandsPermissions[command].operation]) {\r\n                        return true;\r\n                    } else {\r\n                        adapter.log.warn('No permission for \"' + socket._acl.user + '\" to call ' + command + '. Need \"' + commandsPermissions[command].type + '\".\"' + commandsPermissions[command].operation + '\"');\r\n                    }\r\n                } else {\r\n                    return true;\r\n                }\r\n            } else {\r\n                adapter.log.warn('No rule for command: ' + command);\r\n            }\r\n\r\n            if (typeof callback === 'function') {\r\n                callback('permissionError');\r\n            } else {\r\n                if (commandsPermissions[command]) {\r\n                    socket.emit('permissionError', {\r\n                        command: command,\r\n                        type: commandsPermissions[command].type,\r\n                        operation: commandsPermissions[command].operation,\r\n                        arg: arg\r\n                    });\r\n                } else {\r\n                    socket.emit('permissionError', {\r\n                        command: command,\r\n                        arg: arg\r\n                    });\r\n                }\r\n            }\r\n            return false;\r\n        } else {\r\n            return true;\r\n        }\r\n    }\r\n\r\n    function checkObject(id, options, flag) {\r\n        // read rights of object\r\n        if (!objects[id] || !objects[id].common || !objects[id].acl || flag === 'list') {\r\n            return true;\r\n        }\r\n\r\n        if (options.user !== 'system.user.admin' &&\r\n            options.groups.indexOf('system.group.administrator') === -1) {\r\n            if (objects[id].acl.owner !== options.user) {\r\n                // Check if the user is in the group\r\n                if (options.groups.indexOf(objects[id].acl.ownerGroup) !== -1) {\r\n                    // Check group rights\r\n                    if (!(objects[id].acl.object & (flag << 4))) {\r\n                        return false\r\n                    }\r\n                } else {\r\n                    // everybody\r\n                    if (!(objects[id].acl.object & flag)) {\r\n                        return false\r\n                    }\r\n                }\r\n            } else {\r\n                // Check group rights\r\n                if (!(objects[id].acl.object & (flag << 8))) {\r\n                    return false\r\n                }\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n\r\n    function getAllObjects(socket, callback) {\r\n        if (updateSession(socket) && checkPermissions(socket, 'getObjects', callback)) {\r\n            if (socket._acl &&\r\n                socket._acl.user !== 'system.user.admin' &&\r\n                socket._acl.groups.indexOf('system.group.administrator') === -1) {\r\n                const result = {};\r\n                for (const ob in objects) {\r\n                    if (objects.hasOwnProperty(ob) && checkObject(ob, socket._acl, 4 /* 'read' */)) {\r\n                        result[ob] = objects[ob];\r\n                    }\r\n                }\r\n                callback(null, result);\r\n            } else {\r\n                if (typeof callback === 'function') {\r\n                    callback(null, objects);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    function pattern2RegEx(pattern) {\r\n        if (!pattern) {\r\n            return null;\r\n        }\r\n        if (pattern !== '*') {\r\n            if (pattern[0] === '*' && pattern[pattern.length - 1] !== '*') pattern += '$';\r\n            if (pattern[0] !== '*' && pattern[pattern.length - 1] === '*') pattern = '^' + pattern;\r\n        }\r\n        pattern = pattern.replace(/\\./g, '\\\\.');\r\n        pattern = pattern.replace(/\\*/g, '.*');\r\n        pattern = pattern.replace(/\\[/g, '\\\\[');\r\n        pattern = pattern.replace(/]/g, '\\\\]');\r\n        pattern = pattern.replace(/\\(/g, '\\\\(');\r\n        pattern = pattern.replace(/\\)/g, '\\\\)');\r\n        return pattern;\r\n    }\r\n\r\n    this.subscribe = function (socket, type, pattern) {\r\n        //console.log((socket._name || socket.id) + ' subscribe ' + pattern);\r\n        if (socket) {\r\n            socket._subscribe = socket._subscribe || {};\r\n        }\r\n        if (!this.subscribes[type]) this.subscribes[type] = {};\r\n\r\n        let s;\r\n        if (socket) {\r\n            s = socket._subscribe[type] = socket._subscribe[type] || [];\r\n            for (let i = 0; i < s.length; i++) {\r\n                if (s[i].pattern === pattern) return;\r\n            }\r\n        }\r\n\r\n        let p = pattern2RegEx(pattern);\r\n        if (p === null) {\r\n            adapter.log.warn('Empty pattern!');\r\n            return;\r\n        }\r\n        if (socket) {\r\n            s.push({pattern: pattern, regex: new RegExp(p)});\r\n        }\r\n\r\n        if (this.subscribes[type][pattern] === undefined) {\r\n            this.subscribes[type][pattern] = 1;\r\n            if (type === 'stateChange') {\r\n                adapter.log.debug('Subscribe STATES: ' + pattern);\r\n                adapter.subscribeForeignStates(pattern);\r\n            } else if (type === 'objectChange') {\r\n                adapter.log.debug('Subscribe OBJECTS: ' + pattern);\r\n                adapter.subscribeForeignObjects && adapter.subscribeForeignObjects(pattern);\r\n            } else if (type === 'log') {\r\n                adapter.log.debug('Subscribe LOGS');\r\n                adapter.requireLog && adapter.requireLog(true);\r\n            }\r\n        } else {\r\n            this.subscribes[type][pattern]++;\r\n        }\r\n    };\r\n\r\n    function showSubscribes(socket, type) {\r\n        if (socket && socket._subscribe) {\r\n            const s = socket._subscribe[type] || [];\r\n            const ids = [];\r\n            for (let i = 0; i < s.length; i++) {\r\n                ids.push(s[i].pattern);\r\n            }\r\n            adapter.log.debug('Subscribes: ' + ids.join(', '));\r\n        } else {\r\n            adapter.log.debug('Subscribes: no subscribes');\r\n        }\r\n    }\r\n\r\n    function updateConnectedInfo() {\r\n        if (that.infoTimeout) {\r\n            clearTimeout(that.infoTimeout);\r\n            that.infoTimeout = null;\r\n        }\r\n        if (that.server.sockets) {\r\n            let text = '';\r\n            let cnt = 0;\r\n            if (that.server) {\r\n                let clients = that.server.sockets.connected;\r\n\r\n                for (let i in clients) {\r\n                    if (clients.hasOwnProperty(i)) {\r\n                        text += (text ? ', ' : '') + (clients[i]._name || 'noname');\r\n                        cnt++;\r\n                    }\r\n                }\r\n            }\r\n            text = '[' + cnt + ']' + text;\r\n            adapter.setState('connected', text, true);\r\n        }\r\n    }\r\n\r\n    this.unsubscribe = function (socket, type, pattern) {\r\n        //console.log((socket._name || socket.id) + ' unsubscribe ' + pattern);\r\n        this.subscribes[type] = this.subscribes[type] || {};\r\n\r\n        if (socket) {\r\n            if (!socket._subscribe || !socket._subscribe[type]) {\r\n                return;\r\n            }\r\n\r\n            for (let i = socket._subscribe[type].length - 1; i >= 0; i--) {\r\n                if (socket._subscribe[type][i].pattern === pattern) {\r\n\r\n                    // Remove pattern from global list\r\n                    if (this.subscribes[type][pattern] !== undefined) {\r\n                        this.subscribes[type][pattern]--;\r\n                        if (this.subscribes[type][pattern] <= 0) {\r\n                            if (type === 'stateChange') {\r\n                                adapter.log.debug('Unsubscribe STATES: ' + pattern);\r\n                                //console.log((socket._name || socket.id) + ' unsubscribeForeignStates ' + pattern);\r\n                                adapter.unsubscribeForeignStates(pattern);\r\n                            } else if (type === 'objectChange') {\r\n                                adapter.log.debug('Unsubscribe OBJECTS: ' + pattern);\r\n                                //console.log((socket._name || socket.id) + ' unsubscribeForeignObjects ' + pattern);\r\n                                if (adapter.unsubscribeForeignObjects) adapter.unsubscribeForeignObjects(pattern);\r\n                            } else if (type === 'log') {\r\n                                //console.log((socket._name || socket.id) + ' requireLog false');\r\n                                adapter.log.debug('Unsubscribe LOGS');\r\n                                if (adapter.requireLog) adapter.requireLog(false);\r\n                            }\r\n                            delete this.subscribes[type][pattern];\r\n                        }\r\n                    }\r\n\r\n                    delete socket._subscribe[type][i];\r\n                    socket._subscribe[type].splice(i, 1);\r\n                    return;\r\n                }\r\n            }\r\n        } else {\r\n            // Remove pattern from global list\r\n            if (this.subscribes[type][pattern] !== undefined) {\r\n                this.subscribes[type][pattern]--;\r\n                if (this.subscribes[type][pattern] <= 0) {\r\n                    if (type === 'stateChange') {\r\n                        adapter.log.debug('Unsubscribe STATES: ' + pattern);\r\n                        adapter.unsubscribeForeignStates(pattern);\r\n                    } else if (type === 'objectChange') {\r\n                        adapter.log.debug('Unsubscribe OBJECTS: ' + pattern);\r\n                        if (adapter.unsubscribeForeignObjects) adapter.unsubscribeForeignObjects(pattern);\r\n                    } else if (type === 'log') {\r\n                        adapter.log.debug('Unsubscribe LOGS');\r\n                        if (adapter.requireLog) adapter.requireLog(false);\r\n                    }\r\n                    delete this.subscribes[type][pattern];\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    this.unsubscribeAll = function () {\r\n        if (that.server && that.server.sockets) {\r\n            for (const s in that.server.sockets) {\r\n                if (that.server.sockets.hasOwnProperty(s)) {\r\n                    this.unsubscribe(s, 'stateChange');\r\n                    this.unsubscribe(s, 'objectChange');\r\n                    this.unsubscribe(s, 'log');\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    function unsubscribeSocket(socket, type) {\r\n        if (!socket._subscribe || !socket._subscribe[type]) return;\r\n\r\n        for (let i = 0; i < socket._subscribe[type].length; i++) {\r\n            const pattern = socket._subscribe[type][i].pattern;\r\n            if (that.subscribes[type][pattern] !== undefined) {\r\n                that.subscribes[type][pattern]--;\r\n                if (that.subscribes[type][pattern] <= 0) {\r\n                    if (type === 'stateChange') {\r\n                        adapter.log.debug('Unsubscribe STATES: ' + pattern);\r\n                        adapter.unsubscribeForeignStates(pattern);\r\n                    } else if (type === 'objectChange') {\r\n                        adapter.log.debug('Unsubscribe OBJECTS: ' + pattern);\r\n                        adapter.unsubscribeForeignObjects && adapter.unsubscribeForeignObjects(pattern);\r\n                    } else if (type === 'log') {\r\n                        adapter.log.debug('Unsubscribe LOGS: ' + pattern);\r\n                        adapter.requireLog && adapter.requireLog(false);\r\n                    }\r\n                    delete that.subscribes[type][pattern];\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    function subscribeSocket(socket, type) {\r\n        //console.log((socket._name || socket.id) + ' subscribeSocket');\r\n        if (!socket._subscribe || !socket._subscribe[type]) return;\r\n\r\n        for (let i = 0; i < socket._subscribe[type].length; i++) {\r\n            const pattern = socket._subscribe[type][i].pattern;\r\n            if (that.subscribes[type][pattern] === undefined){\r\n                that.subscribes[type][pattern] = 1;\r\n                if (type === 'stateChange') {\r\n                    adapter.log.debug('Subscribe STATES: ' + pattern);\r\n                    adapter.subscribeForeignStates(pattern);\r\n                } else if (type === 'objectChange') {\r\n                    adapter.log.debug('Subscribe OBJECTS: ' + pattern);\r\n                    adapter.subscribeForeignObjects && adapter.subscribeForeignObjects(pattern);\r\n                } else if (type === 'log') {\r\n                    adapter.log.debug('Subscribe LOGS');\r\n                    adapter.requireLog && adapter.requireLog(true);\r\n                }\r\n            } else {\r\n                that.subscribes[type][pattern]++;\r\n            }\r\n        }\r\n    }\r\n\r\n    function socketEvents(socket) {\r\n        if (socket.conn.request.sessionID) {\r\n            socket._secure = true;\r\n            socket._sessionID = socket.conn.request.sessionID;\r\n            // Get user for session\r\n            adapter.getSession(socket.conn.request.sessionID, function (obj) {\r\n                if (!obj || !obj.passport) {\r\n                    socket._acl.user = '';\r\n                    socket.emit('reauthenticate');\r\n                }\r\n            });\r\n        }\r\n\r\n        if (!that.infoTimeout) {\r\n            that.infoTimeout = setTimeout(updateConnectedInfo, 1000);\r\n        }\r\n\r\n        // Enable logging, while some browser is connected\r\n        /*if (adapter.requireLog) {\r\n            adapter.requireLog(true);\r\n        }*/\r\n\r\n        if (socket.conn) {\r\n            subscribeSocket(socket, 'stateChange');\r\n            subscribeSocket(socket, 'objectChange');\r\n            subscribeSocket(socket, 'log');\r\n        }\r\n\r\n        socket.on('name', function (name) {\r\n            updateSession(socket);\r\n            if (this._name === undefined) {\r\n                this._name = name;\r\n                if (!that.infoTimeout) {\r\n                    that.infoTimeout = setTimeout(updateConnectedInfo, 1000);\r\n                }\r\n            } else if (this._name !== name) {\r\n                adapter.log.warn('socket ' + this.id + ' changed socket name from ' + this._name + ' to ' + name);\r\n                this._name = name;\r\n            }\r\n        });\r\n        /*\r\n         *      objects\r\n         */\r\n        socket.on('getObject', function (id, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getObject', callback, id)) {\r\n                adapter.getForeignObject(id, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('getObjects', function (callback) {\r\n            return getAllObjects(socket, callback);\r\n        });\r\n        socket.on('getForeignObjects', function (pattern, type, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getObjects', callback)) {\r\n                if (typeof type === 'function') {\r\n                    callback = type;\r\n                    type = undefined;\r\n                }\r\n\r\n                adapter.getForeignObjects(pattern, type, function (err, objs) {\r\n                    if (typeof callback === 'function') {\r\n                        callback(err, objs);\r\n                    } else {\r\n                        adapter.log.warn('[getObjects] Invalid callback')\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        // Identical to getObjects\r\n        socket.on('getAllObjects', function (callback) {\r\n            return getAllObjects(socket, callback);\r\n        });\r\n\r\n        socket.on('getObjectView', function (design, search, params, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getObjectView', callback, search)) {\r\n                adapter.objects.getObjectView(design, search, params, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('setObject', function (id, obj, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'setObject', callback, id)) {\r\n                adapter.setForeignObject(id, obj, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('delObject', function (id, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'delObject', callback, id)) {\r\n                adapter.delForeignObject(id, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('extendObject', function (id, obj, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'extendObject', callback, id)) {\r\n                adapter.extendForeignObject(id, obj, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('getHostByIp', function (ip, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getHostByIp', ip)) {\r\n                adapter.objects.getObjectView('system', 'host', {}, {user: this._acl.user}, function (err, data) {\r\n                    if (data.rows.length) {\r\n                        for (let i = 0; i < data.rows.length; i++) {\r\n                            if (data.rows[i].value.common.hostname === ip) {\r\n                                if (typeof callback === 'function') {\r\n                                    callback(ip, data.rows[i].value);\r\n                                } else {\r\n                                    adapter.log.warn('[getHostByIp] Invalid callback')\r\n                                }\r\n                                return;\r\n                            }\r\n                            if (data.rows[i].value.native.hardware && data.rows[i].value.native.hardware.networkInterfaces) {\r\n                                const net = data.rows[i].value.native.hardware.networkInterfaces;\r\n                                for (const eth in net) {\r\n                                    if (!net.hasOwnProperty(eth)) continue;\r\n                                    for (let j = 0; j < net[eth].length; j++) {\r\n                                        if (net[eth][j].address === ip) {\r\n                                            if (typeof callback === 'function') {\r\n                                                callback(ip, data.rows[i].value);\r\n                                            } else {\r\n                                                adapter.log.warn('[getHostByIp] Invalid callback')\r\n                                            }\r\n                                            return;\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    if (typeof callback === 'function') {\r\n                        callback(ip, null);\r\n                    } else {\r\n                        adapter.log.warn('[getHostByIp] Invalid callback');\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        /*\r\n         *      states\r\n         */\r\n        socket.on('getStates', function (callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getStates', callback)) {\r\n                if (typeof callback === 'function') {\r\n                    adapter.getForeignStates('*', callback);\r\n                } else {\r\n                    adapter.log.warn('[getStates] Invalid callback')\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('getState', function (id, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getState', callback, id)) {\r\n                if (typeof callback === 'function') {\r\n                    if (states[id]) {\r\n                        callback(null, states[id]);\r\n                    } else {\r\n                        adapter.getForeignState(id, callback);\r\n                    }\r\n                } else {\r\n                    adapter.log.warn('[getState] Invalid callback')\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('getForeignStates', function (pattern, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getStates', callback)) {\r\n                if (typeof callback === 'function') {\r\n                    adapter.getForeignStates(pattern, callback);\r\n                } else {\r\n                    adapter.log.warn('[getForeignStates] Invalid callback')\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('setState', function (id, state, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'setState', callback, id)) {\r\n                if (typeof state !== 'object') {\r\n                    state = {val: state};\r\n                }\r\n\r\n                // clear cache\r\n                if (states[id]) {\r\n                    delete states[id];\r\n                }\r\n\r\n                adapter.setForeignState(id, state, {user: this._acl.user}, (err, res) =>\r\n                    typeof callback === 'function' && callback(err, res));\r\n            }\r\n        });\r\n\r\n        socket.on('delState', function (id, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'delState', callback, id)) {\r\n                // clear cache\r\n                if (states[id]) {\r\n                    delete states[id];\r\n                }\r\n                adapter.delForeignState(id, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('requireLog', function (isEnabled, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'setObject', callback)) {\r\n                if (isEnabled) {\r\n                    that.subscribe(this, 'log', 'dummy');\r\n                } else {\r\n                    that.unsubscribe(this, 'log', 'dummy');\r\n                }\r\n\r\n                if (adapter.log.level === 'debug') showSubscribes(socket, 'log');\r\n\r\n                if (typeof callback === 'function') {\r\n                    setImmediate(callback, null);\r\n                }\r\n            }\r\n        });\r\n        /*\r\n         *      History\r\n         */\r\n        socket.on('getStateHistory', function (id, options, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getStateHistory', callback)) {\r\n                options.user = this._acl.user;\r\n                options.aggregate = options.aggregate || 'none';\r\n                adapter.getHistory(id, options, callback);\r\n            }\r\n        });\r\n        socket.on('getHistory', function (id, options, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getStateHistory', callback)) {\r\n                options.user = this._acl.user;\r\n                options.aggregate = options.aggregate || 'none';\r\n                adapter.getHistory(id, options, callback);\r\n            }\r\n        });\r\n        /*\r\n         *      user/group\r\n         */\r\n        socket.on('addUser', function (user, pass, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'addUser', callback, user)) {\r\n                addUser(user, pass, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('delUser', function (user, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'delUser', callback, user)) {\r\n                delUser(user, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('addGroup', function (group, desc, acl, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'addGroup', callback, group)) {\r\n                addGroup(group, desc, acl, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('delGroup', function (group, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'delGroup', callback, group)) {\r\n                delGroup(group, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('changePassword', function (user, pass, callback) {\r\n            if (updateSession(socket)) {\r\n                if (user === socket._acl.user || checkPermissions(socket, 'changePassword', callback, user)) {\r\n                    adapter.setPassword(user, pass, {user: this._acl.user}, callback);\r\n                }\r\n            }\r\n        });\r\n\r\n        // HTTP\r\n        socket.on('httpGet', function (url, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'httpGet', callback, url)) {\r\n                request(url, callback);\r\n            }\r\n        });\r\n\r\n        // commands will be executed on host/controller\r\n        // following response commands are expected: cmdStdout, cmdStderr, cmdExit\r\n        socket.on('cmdExec', function (host, id, cmd, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'cmdExec', callback, cmd)) {\r\n                console.log('cmdExec on ' + host + '(' + id + '): ' + cmd);\r\n                // remember socket for this ID.\r\n                cmdSessions[id] = {socket: socket};\r\n                adapter.sendToHost(host, 'cmdExec', {data: cmd, id: id});\r\n            }\r\n        });\r\n\r\n        socket.on('readDir', function (_adapter, path, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'readDir', callback, path)) {\r\n                adapter.readDir(_adapter, path, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('writeFile', function (_adapter, filename, data, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'writeFile', callback, filename)) {\r\n                adapter.writeFile(_adapter, filename, data, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('readFile', function (_adapter, filename, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'readFile', callback, filename)) {\r\n                adapter.readFile(_adapter, filename, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('deleteFile', function (_adapter, filename, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'deleteFile', callback, filename)) {\r\n                adapter.unlink(_adapter, filename, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('readFile64', function (_adapter, filename, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'readFile64', callback, filename)) {\r\n                adapter.readFile(_adapter, filename, {user: this._acl.user}, callback);\r\n            }\r\n        });\r\n\r\n        socket.on('sendTo', function (adapterInstance, command, message, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'sendTo', callback, command)) {\r\n                adapter.sendTo(adapterInstance, command, message, function (res) {\r\n                    if (typeof callback === 'function') {\r\n                        setTimeout(function () {\r\n                            callback(res);\r\n                        }, 0);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        // following commands are protected and require the extra permissions\r\n        const protectedCommands = ['cmdExec', 'getLocationOnDisk', 'getDiagData', 'getDevList', 'delLogs', 'writeDirAsZip', 'writeObjectsAsZip', 'readObjectsAsZip', 'checkLogging', 'updateMultihost'];\r\n\r\n        socket.on('sendToHost', function (host, command, message, callback) {\r\n            // host can answer following commands: cmdExec, getRepository, getInstalled, getInstalledAdapter, getVersion, getDiagData, getLocationOnDisk, getDevList, getLogs, getHostInfo,\r\n            // delLogs, readDirAsZip, writeDirAsZip, readObjectsAsZip, writeObjectsAsZip, checkLogging, updateMultihost\r\n            if (updateSession(socket) && checkPermissions(socket, protectedCommands.indexOf(command) !== -1 ? 'cmdExec' : 'sendToHost', callback, command)) {\r\n                adapter.sendToHost(host, command, message, res =>\r\n                    typeof callback === 'function' && setTimeout(() => callback(res), 0));\r\n            }\r\n        });\r\n\r\n        socket.on('authEnabled', function (callback) {\r\n            if (typeof callback === 'function') {\r\n                callback(adapter.config.auth, socket._acl.user.replace(/^system\\.user\\./, ''));\r\n            }\r\n        });\r\n\r\n        socket.on('disconnect', function () {\r\n            unsubscribeSocket(this, 'stateChange');\r\n            unsubscribeSocket(this, 'objectChange');\r\n            unsubscribeSocket(this, 'log');\r\n            if (!that.infoTimeout) {\r\n                that.infoTimeout = setTimeout(updateConnectedInfo, 1000);\r\n            }\r\n\r\n            // Disable logging if no one browser is connected\r\n            if (adapter.requireLog) {\r\n                adapter.log.debug('Disable logging, because no one socket connected');\r\n                adapter.requireLog(!!that.server.engine.clientsCount);\r\n            }\r\n        });\r\n\r\n        socket.on('listPermissions', function (callback) {\r\n            if (updateSession(socket)) {\r\n                if (typeof callback === 'function') {\r\n                    callback(commandsPermissions);\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('getUserPermissions', function (callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'getUserPermissions', callback)) {\r\n                if (typeof callback === 'function') {\r\n                    callback(null, socket._acl);\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('eventsThreshold', function (isActive) {\r\n            if (!isActive) {\r\n                disableEventThreshold(true);\r\n            } else {\r\n                enableEventThreshold();\r\n            }\r\n        });\r\n\r\n        socket.on('eventsThreshold', function (isActive) {\r\n            if (!isActive) {\r\n                disableEventThreshold(true);\r\n            } else {\r\n                enableEventThreshold();\r\n            }\r\n        });\r\n\r\n        socket.on('subscribe', function (pattern, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'subscribe', callback, pattern)) {\r\n                if (pattern && typeof pattern === 'object' && pattern instanceof Array) {\r\n                    for (let p = 0; p < pattern.length; p++) {\r\n                        that.subscribe(this, 'stateChange', pattern[p]);\r\n                    }\r\n                } else {\r\n                    that.subscribe(this, 'stateChange', pattern);\r\n                }\r\n                if (adapter.log.level === 'debug') showSubscribes(socket, 'stateChange');\r\n                if (typeof callback === 'function') {\r\n                    setImmediate(callback, null);\r\n                }\r\n            }\r\n        });\r\n        // same as 'subscribe'\r\n        socket.on('subscribeStates', function (pattern, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'subscribe', callback, pattern)) {\r\n                if (pattern && typeof pattern === 'object' && pattern instanceof Array) {\r\n                    for (let p = 0; p < pattern.length; p++) {\r\n                        that.subscribe(this, 'stateChange', pattern[p]);\r\n                    }\r\n                } else {\r\n                    that.subscribe(this, 'stateChange', pattern);\r\n                }\r\n                if (adapter.log.level === 'debug') showSubscribes(socket, 'stateChange');\r\n                if (typeof callback === 'function') {\r\n                    setImmediate(callback, null);\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('unsubscribe', function (pattern, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'unsubscribe', callback, pattern)) {\r\n                if (pattern && typeof pattern === 'object' && pattern instanceof Array) {\r\n                    for (let p = 0; p < pattern.length; p++) {\r\n                        that.unsubscribe(this, 'stateChange', pattern[p]);\r\n                    }\r\n                } else {\r\n                    that.unsubscribe(this, 'stateChange', pattern);\r\n                }\r\n\r\n                // reset states cache on unsubscribe\r\n                states = {};\r\n\r\n                adapter.log.level === 'debug' && showSubscribes(socket, 'stateChange');\r\n\r\n                typeof callback === 'function' && setImmediate(callback, null);\r\n            }\r\n        });\r\n\r\n        // same as 'unsubscribe'\r\n        socket.on('unsubscribeStates', function (pattern, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'unsubscribe', callback, pattern)) {\r\n                if (pattern && typeof pattern === 'object' && pattern instanceof Array) {\r\n                    for (let p = 0; p < pattern.length; p++) {\r\n                        that.unsubscribe(this, 'stateChange', pattern[p]);\r\n                    }\r\n                } else {\r\n                    that.unsubscribe(this, 'stateChange', pattern);\r\n                }\r\n                if (adapter.log.level === 'debug') showSubscribes(socket, 'stateChange');\r\n                if (typeof callback === 'function') {\r\n                    setImmediate(callback, null);\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('subscribeObjects', function (pattern, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'subscribeObjects', callback, pattern)) {\r\n                if (pattern && typeof pattern === 'object' && pattern instanceof Array) {\r\n                    for (let p = 0; p < pattern.length; p++) {\r\n                        that.subscribe(this, 'objectChange', pattern[p]);\r\n                    }\r\n                } else {\r\n                    that.subscribe(this, 'objectChange', pattern);\r\n                }\r\n                if (typeof callback === 'function') {\r\n                    setImmediate(callback, null);\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('unsubscribeObjects', function (pattern, callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'unsubscribeObjects', callback, pattern)) {\r\n                if (pattern && typeof pattern === 'object' && pattern instanceof Array) {\r\n                    for (let p = 0; p < pattern.length; p++) {\r\n                        that.unsubscribe(this, 'objectChange', pattern[p]);\r\n                    }\r\n                } else {\r\n                    that.unsubscribe(this, 'objectChange', pattern);\r\n                }\r\n                if (typeof callback === 'function') {\r\n                    setImmediate(callback, null);\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('readLogs', function (callback) {\r\n            if (updateSession(socket) && checkPermissions(socket, 'readLogs', callback)) {\r\n                let result = {list: []};\r\n\r\n                // deliver file list\r\n                try {\r\n                    const config = adapter.systemConfig;\r\n                    // detect file log\r\n                    if (config && config.log && config.log.transport) {\r\n                        for (const transport in config.log.transport) {\r\n                            if (config.log.transport.hasOwnProperty(transport) && config.log.transport[transport].type === 'file') {\r\n                                let filename = config.log.transport[transport].filename || 'log/';\r\n                                const parts = filename.replace(/\\\\/g, '/').split('/');\r\n                                parts.pop();\r\n                                filename = parts.join('/');\r\n                                if (filename[0] !== '/' && !filename.match(/^\\W:/)) {\r\n                                    filename = path.normalize(__dirname + '/../../../') + filename;\r\n                                }\r\n                                if (fs.existsSync(filename)) {\r\n                                    const files = fs.readdirSync(filename);\r\n                                    for (let f = 0; f < files.length; f++) {\r\n                                        try {\r\n                                            if (!fs.lstatSync(filename + '/' + files[f]).isDirectory()) {\r\n                                                result.list.push('log/' + transport + '/' + files[f]);\r\n                                            }\r\n                                        } catch (e) {\r\n                                            // push unchecked\r\n                                            // result.list.push('log/' + transport + '/' + files[f]);\r\n                                            adapter.log.error('Cannot check file: ' + filename + '/' + files[f]);\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    } else {\r\n                        result = {error: 'no file loggers'};\r\n                    }\r\n                } catch (e) {\r\n                    adapter.log.error(e);\r\n                    result = {error: e};\r\n                }\r\n                if (typeof callback === 'function') {\r\n                    callback(result.error, result.list);\r\n                }\r\n            }\r\n        });\r\n\r\n        socket.on('getVersion', callback => {\r\n            if (typeof callback === 'function') {\r\n                let version = '';\r\n                try {\r\n                    const pack = require('../io-package.json');\r\n                    version = pack && pack.common && pack.common.version;\r\n                } catch (e) {\r\n                    version = 'unknown';\r\n                }\r\n                callback(null, version)\r\n            }\r\n        });\r\n    }\r\n\r\n    function onAuthorizeSuccess(data, accept) {\r\n        adapter.log.info('successful connection to socket.io from ' + data.connection.remoteAddress);\r\n        //adapter.log.info(JSON.stringify(data));\r\n\r\n        accept();\r\n    }\r\n\r\n    function onAuthorizeFail(data, message, error, accept) {\r\n        if (error) {\r\n            adapter.log.error('failed connection to socket.io from ' + data.connection.remoteAddress + ':', message);\r\n        }\r\n\r\n        if (error) {\r\n            accept(new Error(message));\r\n        } else {\r\n            accept('failed connection to socket.io: ' + message);//null, false);\r\n        }\r\n        // this error will be sent to the user as a special error-package\r\n        // see: http://socket.io/docs/client-api/#socket > error-object\r\n    }\r\n\r\n    function initSocket(socket) {\r\n        disableEventThreshold();\r\n\r\n        if (adapter.config.auth) {\r\n            adapter.config.ttl = parseInt(adapter.config.ttl, 10) || 3600;\r\n            getUserFromSocket(socket, function (err, user) {\r\n                if (err || !user) {\r\n                    adapter.log.error('socket.io ' + err);\r\n                } else {\r\n                    adapter.log.debug('socket.io client ' + user + ' connected');\r\n                    adapter.calculatePermissions(user, commandsPermissions, function (acl) {\r\n                        socket._acl = acl;\r\n                        socketEvents(socket);\r\n                    });\r\n                }\r\n            });\r\n        } else {\r\n            adapter.calculatePermissions(adapter.config.defaultUser || 'system.user.admin', commandsPermissions, function (acl) {\r\n                socket._acl = acl;\r\n                socketEvents(socket);\r\n            });\r\n        }\r\n    }\r\n\r\n    // Extract user name from socket\r\n    function getUserFromSocket(socket, callback) {\r\n        let wait = false;\r\n        try {\r\n            if (socket.conn.request.sessionID) {\r\n                wait = true;\r\n                if (store) {\r\n                    store.get(socket.conn.request.sessionID, function (err, obj) {\r\n                        if (obj && obj.passport && obj.passport.user) {\r\n                            if (typeof callback === 'function') {\r\n                                callback(null, obj.passport.user ? 'system.user.' + obj.passport.user : '');\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        } catch (e) {\r\n\r\n        }\r\n        if (!wait && callback) {\r\n            callback('Cannot detect user');\r\n        }\r\n    }\r\n\r\n    function disableEventThreshold(readAll) {\r\n        if (eventsThreshold.active) {\r\n            eventsThreshold.accidents = 0;\r\n            eventsThreshold.count = 0;\r\n            eventsThreshold.active = false;\r\n            eventsThreshold.timeActivated = 0;\r\n            adapter.log.info('Subscribe on all states again');\r\n\r\n            setTimeout(function () {\r\n                /*if (readAll) {\r\n                    adapter.getForeignStates('*', function (err, res) {\r\n                        adapter.log.info('received all states');\r\n                        for (const id in res) {\r\n                            if (res.hasOwnProperty(id) && JSON.stringify(states[id]) !== JSON.stringify(res[id])) {\r\n                                that.server.sockets.emit('stateChange', id, res[id]);\r\n                                states[id] = res[id];\r\n                            }\r\n                        }\r\n                    });\r\n                }*/\r\n\r\n                that.server.sockets.emit('eventsThreshold', false);\r\n                adapter.unsubscribeForeignStates('system.adapter.*');\r\n\r\n                Object.keys(that.subscribes.stateChange).forEach(pattern =>\r\n                    adapter.subscribeForeignStates(pattern));\r\n\r\n            }, 50);\r\n        }\r\n    }\r\n\r\n    function enableEventThreshold() {\r\n        if (!eventsThreshold.active) {\r\n            eventsThreshold.active = true;\r\n\r\n            setTimeout(function () {\r\n                adapter.log.info('Unsubscribe from all states, except system\\'s, because over ' + eventsThreshold.repeatSeconds + ' seconds the number of events is over ' + eventsThreshold.value + ' (in last second ' + eventsThreshold.count + ')');\r\n                eventsThreshold.timeActivated = new Date().getTime();\r\n\r\n                that.server.sockets.emit('eventsThreshold', true);\r\n\r\n                Object.keys(that.subscribes.stateChange).forEach(pattern =>\r\n                    adapter.unsubscribeForeignStates(pattern));\r\n\r\n                adapter.subscribeForeignStates('system.adapter.*');\r\n            }, 100);\r\n        }\r\n    }\r\n\r\n    this.repoUpdated = function () {\r\n        if (that.server && that.server.sockets) {\r\n            that.server.sockets.emit('repoUpdated');\r\n        }\r\n    };\r\n\r\n    this.objectChange = function (id, obj) {\r\n        const clients = that.server.sockets.connected;\r\n\r\n        for (const i in clients) {\r\n            if (clients.hasOwnProperty(i)) {\r\n                updateSession(clients[i]);\r\n            }\r\n        }\r\n        that.server.sockets.emit('objectChange', id, obj);\r\n    };\r\n\r\n    this.sendCommand = function (obj) {\r\n        if (cmdSessions[obj.message.id]) {\r\n            if (that.server) {\r\n                that.server.sockets.emit(obj.command, obj.message.id, obj.message.data);\r\n            }\r\n            // we cannot save the socket, because if it takes a bit time, the socket will be invalid\r\n            //cmdSessions[obj.message.id].socket.emit(obj.command, obj.message.id, obj.message.data);\r\n            if (obj.command === 'cmdExit') {\r\n                delete cmdSessions[obj.message.id];\r\n            }\r\n        }\r\n    };\r\n\r\n    this.sendLog = function (obj) {\r\n        // TODO Build in some threshold\r\n        if (that.server && that.server.sockets) {\r\n            that.server.sockets.emit('log', obj);\r\n        }\r\n    };\r\n\r\n    this.stateChange = function (id, state) {\r\n        if (!state) {\r\n            if (states[id]) {\r\n                delete states[id];\r\n            }\r\n        } else {\r\n            states[id] = state;\r\n        }\r\n        const clients = that.server.sockets.connected;\r\n\r\n        if (!eventsThreshold.active) {\r\n            eventsThreshold.count++;\r\n        }\r\n        for (const i in clients) {\r\n            if (clients.hasOwnProperty(i)) {\r\n                updateSession(clients[i]);\r\n            }\r\n        }\r\n        that.server.sockets.emit('stateChange', id, state);\r\n    };\r\n\r\n    (function __constructor() {\r\n        // detect event bursts\r\n        setInterval(function () {\r\n            if (!eventsThreshold.active) {\r\n                if (eventsThreshold.count > eventsThreshold.value) {\r\n                    eventsThreshold.accidents++;\r\n\r\n                    if (eventsThreshold.accidents >= eventsThreshold.repeatSeconds) {\r\n                        enableEventThreshold();\r\n                    }\r\n                } else {\r\n                    eventsThreshold.accidents = 0;\r\n                }\r\n                eventsThreshold.count = 0;\r\n            } else if (new Date().getTime() - eventsThreshold.timeActivated > 60000) {\r\n                disableEventThreshold();\r\n            }\r\n        }, eventsThreshold.checkInterval);\r\n\r\n        /*server.server.set('logger', {\r\n         debug: function(obj) {adapter.log.debug('socket.io: ' + obj)},\r\n         info:  function(obj) {adapter.log.debug('socket.io: ' + obj)} ,\r\n         error: function(obj) {adapter.log.error('socket.io: ' + obj)},\r\n         warn:  function(obj) {adapter.log.warn('socket.io: ' + obj)}\r\n         });*/\r\n        // it can be used as client too for cloud\r\n        if (!settings.clientid) {\r\n            if (!server.__inited) {\r\n                that.server = socketio.listen(server);\r\n                server.__inited = true;\r\n            }\r\n        } else {\r\n            that.server = server;\r\n        }\r\n\r\n        that.server.on('connection', initSocket);\r\n\r\n        if (settings.auth && that.server) {\r\n            that.server.use(passportSocketIo.authorize({\r\n                passport:     passport,\r\n                cookieParser: cookieParser,\r\n                key:          userKey,             // the name of the cookie where express/connect stores its session_id\r\n                secret:       settings.secret,     // the session_secret to parse the cookie\r\n                store:        store,               // we NEED to use a sessionstore. no memorystore please\r\n                success:      onAuthorizeSuccess,  // *optional* callback on success - read more below\r\n                fail:         onAuthorizeFail      // *optional* callback on fail/error - read more below\r\n            }));\r\n        }\r\n\r\n        if (!that.infoTimeout) {\r\n            that.infoTimeout = setTimeout(updateConnectedInfo, 1000);\r\n        }\r\n    })();\r\n\r\n    return this;\r\n}\r\n\r\nmodule.exports = IOSocket;", "/* jshint -W097 */\r\n/* jshint strict: false */\r\n/* jslint node: true */\r\n/* jshint -W061 */\r\n'use strict';\r\nconst Stream \t= require('stream');\r\nconst utils \t= require('@iobroker/adapter-core'); // Get common adapter utils\r\nconst LE \t    = require(utils.controllerDir + '/lib/letsencrypt.js');\r\nconst express \t= require('express');\r\nconst fs        = require('fs');\r\nlet path        = require('path');\r\n\r\nlet session;\r\nlet bodyParser;\r\nlet AdapterStore;\r\nlet password;\r\nlet passport;\r\nlet LocalStrategy;\r\nlet flash;\r\nlet cookieParser;\r\nlet fileUpload;\r\nlet socketIoFile;\r\n\r\n// copied from here: https://github.com/component/escape-html/blob/master/index.js\r\nconst matchHtmlRegExp = /[\"'&<>]/;\r\nfunction escapeHtml (string) {\r\n    const str = '' + string;\r\n    const match = matchHtmlRegExp.exec(str);\r\n\r\n    if (!match) {\r\n        return str;\r\n    }\r\n\r\n    let escape;\r\n    let html = '';\r\n    let index = 0;\r\n    let lastIndex = 0;\r\n\r\n    for (index = match.index; index < str.length; index++) {\r\n        switch (str.charCodeAt(index)) {\r\n            case 34: // \"\r\n                escape = '&quot;';\r\n                break;\r\n            case 38: // &\r\n                escape = '&amp;';\r\n                break;\r\n            case 39: // '\r\n                escape = '&#39;';\r\n                break;\r\n            case 60: // <\r\n                escape = '&lt;';\r\n                break;\r\n            case 62: // >\r\n                escape = '&gt;';\r\n                break;\r\n            default:\r\n                continue;\r\n        }\r\n\r\n        if (lastIndex !== index) {\r\n            html += str.substring(lastIndex, index);\r\n        }\r\n\r\n        lastIndex = index + 1;\r\n        html += escape;\r\n    }\r\n\r\n    return lastIndex !== index\r\n        ? html + str.substring(lastIndex, index)\r\n        : html;\r\n}\r\n\r\nfunction Web(settings, adapter, onReady) {\r\n    if (!(this instanceof Web)) return new Web(settings, adapter, onReady);\r\n    const server = {\r\n        app:       null,\r\n        server:    null\r\n    };\r\n    const bruteForce  = {};\r\n    let store       = null;\r\n    let loginPage;\r\n    this.server = server;\r\n\r\n    this.close = () => server.server && server.server.close();\r\n\r\n    function decorateLogFile(filename) {\r\n        const prefix = '<html><head>' +\r\n        '<style>\\n' +\r\n        '   table {' +\r\n        '       font-family: monospace;\\n' +\r\n        '       font-size: 14px;\\n' +\r\n        '   }\\n' +\r\n        '   .info {\\n' +\r\n        '       background: white;' +\r\n        '   }\\n' +\r\n        '   .type {\\n' +\r\n        '       font-weight: bold;' +\r\n        '   }\\n' +\r\n        '   .silly {\\n' +\r\n        '       background: #b3b3b3;' +\r\n        '   }\\n' +\r\n        '   .debug {\\n' +\r\n        '       background: lightgray;' +\r\n        '   }\\n' +\r\n        '   .warn {\\n' +\r\n        '       background: #ffdb75;' +\r\n        '       color: white;' +\r\n        '   }\\n' +\r\n        '   .error {\\n' +\r\n        '       background: #ff6a5b;' +\r\n        '   }\\n' +\r\n        '</style>\\n' +\r\n            '<script>\\n' +\r\n            'function decorate (line) {\\n' +\r\n            '   var className = \"info\";\\n' +\r\n            '   line = line.replace(/\\\\x1B\\\\[39m/g, \"</span>\");\\n' +\r\n            '   if (line.indexOf(\"[32m\") !== -1) {\\n' +\r\n            '       className = \"info\";\\n'+\r\n            '       line = line.replace(/\\\\x1B\\\\[32m/g, \"<span class=\\\\\"type\\\\\">\");\\n' +\r\n            '   } else \\n' +\r\n            '   if (line.indexOf(\"[34m\") !== -1) {\\n' +\r\n            '       className = \"debug\";\\n'+\r\n            '       line = line.replace(/\\\\x1B\\\\[34m/g, \"<span class=\\\\\"type\\\\\">\");\\n' +\r\n            '   } else \\n' +\r\n            '   if (line.indexOf(\"[33m\") !== -1) {\\n' +\r\n            '       className = \"warn\";\\n'+\r\n            '       line = line.replace(/\\\\x1B\\\\[33m/g, \"<span class=\\\\\"type\\\\\">\");\\n' +\r\n            '   } else \\n' +\r\n            '   if (line.indexOf(\"[31m\") !== -1) {\\n' +\r\n            '       className = \"error\";\\n'+\r\n            '       line = line.replace(/\\\\x1B\\\\[31m/g, \"<span class=\\\\\"type\\\\\">\");\\n' +\r\n            '   } else \\n' +\r\n            '   if (line.indexOf(\"[35m\") !== -1) {\\n' +\r\n            '       className = \"silly\";\\n'+\r\n            '       line = line.replace(/\\\\x1B\\\\[35m/g, \"<span class=\\\\\"type\\\\\">\");\\n' +\r\n            '   } else {\\n' +\r\n            '   }\\n' +\r\n            '   return \"<tr class=\\\\\"\" + className + \"\\\\\"><td>\" + line + \"</td></tr>\";\\n'+\r\n            '}\\n' +\r\n            'document.addEventListener(\"DOMContentLoaded\", function () { \\n' +\r\n            '  var text = document.body.innerHTML;\\n' +\r\n            '  var lines = text.split(\"\\\\n\");\\n' +\r\n            '  text = \"<table>\";\\n' +\r\n            '  for (var i = 0; i < lines.length; i++) {\\n' +\r\n            '       if (lines[i]) text += decorate(lines[i]);\\n' +\r\n            '  }\\n' +\r\n            '  text += \"</table>\";\\n' +\r\n            '  document.body.innerHTML = text;\\n' +\r\n            '  window.scrollTo(0,document.body.scrollHeight);\\n' +\r\n            '});\\n' +\r\n            '</script>\\n</head>\\n<body>\\n';\r\n        const suffix = '</body></html>';\r\n        const log = fs.readFileSync(filename).toString();\r\n        return prefix + log + suffix;\r\n    }\r\n\r\n    function prepareLoginTemplate() {\r\n        let def = 'background: #64b5f6;\\n';\r\n        let template = fs.readFileSync(__dirname + '/../www/login/index.html').toString('utf8');\r\n        if (adapter.config.loginBackgroundColor) {\r\n            def = 'background-color: ' + adapter.config.loginBackgroundColor + ';\\n'\r\n        }\r\n        if (adapter.config.loginBackgroundImage) {\r\n            def += '            background-image: url(../' + adapter.namespace + '/login-bg.png);\\n';\r\n        }\r\n        if (adapter.config.loginHideLogo) {\r\n            template = template.replace('.logo { display: block }', '.logo { display: none }');\r\n        }\r\n        if (adapter.config.loginMotto) {\r\n            template = template.replace('Discover awesome. <a href=\"http://iobroker.net/\" target=\"_blank\">ioBroker</a>', adapter.config.loginMotto);\r\n        }\r\n        return template.replace('background: #64b5f6;', def);\r\n    }\r\n\r\n    //settings: {\r\n    //    \"port\":   8080,\r\n    //    \"auth\":   false,\r\n    //    \"secure\": false,\r\n    //    \"bind\":   \"0.0.0.0\", // \"::\"\r\n    //    \"cache\":  false\r\n    //}\r\n    (function __construct () {\r\n        if (settings.port) {\r\n            server.app = express();\r\n\r\n            server.app.disable('x-powered-by');\r\n\r\n            // enable use of i-frames together with HTTPS\r\n            server.app.get('/*', (req, res, next) => {\r\n                res.header('X-Frame-Options', 'SAMEORIGIN');\r\n                next(); // http://expressjs.com/guide.html#passing-route control\r\n            });\r\n\r\n            if (settings.auth) {\r\n                session =           require('express-session');\r\n                cookieParser =      require('cookie-parser');\r\n                bodyParser =        require('body-parser');\r\n                AdapterStore =      require(utils.controllerDir + '/lib/session.js')(session, settings.ttl);\r\n                password =          require(utils.controllerDir + '/lib/password.js');\r\n                passport =          require('passport');\r\n                LocalStrategy =     require('passport-local').Strategy;\r\n                flash =             require('connect-flash'); // TODO report error to user\r\n\r\n                store = new AdapterStore({adapter: adapter});\r\n\r\n                passport.use(new LocalStrategy(\r\n                    (username, password, done) => {\r\n                        if (bruteForce[username] && bruteForce[username].errors > 4) {\r\n                            let minutes = (new Date().getTime() - bruteForce[username].time);\r\n                            if (bruteForce[username].errors < 7) {\r\n                                if ((new Date().getTime() - bruteForce[username].time) < 60000) {\r\n                                    minutes = 1;\r\n                                } else {\r\n                                    minutes = 0;\r\n                                }\r\n                            } else\r\n                            if (bruteForce[username].errors < 10) {\r\n                                if ((new Date().getTime() - bruteForce[username].time) < 180000) {\r\n                                    minutes = Math.ceil((180000 - minutes) / 60000);\r\n                                } else {\r\n                                    minutes = 0;\r\n                                }\r\n                            } else\r\n                            if (bruteForce[username].errors < 15) {\r\n                                if ((new Date().getTime() - bruteForce[username].time) < 600000) {\r\n                                    minutes = Math.ceil((600000 - minutes) / 60000);\r\n                                } else {\r\n                                    minutes = 0;\r\n                                }\r\n                            } else\r\n                            if ((new Date().getTime() - bruteForce[username].time) < 3600000) {\r\n                                minutes = Math.ceil((3600000 - minutes) / 60000);\r\n                            } else {\r\n                                minutes = 0;\r\n                            }\r\n\r\n                            if (minutes) {\r\n                                return done('Too many errors. Try again in ' + minutes + ' ' + (minutes === 1 ? 'minute' : 'minutes') + '.', false);\r\n                            }\r\n                        }\r\n                        adapter.checkPassword(username, password, res => {\r\n                            if (!res) {\r\n                                bruteForce[username] = bruteForce[username] || {errors: 0};\r\n                                bruteForce[username].time = new Date().getTime();\r\n                                bruteForce[username].errors++;\r\n                            } else if (bruteForce[username]) {\r\n                                delete bruteForce[username];\r\n                            }\r\n\r\n                            if (res) {\r\n                                return done(null, username);\r\n                            } else {\r\n                                return done(null, false);\r\n                            }\r\n                        });\r\n\r\n                    }\r\n                ));\r\n                passport.serializeUser((user, done) => done(null, user));\r\n\r\n                passport.deserializeUser((user, done) => done(null, user));\r\n\r\n                server.app.use(cookieParser());\r\n                server.app.use(bodyParser.urlencoded({\r\n                    extended: true\r\n                }));\r\n                server.app.use(bodyParser.json());\r\n                server.app.use(session({\r\n                    secret:             settings.secret,\r\n                    saveUninitialized:  true,\r\n                    resave:             true,\r\n                    cookie:             {\r\n                        maxAge: adapter.config.ttl * 1000\r\n                    },\r\n                    store:  store\r\n                }));\r\n                server.app.use(passport.initialize());\r\n                server.app.use(passport.session());\r\n                server.app.use(flash());\r\n\r\n                server.app.post('/login', (req, res, next) => {\r\n                    let redirect = '/';\r\n                    const origin = (req.body && req.body.origin) || '?href=%2F';\r\n                    if (origin) {\r\n                        const parts = origin.match(/href=(.+)$/);\r\n                        if (parts && parts[1]) {\r\n                            redirect = decodeURIComponent(parts[1]);\r\n                            // if some invalid characters in redirect\r\n                            if (redirect.match(/[^-_a-zA-Z0-9&%?.]/)) {\r\n                                redirect = '/';\r\n                            }\r\n                        }\r\n                    }\r\n                    req.body.password = ((req.body && req.body.password) || '').toString();\r\n                    req.body.username = ((req.body && req.body.username) || '').toString();\r\n\r\n                    passport.authenticate('local', {\r\n                        successRedirect: redirect,\r\n                        failureRedirect: '/login/index.html' + origin + (origin ? '&error' : '?error'),\r\n                        failureFlash:    'Invalid username or password.'\r\n                    })(req, res, next);\r\n                });\r\n\r\n                server.app.get('/logout', (req, res) => {\r\n                    req.logout();\r\n                    res.redirect('/login/index.html');\r\n                });\r\n\r\n                server.app.get('/login/index.html', (req, res) => {\r\n                    loginPage = loginPage || prepareLoginTemplate();\r\n                    res.contentType('text/html');\r\n                    res.status(200).send(loginPage);\r\n                });\r\n\r\n                // route middleware to make sure a user is logged in\r\n                server.app.use((req, res, next) => {\r\n                    if (!req.isAuthenticated()) {\r\n                        if (/admin\\.\\d+\\/login-bg\\.png(\\?.*)?$/.test(req.originalUrl)) {\r\n                            // Read names of files for gong\r\n                            adapter.objects.readFile(adapter.namespace, 'login-bg.png', null, (err, file) => {\r\n                                if (!err && file) {\r\n                                    res.set('Content-Type', 'image/png');\r\n                                    res.status(200).send(file);\r\n                                } else {\r\n                                   res.status(404).send();\r\n                                }\r\n                            });\r\n                        } else if (/^\\/login\\//.test(req.originalUrl) ||\r\n                                   /\\.ico(\\?.*)?$/.test(req.originalUrl)) {\r\n                            return next();\r\n                        } else {\r\n                            res.redirect('/login/index.html?href=' + encodeURIComponent(req.originalUrl));\r\n                        }\r\n                    } else {\r\n                        // special solution for socket.io\r\n                        if (socketIoFile !== false && (req.url.startsWith('socket.io.js') || req.url.match(/\\/socket\\.io\\.js(\\?.*)?$/))) {\r\n                            if (socketIoFile) {\r\n                                res.contentType('text/javascript');\r\n                                res.status(200).send(socketIoFile);\r\n                                return\r\n                            } else {\r\n                                try {\r\n                                    const dir = require.resolve('socket.io-client');\r\n                                    const fileDir = path.join(path.dirname(dir), '../dist/');\r\n                                    if (fs.existsSync(fileDir + 'socket.io.min.js')) {\r\n                                        socketIoFile = fs.readFileSync(fileDir + 'socket.io.min.js');\r\n                                    } else {\r\n                                        socketIoFile = fs.readFileSync(fileDir + 'socket.io.js');\r\n                                    }\r\n                                } catch (e) {\r\n                                    try {\r\n                                        socketIoFile = fs.readFileSync(path.join(__dirname, '../www/lib/js/socket.io.js'));\r\n                                    } catch (e) {\r\n                                        adapter.log.error('Cannot read socket.io.js: ' + e);\r\n                                        socketIoFile = false;\r\n                                    }\r\n                                }\r\n                                if (socketIoFile) {\r\n                                    res.contentType('text/javascript');\r\n                                    res.status(200).send(socketIoFile);\r\n                                    return\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                        return next();\r\n                    }\r\n                });\r\n            } else {\r\n                server.app.get('/login', (req, res) => {\r\n                    res.redirect('/');\r\n                });\r\n                server.app.get('/logout', (req, res) => {\r\n                    res.redirect('/');\r\n                });\r\n            }\r\n\r\n            server.app.get('/zip/*', (req, res) => {\r\n                let parts = req.url.split('/');\r\n                let filename = parts.pop();\r\n\r\n                adapter.getBinaryState('system.host.' + adapter.host + '.zip.' + filename, (err, buff) => {\r\n                    if (err) {\r\n                        res.status(500).send(escapeHtml(typeof err === 'string' ? err : JSON.stringify(err)));\r\n                    } else {\r\n                        if (!buff) {\r\n                            res.status(404).send('File package.zip not found');\r\n                        } else {\r\n                            // remove file\r\n                            adapter.delBinaryState && adapter.delBinaryState('system.host.' + adapter.host + '.zip.' + filename);\r\n                            res.set('Content-Type', 'application/zip');\r\n                            res.send(buff);\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n\r\n            // send log files\r\n            server.app.get('/log/*', (req, res) => {\r\n                let parts = decodeURIComponent(req.url).split('/');\r\n                parts = parts.splice(2);\r\n                const transport = parts.shift();\r\n                let filename = parts.join('/');\r\n                const config = adapter.systemConfig;\r\n                // detect file log\r\n                if (config && config.log && config.log.transport) {\r\n                    if (config.log.transport.hasOwnProperty(transport) && config.log.transport[transport].type === 'file') {\r\n                        let logFolder;\r\n                        if (config.log.transport[transport].filename) {\r\n                            parts = config.log.transport[transport].filename.replace(/\\\\/g, '/').split('/');\r\n                            parts.pop();\r\n                            logFolder = path.normalize(parts.join('/'));\r\n                        } else {\r\n                            logFolder = path.join(process.cwd(), 'log');\r\n                        }\r\n\r\n                        if (logFolder[0] !== '/' && logFolder[0] !== '\\\\' && !logFolder.match(/^[a-zA-Z]:/)) {\r\n                            logFolder = path.normalize(path.join(__dirname + '/../../../', logFolder));\r\n                        }\r\n\r\n                        filename = path.normalize(path.join(logFolder, filename));\r\n\r\n                        if (filename.startsWith(logFolder) && fs.existsSync(filename)) {\r\n                            const stat = fs.lstatSync(filename);\r\n                            if (stat.size > 2 * 1024 * 1024) {\r\n                                res.sendFile(filename);\r\n                            } else {\r\n                                res.send(decorateLogFile(filename));\r\n                            }\r\n\r\n                            return;\r\n                        }\r\n                    }\r\n                }\r\n                res.status(404).send('File ' + escapeHtml(filename) + ' not found');\r\n            });\r\n            const appOptions = {};\r\n            if (settings.cache) {\r\n                appOptions.maxAge = 30758400000;\r\n            }\r\n\r\n            if (settings.tmpPathAllow && settings.tmpPath) {\r\n                server.app.use('/tmp/', express.static(settings.tmpPath, {maxAge: 0}));\r\n                fileUpload = fileUpload || require('express-fileupload');\r\n                server.app.use(fileUpload({\r\n                    useTempFiles: true,\r\n                    tempFileDir: settings.tmpPath\r\n                }));\r\n                server.app.post('/upload', (req, res) => {\r\n                    if (!req.files) {\r\n                        return res.status(400).send('No files were uploaded.');\r\n                    }\r\n\r\n                    // The name of the input field (i.e. \"sampleFile\") is used to retrieve the uploaded file\r\n                    let myFile;\r\n                    // take first non empty file\r\n                    for (const name in req.files) {\r\n                        if (req.files.hasOwnProperty(name)) {\r\n                            myFile = req.files[name];\r\n                            break;\r\n                        }\r\n                    }\r\n\r\n                    if (myFile) {\r\n                        if (myFile.data && myFile.data.length > 600 * 1024 * 1024) {\r\n                            return res.status(500).send('File is too big. (Max 600MB)');\r\n                        }\r\n                        // Use the mv() method to place the file somewhere on your server\r\n                        myFile.mv(settings.tmpPath + '/restore.iob', err =>  {\r\n                            if (err) {\r\n                                res.status(500).send(escapeHtml(typeof err === 'string' ? err : JSON.stringify(err)));\r\n                            } else {\r\n                                res.send('File uploaded!');\r\n                            }\r\n                        });\r\n                    } else {\r\n                        return res.status(500).send('File not uploaded');\r\n                    }\r\n                });\r\n            }\r\n\r\n            if (!fs.existsSync(__dirname + '/../www')) {\r\n                server.app.use('/', (req, res) => {\r\n                    res.send('This adapter cannot be installed directly from github.<br>You must install it from npm.<br>Write for that <i>\"npm install iobroker.admin\"</i> in according directory.');\r\n                });\r\n            } else {\r\n                server.app.use('/', express.static(__dirname + '/../www', appOptions));\r\n            }\r\n\r\n            // reverse proxy with url rewrite for couchdb attachments in <adapter-name>.admin\r\n            server.app.use('/adapter/', (req, res) => {\r\n                // Example: /example/?0\r\n                let url = req.url;\r\n\r\n                // add index.html\r\n                url = url.replace(/\\/($|\\?|#)/, '/index.html$1');\r\n\r\n                // Read config files for admin from /adapters/admin/admin/...\r\n                if (url.substring(0, '/' + adapter.name + '/'.length) === '/' + adapter.name + '/') {\r\n                    url = url.replace('/' + adapter.name + '/', __dirname + '/../admin/');\r\n                    url = url.replace(/\\?[0-9]*/, '');\r\n\r\n                    try {\r\n                        if (fs.existsSync(url)) {\r\n                            fs.createReadStream(url).pipe(res);\r\n                        } else {\r\n                            const ss = new Stream();\r\n                            ss.pipe = dest => dest.write('File not found');\r\n\r\n                            ss.pipe(res);\r\n                        }\r\n                    } catch (e) {\r\n                        const s = new Stream();\r\n                        s.pipe = dest => dest.write('File not found: ' + e);\r\n\r\n                        s.pipe(res);\r\n                    }\r\n                    return;\r\n                }\r\n                url = url.split('/');\r\n                // Skip first /\r\n                url.shift();\r\n                // Get ID\r\n                const id = url.shift() + '.admin';\r\n                url = url.join('/');\r\n                const pos = url.indexOf('?');\r\n                if (pos !== -1) {\r\n                    url = url.substring(0, pos);\r\n                }\r\n                adapter.readFile(id, url, null, (err, buffer, mimeType) => {\r\n                    if (!buffer || err) {\r\n                        res.contentType('text/html');\r\n                        res.status(404).send('File ' + escapeHtml(url) + ' not found');\r\n                    } else {\r\n                        if (mimeType) {\r\n                            res.contentType(mimeType['content-type'] || mimeType);\r\n                        } else {\r\n                            res.contentType('text/javascript');\r\n                        }\r\n                        res.send(buffer);\r\n                    }\r\n                });\r\n            });\r\n\r\n            server.server = LE.createServer(server.app, settings, adapter.config.certificates, adapter.config.leConfig, adapter.log);\r\n            server.server.__server = server;\r\n        } else {\r\n            adapter.log.error('port missing');\r\n            adapter.terminate ? adapter.terminate('port missing', 1) : process.exit(1);\r\n        }\r\n\r\n        if (server.server) {\r\n            settings.port = parseInt(settings.port, 10);\r\n\r\n            adapter.getPort(settings.port, port => {\r\n                if (port !== settings.port && !adapter.config.findNextPort) {\r\n                    adapter.log.error('port ' + settings.port + ' already in use');\r\n                    adapter.terminate ? adapter.terminate('port ' + settings.port + ' already in use', 1) : process.exit(1);\r\n                }\r\n                server.server.listen(port, (!settings.bind || settings.bind === '0.0.0.0') ? undefined : settings.bind || undefined);\r\n\r\n                adapter.log.info('http' + (settings.secure ? 's' : '') + ' server listening on port ' + port);\r\n                adapter.log.info('Use link \"http' + (settings.secure ? 's' : '') + '://localhost:' + port + '\" to configure.');\r\n\r\n                if (typeof onReady === 'function') {\r\n                    onReady(server.server, store);\r\n                }\r\n            });\r\n        }\r\n\r\n        if (server.server) {\r\n            return server;\r\n        } else {\r\n            return null;\r\n        }\r\n    })();\r\n\r\n    return this;\r\n}\r\n\r\nmodule.exports = Web;\r\n", "/**\r\n *      Admin backend\r\n *\r\n *      Controls Adapter-Processes\r\n *\r\n *      Copyright 2014-2019 bluefox <dogafox@gmail.com>,\r\n *      MIT License\r\n *\r\n */\r\n\r\n/* jshint -W097 */\r\n/* jshint strict: false */\r\n/* jslint node: true */\r\n'use strict';\r\n\r\nconst adapterName = require('./package.json').name.split('.').pop();\r\nconst utils       = require('@iobroker/adapter-core'); // Get common adapter utils\r\nconst tools \t  = require(utils.controllerDir + '/lib/tools.js');\r\nconst SocketIO    = require('./lib/socket');\r\nconst Web         = require('./lib/web');\r\n\r\nconst ONE_HOUR_MS = 3600000;\r\nconst ERROR_PERMISSION = 'permissionError';\r\n\r\nlet socket        = null;\r\nlet webServer     = null;\r\n\r\nlet objects       = {};\r\nlet secret        = 'Zgfr56gFe87jJOM'; // Will be generated by first start\r\nlet adapter;\r\n\r\nfunction startAdapter(options) {\r\n    options = options || {};\r\n\tObject.assign(options, {\r\n\t    name:           adapterName, // adapter name\r\n\t    dirname:        __dirname,   // say own position\r\n\t    logTransporter: true,        // receive the logs\r\n\t    systemConfig:   true,\r\n\t    install:        callback => typeof callback === 'function' && callback()\r\n\t});\r\n\r\n    adapter = new utils.Adapter(options);\r\n\r\n    adapter.on('objectChange', (id, obj) => {\r\n        if (obj) {\r\n            //console.log('objectChange: ' + id);\r\n            objects[id] = obj;\r\n\r\n            if (id === 'system.repositories') {\r\n                writeUpdateInfo();\r\n            }\r\n        } else {\r\n            //console.log('objectDeleted: ' + id);\r\n            if (objects[id]) {\r\n                delete objects[id];\r\n            }\r\n        }\r\n\r\n        // TODO Build in some threshold of messages\r\n        socket && socket.objectChange(id, obj);\r\n    });\r\n\r\n    adapter.on('stateChange', (id, state) =>\r\n        socket && socket.stateChange(id, state));\r\n\r\n    adapter.on('ready', () => {\r\n        adapter.getForeignObject('system.config', (err, obj) => {\r\n            if (!err && obj) {\r\n                obj.native = obj.native || {};\r\n                if (!obj.native.secret) {\r\n                    require('crypto').randomBytes(24, (ex, buf) => {\r\n                        adapter.config.secret = buf.toString('hex');\r\n                        adapter.extendForeignObject('system.config', {native: {secret: adapter.config.secret}});\r\n                        main();\r\n                    });\r\n                } else {\r\n                    adapter.config.secret = obj.native.secret;\r\n                    main();\r\n                }\r\n            } else {\r\n                adapter.config.secret = secret;\r\n                adapter.log.error('Cannot find object system.config');\r\n            }\r\n        });\r\n    });\r\n\r\n    adapter.on('message', obj => {\r\n        if (!obj || !obj.message) {\r\n            return false;\r\n        }\r\n\r\n        socket && socket.sendCommand(obj);\r\n\r\n        return true;\r\n    });\r\n\r\n    adapter.on('unload', callback => {\r\n        // unsubscribe all\r\n        socket && socket.unsubscribeAll();\r\n\r\n        try {\r\n            adapter.log.info('terminating http' + (adapter.config.secure ? 's' : '') + ' server on port ' + adapter.config.port);\r\n            webServer.close();\r\n            callback();\r\n        } catch (e) {\r\n            callback();\r\n        }\r\n    });\r\n\r\n// obj = {message: msg, severity: level, from: this.namespace, ts: (new Date()).getTime()}\r\n    adapter.on('log', obj => socket && socket.sendLog(obj));\r\n\r\n    return adapter;\r\n}\r\n\r\nfunction createUpdateInfo() {\r\n    // create connected object and state\r\n    let updatesNumberObj = objects[adapter.namespace + '.info.updatesNumber'];\r\n\r\n    if (!updatesNumberObj || !updatesNumberObj.common || updatesNumberObj.common.type !== 'number') {\r\n        let obj = {\r\n            _id:  'info.updatesNumber',\r\n            type: 'state',\r\n            common: {\r\n                role:  'indicator.updates',\r\n                name:  'Number of adapters to update',\r\n                type:  'number',\r\n                read:  true,\r\n                write: false,\r\n                def:   0\r\n            },\r\n            native: {}\r\n        };\r\n\r\n        adapter.setObject(obj._id, obj);\r\n    }\r\n\r\n    let updatesListObj = objects[adapter.namespace + '.info.updatesList'];\r\n\r\n    if (!updatesListObj || !updatesListObj.common || updatesListObj.common.type !== 'string') {\r\n        let obj = {\r\n            _id:  'info.updatesList',\r\n            type: 'state',\r\n            common: {\r\n                role:  'indicator.updates',\r\n                name:  'List of adapters to update',\r\n                type:  'string',\r\n                read:  true,\r\n                write: false,\r\n                def:   ''\r\n            },\r\n            native: {}\r\n        };\r\n\r\n        adapter.setObject(obj._id, obj);\r\n    }\r\n\r\n    let newUpdatesObj = objects[adapter.namespace + '.info.newUpdates'];\r\n\r\n    if (!newUpdatesObj || !newUpdatesObj.common || newUpdatesObj.common.type !== 'boolean') {\r\n        let obj = {\r\n            _id:  'info.newUpdates',\r\n            type: 'state',\r\n            common: {\r\n                role:  'indicator.updates',\r\n                name:  'Indicator if new adapter updates are available',\r\n                type:  'boolean',\r\n                read:  true,\r\n                write: false,\r\n                def:   false\r\n            },\r\n            native: {}\r\n        };\r\n\r\n        adapter.setObject(obj._id, obj);\r\n    }\r\n\r\n    let updatesJsonObj = objects[adapter.namespace + '.info.updatesJson'];\r\n\r\n    if (!updatesJsonObj || !updatesJsonObj.common || updatesJsonObj.common.type !== 'string') {\r\n        let obj = {\r\n            _id:  'info.updatesJson',\r\n            type: 'state',\r\n            common: {\r\n                role:  'indicator.updates',\r\n                name:  'JSON string with adapter update information',\r\n                type:  'string',\r\n                read:  true,\r\n                write: false,\r\n                def:   '{}'\r\n            },\r\n            native: {}\r\n        };\r\n\r\n        adapter.setObject(obj._id, obj);\r\n    }\r\n\r\n    let lastUpdateCheckObj = objects[adapter.namespace + '.info.lastUpdateCheck'];\r\n\r\n    if (!lastUpdateCheckObj || !lastUpdateCheckObj.common || lastUpdateCheckObj.common.type !== 'string') {\r\n        let obj = {\r\n            _id:  'info.lastUpdateCheck',\r\n            type: 'state',\r\n            common: {\r\n                role:  'value.datetime',\r\n                name:  'Timestamp of last update check',\r\n                type:  'string',\r\n                read:  true,\r\n                write: false,\r\n                def:   '{}'\r\n            },\r\n            native: {}\r\n        };\r\n\r\n        adapter.setObject(obj._id, obj);\r\n    }\r\n}\r\n\r\n// Helper methods\r\nfunction upToDate(a, b) {\r\n    a = a.split('.');\r\n    b = b.split('.');\r\n    a[0] = parseInt(a[0], 10);\r\n    b[0] = parseInt(b[0], 10);\r\n    if (a[0] > b[0]) {\r\n        return false;\r\n    } else if (a[0] < b[0]) {\r\n        return true;\r\n    } else if (a[0] === b[0]) {\r\n        a[1] = parseInt(a[1], 10);\r\n        b[1] = parseInt(b[1], 10);\r\n        if (a[1] > b[1]) {\r\n            return false;\r\n        } else if (a[1] < b[1]) {\r\n            return true;\r\n        } else if (a[1] === b[1]) {\r\n            a[2] = parseInt(a[2], 10);\r\n            b[2] = parseInt(b[2], 10);\r\n            return a[2] <= b[2];\r\n        }\r\n    } else {\r\n        return true;\r\n    }\r\n}\r\n\r\nfunction writeUpdateInfo(sources) {\r\n    if (!sources) {\r\n        let obj = objects['system.repositories'];\r\n        if (!objects['system.config'] || !objects['system.config'].common) {\r\n            adapter.log.warn('Repository cannot be read. Invalid \"system.config\" object.');\r\n            return;\r\n        }\r\n\r\n        const activeRepo = objects['system.config'].common.activeRepo;\r\n\r\n        if (obj && obj.native && obj.native.repositories && obj.native.repositories[activeRepo] &&\r\n            obj.native.repositories[activeRepo].json) {\r\n            sources = obj.native.repositories[activeRepo].json;\r\n        } else {\r\n            adapter.setState('info.updatesNumber', 0, true);\r\n            adapter.setState('info.updatesList',  '', true);\r\n            adapter.setState('info.newUpdates', false, true);\r\n            adapter.setState('info.updatesJson', '{}', true);\r\n            let updateTime = new Date();\r\n            adapter.setState('info.lastUpdateCheck', new Date(updateTime - updateTime.getTimezoneOffset() * 60000).toISOString(), true);\r\n            if (obj && obj.native && obj.native.repositories && obj.native.repositories[activeRepo]) {\r\n                adapter.log.warn('Repository cannot be read');\r\n            } else {\r\n                adapter.log.warn('No repository source configured');\r\n            }\r\n            return;\r\n        }\r\n    }\r\n\r\n    let installed = tools.getInstalledInfo();\r\n    let list  = [];\r\n    let updatesJson = {};\r\n    let newUpdateIndicator = false;\r\n    adapter.getState('info.updatesJson', (err, state) => {\r\n        let oldUpdates;\r\n        if (state && state.val) oldUpdates = JSON.parse(state.val) || {};\r\n        else oldUpdates = {};\r\n        for (let name in sources) {\r\n            if (!sources.hasOwnProperty(name)) continue;\r\n            if (installed[name] && installed[name].version && sources[name].version) {\r\n                if (sources[name].version !== installed[name].version &&\r\n                    !upToDate(sources[name].version, installed[name].version)) {\r\n                    // Check if updates are new or already known to user\r\n                    if (!oldUpdates || !oldUpdates[name] || oldUpdates[name].availableVersion !== sources[name].version) {\r\n                        newUpdateIndicator = true;\r\n                    } // endIf\r\n                    updatesJson[name] = {\r\n                        availableVersion: sources[name].version,\r\n                        installedVersion: installed[name].version\r\n                    };\r\n                    // remove first part of the name\r\n                    const n = name.indexOf('.');\r\n                    list.push(n === -1 ? name : name.substring(n + 1));\r\n                }\r\n            }\r\n        }\r\n        adapter.setState('info.updatesNumber', list.length, true);\r\n        adapter.setState('info.updatesList', list.join(', '), true);\r\n        adapter.setState('info.newUpdates', newUpdateIndicator, true);\r\n        adapter.setState('info.updatesJson', JSON.stringify(updatesJson), true);\r\n        let updateTime = new Date();\r\n        adapter.setState('info.lastUpdateCheck', new Date(updateTime - updateTime.getTimezoneOffset() * 60000).toISOString(), true);\r\n    });\r\n}\r\n\r\nfunction initSocket(server, store) {\r\n    socket = new SocketIO(server, adapter.config, adapter, objects, store);\r\n    socket.subscribe(null, 'objectChange', '*');\r\n}\r\n\r\nfunction main() {\r\n    // adapter.subscribeForeignStates('*');\r\n    // adapter.subscribeForeignObjects('*');\r\n\r\n    adapter.config.defaultUser = adapter.config.defaultUser || 'admin';\r\n    if (!adapter.config.defaultUser.match(/^system\\.user\\./)) {\r\n        adapter.config.defaultUser = 'system.user.' + adapter.config.defaultUser;\r\n    }\r\n\r\n    if (adapter.config.secure) {\r\n        // Load certificates\r\n        adapter.getCertificates((err, certificates, leConfig) => {\r\n            adapter.config.certificates = certificates;\r\n            adapter.config.leConfig     = leConfig;\r\n\r\n            getData(() => webServer = new Web(adapter.config, adapter, initSocket));\r\n        });\r\n    } else {\r\n        getData(() => webServer = new Web(adapter.config, adapter, initSocket));\r\n    }\r\n\r\n    // By default update repository every 24 hours\r\n    if (adapter.config.autoUpdate === undefined || adapter.config.autoUpdate === null) {\r\n        adapter.config.autoUpdate = 24;\r\n    }\r\n\r\n    // interval in hours\r\n    adapter.config.autoUpdate = parseInt(adapter.config.autoUpdate, 10) || 0;\r\n\r\n    adapter.config.autoUpdate && updateRegister();\r\n}\r\n\r\nfunction getData(callback) {\r\n    adapter.log.info('requesting all states');\r\n    /*\r\n    tasks++;\r\n\r\n    adapter.getForeignStates('*', (err, res) => {\r\n        adapter.log.info('received all states');\r\n        states = res;\r\n        !--tasks && callback && callback();\r\n    });*/\r\n\r\n    adapter.log.info('requesting all objects');\r\n\r\n    adapter.objects.getObjectList({include_docs: true}, (err, res) => {\r\n        adapter.log.info('received all objects');\r\n        if (res) {\r\n            res = res.rows;\r\n            objects = {};\r\n            let tmpPath = '';\r\n            for (let i = 0; i < res.length; i++) {\r\n                objects[res[i].doc._id] = res[i].doc;\r\n                if (res[i].doc.type === 'instance' && res[i].doc.common && res[i].doc.common.tmpPath) {\r\n                    tmpPath && adapter.log.warn('tmpPath has multiple definitions!!');\r\n                    tmpPath = res[i].doc.common.tmpPath;\r\n                }\r\n            }\r\n\r\n            // Some adapters want access on specified tmp directory\r\n            if (tmpPath) {\r\n                adapter.config.tmpPath = tmpPath;\r\n                adapter.config.tmpPathAllow = true;\r\n            }\r\n\r\n            createUpdateInfo();\r\n            writeUpdateInfo();\r\n        }\r\n\r\n        callback && callback();\r\n    });\r\n}\r\n\r\n// read repository information from active repository\r\nfunction updateRegister(isForce) {\r\n    adapter.getForeignObject('system.config', (err, systemConfig) => {\r\n        err && adapter.log.error('May not read \"system.config\"');\r\n\r\n        if (systemConfig && systemConfig.common) {\r\n            adapter.getForeignObject('system.repositories', (err, repos) => {\r\n                err && adapter.log.error('May not read \"system.repositories\"');\r\n                // Check if repositories exists\r\n                let exists = false;\r\n                const active = systemConfig.common.activeRepo;\r\n\r\n                // if repo is valid and actual\r\n                if (!err &&\r\n                    repos &&\r\n                    repos.native &&\r\n                    repos.native.repositories &&\r\n                    repos.native.repositories[active] &&\r\n                    Date.now() < repos.ts + adapter.config.autoUpdate * ONE_HOUR_MS) {\r\n                    exists = true;\r\n                }\r\n\r\n                if (!exists || isForce) {\r\n                    adapter.log.info('Request actual repository...');\r\n                    // request repo from host\r\n                    adapter.sendToHost(adapter.host, 'getRepository', {\r\n                        repo:   active,\r\n                        update: true\r\n                    }, _repository => {\r\n                        if (_repository === ERROR_PERMISSION) {\r\n                            adapter.log.error('May not read \"getRepository\"');\r\n                        } else {\r\n                            adapter.log.info('Repository received successfully.');\r\n\r\n                            socket && socket.repoUpdated();\r\n                        }\r\n\r\n                        // start next cycle\r\n                        if (adapter.config.autoUpdate) {\r\n                            adapter.timerRepo && clearInterval(adapter.timerRepo);\r\n                            adapter.log.debug('Next repo update on ' + new Date(Date.now() + adapter.config.autoUpdate * ONE_HOUR_MS + 1).toLocaleString());\r\n                            adapter.timerRepo = setTimeout(() => updateRegister(), adapter.config.autoUpdate * ONE_HOUR_MS + 1);\r\n                        }\r\n                    });\r\n                } else if (adapter.config.autoUpdate) {\r\n                    const interval = repos.ts + adapter.config.autoUpdate * ONE_HOUR_MS - Date.now() + 1;\r\n                    adapter.log.debug('Next repo update on ' + new Date(Date.now() + interval).toLocaleString());\r\n                    adapter.timerRepo && clearInterval(adapter.timerRepo);\r\n                    adapter.timerRepo = setTimeout(() => updateRegister(), interval);\r\n                }\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n// If started as allInOne mode => return function to create instance\r\nif (module && module.parent) {\r\n    module.exports = startAdapter;\r\n} else {\r\n    // or start the instance directly\r\n    startAdapter();\r\n}\r\n", "{\n  \"name\": \"iobroker.admin\",\n  \"description\": \"The adapter opens a webserver for the ioBroker admin UI.\",\n  \"version\": \"3.6.8\",\n  \"contributors\": [\n    \"bluefox <dogafox@gmail.com>\",\n    \"apollon77\",\n    \"soef <soef@gmx.net>\",\n    \"hobbyquaker <hq@ccu.io>\"\n  ],\n  \"homepage\": \"https://github.com/ioBroker/ioBroker.admin\",\n  \"repository\": {\n    \"type\": \"git\",\n    \"url\": \"https://github.com/ioBroker/ioBroker.admin\"\n  },\n  \"license\": \"MIT\",\n  \"keywords\": [\n    \"ioBroker\",\n    \"setup\"\n  ],\n  \"dependencies\": {\n    \"body-parser\": \"^1.19.0\",\n    \"connect-flash\": \"^0.1.1\",\n    \"cookie-parser\": \"^1.4.4\",\n    \"express\": \"^4.17.1\",\n    \"express-fileupload\": \"^1.1.6-alpha.5\",\n    \"express-session\": \"^1.16.2\",\n    \"passport\": \"^0.4.0\",\n    \"passport-local\": \"^1.0.0\",\n    \"passport.socketio\": \"^3.7.0\",\n    \"request\": \"^2.88.0\",\n    \"socket.io\": \"1.7.2\",\n    \"xtend\": \"^4.0.2\",\n    \"@iobroker/adapter-core\": \"^1.0.3\"\n  },\n  \"devDependencies\": {\n    \"@iobroker/testing\": \"^1.2.5\",\n    \"@babel/core\": \"^7.6.3\",\n    \"@babel/plugin-transform-arrow-functions\": \"^7.2.0\",\n    \"@babel/plugin-transform-block-scoping\": \"^7.6.3\",\n    \"@babel/plugin-transform-classes\": \"^7.5.5\",\n    \"@babel/plugin-transform-template-literals\": \"^7.4.4\",\n    \"chai\": \"^4.2.0\",\n    \"gulp\": \"^4.0.2\",\n    \"gulp-babel\": \"^8.0.0\",\n    \"gulp-clean-css\": \"^4.2.0\",\n    \"gulp-concat\": \"^2.6.1\",\n    \"gulp-htmlmin\": \"^5.0.1\",\n    \"gulp-less\": \"^4.0.1\",\n    \"gulp-sass\": \"^4.0.2\",\n    \"gulp-sourcemaps\": \"^2.6.5\",\n    \"gulp-terser\": \"^1.2.0\",\n    \"fancy-log\": \"^1.3.3\",\n    \"ansi-colors\": \"^4.1.1\",\n    \"materialize-css\": \"^1.0.0\",\n    \"mocha\": \"^6.2.1\"\n  },\n  \"bugs\": {\n    \"url\": \"https://github.com/ioBroker/ioBroker.admin/issues\"\n  },\n  \"main\": \"main.js\",\n  \"scripts\": {\n    \"test\": \"npm run test:package && npm run test:unit\",\n    \"prepare\": \"node node_modules/gulp/bin/gulp default\",\n    \"test:package\": \"mocha test/package --exit\",\n    \"test:unit\": \"mocha test/unit --exit\",\n    \"test:integration\": \"mocha test/integration --exit\"\n  },\n  \"author\": \"bluefox <dogafox@gmail.com>\"\n}\n", "/* jshint -W097 */\n/* jshint strict:true */\n/* jslint consts: true */\n/* global io:false */\n/* global jQuery:false */\n/* jslint browser:true */\n/* jshint browser:true */\n/* global _ */\n/* global ace */\n/* global console */\n/* global alert */\n/* global confirm */\n/* global systemLang: true */\n/* global license */\n/* global translateAll */\n/* global initGridLanguage, M, storage, decodeURI, States */\n'use strict';\n\n//if (typeof Worker === 'undefined') alert('your browser does not support WebWorkers :-(');\n\nArray.prototype.remove = function () {\n    let what;\n    const a = arguments;\n    let L = a.length;\n    let ax;\n    while (L && this.length) {\n        what = a[--L];\n        while ((ax = this.indexOf(what)) !== -1) {\n            this.splice(ax, 1);\n        }\n    }\n    return this;\n};\n// for IE\nif (!console.debug) {\n    console.debug = console.log;\n}\nif (typeof Number === 'undefined') {\n    console.log('define Number');\n    Number = function (obj) {\n        return parseFloat(obj);\n    };\n}\nif (!Object.assign) {\n    Object.assign = $.extend;\n}\n\nasync function asyncForEach(array, callback) {\n    for (let index = 0; index < array.length; index++) {\n        await callback(array [index], index, array);\n    }\n}\n\nlet $iframeDialog = null;  // used in adapter settings window\nlet configNotSaved = null; // used in adapter settings window\nlet showConfig = null;     // used in adapter settings window\n\nconst defaults = {};\nconst customPostInits = {};\nconst customPostOnSave = {};\nconst FORBIDDEN_CHARS = /[\\]\\[*,;'\"`<>\\\\\\s?]/g;\n\n// used in adapter settings window\nconst adapterRedirect = function (redirect, timeout) {\n    if (redirect) {\n        setTimeout(function () {\n            redirect += document.location.pathname;\n            redirect += document.location.hash;\n            document.location.href = redirect;\n        }, timeout || 5000);\n    }\n};\nlet gMain = null; // for google maps\n\nfunction detectIE() {\n    const ua = window.navigator.userAgent;\n\n    const msie = ua.indexOf('MSIE ');\n    if (msie > 0) {\n        // IE 10 or older => return version number\n        return parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10);\n    }\n\n    const trident = ua.indexOf('Trident/');\n    if (trident > 0) {\n        // IE 11 => return version number\n        const rv = ua.indexOf('rv:');\n        return parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10);\n    }\n\n    const edge = ua.indexOf('Edge/');\n    if (edge > 0) {\n        // Edge (IE 12+) => return version number\n        return parseInt(ua.substring(edge + 5, ua.indexOf('.', edge)), 10);\n    }\n\n    // other browser\n    return false;\n}\n\n(function ($) {\n$(document).ready(function () {\n    let path = location.pathname + 'socket.io';\n    if (location.pathname.match(/^\\/admin\\//)) {\n        path = '/socket.io';\n    }\n\n    let allTabs = {};\n\n    const main = {\n        objects:        {},\n        states:         {},\n        currentHost:    '',\n        currentTab:     null,\n        currentDialog:  null,\n        currentUser:    '',\n        subscribesStates: {},\n        subscribesObjects: {},\n        subscribesLogs: 0,\n        socket:         io.connect('/', {path: path}),\n        systemConfig:   null,\n        instances:      null,\n        objectsLoaded:  false,\n        waitForRestart: false,\n        tabs:           null,\n        dialogs:        {},\n        selectId:       null,\n        config:         {},\n        //ignoreJSupdate: false, // set to true after some global script updated and till system.adapter.javascript.x updated\n        addEventMessage: function (id, stateOrObj, isMessage, isState) {\n            // cannot directly use tabs.events.add, because to init time not available.\n            tabs.events.add(id, stateOrObj, isMessage, isState);\n        },\n        saveConfig:     function (attr, value) {\n            if (attr) main.config[attr] = value;\n\n            if (typeof storage !== 'undefined') {\n                storage.set('adminConfig', JSON.stringify(main.config));\n            }\n        },\n        saveTabs:       function () {\n            this.socket.emit ('setObject', 'system.config', this.systemConfig, function (err) {\n                err && this.showError(err);\n            });\n        },\n\n        // Helper methods\n        upToDate:       function (_new, old) {\n            _new = _new.split('.');\n            old = old.split('.');\n            _new[0] = parseInt(_new[0], 10);\n            old[0] = parseInt(old[0], 10);\n            if (_new[0] > old[0]) {\n                return false;\n            } else if (_new[0] === old[0]) {\n                _new[1] = parseInt(_new[1], 10);\n                old[1] = parseInt(old[1], 10);\n                if (_new[1] > old[1]) {\n                    return false;\n                } else if (_new[1] === old[1]) {\n                    _new[2] = parseInt(_new[2], 10);\n                    old[2] = parseInt(old[2], 10);\n                    return (_new[2] <= old[2]);\n                } else {\n                    return true;\n                }\n            } else {\n                return true;\n            }\n        },\n\n        // Methods\n        cmdExec:        function (host, cmd, callback) {\n            host = host || main.currentHost;\n            $stdout.val('');\n\n            $dialogCommand.modal('open');\n\n            stdout = '$ ./iobroker ' + cmd;\n            $dialogCommand.data('finished', false).find('.btn').html(_('In background'));\n            $dialogCommand.find('.command').html(stdout);\n            $dialogCommand.find('.progress-dont-close').removeClass('disabled');\n            $adminSideMain.find('.button-command').removeClass('error').addClass('in-progress');\n            $dialogCommand.data('max', null);\n            $dialogCommand.data('error', '');\n            $dialogCommandProgress.addClass('indeterminate').removeClass('determinate');\n\n            if (cmd.match(/^upload /)) {\n                $dialogCommand.find('.progress-text').html(_('Upload started...')).removeClass('error');\n            } else if (cmd.match(/^del [-_\\w\\d]+\\.[\\d]+$/)) {\n                $dialogCommand.find('.progress-text').html(_('Removing of instance...')).removeClass('error');\n            } else if (cmd.match(/^del /)) {\n                $dialogCommand.find('.progress-text').html(_('Removing of adapter...')).removeClass('error');\n            } else if (cmd.match(/^url /)) {\n                $dialogCommand.find('.progress-text').html(_('Install or update from URL...')).removeClass('error');\n            }  else if (cmd.match(/^add /)) {\n                $dialogCommand.find('.progress-text').html(_('Add instance...')).removeClass('error');\n            } else{\n                $dialogCommand.find('.progress-text').html(_('Started...')).removeClass('error');\n            }\n\n            $stdout.val(stdout);\n            // generate the unique id to coordinate the outputs\n            activeCmdId = Math.floor(Math.random() * 0xFFFFFFE) + 1;\n            cmdCallback = callback;\n            main.socket.emit('cmdExec', host, activeCmdId, cmd, function (err) {\n                if (err) {\n                    stdout += '\\n' + _(err);\n                    $stdout.val(stdout);\n                    cmdCallback = null;\n                    callback(err);\n                } else {\n                    if (callback) callback();\n                }\n            });\n        },\n        confirmMessage: function (message, title, icon, buttons, callback) {\n            // if standard buttons\n            if (typeof buttons === 'function') {\n                callback = buttons;\n                $dialogConfirm.find('.modal-footer').html(\n                    '<a class=\"modal-action modal-close waves-effect waves-green btn-flat translate\" data-result=\"true\">' + _('Ok') + '</a>' +\n                    '<a class=\"modal-action modal-close waves-effect waves-green btn-flat translate\">' + _('Cancel') + '</a>');\n                $dialogConfirm.find('.modal-footer .modal-action').on('click', function () {\n                    const cb = $dialogConfirm.data('callback');\n                    cb && cb($(this).data('result'));\n                });\n            } else if (typeof buttons === 'object') {\n                let tButtons = '';\n                for (let b = buttons.length - 1; b >= 0; b--) {\n                    tButtons += '<a class=\"modal-action modal-close waves-effect waves-green btn-flat translate\" data-id=\"' + b + '\">' + buttons[b] + '</a>';\n                }\n                $dialogConfirm.find('.modal-footer').html(tButtons);\n                $dialogConfirm.find('.modal-footer .modal-action').on('click', function () {\n                    const cb = $dialogConfirm.data('callback');\n                    cb && cb($(this).data('id'));\n                });\n            }\n\n            $dialogConfirm.find('.dialog-title').text(title || _('Please confirm'));\n            if (icon) {\n                $dialogConfirm.find('.dialog-icon')\n                    .show()\n                    .html(icon);\n            } else {\n                $dialogConfirm.find('.dialog-icon').hide();\n            }\n            $dialogConfirm.find('.dialog-text').html(message);\n            $dialogConfirm.data('callback', callback);\n            $dialogConfirm.modal('open');\n        },\n        showMessage:    function (message, title, icon) {\n            $dialogMessage.find('.dialog-title').text(title || _('Message'));\n            if (icon) {\n                $dialogMessage.find('.dialog-icon')\n                    .show()\n                    .html(icon);\n            } else {\n                $dialogMessage.find('.dialog-icon').hide();\n            }\n            $dialogMessage.find('.dialog-text').html(message);\n            $dialogMessage.modal('open');\n        },\n        showError:      function (error) {\n            main.showMessage(_(error),  _('Error'), 'error_outline');\n        },\n        showToast:      function (parent, message, icon, duration, isError, classes) {\n            if (parent && parent instanceof jQuery) {\n                parent = parent[0];\n            }\n            classes = classes || [];\n\n            if (typeof classes === 'string') {\n                classes = [classes];\n            }\n            isError && classes.push('dropZone-error');\n\n            M.toast({\n                parentSelector: parent || $('body')[0],\n                html:           message + (icon ? '<i class=\"material-icons\">' + icon + '</i>' : ''),\n                displayLength:  duration || 3000,\n                classes:        classes\n            });\n        },\n        formatDate:     function (dateObj, justTime) {\n            //return dateObj.getFullYear() + '-' +\n            //    (\"0\" + (dateObj.getMonth() + 1).toString(10)).slice(-2) + '-' +\n            //    (\"0\" + (dateObj.getDate()).toString(10)).slice(-2) + ' ' +\n            //    (\"0\" + (dateObj.getHours()).toString(10)).slice(-2) + ':' +\n            //    (\"0\" + (dateObj.getMinutes()).toString(10)).slice(-2) + ':' +\n            //    (\"0\" + (dateObj.getSeconds()).toString(10)).slice(-2);\n            // Following implementation is 5 times faster\n            if (!dateObj) return '';\n            let text = typeof dateObj;\n            if (text === 'string') {\n                if (justTime) {\n                    return dateObj.substring(8);\n                } else {\n                    return dateObj;\n                }\n            }\n            // if less 2000.01.01 00:00:00\n            if (text !== 'object') dateObj = dateObj < 946681200000 ? new Date(dateObj * 1000) : new Date(dateObj);\n\n            let v;\n            if (!justTime) {\n                text = dateObj.getFullYear();\n                v = dateObj.getMonth() + 1;\n                if (v < 10) {\n                    text += '-0' + v;\n                } else {\n                    text += '-' + v;\n                }\n\n                v = dateObj.getDate();\n                if (v < 10) {\n                    text += '-0' + v;\n                } else {\n                    text += '-' + v;\n                }\n            } else {\n                v = dateObj.getDate();\n                if (v < 10) {\n                    text = '0' + v;\n                } else {\n                    text = v;\n                }\n            }\n\n            v = dateObj.getHours();\n            if (v < 10) {\n                text += ' 0' + v;\n            } else {\n                text += ' ' + v;\n            }\n            v = dateObj.getMinutes();\n            if (v < 10) {\n                text += ':0' + v;\n            } else {\n                text += ':' + v;\n            }\n\n            v = dateObj.getSeconds();\n            if (v < 10) {\n                text += ':0' + v;\n            } else {\n                text += ':' + v;\n            }\n\n            v = dateObj.getMilliseconds();\n            if (v < 10) {\n                text += '.00' + v;\n            } else if (v < 100) {\n                text += '.0' + v;\n            } else {\n                text += '.' + v;\n            }\n\n            return text;\n        },\n        /*initSelectId:   function () {\n            if (main.selectId) return main.selectId;\n            main.selectId = $('#dialog-select-member').selectId('init',  {\n                objects: main.objects,\n                states:  main.states,\n                filter: {type: 'state'},\n                name:   'admin-select-member',\n                texts: {\n                    select:   _('Select'),\n                    cancel:   _('Cancel'),\n                    all:      _('All'),\n                    id:       _('ID'),\n                    name:     _('Name'),\n                    role:     _('Role'),\n                    room:     _('Room'),\n                    value:    _('Value'),\n                    selectid: _('Select ID'),\n                    from:     _('From'),\n                    lc:       _('Last changed'),\n                    ts:       _('Time stamp'),\n                    wait:     _('Processing...'),\n                    ack:      _('Acknowledged')\n                },\n                columns: ['image', 'name', 'role', 'room', 'value']\n            });\n            return main.selectId;\n        },*/\n        updateWizard:   function () {\n            const $wizard = $('#button-wizard');\n            if (main.objects['system.adapter.discovery.0']) {\n                if (!$wizard.data('inited')) {\n                    $wizard.data('inited', true);\n                    $wizard/*.button({\n                        icons: {primary: ' ui-icon-search'},\n                        text: false\n                    })*/.on('click', function () {\n                        // open configuration dialog\n                        main.navigate({\n                            tab: 'instances',\n                            dialog: 'config',\n                            params: 'system.adapter.discovery.0'\n                        });\n                    }).attr('title', _('Device discovery'));\n                }\n                $wizard.show();\n\n                // Show wizard dialog\n                if (!main.systemConfig.common.wizard && main.systemConfig.common.licenseConfirmed) {\n                    $wizard.trigger('click');\n                }\n            } else {\n                $wizard.hide();\n            }\n        },\n        getUser:        function () {\n            if (!main.currentUser) {\n                main.socket.emit('authEnabled', function (auth, user) {\n                    main.currentUser = 'system.user.' + user;\n                    if (!auth) {\n                        $('#button-logout').remove();\n                    } else {\n                        main._lastTimer = Date.now();\n                        monitor();\n                    }\n                });\n            } else if (main.objects[main.currentUser]) {\n                const obj = main.objects[main.currentUser];\n                let name = '';\n                if (!obj || !obj.common || !obj.common.name) {\n                    name = main.currentUser.replace(/^system\\.user\\./);\n                    name = name[0].toUpperCase() + name.substring(1).toLowerCase();\n                } else {\n                    name = translateName(obj.common.name);\n                }\n                if (obj && obj.common && obj.common.icon) {\n                    const objs = {};\n                    objs[main.currentUser] = obj;\n                    $('#current-user-icon').html(main.getIcon(main.currentUser, null, objs));\n                } else {\n                    $('#current-user-icon').html('<i class=\"large material-icons\">account_circle</i>');\n                }\n                $('#current-user').html(name);\n                const groups = [];\n                for (let i = 0; i < tabs.users.groups.length; i++) {\n                    const group = main.objects[tabs.users.groups[i]];\n                    if (group && group.common && group.common.members && group.common.members.indexOf(main.currentUser) !== -1) {\n                        groups.push(_(translateName(group.common.name)));\n                    }\n                }\n                $('#current-group').html(groups.join(', '));\n            }\n        },\n\n        // Delete objects\n        _delObject:     function (idOrList, callback) {\n            let id;\n            if (!Array.isArray(idOrList)) {\n                if (typeof idOrList !== 'string') return callback && callback('invalid idOrList parameter');\n                idOrList = [idOrList];\n            }\n\n            function doIt() {\n                if (idOrList.length === 0) {\n                    return callback && setTimeout(callback, 0, null, id);\n                }\n                id = idOrList.pop();\n                if (main.objects[id] && main.objects[id].common && (main.objects[id].common['object-non-deletable'] || main.objects[id].common.dontDelete)) {\n                    main.showMessage (_ ('Cannot delete \"%s\" because not allowed', id), '', 'notifications');\n                    setTimeout(doIt, 0);\n                } else {\n                    const obj = main.objects[id];\n                    main.socket.emit('delObject', id, function (err) {\n                        if (err && err !== 'Not exists') {\n                            main.showError (err);\n                            return callback(err);\n                        }\n                        if (obj && obj.type === 'state') {\n                            main.socket.emit ('delState', id, function (err) {\n                                if (err && err !== 'Not exists') {\n                                    main.showError (err);\n                                    return callback(err);\n                                }\n                                setTimeout(doIt, 0);\n                            });\n                        } else {\n                            setTimeout(doIt, 0);\n                        }\n                    });\n                }\n            }\n            doIt();\n        },\n        _delObjects:    function (rootId, isAll, callback) {\n            if (!isAll) {\n                this._delObject(rootId, callback);\n            } else {\n                const list = [];\n                for (const id in main.objects) {\n                    if (main.objects.hasOwnProperty(id) && id.substring(0, rootId.length + 1) === rootId + '.') {\n                        list.push(id);\n                    }\n                }\n                list.push(rootId);\n                list.sort();\n\n                this._delObject(list, function () {\n                    if (callback) callback();\n                });\n            }\n        },\n        delObject:      function ($tree, id, callback) {\n            const leaf = $tree ? $tree.selectId('getTreeInfo', id) : null;\n            if (main.objects[id]) {\n                if (leaf && leaf.children) {\n                    // ask if only object must be deleted or just this one\n                    main.confirmMessage(_('Do you want to delete just <span style=\"color: blue\">one object</span> or <span style=\"color: red\">all</span> children of %s too?', id), null, 'help_outline', [_('_All'), _('Only one'), _('Cancel')], function (result) {\n                        // If all\n                        if (result === 0) {\n                            main._delObjects(id, true, callback);\n                        } else\n                        // if only one object\n                        if (result === 1) {\n                            main._delObjects(id, false, callback);\n                        } // else do nothing\n                    });\n                } else {\n                    main.confirmMessage(_('Are you sure to delete %s?', id), null, 'help_outline', function (result) {\n                        // If all\n                        if (result) main._delObjects(id, true, callback);\n                    });\n                }\n            } else if (leaf && leaf.children) {\n                main.confirmMessage(_('Are you sure to delete all children of %s?', id), null, 'help_outline', function (result) {\n                    // If all\n                    if (result) main._delObjects(id, true, callback);\n                });\n            } else {\n                main.showMessage(_('Object \"<b>%s</b>\" does not exists. Update the page.', id), _('Error'), 'help_outline', function (result) {\n                    // If all\n                    if (result) main._delObjects(id, true, callback);\n                });\n            }\n        }\n    };\n\n    gMain = main; // for google maps\n\n    const tabs = {\n        hosts:      new Hosts(main), // must be first to read the list of hosts\n        objects:    new Objects(main),\n        adapters:   new Adapters(main),\n        instances:  new Instances(main),\n        users:      new Users(main),\n        enums:      new Enums(main),\n        events:     new Events(main),\n        logs:       new Logs(main),\n        states:     null,\n        intro:      new Intro(main),\n        info:       new InfoAdapter(main)\n    };\n\n    if (typeof States !== 'undefined') {\n        tabs.states = new States(main);\n    }\n\n    main.instances     = tabs.instances.list;\n    main.tabs          = tabs;\n    main.dialogs       = {\n        system:     new System(main),\n        customs:    new Customs(main),\n        config:     new Config(main),\n        editobject: new EditObject(main),\n        issue:      new Issue(main),\n        readme:     new Readme(main)\n    };\n\n    let stdout;\n    let cmdCallback      = null;\n    let activeCmdId      = null;\n    const $stdout        = $('#stdout');\n\n    const $dialogCommand = $('#dialog-command');\n    const $dialogLicense = $('#dialog-license-main');\n    const $dialogMessage = $('#dialog-message');\n    const $dialogConfirm = $('#dialog-confirm');\n    const $dialogCommandProgress = $dialogCommand.find('.progress div');\n\n    const $adminSideMenu = $('#admin_sidemenu_menu');\n    const $adminSideMain = $('#admin_sidemenu_main');\n\n    let firstConnect     = true;\n\n    // detect touch devices\n    if (!('ontouchstart' in window || navigator.maxTouchPoints)) {\n        $('body').addClass('desktop-screen');\n    }\n    if (navigator.userAgent.indexOf('Safari') !== -1 &&\n        navigator.userAgent.indexOf('Chrome') === -1 &&\n        navigator.userAgent.indexOf('Android') === -1) {\n        $('body').addClass('safari');\n        main.browser = 'safari';\n        main.noSelect = true;\n    } else if (detectIE()) {\n        $('body').addClass('ie');\n        // workaround\n        main.browser = 'ie';\n        main.browserVersion = detectIE();\n        main.noSelect = true;\n        $('#host-adapters-btn').css('margin-top', '10px');\n    }\n\n    // Read all positions, selected widgets for every view,\n    // Selected view, selected menu page,\n    // Selected widget or view page\n    // Selected filter\n    if (typeof storage !== 'undefined') {\n        try {\n            main.config = storage.get('adminConfig');\n            if (main.config) {\n                main.config = JSON.parse(main.config);\n            } else {\n                main.config = {};\n            }\n        } catch (e) {\n            console.log('Cannot load edit config');\n            main.config = {};\n        }\n    }\n\n    function globalClickHandler(event){\n        $('#admin_sidemenu_dialog').html('');\n        $('html').off('click', globalClickHandler);\n    }\n\n    function initHtmlButtons() {\n        main.socket.emit('getVersion', function (err, version) {\n\t\t\tconst $versionBtn = $('.button-version');\n\t        if (!$versionBtn.hasClass('vendor')) {\n\t            $versionBtn.text('ioBroker.admin ' + version);\n\t        }\n        });\n\n        $('.choose-tabs-config-button').off('click').on('click', function(event) {\n            const $dialog = $('#admin_sidemenu_dialog');\n            const html = $dialog.html();\n            if (html) {\n                $dialog.html('');\n                // disable global handler\n                $('html').off('click', globalClickHandler);\n                return;\n            }\n            setTimeout(function () {\n                // enable global handler\n                $('html').on('click', globalClickHandler);\n            }, 100);\n            const $e = $(event.target);\n            const offs = $e.offset();\n            offs.top += $e.height() - 2;\n\n            let text =\n                '<dialog open class=\"tab-selector m\" style=\"top: ' + offs.top + 'px; left: ' + offs.left + 'px;\">' + // style=\"overflow: visible; z-index: 999; \">'\n                '<div>' +\n                '<ul style=\"\">';\n\n            const $lis = $adminSideMenu;\n            for (const tid in allTabs) {\n                const name = allTabs[tid];\n                const found = $adminSideMenu.find('.admin-sidemenu-items[data-tab=\"' + tid + '\"]').length;\n                // TABS\n                /*$adminSideMenu.each(function (i, e) {\n                    if (tid === $(e).attr('aria-controls')) {\n                        found = $(e);\n                        return false;\n                    }\n                });*/\n                const id = 'chk-' + tid;\n                text +=\n                    '<li><input ' + (found ? 'checked' : 'unchecked') + ' class=\"chk-tab filled-in\" type=\"checkbox\" id=\"' + id + '\" />' +\n                    '<span for=\"' + id + '\">' + _(name) + '</span></id>';\n            }\n            text += '' +\n                '</ul>' +\n                '</div>' +\n                '</dialog>';\n            $dialog.append(text);\n\n            $dialog.find('.chk-tab').off('change').on('change', function (event) {\n                const id = $(this).attr('id').substr(4);\n                if ($(this).prop('checked')) {\n                    main.systemConfig.common.tabs.push(id);\n                } else {\n                    const pos = main.systemConfig.common.tabs.indexOf(id);\n                    if (id !== -1) {\n                        main.systemConfig.common.tabs.splice(pos, 1);\n                    }\n                }\n                main.saveTabs();\n                initTabs();\n            });\n            // workaround for materialize checkbox problem\n            $dialog.find('input[type=\"checkbox\"]+span').off('click').on('click', function () {\n                const $input = $(this).prev();\n                if (!$input.prop('disabled')) {\n                    $input.prop('checked', !$input.prop('checked')).trigger('change');\n                }\n            });\n        });\n\n        main.updateWizard();\n\n        $('#button-logout').on('click', function () {\n            window.location.href = '/logout/';\n        });\n\n        setTimeout(function () {\n            main.tabs.info.init();\n        }, 5000);\n\n        window.onhashchange = function () {\n            main.navigateDo();\n        };\n        main.navigateDo();\n    }\n\n    function initHtmlTabs() {\n        // jQuery UI initializations\n        initSideNav();\n\n        if (!main.tabsInited) {\n            main.tabsInited = true;\n\n            initHtmlButtons();\n\n            $('#events_threshold').on('click', function () {\n                main.socket.emit('eventsThreshold', false);\n            });\n        } else {\n            const $menu = $adminSideMenu;\n            const panelSelector = $menu.data('problem-link');\n            if (panelSelector) {\n                const $panel = $(panelSelector);\n                // Init source for iframe\n                if ($panel.length) {\n                    const link = $panel.data('src');\n                    if (link && link.indexOf('%') === -1) {\n                        const $iframe = $panel.find('iframe');\n                        if ($iframe.length && !$iframe.attr('src')) {\n                            $iframe.attr('src', link);\n                            $menu.data('problem-link', null);\n                        }\n                    }\n                }\n            }\n            // show current tab\n            main.currentHash = null;\n            main.navigateDo();\n        }\n    }\n\n    function initTabs() {\n        // extract all additional instances\n        let text      = '';\n        const list    = [];\n        const addTabs = [];\n\n        allTabs = {};\n        for (let i = 0; i < main.instances.length; i++) {\n            const instance = main.instances[i];\n            const instanceObj = main.objects[instance];\n            if (!instanceObj.common || !instanceObj.common.adminTab) continue;\n            if (instanceObj.common.adminTab.singleton) {\n                let isFound = false;\n                const inst1 = instance.replace(/\\.(\\d+)$/, '.');\n                for (let j = 0; j < addTabs.length; j++) {\n                    const inst2 = addTabs[j].replace(/\\.(\\d+)$/, '.');\n                    if (inst1 === inst2) {\n                        isFound = true;\n                        break;\n                    }\n                }\n                if (!isFound) addTabs.push(instance);\n            } else {\n                addTabs.push(instance);\n            }\n        }\n\n        // Build the standard tabs together\n        $('.admin-tab').each(function () {\n            const $this = $(this);\n            const id = $this.attr('id');\n            list.push(id);\n            allTabs[id] = $this.data('name');\n        });\n\n        // Look for adapter tabs\n        for (let a = 0; a < addTabs.length; a++) {\n            const tab = main.objects[addTabs[a]];\n            let name  = 'tab-' + tab.common.name;\n\n            let link  = tab.common.adminTab.link || '/adapter/' + tab.common.name + '/tab.html';\n            if (tab.common.materializeTab) {\n                link  = tab.common.adminTab.link || '/adapter/' + tab.common.name + '/tab_m.html';\n            }\n\n            const parts = addTabs[a].split('.');\n            let buttonName;\n\n            if (tab.common.adminTab.name) {\n                if (typeof tab.common.adminTab.name === 'object') {\n                    if (tab.common.adminTab.name[systemLang]) {\n                        buttonName = tab.common.adminTab.name[systemLang];\n                    } else if (tab.common.adminTab.name.en) {\n                        buttonName = _(tab.common.adminTab.name.en);\n                    } else {\n                        buttonName = _(tab.common.name);\n                    }\n                } else {\n                    buttonName = _(tab.common.adminTab.name);\n                }\n            } else {\n                buttonName = _(tab.common.name);\n            }\n\n            if (!tab.common.adminTab.singleton) {\n                if (link.indexOf('?') !== -1) {\n                    link += '&instance=' + parts[3];\n                } else {\n                    link += '?instance=' + parts[3];\n                }\n                buttonName += '.' + parts[3];\n                name += '-' + parts[3];\n            } else {\n                parts[3] = 0;\n            }\n\n            list.push(name);\n            allTabs[name] = buttonName;\n\n            if (!main.systemConfig.common.tabs || main.systemConfig.common.tabs.indexOf(name) !==-1) {\n                let isReplace = false;\n                if (!link) {\n                    link = '/adapter/' + parts[2] + '/tab.html';\n                    if (tab.common.materilizeTab) {\n                        link = '/adapter/' + parts[2] + '/tab_m.html';\n                    }\n                } else {\n                    isReplace = link.indexOf('%') !== -1;\n                }\n\n                text += '<li><a href=\"#' + name + '\">' + buttonName + '</a></li>\\n';\n\n                // noinspection JSJQueryEfficiency\n                if (!$('#' + name).length) {\n                    const div = '<div id=\"' + name + '\" data-name=\"' + buttonName + '\" class=\"tab-custom ' + (isReplace ? 'link-replace' : '') + '\" data-adapter=\"' + parts[2] + '\" data-instance=\"' + parts[3] + '\" data-src=\"' + link + '\">' +\n                        '<iframe class=\"iframe-in-tab\" style=\"border: 0; solid #FFF; display: block; left: 0; top: 0; width: 100%; height: 100%\"' +\n                        '></iframe></div>';\n                    $(div).hide().appendTo($('body'));\n\n                    // TODO: temporary, until other tab will be adapted\n                    $('#' + name).find ('.iframe-in-tab').on('load', function () {\n                        let elem = $ (this).contents ().find('body>header');\n                        if (!elem || !elem.length) {\n                            elem = $(this).contents ().find('head');\n                        }\n                        if (elem && elem.length) {\n                            elem.append('<link rel=\"stylesheet\" type=\"text/css\" href=\"../../lib/css/iob/selectID.css\"/>');\n                        }\n                    });\n                } else {\n                    $('#' + name).hide().appendTo($('body'));\n                }\n            } else {\n                $('#' + name).hide().appendTo($('body'));\n            }\n        }\n        $('.tab-custom').each(function () {\n            if (list.indexOf($(this).attr('id')) === -1) {\n                $('#' + $(this).attr('id')).remove();\n            }\n        });\n\n        if (!main.systemConfig.common.tabs) main.systemConfig.common.tabs = list;\n\n        if ($('.link-replace').length) {\n            let countLink = 0;\n\n            // If some objects cannot be read => go by timeout\n            let loadTimeout = setTimeout(function() {\n                loadTimeout = null;\n                initHtmlTabs(/*showTabs*/);\n            }, 100);\n\n            $('.link-replace').each(function () {\n                // convert \"http://%ip%:%port%\" to \"http://localhost:1880\"\n                countLink++;\n                main.tabs.instances._replaceLinks($(this).data('src'), $(this).data('adapter'), $(this).data('instance'), $(this).attr('id'), function (link, adapter, instance, arg) {\n                    $('#' + arg).data('src', link).removeClass('link-replace');\n                    if (!--countLink) {\n                        if (loadTimeout) {\n                            clearTimeout(loadTimeout);\n                            loadTimeout = null;\n                            initHtmlTabs(/*showTabs*/);\n                        }\n                    }\n                });\n            });\n        } else {\n            initHtmlTabs();\n        }\n    }\n\n    main.initHostsList = function (isFirstInit) {\n        // fill the host list (select) on adapter tab\n        const $selHosts = $('#host-adapters');\n        if (isFirstInit && $selHosts.data('inited')) {\n            return;\n        }\n\n        $selHosts.data('inited', true);\n\n        main.currentHost = main.currentHost || main.config.currentHost || '';\n\n        const lines = [];\n        let color;\n        let curId;\n        for (let i = 0; i < main.tabs.hosts.list.length; i++) {\n            lines.push('<li><a data-value=\"' + main.tabs.hosts.list[i].name + '\">' + main.getHostIcon(main.objects[main.tabs.hosts.list[i].id], 'imgHost left') + main.tabs.hosts.list[i].name + '</a></li>');\n            if (!main.currentHost) {\n                main.currentHost = main.tabs.hosts.list[i].name;\n            }\n            if (main.currentHost === main.tabs.hosts.list[i].name) {\n                curId = main.tabs.hosts.list[i].id;\n            }\n        }\n        $selHosts.html(lines);\n\n        const $selBtn = $('#host-adapters-btn').show();\n        $selBtn\n            .text(_('Host:') + ' ' + main.currentHost)\n            .dropdown();\n\n        if (main.objects[curId] && main.objects[curId].common) {\n            color = main.objects[curId].common.color;\n        }\n\n        $selBtn.append($(main.getHostIcon(main.objects[curId], 'imgHost left')));\n        if (color) {\n            // set color of button\n        }\n\n        if (main.tabs.hosts.list.length < 2) {\n            $selBtn.addClass('disabled');\n        } else {\n            $selBtn.removeClass('disabled');\n        }\n\n        // host selector\n        $selHosts.find('a').on('click', function () {\n            const val = $(this).data('value');\n            const id  = 'system.host.' + val + '.alive';\n            if (!main.states[id] || !main.states[id].val || main.states[id].val === 'null') {\n                main.showMessage(_('Host %s is offline', $(this).val()));\n                return;\n            }\n\n            main.currentHost = val;\n\n            $('#host-adapters-btn')\n                .text(_('Host:') + ' ' + main.currentHost)\n                .append($(this).find('.imgHost').clone());\n            // destroy current view and load anew\n            console.log(main.currentTab);\n            if (tabsInfo['tab-' + main.currentTab] && tabsInfo['tab-' + main.currentTab].host) {\n                // destroy actual tab\n                if (main.tabs[main.currentTab] && typeof main.tabs[main.currentTab].destroy === 'function') {\n                    main.tabs[main.currentTab].destroy();\n                }\n\n                // init new tab\n                if (main.tabs[main.currentTab] && typeof main.tabs[main.currentTab].init === 'function') {\n                    main.tabs[main.currentTab].init();\n                }\n            }\n\n            main.saveConfig('currentHost', main.currentHost);\n        });\n    };\n\n    // Use the function for this because it must be done after the language was read\n    function initAllDialogs() {\n        // todo delete it because jqgrid does not used any more\n        if (typeof initGridLanguage === 'function') {\n            initGridLanguage(main.systemConfig.common.language);\n        }\n\n        $dialogCommand.modal({\n            dismissible: false\n        });\n        $dialogMessage.modal();\n        $dialogConfirm.modal({\n            dismissible: false\n        });\n\n        $dialogCommand.find('.progress-show-more').off('change').on('change', function () {\n            const val = $(this).prop('checked');\n            main.saveConfig('progressMore', val);\n            if (val) {\n                $dialogCommand.find('.textarea').show();\n            } else {\n                $dialogCommand.find('.textarea').hide();\n            }\n        });\n        if (main.config.progressClose === undefined) {\n            main.config.progressClose = true;\n        }\n        $dialogCommand.find('.progress-dont-close input').on('change', function () {\n            main.saveConfig('progressClose', $(this).prop('checked'));\n        });\n        // workaround for materialize checkbox problem\n        $dialogCommand.find('input[type=\"checkbox\"]+span').off('click').on('click', function () {\n            const $input = $(this).prev();\n            // ignore switch\n            if ($input.parent().parent().hasClass('switch')) return;\n\n            if (!$input.prop('disabled')) {\n                $input.prop('checked', !$input.prop('checked')).trigger('change');\n            }\n        });\n        $dialogCommand.find('.progress-dont-close input').prop('checked', main.config.progressClose);\n        $dialogCommand.find('.progress-show-more').prop('checked', !!main.config.progressMore).trigger('change');\n        $dialogCommand.find('.btn').on('click', function () {\n            if ($dialogCommand.data('finished')) {\n                $adminSideMain.find('.button-command').hide();\n            } else {\n                $adminSideMain.find('.button-command').show();\n            }\n        });\n\n        $adminSideMain.find('.button-command').on('click', function () {\n            $dialogCommand.modal('open');\n        });\n    }\n\n    function checkNodeJsVersions(hosts, index) {\n        index = index || 0;\n        if (hosts && index < hosts.length) {\n            main.socket.emit('sendToHost', hosts[index].name, 'getHostInfo', null, function (result) {\n                if (result && result['Node.js']) {\n                    const major = parseInt(result['Node.js'].split('.').shift().replace('v', ''), 10);\n                    if (major < 6 || major === 7 || major === 9  || major === 11 ) { // we allow 6, 8, 10 and 12+\n                        main.showMessage(_('This version of node.js \"%s\" on \"%s\" is deprecated. Please install node.js 6, 8 or newer', result['Node.js'], hosts[index].name), _('Suggestion'), 'error_outline');\n                    }\n                }\n                setTimeout(function () {\n                    checkNodeJsVersions(hosts, index + 1);\n                }, 100);\n            });\n        }\n    }\n\n    // ----------------------------- Objects show and Edit ------------------------------------------------\n    function getObjects(callback) {\n        main.socket.emit('getAllObjects', function (err, res) {\n            if (err) {\n                // following errors are possible\n                // permissionError\n                // Admin is not enabled in cloud settings!\n                window.alert(_(err));\n                return;\n            }\n\n            setTimeout(function () {\n                let obj;\n                main.objects = res;\n                for (const id in main.objects) {\n                    if (!main.objects.hasOwnProperty(id) || id.slice(0, 7) === '_design') continue;\n\n                    obj = main.objects[id];\n\n                    if (obj.type === 'instance') main.instances.push(id);\n                    if (obj.type === 'enum')     tabs.enums.list.push(id);\n                    if (obj.type === 'user')     tabs.users.list.push(id);\n                    if (obj.type === 'group')    tabs.users.groups.push(id);\n                    if (obj.type === 'adapter')  tabs.adapters.list.push(id);\n                    if (obj.type === 'host')     tabs.hosts.addHost(obj);\n\n                    // convert obj.history into obj.custom\n                    if (obj.common && obj.common.history) {\n                        obj.common.custom = JSON.parse(JSON.stringify(obj.common.history));\n                        delete obj.common.history;\n                    }\n                }\n                main.objectsLoaded = true;\n                main.initHostsList(true);\n\n                initTabs();\n                // init dialogs\n                for (const dialog in main.dialogs) {\n                    if (main.dialogs.hasOwnProperty(dialog) && typeof main.dialogs[dialog].prepare === 'function') {\n                        main.dialogs[dialog].prepare();\n                    }\n                }\n\n                // Detect node.js version\n                checkNodeJsVersions(tabs.hosts.list);\n\n                main.getUser();\n\n                if (typeof callback === 'function') callback();\n            }, 0);\n        });\n    }\n    // ----------------------------- States show and Edit ------------------------------------------------\n\n    function getStates(callback) {\n        if (tabs.states) tabs.states.clear();\n        main.socket.emit('getStates', function (err, res) {\n            main.states = res;\n            if (typeof callback === 'function') {\n                setTimeout(function () {\n                    callback();\n                }, 0);\n            }\n        });\n    }\n\n    function stateChange(id, state) {\n        id = id ? id.replace(/\\s/g, '_') : '';\n\n        if (!id || !id.match(/\\.messagebox$/)) {\n            if (tabs.states) {\n                tabs.states.stateChange(id, state);\n            }\n            tabs.objects.stateChange(id, state);\n            tabs.hosts.stateChange(id, state);\n\n            // Update alive and connected of main.instances\n            tabs.instances.stateChange(id, state);\n            tabs.adapters.stateChange(id, state);\n            main.dialogs.customs.stateChange(id, state);\n\n            if (main.selectId) {\n                main.selectId.selectId('state', id, state);\n            }\n            main.addEventMessage(id, state, false, true);\n        } else {\n            main.addEventMessage(id, state, true, true);\n        }\n    }\n\n    function objectChange(id, obj) {\n        //const changed = false;\n        const oldObj = main.objects[id];\n        let action = 'update';\n\n        // update main.objects cache\n        if (obj) {\n            if (obj._rev && main.objects[id]) main.objects[id]._rev = obj._rev;\n            if (!main.objects[id]) {\n                action = 'add';\n            }\n            if (action === 'add' || JSON.stringify(main.objects[id]) !== JSON.stringify(obj)) {\n                main.objects[id] = obj;\n            }\n        } else if (main.objects[id]) {\n            action = 'delete';\n            delete main.objects[id];\n        }\n\n        // update to event table\n        main.addEventMessage(id, obj, false, false);\n\n        tabs.objects.objectChange(id, obj, action);\n\n        main.selectId && main.selectId.selectId('object', id, obj, action);\n\n        tabs.enums.objectChange(id, obj, action);\n        tabs.intro.objectChange(id, obj, action);\n\n        // If system config updated\n        if (id === 'system.config') {\n            // Check language\n            if (main.systemConfig.common.language !== obj.common.language) {\n                window.location.reload();\n            }\n\n            main.systemConfig = obj;\n            initTabs();\n        }\n\n        if (id === 'system.adapter.discovery.0') {\n            main.updateWizard();\n        }\n\n        if (id.match(/^system\\.host\\.[-\\w]+$/)) {\n            main.initHostsList();\n        }\n\n        tabs.instances.objectChange(id, obj, action);\n\n        //if (id.match(/^script\\.js\\.global\\..*/)) {\n        //    main.ignoreJSupdate = true;\n        //}\n\n        if (obj && id.match(/^system\\.adapter\\.[\\w-]+\\.[0-9]+$/)) {\n            if (obj.common &&\n                obj.common.adminTab &&\n                !obj.common.adminTab.ignoreConfigUpdate\n            ) {\n                // Detect enable/disable change and do not update tabs (To able to work with global scripts normally)\n                let ignore = false;\n                // try to detect if javascript just enabled or disabled\n                if (oldObj && obj) {\n                    if (oldObj.common && obj.common) {\n                        const newObj = JSON.parse(JSON.stringify(obj));\n                        newObj.common.enabled = oldObj.common.enabled;\n                        newObj.ts = 0;\n                        oldObj.ts = 0;\n                        console.log(JSON.stringify(newObj));\n                        console.log(JSON.stringify(oldObj));\n                        if (JSON.stringify(newObj) === JSON.stringify(oldObj)) {\n                            ignore = true;\n                        }\n                    }\n                }\n                !ignore && initTabs();\n                /*} else {\n                    main.ignoreJSupdate = false;\n                }*/\n            }\n\n            if (obj && obj.type === 'instance' && obj.common.supportCustoms) {\n                // Update all states if customs enabled or disabled\n                tabs.objects.reinit();\n            }\n        }\n\n        tabs.hosts.objectChange(id, obj, action);\n\n        // Update users\n        tabs.users.objectChange(id, obj, action);\n\n        // update user in side menu\n        if (id === main.currentUser) {\n            main.getUser();\n        }\n    }\n\n    function monitor() {\n        if (main._timer) return;\n        const ts = Date.now();\n\n        if (ts - main._lastTimer > 30000) {\n            // It seems, that PC was in a sleep => Reload page to request authentication anew\n            location.reload();\n        } else {\n            main._lastTimer = ts;\n        }\n        main._timer = setTimeout(() => {\n            main._timer = null;\n            monitor();\n        }, 10000);\n    }\n\n    // ---------------------------- Subscribes ---------------------------------------------\n    main.resubscribeStates = function () {\n        for (const pattern in main.subscribesStates) {\n            if (main.subscribesStates.hasOwnProperty(pattern) && main.subscribesStates[pattern]) {\n                console.debug('Re-Subscribe: ' + pattern);\n                main.socket.emit('subscribe', pattern);\n            }\n        }\n    };\n\n    main.resubscribeObjects = function () {\n        for (const pattern in main.subscribesObjects) {\n            if (main.subscribesObjects.hasOwnProperty(pattern) && main.subscribesObjects[pattern]) {\n                main.socket.emit('subscribeObjects', pattern);\n            }\n        }\n    };\n\n    main.resubscribeLogs = function () {\n        if (main.subscribesLogs) {\n            console.debug('Subscribe LOG');\n            main.socket.emit('requireLog', true);\n        }\n    };\n\n    main.subscribeStates = function (patterns) {\n        if (!patterns) return;\n        if (typeof patterns === 'object') {\n            for (let s = 0; s < patterns.length; s++) {\n                main.subscribesStates[patterns[s]] = main.subscribesStates[patterns[s]] || 0;\n                main.subscribesStates[patterns[s]]++;\n                if (main.subscribesStates[patterns[s]] === 1) {\n                    console.debug('Subscribe: ' + patterns[s]);\n                    main.socket.emit('subscribe', patterns[s]);\n                }\n            }\n        } else {\n            main.subscribesStates[patterns] = main.subscribesStates[patterns] || 0;\n            main.subscribesStates[patterns]++;\n            if (main.subscribesStates[patterns] === 1) {\n                console.debug('Subscribe: ' + patterns);\n                main.socket.emit('subscribe', patterns);\n            }\n        }\n    };\n\n    main.unsubscribeStates = function (patterns) {\n        if (!patterns) return;\n        if (typeof patterns === 'object') {\n            for (let s = 0; s < patterns.length; s++) {\n                if (main.subscribesStates[patterns[s]]) {\n                    main.subscribesStates[patterns[s]]--;\n                }\n                if (main.subscribesStates[patterns[s]] === 0) {\n                    console.debug('Unsubscribe: ' + patterns[s]);\n                    main.socket.emit('unsubscribe', patterns[s]);\n                    delete main.subscribesStates[patterns[s]];\n                }\n            }\n        } else {\n            if (main.subscribesStates[patterns]) {\n                main.subscribesStates[patterns]--;\n            }\n            if (main.subscribesStates[patterns] === 0) {\n                console.debug('Unsibscribe: ' + patterns);\n                main.socket.emit('unsubscribe', patterns);\n                delete main.subscribesStates[patterns];\n            }\n        }\n    };\n\n    main.subscribeObjects = function (patterns) {\n        if (!patterns) return;\n        if (typeof patterns === 'object') {\n            for (let s = 0; s < patterns.length; s++) {\n                main.subscribesObjects[patterns[s]] = main.subscribesObjects[patterns[s]] || 0;\n                main.subscribesObjects[patterns[s]]++;\n                if (main.subscribesObjects[patterns[s]] === 1) {\n                    main.socket.emit('subscribeObjects', patterns[s]);\n                }\n            }\n        } else {\n            main.subscribesObjects[patterns] = main.subscribesObjects[patterns] || 0;\n            main.subscribesObjects[patterns]++;\n            if (main.subscribesObjects[patterns] === 1) {\n                main.socket.emit('subscribeObjects', patterns);\n            }\n        }\n    };\n\n    main.unsubscribeObjects = function (patterns) {\n        if (!patterns) return;\n        if (typeof patterns === 'object') {\n            for (let s = 0; s < patterns.length; s++) {\n                if (main.subscribesObjects[patterns[s]]) {\n                    main.subscribesObjects[patterns[s]]--;\n                }\n                if (main.subscribesObjects[patterns[s]] === 0) {\n                    main.socket.emit('unsubscribeObjects', patterns[s]);\n                    delete main.subscribesObjects[patterns[s]];\n                }\n            }\n        } else {\n            if (main.subscribesObjects[patterns]) {\n                main.subscribesObjects[patterns]--;\n            }\n            if (main.subscribesObjects[patterns] === 0) {\n                main.socket.emit('unsubscribeObjects', patterns);\n                delete main.subscribesObjects[patterns];\n            }\n        }\n    };\n\n    main.subscribeLogs = function (isSubscribe) {\n        if (isSubscribe) {\n            main.subscribesLogs++;\n            if (main.subscribesLogs === 1) {\n                console.debug('Subscribe Logs');\n                main.socket.emit('requireLog', true);\n            }\n        } else {\n            main.subscribesLogs--;\n            if (main.subscribesLogs <= 0) {\n                main.subscribesLogs = 0;\n                console.debug('Unsubscribe Logs');\n                main.socket.emit('requireLog', false);\n            }\n        }\n    };\n\n    // ---------------------------- Navigation ---------------------------------------------\n    main.navigateCheckDialog = function (callback) {\n        if (main.currentDialog && main.dialogs[main.currentDialog] && typeof main.dialogs[main.currentDialog].allStored === 'function') {\n            if (main.dialogs[main.currentDialog].allStored() === false) {\n                return main.confirmMessage(_('Some data are not stored. Discard?'), _('Please confirm'), null, function (result) {\n                    callback(!result);\n                });\n            }\n        } else {\n            if (configNotSaved) {\n                return main.confirmMessage(_('Some data are not stored. Discard?'), _('Please confirm'), null, function (result) {\n                    callback(!result);\n                });\n            }\n        }\n        callback(false);\n    };\n\n    main.navigateGetParams = function () {\n        const parts = decodeURI(window.location.hash).split('/');\n        return parts[2] ? decodeURIComponent(parts[2]) : null;\n    };\n\n    main.navigate = function (options) {\n        if (!options) {\n            options = {};\n        }\n        if (typeof options === 'string') {\n            options = {\n                tab:    options,\n                dialog: '',\n                params: ''\n            };\n        }\n\n        // get actual tab\n        if (!options.tab) {\n            const parts   = decodeURI(window.location.hash).split('/');\n            options.tab = parts[0].replace(/^#/, '').replace(/^tab-/, '');\n        }\n\n        window.location.hash = '#tab-' + encodeURIComponent(options.tab) + (options.dialog ? '/' + options.dialog + (options.params ? '/' + encodeURIComponent(options.params) : '') : '');\n    };\n\n    // Router\n    main.navigateDo = function () {\n        // ignore if hash not changed\n        if (window.location.hash === main.currentHash) {\n            return;\n        }\n        // if config dialog opened and has some unsaved data\n        main.navigateCheckDialog(function (err) {\n            if (!err) {\n                configNotSaved = null;\n                main.currentHash = window.location.hash;\n                // hash has following structure => #tabName/dialogName/ids\n                const parts  = main.currentHash.split('/');\n                let tab      = parts[0].replace(/^#/, '').replace(/^tab-/, '');\n                const dialog = parts[1];\n                const params = decodeURIComponent(parts[2]);\n\n                // set default page\n                if (!tab || tab === '!') {\n                    if (!main.systemConfig.common.tabs || main.systemConfig.common.tabs.indexOf('tab-intro') !== -1) {\n                        tab = 'intro';\n                    } else if (main.systemConfig.common.tabs.indexOf('tab-adapters') !== -1) {\n                        tab = 'adapters';\n                    } else {\n                        tab = main.systemConfig.common.tabs[0].replace(/^#/, '').replace(/^tab-/, '');\n                    }\n                }\n                // do tab is not found\n\n                const $adminBody = $('.admin-sidemenu-body');\n                let $actualTab   = $adminBody.find('.admin-sidemenu-body-content');\n                const $panel     = $('#tab-' + tab);\n\n                $adminBody.find('.admin-preloader').remove();\n\n                if (!$panel.length) {\n                    tab = 'intro';\n                }\n\n                // if tab was changed\n                if (main.currentTab !== tab || !$actualTab.length) {\n                    let link;\n                    // destroy actual tab\n                    if (main.currentTab && tabs[main.currentTab] && typeof tabs[main.currentTab].destroy === 'function') {\n                        tabs[main.currentTab].destroy();\n                    } else if (main.currentTab) {\n                        const $oldPanel = $('#tab-' + main.currentTab);\n                        // destroy current iframe\n                        if ($oldPanel.length && (link = $oldPanel.data('src'))) {\n                            const $iframe_ = $oldPanel.find('>iframe');\n                            if ($iframe_.attr('src')) {\n                                console.log('clear');\n                                $iframe_.attr('src', '');\n                            }\n                        }\n                    }\n                    main.currentTab = tab;\n\n                    $actualTab.hide().appendTo('body');\n                    if (!dialog) {\n                        $panel.addClass('admin-sidemenu-body-content').show().appendTo($adminBody);\n                        $actualTab = $panel;\n                    }\n\n                    // init new tab\n                    if (tabs[tab] && typeof tabs[tab].init === 'function') {\n                        tabs[tab].init();\n                    }\n\n                    // if iframe like node-red\n                    if ($panel.length && (link = $panel.data('src'))) {\n                        if (link.indexOf('%') === -1) {\n                            const $iframe = $panel.find('>iframe');\n                            if ($iframe.length && !$iframe.attr('src')) {\n                                $iframe.attr('src', link);\n                            }\n                        } else {\n                            $adminSideMenu.data('problem-link', 'tab-' + tab);\n                        }\n                    }\n                }\n\n                // select menu element\n                const  $tab = $adminSideMenu.find('.admin-sidemenu-items[data-tab=\"tab-' + tab + '\"]');\n                $adminSideMenu.find('.admin-sidemenu-items').not($tab).removeClass('admin-sidemenu-active');\n                $tab.addClass('admin-sidemenu-active');\n\n                if (tabsInfo['tab-' + tab] && tabsInfo['tab-' + tab].host) {\n                    $('#host-adapters-btn').css('opacity', 1);\n                } else {\n                    $('#host-adapters-btn').css('opacity', 0.3);\n                }\n                document.title = tab + ' - ioBroker';\n                // if some dialog opened or must be shown\n                if (main.currentDialog !== dialog) {\n                    // destroy it\n                    if (main.dialogs[main.currentDialog] && typeof main.dialogs[main.currentDialog].destroy === 'function') {\n                        main.dialogs[main.currentDialog].destroy();\n                    }\n                    main.currentDialog = dialog;\n                    if (dialog && main.dialogs[dialog]) {\n                        if (typeof main.dialogs[dialog].init === 'function') {\n                            main.dialogs[dialog].init(params ? params.split(',') : undefined);\n                        }\n                        tabs[main.currentTab] && tabs[main.currentTab].saveScroll && tabs[main.currentTab].saveScroll();\n                        $actualTab.hide().appendTo('body');\n                        $('#dialog-' + dialog).addClass('admin-sidemenu-body-content').show().appendTo($adminBody);\n                    } else if ($actualTab.attr('id') !== $panel.attr('id')) {\n                        $actualTab.hide().appendTo('body');\n                        $panel.addClass('admin-sidemenu-body-content').show().appendTo($adminBody);\n                        tabs[main.currentTab] && tabs[main.currentTab].restoreScroll && tabs[main.currentTab].restoreScroll();\n                    }\n                }\n            } else {\n                // restore hash link\n                window.location.hash = main.currentHash || '';\n            }\n        });\n    };\n\n    function getIconHtml(obj, classes) {\n        let icon;\n        let alt;\n        const isCommon = obj && obj.common;\n\n        if (isCommon.icon) {\n            if (!isCommon.icon.match(/^data:image\\//)) {\n                if (isCommon.icon.indexOf('.') !== -1) {\n                    let instance;\n                    if (obj.type === 'instance') {\n                        icon = '/adapter/' + obj.common.name + '/' + obj.common.icon;\n                    } else if (obj._id.match(/^system\\.adapter\\./)) {\n                        instance = obj._id.split('.', 3);\n                        if (isCommon.icon[0] === '/') {\n                            instance[2] += isCommon.icon;\n                        } else {\n                            instance[2] += '/' + isCommon.icon;\n                        }\n                        icon = '/adapter/' + instance[2];\n                    } else {\n                        instance = obj._id.split('.', 2);\n                        if (isCommon.icon[0] === '/') {\n                            instance[0] += isCommon.icon;\n                        } else {\n                            instance[0] += '/' + isCommon.icon;\n                        }\n                        icon = '/adapter/' + instance[0];\n                    }\n                } else {\n                    return '<i class=\"material-icons ' + (classes || 'treetable-icon') + '\">' + isCommon.icon + '</i>';\n                }\n\n            } else {\n                icon = isCommon.icon;\n            }\n            alt = obj.type;\n        }\n        return {icon: icon, alt: alt};\n    }\n\n    main.getIconFromObj = function (obj, imgPath, classes) {\n        let icon     = '';\n        let alt      = '';\n        if (obj && obj.common) {\n            if (obj.common.icon) {\n                const result = getIconHtml(obj);\n                icon = result.icon;\n                alt = result.alt;\n            } else {\n                imgPath = imgPath || 'lib/css/fancytree/';\n                if (obj.type === 'device') {\n                    icon = imgPath + 'device.png';\n                    alt  = 'device';\n                } else if (obj.type === 'channel') {\n                    icon = imgPath + 'channel.png';\n                    alt  = 'channel';\n                } else if (obj.type === 'state') {\n                    icon = imgPath + 'state.png';\n                    alt  = 'state';\n                }\n            }\n        }\n\n        if (icon) return '<img class=\"' + (classes || 'treetable-icon') + '\" src=\"' + icon + '\" alt=\"' + (alt || '') + '\" />';\n        return '';\n    };\n\n    // static, just used from many places\n    main.getIcon = function(id, imgPath, objects, classes) {\n        return main.getIconFromObj((objects || main.objects)[id], imgPath, classes);\n    };\n\n    main.getHostIcon = function (obj, classes) {\n        let icon     = '';\n        let alt      = '';\n\n        if (obj && obj.common && obj.common.icon) {\n            const result = getIconHtml(obj);\n            icon = result.icon;\n            alt = result.alt;\n        }\n        icon = icon || 'img/no-image.png';\n        alt  = alt  || '';\n\n        return '<img class=\"' + (classes || 'treetable-icon') + '\" src=\"' + icon + '\" alt=\"' + alt + '\" />';\n    };\n\n    main.formatBytes = function (bytes) {\n        if (Math.abs(bytes) < 1024) {\n            return bytes + ' B';\n        }\n        const units = ['KiB','MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];\n        let u = -1;\n        do {\n            bytes /= 1024;\n            ++u;\n        } while (Math.abs(bytes) >= 1024 && u < units.length - 1);\n        return bytes.toFixed(1) + ' ' + units[u];\n    };\n\n    // https://stackoverflow.com/questions/35969656/how-can-i-generate-the-opposite-color-according-to-current-color\n    main.invertColor = function (hex) {\n        if (hex.indexOf('#') === 0) {\n            hex = hex.slice(1);\n        }\n        // convert 3-digit hex to 6-digits.\n        if (hex.length === 3) {\n            hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];\n        }\n        if (hex.length !== 6) {\n            return false;\n        }\n        const r = parseInt(hex.slice(0, 2), 16),\n            g = parseInt(hex.slice(2, 4), 16),\n            b = parseInt(hex.slice(4, 6), 16);\n        // http://stackoverflow.com/a/3943023/112731\n        return (r * 0.299 + g * 0.587 + b * 0.114) <= 186;\n    };\n\n    const tabsInfo = {\n        'tab-intro':            {order: 1,    icon: 'apps'},\n        'tab-info':             {order: 5,    icon: 'info',              host: true},\n        'tab-adapters':         {order: 10,   icon: 'store',             host: true},\n        'tab-instances':        {order: 15,   icon: 'subtitles',         host: true},\n        'tab-objects':          {order: 20,   icon: 'view_list'},\n        'tab-enums':            {order: 25,   icon: 'art_track'},\n        'tab-devices':          {order: 27,   icon: 'dvr',               host: true},\n        'tab-logs':             {order: 30,   icon: 'view_headline',     host: true},\n        'tab-scenes':           {order: 35,   icon: 'subscriptions'},\n        'tab-events':           {order: 40,   icon: 'flash_on'},\n        'tab-users':            {order: 45,   icon: 'person_outline'},\n        'tab-javascript':       {order: 50,   icon: 'code'},\n        'tab-text2command-0':   {order: 55,   icon: 'ac_unit'},\n        'tab-text2command-1':   {order: 56,   icon: 'ac_unit'},\n        'tab-text2command-2':   {order: 57,   icon: 'ac_unit'},\n        'tab-node-red-0':       {order: 60,   icon: 'device_hub'},\n        'tab-node-red-1':       {order: 61,   icon: 'device_hub'},\n        'tab-node-red-2':       {order: 62,   icon: 'device_hub'},\n        'tab-fullcalendar-0':   {order: 65,   icon: 'perm_contact_calendar'},\n        'tab-fullcalendar-1':   {order: 66,   icon: 'perm_contact_calendar'},\n        'tab-fullcalendar-2':   {order: 67,   icon: 'perm_contact_calendar'},\n        'tab-hosts':            {order: 100,  icon: 'storage'},\n    };\n\n    function initSideNav() {\n        let lines = '';\n\n        const elements = [];\n        $('.admin-tab').each(function () {\n            const id = $(this).attr('id');\n            if (!main.systemConfig.common.tabs || main.systemConfig.common.tabs.indexOf(id) !== -1) {\n                elements.push({\n                    line: '<li class=\"admin-sidemenu-items\" data-tab=\"' + id + '\"><a href=\"#' + id + '\">' +\n                            (tabsInfo[id] && tabsInfo[id].icon ? '<i class=\"material-icons left\">' + tabsInfo[id].icon + '</i>' : '<i class=\"material-icons left\">live_help</i>') +\n                            _($(this).data('name')) + '</a></li>',\n                    id: id\n                });\n            }\n        });\n        $('.tab-custom').each(function () {\n            const id = $(this).attr('id');\n            if (!main.systemConfig.common.tabs || main.systemConfig.common.tabs.indexOf(id) !== -1) {\n                let icon;\n                if (tabsInfo[id] && tabsInfo[id].icon) {\n                    icon = tabsInfo[id].icon;\n                } else {\n                    const _id = 'system.adapter.' + id.substring(4);\n\t\t            if (main.objects[_id] && main.objects[_id].common.adminTab && main.objects[_id].common.adminTab['fa-icon']) {\n                        icon = main.objects[_id].common.adminTab['fa-icon'];\n                    }\n                }\n\n                elements.push({\n                    line: '<li class=\"admin-sidemenu-items\" data-tab=\"' + id + '\"><a href=\"#' + id + '\">' +\n                    (icon ? '<i class=\"material-icons left\">' + icon + '</i>' : '<i class=\"material-icons left\">live_help</i>') +\n                    $(this).data('name') + '</a></li>',\n                    id: id\n                });\n            }\n        });\n\n        elements.sort(function (a, b) {\n            if (!tabsInfo[a.id] && !tabsInfo[b.id]) return 0;\n            if (!tabsInfo[a.id]) return 1;\n            if (!tabsInfo[b.id]) return -1;\n            if (tabsInfo[a.id].order < tabsInfo[b.id].order) return -1;\n            if (tabsInfo[a.id].order > tabsInfo[b.id].order) return 1;\n            return 0;\n        });\n\n        for (let e = 0; e < elements.length; e++) {\n            lines += elements[e].line;\n        }\n        $adminSideMenu.find('.admin-sidemenu-menu').html(lines);\n\n        $('.admin-sidemenu-close').off('click').on('click', function () {\n            $adminSideMain.toggleClass('admin-sidemenu-closed');\n            $adminSideMenu.toggleClass('admin-sidemenu-closed');\n            $('.admin-sidemenu-close i').toggleClass('hide');\n\n            setTimeout(function () {\n                //resizeGrids();\n                $(window).trigger('resize');\n            }, 400);\n        });\n\n        $('.admin-sidemenu-items').off('click').on('click', function (e) {\n            e.preventDefault();\n            e.stopPropagation();\n            window.location.hash = '#' + $(this).data('tab');\n        });\n        $('.admin-sidemenu-items a').off('click').on('click', function (e) {\n            e.preventDefault();\n            e.stopPropagation();\n            window.location.hash = '#' + $(this).parent().data('tab');\n        });\n\n        // Show if update available\n        tabs.hosts.updateCounter();\n        tabs.adapters.updateCounter();\n    }\n\n    // ---------------------------- Socket.io methods ---------------------------------------------\n    main.socket.on('log',               function (message) {\n        tabs.logs.add(message);\n    });\n    main.socket.on('error',             function (error) {\n        console.log(error);\n    });\n    main.socket.on('permissionError',   function (err) {\n        main.showMessage(_('Has no permission to %s %s %s', err.operation, err.type, (err.id || '')));\n    });\n    main.socket.on('stateChange',       function (id, obj) {\n        setTimeout(stateChange, 0, id, obj);\n    });\n    main.socket.on('objectChange',      function (id, obj) {\n        setTimeout(objectChange, 0, id, obj);\n    });\n    main.socket.on('cmdStdout',         function (_id, text) {\n        if (activeCmdId === _id) {\n            let m = text.match(/^upload \\[(\\d+)]/);\n            if (m) {\n                if ($dialogCommand.data('max') === null) {\n                    $dialogCommand.data('max', parseInt(m[1], 10));\n                    $dialogCommandProgress.removeClass('indeterminate').addClass('determinate');\n                }\n                const max = $dialogCommand.data('max');\n                const value = parseInt(m[1], 10);\n                $dialogCommandProgress.css('width', (100 - Math.round((value / max) * 100)) + '%');\n            } else {\n                m = text.match(/^got [-_:\\/\\\\.\\w\\d]+\\/admin$/);\n                if (m) {\n                    // upload of admin\n                    $dialogCommand.find('.progress-text').html(_('Upload admin started'));\n                    $dialogCommand.data('max', null);\n                } else {\n                    // got ..../www\n                    m = text.match(/^got [-_:\\/\\\\.\\w\\d]+\\/www$/);\n                    if (m) {\n                        // upload of www\n                        $dialogCommand.find('.progress-text').html(_('Upload www started'));\n                        $dialogCommand.data('max', null);\n                    } else {\n\n                    }\n                }\n            }\n\n            stdout += '\\n' + text;\n            $stdout.val(stdout);\n            $stdout.scrollTop($stdout[0].scrollHeight - $stdout.height());\n        }\n    });\n    main.socket.on('cmdStderr',         function (_id, text) {\n        if (activeCmdId === _id) {\n            if (!$dialogCommand.data('error')) {\n                $dialogCommand.data('error', text);\n            }\n            stdout += '\\nERROR: ' + text;\n            $stdout.val(stdout);\n            $stdout.scrollTop($stdout[0].scrollHeight - $stdout.height());\n        }\n    });\n    main.socket.on('cmdExit',           function (_id, exitCode) {\n        if (activeCmdId === _id) {\n\n            exitCode = parseInt(exitCode, 10);\n            stdout += '\\n' + (exitCode !== 0 ? 'ERROR: ' : '') + 'process exited with code ' + exitCode;\n            $stdout.val(stdout);\n            $stdout.scrollTop($stdout[0].scrollHeight - $stdout.height());\n\n            $dialogCommand.find('.progress-dont-close').addClass('disabled');\n            $dialogCommandProgress.removeClass('indeterminate').css({'width': '100%'});\n            $dialogCommand.find('.btn').html(_('Close'));\n            $dialogCommand.data('finished', true);\n            $dialogCommand.data('max', true);\n            const $backButton = $adminSideMain.find('.button-command');\n            $backButton.removeClass('in-progress');\n\n            if (!exitCode) {\n                $dialogCommand.find('.progress-text').html(_('Success!'));\n                $backButton.hide();\n                if ($dialogCommand.find('.progress-dont-close input').prop('checked')) {\n                    setTimeout(function () {\n                        $dialogCommand.modal('close');\n                    }, 1500);\n                }\n            } else {\n                let error = $dialogCommand.data('error');\n                if (error) {\n                    const m = error.match(/error: (.*)$/);\n                    if (m) {\n                        error = m[1];\n                    }\n\n                    $dialogCommand.find('.progress-text').html(_('Done with error: %s', _(error))).addClass('error');\n                } else {\n                    $dialogCommand.find('.progress-text').html(_('Done with error')).addClass('error');\n                }\n                $backButton.addClass('error');\n                $backButton.show();\n            }\n            if (cmdCallback) {\n                cmdCallback(exitCode);\n                cmdCallback = null;\n            }\n        }\n    });\n    main.socket.on('eventsThreshold',   function (isActive) {\n        if (isActive) {\n            $('#events_threshold').show();\n        } else {\n            $('#events_threshold').hide();\n        }\n    });\n    main.socket.on('connect',           function () {\n        $('#connecting').hide();\n        if (firstConnect) {\n            firstConnect = false;\n\n            main.getUser();\n\n            main.socket.emit('getUserPermissions', function (err, acl) {\n                main.acl = acl;\n                // Read system configuration\n                main.socket.emit('getObject', 'system.config', function (errConfig, data) {\n                    main.systemConfig = data;\n\n                    // set logo and set branding\n                    if (data && data.native && data.native.vendor) {\n                        const vendor = data.native.vendor;\n                        if (vendor.icon) {\n                            $('.admin-sidemenu-header .button-icon img').attr('src', data.native.vendor.icon);\n                        }\n                        if (vendor.name) {\n                            $('.admin-sidemenu-header .button-version').html(data.native.vendor.name).addClass('vendor');\n                        }\n                        if (vendor.admin && vendor.admin.noCustomInstall) {\n                            $('#btn_filter_custom_url').hide();\n                        }\n                        if (vendor.admin && vendor.admin.css) {\n                            if (vendor.admin.css.sideNavUser) {\n                                $('.side-nav .user-view').css(vendor.admin.css.sideNavUser);\n                            }\n                            if (vendor.admin.css.sideNavMenu) {\n                                $('.side-nav').css(vendor.admin.css.sideNavMenu);\n                            }\n                            if (vendor.admin.css.header) {\n                                $adminSideMain.find('.admin-sidemenu-header nav').css(vendor.admin.css.header);\n                            }\n                            // apply rules\n                            if (vendor.admin.css.rules) {\n                                for (let r = 0; r < vendor.admin.css.rules.length; r++) {\n                                    $(vendor.admin.css.rules[r].selector).css(vendor.admin.css.rules[r].css);\n                                }\n                            }\n                            if (vendor.admin.styles) {\n                                $('head').append('<style type=\"text/css\">' + vendor.admin.styles + '</style>');\n                            }\n                        }\n                    }\n\n                    // rename log => logs (back compatibility)\n                    if (main.systemConfig && main.systemConfig.common && main.systemConfig.common.tabs) {\n                        const pos = main.systemConfig.common.tabs.indexOf('tab-log');\n                        if (pos !== -1) {\n                            main.systemConfig.common.tabs[pos] = 'tab-logs';\n                        }\n                    }\n\n                    main.socket.emit('getObject', 'system.repositories', function (errRepo, repo) {\n                        main.dialogs.system.systemRepos = repo;\n                        main.socket.emit('getObject', 'system.certificates', function (errCerts, certs) {\n                            setTimeout(function () {\n                                main.dialogs.system.systemCerts = certs;\n                                if (errConfig === 'permissionError') {\n                                    main.systemConfig = {common: {language: systemLang}, error: 'permissionError'};\n                                } else {\n                                    if (!errConfig && main.systemConfig && main.systemConfig.common) {\n                                        systemLang = main.systemConfig.common.language || systemLang;\n                                        main.systemConfig.common.city      = main.systemConfig.common.city      || '';\n                                        main.systemConfig.common.country   = main.systemConfig.common.country   || '';\n                                        main.systemConfig.common.longitude = main.systemConfig.common.longitude || '';\n                                        main.systemConfig.common.latitude  = main.systemConfig.common.latitude  || '';\n\n                                        if (!main.systemConfig.common.licenseConfirmed) {\n                                            // Show license agreement\n                                            let language = (main.systemConfig.common.language || window.navigator.userLanguage || window.navigator.language || '').substring(0, 2);\n                                            if (language !== 'en' && language !== 'de' && language !== 'ru') {\n                                                language = 'en';\n                                            }\n\n                                            systemLang = language;\n\n                                            $dialogLicense.find('.license_text').html(license[language] || license.en);\n\n                                            $dialogLicense.find('.license_checkbox').prop('checked', false);\n\n                                            // on language change\n                                            $dialogLicense.find('.license_language')\n                                                .data('licenseConfirmed', false)\n                                                .val(language)\n                                                .on('change', function () {\n                                                    language = $(this).val();\n                                                    $dialogLicense.find('.license_language_label').html(translateWord('Select language', language));\n                                                    $dialogLicense.find('.license_text').html(license[language] || license.en);\n                                                    $dialogLicense.find('.license_checkbox').html(translateWord('license_checkbox', language));\n                                                    $dialogLicense.find('.license_agree .translate').html(translateWord('agree', language));\n                                                    $dialogLicense.find('.license_non_agree .translate').html(translateWord('not agree', language));\n                                                    $dialogLicense.find('.license_terms').html(translateWord('License terms', language));\n                                                    $dialogLicense.find('.license_agreement_label').html(translateWord('license agreement', language));\n                                                }).select();\n\n                                            $dialogLicense.find('.license_diag').on('change', function () {\n                                                if ($(this).prop('checked')) {\n                                                    $dialogLicense.find('.license_agree').removeClass('disabled');\n                                                } else {\n                                                    $dialogLicense.find('.license_agree').addClass('disabled');\n                                                }\n                                            });\n\n                                            // workaround for materialize checkbox problem\n                                            $dialogLicense.find('input[type=\"checkbox\"]+span').off('click').on('click', function () {\n                                                const $input = $(this).prev();\n                                                if (!$input.prop('disabled')) {\n                                                    $input.prop('checked', !$input.prop('checked')).trigger('change');\n                                                }\n                                            });\n\n                                            $dialogLicense.modal({\n                                                dismissible: false,\n                                                complete: function () {\n                                                    $dialogLicense.find('.license_text').html('');\n                                                    location.reload();\n                                                }\n                                            }).modal('open');\n\n                                            $dialogLicense.find('.license_agree').addClass('disabled').off('click').on('click', function (e) {\n                                                e.preventDefault();\n                                                e.stopPropagation();\n\n                                                main.socket.emit('getObject', 'system.config', function (err, obj) {\n                                                    if (err || !obj) {\n                                                        main.showError(_('Cannot confirm: ' + err));\n                                                        return;\n                                                    }\n                                                    obj.common = obj.common || {};\n                                                    obj.common.licenseConfirmed = true;\n                                                    obj.common.language = language;\n                                                    main.socket.emit('setObject', 'system.config', obj, function (err) {\n                                                        if (err) {\n                                                            main.showError(err);\n                                                        }\n                                                        $dialogLicense.modal('close');\n                                                        $dialogLicense.find('.license_agree').off('click');\n                                                        $dialogLicense.find('.license_non_agree').off('click');\n                                                    });\n                                                });\n                                            });\n                                            $dialogLicense.find('.license_non_agree').off('click').on('click', function (e) {\n                                                location.reload();\n                                            });\n                                        }\n                                    } else {\n                                        main.systemConfig = {\n                                            type: 'config',\n                                            common: {\n                                                name:             'system.config',\n                                                city:             '',           // City for weather\n                                                country:          '',           // Country for weather\n                                                longitude:        '',           // longitude for javascript\n                                                latitude:         '',           // longitude for javascript\n                                                language:         '',           // Default language for adapters. Adapters can use different values.\n                                                tempUnit:         '\u00b0C',         // Default temperature units.\n                                                currency:         '',           // Default currency sign.\n                                                dateFormat:       'DD.MM.YYYY', // Default date format.\n                                                isFloatComma:     true,         // Default float divider ('.' - false, ',' - true)\n                                                licenseConfirmed: false,        // If license agreement confirmed,\n                                                infoAdapterInstall: false,      // Asked if user wants to install the info adapter\n                                                defaultHistory:   '',           // Default history instance\n                                                tabs: [                         // Show by default only these tabs\n                                                    'tab-intro',\n                                                    'tab-info',\n                                                    'tab-adapters',\n                                                    'tab-instances',\n                                                    'tab-objects',\n                                                    'tab-logs',\n                                                    'tab-scenes',\n                                                    'tab-javascript',\n                                                    'tab-text2command-0'\n                                                ]\n                                            }\n                                        };\n                                        main.systemConfig.common.language = window.navigator.userLanguage || window.navigator.language;\n\n                                        if (main.systemConfig.common.language !== 'en' && main.systemConfig.common.language !== 'de' && main.systemConfig.common.language !== 'ru') {\n                                            main.systemConfig.common.language = 'en';\n                                        }\n                                    }\n                                }\n\n                                translateCron();\n                                translateAll();\n\n                                // Here we go!\n                                initAllDialogs();\n                                // call prepare\n                                for (const t in tabs) {\n                                    if (tabs.hasOwnProperty(t) && tabs[t] && typeof tabs[t].prepare === 'function') {\n                                        tabs[t].prepare();\n                                    }\n                                }\n                                // TABS\n                                // resizeGrids();\n\n                                getStates(getObjects);\n                            }, 0);\n                        });\n                    });\n                });\n            });\n        } else {\n            main.resubscribeStates();\n            main.resubscribeObjects();\n            main.resubscribeLogs();\n        }\n\n        main.waitForRestart && location.reload();\n    });\n    main.socket.on('disconnect',        function () {\n        $('#connecting').show();\n    });\n    main.socket.on('reconnect',         function () {\n        $('#connecting').hide();\n        main.waitForRestart && location.reload();\n    });\n    main.socket.on('repoUpdated',       function () {\n        setTimeout(function () {\n            tabs.adapters.init(true);\n        }, 0);\n    });\n    main.socket.on('reauthenticate',    function () {\n        location.reload();\n    });\n\n    });\n})(jQuery);", "function Adapters(main) {\n    'use strict';\n\n    const that = this;\n\n    this.curRepository     = null;\n    this.curRepoLastUpdate = null;\n    this.curInstalled      = null;\n    this.curRepoLastHost   = null;\n\n    this.list   = [];\n    this.$tab   = $('#tab-adapters');\n    this.$grid  = this.$tab.find('#grid-adapters');\n    this.$tiles = this.$tab.find('#grid-adapters-tiles');\n    this.$installDialog = $('#dialog-install-url');\n    this.main   = main;\n    this.tree   = [];\n    this.data   = {};\n    this.urls   = {};\n    this.groupImages = {\n        'common adapters_group':  'img/common.png',\n        'general_group':          'img/common.png',\n        'hardware_group':         'img/hardware.png',\n        'lighting_group':         'img/hardware.png',\n        'energy_group':           'img/hardware.png',\n        'household_group':        'img/hardware.png',\n        'iot-systems_group':      'img/hardware.png',\n        'climate-control_group':  'img/hardware.png',\n        'infrastructure_group':   'img/hardware.png',\n        'garden_group':           'img/hardware.png',\n        'alarm_group':            'img/hardware.png',\n        'script_group':           'img/script.png',\n        'logic_group':            'img/script.png',\n        'media_group':            'img/media.png',\n        'multimedia_group':       'img/media.png',\n        'communication_group':    'img/communication.png',\n        'protocols_group':        'img/communication.png',\n        'network_group':          'img/communication.png',\n        'messaging_group':        'img/communication.png',\n        'visualisation_group':    'img/visualisation.png',\n        'visualization_group':    'img/visualisation.png',\n        'visualization-icons_group': 'img/visualisation.png',\n        'visualization-widgets_group': 'img/visualisation.png',\n        'storage_group':          'img/storage.png',\n        'weather_group':          'img/weather.png',\n        'schedule_group':         'img/schedule.png',\n        'vis_group':              'img/vis.png',\n        'date-and-time_group':    'img/service.png',\n        'geoposition_group':      'img/service.png',\n        'utility_group':          'img/service.png',\n        'misc-data_group':        'img/service.png',\n        'service_group':          'img/service.png',\n        'third-party_group':      'img/service.png'\n    };\n    this.inited = false;\n\n    this.isList        = false;\n    this.filterVals    = {length: 0};\n    this.onlyInstalled = false;\n    this.onlyUpdatable = false;\n    this.currentFilter = '';\n    this.currentType   = '';\n    this.isCollapsed   = {};\n    this.isTiles       = true;\n\n    this.types = {\n        occ:          'schedule'\n    };\n\n    function getVersionClass(version) {\n        if (version) {\n            const tmp = version.split ('.');\n            if (tmp[0] === '0' && tmp[1] === '0' && tmp[2] === '0') {\n                version = 'planned';\n            } else if (tmp[0] === '0' && tmp[1] === '0') {\n                version = 'alpha';\n            } else if (tmp[0] === '0') {\n                version = 'beta'\n            } else if (version === 'npm error') {\n                version = 'error';\n            } else {\n                version = 'stable';\n            }\n        }\n        return version;\n    }\n\n    function prepareTable() {\n        that.$grid.show();\n        that.$tiles.html('').hide();\n        that.$tab.find('#main-toolbar-table-types-btn').hide();\n\n        if (!that.$grid.data('inited')) {\n            that.$grid.data('inited', true);\n            that.$grid.fancytree({\n                extensions: ['table', 'gridnav', 'filter', 'themeroller'],\n                checkbox:   false,\n                strings: {\n                    noData: _('No data')\n                },\n                table: {\n                    indentation: 5      // indent 20px per node level\n                },\n                show: function (currentId, filter, onSuccess) {\n                    that.sortTree();\n                },\n                source:     that.tree,\n                renderColumns: function(event, data) {\n                    const node = data.node;\n                    const $tdList = $(node.tr).find('>td');\n                    const obj = that.data[node.key];\n\n                    function ellipsis(txt) {\n                        return '<div class=\"text-ellipsis\">' + txt + '</div>';\n                    }\n\n                    if (!obj) {\n                        $tdList.eq(0).css({'font-weight': 'bold'});\n                        $tdList.eq(0).find('img').remove();\n                        $tdList.eq(0).find('span.fancytree-title').attr('style', 'padding-left: 0px !important');\n\n                        // Calculate total count of adapter and count of installed adapter\n                        for (let c = 0; c < that.tree.length; c++) {\n                            if (that.tree[c].key === node.key) {\n                                $tdList.eq(1).html(that.tree[c].desc || '').css({'overflow': 'hidden', 'white-space': 'nowrap', position: 'relative'});\n                                let installed = 0;\n                                for (let k = 0; k < that.tree[c].children.length; k++) {\n                                    if (that.data[that.tree[c].children[k].key].installed) {\n                                        installed++;\n                                    }\n                                }\n                                that.tree[c].installed = installed;\n                                node.data.installed = installed;\n                                let title = '[<span title=\"' + _('Installed from group') + '\">' + installed + '</span> / <span title=\"' + _('Total count in group') + '\">' + that.tree[c].children.length + '</span>]';\n                                $tdList.eq(1).html(ellipsis('<span class=\"dark-green\">' + installed + '</span> ' + _('of') + '<span class=\"dark-blue\"> ' + that.tree[c].children.length + '</span> ' + _('Adapters from this Group installed')));\n                                break;\n                            }\n                        }\n                        return;\n                    }\n\n                    $tdList.eq(0).css({'overflow': 'hidden', 'white-space': 'nowrap'});\n\n                    function setHtml(no, html) {\n                        return $tdList.eq(no).html(ellipsis(html));\n                    }\n\n                    const idx = obj.desc.indexOf('<div');\n                    const desc = idx >= 0 ? obj.desc.substr(0, idx) : obj.desc;\n                    $tdList.eq(1).html(ellipsis(obj.desc))\n                        .attr('title', desc)\n                        .css({'white-space': 'nowrap', position: 'relative', 'font-weight': obj.bold ? 'bold' : null}).find('>div>div')\n                        .css('height: 22px !important')\n                    ;\n\n                    setHtml(2, obj.keywords).attr('title', obj.keywords);\n\n                    $tdList.eq(3).html(obj.installed);\n                    $tdList.eq(4).html(obj.version); //.css({ position: 'relative'});\n\n                    // setHtml(5, obj.platform);// actually there is only one platform\n                    setHtml(5, obj.license);\n                    setHtml(6, obj.install);\n\n                    that.initButtons(node.key);\n                    // If we render this element, that means it is expanded\n                    if (that.isCollapsed[obj.group]) {\n                        that.isCollapsed[obj.group] = false;\n                        that.main.saveConfig('adaptersIsCollapsed', JSON.stringify(that.isCollapsed));\n                    }\n                },\n                gridnav: {\n                    autofocusInput:   false,\n                    handleCursorKeys: true\n                },\n                filter: {\n                    mode: 'hide',\n                    autoApply: true\n                },\n                collapse: function(event, data) {\n                    if (that.isCollapsed[data.node.key]) return;\n                    that.isCollapsed[data.node.key] = true;\n                    that.main.saveConfig('adaptersIsCollapsed', JSON.stringify(that.isCollapsed));\n                }\n            });\n\n            that.$tab.find('#btn_collapse_adapters').show().off('click').on('click', function () {\n                that.$tab.find('.process-adapters').show();\n                setTimeout(function () {\n                    that.$grid.fancytree('getRootNode').visit(function (node) {\n                        if (!that.filterVals.length || node.match || node.subMatch) node.setExpanded(false);\n                    });\n                    that.$tab.find('.process-adapters').hide();\n                }, 100);\n            });\n\n            that.$tab.find('#btn_expand_adapters').show().off('click').on('click', function () {\n                that.$tab.find('.process-adapters').show();\n                setTimeout(function () {\n                    that.$grid.fancytree('getRootNode').visit(function (node) {\n                        if (!that.filterVals.length || node.match || node.subMatch)\n                            node.setExpanded(true);\n                    });\n                    that.$tab.find('.process-adapters').hide();\n                }, 100);\n            });\n\n            that.$tab.find('#btn_list_adapters').show().off('click').on('click', function () {\n                const $processAdapters = that.$tab.find('.process-adapters');\n                $processAdapters.show();\n                that.isList = !that.isList;\n                if (that.isList) {\n                    that.$tab.find('#btn_list_adapters').addClass('red lighten-3');\n                    that.$tab.find('#btn_expand_adapters').hide();\n                    that.$tab.find('#btn_collapse_adapters').hide();\n                    $(this).attr('title', _('list'));\n                } else {\n                    that.$tab.find('#btn_list_adapters').removeClass('red lighten-3');\n                    that.$tab.find('#btn_expand_adapters').show();\n                    that.$tab.find('#btn_collapse_adapters').show();\n                    $(this).attr('title', _('tree'));\n                }\n                that.main.saveConfig('adaptersIsList', that.isList);\n                $processAdapters.show();\n\n                setTimeout(function () {\n                    that._postInit(true);\n                    $processAdapters.hide();\n                }, 200);\n            });\n        } else {\n            that.$tab.find('#btn_collapse_adapters').show();\n            that.$tab.find('#btn_expand_adapters').show();\n            that.$tab.find('#btn_list_adapters').show();\n        }\n\n        if (that.isList) {\n            that.$tab.find('#btn_list_adapters').addClass('red lighten-3').attr('title', _('tree'));\n            that.$tab.find('#btn_expand_adapters').hide();\n            that.$tab.find('#btn_collapse_adapters').hide();\n        } else {\n            that.$tab.find('#btn_list_adapters').removeClass('red lighten-3').attr('title', _('list'));\n            that.$tab.find('#btn_expand_adapters').show();\n            that.$tab.find('#btn_collapse_adapters').show();\n        }\n\n        that.$tab.find('.filter-input').trigger('change');\n    }\n\n    function prepareTiles() {\n        that.$grid.hide();\n        that.$tiles.show();\n        that.$tab.find('#main-toolbar-table-types-btn').show();\n        that.$tab.find('#btn_list_adapters').hide();\n        that.$tab.find('#btn_collapse_adapters').hide();\n        that.$tab.find('#btn_expand_adapters').hide();\n        that.$tab.find('.filter-input').trigger('change');\n    }\n\n    function onOnlyUpdatableChanged() {\n        if (that.onlyUpdatable) {\n            that.$tab.find('#btn_filter_updates').addClass('red lighten-3');\n            that.$tab.find('#btn_upgrade_all').show();\n        } else {\n            that.$tab.find('#btn_upgrade_all').hide();\n            that.$tab.find('#btn_filter_updates').removeClass('red lighten-3');\n        }\n    }\n\n    function onExpertmodeChanged() {\n        if (that.main.config.expertMode) {\n            that.$tab.find('#btn_adapters_expert_mode').addClass('red lighten-3');\n            that.$tab.find('#btn_upgrade_all').show();\n        } else {\n            that.$tab.find('#btn_adapters_expert_mode').removeClass('red lighten-3');\n            onOnlyUpdatableChanged();\n        }\n    }\n\n    function filterTiles() {\n        let anyVisible = false;\n        // filter\n        if (that.currentFilter) {\n            that.$tiles.find('.tile').each(function () {\n                const $this = $(this);\n                if (that.currentType && !$this.hasClass('class-' + that.currentType)) {\n                    $this.hide();\n                    return;\n                }\n\n                if (customFilter({key: $this.data('id')})) {\n                    anyVisible = true;\n                    $this.show();\n                } else {\n                    $this.hide();\n                }\n            });\n        } else {\n            if (!that.currentType) {\n                that.$tiles.find('.tile')\n                    .show()\n                    .each(function () {\n                        if ($(this).is(':visible')) {\n                            anyVisible = true;\n                            return false;\n                        }\n                    });\n            } else {\n                that.$tiles.find('.tile').hide();\n                that.$tiles.find('.class-' + that.currentType).show();\n                that.$tiles.find('.tile').each(function () {\n                    if ($(this).is(':visible')) {\n                        anyVisible = true;\n                        return false;\n                    }\n                });\n            }\n        }\n\n        if (anyVisible) {\n            that.$tiles.find('.filtered-out').hide();\n        } else {\n            that.$tiles.find('.filtered-out').show();\n        }\n    }\n\n    this.prepare = function () {\n        this.$tab.find('#btn_switch_adapters').off('click').on('click', function () {\n            that.$tab.find('.process-adapters').show();\n            that.isTiles = !that.isTiles;\n\n            if (that.isTiles) {\n                that.$tab.removeClass('view-table').addClass('view-tiles');\n                $(this).find('i').text('view_list');\n            } else {\n                $(this).find('i').text('view_module');\n                that.$tab.removeClass('view-tiles').addClass('view-table');\n            }\n\n            that.main.saveConfig('adaptersIsTiles', that.isTiles);\n\n            setTimeout(function () {\n                if (that.isTiles) {\n                    prepareTiles();\n                } else {\n                    prepareTable();\n                }\n                that._postInit(true);\n                that.$tab.find('.process-adapters').hide();\n            }, 50);\n        });\n\n        this.$tab.find('#btn_filter_adapters').off('click').on('click', function () {\n            that.$tab.find('.process-adapters').show();\n            that.onlyInstalled = !that.onlyInstalled;\n            if (that.onlyInstalled) {\n                that.$tab.find('#btn_filter_adapters').addClass('red lighten-3');\n            } else {\n                that.$tab.find('#btn_filter_adapters').removeClass('red lighten-3');\n            }\n            that.main.saveConfig('adaptersOnlyInstalled', that.onlyInstalled);\n\n            setTimeout(function () {\n                that._postInit(true);\n                that.$tab.find('.process-adapters').hide();\n            }, 50);\n        });\n\n        this.$tab.find('#btn_filter_updates').off('click').on('click', function () {\n            that.$tab.find('.process-adapters').show();\n            that.onlyUpdatable = !that.onlyUpdatable;\n            onOnlyUpdatableChanged();\n\n            that.main.saveConfig('adaptersOnlyUpdatable', that.onlyUpdatable);\n\n            setTimeout(function () {\n                that._postInit(true);\n                that.$tab.find('.process-adapters').hide();\n            }, 200);\n        });\n\n        this.$tab.find('#btn_filter_custom_url')\n            .off('click')\n            .on('click', function () {\n                // prepare adapters\n                const data = {};\n                const order = [];\n                let url;\n                for (url in that.urls) {\n                    if (that.urls.hasOwnProperty(url)) {\n                        order.push(url);\n                    }\n                }\n                order.sort();\n\n                for (let o = 0; o < order.length; o++) {\n                    const user = that.urls[order[o]].match(/\\.com\\/([-_$\u00a7A-Za-z0-9]+)\\/([-._$\u00a7A-Za-z0-9]+)\\//);\n                    if (user && user.length >= 2 && (that.main.config.expertMode || order[o].indexOf('js-controller') === -1)) {\n                        //text += '<option value=\"https://github.com/' + user[1] + '/ioBroker.' + order[o] + '/tarball/master ' + order[o] + '\">' + order[o] + '</option>';\n                        data[order[o] + ' [' + user[1] + ']'] = null;\n\n                    }\n                }\n                that.$installDialog.find('#install-github-link').mautocomplete({\n                    data: data,\n                    minLength: 0,\n                    sortFunction: function (a, b, inputString) {\n                        return a.indexOf(inputString) - b.indexOf(inputString);\n                    }\n                });\n\n                that.$installDialog.modal();\n\n                that.$installDialog.find('.btn-install').off('click').on('click', function () {\n                    const isCustom = !that.$installDialog.find('a[href=\"#tabs-install-github\"]').hasClass('active');//!!that.$installDialog.find('#tabs-install').tabs('option', 'active');\n                    let url;\n                    let debug;\n                    let adapter;\n                    if (isCustom) {\n                        url     = that.$installDialog.find('#install-url-link').val();\n                        debug   = that.$installDialog.find('#install-url-debug').prop('checked') ? ' --debug' : '';\n                        adapter = '';\n                    } else {\n                        const parts = that.$installDialog.find('#install-github-link').val().split(' ');\n                        url     = 'https://github.com/' + parts[1].replace(/^\\[|]$/g, '') + '/ioBroker.' + parts[0] + '/tarball/master';\n                        debug   = that.$installDialog.find('#install-github-debug').prop('checked') ? ' --debug' : '';\n                        adapter = ' ' + parts[0];\n                    }\n\n                    if (!url) {\n                        that.main.showError(_('Invalid link'));\n                        return;\n                    }\n\n                    that.main.cmdExec(null, 'url \"' + url + '\"' + adapter + debug, function (exitCode) {\n                        if (!exitCode) {\n                            that.init(true, true);\n                        }\n                    });\n                });\n                // workaround for materialize checkbox problem\n                that.$installDialog.find('input[type=\"checkbox\"]+span').off('click').on('click', function () {\n                    const $input = $(this).prev();\n                    if (!$input.prop('disabled')) {\n                        $input.prop('checked', !$input.prop('checked')).trigger('change');\n                    }\n                });\n                that.$installDialog.modal('open');\n                that.$installDialog.find('.tabs').mtabs({\n                    nShow: function (tab)  {\n                        if (!tab) return;\n                        that.main.saveConfig('adaptersInstallTab', $(tab).attr('id'));\n                    }\n                });\n\n                if (that.main.config.adaptersInstallTab && !that.main.noSelect) {\n                    that.$installDialog.find('.tabs').mtabs('select', that.main.config.adaptersInstallTab);\n                }\n            });\n\n        this.$tab.find('#btn_upgrade_all').off('click').on('click', function () {\n            that.main.confirmMessage(_('Do you want to upgrade all adapters?'), _('Please confirm'), 'help', function (result) {\n                if (result) {\n                    that.main.cmdExec(null, 'upgrade', function (exitCode) {\n                        if (!exitCode) that._postInit(true);\n                    });\n                }\n            });\n        });\n\n        this.$tab.find('#btn_adapters_expert_mode').on('click', function () {\n            that.main.config.expertMode = !that.main.config.expertMode;\n            that.main.saveConfig('expertMode', that.main.config.expertMode);\n            that.updateExpertMode();\n            that.main.tabs.instances.updateExpertMode();\n        });\n\n        if (that.main.config.expertMode) {\n            that.$tab.find('#btn_adapters_expert_mode').addClass('red lighten-3');\n        }\n\n        // save last selected adapter\n        this.$installDialog.find('#install-github-link').on('change', function () {\n            that.main.saveConfig('adaptersGithub', $(this).val());\n        });\n        this.$installDialog.find('#install-url-link').on('keyup', function (event) {\n            if (event.which === 13) {\n                that.$installDialog.find('#dialog-install-url-button').trigger('click');\n            }\n        });\n\n        // Load settings\n        this.isTiles       = (this.main.config.adaptersIsTiles !== undefined && this.main.config.adaptersIsTiles !== null) ? this.main.config.adaptersIsTiles : true;\n        this.isList        = this.main.config.adaptersIsList        || false;\n        this.onlyInstalled = this.main.config.adaptersOnlyInstalled || false;\n        this.onlyUpdatable = this.main.config.adaptersOnlyUpdatable || false;\n        this.currentFilter = this.main.config.adaptersCurrentFilter || '';\n        this.currentType   = this.main.config.adaptersCurrentType   || '';\n        this.currentOrder  = this.main.config.adaptersCurrentOrder  || 'a-z';\n        this.isCollapsed   = this.main.config.adaptersIsCollapsed ? JSON.parse(this.main.config.adaptersIsCollapsed) : {};\n        if (this.currentFilter) {\n            this.$tab.find('.filter-input').addClass('input-not-empty').val(that.currentFilter);\n            this.$tab.find('.filter-clear').show();\n        } else {\n            this.$tab.find('.filter-clear').hide();\n        }\n\n        if (this.onlyInstalled) {\n            this.$tab.find('#btn_filter_adapters').addClass('red lighten-3');\n        } else {\n            this.$tab.find('#btn_filter_adapters').removeClass('red lighten-3');\n        }\n\n        if (this.onlyUpdatable) {\n            this.$tab.find('#btn_filter_updates').addClass('red lighten-3');\n        } else {\n            this.$tab.find('#btn_filter_updates').removeClass('red lighten-3');\n        }\n\n        // fix for IE\n        if (this.main.browser === 'ie' && this.main.browserVersion <= 10) {\n            this.isTiles = false;\n            this.$tab.find('#btn_switch_adapters').hide();\n        }\n\n        onExpertmodeChanged();\n\n        this.$tab.find('#btn_refresh_adapters').on('click', function () {\n            that.init(true, true);\n        });\n\n        // add filter processing\n        this.$tab.find('.filter-input').on('keyup', function () {\n            $(this).trigger('change');\n        }).on('change', function (event) {\n            if (that.filterTimer) {\n                clearTimeout(that.filterTimer);\n            }\n            that.filterTimer = setTimeout(function () {\n                that.filterTimer = null;\n                that.currentFilter = that.$tab.find('.filter-input').val().toLowerCase();\n                event && event.target && $(event.target)[that.currentFilter ? 'addClass' : 'removeClass']('input-not-empty');\n                if (that.currentFilter) {\n                    that.$tab.find('.filter-clear').show();\n                } else {\n                    that.$tab.find('.filter-clear').hide();\n                }\n\n                that.main.saveConfig('adaptersCurrentFilter', that.currentFilter);\n                if (that.isTiles) {\n                    filterTiles();\n                } else {\n                    that.$grid.fancytree('getTree').filterNodes(customFilter, false);\n                }\n            }, 400);\n        });\n\n        this.$tab.find('.filter-clear').on('click', function () {\n            that.$tab.find('.filter-input').val('').trigger('change');\n        });\n\n        if (this.isTiles) {\n            this.$tab.find('#btn_switch_adapters').find('i').text('view_list');\n            that.$tab.removeClass('view-table').addClass('view-tiles');\n            prepareTiles();\n        } else {\n            that.$tab.removeClass('view-tiles').addClass('view-table');\n            prepareTable();\n        }\n    };\n\n    this.updateExpertMode = function () {\n        this.init(true);\n        onExpertmodeChanged();\n    };\n\n    function customFilter(node) {\n        //if (node.parent && node.parent.match) return true;\n\n        if (that.currentFilter) {\n            if (!that.data[node.key]) return false;\n\n            let title = that.data[node.key].title;\n            if (title && typeof title === 'object') {\n                 title = title[systemLang] || title.en;\n            }\n            let desc = that.data[node.key].desc;\n            if (desc && typeof desc === 'object') {\n               desc = desc[systemLang] || desc.en;\n            }\n\n            if ((that.data[node.key].name     && that.data[node.key].name.toLowerCase().indexOf(that.currentFilter)     !== -1) ||\n                (title                        && title.toLowerCase().indexOf(that.currentFilter)                        !== -1) ||\n                (that.data[node.key].keywords && that.data[node.key].keywords.toLowerCase().indexOf(that.currentFilter) !== -1) ||\n                (desc                         && desc.toLowerCase().indexOf(that.currentFilter)                         !== -1)){\n                return true;\n            } else {\n                return false;\n            }\n        } else {\n            return true;\n        }\n    }\n\n    this.getAdaptersInfo = function (host, update, updateRepo, callback) {\n        if (!host) return;\n\n        if (!callback) throw 'Callback cannot be null or undefined';\n        if (update) {\n            // Do not update too often\n            if (!this.curRepoLastUpdate || ((new Date()).getTime() - this.curRepoLastUpdate > 1000)) {\n                this.curRepository = null;\n                this.curInstalled  = null;\n            }\n        }\n\n        if (this.curRunning) {\n            this.curRunning.push(callback);\n            return;\n        }\n\n        if (!this.curRepository || this.curRepoLastHost !== host) {\n            this.curRepository = null;\n            this.main.socket.emit('sendToHost', host, 'getRepository', {repo: this.main.systemConfig.common.activeRepo, update: updateRepo}, _repository => {\n                if (_repository === 'permissionError') {\n                    console.error('May not read \"getRepository\"');\n                    _repository = {};\n                }\n\n                this.curRepository = _repository || {};\n\n                if (this.curRepository && that.curInstalled && that.curRunning) {\n                    this.curRepoLastUpdate = Date.now();\n                    setTimeout(() => {\n                        this.curRunning.forEach(cb =>\n                            cb(this.curRepository, this.curInstalled));\n\n                        this.curRunning = null;\n                    }, 0);\n                }\n            });\n        }\n        if (!this.curInstalled || this.curRepoLastHost !== host) {\n            this.curInstalled = null;\n            this.main.socket.emit('sendToHost', host, 'getInstalled', null, _installed => {\n                if (_installed === 'permissionError') {\n                    console.error('May not read \"getInstalled\"');\n                    _installed = {};\n                }\n\n                this.curInstalled = _installed || {};\n\n                if (this.curRepository && that.curInstalled) {\n                    this.curRepoLastUpdate = Date.now();\n                    setTimeout(() => {\n                        this.curRunning.forEach(cb =>\n                            cb(this.curRepository, this.curInstalled));\n\n                        this.curRunning = null;\n                    }, 0);\n                }\n            });\n        }\n\n        this.curRepoLastHost = host;\n\n        if (this.curInstalled && this.curRepository) {\n            setTimeout(() => {\n                if (this.curRunning) {\n                    this.curRunning.forEach(cb =>\n                        cb(this.curRepository, this.curInstalled));\n\n                    this.curRunning = null;\n                }\n                callback && callback(this.curRepository, this.curInstalled);\n            }, 0);\n        } else {\n            this.curRunning = [callback];\n        }\n    };\n\n    this.enableColResize = function () {\n        if (!$.fn.colResizable) return;\n        if (this.$grid.is(':visible')) {\n            this.$grid.colResizable({liveDrag: true});\n        }\n    };\n\n    function getNews(actualVersion, adapter) {\n        let text = '';\n        if (adapter.news) {\n            for (const v in adapter.news) {\n                if (adapter.news.hasOwnProperty(v)) {\n                    if (systemLang === v) text += (text ? '\\n' : '') + adapter.news[v];\n                    if (v === 'en' || v === 'ru'  || v === 'de') continue;\n                    if (v === actualVersion) break;\n                    text += (text ? '\\n' : '') + (adapter.news[v][systemLang] || adapter.news[v].en);\n                }\n            }\n        }\n        return text;\n    }\n\n    function checkDependencies(dependencies) {\n        if (!dependencies) return '';\n        // like [{\"js-controller\": \">=0.10.1\"}]\n        let adapters;\n        if (dependencies instanceof Array) {\n            adapters = {};\n            for (let a = 0; a < dependencies.length; a++) {\n                if (typeof dependencies[a] === 'string') continue;\n                for (const b in dependencies[a]) {\n                    if (dependencies[a].hasOwnProperty(b)) {\n                        adapters[b] = dependencies[a][b];\n                    }\n                }\n            }\n        } else {\n            adapters = dependencies;\n        }\n\n        for (const adapter in adapters) {\n            if (adapters.hasOwnProperty(adapter)) {\n                if (adapter === 'js-controller') {\n                    if (!semver.satisfies(that.main.objects['system.host.' + that.main.currentHost].common.installedVersion, adapters[adapter])) return _('Invalid version of %s. Required %s', adapter, adapters[adapter]);\n                } else {\n                    if (!that.main.objects['system.adapter.' + adapter] || !that.main.objects['system.adapter.' + adapter].common || !that.main.objects['system.adapter.' + adapter].common.installedVersion) return _('No version of %s', adapter);\n                    if (!semver.satisfies(that.main.objects['system.adapter.' + adapter].common.installedVersion, adapters[adapter])) return _('Invalid version of %s', adapter);\n                }\n            }\n        }\n        return '';\n    }\n\n    this.sortTree = function() {\n        function sort(c1, c2) {\n            //const d1 = that.data[c1.key], d2 = that.data[c1.key];\n            const inst1 = c1.data.installed || 0, inst2 = c2.data.installed || 0;\n            const ret = inst2 - inst1;\n            if (ret) return ret;\n            let t1 = c1.titleLang || c1.title || '';\n            if (typeof t1 === 'object') {\n                t1 = t1[systemLang] || t1.en;\n            }\n            let t2 = c2.titleLang || c2.title || '';\n            if (typeof t2 === 'object') {\n                t2 = t2[systemLang] || t2.en;\n            }\n\n            t1 = t1.toLowerCase();\n            t2 = t2.toLowerCase();\n            if (t1 > t2) return 1;\n            if (t1 < t2) return -1;\n            return 0;\n        }\n        that.$grid.fancytree('getRootNode').sortChildren(sort, true);\n    };\n\n    function getInterval(time, todayText, yesterdayText, x1DayAgoText, x2DaysAgoText, x5DaysAgoText, now) {\n        now = now || Date.now();\n        if (!time) return '';\n        if (typeof time === 'string' || typeof time === 'number') {\n            time = new Date(time);\n        }\n        const interval = now.getTime() - time.getTime();\n        const days = Math.floor(interval / (24 * 3600000));\n        if (days === 0) {\n            if (now.getDate() === time.getDate()) {\n                return todayText;\n            } else {\n                return yesterdayText;\n            }\n        } else if (days === 1) {\n            if (now.getDate() - time.getDate() === 1) {\n                return yesterdayText;\n            } else {\n                return x2DaysAgoText.replace('%d', days + 1);\n            }\n        } else {\n            const t  = days % 10;\n            const tt = days % 100;\n            // 2, 3, 4, 22, 23, 24, 32, 33, 34, 111, ...x2, x3, h4\n            if ((tt < 10 || tt > 20) && t >= 2 && t <= 4) {\n                return x2DaysAgoText.replace('%d', days);\n            } else\n            // 1, 21, 31, 41, 121....\n            if ((tt < 10 || tt > 20) && t === 1) {\n                return x1DayAgoText.replace('%d', days);\n            } else {\n                return x5DaysAgoText.replace('%d', days);\n            }\n        }\n    }\n\n    this._postInit = function (update, updateRepo) {\n        if (typeof this.$grid !== 'undefined') {\n\n            that.$tab.find('.process-adapters').show();\n\n            this.$grid.find('tbody').html('');\n\n            this.getAdaptersInfo(this.main.currentHost, update, updateRepo, function (repository, installedList) {\n                let obj;\n                let version;\n                let rawVersion;\n                let adapter;\n                let adaptersToUpdate = 0;\n\n                const listInstalled = [];\n                const listNonInstalled = [];\n                const nowObj = new Date();\n                const localTexts = {\n                    'add instance':             _('add instance'),\n                    'update':                   _('update'),\n                    'upload':                   _('upload'),\n                    'Available version:':       _('Available version:'),\n                    'Active instances':         _('Active instances'),\n                    'Installed version':        _('Installed version'),\n                    'readme':                   _('readme'),\n                    'delete adapter':           _('delete adapter'),\n                    'install specific version': _('install specific version'),\n                    'all':                      _('all'),\n                    'Last update':              _('Last update'),\n                    'Installations counter':    _('Installation counter'),\n                    'today':                    _('today'),\n                    'yesterday':                _('yesterday'),\n                    '1 %d days ago':            _('1 %d days ago'),\n                    '2 %d days ago':            _('2 %d days ago'),\n                    '5 %d days ago':            _('5 %d days ago')\n                };\n\n                if (installedList) {\n                    for (adapter in installedList) {\n                        if (!installedList.hasOwnProperty(adapter)) continue;\n                        obj = installedList[adapter];\n                        if (!obj || obj.controller || adapter === 'hosts') continue;\n                        listInstalled.push(adapter);\n                    }\n                    listInstalled.sort();\n                }\n\n                that.urls = {};\n                // List of adapters for repository\n                for (adapter in repository) {\n                    if (!repository.hasOwnProperty(adapter)) continue;\n                    if (installedList && installedList[adapter] && !installedList[adapter].versionDate) {\n                        installedList[adapter].versionDate = repository[adapter].versionDate;\n                    }\n\n                    // it is not possible to install this adapter from git\n                    if (!repository[adapter].nogit) {\n                        that.urls[adapter] = repository[adapter].meta;\n                    }\n                    obj = repository[adapter];\n                    if (!obj || obj.controller) continue;\n                    version = '';\n                    if (installedList && installedList[adapter]) continue;\n                    listNonInstalled.push(adapter);\n                }\n                listNonInstalled.sort();\n\n                function getVersionString(version, updatable, news, updatableError) {\n                    //const span = getVersionSpan(version);\n                    const color = getVersionClass(version);\n                    const title = color + '\\n\\r' + (news || '');\n                    //version = '<table style=\"min-width: 80px; width: 100%; text-align: center; border: 0; border-spacing: 0px;' + (news ? 'font-weight: bold;' : '') + '\" cellspacing=\"0\" cellpadding=\"0\" class=\"ui-widget\">' +\n                    version = //'<div style=\"height: 100% !important;\">' +\n                        '<table style=\"cursor: alias; width: 100%; text-align: center; border: 0; border-spacing: 0;' + (news ? 'color: blue;' : '') + '\" cellspacing=\"0\" cellpadding=\"0\" class=\"ui-widget\">' +\n                        '<tr class=\"' + color + 'Bg\">' +\n                        '<td title=\"' + localTexts['Available version:'] + ' ' + title + '\" class=\"actual-version\">' + version + '</td>' +\n                        '<td style=\"border: 0; padding: 0; width: 30px\" class=\"update-version\">';\n                    if (updatable) {    //xxx\n                        version += '<button class=\"adapter-update-submit small-button m\" data-adapter-name=\"' + adapter + '\" ' + (updatableError ? ' disabled title=\"' + updatableError + '\"' : 'title=\"' + localTexts['update'] + '\"') + '><i class=\"material-icons\">refresh</i></button>';\n                    }\n                    version += '</td></tr></table>';\n                    return version;\n                }\n\n                that.tree = [];\n                that.data = {};\n\n                // list of the installed adapters\n                for (const i = 0; i < listInstalled.length; i++) {\n                    adapter = listInstalled[i];\n\n                    obj = installedList ? installedList[adapter] : null;\n\n                    if (!obj || obj.controller || adapter === 'hosts') continue;\n                    let installed = '';\n                    let rawInstalled = '';\n                    let icon = obj.icon;\n                    version = '';\n\n                    if (repository[adapter] && repository[adapter].version) version = repository[adapter].version;\n\n                    if (repository[adapter] && repository[adapter].extIcon) icon = repository[adapter].extIcon;\n\n                    let _instances = 0;\n                    let _enabled   = 0;\n                    if (obj.version) {\n                        let news = '';\n                        let updatable = false;\n                        let updatableError = '';\n\n                        if (!that.main.upToDate(version, obj.version)) {\n                            news = getNews(obj.version, repository[adapter]);\n                            // check if version is compatible with current adapters and js-controller\n                            updatable = true;\n                            updatableError = checkDependencies(repository[adapter].dependencies);\n                            adaptersToUpdate++;\n                        }\n                        // TODO: move style to class\n                        installed = '<table style=\"min-width: 80px; text-align: center; border: 0; border-spacing: 0;\" cellspacing=\"0\" cellpadding=\"0\" class=\"ui-widget\">' +\n                            '<tr>';\n\n                        // Show information about installed and enabled instances\n                        for (const z = 0; z < that.main.instances.length; z++) {\n                            if (that.main.objects[that.main.instances[z]] &&\n                                that.main.objects[that.main.instances[z]].common.name === adapter) {\n                                _instances++;\n                                if (that.main.objects[that.main.instances[z]].common.enabled) _enabled++;\n                            }\n                        }\n\n                        if (_instances) {\n                            // TODO: move style to class\n                            installed += '<td style=\"border: 0; text-align: center; padding: 0; width: 40px\">';\n                            if (_enabled !== _instances) {\n                                installed += '<span title=\"' + _ ('Installed instances') + '\">' + _instances + '</span>';\n                                if (_enabled) installed += ' ~ ';\n                            }\n                            if (_enabled) installed += '<span title=\"' + localTexts['Active instances'] + '\" class=\"true\">' + _enabled + '</span>';\n                            installed += '</td>';\n                        } else {\n                            // TODO: move style to class\n                            installed += '<td style=\"border: 0; padding: 0; width: 40px\"></td>';\n                        }\n                        // TODO: move style to class\n                        installed += '<td style=\"border: 0; padding: 0; width: 50px\" title=\"' + localTexts['Installed version'] + '\">' + obj.version + '</td>';\n                        rawInstalled = '<span class=\"installed\" title=\"' + localTexts['Installed version'] + '\">' + obj.version + '</span>';\n\n                        //tmp = installed.split('.');\n                        // if (updatable) {    //xxx\n                        //     //TODO\n                        //     // installed += '<td style=\"border: 0; padding: 0; width: 30px\"><button class=\"adapter-update-submit\" data-adapter-name=\"' + adapter + '\" ' + (updatableError ? ' disabled title=\"' + updatableError + '\"' : 'title=\"' + _('update') + '\"')+ '></button></td>';\n                        //     // version = version.replace('class=\"', 'class=\"updateReady ');\n                        //     // $('a[href=\"#tab-adapters\"]').addClass('updateReady');\n                        // } else if (that.onlyUpdatable) {\n                        //     continue;\n                        // }\n\n\n                        // Use different pathes for installed and non installed adapters\n                        icon = obj.localIcon || icon;\n\n                        installed += '</tr></table>';\n                        if (!updatable && that.onlyUpdatable) continue;\n                    }\n                    rawVersion = version;\n                    version = getVersionString(version, updatable, news, updatableError);\n\n                    const group = (obj.type || that.types[adapter] || 'common adapters') + '_group';\n                    let desc  = (typeof obj.desc === 'object') ? (obj.desc[systemLang] || obj.desc.en) : obj.desc;\n                    desc = desc || '';\n                    desc += showUploadProgress(group, adapter, that.main.states['system.adapter.' + adapter + '.upload'] ? that.main.states['system.adapter.' + adapter + '.upload'].val : 0);\n                    let title = obj.titleLang || obj.title;\n                    title = (typeof title === 'object') ? (title[systemLang] || title.en) : title;\n\n                    that.data[adapter] = {\n                        image:      icon ? '<img onerror=\"this.src=\\'img/info-big.png\\';\" src=\"' + icon + '\" class=\"adapter-table-icon\" />' : '',\n                        icon:       icon || '',\n                        stat:        repository[adapter] ? repository[adapter].stat : 0,\n                        name:       adapter,\n                        title:      (title || '').replace('ioBroker Visualisation - ', ''),\n                        desc:       desc,\n                        news:       news,\n                        updatableError: updatableError,\n                        keywords:   obj.keywords ? obj.keywords.join(' ') : '',\n                        version:    version,\n                        installed:  installed,\n                        rawVersion: rawVersion,\n                        instances:  _instances,\n                        rawInstalled: rawInstalled,\n                        versionDate: obj.versionDate,\n                        updatable:  updatable,\n                        bold:       obj.highlight || false,\n                        install: '<button data-adapter-name=\"' + adapter + '\" class=\"adapter-install-submit small-button m\" title=\"' + localTexts['add instance'] + '\" data-adapter-desc=\"' + desc + '\"><i class=\"material-icons\">add_circle_outline</i></button>' +\n                        '<button ' + (obj.readme ? '' : 'disabled=\"disabled\" ') + 'data-adapter-name=\"' + adapter + '\" data-adapter-url=\"' + (obj.readme || '') + '\" class=\"adapter-readme-submit small-button\" title=\"' + localTexts['readme'] + '\"><i class=\"material-icons\">help_outline</i></button>' +\n                        ((that.main.config.expertMode) ? '<button data-adapter-name=\"' + adapter + '\" class=\"adapter-upload-submit small-button\" title=\"' + localTexts['upload'] + '\"><i class=\"material-icons\">file_upload</i></button>' : '') +\n                        '<button ' + (installed ? '' : 'disabled=\"disabled\" ') + 'data-adapter-name=\"' + adapter + '\" class=\"adapter-delete-submit small-button\" title=\"' + localTexts['delete adapter'] + '\"><i class=\"material-icons\">delete_forever</i></button>' +\n                        ((that.main.config.expertMode) ? '<button data-adapter-name=\"' + adapter + '\" data-target=\"adapters-menu\" class=\"adapter-update-custom-submit small-button\" title=\"' + localTexts['install specific version'] + '\"><i class=\"material-icons\">add_to_photos</i></button>' : ''),\n                        // platform:   obj.platform, actually there is only one platform\n                        group:      group,\n                        license:    obj.license || '',\n                        licenseUrl: obj.licenseUrl || ''\n                    };\n\n                    if (!obj.type) console.log('\"' + adapter + '\": \"common adapters\",');\n                    if (obj.type && that.types[adapter]) console.log('Adapter \"' + adapter + '\" has own type. Remove from admin.');\n\n                    if (!that.isList) {\n                        let iGroup = -1;\n                        for (const jj = 0; jj < that.tree.length; jj++) {\n                            if (that.tree[jj].key === that.data[adapter].group) {\n                                iGroup = jj;\n                                break;\n                            }\n                        }\n                        if (iGroup < 0) {\n                            if (!localTexts[that.data[adapter].group]) localTexts[that.data[adapter].group] = _(that.data[adapter].group);\n                            that.tree.push({\n                                title:    localTexts[that.data[adapter].group],\n                                desc:     showUploadProgress(group),\n                                key:      that.data[adapter].group,\n                                folder:   true,\n                                expanded: !that.isCollapsed[that.data[adapter].group],\n                                children: [],\n                                icon:     that.groupImages[that.data[adapter].group]\n                            });\n                            iGroup = that.tree.length - 1;\n                        }\n                        that.tree[iGroup].children.push({\n                            icon:     icon,\n                            title:    that.data[adapter].title || adapter,\n                            key:      adapter\n                        });\n                    } else {\n                        that.tree.push({\n                            icon:     icon,\n                            title:    that.data[adapter].title || adapter,\n                            key:      adapter\n                        });\n                    }\n                }\n                //that.sortTree();\n\n                if (!that.onlyInstalled && !that.onlyUpdatable) {\n                    for (let i = 0; i < listNonInstalled.length; i++) {\n                        adapter = listNonInstalled[i];\n\n                        obj = repository[adapter];\n                        if (!obj || obj.controller) continue;\n                        version = '';\n                        if (installedList && installedList[adapter]) continue;\n\n                        if (obj && obj.version) {\n                            version = obj.version;\n                            rawVersion = version;\n                            version = getVersionString(version);\n                        }\n\n                        const group = (obj.type || that.types[adapter] || 'common adapters') + '_group';\n                        let desc = (typeof obj.desc === 'object') ? (obj.desc[systemLang] || obj.desc.en) : obj.desc;\n                        desc = desc || '';\n                        desc += showUploadProgress(group, adapter, that.main.states['system.adapter.' + adapter + '.upload'] ? that.main.states['system.adapter.' + adapter + '.upload'].val : 0);\n\n                        let title = obj.titleLang || obj.title;\n                        title = (typeof title === 'object') ? (title[systemLang] || title.en) : title;\n\n                        that.data[adapter] = {\n                            image:      obj.extIcon ? '<img onerror=\"this.src=\\'img/info-big.png\\';\" src=\"' + obj.extIcon + '\" class=\"adapter-table-icon\" />' : '',\n                            icon:       obj.extIcon,\n                            stat:       obj.stat,\n                            name:       adapter,\n                            title:      (title || '').replace('ioBroker Visualisation - ', ''),\n                            desc:       desc,\n                            keywords:   obj.keywords ? obj.keywords.join(' ') : '',\n                            rawVersion: rawVersion,\n                            version:    version,\n                            bold:       obj.highlight,\n                            installed:  '',\n                            versionDate: obj.versionDate,\n                            install: '<button data-adapter-name=\"' + adapter + '\" class=\"adapter-install-submit small-button\" title=\"' + localTexts['add instance'] + '\" data-adapter-desc=\"' + desc + '\"><i class=\"material-icons\">add_circle_outline</i></button>' +\n                            '<button ' + (obj.readme ? '' : 'disabled=\"disabled\" ') + ' data-adapter-name=\"' + adapter + '\" data-adapter-url=\"' + (obj.readme || '') + '\" class=\"adapter-readme-submit small-button\" title=\"' + localTexts['readme'] + '\"><i class=\"material-icons\">help_outline</i></button>' +\n                            '<button data-adapter-name=\"' + adapter + '\" class=\"adapter-delete-submit small-button hide\" title=\"' + localTexts['delete adapter'] + '\"><i class=\"material-icons\">delete_forever</i></button>' +\n                            ((that.main.config.expertMode) ? '<button data-adapter-name=\"' + adapter + '\" data-target=\"adapters-menu\" class=\"adapter-update-custom-submit small-button\" title=\"' + localTexts['install specific version'] + '\"><i class=\"material-icons\">add_to_photos</i></button>' : ''),\n                            // TODO do not show adapters not for this platform\n                            // platform:   obj.platform, // actually there is only one platform\n                            license:    obj.license    || '',\n                            licenseUrl: obj.licenseUrl || '',\n                            group:      group\n                        };\n\n                        if (!obj.type) console.log('\"' + adapter + '\": \"common adapters\",');\n                        if (obj.type && that.types[adapter]) console.log('Adapter \"' + adapter + '\" has own type. Remove from admin.');\n\n                        if (!that.isList) {\n                            let igroup = -1;\n                            for (const j = 0; j < that.tree.length; j++){\n                                if (that.tree[j].key === that.data[adapter].group) {\n                                    igroup = j;\n                                    break;\n                                }\n                            }\n                            if (igroup < 0) {\n                                if (!localTexts[that.data[adapter].group]) localTexts[that.data[adapter].group] = _(that.data[adapter].group);\n                                that.tree.push({\n                                    title:    localTexts[that.data[adapter].group],\n                                    key:      that.data[adapter].group,\n                                    folder:   true,\n                                    expanded: !that.isCollapsed[that.data[adapter].group],\n                                    children: [],\n                                    icon:     that.groupImages[that.data[adapter].group]\n                                });\n                                igroup = that.tree.length - 1;\n                            }\n                            that.tree[igroup].children.push({\n                                title:    that.data[adapter].title || adapter,\n                                icon:     obj.extIcon,\n                                desc:     showUploadProgress(group),\n                                key:      adapter\n                            });\n                        } else {\n                            that.tree.push({\n                                icon:     obj.extIcon,\n                                title:    that.data[adapter].title || adapter,\n                                key:      adapter\n                            });\n                        }\n                    }\n                }\n\n                if (that.currentOrder === 'popular' || that.currentOrder === 'updated') {\n                    const akeys = Object.keys(that.data);\n\n                    if (that.currentOrder === 'popular') {\n                        akeys.sort(function (a, b) {\n                            if (that.data[a].stat > that.data[b].stat) return -1;\n                            if (that.data[a].stat < that.data[b].stat) return 1;\n                            return 0;\n                        });\n                    } else if (that.currentOrder === 'updated') {\n                        akeys.sort(function (a, b) {\n                            if (that.data[a].versionDate && !that.data[b].versionDate) return -1;\n                            if (!that.data[a].versionDate && that.data[b].versionDate) return 1;\n                            if (that.data[a].versionDate > that.data[b].versionDate) return -1;\n                            if (that.data[a].versionDate < that.data[b].versionDate) return 1;\n                            if (a > b) return -1;\n                            if (a < b) return 1;\n                            return 0;\n                        });\n                    }\n                    const newData = {};\n                    for (let u = 0; u < akeys.length; u++) {\n                        newData[akeys[u]] = that.data[akeys[u]];\n                    }\n                    that.data = newData;\n                }\n\n                // build tiles\n                if (that.isTiles && (that.main.browser !== 'ie' || that.main.browserVersion > 10)) {\n                    let text = '';\n                    const types = [];\n                    for (const a in that.data) {\n                        if (!that.data.hasOwnProperty(a)) continue;\n                        const ad = that.data[a];\n                        if (types.indexOf(ad.group) === -1) {\n                            types.push(ad.group);\n                        }\n//                        text += '<div class=\"tile class-' + ad.group + '\" data-id=\"' + ad.name + '\">';\n//                        text += '   <div class=\"card-header\">';\n//                        text += '       <div class=\"title\">' + ad.title + '</div>';\n//                        if (that.currentOrder === 'popular' && ad.stat) {\n//                            text += '   <div class=\"stat\" title=\"' + localTexts['Installations counter'] + '\">' + ad.stat + '</div>';\n//                        } else if (that.currentOrder === 'updated' && ad.versionDate) {\n//                            text += '   <div class=\"last-update\" title=\"' + localTexts['Last update'] + '\">' + getInterval(ad.versionDate, localTexts['today'], localTexts['yesterday'], localTexts['1 %d days ago'], localTexts['2 %d days ago'], localTexts['5 %d days ago'], nowObj) + '</div>';\n//                        }\n//                        text += '    </div>';\n//                        text += '    <div class=\"card-body\">';\n//                        text += '       <img onerror=\"this.src=\\'img/info-big.png\\';\" class=\"icon\" src=\"' + ad.icon + '\" />';\n//                        text += '       <div class=\"desc\">' + ad.desc + '</div>';\n//                        text += '    </div>';\n//                        text += '    <div class=\"card-action\">';\n//                        text += '       <div class=\"version\"><table><tr><td>' + ad.version + (ad.installed ? '</td><td class=\"installed\">' + ad.rawInstalled : '')  + '</td></tr></table></div>';\n//                        text += '       <div class=\"buttons\">' + ad.install + '</div>';\n//                        text += '    </div>';\n//                        text += '</div>';\n\n                        text += '<div class=\"col s12 m6 l4 xl3 tile class-' + ad.group + '\" data-id=\"' + ad.name + '\">';\n                        text += '   <div class=\"card hoverable card-adapters\">';\n                        text += '       <div class=\"card-header ' + (ad.updatable ? 'updatable' : (ad.installed ? 'installed' : '')) + '\"></div>';\n                        text += '       <div class=\"card-content\">';\n                        text += '           <img onerror=\"this.src=\\'img/info-big.png\\';\" class=\"card-profile-image\" src=\"' + ad.icon + '\">';\n                        text += '           <span class=\"card-title grey-text text-darken-4\">' + ad.title + '</span>';\n                        text += '           <a title=\"info\" class=\"btn-floating activator btnUp blue lighten-2 z-depth-3\"><i class=\"material-icons\">more_vert</i></a>';\n                        text += '           <ul class=\"ver\">';\n                        text += '               <li>' + localTexts['Available version:']  + ' <span class=\"data ' + (ad.updatable ? 'updatable' : '') + '\" ' + (ad.news ? ' title=\"' + ad.news + '\"' : '') + '>' + ad.rawVersion + '</span>' +\n                            (ad.updatable ? '<button class=\"adapter-update-submit small-button\" data-adapter-name=\"' + a + '\" ' + (updatableError ? ' disabled title=\"' + ad.updatableError + '\"' : 'title=\"' + localTexts['update'] + '\"') + '><i class=\"material-icons\">refresh</i></button>' : '') +\n                            '</li>';\n                        if (ad.installed) {\n                            text += '           <li>' + localTexts['Installed version'] + ': <span class=\"data\">'+ ad.rawInstalled + '</span></li>';\n                        }\n                        if (ad.instances) {\n                            text += '           <li>' + _('Installed instances') + ': <span class=\"data\">' + ad.instances + '</span></li>';\n                        }\n                        text += '           </ul>';\n                        text += '       </div>';\n                        text += '       <div class=\"footer right-align\"></div>';\n                        text += '       <div class=\"card-reveal\">';\n                        text += '           <i class=\"card-title material-icons right\">close</i>';\n                        text += '           <p>' + ad.desc + '</p>';\n                        text += '           <div class=\"card-reveal-buttons\">';\n                        text += ad.install;\n                        text += '           </div>';\n                        text += '       </div>';\n\n                        if (that.currentOrder === 'popular' && ad.stat) {\n                            text += '   <div class=\"stat\" title=\"' + localTexts['Installations counter'] + '\">' + ad.stat + '</div>';\n                        } else if (that.currentOrder === 'updated' && ad.versionDate) {\n                            text += '   <div class=\"last-update\" title=\"' + localTexts['Last update'] + '\">' + getInterval(ad.versionDate, localTexts['today'], localTexts['yesterday'], localTexts['1 %d days ago'], localTexts['2 %d days ago'], localTexts['5 %d days ago'], nowObj) + '</div>';\n                        }\n\n\n                        text += '   </div>';\n                        text += '</div>';\n                    }\n\n\n                    // Add filtered out tile\n                    text += '<div class=\"col s12 m6 l4 xl3 filtered-out\">';\n                    text += '   <div class=\"card hoverable card-adapters\">';\n                    text += '       <div class=\"card-header\"></div>';\n                    text += '       <div class=\"card-content\">';\n                    //text += '           <img onerror=\"this.src=\\'img/info-big.png\\';\" class=\"card-profile-image\" src=\"' + ad.icon + '\">';\n                    text += '           <span class=\"card-title grey-text text-darken-4\">' + _('Filtered out') + '</span>';\n                    text += '       </div>';\n                    text += '       <div class=\"footer right-align\"></div>';\n                    text += '   </div>';\n                    text += '</div>';\n\n                    that.$tiles.html(text);\n                    // init buttons\n                    for (const b in that.data) {\n                        if (that.data.hasOwnProperty(b)) {\n                            that.initButtons(b);\n                        }\n                    }\n\n                    let tTypes = '<li class=\"main-toolbar-table-types-item\" data-type=\"\"><a>' + localTexts['all'] + '</a></li>\\n';\n                    for (let g = 0; g < types.length; g++) {\n                        tTypes += '<li class=\"main-toolbar-table-types-item\" data-type=\"' + types[g] + '\"><a>' + _(types[g]) + '</a></li>\\n';\n                    }\n                    const $types = that.$tab.find('#main-toolbar-table-types');\n                    $types.html(tTypes);\n                    $types.find('.main-toolbar-table-types-item').show().off('click').on('click', function () {\n                        that.currentType = $(this).data('type') || '';\n                        filterTiles();\n                        that.$tab.find('#main-toolbar-table-types-btn').html(_(that.currentType || 'all'));\n                        that.main.saveConfig('adaptersCurrentType', that.currentType);\n                    });\n                    if (that.currentType && !localTexts[that.currentType]) localTexts[that.currentType] = _(that.currentType);\n                    that.$tab.find('#main-toolbar-table-types-btn').html(localTexts[that.currentType || 'all']).dropdown({\n                        constrainWidth: false, // Does not change width of dropdown to that of the activator\n                        // hover: true, // Activate on hover\n                        gutter: 0\n                    });\n\n                    $types = that.$tab.find('#main-toolbar-table-order');\n                    $types.find('.main-toolbar-table-order-item').off('click').on('click', function () {\n                        that.currentOrder = $(this).data('type') || '';\n                        //filterTiles();\n                        that.$tab.find('#main-toolbar-table-order-btn').html(_(that.currentOrder || 'a-z'));\n                        that.main.saveConfig('adaptersCurrentOrder', that.currentOrder);\n                        that._postInit();\n                    });\n                    if (that.currentOrder && !localTexts[that.currentOrder]) localTexts[that.currentOrder] = _(that.currentOrder);\n                    that.$tab.find('#main-toolbar-table-order-btn').show().html(localTexts[that.currentOrder || 'a-z']).dropdown({\n                        constrainWidth: false, // Does not change width of dropdown to that of the activator\n                        // hover: true, // Activate on hover\n                        gutter: 0\n                    });\n\n                    filterTiles();\n                } else {\n                    that.$tab.find('#main-toolbar-table-types-btn').hide();\n                    that.$tab.find('#main-toolbar-table-order-btn').hide();\n                    // build tree\n                    that.$grid.fancytree('getTree').reload(that.tree);\n                    that.$grid.find('.fancytree-icon').each(function () {\n                        if ($(this).attr('src')) {\n                            $(this).css({width: 18, height: 18});\n                        }\n\n                        $(this).on('hover', function () {\n                            const text = '<div class=\"icon-large\" style=\"' +\n                                'left: ' + Math.round($(this).position().left + $(this).width() + 5) + 'px;\"><img onerror=\"this.src=\\'img/info-big.png\\';\" src=\"' + $(this).attr('src') + '\"/></div>';\n                            const $big = $(text);\n                            $big.insertAfter($(this));\n                            $(this).data('big', $big[0]);\n                            const h = parseFloat($big.height());\n                            let top = Math.round($(this).position().top - ((h - parseFloat($(this).height())) / 2));\n                            if (h + top > (window.innerHeight || document.documentElement.clientHeight)) {\n                                top = (window.innerHeight || document.documentElement.clientHeight) - h;\n                            }\n                            $big.css({top: top});\n\n                        }, function () {\n                            const big = $(this).data('big');\n                            $(big).remove();\n                            $(this).data('big', undefined);\n                        });\n                    });\n\n                    if (that.currentFilter) {\n                        that.$grid.fancytree('getTree').filterNodes(customFilter, false);\n                    }\n\n                    that.sortTree();\n                    that.enableColResize();\n                    const classes = [\n                        'tab-adapters-table-name',\n                        'tab-adapters-table-description',\n                        'tab-adapters-table-keywords',\n                        'tab-adapters-table-installed',\n                        'tab-adapters-table-available',\n                        'tab-adapters-table-license',\n                        'tab-adapters-table-install'\n                    ];\n                    that.$grid.find('tbody tr').each(function () {\n                        const i = 0;\n                        $(this).find('td').each(function () {\n                            $(this).addClass(classes[i]);\n                            i++;\n                        });\n                    })\n                }\n                that.$tab.find('.grid-main-div').removeClass('order-a-z order-popular order-updated').addClass(that.currentOrder ? 'order-' + that.currentOrder : '');\n                that.$tab.find('.process-adapters').hide();\n                that.updateCounter(adaptersToUpdate);\n            });\n        } else {\n            this.enableColResize();\n        }\n        this.restoreScroll();\n    };\n    this.saveScroll         = function () {\n        this.scrollTop = this.$tab.find('.grid-main-div').scrollTop();\n    };\n    this.restoreScroll         = function () {\n        if (this.scrollTop) {\n            this.$tab.find('.grid-main-div').scrollTop(this.scrollTop);\n        }\n    };\n\n    this.updateCounter = function (counter) {\n        if (counter === undefined) {\n            this.getAdaptersInfo(this.main.currentHost, false, false, function (repository, installedList) {\n                let adaptersToUpdate = 0;\n\n                for (const adapter in installedList) {\n                    if (!installedList.hasOwnProperty(adapter)) continue;\n                    const obj = installedList ? installedList[adapter] : null;\n                    if (!obj || obj.controller || adapter === 'hosts') continue;\n\n                    let version = '';\n                    if (repository[adapter] && repository[adapter].version) {\n                        version = repository[adapter].version;\n                    }\n\n                    if (obj.version && !that.main.upToDate(version, obj.version)) {\n                        adaptersToUpdate++;\n                    }\n                }\n                that.updateCounter(adaptersToUpdate);\n            });\n        } else if (counter) {\n            const $updates = $('#updates-for-adapters');\n            if ($updates.length) {\n                $updates.text(counter);\n            } else {\n                $('<span id=\"updates-for-adapters\" title=\"' + _('updates') + '\" class=\"new badge updates-for-adapters\" data-badge-caption=\"\">' + counter + '</span>').appendTo('.admin-sidemenu-items[data-tab=\"tab-adapters\"] a');\n            }\n        } else {\n            $('#updates-for-adapters').remove();\n        }\n    };\n\n    // ----------------------------- Adapters show and Edit ------------------------------------------------\n    this.init = function (update, updateRepo) {\n        if (this.inited && !update) {\n            return;\n        }\n\n        if (!this.main.objectsLoaded) {\n            setTimeout(function () {\n                that.init(update, updateRepo);\n            }, 250);\n            return;\n        }\n\n        // update info\n        // Required is list of hosts and repository (done in getAdaptersInfo)\n        if (!this.inited) {\n            this.inited = true;\n            this.main.subscribeObjects('system.host.*');\n            this.main.subscribeStates('system.host.*');\n        }\n        this.main.tabs.hosts.getHosts(function () {\n            that._postInit(update, updateRepo);\n        });\n    };\n\n    this.destroy = function () {\n        if (this.inited) {\n            this.saveScroll();\n            this.inited = false;\n            this.main.unsubscribeObjects('system.host.*');\n            this.main.unsubscribeStates('system.host.*');\n        }\n    };\n\n    function showAddInstanceDialog(adapter, desc, callback) {\n        if (that.main.tabs.hosts.list.length <= 1 && !that.main.config.expertMode) {\n            return callback(true, that.main.currentHost, '');\n        }\n\n        const $dialogAddInstance = $('#dialog-add-instance');\n        $dialogAddInstance.find('.dialog-add-instance-name').html(adapter);\n        $dialogAddInstance.find('.dialog-add-description').html(desc);\n\n        // fill the hosts\n        let text = '';\n        for (const h = 0; h < that.main.tabs.hosts.list.length; h++) {\n            const host = that.main.tabs.hosts.list[h];\n            text += '<option ' + (host.name === that.main.currentHost ? 'selected' : '') + ' value=\"' + host.name + '\">' + host.name + '</option>';\n        }\n\n        if (that.main.tabs.hosts.list.length <= 1) {\n            $dialogAddInstance.find('.dialog-add-instance-host').addClass('disabled').prop('disabled', true);\n        } else {\n            $dialogAddInstance.find('.dialog-add-instance-host').removeClass('disabled').prop('disabled', false);\n        }\n        $dialogAddInstance.find('.dialog-add-instance-host').html(text).select();\n\n        // find free instance numbers\n        let min = -1;\n        const used = [];\n        for (const i = 0; i < that.main.tabs.instances.list.length; i++) {\n            const parts = that.main.tabs.instances.list[i].split('.');\n            if (parts[parts.length - 2] === adapter) {\n                const index = parseInt(parts[parts.length - 1], 10);\n                used.push(index);\n                if (index > min) {\n                    min = index;\n                }\n            }\n        }\n        min += 10;\n        text = '<option selected value=\"\">' + _('auto') + '</option>';\n        for (const m = 0; m < min; m++) {\n            if (used.indexOf(m) !== -1) continue;\n            text += '<option value=\"' + m + '\">' + m + '</option>';\n        }\n        $dialogAddInstance.find('.dialog-add-instance-number').html(text).select();\n        $dialogAddInstance.find('.dialog-add-install-btn').off('click').on('click', function (e) {\n            if (callback) {\n                callback(true, $dialogAddInstance.find('.dialog-add-instance-host').val(), $dialogAddInstance.find('.dialog-add-instance-number').val());\n                callback = null;\n            }\n            $dialogAddInstance.find('.dialog-add-cancel-btn').off('click');\n            $dialogAddInstance.find('.dialog-add-instance-number').off('click');\n        });\n\n        $dialogAddInstance.find('.dialog-add-cancel-btn').off('click').on('click', function (e) {\n            if (callback) {\n                callback(false);\n                callback = null;\n            }\n            $dialogAddInstance.find('.dialog-add-cancel-btn').off('click');\n            $dialogAddInstance.find('.dialog-add-instance-number').off('click');\n        });\n        $dialogAddInstance.modal({\n            dismissible: false,\n            complete: function () {\n                $dialogAddInstance.find('.dialog-add-instance-name').html('');\n            }\n        }).modal('open');\n    }\n\n    function showLicenseDialog(adapter, callback) {\n        const $dialogLicense = $('#dialog-license');\n        // Is adapter installed\n        if (that.data[adapter].installed || !that.data[adapter].licenseUrl) {\n            callback(true);\n            return;\n        }\n\n        let timeout = setTimeout(function () {\n            timeout = null;\n            callback(true);\n        }, 10000);\n\n        if (!that.data[adapter].licenseUrl) {\n            that.data[adapter].licenseUrl = 'https://raw.githubusercontent.com/ioBroker/ioBroker.' + (that.data[adapter].name || adapter) + '/master/LICENSE';\n        }\n        if (typeof that.data[adapter].licenseUrl === 'object') {\n            that.data[adapter].licenseUrl = that.data[adapter].licenseUrl[systemLang] || that.data[adapter].licenseUrl.en;\n        }\n        // Workaround\n        // https://github.com/ioBroker/ioBroker.vis/blob/master/LICENSE =>\n        // https://raw.githubusercontent.com/ioBroker/ioBroker.vis/master/LICENSE\n        if (that.data[adapter].licenseUrl.indexOf('github.com') !== -1) {\n            that.data[adapter].licenseUrl = that.data[adapter].licenseUrl.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');\n        }\n\n        that.main.socket.emit('httpGet', that.data[adapter].licenseUrl, function (error, response, body) {\n            if (timeout) {\n                clearTimeout(timeout);\n                timeout = null;\n\n                if (!error && body) {\n                    $dialogLicense.css({'z-index': 200});\n                    body = body.toString().replace(/\\r\\n/g, '<br>');\n                    body = body.replace(/\\n/g, '<br>');\n                    $dialogLicense.find('.license_text').html(body);\n                    $dialogLicense.find('.license_agreement_name').text(_(' for %s', adapter));\n\n                    $dialogLicense.modal({\n                        dismissible: false,\n                        complete: function () {\n                            $dialogLicense.find('.license_text').html('');\n                        }\n                    }).modal('open');\n\n                    $dialogLicense.find('.license_agree').off('click').on('click', function (e) {\n                        if (callback) {\n                            callback(true);\n                            callback = null;\n                        }\n                        $dialogLicense.find('.license_agree').off('click');\n                        $dialogLicense.find('.license_non_agree').off('click');\n                    });\n\n                    $dialogLicense.find('.license_non_agree').off('click').on('click', function (e) {\n                        if (callback) {\n                            callback(false);\n                            callback = null;\n                        }\n                        $dialogLicense.find('.license_agree').off('click');\n                        $dialogLicense.find('.license_non_agree').off('click');\n                    });\n                } else {\n                    callback && callback(true);\n                    callback = null;\n                }\n            }\n        });\n    }\n\n    this.initButtons = function (adapter) {\n        this.$tab.find('.adapter-install-submit[data-adapter-name=\"' + adapter + '\"]').off('click').on('click', function () {\n            const adapter = $(this).attr('data-adapter-name');\n            const desc = $(this).attr('data-adapter-desc');\n\n            // show config dialog\n            showAddInstanceDialog(adapter, desc, function (result, host, index) {\n                if (!result) return;\n\n                that.getAdaptersInfo(host, false, false, function (repo, installed) {\n                    let obj = repo[adapter];\n\n                    obj = obj || installed[adapter];\n\n                    if (!obj) {\n                        return;\n                    }\n\n                    if (obj.license && obj.license !== 'MIT') {\n                        // Show license dialog!\n                        showLicenseDialog(adapter, isAgree =>\n                            isAgree && that.main.cmdExec(null, 'add ' + adapter + ' ' + index + ' --host ' + host, exitCode =>\n                                !exitCode && that._postInit(true)));\n                    } else {\n                        that.main.cmdExec(null, 'add ' + adapter + ' ' + index + ' --host ' + host, exitCode =>\n                            !exitCode && that._postInit(true));\n                    }\n                });\n            });\n        });\n\n        this.$tab.find('.adapter-delete-submit[data-adapter-name=\"' + adapter + '\"]').off('click').on('click', function () {\n            const name = $(this).attr('data-adapter-name');\n            that.main.confirmMessage(_('Are you sure you want to delete adapter %s?', name), _('Please confirm'), 'help', function (result) {\n                if (result) {\n                    that.main.cmdExec(null, 'del ' + name, function (exitCode) {\n                        if (!exitCode) that._postInit(true);\n                    });\n                }\n            });\n        });\n\n        this.$tab.find('.adapter-readme-submit[data-adapter-name=\"' + adapter + '\"]').off('click').on('click', function () {\n            that.main.navigate({\n                tab:    'adapters',\n                dialog: 'readme',\n                params:  $(this).data('adapter-name')\n            });\n        });\n\n        this.$tab.find('.adapter-update-submit[data-adapter-name=\"' + adapter + '\"]').off('click').on('click', function () {\n            const aName = $(this).attr('data-adapter-name');\n            if (aName === 'admin') that.main.waitForRestart = true;\n\n            that.main.cmdExec(null, 'upgrade ' + aName, function (exitCode) {\n                if (!exitCode) that._postInit(true);\n            });\n        });\n\n        this.$tab.find('.adapter-upload-submit[data-adapter-name=\"' + adapter + '\"]').off('click').on('click', function () {\n            const aName = $(this).attr('data-adapter-name');\n\n            that.main.cmdExec(null, 'upload ' + aName, function (exitCode) {\n                if (!exitCode) that._postInit(true);\n            });\n        });\n\n        const $button = this.$tab.find('.adapter-update-custom-submit[data-adapter-name=\"' + adapter + '\"]');\n        $button.off('click').on('click', function () {\n            const versions = [];\n            if (that.main.objects['system.adapter.' + adapter].common.news) {\n                const news = that.main.objects['system.adapter.' + adapter].common.news;\n                for (const id in news) {\n                    if (news.hasOwnProperty(id)) {\n                        versions.push(id);\n                    }\n                }\n            } else {\n                versions.push(that.main.objects['system.adapter.' + adapter].common.version);\n            }\n            const menu = '<div class=\"collection\">';\n            for (const v = 0; v < versions.length; v++) {\n                const nnews = (news[versions[v]] ? news[versions[v]][systemLang] || news[versions[v]].en : '');\n                menu += '<a data-version=\"' + versions[v] + '\" data-position=\"left\" data-delay=\"50\" title=\"' + nnews + '\" data-adapter-name=\"' + $(this).data('adapter-name') + '\" class=\"collection-item adapters-versions-link tooltipped\"><span class=\"adapters-versions-link-version\">' + versions[v] + '</span> - <div class=\"adapters-versions-link-history\">' + nnews + '</div></a>';\n            }\n            menu += '</div>';\n\n            const $adaptersMenu = $('#adapters-menu');\n            if (!$adaptersMenu.length) {\n                //$adaptersMenu = $('<div id=\"adapters-menu\" class=\"dropdown-content m\"></div>');\n                $adaptersMenu = $('<div id=\"adapters-menu\" class=\"modal modal-fixed-footer\"><div class=\"modal-content\">' +\n                    '<h4>Modal Header</h4><p></p></div><div class=\"modal-footer\">' +\n                    '<a class=\"modal-action modal-close waves-effect waves-green btn-flat \">' + _('Close') + '</a></div></div>');\n                $adaptersMenu.appendTo($('.materialize-dialogs').first());\n                $adaptersMenu.modal();\n            }\n            $adaptersMenu.data('trigger', this);\n\n            $adaptersMenu.find('p').html(menu);\n            $adaptersMenu.find('h4').html(_('Versions of %s', adapter));\n\n            $adaptersMenu.find('.adapters-versions-link').off('click').on('click', function () {\n                //if ($(this).data('link')) window.open($(this).data('link'), $(this).data('instance-id'));\n                $adaptersMenu.modal('close');\n                const adapter = $(this).data('adapter-name');\n                const version = $(this).data('version');\n                if (version && adapter) {\n                    that.main.cmdExec(null, 'upgrade ' + adapter + '@' + version, function (exitCode) {\n                        if (!exitCode) that._postInit(true);\n                    });\n                }\n            });\n\n            /*$(this).dropdown({\n                onCloseEnd: function () {\n                    const $adaptersMenu = $('#adapters-menu');\n                    const trigger = $adaptersMenu.data('trigger');\n                    $(trigger).dropdown('close').dropdown('destroy');\n                    $adaptersMenu.data('trigger', null).hide();\n                    $adaptersMenu.remove();\n                }\n            }).dropdown('open');*/\n            $adaptersMenu.modal('open');\n\n\n            // does not work... must be fixed.\n            //$adaptersMenu.find('.tooltipped').tooltip();\n        });\n\n        if (!that.main.objects['system.adapter.' + adapter]) {\n            $button.hide();//addClass('disabled');\n        }\n    };\n\n    this.objectChange = function (id, obj) {\n        // Update Adapter Table\n        if (id.match(/^system\\.adapter\\.[a-zA-Z0-9-_]+$/)) {\n            if (obj) {\n                if (this.list.indexOf(id) === -1) this.list.push(id);\n            } else {\n                const j = this.list.indexOf(id);\n                if (j !== -1) {\n                    this.list.splice(j, 1);\n                }\n            }\n\n            if (typeof this.$grid !== 'undefined' && this.$grid[0]._isInited) {\n                this.init(true);\n            }\n        }\n    };\n\n    function showUploadProgress(group, adapter, percent) {\n        let text = '';\n        let opened;\n        if (adapter || typeof group === 'string') {\n            if (adapter) {\n               // text += '<div class=\"adapter-upload-progress\" data-adapter-name=\"' + adapter + '\"';\n            } else {\n                text += '<div class=\"group-upload-progress\"';\n            }\n            //text += ' data-adapter-group=\"' + group + '\" style=\"position: absolute; width: 100%; height: 100%; opacity: ' + (percent ? 0.7 : 0) + '; top: 0; left: 0\">';\n            opened = true;\n        } else {\n            percent = group;\n            group = null;\n        }\n        //percent = 80;\n        if (percent) {\n            text +=\n                '<table style=\"height: 3px; \" title=\"' + _('Upload') + ' ' + percent + '%\" class=\"no-space\" style=\"width:100%; height: 100%; opacity: 0.7\">' +\n                    '<tr style=\"height: 100%\" class=\"no-space\">' +\n                        '<td class=\"no-space\" style=\"width:' + percent + '%;background: blue\"></td>' +\n                        '<td style=\"width:' + (100 - percent) + '%;opacity: 0.1\" class=\"no-space\"></td>' +\n                    '</tr>' +\n                '</table>'\n            ;\n        }\n        //text += percent ? '<table title=\"' + _('Upload') + ' ' + percent + '%\" class=\"no-space\" style=\"width:100%; height: 100%; opacity: 0.7\"><tr style=\"height: 100%\" class=\"no-space\"><td class=\"no-space\" style=\"width:' + percent + '%;background: blue\"></td><td style=\"width:' + (100 - percent) + '%;opacity: 0.1\" class=\"no-space\"></td></tr></table>' : '';\n\n        if (opened) {\n            //text += '</div>';\n        }\n        return text;\n    }\n\n    this.stateChange = function (id, state) {\n        if (id && state) {\n            const adapter = id.match(/^system\\.adapter\\.([\\w\\d-]+)\\.upload$/);\n            if (adapter) {\n                const $adapter = this.$tab.find('.adapter-upload-progress[data-adapter-name=\"' + adapter[1] + '\"]');\n                const text = showUploadProgress(state.val);\n                $adapter.html(text).css({opacity: state.val ? 0.7 : 0});\n                this.$tab.find('.group-upload-progress[data-adapter-group=\"' + $adapter.data('adapter-group') + '\"]').html(text).css({opacity: state.val ? 0.7 : 0});\n            }\n        }\n    };\n}\n", "<html>\n<head>\n    <style>\n        * {\n            box-sizing: border-box;\n        }\n\n        body {\n            font-family: Helvetica;\n            background: #64b5f6;\n            -webkit-font-smoothing: antialiased;\n            background-size: 100% auto;\n        }\n\n        .logo { display: block }\n\n        @media only screen and (orientation: portrait) {\n            body {\n                background-size: auto 100%;\n            }\n        }\n\n        header {\n            text-align:center;\n            margin-top: 4em;\n        }\n\n        /*h1, h3 { font-weight: 300; }*/\n\n        h1 {\n            color:          white;\n            font-weight:    bold;\n            text-transform: uppercase;\n        }\n\n        h3 { color: #4a89dc; }\n\n        form {\n            width:          380px;\n            margin:         4em auto;\n            padding:        3em 2em 2em 2em;\n            background:     #fafafa;\n            border:         1px solid #ebebeb;\n            box-shadow:     rgba(0,0,0,0.14902) 0 1px 1px 0,rgba(0,0,0,0.09804) 0 1px 2px 0;\n            border-radius:  2px;\n        }\n\n        .group {\n            position: relative;\n            margin-bottom: 45px;\n        }\n\n        input {\n            font-size: 18px;\n            padding: 10px 10px 10px 5px;\n            -webkit-appearance: none;\n            display: block;\n            background: #fafafa;\n            color: #636363;\n            width: 100%;\n            border: none;\n            border-radius: 0;\n            border-bottom: 1px solid #757575;\n        }\n\n        input:focus {\n            outline: none;\n        }\n\n        /* Label */\n\n        label {\n            color: #999;\n            font-size: 18px;\n            font-weight: normal;\n            position: absolute;\n            pointer-events: none;\n            left: 5px;\n            top: 10px;\n            transition: all 0.2s ease;\n        }\n\n        /* active */\n        input:focus ~ label,\n        input.used ~ label {\n            top: -20px;\n            transform: scale(.75); left: -2px;\n            /* font-size: 14px; */\n            color: #4a89dc;\n        }\n\n        /* Underline */\n\n        .bar {\n            position: relative;\n            display: block;\n            width: 100%;\n        }\n\n        .bar:before, .bar:after {\n            content: '';\n            height: 2px;\n            width: 0;\n            bottom: 1px;\n            position: absolute;\n            background: #4a89dc;\n            transition: all 0.2s ease;\n        }\n\n        .bar:before { left: 50%; }\n\n        .bar:after { right: 50%; }\n\n        /* active */\n\n        input:focus ~ .bar:before,\n        input:focus ~ .bar:after {\n            width: 50%;\n        }\n\n\n        /* Highlight */\n\n        .highlight {\n            position: absolute;\n            height: 60%;\n            width: 100px;\n            top: 25%;\n            left: 0;\n            pointer-events: none;\n            opacity: 0.5;\n        }\n\n\n        /* active */\n\n        input:focus ~ .highlight {\n            animation: inputHighlighter 0.3s ease;\n        }\n\n\n        /* Animations */\n\n        @keyframes inputHighlighter {\n            from { background: #4a89dc; }\n            to \t{ width: 0; background: transparent; }\n        }\n\n\n        /* Button */\n\n        .button {\n            position: relative;\n            display: inline-block;\n            padding: 12px 24px;\n            margin: .3em 0 1em 0;\n            width: 100%;\n            vertical-align: middle;\n            color: #fff;\n            font-size: 16px;\n            line-height: 20px;\n            -webkit-font-smoothing: antialiased;\n            text-align: center;\n            letter-spacing: 1px;\n            background: transparent;\n            border: 0;\n            border-bottom: 2px solid #3160B6;\n            cursor: pointer;\n            transition: all 0.15s ease;\n        }\n\n        .button:focus {\n            outline: 0;\n        }\n\n        /* Button modifiers */\n        .buttonBlue {\n            background: #2196f3;\n            text-shadow: 1px 1px 0 rgba(39, 110, 204, .5);\n            border-radius: 2px;\n        }\n\n        .buttonBlue:hover {\n            background: #39a1f4;\n        }\n\n\n        /* Ripples container */\n        .ripples {\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            overflow: hidden;\n            background: transparent;\n        }\n\n        /* Ripples circle */\n\n        .ripplesCircle {\n            position: absolute;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            opacity: 0;\n            width: 0;\n            height: 0;\n            border-radius: 50%;\n            background: rgba(255, 255, 255, 0.25);\n        }\n\n        .ripples.is-active .ripplesCircle {\n            animation: ripples .4s ease-in;\n        }\n\n\n        /* Ripples animation */\n\n        @keyframes ripples {\n            0% { opacity: 0; }\n\n            25% { opacity: 1; }\n\n            100% {\n                width: 200%;\n                padding-bottom: 200%;\n                opacity: 0;\n            }\n        }\n\n        footer { text-align: center; }\n\n        footer p {\n            color: white;\n            font-size: 13px;\n            letter-spacing: .4px;\n        }\n\n        footer a {\n            color: #eaeaea;\n            text-decoration: none;\n            transition: all .2s ease;\n        }\n\n        footer a:hover {\n            color: white;\n            text-decoration: underline;\n        }\n\n        footer img {\n            width: 80px;\n            transition: all .2s ease;\n        }\n\n        footer img:hover { opacity: .83; }\n\n        footer img:focus , footer a:focus { outline: none; }\n\n        .error {\n            color:          white;\n            text-align:     center;\n            padding:        0.5rem 1rem;\n            position:       absolute;\n            background:     #ef9a9a;\n            top:            10px;\n            width:          400px;\n            left:           calc(50% - 200px);\n            border-radius: 2px;\n        }\n    </style>\n</head>\n<body>\n<header>\n    <h1 id=\"login-label\">ioBroker Admin</h1>\n</header>\n<form action=\"/login\" method=\"post\">\n    <div class=\"group\">\n        <input type=\"text\" name=\"username\" id=\"username\" class=\"used\"><span class=\"highlight\"></span><span class=\"bar\"></span>\n        <label id=\"username-label\" for=\"username\">Name</label>\n    </div>\n    <div class=\"group\">\n        <input type=\"password\" name=\"password\" id=\"password\" class=\"used\"><span class=\"highlight\"></span><span class=\"bar\"></span>\n        <label id=\"password-label\" for=\"password\">Password</label>\n    </div>\n    <input type=\"hidden\" id=\"origin\" name=\"origin\" value=\"\"/>\n    <button type=\"submit\" class=\"button buttonBlue\" id=\"submit\"><span id=\"submit-label\">Submit</span>\n        <div class=\"ripples buttonRipples\"><span class=\"ripplesCircle\"></span></div>\n    </button>\n</form>\n<div id=\"error\" class=\"error\" style=\"display: none\"></div>\n<footer><a class=\"logo\" href=\"http://iobroker.net/\" target=\"_blank\"><img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAScwAAEnMBjCK5BwAAABl0RVh0U29mdHdhcmUAcGFpbnQubmV0IDQuMC4yMfEgaZUAACHYSURBVHhe7Z0LmB1FlcczhIisSiBzq3tmCA/dCIigZG6CUdDLdHXfhIeuCuOuiwqyGhWMMZnpqnsT4cIKKgoor2Qm6IKIuxIEFmEBl/UBopKZgQ8VBEVQw0MBeRkBA8nMnrpzIMOkApNJd1V19/l93/8L5DH1r+pTp6u6q6umEARBEARBEARBEARBEARBEARBEARBEARBEARBEC4wMtJy4Nm37DT7glvf1Nk32DW7f+DIzr6hEzpXrDmxs3/oS+X+wfNA3wJdXu4bvBr+zvfHSv1e88/U3+kbPL+zb+D0zhWDJ87uH/x0eeXgUZ2rhoK55615c7l/aLoqC0slCMIGs/sG3t25cuBM6LxXdfYP3g6d/CnouMPQQUdSFZQB5a2DBPHLZtJYOfhV+P33oi2CIExQ7r8V7tiaDmpBagSBtgiCmBTd3VNZ1HtAKZCLPS4vbz+i8Q/4J1qylAAqlcb2Xii+2xrInlK1Vp7SvXoq/hFBFJfWMO7wuTwOOvylLBSPeqEceUGt74lfh39NS5YSQHnhwmmQAJ5/sX5cPO6Fte/C7328o7p8N/xrBJF3RlpKXM5mXJwCneBW6AzDL3aKccp1AniphiH5/YJF4rQ2Xps7pdHYDv8ZQeQD1iXfCnf50yHQ79V0AK0KlABeIhbKP4DObOU9c+Gf0tsGIpuo4T10+F642/9KF+ivpKImgLGC9rvL57V6eyh3xx9FEA6jHnZx+U8QvFdPJuDHihLAGHGxAdr1ehbF3ft2N16FP5Yg3KBtQZ1BgC+HIF2rDeBJiBLAFsTFQ4zHJ5fmL2vHH08QdmgL6vsyLvtgzvqMNli3QZQAXkFcrAdd6AX1t2AxBGEGj9fe7nNxFQT1Rm1wJiBKABOVGPZ4fH0pjCtYHEGkAwTbPBaKG/SBmKwoAUxG4ia/SwZYLEEkg3o/DfP7a/VBl44oAUxeMC37PxbVD8LiCWJywLDyjdDxL4W55hYX7KQlSgDbrGFIBFe1heJNaIMgJsYuoZzOInFG80GTPrhSFyWApKTKFed38For2iGILdDdPdXj8UK4czysDyZzogSQrBgXj/m8d5H6MAltEcQmSkHcCR3/Fl3w2BAlgJTExe3gZR5aI4qOH/W8Bub5X4HA2KANGEuiBJCmxEa45ufOWNDYCS0SRcTjtRAC4nebB4h9UQIwIC7W+lwcjjaJoqA224AAOB9k/On+REUJwKC4uJBGAwXBD8SBLJR3awPBIVECMCvGxX2loP5OtEzkjkZjOy9ofrDznC4AXBMlAAviYgNMCU4rlxdOQ+tEHvCCum9qCW9SogRgUVz8ZNeKmIn2iSxTiuS74II+pL3QDosSgF3BlOCRtkgcilUgMkiLx2tLsxZ4L4gSgAPi6nWhOJH2KcwYM+ct2RGG/JdoL2pGRAnAHcFo4ApWabwWq0O4THMvPi6cWdE3WVECcEtwQ/mFP1/uiVUiXEQdrAGB9oDuAmZNlADc0+g3IrSM2Em8qojg4vxVd+GyKEoAbgqSwDNeENNZiC7BeO0YGKJl4v3+REUJwGFxuYHx+HisHmETjwv1pN/ZJb2TFSUA9wWjgZOhenR4iSVa1AXQXZg8aFsSAHTIDZ19A4909g/dpjqnOvO/s3/gnM6+oVM7Vw7VZ6+8ZQn8+QmzVw5+Qqlz5cDx8P+fhV/rzb/TN3h2edXQxeW+wevh3w7Br3+Gn/W8riyloiYAJcbFGVNGRigJmGWkBYb8Z+kuSF40kQQAHW8ddNib5/QN9UFHXjJnxcChc74+sDd0ypc9WXgyzDvzZzvOXbVmLyizCklkcefKwRWQGG6Csp4scgJQYqHsU5vJYHWJtMl751d6pQQw97w1bd2r7R+z3WiMbPe2C37u4/9qyXsCGJW4kBYMpU7+7/wv6JUSQJYoRgJojgT6KQmkiBfVvqRr+DyJcXkHi8Qp6pxBrHb2UV9iNo9OU9tx6eudG3GxQt2osOZEUvhhLLUNngPBqOaBEhdf9KP6fljd3NJare/jh+LzjIvf69oiF4JridUlksAL409Cw+bqVR90+vXqzAHWVatO6bY/lzcOjAr8SAbQDpeAntW1UcbVgzUltgXGe49UCy80DZxNcfknL5An0em2m/CjHg9GBHWYQ9+vbbNsahjqdAxWkZgMMG+cl8bJu1bExW/VmQN7VBqvxuoR41Bn/7NAHgsjgju1bZgxQew+B6NXjtUjtgZWrc2CQHhE17AZ0x1+IP7F5DB/3qVrd5x9/q1vmtM/EJZXDn6kvGJNrbNv4ItqvUC5f+g75f7B74Gu6+wbukFJ/Xfz9/oGL4Vf+zv7h74Ef6/WuWroWPj30YErb9s3jbUFW0Q9NAzq74UbwG2a9syYxBP+fPFmrBkxEeAuuTPcMe/SN2g2BMnr9608PjrN10Ldq0emdvYN7g86BjryWfArdOiBP8KvG6DDalftTVbwMzeC7ock8QPQ12ZfcOtH565ac0DlRyPpva2AtmOROAo60W90bZwVqQeeapqDtSJeltHjuYyexJukoOM/Dr/2zFqwaAesUSrAnfrL0CHX6TqrSXWuHHi6vGrwa2grFcrl/mnQrp+GjpTZESFMB25SUxysErEloLFOH994mVDzCzG5sr3SKGFVUiVLHwMlhRoZ+jz+KowIMrmoCBLYSqwKoaMUig/oGs59idvaeG0uVsMIRUwAL8C65FthRPAz/bVwWyysfRSrQYxFLRCBu+hTukZzVZDRn4GhnbSxj3yRE0ATmCr6kfgMJN91umvjqtRbrdL8uBNrQShmHqU28ZS/0DWYq4Lh/s87uuK9sQrGKXwCQPyo5/UsED/SXSNnxcU9u4RyOlaB8EPRr20oF8WFmuufbHutPiWAMahVhWFvDa5LZnaFgtHjt9F9scnUvJ+LtTBSORitW4USwOa0hcvmqLur9to5qBKPj0PrxWTGAjETLph6baZtIKfE5bXtlaVGnvBPBEoAetTQmoXiCu01dEwwYvlbKYzfiNaLxkiLF4jrdA3jlsQwXKhT01zQMxkoAbwcIy0+r9Uz8Q0JFzcXcjchxmvHaxvEIY1maPEBtOwUlABemRIXh0MHc/7NEguEQMvFQD25hQvj9usbLh5q7+opo2XnoAQwMdQeCyyUf9BeY0cE/p5tC8Wb0HLegaE/l9frGsIdibv9aPnr0bCTUAKYOOq4OEjoTu9GpBY2FWIq4AXyQ7oGcEWMxz/v4LVWtOsslAC2jubDQS5/qLvmrogF8gS0m09mVpfMgIvwsK7yLohx8UNWOT4Tp8BSAth6mqdGB/Jq3bV3RE+ww3rb0G7+gLlOn6bSbgimJX7U8xq06jyUACZHc9MRLq7UxoADgj5yCVrNF7hIY6Ou0vYlrsvaTj2UACaPSgIlHl+ujwX78rk8BK3mhhbo/DfpKmtdXNzYfkTD3G43CUEJYNsoL+yfphZ3aWPCtri4PVcPBFlU69ZW1LJYKAay+lEGJYBtRyV+GP25eWMK44+hzWyjdsaBOdd9+kralPiNqc070oASQDKoTUbgRuDel6hcPMQqjUw8kH5ZoCJLtRW0KBbKR0vvyvYabEoAybFrRcyEuHhgfJxYFxcnosVsMvruVTyqrZwlQbZ/loVLnfiib1ugBJAspSDuhFGha6tT/5rpzUQ9XjtRUymrYmH8YbSXaSgBJA/cHN4PMeLUCVQskGeivWyBd3/XPvU9G+1lHkoA6QDTw3/XxI01QR96mlUyuDgIhlMNXYWsidd+ol79oL3MQwkgJdS29IF06jN1SAJnoLtsoM62d+nuD14emREs2xXt5QJKAOnRtqDO4Abm0ENBsS4L36e8CMylevUVsSAuhtV34WgtN1ACSJe2MK5A7DizoQjcxE5Ba27TfO/vVvY8B63lCkoA6QNx/Hl9TFkQl49lYl2AY5/73p3FZb4TgRJA+jSXCzt0QGkmPheGTDWoM29cMHzzo563oa3cQQnADOoUIoil9doYMy0u73Ztb8qXwKL6QVrjNsTlV9BWLqEEYA6Ip5M2iy9LKgXiULTlHiwS/6kzbVqMiz9kZWOPyUIJwBzNPQRCcacu1kwLYvt7aMst1GIFd4ZKvf+EtnILJQCztHJ5iBcK+6sEudzgV+SeaMsdGI9jrWHDgkx9NVrKNZQAzAPx9V/j482G1NsJtOQKIy2QHe0PkWAEUuK1vdBUrqEEYJ6O6vLdYAj+tDb2TIrL+6d0r3ZnwxC/Kg7UGjUsyIxnoaXcQwnADozLk3WxZ1osqlXRkn3UYhudSaPi4qksb/CxtVACsINajAOjAAd2thbfREt2KZcXToM77yN6k+akMjNaKgSUAOzhhbXP6mLQqNQNz4VFbuq9pNagQUEC+suMBYt2QkuFgBKAPdT5AjAPf1AXiyal9tpES/aATHShzpxZieVopzBQArALxN3izePQsHhtNdqxg1orre6+WnPm9OT0SmNntFQYKAHYRQ2/bT8LUKdXWz3MxuO9oc6YUfE410t+twQlAPuUYOSpjUmDghvw+9GOecDA2eMNmZV4vq2rZw+0UygoAdgHRgEluAs/o49NY7oI7RhHnfZzj8aQOXF5GXopHJQA3ABuQt/QxqYhwQjgz1ZOEWLV2iydIZMqhXEF7RQOSgBuMLqduD4+TaktjOegHXOozQl0ZkwJhl6/Bhsto26KByUAd4CRqNU9MEqBXIZWzKE+S9SZMSYulqKVQkIJwB08Hi/UxqghsVD+EK2YoVJpbA8FPzneiDmJ59lhGdwrPUEoAbjDjAWNnWw+DISy/z7zqCU7op308QPrH/9ch1YKCyUAt4CY/M64GDUqP4i70Er6tIayR2fClPyg91i0UlgoAbiFF9Tfq4tVc6o10Er6sLB2hd5E+oL5znMzq40ZaKWwUAJwCzUE97i9w0WhX/wvWkmbkRbGxUM6E0bEReGDTUEJwD3UuhRtzJoQl381sh6gPZS7aw0YEiSfT6GVQkMJwD0Y7/2ILmaNiYv90Up6eJF8n7ZwMxp2ckNEC1ACcA91lj90wo2auDUiFsn0n43ZPD6ZheJOtFF4KAG4iReKAV3smpGBY/D8SF6lLzx9lXJ6zt9koATgJiwSp+li14Rgenwj2kgPuAvfqyvchKx++ugYlADcxOM1a5/IMy4fS/XoMLUhIgwz7ByOAHMrP2p4aKXwUAJwk+ZGIaF8ThvD6Wu4NYw70ErytIXL5mgKNSMufos2CIASgLtAvFp7DgBT9ABtJI/H46N1hZoQzG++jTYIgBKAu8Ao+XxdDJsQ4/HxaCN5WBBbewPgcbkEbRAAJQB38Xl8nDaGDQhulGegjeSBTnixrlATMvqxQwagBOAupWqtrIthE2JcXoU2kgcSwE91hZpQB6+1og0CoATgLs3vAkJh6UGguA1tJA8ML9bqC01df0ILBEIJwG0gZu8eF8NGBH30cfW9DtpIkIULp0F2eV5XaNpioTC740kGoATgNh4X1+hiOX2J4VSODPOCuq8vMH3BvGYV2iAQSgBuwyJxhi6WTaijK9571EWCtNt8sBH21tAGgVACcBu4aS3SxbIJsah+ENpIDtZVq+oKM6FWHh+NNgiEEoDb+IF8ty6WjSiS70MbyVEKxL9oCzOgUhC/E20QCCUAt7G6ajYQn0AbyeFbHNK0V+v7oA0CoQTgNmrXal0smxALpEQbyeFx+TldYSb0hlBORxsEQgnAbWYtWLSDx+18OOdH4jS0kRylMP6CrrC0xbhYr84hQBsEQgnAfbzQ1iah4jy0kBwsFGfpC0tZXDyVzsKGbEMJwH3g5vVHbUynr+RPDGah7NcUZEL3owViDJQA3IdxeYcmntMXl5eiheSAH3zRZgWZEBd3oQViDJQA3Adid0gb0ykLbtZXooXkgB9q6egjcTtaIMZACcB9IH6tfDwH0/XvoYXk8CKxWleYAa1BC8QYKAG4D8Supa9nRfJnZ1ICcAtKAO4DsWsrASR/PawlAJhHoQViDJQA3Afi19IUQF6NFpID5hXf0hWWthgXv0ILxBgoAbgPdMQ1uphOW+k8AwjFN3SFpS3G5X1ogRgDJQD3gdHr7bqYNqDL0EJyeFyeqykodcEI4FG0QIyBEoD7wM3rt7qYTlvQZ5LfQRtGAF/WFZa2oDJPd5s49jhjUAJwHxiKP6qL6bQF5fajheSAbHayrrDUxcXGPSqNV6MNAqEE4DiNxnZw07SzhV4kkt8aHLJKr64wE+qoLt0NbRAIJQC32aOyeGddLBsRFyeijeTwQ/FRbWEG1MZrc9EGgVACcJv26tJ9dLFsQn5U+wzaSA6fx0foCjMhn4vD0QaBUAJwGy+MuS6WjSiQH0IbyaG25dIWZkAw/fg02iAQSgBuw7j8iC6WjYjXQrSRHKyr9x+1hZnR6WiDQCgBuI21h+YgFi07AG0kB6s0XuuFdrY4ghFA8p83ZhxKAG4DfeWbulg2IT/q8dBGssAPf2J8YSYECeBOtEAglADcBkYAP9fFctpiXDw7Ja11M9aWNnKxvlxeOA1tEAAlAIdprgGwdrO8F10kD/zwq3WFGhEX+6MNAqAE4C4d1eW7aWPYgGAE8AO0kTw+l1/VFWpEUQqvNjIMJQB3KXFxuDaGjUh8A20kj3odpy80fbFQnok2CIASgLt4gTxJF8MmBCOAOtpIHq8qIl2hJgQJ4Ca0QQCUANzF5lQZyn4/2kieXReImbpCTUh9Fbhvd+NVaKXwUAJwlhaI1Ud0MWxCftSzH/pIhRaPi6d0BZuQH4gD0UfhoQTgJq3VurVvAGD+v37WgrN3QCvpAAXdvHnBZsS4jNFG4aEE4CZw9/+ULnZNiPH4DrSRHlDBlbrCDSn57Y4zCiUAN4EYvWxczJoTl/+FNtLDC+NPags3IPUcYOa8JTuilUJDCcA91CG2EKOP6WLXhFgQJ38s+HjaeM9cXeGmVIrEoWil0FACcA8WyoN1MWtMvDf5rwDHox4yeKF4VmvAjM5HK4WGEoB7QGyePi5Wzam5dd7indFKutj60KEpLh5Ua63RSmGhBOAc6g3ZXdqYNSAYfaT/APAFWCDP1JkwJRb1HoRWCgslALfwo/p+ulg1JRaksBPwlvAi+T6dCXOKz0YrhYUSgFuwSJyij1VDSmMbsC3RwWutas6hNWJCXD44pdLYHu0UEkoALjGihv9WDgFBDbeHcnc0YwYvFLdpjBhTKSj22wBKAO7AovpBuhg1Ji5/CzZaRt0YwgtrVk4K2iTxHbRSSCgBuAOzdG7mC2Jc9qEVc1jd9liJi/VeUPfRTuGgBOAG0yuLd4YO+DdtjBoSlH8k2jHH6HoAuW68GbMSy9FO4aAE4AbQ+RbpY9OYnjP2/n88LJJXaQyZE5dri7pXICUAB2g0toME8GttbJoSFzeiG/PAHfjjWlMm1RV/EO0UCkoA9lEPorUxaVCsS/SiHfOU5i9rt/o6sCkxAFbMPgF1AEoA9mFc/EAfk+bEqrVZaMcOMAy3tj/Ai0rjKCTHoQRgFz+qvU0biybFxe1oxx4lLj6jNWdSXPwE7RQGSgB2gZj7H20smlTgwEPw1jDusD8NABVsFEAJwB4w7ZwHsnJM3iaJYevD/xdgobhBb9KcWChvUUsy0VLuoQRgD7jhfV8Xg0bF5Rq0Yx9m8yjkMUp1S2THoARgh9ZIBrrYMy3GexehJfu0vid+ne3VUErg4e5yub8Q6wIoAVhAvfcP5a262DMpuNE9l9oJwJMF5uAX6swaF4+XoKVcQwnAPE6sewFBArgCLbmD9f3QNulJtT4BbeUWSgBmmVldMoNZPPBjrBzdF3OkBTLTnTrDpgU+LkFTuYUSgFng7n+eLtZMC6a59zm7JR7jteN1ps1LDHuBiNBWLqEEYA6Ip3kelxv0sWZWLBACbbkHqzReCyafHG/ahmAUcK8f9bwGreUOSgBmmLVg0Q7ujGzlM+2VpSW05iYsjK1uGDpWpVCcg7ZyByUAM0AcfWF8XNlTimf/J4U/X+4JRp/XV8C4hllUq6K1XEEJIH08Xnu7x4UTQ3/QMHjZH625jcfjSzUVsCMu71dPcNFabqAEkC7N6SwX92hjyoa4vBatuU8piDvBtOW10psEc7gr87ZMmBJAqqg3Wt/SxZIttXXJd6G3bADZ0/7XUmMVxD1oLRdQAkgPmMI6seDnRXH5Y7SWHZz4XnqMWCifU9s3o73MQwkgHVi07AD1tF0XQ9aU1VfakLncGgVw+eCMYNmuaC/TUAJInrYFdca4+L02dmyJy5vBWjanr6NHidv+bvqlgrndQPsRjX9Ai5mFEkCy7NvdeBV0/ht1MWNTfiQDtJhNoMNdoauYVUViddZPGKYEkCgtLIy/ro0Vi4K+cwP6yy7tlfo+UJnnxlfOvsSX0WImoQSQHDDM/pw+RmxKbCxxORstZhuojBMfUmymQC5Gi5mDEkAy4BN/p6apTXFxMVrMPurhCjT0E9qKWpUYZpE4Bm1mCkoA2w7j8kiIAVdWrb4oxsXTxk/7TRsYZi3RVda6uNhQCsUH0GZmoASwbfhcHA4x+XdtTFgWJIBT0GZ+KC/snwYNbvcYpS2ouUbAxgGL2wAlgMnDDhHzoZM9q4sF21KvIWcetWRHtJov1CsNqKR7862m1FAwO8eMUQKYHBCD72ahm51fyQ/ku9FqPoFOdpGu4k5ITQci8W9o1WkoAWw96hxJuMM6+EZqVDAKvRKt5pfmaqtQ/EXXAI5omIWxRLvOQglg62BR7wkwyrN/gM0WJdbl7sHflmBh7cP6RnBIkTx3SvfqqWjZOSgBTJBGY7sSF1/UXmOHxCJ5AjouBC0w3L5G1xCO6eoZCxbthJ6dghLAK6OWfHtcXqa5rk4JpiU/zPrK1K1m9ExB+ZiuQVwSC+WvPF57A9p2BkoAL8+MipgJ125Ad02dEpd/dTG+jKDev2sbxTExSFSlrvgwtO0ElAC2jB/1BND5/6y7ls6J1xai7WLCQnGJtmFcExcbfS5Oc+W5ACUADTCMhmu1zMXVfTrB0P974LowB9pq2aOyeGdoiPt0DeSiwOuPXXhaSwngpajToGA4fb3umrkp8YB6I4b2i00rr82Fi+fksky9xBNeID+E9q1ACWATXiTfB0P+R/XXykFxscHn8hC0TyigU31W21gui8vLbGVxSgAvntfn1OadE5NoYBWITYy0lELxXX2DuSzxFxb0Hmt61+GCJwAVK+oB8p82vx6uS1w3pbvb2fUlVlHv3JkjxzBttbj4sR/V98OqpE5n/9Dlus5oQ50rB65BW6lT4rW9oK2/r70Gjgti+948nlGRKCW+dC9oLAf3DpiIxPNwkc/a/eDaLlid9Gg0tpu7as2b56wYOK7cP3ge3IV/Anq83Dc0rOukyWhwpNw3+ASU8VMoawXoY7MvuPUt3avTfzOibg7Qxl/I1rOiTYKpytMs6j0Aq0O8HKVAHKoelOgaMgtS3zqAemfOM/5ZZ8tbVvzUO6D/tneUVw5+EDptbU7f0FnQaS+FTnsDdNhbOvsG7oLRw1rozA939g09pQR//gj82f2gu5p/p3/o/+Dfrobf/1rnioFl5VXNn3Xw2y74pT9lxOxUp7lZZyg+DR3oYV1bZ0NimAW1bqwSMRG8MF6sb8zsCIJ2rReJT6ggxmoRE6XS2L6Ni2OgDTPzinjLEsuxVsTW4PH4XH2DZktwB/u9F4hPWBgRZA51HLcfio9Cp/mNri2zJ/HNvB1LZ47u1VNZKK/UN2z21FyeGsiTvKDuYw0JpIPXWtVn2NBGD+jaLouCxH8Djf62kdEvusTNugbOqiAwnoU6XayOT8NqFpbS/LiT8fjr0PGf1rVVdiVudfVL0syBCz5+oW/ojIuL22Gqs4Qd1tuG1c09zU1hAnkC1H1I2yaZF0xfaJSXLKzS25afeaFOzVeIN5RC+bE8rhFvJvGo91iPy2shmTu7Ldc2i4u1fkXuidUmkqSta/kezQdquobPk9QrUC5+7EViaXu1vg9WP3OUwviNpSBerBIbDPHz2+lfEBcPqTpj9Yk0YF29/wiN/YfNGj/Har5ODMU3S1we19EV7+3k7jHgiVVrs8DrMXCX/3o+Xt9thaDzt2Y4WWcKtYNK4QJsjOCO+hcIuO97QfyFtijubgvq+5p82lwuL5zWMT/eW52lwHh8KiSn6+C/M7xQZxtFnd88ajoAgXeP9oIUUc15tbgL/vtataGpeqUGifJoUKiWoKo9DHYJ5fRKpbF9d3f31AbcscdK/Z76M/V3OqrLd2Nd8q3Ncxy4+Ffo5DH87HPgv6+Bjv5rSL7rNyu/qOLij2rkg2FJmEQ9GIS7YT7fDqSpZgcW616i0TX2jh7a4qrEb9SNCMORsMHuh9d2geDN1ToBUgakXmHSqz43UIuFYCTw39oLRSIlLJgG/W/re+LXYfgRTtC9empevh0guasSl/9By3sdxufiMzAlyOynxCRHxcUwxFYdQow+7HEdxmsLPLVxp+5CkkhbKRjy/40F4igMLyILqAUzLKvbi5HcERf3gPbHsCKyROs74teVQvfPhiM5Ki6vnX64ge3diDQZaYELuWT03bfmIpNIm0mdLCSWF+7AzjzTFsZz4OL+bvOLTSKNEZf3l4L4nRg2RJ6YsaCxE+Pi29oLTyJxebnamQjDhcgr6lCJ5gc1uiAgFVFPskgeC6FBr/iKgjpM0ufyKk0wkIokLq934bBXwhJeNT6aZelgSVJCUutExMdpx15iSnulUVJLPNVqL32wkHKkYcblf7LDGoXZg5GYIDASOJhx8UtN0JByIbVZp4jwchPE5qjdbprfE9BDwjzpSRYIQR/xEBNmZrUxg4XiLBguZvIwSlJTapek8+m7fWLS+FHP65trB7jYqAkwkpsaLvH4crVvIV5Ggtg24C7yFo+r7wooEbgrMQyJ+hq16hMvG0Eki/oyDKYG34Ffac8BVwSjMxilXUEdnzBGidf2YqP739MzAmsS66HzX+xH9f3wshCEWdQDJi+IT4LpwYP6ICUlLRbKP0PyPXVGsGRXvAwEYRf1iqkU1j8Ad6UfQZDSgqJ09FMvkh+atWDRDtjsBOEe7dWl+0Ai+DIMTx/SBDFpKwRTrIdBX6NhPpE9Ko3tWVSreoG8CIL5yfHBTdqSxDoY5l/ic3G4WpiFrUkQ2WWPSuPVXhi/Rz20Aj2uD/wCi4unmmv0uTxSnfOAzUYQ+UPd1SAZcLXSEO52d4IK+MygWee7S6E4B9phPi3TJQpLR3XpbjDPPQY6xEXwa35PPeZiLXT2b/lcHufPl3ti9QmCGEOLOp3X5/E/q4dfMBf+GegZbYdyWOobCtCa5mlNPD4aOzx9e08QW4s6tls9BffC2gd9Lk6DhHAl6A4XEoPq6F7zyHB5Fdzhv6g6O6vKt9KQniDSBhKD2s6qLZLvgg74kVIQL1N3XBhmXwFzbLUe4U74ffUa7WnonFvxDYNQm2Y8A//uEdW54d/eqJIO/P55MGdfzgJ5LAzjD1F39fLCfnpKTxBOMzLS0t3dPbW5K/JhvW3qTHv1pdxYtR22fA+1T+IuoZze3b16qvo3+K8JgiAIgiAIgiAIgiAIgiAIgiAIgiAIgiCITDBlyv8DBGlniQq1Wq8AAAAASUVORK5CYII=\"></a>\n    <p>Discover awesome. <a href=\"http://iobroker.net/\" target=\"_blank\">ioBroker</a></p>\n</footer>\n<script>\n    document.getElementById('origin').value = window.location.search.replace('&error', '');\n    var userLang = navigator.language || navigator.userLanguage;\n    userLang = userLang.substring(0, 2).toLowerCase();\n    var systemDictionary = {\n        \"wrongPassword\": {\n            \"en\": \"Invalid username or password\",\n            \"de\": \"Name oder Kennwort sind falsch\",\n            \"ru\": \"\u041d\u0435\u0432\u0435\u0440\u043d\u044b\u0435 \u0438\u043c\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f \u0438\u043b\u0438 \u043f\u0430\u0440\u043e\u043b\u044c\",\n            \"pt\": \"nome de usu\u00e1rio ou senha inv\u00e1lidos\",\n            \"nl\": \"ongeldige gebruikersnaam of wachtwoord\",\n            \"fr\": \"Nom d'utilisateur ou mot de passe invalide\",\n            \"it\": \"Nome utente o password errati\",\n            \"es\": \"usuario o contrase\u00f1a invalido\",\n            \"pl\": \"Nieprawid\u0142owa nazwa u\u017cytkownika lub has\u0142o\",\n            \"zh-cn\": \"\u7528\u6237\u540d\u6216\u5bc6\u7801\u65e0\u6548\"\n        },\n        \"enterLogin\": {\n            \"en\": \"Login name\",\n            \"de\": \"Loginname\",\n            \"ru\": \"\u0418\u043c\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\",\n            \"pt\": \"Nome de acesso\",\n            \"nl\": \"Inlog naam\",\n            \"fr\": \"Identifiant\",\n            \"it\": \"Nome di login\",\n            \"es\": \"Nombre de inicio de sesi\u00f3n\",\n            \"pl\": \"Nazwa u\u017cytkownika\",\n            \"zh-cn\": \"\u767b\u5f55\u540d\"\n        },\n        \"enterPassword\": {\n            \"en\": \"Password\",\n            \"de\": \"Kennwort\",\n            \"ru\": \"\u041f\u0430\u0440\u043e\u043b\u044c\",\n            \"pt\": \"Senha\",\n            \"nl\": \"Wachtwoord\",\n            \"fr\": \"Mot de passe\",\n            \"it\": \"Parola d'ordine\",\n            \"es\": \"Contrase\u00f1a\",\n            \"pl\": \"Has\u0142o\",\n            \"zh-cn\": \"\u5bc6\u7801\"\n        },\n        \"login\": {\n            \"en\": \"Log in\",\n            \"de\": \"Log in\",\n            \"ru\": \"\u0412\u043e\u0439\u0442\u0438\",\n            \"pt\": \"Entrar\",\n            \"nl\": \"Log in\",\n            \"fr\": \"S'identifier\",\n            \"it\": \"Accesso\",\n            \"es\": \"Iniciar sesi\u00f3n\",\n            \"pl\": \"Zaloguj Si\u0119\",\n            \"zh-cn\": \"\u767b\u5f55\"\n        },\n        \"title\": {\n            \"en\": \"Admin\",\n            \"de\": \"Admin\",\n            \"ru\": \"\u0412\u0445\u043e\u0434 \u0432 \u0430\u0434\u043c\u0438\u043d\"\n        }\n    };\n\n    if (window.location.search.indexOf('error') !== -1) {\n        document.getElementById('error').innerHTML      = systemDictionary.wrongPassword[userLang]  || systemDictionary.wrongPassword.en;\n        document.getElementById('error').style.display  = '';\n    }\n    document.getElementById('username-label').innerHTML = systemDictionary.enterLogin[userLang]     || systemDictionary.enterLogin.en;\n    document.getElementById('password-label').innerHTML = systemDictionary.enterPassword[userLang]  || systemDictionary.enterPassword.en;\n    document.getElementById('login-label').innerHTML    = systemDictionary.title[userLang]          || systemDictionary.title.en;\n    document.getElementById('submit-label').innerHTML   = systemDictionary.login[userLang]          || systemDictionary.login.en;\n\n    var inputs = document.getElementsByTagName('INPUT');\n    if (inputs) {\n        /*for (var i = 0; i < inputs.length; i++) {\n            inputs[i].addEventListener('blur', function() {\n                if (this.value) {\n                    if (this.className.indexOf('used') === -1) {\n                        this.className += ' used';\n                    }\n                } else {\n                    this.className = this.className.replace(/\\s?used/, '');\n                }\n            });\n        }*/\n        setTimeout(function () {\n            if (document.getElementById('username').value) {\n                document.getElementById('password').focus();\n                setTimeout(function () {\n                    if (!document.getElementById('username').value) {\n                        document.getElementById('username').focus();\n                    }\n                }, 300);\n            } else {\n                document.getElementById('username').focus();\n            }\n        }, 300);\n    }\n\n    document.getElementById('username').addEventListener('keydown', function (e) {\n        if (e.keyCode === 13) {\n            e.preventDefault();\n            setTimeout(function () {\n                document.getElementById('password').focus();\n            }, 100);\n        }\n    });\n    document.getElementById('password').addEventListener('keyup', function (e) {\n        if (e.keyCode === 13) {\n            document.getElementById('submit').click();\n        }\n    });\n\n    function animationEnd () {\n        this.className = this.className.replace(/\\s?is-active/, '');\n    }\n\n    var ripples = document.getElementsByClassName('ripples');\n    if (ripples) {\n        for (var r = 0; r < ripples.length; r++) {\n            ripples[r].addEventListener('click', function (e) {\n                var $parent = this.parentElement.parentElement;\n                var $offset = {top: $parent.offsetTop, left: $parent.offsetLeft};\n                var $circle = this.getElementsByClassName('ripplesCircle')[0];\n\n                var x = e.pageX - $offset.left;\n                var y = e.pageY - $offset.top;\n\n                $circle.style.top   = y + 'px';\n                $circle.style.left  = x + 'px';\n\n                if (this.className.indexOf('is-active') === -1) {\n                    this.className += ' is-active';\n                }\n            });\n\n            ripples[r].addEventListener('webkitAnimationEnd',   animationEnd);\n            ripples[r].addEventListener('mozAnimationEnd',      animationEnd);\n            ripples[r].addEventListener('MSAnimationEnd',       animationEnd);\n            ripples[r].addEventListener('oanimationend',        animationEnd);\n            ripples[r].addEventListener('animationend',         animationEnd);\n        }\n    }\n</script>\n</body>\n</html>"], "filenames": ["README.md", "gulpfile.js", "io-package.json", "lib/socket.js", "lib/web.js", "main.js", "package.json", "src/js/admin.js", "src/js/adminAdapters.js", "src/login/index.html"], "buggy_code_start_loc": [3, 496, 5, 12, 22, 17, 4, 3, 4, 5], "buggy_code_end_loc": [291, 503, 166, 1311, 474, 461, 57, 2111, 1740, 381], "fixing_code_start_loc": [2, 496, 5, 12, 23, 17, 4, 3, 4, 5], "fixing_code_end_loc": [292, 503, 177, 1342, 534, 438, 57, 2114, 1742, 391], "type": "CWE-22", "message": "iobroker.admin before 3.6.12 allows attacker to include file contents from outside the `/log/file1/` directory.", "other": {"cve": {"id": "CVE-2019-10765", "sourceIdentifier": "report@snyk.io", "published": "2019-11-20T16:15:12.873", "lastModified": "2019-11-22T14:35:40.177", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "iobroker.admin before 3.6.12 allows attacker to include file contents from outside the `/log/file1/` directory."}, {"lang": "es", "value": "iobroker.admin versiones anteriores a La versi\u00f3n  3.6.12, permite a un atacante incluir el contenido del archivo desde fuera del directorio \"/log/file1/\"."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.8, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.9, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:N/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 7.5}, "baseSeverity": "HIGH", "exploitabilityScore": 10.0, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-22"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:iobroker:iobroker.admin:*:*:*:*:*:node.js:*:*", "versionEndExcluding": "3.6.12", "matchCriteriaId": "1D931227-8340-45D1-AC9E-7DEA41462B51"}]}]}], "references": [{"url": "https://github.com/ioBroker/ioBroker.admin/commit/16b2b325ab47896090bc7f54b77b0a97ed74f5cd", "source": "report@snyk.io", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://snyk.io/vuln/SNYK-JS-IOBROKERADMIN-534634", "source": "report@snyk.io", "tags": ["Exploit", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/ioBroker/ioBroker.admin/commit/16b2b325ab47896090bc7f54b77b0a97ed74f5cd"}}