{"buggy_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2008-2018\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n*/\n\nfunction paging($num_rows, $param, $rows_per_page, $mini = false, $result_count = 0) {\n\n\t//validate the data\n\tif (!is_numeric($num_rows)) { $num_rows = 0; }\n\tif (!is_numeric($rows_per_page)) { $rows_per_page = 100; }\n\tif (!is_numeric($result_count)) { $result_count = 0; }\n\n\t// if $_get['page'] defined, use it as page number\n\tif(isset($_GET['page']) && is_numeric($_GET['page'])) {\n\t\t$page_number = $_GET['page'];\n\t}\n\telse {\n\t\t$page_number = 0;\n\t}\n\n\t//get the offset\n\t$offset = ($page_number - 1) * $rows_per_page;\n\n\t//how many pages we have when using paging\n\tif ($num_rows > 0) {\n\t\t$max_page = ceil($num_rows/$rows_per_page);\n\t}\n\n\t//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n\t// print the link to access each page\n\t$self = $_SERVER['PHP_SELF'];\n\t$nav = '';\n\tfor($page = 1; $page <= $max_page; $page++){\n\t\tif ($page == $page_number) {\n\t\t\t$nav .= \" $page \";   // no need to create a link to current page\n\t\t}\n\t\telse {\n\t\t\t$nav .= \" <a href=\\\"$self?page=$page\\\">$page</a> \\n\";\n\t\t}\n\t}\n\n\tif ($page_number > 0) {\n        $page = $page_number - 1;\n\t\t$prev = \"<input class='btn' type='button' value='\".$text['button-back'].\"' alt='\".($page+1).\"' title='\".($page+1).\"' onClick=\\\"window.location = '\".$self.\"?page=$page\".$param.\"';\\\">\\n\"; //&#9664;\n\t\t$first = \"<input class='btn' type='button' value='\".$text['button-next'].\"' onClick=\\\"window.location = '\".$self.\"?page=1\".$param.\"';\\\">\\n\"; //&#9650;\n\t}\n\telse {\n\t\t$prev = \"<input class='btn' type='button' disabled value='\".$text['button-back'].\"' style='opacity: 0.4; -moz-opacity: 0.4; cursor: default;'>\\n\"; //&#9664;\n\t}\n\n\tif (($page_number + 1) < $max_page) {\n        $page = $page_number + 1;\n\t\t$next = \"<input class='btn' type='button' value='\".$text['button-next'].\"' alt='\".($page+1).\"' title='\".($page+1).\"' onClick=\\\"window.location = '\".$self.\"?page=$page\".$param.\"';\\\">\\n\"; //&#9654;\n\t\t$last = \"<input class='btn' type='button' value='\".$text['button-back'].\"' onClick=\\\"window.location = '\".$self.\"?page=$max_page\".$param.\"';\\\">\\n\"; //&#9660;\n\t}\n\telse {\n\t\t$last = \"<input class='btn' type='button' value='\".$text['button-next'].\"' onClick=\\\"window.location = '\".$self.\"?page=$max_page\".$param.\"';\\\">\\n\"; //&#9660;\n\t\t$next = \"<input class='btn' type='button' disabled value='\".$text['button-next'].\"' style='opacity: 0.4; -moz-opacity: 0.4; cursor: default;'>\\n\"; //&#9654;\n\t}\n\n\t//if the result count is less than the rows per page then this is the last page of results\n\tif ($result_count > 0 and $result_count < $rows_per_page) {\n\t\t\t$next = \"<input class='btn' type='button' disabled value='\".$text['button-next'].\"' style='opacity: 0.4; -moz-opacity: 0.4; cursor: default;'>\\n\"; //&#9654;\n\t}\n\n\t$array = array();\n\t$code = '';\n\tif ($max_page > 1) {\n\t\t//define javascript to include\n\t\t\t$script = \"<script>\\n\".\n\t\t\t\t\t\"function go(e) {\\n\".\n\t\t\t\t\t\t\"var page_num;\\n\".\n\t\t\t\t\t\t\"page_num = document.getElementById('paging_page_num').value;\\n\".\n\n\t\t\t\t\t\t\"do_action = false;\\n\".\n\t\t\t\t\t\t\"if (e != null) {\\n\".\n\t\t\t\t\t\t\t\"// called from a form field keypress event\\n\".\n\t\t\t\t\t\t\t\"var keyevent;\\n\".\n\t\t\t\t\t\t\t\"var keychar;\\n\".\n\n\t\t\t\t\t\t\t\"if (window.event) { keyevent = e.keyCode; }\\n\".\n\t\t\t\t\t\t\t\"else if (e.which) { keyevent = e.which; }\\n\".\n\n\t\t\t\t\t\t\t\"keychar = keyevent;\\n\".\n\t\t\t\t\t\t\t\"if (keychar == 13) {\\n\".\n\t\t\t\t\t\t\t\t\"do_action = true;\\n\".\n\t\t\t\t\t\t\t\"}\\n\".\n\t\t\t\t\t\t\t\"else {\\n\".\n\t\t\t\t\t\t\t\t\"keychar;\\n\".\n\t\t\t\t\t\t\t\t\"return true;\\n\".\n\t\t\t\t\t\t\t\"}\\n\".\n\t\t\t\t\t\t\"}\\n\".\n\t\t\t\t\t\t\"else {\\n\".\n\t\t\t\t\t\t\t\"// called from something else (non-keypress)\\n\".\n\t\t\t\t\t\t\t\"do_action = true;\\n\".\n\t\t\t\t\t\t\"}\\n\".\n\n\t\t\t\t\t\t\"if (do_action) {\\n\".\n\t\t\t\t\t\t\t\"// action to peform when enter is hit\\n\".\n\t\t\t\t\t\t\t\"if (page_num < 1) { page_num = 1; }\\n\".\n\t\t\t\t\t\t\t\"if (page_num > \".$max_page.\") { page_num = \".$max_page.\"; }\\n\".\n\t\t\t\t\t\t\t\"document.location.href = '\".$self.\"?page='+(--page_num)+'\".$param.\"';\\n\".\n\t\t\t\t\t\t\"}\\n\".\n\t\t\t\t\t\"}\\n\".\n\t\t\t\t\"</script>\\n\";\n\t\t//determine size\n\t\t\tif ($mini) {\n\t\t\t\t$code = $prev.$next.\"\\n\".$script;\n\t\t\t}\n\t\t\telse {\n\t\t\t\t$code .= \"<center nowrap=\\\"nowrap\\\">\";\n\t\t\t\t$code .= \"\t\".$prev;\n\t\t\t\t$code .= \"\t&nbsp;&nbsp;&nbsp;\";\n\t\t\t\t$code .= \"\t<input id='paging_page_num' class='formfld' style='max-width: 50px; min-width: 50px; text-align: center;' type='text' value='\".($page_number+1).\"' onfocus='this.select();' onkeypress='return go(event);'>\";\n\t\t\t\tif ($result_count == 0) {\n\t\t\t\t\t$code .= \"\t&nbsp;&nbsp;<strong>\".$max_page.\"</strong>\";\n\t\t\t\t}\n\t\t\t\t$code .= \"\t&nbsp;&nbsp;&nbsp;\";\n\t\t\t\t$code .= \"\t\".$next;\n\t\t\t\t$code .= \"</center>\\n\".$script;\n\t\t\t}\n\n\t\t//add to array\n\t\t\t$array[] = $code;\n\t}\n\telse {\n\t\t$array[] = \"\";\n\t}\n\t$array[] = $rows_per_page;\n\t$array[] = $offset;\n\n\treturn $array;\n\n}\n\n?>\n"], "fixing_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2008-2018\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n*/\n\nfunction paging($num_rows, $param, $rows_per_page, $mini = false, $result_count = 0) {\n\n\t//validate the data\n\tif (!is_numeric($num_rows)) { $num_rows = 0; }\n\tif (!is_numeric($rows_per_page)) { $rows_per_page = 100; }\n\tif (!is_numeric($result_count)) { $result_count = 0; }\n\n\t// if $_get['page'] defined, use it as page number\n\tif(isset($_GET['page']) && is_numeric($_GET['page'])) {\n\t\t$page_number = $_GET['page'];\n\t}\n\telse {\n\t\t$page_number = 0;\n\t}\n\n\t//sanitize the parameters\n\t$sanitized_parameters = '';\n\tif (isset($param) && strlen($param) > 0) {\n\t\t$param_array = explode(\"&\", $param);\n\t\tif (is_array($param_array)) {\n\t\t\tforeach($param_array as $row) {\n\t\t\t\t$param_sub_array = explode(\"=\", $row);\n\t\t\t\t$key = preg_replace('#[^a-zA-Z0-9_\\-]#', '', $param_sub_array['0']);\n\t\t\t\t$value = urldecode($param_sub_array['1']);\n\t\t\t\tif ($key == 'order_by' && strlen($value) > 0) {\n\t\t\t\t\t//validate order by\n\t\t\t\t\t$sanitized_parameters .= \"&order_by=\". preg_replace('#[^a-zA-Z0-9_\\-]#', '', $value);\n\t\t\t\t}\n\t\t\t\telseif ($key == 'order' && strlen($value) > 0) {\n\t\t\t\t\t//validate order\n\t\t\t\t\tswitch ($value) {\n\t\t\t\t\t\tcase 'asc':\n\t\t\t\t\t\t\t$sanitized_parameters .= \"&order=asc\";\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'desc':\n\t\t\t\t\t\t\t$sanitized_parameters .= \"&order=desc\";\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telseif (strlen($value) > 0 && is_numeric($value)) {\n\t\t\t\t\t$sanitized_parameters .= \"&\".$key.\"=\".$value;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$sanitized_parameters .= \"&\".$key.\"=\".urlencode($value);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t//get the offset\n\t$offset = ($page_number - 1) * $rows_per_page;\n\n\t//how many pages we have when using paging\n\tif ($num_rows > 0) {\n\t\t$max_page = ceil($num_rows/$rows_per_page);\n\t}\n\n\t//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n\t//print the link to access each page\n\t$self =  escape($_SERVER['PHP_SELF']);\n\t$nav = '';\n\tfor($page = 1; $page <= $max_page; $page++){\n\t\tif ($page == $page_number) {\n\t\t\t$nav .= \" $page \";   // no need to create a link to current page\n\t\t}\n\t\telse {\n\t\t\t$nav .= \" <a href=\\\"$self?page=$page\\\">$page</a> \\n\";\n\t\t}\n\t}\n\n\tif ($page_number > 0) {\n\t\t$page = $page_number - 1;\n\t\t$prev = \"<input class='btn' type='button' value='\".$text['button-back'].\"' alt='\".($page+1).\"' title='\".($page+1).\"' onClick=\\\"window.location = '\".$self.\"?page=\".$page.$sanitized_parameters.\"';\\\">\\n\"; //&#9664;\n\t\t$first = \"<input class='btn' type='button' value='\".$text['button-next'].\"' onClick=\\\"window.location = '\".$self.\"?page=1\".$sanitized_parameters.\"';\\\">\\n\"; //&#9650;\n\t}\n\telse {\n\t\t$prev = \"<input class='btn' type='button' disabled value='\".$text['button-back'].\"' style='opacity: 0.4; -moz-opacity: 0.4; cursor: default;'>\\n\"; //&#9664;\n\t}\n\n\tif (($page_number + 1) < $max_page) {\n\t\t$page = $page_number + 1;\n\t\t$next = \"<input class='btn' type='button' value='\".$text['button-next'].\"' alt='\".($page+1).\"' title='\".($page+1).\"' onClick=\\\"window.location = '\".$self.\"?page=\".$page.$sanitized_parameters.\"';\\\">\\n\"; //&#9654;\n\t\t$last = \"<input class='btn' type='button' value='\".$text['button-back'].\"' onClick=\\\"window.location = '\".$self.\"?page=\".$max_page.$sanitized_parameters.\"';\\\">\\n\"; //&#9660;\n\t}\n\telse {\n\t\t$last = \"<input class='btn' type='button' value='\".$text['button-next'].\"' onClick=\\\"window.location = '\".$self.\"?page=\".$max_page.$sanitized_parameters.\"';\\\">\\n\"; //&#9660;\n\t\t$next = \"<input class='btn' type='button' disabled value='\".$text['button-next'].\"' style='opacity: 0.4; -moz-opacity: 0.4; cursor: default;'>\\n\"; //&#9654;\n\t}\n\n\t//if the result count is less than the rows per page then this is the last page of results\n\tif ($result_count > 0 and $result_count < $rows_per_page) {\n\t\t\t$next = \"<input class='btn' type='button' disabled value='\".$text['button-next'].\"' style='opacity: 0.4; -moz-opacity: 0.4; cursor: default;'>\\n\"; //&#9654;\n\t}\n\n\t$array = array();\n\t$code = '';\n\tif ($max_page > 1) {\n\t\t//define javascript to include\n\t\t\t$script = \"<script>\\n\".\n\t\t\t\t\t\"function go(e) {\\n\".\n\t\t\t\t\t\t\"var page_num;\\n\".\n\t\t\t\t\t\t\"page_num = document.getElementById('paging_page_num').value;\\n\".\n\n\t\t\t\t\t\t\"do_action = false;\\n\".\n\t\t\t\t\t\t\"if (e != null) {\\n\".\n\t\t\t\t\t\t\t\"// called from a form field keypress event\\n\".\n\t\t\t\t\t\t\t\"var keyevent;\\n\".\n\t\t\t\t\t\t\t\"var keychar;\\n\".\n\n\t\t\t\t\t\t\t\"if (window.event) { keyevent = e.keyCode; }\\n\".\n\t\t\t\t\t\t\t\"else if (e.which) { keyevent = e.which; }\\n\".\n\n\t\t\t\t\t\t\t\"keychar = keyevent;\\n\".\n\t\t\t\t\t\t\t\"if (keychar == 13) {\\n\".\n\t\t\t\t\t\t\t\t\"do_action = true;\\n\".\n\t\t\t\t\t\t\t\"}\\n\".\n\t\t\t\t\t\t\t\"else {\\n\".\n\t\t\t\t\t\t\t\t\"keychar;\\n\".\n\t\t\t\t\t\t\t\t\"return true;\\n\".\n\t\t\t\t\t\t\t\"}\\n\".\n\t\t\t\t\t\t\"}\\n\".\n\t\t\t\t\t\t\"else {\\n\".\n\t\t\t\t\t\t\t\"// called from something else (non-keypress)\\n\".\n\t\t\t\t\t\t\t\"do_action = true;\\n\".\n\t\t\t\t\t\t\"}\\n\".\n\n\t\t\t\t\t\t\"if (do_action) {\\n\".\n\t\t\t\t\t\t\t\"// action to peform when enter is hit\\n\".\n\t\t\t\t\t\t\t\"if (page_num < 1) { page_num = 1; }\\n\".\n\t\t\t\t\t\t\t\"if (page_num > \".$max_page.\") { page_num = \".$max_page.\"; }\\n\".\n\t\t\t\t\t\t\t\"document.location.href = '\".$self.\"?page='+(--page_num)+'\".$sanitized_parameters.\"';\\n\".\n\t\t\t\t\t\t\"}\\n\".\n\t\t\t\t\t\"}\\n\".\n\t\t\t\t\"</script>\\n\";\n\t\t//determine size\n\t\t\tif ($mini) {\n\t\t\t\t$code = $prev.$next.\"\\n\".$script;\n\t\t\t}\n\t\t\telse {\n\t\t\t\t$code .= \"<center nowrap=\\\"nowrap\\\">\";\n\t\t\t\t$code .= \"\t\".$prev;\n\t\t\t\t$code .= \"\t&nbsp;&nbsp;&nbsp;\";\n\t\t\t\t$code .= \"\t<input id='paging_page_num' class='formfld' style='max-width: 50px; min-width: 50px; text-align: center;' type='text' value='\".($page_number+1).\"' onfocus='this.select();' onkeypress='return go(event);'>\";\n\t\t\t\tif ($result_count == 0) {\n\t\t\t\t\t$code .= \"\t&nbsp;&nbsp;<strong>\".$max_page.\"</strong>\";\n\t\t\t\t}\n\t\t\t\t$code .= \"\t&nbsp;&nbsp;&nbsp;\";\n\t\t\t\t$code .= \"\t\".$next;\n\t\t\t\t$code .= \"</center>\\n\".$script;\n\t\t\t}\n\n\t\t//add to array\n\t\t\t$array[] = $code;\n\t}\n\telse {\n\t\t$array[] = \"\";\n\t}\n\t$array[] = $rows_per_page;\n\t$array[] = $offset;\n\n\treturn $array;\n\n}\n\n?>\n"], "filenames": ["resources/paging.php"], "buggy_code_start_loc": [41], "buggy_code_end_loc": [127], "fixing_code_start_loc": [42], "fixing_code_end_loc": [161], "type": "CWE-79", "message": "In FusionPBX up to v4.5.7, the file resources\\paging.php has a paging function (called by several pages of the interface), which uses an unsanitized \"param\" variable constructed partially from the URL args and reflected in HTML, leading to XSS.", "other": {"cve": {"id": "CVE-2019-16983", "sourceIdentifier": "cve@mitre.org", "published": "2019-10-21T16:15:17.913", "lastModified": "2023-02-03T21:36:10.140", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In FusionPBX up to v4.5.7, the file resources\\paging.php has a paging function (called by several pages of the interface), which uses an unsanitized \"param\" variable constructed partially from the URL args and reflected in HTML, leading to XSS."}, {"lang": "es", "value": "En FusionPBX versiones hasta v4.5.7, el archivo resources\\paging.php presenta una funci\u00f3n de paginaci\u00f3n (llamada por varias p\u00e1ginas de la interfaz), que utiliza una variable \"param\" no higi\u00e9nica construida parcialmente a partir de los argumentos de URL y reflejada en HTML, conllevando a una vulnerabilidad de tipo XSS."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:fusionpbx:fusionpbx:*:*:*:*:*:*:*:*", "versionEndIncluding": "4.5.7", "matchCriteriaId": "A5A0C1F9-8032-46C6-8DD4-DB91FACF7330"}]}]}], "references": [{"url": "https://github.com/fusionpbx/fusionpbx/commit/23581e56e9a4d1685ddf1c7d67137417d654e134", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://resp3ctblog.wordpress.com/2019/10/19/fusionpbx-xss-15/", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/fusionpbx/fusionpbx/commit/23581e56e9a4d1685ddf1c7d67137417d654e134"}}