{"buggy_code": ["<?php\nnamespace Api\\Controller;\nuse Think\\Controller;\nclass CatalogController extends BaseController {\n\n    //\u83b7\u53d6\u76ee\u5f55\u5217\u8868\n    public function catList(){\n        $login_user = $this->checkLogin();\n        $item_id = I(\"item_id/d\");\n        if (!$this->checkItemVisit($login_user['uid'] , $item_id)) {\n            $this->sendError(10103);\n            return ;\n        }\n        if ($item_id > 0 ) {\n            $ret = D(\"Catalog\")->getList($item_id);\n        }\n        if ($ret) {\n           $this->sendResult($ret);\n        }else{\n            $this->sendResult(array());\n        }\n    }\n\n    //\u83b7\u53d6\u76ee\u5f55\u5217\u8868\n    public function catListGroup(){\n        $login_user = $this->checkLogin();\n        $item_id = I(\"item_id/d\");\n        if (!$this->checkItemVisit($login_user['uid'] , $item_id)) {\n            $this->sendError(10103);\n            return ;\n        }\n        if ($item_id > 0 ) {\n            $ret = D(\"Catalog\")->getList($item_id,true);\n        }\n        if ($ret) {\n           $this->sendResult($ret);\n        }else{\n           $this->sendResult(array());\n        }\n    }\n\n    //\u83b7\u53d6\u4e8c\u7ea7\u76ee\u5f55\u5217\u8868\n    public function secondCatList(){\n        $login_user = $this->checkLogin();\n        $item_id = I(\"item_id/d\");\n        if (!$this->checkItemVisit($login_user['uid'] , $item_id)) {\n            $this->sendError(10103);\n            return ;\n        }\n        if ($item_id > 0 ) {\n            $ret = D(\"Catalog\")->getListByLevel($item_id , 2);\n        }\n        if ($ret) {\n           $this->sendResult($ret);\n        }else{\n            $this->sendResult(array());\n        }\n    }\n\n    //\u83b7\u53d6\u4e8c\u7ea7\u76ee\u5f55\u7684\u5b50\u76ee\u5f55\u5217\u8868\uff0c\u5373\u4e09\u7ea7\u76ee\u5f55\u5217\u8868\uff08\u5982\u679c\u5b58\u5728\u7684\u8bdd\uff09\n    public function childCatList(){\n        $login_user = $this->checkLogin();\n        $cat_id = I(\"cat_id/d\");\n        if ($cat_id > 0 ) {\n            $row = D(\"Catalog\")->where(\" cat_id = '$cat_id' \")->find() ;\n            $item_id = $row['item_id'] ;\n            if (!$this->checkItemVisit($login_user['uid'] , $item_id)) {\n                $this->sendError(10103);\n                return ;\n            }\n            $ret =  D(\"Catalog\")->getChlid($item_id , $cat_id);\n        }\n        if ($ret) {\n           $this->sendResult($ret);\n        }else{\n            $this->sendResult(array());\n        }      \n    }\n\n    //\u4fdd\u5b58\u76ee\u5f55\n    public function save(){\n        $cat_name = I(\"cat_name\");\n        $s_number = I(\"s_number/d\") ? I(\"s_number/d\") : 99 ;\n        $cat_id = I(\"cat_id/d\")? I(\"cat_id/d\") : 0;\n        $parent_cat_id = I(\"parent_cat_id/d\")? I(\"parent_cat_id/d\") : 0;\n        $item_id =  I(\"item_id/d\");\n\n        $login_user = $this->checkLogin();\n        if (!$this->checkItemPermn($login_user['uid'] , $item_id)) {\n            $this->sendError(10103);\n            return;\n        }\n        //\u7981\u6b62\u7a7a\u76ee\u5f55\u7684\u751f\u6210\n        if (!$cat_name) {\n            return;\n        }\n        \n        if ($parent_cat_id &&  $parent_cat_id == $cat_id) {\n            $this->sendError(10101,\"\u4e0a\u7ea7\u76ee\u5f55\u4e0d\u80fd\u9009\u62e9\u81ea\u8eab\");\n            return;\n        }\n        \n        $data['cat_name'] = $cat_name ;\n        $data['s_number'] = $s_number ;\n        $data['item_id'] = $item_id ;\n        $data['parent_cat_id'] = $parent_cat_id ;\n        if ($parent_cat_id > 0 ) {\n            $row = D(\"Catalog\")->where(\" cat_id = '$parent_cat_id' \")->find() ;\n            $data['level'] = $row['level'] +1 ;\n        }else{\n            $data['level'] = 2;\n        }\n\n        if ($cat_id > 0 ) {\n            \n            //\u5982\u679c\u4e00\u4e2a\u76ee\u5f55\u5df2\u7ecf\u662f\u522b\u7684\u76ee\u5f55\u7684\u7236\u76ee\u5f55\uff0c\u90a3\u4e48\u5b83\u5c06\u65e0\u6cd5\u518d\u8f6c\u4e3alevel4\u76ee\u5f55\n            if (D(\"Catalog\")->where(\" parent_cat_id = '$cat_id' \")->find() && $data['level'] == 4 ) {\n                $this->sendError(10101,\"\u8be5\u76ee\u5f55\u542b\u6709\u5b50\u76ee\u5f55\uff0c\u4e0d\u5141\u8bb8\u8f6c\u4e3a\u5e95\u5c42\u76ee\u5f55\u3002\");\n                return;\n            }\n            \n            $ret = D(\"Catalog\")->where(\" cat_id = '$cat_id' \")->save($data);\n            $return = D(\"Catalog\")->where(\" cat_id = '$cat_id' \")->find();\n\n        }else{\n            $data['addtime'] = time();\n            $cat_id = D(\"Catalog\")->add($data);\n            $return = D(\"Catalog\")->where(\" cat_id = '$cat_id' \")->find();\n            \n        }\n        if (!$return) {\n            $return['error_code'] = 10103 ;\n            $return['error_message'] = 'request  fail' ;\n        }\n        $this->sendResult($return);\n        \n    }\n\n    //\u5220\u9664\u76ee\u5f55\n    public function delete(){\n        $cat_id = I(\"cat_id/d\")? I(\"cat_id/d\") : 0;\n        $cat = D(\"Catalog\")->where(\" cat_id = '$cat_id' \")->find();\n        $item_id = $cat['item_id'];\n        \n        $login_user = $this->checkLogin();\n        if (!$this->checkItemPermn($login_user['uid'] , $item_id)) {\n            $return['error_code'] = -1 ;\n            $return['error_message'] = L('no_permissions');\n            $this->sendResult($return);\n            return;\n        }\n\n        if (D(\"Page\")->where(\" cat_id = '$cat_id' and is_del = 0\")->find() || D(\"Catalog\")->where(\" parent_cat_id = '$cat_id' \")->find()) {\n            $return['error_code'] = -1 ;\n            $return['error_message'] = L('no_delete_empty_catalog') ;\n            $this->sendResult($return);\n            return;\n        }\n\n        if ($cat_id > 0 ) {\n            \n            $ret = D(\"Catalog\")->where(\" cat_id = '$cat_id' \")->delete();\n\n        }\n        if ($ret) {\n           $this->sendResult($ret);\n        }else{\n            $return['error_code'] = -1 ;\n            $return['error_message'] = 'request  fail' ;\n            $this->sendResult($return);\n        }\n    }\n\n    //\u7f16\u8f91\u9875\u9762\u65f6\uff0c\u81ea\u52a8\u5e2e\u52a9\u7528\u6237\u9009\u4e2d\u76ee\u5f55\n    //\u9009\u4e2d\u7684\u89c4\u5219\u662f\uff1a\u7f16\u8f91\u9875\u9762\u5219\u9009\u4e2d\u8be5\u9875\u9762\u76ee\u5f55\uff0c\u590d\u5236\u9875\u9762\u5219\u9009\u4e2d\u76ee\u6807\u9875\u9762\u76ee\u5f55;\n    //              \u5982\u679c\u662f\u6062\u590d\u5386\u53f2\u9875\u9762\u5219\u4f7f\u7528\u5386\u53f2\u9875\u9762\u7684\u76ee\u5f55\uff0c\u5982\u679c\u90fd\u6ca1\u6709\u5219\u9009\u4e2d\u7528\u6237\u4e0a\u6b21\u4f7f\u7528\u7684\u76ee\u5f55\n    public function getDefaultCat(){\n        $login_user = $this->checkLogin();\n        $page_id = I(\"page_id/d\");\n        $item_id = I(\"item_id/d\");\n        $page_history_id = I(\"page_history_id/d\");\n        $copy_page_id = I(\"copy_page_id/d\");\n\n        if ($page_id > 0 ) {\n            if ($page_history_id) {\n                $page = D(\"PageHistory\")->where(\" page_history_id = '$page_history_id' \")->find();\n            }else{\n                $page = M(\"Page\")->where(\" page_id = '$page_id' \")->find();\n            }\n            $default_cat_id = $page['cat_id'];\n        }\n        //\u5982\u679c\u662f\u590d\u5236\u63a5\u53e3\n        elseif ($copy_page_id) {\n            $copy_page = M(\"Page\")->where(\" page_id = '$copy_page_id' \")->find();\n            $page['item_id'] = $copy_page['item_id'];\n            $default_cat_id = $copy_page['cat_id'];\n\n        }else{\n            //\u67e5\u627e\u7528\u6237\u4e0a\u4e00\u6b21\u8bbe\u7f6e\u7684\u76ee\u5f55\n            $last_page = D(\"Page\")->where(\" author_uid ='$login_user[uid]' and item_id = '$item_id' \")->order(\" addtime desc \")->limit(1)->find();\n            $default_cat_id = $last_page['cat_id'];\n\n\n        }\n\n        $item_id = $page['item_id'] ?$page['item_id'] :$item_id;\n\n        \n        if (!$this->checkItemPermn($login_user['uid'] , $item_id)) {\n            $this->sendError(10101,L('no_permissions'));\n            return;\n        }\n\n        $this->sendResult(array(\"default_cat_id\"=>$default_cat_id ));\n    }\n\n\n}\n"], "fixing_code": ["<?php\nnamespace Api\\Controller;\nuse Think\\Controller;\nclass CatalogController extends BaseController {\n\n    //\u83b7\u53d6\u76ee\u5f55\u5217\u8868\n    public function catList(){\n        $login_user = $this->checkLogin();\n        $item_id = I(\"item_id/d\");\n        if (!$this->checkItemVisit($login_user['uid'] , $item_id)) {\n            $this->sendError(10103);\n            return ;\n        }\n        if ($item_id > 0 ) {\n            $ret = D(\"Catalog\")->getList($item_id);\n        }\n        if ($ret) {\n           $this->sendResult($ret);\n        }else{\n            $this->sendResult(array());\n        }\n    }\n\n    //\u83b7\u53d6\u76ee\u5f55\u5217\u8868\n    public function catListGroup(){\n        $login_user = $this->checkLogin();\n        $item_id = I(\"item_id/d\");\n        if (!$this->checkItemVisit($login_user['uid'] , $item_id)) {\n            $this->sendError(10103);\n            return ;\n        }\n        if ($item_id > 0 ) {\n            $ret = D(\"Catalog\")->getList($item_id,true);\n        }\n        if ($ret) {\n           $this->sendResult($ret);\n        }else{\n           $this->sendResult(array());\n        }\n    }\n\n    //\u83b7\u53d6\u4e8c\u7ea7\u76ee\u5f55\u5217\u8868\n    public function secondCatList(){\n        $login_user = $this->checkLogin();\n        $item_id = I(\"item_id/d\");\n        if (!$this->checkItemVisit($login_user['uid'] , $item_id)) {\n            $this->sendError(10103);\n            return ;\n        }\n        if ($item_id > 0 ) {\n            $ret = D(\"Catalog\")->getListByLevel($item_id , 2);\n        }\n        if ($ret) {\n           $this->sendResult($ret);\n        }else{\n            $this->sendResult(array());\n        }\n    }\n\n    //\u83b7\u53d6\u4e8c\u7ea7\u76ee\u5f55\u7684\u5b50\u76ee\u5f55\u5217\u8868\uff0c\u5373\u4e09\u7ea7\u76ee\u5f55\u5217\u8868\uff08\u5982\u679c\u5b58\u5728\u7684\u8bdd\uff09\n    public function childCatList(){\n        $login_user = $this->checkLogin();\n        $cat_id = I(\"cat_id/d\");\n        if ($cat_id > 0 ) {\n            $row = D(\"Catalog\")->where(\" cat_id = '$cat_id' \")->find() ;\n            $item_id = $row['item_id'] ;\n            if (!$this->checkItemVisit($login_user['uid'] , $item_id)) {\n                $this->sendError(10103);\n                return ;\n            }\n            $ret =  D(\"Catalog\")->getChlid($item_id , $cat_id);\n        }\n        if ($ret) {\n           $this->sendResult($ret);\n        }else{\n            $this->sendResult(array());\n        }      \n    }\n\n    //\u4fdd\u5b58\u76ee\u5f55\n    public function save(){\n        $cat_name = I(\"cat_name\");\n        $s_number = I(\"s_number/d\") ? I(\"s_number/d\") : 99 ;\n        $cat_id = I(\"cat_id/d\")? I(\"cat_id/d\") : 0;\n        $parent_cat_id = I(\"parent_cat_id/d\")? I(\"parent_cat_id/d\") : 0;\n        $item_id =  I(\"item_id/d\");\n\n        $login_user = $this->checkLogin();\n        if (!$this->checkItemPermn($login_user['uid'] , $item_id)) {\n            $this->sendError(10103);\n            return;\n        }\n        //\u7981\u6b62\u7a7a\u76ee\u5f55\u7684\u751f\u6210\n        if (!$cat_name) {\n            return;\n        }\n        \n        if ($parent_cat_id &&  $parent_cat_id == $cat_id) {\n            $this->sendError(10101,\"\u4e0a\u7ea7\u76ee\u5f55\u4e0d\u80fd\u9009\u62e9\u81ea\u8eab\");\n            return;\n        }\n        \n        $data['cat_name'] = $cat_name ;\n        $data['s_number'] = $s_number ;\n        $data['item_id'] = $item_id ;\n        $data['parent_cat_id'] = $parent_cat_id ;\n        if ($parent_cat_id > 0 ) {\n            $row = D(\"Catalog\")->where(\" cat_id = '$parent_cat_id' \")->find() ;\n            $data['level'] = $row['level'] +1 ;\n        }else{\n            $data['level'] = 2;\n        }\n\n        if ($cat_id > 0 ) {\n            $cat = D(\"Catalog\")->where(\" cat_id = '$cat_id' \")->find();\n            $item_id = $cat['item_id']; \n            if (!$this->checkItemPermn($login_user['uid'] , $item_id)) {\n                $this->sendError(10103);\n                return;\n            }\n            //\u5982\u679c\u4e00\u4e2a\u76ee\u5f55\u5df2\u7ecf\u662f\u522b\u7684\u76ee\u5f55\u7684\u7236\u76ee\u5f55\uff0c\u90a3\u4e48\u5b83\u5c06\u65e0\u6cd5\u518d\u8f6c\u4e3alevel4\u76ee\u5f55\n            if (D(\"Catalog\")->where(\" parent_cat_id = '$cat_id' \")->find() && $data['level'] == 4 ) {\n                $this->sendError(10101,\"\u8be5\u76ee\u5f55\u542b\u6709\u5b50\u76ee\u5f55\uff0c\u4e0d\u5141\u8bb8\u8f6c\u4e3a\u5e95\u5c42\u76ee\u5f55\u3002\");\n                return;\n            }\n            \n            $ret = D(\"Catalog\")->where(\" cat_id = '$cat_id' \")->save($data);\n            $return = D(\"Catalog\")->where(\" cat_id = '$cat_id' \")->find();\n\n        }else{\n            $data['addtime'] = time();\n            $cat_id = D(\"Catalog\")->add($data);\n            $return = D(\"Catalog\")->where(\" cat_id = '$cat_id' \")->find();\n            \n        }\n        if (!$return) {\n            $return['error_code'] = 10103 ;\n            $return['error_message'] = 'request  fail' ;\n        }\n        $this->sendResult($return);\n        \n    }\n\n    //\u5220\u9664\u76ee\u5f55\n    public function delete(){\n        $cat_id = I(\"cat_id/d\")? I(\"cat_id/d\") : 0;\n        $cat = D(\"Catalog\")->where(\" cat_id = '$cat_id' \")->find();\n        $item_id = $cat['item_id'];\n        \n        $login_user = $this->checkLogin();\n        if (!$this->checkItemPermn($login_user['uid'] , $item_id)) {\n            $return['error_code'] = -1 ;\n            $return['error_message'] = L('no_permissions');\n            $this->sendResult($return);\n            return;\n        }\n\n        if (D(\"Page\")->where(\" cat_id = '$cat_id' and is_del = 0\")->find() || D(\"Catalog\")->where(\" parent_cat_id = '$cat_id' \")->find()) {\n            $return['error_code'] = -1 ;\n            $return['error_message'] = L('no_delete_empty_catalog') ;\n            $this->sendResult($return);\n            return;\n        }\n\n        if ($cat_id > 0 ) {\n            \n            $ret = D(\"Catalog\")->where(\" cat_id = '$cat_id' \")->delete();\n\n        }\n        if ($ret) {\n           $this->sendResult($ret);\n        }else{\n            $return['error_code'] = -1 ;\n            $return['error_message'] = 'request  fail' ;\n            $this->sendResult($return);\n        }\n    }\n\n    //\u7f16\u8f91\u9875\u9762\u65f6\uff0c\u81ea\u52a8\u5e2e\u52a9\u7528\u6237\u9009\u4e2d\u76ee\u5f55\n    //\u9009\u4e2d\u7684\u89c4\u5219\u662f\uff1a\u7f16\u8f91\u9875\u9762\u5219\u9009\u4e2d\u8be5\u9875\u9762\u76ee\u5f55\uff0c\u590d\u5236\u9875\u9762\u5219\u9009\u4e2d\u76ee\u6807\u9875\u9762\u76ee\u5f55;\n    //              \u5982\u679c\u662f\u6062\u590d\u5386\u53f2\u9875\u9762\u5219\u4f7f\u7528\u5386\u53f2\u9875\u9762\u7684\u76ee\u5f55\uff0c\u5982\u679c\u90fd\u6ca1\u6709\u5219\u9009\u4e2d\u7528\u6237\u4e0a\u6b21\u4f7f\u7528\u7684\u76ee\u5f55\n    public function getDefaultCat(){\n        $login_user = $this->checkLogin();\n        $page_id = I(\"page_id/d\");\n        $item_id = I(\"item_id/d\");\n        $page_history_id = I(\"page_history_id/d\");\n        $copy_page_id = I(\"copy_page_id/d\");\n\n        if ($page_id > 0 ) {\n            if ($page_history_id) {\n                $page = D(\"PageHistory\")->where(\" page_history_id = '$page_history_id' \")->find();\n            }else{\n                $page = M(\"Page\")->where(\" page_id = '$page_id' \")->find();\n            }\n            $default_cat_id = $page['cat_id'];\n        }\n        //\u5982\u679c\u662f\u590d\u5236\u63a5\u53e3\n        elseif ($copy_page_id) {\n            $copy_page = M(\"Page\")->where(\" page_id = '$copy_page_id' \")->find();\n            $page['item_id'] = $copy_page['item_id'];\n            $default_cat_id = $copy_page['cat_id'];\n\n        }else{\n            //\u67e5\u627e\u7528\u6237\u4e0a\u4e00\u6b21\u8bbe\u7f6e\u7684\u76ee\u5f55\n            $last_page = D(\"Page\")->where(\" author_uid ='$login_user[uid]' and item_id = '$item_id' \")->order(\" addtime desc \")->limit(1)->find();\n            $default_cat_id = $last_page['cat_id'];\n\n\n        }\n\n        $item_id = $page['item_id'] ?$page['item_id'] :$item_id;\n\n        \n        if (!$this->checkItemPermn($login_user['uid'] , $item_id)) {\n            $this->sendError(10101,L('no_permissions'));\n            return;\n        }\n\n        $this->sendResult(array(\"default_cat_id\"=>$default_cat_id ));\n    }\n\n\n}\n"], "filenames": ["server/Application/Api/Controller/CatalogController.class.php"], "buggy_code_start_loc": [115], "buggy_code_end_loc": [116], "fixing_code_start_loc": [115], "fixing_code_end_loc": [121], "type": "CWE-425", "message": "ShowDoc 2.4.1 allows remote attackers to edit other users' notes by navigating with a modified page_id.", "other": {"cve": {"id": "CVE-2018-19620", "sourceIdentifier": "cve@mitre.org", "published": "2018-11-28T08:29:00.277", "lastModified": "2019-10-03T00:03:26.223", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "ShowDoc 2.4.1 allows remote attackers to edit other users' notes by navigating with a modified page_id."}, {"lang": "es", "value": "ShowDoc 2.4.1 permite que los atacantes remotos editen las notas de otros usuarios navegando con un page_id  modificado."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 4.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 1.4}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-425"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:showdoc:showdoc:2.4.1:*:*:*:*:*:*:*", "matchCriteriaId": "60FAF69B-91E1-4DCF-924D-1B484D7913E5"}]}]}], "references": [{"url": "https://github.com/CCCCCrash/POCs/tree/master/Web/showdoc/IncorrectAccessControl#0x02-modify", "source": "cve@mitre.org", "tags": ["Exploit", "Third Party Advisory"]}, {"url": "https://github.com/star7th/showdoc/commit/bcdb5e3519285bdf81e618b3c9b90d22bc49e13c", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://github.com/star7th/showdoc/issues/397", "source": "cve@mitre.org", "tags": ["Issue Tracking"]}]}, "github_commit_url": "https://github.com/star7th/showdoc/commit/bcdb5e3519285bdf81e618b3c9b90d22bc49e13c"}}