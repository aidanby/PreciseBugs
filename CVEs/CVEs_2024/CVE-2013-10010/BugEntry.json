{"buggy_code": ["#============================================================================================================\r\n#\r\n#\t\ufffdX\ufffd\ufffd\ufffdb\ufffdh\ufffd\u01d7\ufffd - \ufffd\ufffd\ufffdX \ufffd\ufffd\ufffdW\ufffd\ufffd\ufffd[\ufffd\ufffd\r\n#\tthread.res.pl\r\n#\t---------------------------------------------------------------------------\r\n#\t2004.07.21 start\r\n#\r\n#============================================================================================================\r\npackage\tMODULE;\r\n\r\nuse strict;\r\nuse warnings;\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\ufffdR\ufffd\ufffd\ufffdX\ufffdg\ufffd\ufffd\ufffdN\ufffd^\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t\ufffd\u0202\ufffd\r\n#\t@return\t\ufffd\ufffd\ufffdW\ufffd\ufffd\ufffd[\ufffd\ufffd\ufffdI\ufffdu\ufffdW\ufffdF\ufffdN\ufffdg\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub new\r\n{\r\n\tmy $this = shift;\r\n\tmy ($obj, @LOG);\r\n\t\r\n\t$obj = {\r\n\t\t'LOG' => \\@LOG\r\n\t};\r\n\tbless $obj, $this;\r\n\t\r\n\treturn $obj;\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\ufffd\\\ufffd\ufffd\ufffd\ufffd\ufffd\\\ufffdb\ufffdh\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Sys\tMELKOR\r\n#\t@param\t$Form\tSAMWISE\r\n#\t@param\t$pSys\t\ufffd\u01d7\ufffd\ufffdV\ufffdX\ufffde\ufffd\ufffd\r\n#\t@return\t\ufffd\u0202\ufffd\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub DoPrint\r\n{\r\n\tmy $this = shift;\r\n\tmy ($Sys, $Form, $pSys) = @_;\r\n\tmy ($subMode, $BASE, $BBS, $DAT, $Page,$Logger);\r\n\t\r\n\trequire './mordor/sauron.pl';\r\n\t$BASE = SAURON->new;\r\n\t$BBS = $pSys->{'AD_BBS'};\r\n\t$DAT = $pSys->{'AD_DAT'};\r\n\t\r\n\t# \ufffdf\ufffd\ufffd\ufffd\u008f\ufffd\ufffd\u0313\u01c2\u074d\ufffd\ufffd\u0742\u0183O\ufffd\ufffd\ufffd[\ufffdv\ufffd\u0752\ufffd\r\n\tif (! defined $pSys->{'AD_BBS'}) {\r\n\t\trequire './module/nazguls.pl';\r\n\t\t$BBS = NAZGUL->new;\r\n\t\t\r\n\t\t$BBS->Load($Sys);\r\n\t\t$Sys->Set('BBS', $BBS->Get('DIR', $Form->Get('TARGET_BBS')));\r\n\t\t$pSys->{'SECINFO'}->SetGroupInfo($BBS->Get('DIR', $Form->Get('TARGET_BBS')));\r\n\t}\r\n\t\r\n\t# dat\ufffd\u0313\u01c2\u074d\ufffd\ufffd\ufffd\r\n\tif (! defined $pSys->{'AD_DAT'}) {\r\n\t\trequire './module/gondor.pl';\r\n\t\t$DAT = ARAGORN->new;\r\n\t\t\r\n\t\t$Sys->Set('KEY', $Form->Get('TARGET_THREAD'));\r\n\t\tmy $datPath = $Sys->Get('BBSPATH') . '/' . $Sys->Get('BBS') . '/dat/' . $Sys->Get('KEY') . '.dat';\r\n\t\t$DAT->Load($Sys, $datPath, 1);\r\n\t}\r\n\t\r\n\t#log\ufffd\u0313\u01c2\u074d\ufffd\ufffd\ufffd\r\n\trequire './module/imrahil.pl';\r\n\t$Logger = IMRAHIL->new;\r\n\tmy $logPath = $Sys->Get('BBSPATH') . '/' . $Sys->Get('BBS') . '/log/' . $Sys->Get('KEY');\r\n\t$Logger->Open($logPath, 0, 1 | 2);\r\n\t\r\n\t# \ufffd\u01d7\ufffd\ufffd}\ufffdX\ufffd^\ufffdI\ufffdu\ufffdW\ufffdF\ufffdN\ufffdg\ufffd\u0310\ufffd\ufffd\ufffd\r\n\t$Page\t\t= $BASE->Create($Sys, $Form);\r\n\t$subMode\t= $Form->Get('MODE_SUB');\r\n\t\r\n\t# \ufffd\ufffd\ufffdj\ufffd\ufffd\ufffd[\ufffd\u0310\u0752\ufffd\r\n\tSetMenuList($BASE, $pSys, $Sys->Get('BBS'));\r\n\t\r\n\tif ($subMode eq 'LIST') {\t\t\t\t\t\t\t\t\t\t\t\t\t\t# \ufffd\ufffd\ufffdX\ufffd\ua5d7\ufffd\ufffd\ufffd\r\n\t\tPrintResList($Page, $Sys, $Form, $DAT,$Logger);\r\n\t}\r\n\telsif ($subMode eq 'EDIT') {\t\t\t\t\t\t\t\t\t\t\t\t\t# \ufffd\ufffd\ufffdX\ufffd\u048fW\ufffd\ufffd\ufffd\r\n\t\tPrintResEdit($Page, $Sys, $Form, $DAT);\r\n\t}\r\n\telsif ($subMode eq 'ABONE') {\t\t\t\t\t\t\t\t\t\t\t\t\t# \ufffd\ufffd\ufffdX\ufffd\ud3dc\ufffdm\ufffdF\ufffd\ufffd\ufffd\r\n\t\tPrintResDelete($Page, $Sys, $Form, $DAT, 1);\r\n\t}\r\n\telsif ($subMode eq 'DELETE') {\t\t\t\t\t\t\t\t\t\t\t\t\t# \ufffd\ufffd\ufffdX\ufffd\ud3dc\ufffdm\ufffdF\ufffd\ufffd\ufffd\r\n\t\tPrintResDelete($Page, $Sys, $Form, $DAT, 0);\r\n\t}\r\n\telsif ($subMode eq 'DELLUMP') {\t\t\t\t\t\t\t\t\t\t\t\t\t# \ufffd\ufffd\ufffdX\ufffd\ua287\ufffd\ud3dc\ufffd\ufffd\ufffd\r\n\t\tPrintResLumpDelete($Page, $Sys, $Form, $DAT);\r\n\t}\r\n\telsif ($subMode eq 'COMPLETE') {\t\t\t\t\t\t\t\t\t\t\t\t# \ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\r\n\t\t$Sys->Set('_TITLE', 'Process Complete');\r\n\t\t$BASE->PrintComplete('\ufffd\u07cb\ufffd\ufffd\ufffd\ufffdO\ufffd\ufffd\ufffd\ufffd', $this->{'LOG'});\r\n\t}\r\n\telsif ($subMode eq 'FALSE') {\t\t\t\t\t\t\t\t\t\t\t\t\t# \ufffd\ufffd\ufffds\ufffd\ufffd\ufffd\r\n\t\t$Sys->Set('_TITLE', 'Process Failed');\r\n\t\t$BASE->PrintError($this->{'LOG'});\r\n\t}\r\n\t\r\n\t# \ufffdf\ufffd\ufffd\ufffd\u0081E\ufffdX\ufffd\ufffd\ufffdb\ufffdh\ufffd\ufffd\ufffd\ufffd\u0752\ufffd\r\n\t$Page->HTMLInput('hidden', 'TARGET_BBS', $Form->Get('TARGET_BBS'));\r\n\t$Page->HTMLInput('hidden', 'TARGET_THREAD', $Form->Get('TARGET_THREAD'));\r\n\t\r\n\t$BASE->Print($Sys->Get('_TITLE') . ' - ' . $BBS->Get('NAME', $Form->Get('TARGET_BBS'))\r\n\t\t\t\t\t. ' - ' . $DAT->GetSubject(), 3);\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\ufffd@\ufffd\\\ufffd\ufffd\ufffd\\\ufffdb\ufffdh\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Sys\tMELKOR\r\n#\t@param\t$Form\tSAMWISE\r\n#\t@param\t$pSys\t\ufffd\u01d7\ufffd\ufffdV\ufffdX\ufffde\ufffd\ufffd\r\n#\t@return\t\ufffd\u0202\ufffd\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub DoFunction\r\n{\r\n\tmy $this = shift;\r\n\tmy ($Sys, $Form, $pSys) = @_;\r\n\tmy ($subMode, $err, $BBS, $DAT);\r\n\t\r\n\trequire './module/gondor.pl';\r\n\trequire './module/nazguls.pl';\r\n\t$BBS = NAZGUL->new;\r\n\t$DAT = ARAGORN->new;\r\n\t\r\n\t# \ufffdf\ufffd\ufffd\ufffd\u008f\ufffd\ufffd\u0313\u01c2\u074d\ufffd\ufffd\u0742\u0183O\ufffd\ufffd\ufffd[\ufffdv\ufffd\u0752\ufffd\r\n\t$BBS->Load($Sys);\r\n\t$Sys->Set('BBS', $BBS->Get('DIR', $Form->Get('TARGET_BBS')));\r\n\t$pSys->{'SECINFO'}->SetGroupInfo($BBS->Get('DIR', $Form->Get('TARGET_BBS')));\r\n\t\r\n\t# dat\ufffd\u0313\u01c2\u074d\ufffd\ufffd\ufffd\r\n\t$Sys->Set('KEY', $Form->Get('TARGET_THREAD'));\r\n\tmy $datPath = $Sys->Get('BBSPATH') . '/' . $Sys->Get('BBS') . '/dat/' . $Sys->Get('KEY') . '.dat';\r\n\t$DAT->Load($Sys, $datPath, 1);\r\n\t\r\n\t$subMode\t= $Form->Get('MODE_SUB');\r\n\t$err\t\t= 9999;\r\n\t\r\n\tif ($subMode eq 'EDIT') {\t\t\t\t\t\t\t\t\t\t\t\t\t# \ufffd\ufffd\ufffdX\ufffd\u048fW\r\n\t\t$err = FunctionResEdit($Sys, $Form, $DAT, $this->{'LOG'});\r\n\t}\r\n\telsif ($subMode eq 'ABONE') {\t\t\t\t\t\t\t\t\t\t\t\t# \ufffd\ufffd\ufffdX\ufffd\ufffd\ufffd\u0681`\ufffd\ufffd\r\n\t\t$err = FunctionResDelete($Sys, $Form, $DAT, $this->{'LOG'}, 1);\r\n\t}\r\n\telsif ($subMode eq 'DELETE') {\t\t\t\t\t\t\t\t\t\t\t\t# \ufffd\ufffd\ufffdX\ufffd\ud3dc\r\n\t\t$err = FunctionResDelete($Sys, $Form, $DAT, $this->{'LOG'}, 0);\r\n\t}\r\n\t\r\n\t# \ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\u0295\\\ufffd\ufffd\r\n\tif ($err) {\r\n\t\t$pSys->{'LOGGER'}->Put($Form->Get('UserName'), \"RESPONSE($subMode)\", \"ERROR:$err\");\r\n\t\tpush @{$this->{'LOG'}}, $err;\r\n\t\t$Form->Set('MODE_SUB', 'FALSE');\r\n\t}\r\n\telse {\r\n\t\t$pSys->{'LOGGER'}->Put($Form->Get('UserName'), \"RESPONSE($subMode)\", 'COMPLETE');\r\n\t\t$Form->Set('MODE_SUB', 'COMPLETE');\r\n\t}\r\n\t$pSys->{'AD_BBS'} = $BBS;\r\n\t$pSys->{'AD_DAT'} = $DAT;\r\n\t$this->DoPrint($Sys, $Form, $pSys);\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\ufffd\ufffd\ufffdj\ufffd\ufffd\ufffd[\ufffd\ufffd\ufffdX\ufffdg\ufffd\u0752\ufffd\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Base\tSAURON\r\n#\t@return\t\ufffd\u0202\ufffd\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub SetMenuList\r\n{\r\n\tmy ($Base, $pSys, $bbs) = @_;\r\n\t\r\n\t$Base->SetMenu('\ufffd\ufffd\ufffdX\ufffd\ua5d7', \"'thread.res','DISP','LIST'\");\r\n\t\r\n\t# \ufffd\ufffd\ufffdX\ufffd\ud3dc\ufffd\ufffd\ufffd\ufffd\ufffd\u0302\ufffd\r\n\tif ($pSys->{'SECINFO'}->IsAuthority($pSys->{'USER'}, $ZP::AUTH_RESDELETE, $bbs)){\r\n\t\t$Base->SetMenu('\ufffd\ufffd\ufffdX\ufffd\ua287\ufffd\ud3dc', \"'thread.res','DISP','DELLUMP'\");\r\n\t}\r\n\t# \ufffd\u01d7\ufffd\ufffdO\ufffd\ufffd\ufffd[\ufffdv\ufffd\ufffd\ufffd\ufffd\ufffd\u0302\ufffd\r\n\tif ($pSys->{'SECINFO'}->IsAuthority($pSys->{'USER'}, $ZP::AUTH_USERGROUP, $bbs)){\r\n\t#\t$Base->SetMenu('<hr>', '');\r\n\t#\t$Base->SetMenu('\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\u0743\ufffd\ufffdO', \"'thread.res','DISP','LOG_THREAD_WRITE'\");\r\n\t}\r\n\t$Base->SetMenu('<hr>', '');\r\n\t$Base->SetMenu('\ufffdf\ufffd\ufffd\ufffd\u008a\u01d7\ufffd\ufffd\u0596\u07c2\ufffd', \"'bbs.thread','DISP','LIST'\");\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\ufffd\ufffd\ufffdX\ufffd\ua5d7\ufffd\u0315\\\ufffd\ufffd\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Page\t\ufffdy\ufffd[\ufffdW\ufffdR\ufffd\ufffd\ufffde\ufffdL\ufffdX\ufffdg\r\n#\t@param\t$SYS\t\ufffdV\ufffdX\ufffde\ufffd\ufffd\ufffd\u03d0\ufffd\r\n#\t@param\t$Form\t\ufffdt\ufffdH\ufffd[\ufffd\ufffd\ufffd\u03d0\ufffd\r\n#\t@param\t$Dat\tdat\ufffd\u03d0\ufffd\r\n#\t@return\t\ufffd\u0202\ufffd\r\n#\r\n#\t2010.08.12 windyakin \ufffd\ufffd\r\n#\t -> \ufffdf\ufffdt\ufffdH\ufffd\ufffd\ufffdg\ufffd\\\ufffd\ufffd\ufffd\u0150V\ufffdP\ufffdO\ufffd\u0255\u03cdX\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub PrintResList\r\n{\r\n\tmy ($Page, $Sys, $Form, $Dat,$Logger) = @_;\r\n\tmy (@elem, $resNum, $dispNum, $dispSt, $dispEd, $common, $i);\r\n\tmy ($pRes, $isAbone, $isEdit, $isAccessUser, $format);\r\n\tmy ($log, @logs, $lastnum, $logsize);\r\n\t\r\n\t$Sys->Set('_TITLE', 'Res List');\r\n\t\r\n\t# \ufffd\\\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\u0310\u0752\ufffd\r\n\t$format = $Form->Get('DISP_FORMAT') eq '' ? 'l10' : $Form->Get('DISP_FORMAT');\r\n\t($dispSt, $dispEd) = AnalyzeFormat($format, $Dat);\r\n\t\r\n\t$common = \"DoSubmit('thread.res','DISP','LIST');\";\r\n\t\r\n\t$Page->Print(\"<center><dl><table border=0 cellspacing=2 width=100%>\");\r\n\t$Page->Print(\"<tr><td colspan=2 align=right>\ufffd\\\\\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffdF<input type=text name=DISP_FORMAT\");\r\n\t$Page->Print(\" value=\\\"$format\\\"><input type=button value=\\\"\ufffd@\ufffd\\\\\ufffd\ufffd\ufffd@\\\" onclick=\\\"$common\\\">\");\r\n\t$Page->Print(\"</td></tr>\\n<tr><td colspan=2><hr></td></tr>\\n\");\r\n\t$Page->Print(\"<tr><th style=\\\"width:30\\\">\ufffd@</th>\");\r\n\t$Page->Print(\"<td class=\\\"DetailTitle\\\" style=\\\"width:300\\\">Contents</td></tr>\\n\");\r\n\t\r\n\t# \ufffd\ufffd\ufffd\ufffd\ufffd\u64fe\r\n\t$isAbone = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'}, $ZP::AUTH_RESDELETE, $Sys->Get('BBS'));\r\n\t$isEdit = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'}, $ZP::AUTH_RESEDIT, $Sys->Get('BBS'));\r\n\t$isAccessUser = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'}, $ZP::AUTH_ACCESUSER, $Sys->Get('BBS'));\r\n\t\r\n\t$lastnum = $Dat->Size() - 1;\r\n\t$logsize = $Logger->Size();\r\n\t\r\n\t$lastnum -= 1 if ($Dat->IsStopped($Sys));\r\n\t\r\n\t# \ufffd\ufffd\ufffdX\ufffd\ua5d7\ufffd\ufffd\ufffdo\ufffd\ufffd\r\n\tfor ($i = $dispSt ; $i < $dispEd ; $i++) {\r\n\t\t$pRes\t= $Dat->Get($i);\r\n\t\t@elem\t= split(/<>/, $$pRes);\r\n\t\t$log = $Logger->Get($logsize - 1 + $i - $lastnum);\r\n\t\t@logs\t= split(/<>/,$log,-1) if (defined $log);\r\n\t\t\r\n\t\t$Page->Print(\"<tr><td class=\\\"Response\\\" valign=top>\");\r\n\t\t\r\n\t\t# \ufffd\ufffd\ufffdX\ufffd\ud3dc\ufffd\ufffd\ufffd\u0242\ufffd\ufffd\\\ufffd\ufffd\ufffd}\ufffd\ufffd\r\n\t\tif ($isAbone) {\r\n\t\t\t$Page->Print(\"<input type=checkbox name=RESS value=$i></td>\");\r\n\t\t}\r\n\t\telse {\r\n\t\t\t$Page->Print(\"</td>\");\r\n\t\t}\r\n\t\t$Page->Print(\"<td class=\\\"Response\\\"><dt>\");\r\n\t\t\r\n\t\t# \ufffd\ufffd\ufffdX\ufffd\u048fW\ufffd\ufffd\ufffd\u0242\ufffd\ufffd\\\ufffd\ufffd\ufffd}\ufffd\ufffd\r\n\t\tif ($isEdit) {\r\n\t\t\t$common = \"\\\"javascript:SetOption('SELECT_RES','$i');\";\r\n\t\t\t$common = $common . \"DoSubmit('thread.res','DISP','EDIT')\\\"\";\r\n\t\t\t$Page->Print(\"<a href=$common>\" . ($i + 1) . \"</a>\");\r\n\t\t}\r\n\t\telse {\r\n\t\t\t$Page->Print('' . ($i + 1));\r\n\t\t}\r\n\t\t$Page->Print(\"\ufffdF<font color=forestgreen><b>$elem[0]</b></font>[$elem[1]]\");\r\n\t\t$Page->Print(\"\ufffdF$elem[2]</dt><dd>$elem[3]\");\r\n\t\t$Page->Print(\"<br><br><hr>HOST:$logs[5]<br>IP:$logs[6]<br>UA:$logs[8]\") if (defined $log && $isAccessUser);\r\n\t\t$Page->Print(\"</dd></td></tr>\\n\");\r\n\t}\r\n\t$Page->HTMLInput('hidden', 'SELECT_RES', '');\r\n\t$Page->Print(\"<tr><td colspan=2><hr></td></tr>\\n\");\r\n\t\r\n\t# \ufffdV\ufffdX\ufffde\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffdL\ufffd\ufffd\ufffd\u0242\ufffd\ufffd\\\ufffd\ufffd\ufffd}\ufffd\ufffd\r\n\tif ($isAbone) {\r\n\t\t$common = \"onclick=\\\"DoSubmit('thread.res','DISP'\";\r\n\t\t$Page->Print(\"<tr><td colspan=2 align=right>\");\r\n\t\t$Page->Print(\"<input type=button value=\\\"\ufffd\ufffd\ufffd\u0681`\ufffd\ufffd\\\" $common,'ABONE')\\\"> \");\r\n\t\t$Page->Print(\"<input type=button value=\\\"\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\u0681`\ufffd\ufffd\\\" $common,'DELETE')\\\">\");\r\n\t\t$Page->Print(\"</td></tr>\\n\");\r\n\t}\r\n\t$Page->Print(\"</table></dl><br>\");\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\ufffd\ufffd\ufffdX\ufffd\u048fW\ufffd\ufffd\u0282\u0315\\\ufffd\ufffd\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Page\t\ufffdy\ufffd[\ufffdW\ufffdR\ufffd\ufffd\ufffde\ufffdL\ufffdX\ufffdg\r\n#\t@param\t$SYS\t\ufffdV\ufffdX\ufffde\ufffd\ufffd\ufffd\u03d0\ufffd\r\n#\t@param\t$Form\t\ufffdt\ufffdH\ufffd[\ufffd\ufffd\ufffd\u03d0\ufffd\r\n#\t@param\t$Dat\tdat\ufffd\u03d0\ufffd\r\n#\t@return\t\ufffd\u0202\ufffd\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub PrintResEdit\r\n{\r\n\tmy ($Page, $Sys, $Form, $Dat) = @_;\r\n\tmy (@elem, $pRes, $isEdit, $common);\r\n\t\r\n\t$Sys->Set('_TITLE', 'Res Edit');\r\n\t\r\n\t$isEdit = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'}, $ZP::AUTH_RESEDIT, $Sys->Get('BBS'));\r\n\t$pRes\t= $Dat->Get($Form->Get('SELECT_RES'));\r\n\t@elem\t= split(/<>/, $$pRes);\r\n\t\r\n\t$elem[3] =~ s/^ //;\r\n\t$elem[3] =~ s/ $//;\r\n\t$elem[3] =~ s/ ?<br> ?/\\n/g;\r\n\tforeach (0 .. 3) {\r\n\t\t$elem[$_] =~ s/&/&amp;/g;\r\n\t\t$elem[$_] =~ s/\"/&quot;/g;\r\n\t\t$elem[$_] =~ s/</&lt;/g;\r\n\t\t$elem[$_] =~ s/>/&gt;/g;\r\n\t}\r\n\t\r\n\t$Page->Print(\"<center><table border=0 cellspacing=2 width=100%>\");\r\n\t$Page->Print(\"<tr><td colspan=2><hr></td></tr>\");\r\n\t$Page->Print(\"<tr><td class=\\\"DetailTitle\\\">\ufffd\ufffd\ufffdO</td><td>\");\r\n\t$Page->Print(\"<input type=text size=50 value=\\\"$elem[0]\\\" name=FROM></td></tr>\");\r\n\t$Page->Print(\"<tr><td class=\\\"DetailTitle\\\">\ufffd\ufffd\ufffd[\ufffd\ufffd</td><td>\");\r\n\t$Page->Print(\"<input type=text size=50 value=\\\"$elem[1]\\\" name=mail></td></tr>\");\r\n\t$Page->Print(\"<tr><td class=\\\"DetailTitle\\\">\ufffd\ufffd\ufffdt\ufffdEID</td><td>\");\r\n\t$Page->Print(\"<input type=text size=50 value=\\\"$elem[2]\\\" name=_DATE_></td></tr>\");\r\n\t$Page->Print(\"<tr><td class=\\\"DetailTitle\\\">\ufffd{\ufffd\ufffd</td><td>\");\r\n\t$Page->Print(\"<textarea name=MESSAGE cols=70 rows=10>$elem[3]</textarea></td></tr>\");\r\n\t$Page->Print(\"<tr><td colspan=2><hr></td></tr>\");\r\n\t\r\n\t$Page->HTMLInput('hidden', 'SELECT_RES', $Form->Get('SELECT_RES'));\r\n\t\r\n\t# \ufffdV\ufffdX\ufffde\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffdL\ufffd\ufffd\ufffd\u0242\ufffd\ufffd\\\ufffd\ufffd\ufffd}\ufffd\ufffd\r\n\tif ($isEdit) {\r\n\t\t$common = \"onclick=\\\"DoSubmit('thread.res','FUNC'\";\r\n\t\t$Page->Print(\"<tr><td colspan=2 align=right>\");\r\n\t\t$Page->Print(\"<input type=button value=\\\"\ufffd@\ufffd\u03cdX\ufffd@\\\" $common,'EDIT')\\\"> \");\r\n\t\t$Page->Print(\"</td></tr>\\n\");\r\n\t}\r\n\t$Page->Print(\"</table><br>\");\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\ufffd\ufffd\ufffdX\ufffd\ud3dc\ufffdm\ufffdF\ufffd\u0315\\\ufffd\ufffd\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Page\t\ufffdy\ufffd[\ufffdW\ufffdR\ufffd\ufffd\ufffde\ufffdL\ufffdX\ufffdg\r\n#\t@param\t$SYS\t\ufffdV\ufffdX\ufffde\ufffd\ufffd\ufffd\u03d0\ufffd\r\n#\t@param\t$Form\t\ufffdt\ufffdH\ufffd[\ufffd\ufffd\ufffd\u03d0\ufffd\r\n#\t@param\t$Dat\tdat\ufffd\u03d0\ufffd\r\n#\t@return\t\ufffd\u0202\ufffd\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub PrintResDelete\r\n{\r\n\tmy ($Page, $Sys, $Form, $Dat, $mode) = @_;\r\n\tmy (@resSet, @elem, $pRes, $num, $common, $isAbone);\r\n\t\r\n\t$Sys->Set('_TITLE', 'Res Delete Confirm');\r\n\t\r\n\t# \ufffdI\ufffd\ufffd\ufffd\ufffd\ufffdX\ufffd\ufffd\ufffd\u64fe\r\n\t@resSet = $Form->GetAtArray('RESS');\r\n\t\r\n\t# \ufffd\ufffd\ufffd\ufffd\ufffd\u64fe\r\n\t$isAbone = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'}, $ZP::AUTH_RESDELETE, $Sys->Get('BBS'));\r\n\t\r\n\t$Page->Print(\"<center><dl><table border=0 cellspacing=2 width=100%>\");\r\n\t$Page->Print(\"<tr><td>\ufffd\u0209\ufffd\ufffd\u0303\ufffd\ufffdX\ufffd\ufffd\" . ($mode ? '\ufffd\ufffd\ufffd\u0681`\ufffd\ufffd' : '\ufffd\ud3dc') . \"\ufffd\ufffd\ufffd\u0702\ufffd\ufffdB</td></tr>\\n\");\r\n\t$Page->Print(\"<tr><td><hr></td></tr>\\n\");\r\n\t$Page->Print(\"<tr><td class=\\\"DetailTitle\\\">Contents</td></tr>\\n\");\r\n\t\r\n\t# \ufffd\ufffd\ufffdX\ufffd\ua5d7\ufffd\ufffd\ufffdo\ufffd\ufffd\r\n\tforeach $num (@resSet) {\r\n\t\t$pRes\t= $Dat->Get($num);\r\n\t\t@elem\t= split(/<>/, $$pRes);\r\n\t\t\r\n\t\t$Page->Print(\"<tr><td class=\\\"Response\\\"><dt>\" . ($num + 1));\r\n\t\t$Page->Print(\"\ufffdF<font color=forestgreen><b>$elem[0]</b></font>[$elem[1]]\");\r\n\t\t$Page->Print(\"\ufffdF$elem[2]</dt><dd>$elem[3]<br><br></dd></td></tr>\\n\");\r\n\t\t$Page->HTMLInput('hidden', 'RESS', $num);\r\n\t}\r\n\t$Page->Print(\"<tr><td><hr></td></tr>\\n\");\r\n\t\r\n\t# \ufffdV\ufffdX\ufffde\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffdL\ufffd\ufffd\ufffd\u0242\ufffd\ufffd\\\ufffd\ufffd\ufffd}\ufffd\ufffd\r\n\tif ($isAbone) {\r\n\t\t$common = \"onclick=\\\"DoSubmit('thread.res','FUNC','\";\r\n\t\t$common = $common . ($mode ? 'ABONE' : 'DELETE') . \"')\\\"\";\r\n\t\t$Page->Print(\"<tr><td align=right>\");\r\n\t\t$Page->Print(\"<input type=button value=\\\"\ufffd@\ufffd\ufffd\ufffds\ufffd@\\\" $common> \");\r\n\t\t$Page->Print(\"</td></tr>\\n\");\r\n\t}\r\n\t$Page->Print(\"</table></dl><br>\");\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\ufffd\ufffd\ufffdX\ufffd\ua287\ufffd\ud3dc\ufffd\u0315\\\ufffd\ufffd\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Page\t\ufffdy\ufffd[\ufffdW\ufffdR\ufffd\ufffd\ufffde\ufffdL\ufffdX\ufffdg\r\n#\t@param\t$SYS\t\ufffdV\ufffdX\ufffde\ufffd\ufffd\ufffd\u03d0\ufffd\r\n#\t@param\t$Form\t\ufffdt\ufffdH\ufffd[\ufffd\ufffd\ufffd\u03d0\ufffd\r\n#\t@param\t$Dat\tdat\ufffd\u03d0\ufffd\r\n#\t@return\t\ufffd\u0202\ufffd\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub PrintResLumpDelete\r\n{\r\n\tmy ($Page, $Sys, $Form, $Dat) = @_;\r\n\tmy (@resSet, @elem, $pRes, $format, $num, $common, $isAbone);\r\n\t\r\n\t$Sys->Set('_TITLE', 'Res Lump Delete');\r\n\t\r\n\t# \ufffd\ufffd\ufffd\ufffd\ufffd\u0309\ufffd\ufffd\r\n\t$num = 0;\r\n\t$format = $Form->Get('DEL_FORMAT');\r\n\tif ($format ne '') {\r\n\t\tAnalyzeDeleteFormat($format, $Dat, \\@resSet);\r\n\t\t$num = @resSet;\r\n\t}\r\n\t\r\n\t# \ufffd\ufffd\ufffd\ufffd\ufffd\u64fe\r\n\t$isAbone = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'}, $ZP::AUTH_RESDELETE, $Sys->Get('BBS'));\r\n\t\r\n\t$Page->Print(\"<center><dl><table border=0 cellspacing=2 width=100%>\");\r\n\t$Page->Print(\"<tr><td colspan=2><hr></td></tr>\\n\");\r\n\t$Page->Print(\"<tr><td class=\\\"DetailTitle\\\">\ufffd\ud3dc\ufffd\ufffd\ufffdX\ufffd\ufffd\ufffd\ufffd</td><td>\");\r\n\t$Page->Print(\"<input type=text name=DEL_FORMAT size=40 value=$format></td></tr>\\n\");\r\n\t$Page->Print(\"<tr><td colspan=2><hr></td></tr>\\n\");\r\n\t\r\n\tif ($num > 0) {\r\n\t\t$Page->Print(\"<tr><td colspan=2 class=\\\"DetailTitle\\\">Delete Contents</td></tr>\");\r\n\t\t\r\n\t\t# \ufffd\ufffd\ufffdX\ufffd\ua5d7\ufffd\ufffd\ufffdo\ufffd\ufffd\r\n\t\tforeach $num (@resSet) {\r\n\t\t\t$pRes\t= $Dat->Get($num);\r\n\t\t\t@elem\t= split(/<>/, $$pRes);\r\n\t\t\t\r\n\t\t\t$Page->Print(\"<tr><td colspan=2 class=\\\"Response\\\"><dt>\" . ($num + 1));\r\n\t\t\t$Page->Print(\"\ufffdF<font color=forestgreen><b>$elem[0]</b></font>[$elem[1]]\");\r\n\t\t\t$Page->Print(\"\ufffdF$elem[2]</dt><dd>$elem[3]<br><br></dd></td></tr>\\n\");\r\n\t\t\t$Page->HTMLInput('hidden', 'RESS', $num);\r\n\t\t}\r\n\t\t$Page->Print(\"<tr><td colspan=2><hr></td></tr>\\n\");\r\n\t}\r\n\t\r\n\t# \ufffdV\ufffdX\ufffde\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffdL\ufffd\ufffd\ufffd\u0242\ufffd\ufffd\\\ufffd\ufffd\ufffd}\ufffd\ufffd\r\n\tif ($isAbone) {\r\n\t\t$common = \"onclick=\\\"DoSubmit('thread.res'\";\r\n\t\t$Page->Print(\"<tr><td align=right colspan=2>\");\r\n\t\t$Page->Print(\"<input type=button value=\\\"\ufffd@\ufffdm\ufffdF\ufffd@\\\" $common,'DISP','DELLUMP')\\\" style=\\\"float: left;\\\"> \");\r\n\t\t$Page->Print(\"<input type=button value=\\\"\ufffd\ufffd\ufffd\u0681`\ufffd\ufffd\\\" $common,'FUNC','ABONE')\\\"> \");\r\n\t\t$Page->Print(\"<input type=button value=\\\"\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\u0681`\ufffd\ufffd\\\" $common,'FUNC','DELETE')\\\"> \");\r\n\t\t$Page->Print(\"</td></tr>\\n\");\r\n\t}\r\n\t$Page->Print(\"</table></dl><br>\");\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\ufffd\ufffd\ufffdX\ufffd\u048fW\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Sys\t\ufffdV\ufffdX\ufffde\ufffd\ufffd\ufffd\u03d0\ufffd\r\n#\t@param\t$Form\t\ufffdt\ufffdH\ufffd[\ufffd\ufffd\ufffd\u03d0\ufffd\r\n#\t@param\t$Dat\tDat\ufffd\u03d0\ufffd\r\n#\t@param\t$pLog\t\ufffd\ufffd\ufffdO\ufffdp\r\n#\t@return\t\ufffdG\ufffd\ufffd\ufffd[\ufffdR\ufffd[\ufffdh\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub FunctionResEdit\r\n{\r\n\tmy ($Sys, $Form, $Dat, $pLog) = @_;\r\n\tmy (@elem, $pRes, $data);\r\n\t\r\n\t# \ufffd\ufffd\ufffd\ufffd\ufffd`\ufffdF\ufffdb\ufffdN\r\n\t{\r\n\t\tmy $SEC = $Sys->Get('ADMIN')->{'SECINFO'};\r\n\t\tmy $chkID = $Sys->Get('ADMIN')->{'USER'};\r\n\t\t\r\n\t\tif (($SEC->IsAuthority($chkID, $ZP::AUTH_RESEDIT, $Sys->Get('BBS'))) == 0) {\r\n\t\t\treturn 1000;\r\n\t\t}\r\n\t}\r\n\t\r\n\t# \ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\u0743\ufffd\ufffd[\ufffdh\ufffd\u0153\u01c2\u0752\ufffd\ufffd\ufffd\r\n\t$Dat->ReLoad($Sys, 0);\r\n\t\r\n\t$pRes = $Dat->Get($Form->Get('SELECT_RES'));\r\n\t@elem = split(/<>/, $$pRes);\r\n\t$elem[0] = $Form->Get('FROM');\r\n\t$elem[1] = $Form->Get('mail');\r\n\t$elem[2] = $Form->Get('_DATE_');\r\n\t$elem[3] = $Form->Get('MESSAGE');\r\n\t\r\n\t# \ufffd\ufffd\ufffds\ufffdE\ufffd\u0591\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\u0315\u03ca\ufffd\r\n\t$elem[3] =~ s/\\r\\n|\\r|\\n/ <br> /g;\r\n\t$elem[3] =~ s/<>/&lt;&gt;/g;\r\n\t$elem[3] = \" $elem[3] \";\r\n\t\r\n\t# \ufffdf\ufffd[\ufffd^\ufffd\u0318A\ufffd\ufffd\r\n\t$data = join('<>', @elem);\r\n\t\r\n\t# \ufffdf\ufffd[\ufffd^\ufffd\u0310\u0752\ufffd\u0195\u06d1\ufffd\r\n\t$Dat->Set($Form->Get('SELECT_RES'), $data);\r\n\t$Dat->Save($Sys);\r\n\t\r\n\t# \ufffd\ufffd\ufffdO\ufffd\u0310\u0752\ufffd\r\n\tpush @$pLog, '\ufffd\u050d\ufffd[' . $Form->Get('SELECT_RES') . ']\ufffd\u0303\ufffd\ufffdX\ufffd\ufffd\ufffd\u0209\ufffd\ufffd\u0302\u60a4\ufffd\u0255\u03cdX\ufffd\ufffd\ufffd\u0702\ufffd\ufffd\ufffd\ufffdB';\r\n\tforeach (@elem) {\r\n\t\tpush @$pLog, $_;\r\n\t}\r\n\t\r\n\treturn 0;\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\ufffd\ufffd\ufffdX\ufffd\ud3dc\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Sys\t\ufffdV\ufffdX\ufffde\ufffd\ufffd\ufffd\u03d0\ufffd\r\n#\t@param\t$Form\t\ufffdt\ufffdH\ufffd[\ufffd\ufffd\ufffd\u03d0\ufffd\r\n#\t@param\t$Dat\tDat\ufffd\u03d0\ufffd\r\n#\t@param\t$pLog\t\ufffd\ufffd\ufffdO\ufffdp\r\n#\t@return\t\ufffdG\ufffd\ufffd\ufffd[\ufffdR\ufffd[\ufffdh\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub FunctionResDelete\r\n{\r\n\tmy ($Sys, $Form, $Dat, $pLog, $mode) = @_;\r\n\tmy (@resSet, $pRes, $abone, $path, $tm, $user, $delCnt, $num, $datPath, $LOG, $logsize, $lastnum);\r\n\t\r\n\t# \ufffd\ufffd\ufffd\ufffd\ufffd`\ufffdF\ufffdb\ufffdN\r\n\t{\r\n\t\tmy $SEC\t= $Sys->Get('ADMIN')->{'SECINFO'};\r\n\t\tmy $chkID\t= $Sys->Get('ADMIN')->{'USER'};\r\n\t\t\r\n\t\tif (($SEC->IsAuthority($chkID, $ZP::AUTH_RESDELETE, $Sys->Get('BBS'))) == 0) {\r\n\t\t\treturn 1000;\r\n\t\t}\r\n\t}\r\n\t\r\n\t# \ufffd\ufffd\ufffd\u0681`\ufffd\ud8f9\udf82\u034d\ud3dc\ufffd\ufffd\ufffd\ufffd\ufffd\u64fe\r\n\tif ($mode) {\r\n\t\tmy $Setting;\r\n\t\trequire './module/isildur.pl';\r\n\t\t$Setting = ISILDUR->new;\r\n\t\t$Setting->Load($Sys);\r\n\t\t$abone\t= $Setting->Get('BBS_DELETE_NAME');\r\n\t}\r\n\telse {\r\n\t\trequire './module/peregrin.pl';\r\n\t\t$LOG = PEREGRIN->new;\r\n\t\t$LOG->Load($Sys, 'WRT', $Sys->Get('KEY'));\r\n\t\t$logsize = $LOG->Size();\r\n\t\t$lastnum = $Dat->Size() - 1;\r\n\t}\r\n\t\r\n\t# \ufffde\ufffdl\ufffd\ufffd\u0752\ufffd\r\n\t@resSet\t= $Form->GetAtArray('RESS');\r\n\t$datPath= $Sys->Get('BBSPATH') . '/' . $Sys->Get('BBS') . '/dat/' . $Sys->Get('KEY') . '.dat';\r\n\t$path\t= $Sys->Get('BBSPATH') . '/' . $Sys->Get('BBS') . '/log/del_' . $Sys->Get('KEY') . '.cgi';\r\n\t$tm\t\t= time;\r\n\t$user\t= $Form->Get('UserName');\r\n\t$delCnt\t= 0;\r\n\t\r\n\t# dat\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\u0743\ufffd\ufffd[\ufffdh\ufffd\u0153\u01c2\u0752\ufffd\ufffd\ufffd\r\n\t$Dat->Close();\r\n\t$Dat->Load($Sys, $datPath, 0);\r\n\t\r\n\t# \ufffd\ud3dc\ufffd\u0193\ufffd\ufffd\ufffd\ufffd\u024d\ud3dc\ufffd\ufffd\ufffdO\ufffd\u058d\ud3dc\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffde\ufffd\ufffd\u06d1\ufffd\ufffd\ufffd\ufffd\ufffd\r\n\tif (open(my $f_dellog, '>>', $path)) {\r\n\t\tflock($f_dellog, 2);\r\n\t\tbinmode($f_dellog);\r\n\t\tforeach $num (sort @resSet) {\r\n\t\t\tnext if ($num == 0);\r\n\t\t\t$pRes = $Dat->Get($num - $delCnt);\r\n\t\t\tprint $f_dellog \"$tm<>$user<>$num<>$mode<>$$pRes\";\r\n\t\t\tif ($mode) {\r\n\t\t\t\t$Dat->Set($num, \"$abone<>$abone<>$abone<>$abone<>$abone\\n\");\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\t$Dat->Delete($num - $delCnt);\r\n\t\t\t\t$LOG->Delete($logsize - 1 + ($num - $delCnt) - $lastnum);\r\n\t\t\t\t$delCnt ++;\r\n\t\t\t\t$logsize --;\r\n\t\t\t\t$lastnum --;\r\n\t\t\t}\r\n\t\t}\r\n\t\tclose($f_dellog);\r\n\t\tchmod($Sys->Get('PM-LOG'), $path);\r\n\t\t\r\n\t\t# \ufffd\u06d1\ufffd\r\n\t\t$Dat->Save($Sys);\r\n\t\t$LOG->Save($Sys) if (! $mode);\r\n\t}\r\n\t\r\n\t# \ufffd\ufffd\ufffdO\ufffd\u0310\u0752\ufffd\r\n\t$delCnt = 0;\r\n\t$abone\t= '';\r\n\tpush @$pLog, '\ufffd\u0209\ufffd\ufffd\u0303\ufffd\ufffdX\ufffd\ufffd' . ($mode ? '\ufffd\ufffd\ufffd\u0681`\ufffd\ufffd' : '\ufffd\ud3dc') . '\ufffd\ufffd\ufffd\u0702\ufffd\ufffd\ufffd\ufffdB';\r\n\tforeach (@resSet) {\r\n\t\tnext if ($_ == 0);\r\n\t\tif ($delCnt > 5) {\r\n\t\t\tpush @$pLog, $abone;\r\n\t\t\t$abone = '';\r\n\t\t\t$delCnt = 0;\r\n\t\t}\r\n\t\telse {\r\n\t\t\t$abone .= ($_ + 1) . ', ';\r\n\t\t\t$delCnt ++;\r\n\t\t}\r\n\t}\r\n\tpush @$pLog, $abone;\r\n\t\r\n\treturn 0;\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\ufffd\ud3dc\ufffd\ufffd\ufffd\ufffd\ufffd\u0309\ufffd\ufffd\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$format\t\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\r\n#\t@param\t$Dat\tARAGORN\ufffdI\ufffdu\ufffdW\ufffdF\ufffdN\ufffdg\r\n#\t@param\t$pSet\t\ufffd\ufffd\ufffd\u028ai\ufffd[\ufffdz\ufffd\ufffd\u030eQ\ufffd\ufffd\r\n#\t@return\t\ufffd\u0202\ufffd\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub AnalyzeDeleteFormat\r\n{\r\n\tmy ($format, $Dat, $pSet) = @_;\r\n\tmy (%deleteTable, @elem, $i, $st, $ed);\r\n\t\r\n\t# \ufffdZ\ufffdp\ufffd\ufffd\ufffd[\ufffd^\ufffd\u0155\ufffd\ufffd\ufffd\r\n\t@elem = split(/\\, /, $format);\r\n\t\r\n\t# 1\ufffd\u656a\ufffd\ufffd\ufffd\u008f\ufffd\ufffd\ufffd\ufffd\ufffd\u0342\ufffd\ufffd\ufffd\ufffd\u0103n\ufffdb\ufffdV\ufffd\ufffd(\ufffd\ufffdd\ufffdo\ufffd^\ufffdh\ufffd~\ufffd\u0302\ufffd\ufffd\ufffd)\ufffd\u024ai\ufffd[\r\n\tforeach (@elem){\r\n\t\t($st, $ed) = AnalyzeFormat($_, $Dat);\r\n\t\tif ($st != 0 || $ed != 0) {\r\n\t\t\tfor ($i = $st ; $i < $ed ; $i++) {\r\n\t\t\t\t$deleteTable{$i} = 'true';\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\t# \ufffd\ufffd\ufffd\u0282\ufffdz\ufffd\ufffd\u0250\u0752\ufffd\r\n\tforeach (sort {$a <=> $b} (keys %deleteTable)) {\r\n\t\tpush @$pSet, $_;\r\n\t}\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\ufffd\ufffd\ufffd\ufffd\ufffd\u0309\ufffd\ufffd\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$format\t\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\r\n#\t@param\t$Dat\tARAGORN\ufffdI\ufffdu\ufffdW\ufffdF\ufffdN\ufffdg\r\n#\t@return\t(\ufffdJ\ufffdn\ufffd\u050d\ufffd, \ufffdI\ufffd\ufffd\ufffd\u050d\ufffd)\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub AnalyzeFormat\r\n{\r\n\tmy ($format, $Dat) = @_;\r\n\tmy ($start, $end, $max);\r\n\t\r\n\t# \ufffd\ufffd\ufffd\ufffd\ufffdG\ufffd\ufffd\ufffd[\r\n\tif ($format =~ /[^0-9\\-l]/ || $format eq '') {\r\n\t\treturn (0, 0);\r\n\t}\r\n\t$max = $Dat->Size();\r\n\t\r\n\t# \ufffd\u0150Vn\ufffd\ufffd\r\n\tif ($format =~ /l(\\d+)/) {\r\n\t\t$end\t= $max;\r\n\t\t$start\t= ($max - $1 + 1) > 0 ? ($max - $1 + 1) : 1;\r\n\t}\r\n\t# n\ufffd`m\r\n\telsif ($format =~ /(\\d+)-(\\d+)/) {\r\n\t\t$start\t= $1 > $max ? $max : $1;\r\n\t\t$end\t= $2 > $max ? $max : $2;\r\n\t}\r\n\t# n\ufffd\u020d~\ufffd\ufffd\ufffd\u05c2\ufffd\r\n\telsif ($format =~ /(\\d+)-/) {\r\n\t\t$start\t= $1 > $max ? $max : $1;\r\n\t\t$end\t= $max;\r\n\t}\r\n\t# n\ufffd\u0211O\ufffd\ufffd\ufffd\u05c2\ufffd\r\n\telsif ($format =~ /-(\\d+)/) {\r\n\t\t$start\t= 1;\r\n\t\t$end\t= $1 > $max ? $max : $1;\r\n\t}\r\n\t# n\ufffd\u0302\ufffd\r\n\telsif ($format =~ /(\\d+)/) {\r\n\t\t$start\t= $1 > $max ? $max : $1;\r\n\t\t$end\t= $1 > $max ? $max : $1;\r\n\t}\r\n\t\r\n\t# \ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffdK\ufffd\ufffd\r\n\tif ($start > $end) {\r\n\t\t$max = $start;\r\n\t\t$start = $end;\r\n\t\t$end = $start;\r\n\t}\r\n\t\r\n\treturn ($start - 1, $end);\r\n}\r\n\r\n#============================================================================================================\r\n#\tModule END\r\n#============================================================================================================\r\n1;\r\n"], "fixing_code": ["#============================================================================================================\r\n#\r\n#\t\u30b9\u30ec\u30c3\u30c9\u7ba1\u7406 - \u30ec\u30b9 \u30e2\u30b8\u30e5\u30fc\u30eb\r\n#\tthread.res.pl\r\n#\t---------------------------------------------------------------------------\r\n#\t2004.07.21 start\r\n#\r\n#============================================================================================================\r\npackage\tMODULE;\r\n\r\nuse strict;\r\nuse warnings;\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t\u306a\u3057\r\n#\t@return\t\u30e2\u30b8\u30e5\u30fc\u30eb\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub new\r\n{\r\n\tmy $this = shift;\r\n\tmy ($obj, @LOG);\r\n\t\r\n\t$obj = {\r\n\t\t'LOG' => \\@LOG\r\n\t};\r\n\tbless $obj, $this;\r\n\t\r\n\treturn $obj;\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\u8868\u793a\u30e1\u30bd\u30c3\u30c9\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Sys\tMELKOR\r\n#\t@param\t$Form\tSAMWISE\r\n#\t@param\t$pSys\t\u7ba1\u7406\u30b7\u30b9\u30c6\u30e0\r\n#\t@return\t\u306a\u3057\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub DoPrint\r\n{\r\n\tmy $this = shift;\r\n\tmy ($Sys, $Form, $pSys) = @_;\r\n\tmy ($subMode, $BASE, $BBS, $DAT, $Page,$Logger);\r\n\t\r\n\trequire './mordor/sauron.pl';\r\n\t$BASE = SAURON->new;\r\n\t$BBS = $pSys->{'AD_BBS'};\r\n\t$DAT = $pSys->{'AD_DAT'};\r\n\t\r\n\t# \u63b2\u793a\u677f\u60c5\u5831\u306e\u8aad\u307f\u8fbc\u307f\u3068\u30b0\u30eb\u30fc\u30d7\u8a2d\u5b9a\r\n\tif (! defined $pSys->{'AD_BBS'}) {\r\n\t\trequire './module/nazguls.pl';\r\n\t\t$BBS = NAZGUL->new;\r\n\t\t\r\n\t\t$BBS->Load($Sys);\r\n\t\t$Sys->Set('BBS', $BBS->Get('DIR', $Form->Get('TARGET_BBS')));\r\n\t\t$pSys->{'SECINFO'}->SetGroupInfo($BBS->Get('DIR', $Form->Get('TARGET_BBS')));\r\n\t}\r\n\t\r\n\t# dat\u306e\u8aad\u307f\u8fbc\u307f\r\n\tif (! defined $pSys->{'AD_DAT'}) {\r\n\t\trequire './module/gondor.pl';\r\n\t\t$DAT = ARAGORN->new;\r\n\t\t\r\n\t\t$Sys->Set('KEY', $Form->Get('TARGET_THREAD'));\r\n\t\tmy $datPath = $Sys->Get('BBSPATH') . '/' . $Sys->Get('BBS') . '/dat/' . $Sys->Get('KEY') . '.dat';\r\n\t\t$DAT->Load($Sys, $datPath, 1);\r\n\t}\r\n\t\r\n\t#log\u306e\u8aad\u307f\u8fbc\u307f\r\n\trequire './module/imrahil.pl';\r\n\t$Logger = IMRAHIL->new;\r\n\tmy $logPath = $Sys->Get('BBSPATH') . '/' . $Sys->Get('BBS') . '/log/' . $Sys->Get('KEY');\r\n\t$Logger->Open($logPath, 0, 1 | 2);\r\n\t\r\n\t# \u7ba1\u7406\u30de\u30b9\u30bf\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u751f\u6210\r\n\t$Page\t\t= $BASE->Create($Sys, $Form);\r\n\t$subMode\t= $Form->Get('MODE_SUB');\r\n\t\r\n\t# \u30e1\u30cb\u30e5\u30fc\u306e\u8a2d\u5b9a\r\n\tSetMenuList($BASE, $pSys, $Sys->Get('BBS'));\r\n\t\r\n\tif ($subMode eq 'LIST') {\t\t\t\t\t\t\t\t\t\t\t\t\t\t# \u30ec\u30b9\u4e00\u89a7\u753b\u9762\r\n\t\tPrintResList($Page, $Sys, $Form, $DAT,$Logger);\r\n\t}\r\n\telsif ($subMode eq 'EDIT') {\t\t\t\t\t\t\t\t\t\t\t\t\t# \u30ec\u30b9\u7de8\u96c6\u753b\u9762\r\n\t\tPrintResEdit($Page, $Sys, $Form, $DAT);\r\n\t}\r\n\telsif ($subMode eq 'ABONE') {\t\t\t\t\t\t\t\t\t\t\t\t\t# \u30ec\u30b9\u524a\u9664\u78ba\u8a8d\u753b\u9762\r\n\t\tPrintResDelete($Page, $Sys, $Form, $DAT, 1);\r\n\t}\r\n\telsif ($subMode eq 'DELETE') {\t\t\t\t\t\t\t\t\t\t\t\t\t# \u30ec\u30b9\u524a\u9664\u78ba\u8a8d\u753b\u9762\r\n\t\tPrintResDelete($Page, $Sys, $Form, $DAT, 0);\r\n\t}\r\n\telsif ($subMode eq 'DELLUMP') {\t\t\t\t\t\t\t\t\t\t\t\t\t# \u30ec\u30b9\u4e00\u62ec\u524a\u9664\u753b\u9762\r\n\t\tPrintResLumpDelete($Page, $Sys, $Form, $DAT);\r\n\t}\r\n\telsif ($subMode eq 'COMPLETE') {\t\t\t\t\t\t\t\t\t\t\t\t# \u5b8c\u4e86\u753b\u9762\r\n\t\t$Sys->Set('_TITLE', 'Process Complete');\r\n\t\t$BASE->PrintComplete('\u904e\u53bb\u30ed\u30b0\u51e6\u7406', $this->{'LOG'});\r\n\t}\r\n\telsif ($subMode eq 'FALSE') {\t\t\t\t\t\t\t\t\t\t\t\t\t# \u5931\u6557\u753b\u9762\r\n\t\t$Sys->Set('_TITLE', 'Process Failed');\r\n\t\t$BASE->PrintError($this->{'LOG'});\r\n\t}\r\n\t\r\n\t# \u63b2\u793a\u677f\u30fb\u30b9\u30ec\u30c3\u30c9\u60c5\u5831\u3092\u8a2d\u5b9a\r\n\t$Page->HTMLInput('hidden', 'TARGET_BBS', $Form->Get('TARGET_BBS'));\r\n\t$Page->HTMLInput('hidden', 'TARGET_THREAD', $Form->Get('TARGET_THREAD'));\r\n\t\r\n\t$BASE->Print($Sys->Get('_TITLE') . ' - ' . $BBS->Get('NAME', $Form->Get('TARGET_BBS'))\r\n\t\t\t\t\t. ' - ' . $DAT->GetSubject(), 3);\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\u6a5f\u80fd\u30e1\u30bd\u30c3\u30c9\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Sys\tMELKOR\r\n#\t@param\t$Form\tSAMWISE\r\n#\t@param\t$pSys\t\u7ba1\u7406\u30b7\u30b9\u30c6\u30e0\r\n#\t@return\t\u306a\u3057\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub DoFunction\r\n{\r\n\tmy $this = shift;\r\n\tmy ($Sys, $Form, $pSys) = @_;\r\n\tmy ($subMode, $err, $BBS, $DAT);\r\n\t\r\n\trequire './module/gondor.pl';\r\n\trequire './module/nazguls.pl';\r\n\t$BBS = NAZGUL->new;\r\n\t$DAT = ARAGORN->new;\r\n\t\r\n\t# \u63b2\u793a\u677f\u60c5\u5831\u306e\u8aad\u307f\u8fbc\u307f\u3068\u30b0\u30eb\u30fc\u30d7\u8a2d\u5b9a\r\n\t$BBS->Load($Sys);\r\n\t$Sys->Set('BBS', $BBS->Get('DIR', $Form->Get('TARGET_BBS')));\r\n\t$pSys->{'SECINFO'}->SetGroupInfo($BBS->Get('DIR', $Form->Get('TARGET_BBS')));\r\n\t\r\n\t# dat\u306e\u8aad\u307f\u8fbc\u307f\r\n\t$Sys->Set('KEY', $Form->Get('TARGET_THREAD'));\r\n\tmy $datPath = $Sys->Get('BBSPATH') . '/' . $Sys->Get('BBS') . '/dat/' . $Sys->Get('KEY') . '.dat';\r\n\t$DAT->Load($Sys, $datPath, 1);\r\n\t\r\n\t$subMode\t= $Form->Get('MODE_SUB');\r\n\t$err\t\t= 9999;\r\n\t\r\n\tif ($subMode eq 'EDIT') {\t\t\t\t\t\t\t\t\t\t\t\t\t# \u30ec\u30b9\u7de8\u96c6\r\n\t\t$err = FunctionResEdit($Sys, $Form, $DAT, $this->{'LOG'});\r\n\t}\r\n\telsif ($subMode eq 'ABONE') {\t\t\t\t\t\t\t\t\t\t\t\t# \u30ec\u30b9\u3042\u307c\u301c\u3093\r\n\t\t$err = FunctionResDelete($Sys, $Form, $DAT, $this->{'LOG'}, 1);\r\n\t}\r\n\telsif ($subMode eq 'DELETE') {\t\t\t\t\t\t\t\t\t\t\t\t# \u30ec\u30b9\u524a\u9664\r\n\t\t$err = FunctionResDelete($Sys, $Form, $DAT, $this->{'LOG'}, 0);\r\n\t}\r\n\t\r\n\t# \u51e6\u7406\u7d50\u679c\u8868\u793a\r\n\tif ($err) {\r\n\t\t$pSys->{'LOGGER'}->Put($Form->Get('UserName'), \"RESPONSE($subMode)\", \"ERROR:$err\");\r\n\t\tpush @{$this->{'LOG'}}, $err;\r\n\t\t$Form->Set('MODE_SUB', 'FALSE');\r\n\t}\r\n\telse {\r\n\t\t$pSys->{'LOGGER'}->Put($Form->Get('UserName'), \"RESPONSE($subMode)\", 'COMPLETE');\r\n\t\t$Form->Set('MODE_SUB', 'COMPLETE');\r\n\t}\r\n\t$pSys->{'AD_BBS'} = $BBS;\r\n\t$pSys->{'AD_DAT'} = $DAT;\r\n\t$this->DoPrint($Sys, $Form, $pSys);\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\u30e1\u30cb\u30e5\u30fc\u30ea\u30b9\u30c8\u8a2d\u5b9a\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Base\tSAURON\r\n#\t@return\t\u306a\u3057\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub SetMenuList\r\n{\r\n\tmy ($Base, $pSys, $bbs) = @_;\r\n\t\r\n\t$Base->SetMenu('\u30ec\u30b9\u4e00\u89a7', \"'thread.res','DISP','LIST'\");\r\n\t\r\n\t# \u30ec\u30b9\u524a\u9664\u6a29\u9650\u306e\u307f\r\n\tif ($pSys->{'SECINFO'}->IsAuthority($pSys->{'USER'}, $ZP::AUTH_RESDELETE, $bbs)){\r\n\t\t$Base->SetMenu('\u30ec\u30b9\u4e00\u62ec\u524a\u9664', \"'thread.res','DISP','DELLUMP'\");\r\n\t}\r\n\t# \u7ba1\u7406\u30b0\u30eb\u30fc\u30d7\u6a29\u9650\u306e\u307f\r\n\tif ($pSys->{'SECINFO'}->IsAuthority($pSys->{'USER'}, $ZP::AUTH_USERGROUP, $bbs)){\r\n\t#\t$Base->SetMenu('<hr>', '');\r\n\t#\t$Base->SetMenu('\u66f8\u304d\u8fbc\u307f\u30ed\u30b0', \"'thread.res','DISP','LOG_THREAD_WRITE'\");\r\n\t}\r\n\t$Base->SetMenu('<hr>', '');\r\n\t$Base->SetMenu('\u63b2\u793a\u677f\u7ba1\u7406\u3078\u623b\u308b', \"'bbs.thread','DISP','LIST'\");\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\u30ec\u30b9\u4e00\u89a7\u306e\u8868\u793a\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Page\t\u30da\u30fc\u30b8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\r\n#\t@param\t$SYS\t\u30b7\u30b9\u30c6\u30e0\u5909\u6570\r\n#\t@param\t$Form\t\u30d5\u30a9\u30fc\u30e0\u5909\u6570\r\n#\t@param\t$Dat\tdat\u5909\u6570\r\n#\t@return\t\u306a\u3057\r\n#\r\n#\t2010.08.12 windyakin \u2605\r\n#\t -> \u30c7\u30d5\u30a9\u30eb\u30c8\u8868\u793a\u6700\u65b0\uff11\uff10\u306b\u5909\u66f4\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub PrintResList\r\n{\r\n\tmy ($Page, $Sys, $Form, $Dat,$Logger) = @_;\r\n\tmy (@elem, $resNum, $dispNum, $dispSt, $dispEd, $common, $i);\r\n\tmy ($pRes, $isAbone, $isEdit, $isAccessUser, $format);\r\n\tmy ($log, @logs, $lastnum, $logsize);\r\n\t\r\n\t$Sys->Set('_TITLE', 'Res List');\r\n\t\r\n\t# \u8868\u793a\u66f8\u5f0f\u306e\u8a2d\u5b9a\r\n\t$format = $Form->Get('DISP_FORMAT') eq '' ? 'l10' : $Form->Get('DISP_FORMAT');\r\n\t($dispSt, $dispEd) = AnalyzeFormat($format, $Dat);\r\n\t\r\n\t$common = \"DoSubmit('thread.res','DISP','LIST');\";\r\n\t\r\n\t$Page->Print(\"<center><dl><table border=0 cellspacing=2 width=100%>\");\r\n\t$Page->Print(\"<tr><td colspan=2 align=right>\u8868\\\u793a\u66f8\u5f0f\uff1a<input type=text name=DISP_FORMAT\");\r\n\t$Page->Print(\" value=\\\"$format\\\"><input type=button value=\\\"\u3000\u8868\\\u793a\u3000\\\" onclick=\\\"$common\\\">\");\r\n\t$Page->Print(\"</td></tr>\\n<tr><td colspan=2><hr></td></tr>\\n\");\r\n\t$Page->Print(\"<tr><th style=\\\"width:30\\\">\u3000</th>\");\r\n\t$Page->Print(\"<td class=\\\"DetailTitle\\\" style=\\\"width:300\\\">Contents</td></tr>\\n\");\r\n\t\r\n\t# \u6a29\u9650\u53d6\u5f97\r\n\t$isAbone = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'}, $ZP::AUTH_RESDELETE, $Sys->Get('BBS'));\r\n\t$isEdit = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'}, $ZP::AUTH_RESEDIT, $Sys->Get('BBS'));\r\n\t$isAccessUser = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'}, $ZP::AUTH_ACCESUSER, $Sys->Get('BBS'));\r\n\t\r\n\t$lastnum = $Dat->Size() - 1;\r\n\t$logsize = $Logger->Size();\r\n\t\r\n\t$lastnum -= 1 if ($Dat->IsStopped($Sys));\r\n\t\r\n\t# \u30ec\u30b9\u4e00\u89a7\u3092\u51fa\u529b\r\n\tfor ($i = $dispSt ; $i < $dispEd ; $i++) {\r\n\t\t$pRes\t= $Dat->Get($i);\r\n\t\t@elem\t= split(/<>/, $$pRes);\r\n\t\t$log = $Logger->Get($logsize - 1 + $i - $lastnum);\r\n\t\t@logs\t= split(/<>/,$log,-1) if (defined $log);\r\n\t\t\r\n\t\tforeach (0 .. $#logs) {\r\n\t\t\t$logs[$_] =~ s/[\\x0d\\x0a\\0]//g;\r\n\t\t\t$logs[$_] =~ s/&/&amp;/g;\r\n\t\t\t$logs[$_] =~ s/\"/&quot;/g;\r\n\t\t\t$logs[$_] =~ s/'/&#39;/g;\r\n\t\t\t$logs[$_] =~ s/</&lt;/g;\r\n\t\t\t$logs[$_] =~ s/>/&gt;/g;\r\n\t\t}\r\n\t\t\r\n\t\t$Page->Print(\"<tr><td class=\\\"Response\\\" valign=top>\");\r\n\t\t\r\n\t\t# \u30ec\u30b9\u524a\u9664\u6a29\u306b\u3088\u308b\u8868\u793a\u6291\u5236\r\n\t\tif ($isAbone) {\r\n\t\t\t$Page->Print(\"<input type=checkbox name=RESS value=$i></td>\");\r\n\t\t}\r\n\t\telse {\r\n\t\t\t$Page->Print(\"</td>\");\r\n\t\t}\r\n\t\t$Page->Print(\"<td class=\\\"Response\\\"><dt>\");\r\n\t\t\r\n\t\t# \u30ec\u30b9\u7de8\u96c6\u6a29\u306b\u3088\u308b\u8868\u793a\u6291\u5236\r\n\t\tif ($isEdit) {\r\n\t\t\t$common = \"\\\"javascript:SetOption('SELECT_RES','$i');\";\r\n\t\t\t$common = $common . \"DoSubmit('thread.res','DISP','EDIT')\\\"\";\r\n\t\t\t$Page->Print(\"<a href=$common>\" . ($i + 1) . \"</a>\");\r\n\t\t}\r\n\t\telse {\r\n\t\t\t$Page->Print('' . ($i + 1));\r\n\t\t}\r\n\t\t$Page->Print(\"\uff1a<font color=forestgreen><b>$elem[0]</b></font>[$elem[1]]\");\r\n\t\t$Page->Print(\"\uff1a$elem[2]</dt><dd>$elem[3]\");\r\n\t\t$Page->Print(\"<br><br><hr>HOST:$logs[5]<br>IP:$logs[6]<br>UA:$logs[8]\") if (defined $log && $isAccessUser);\r\n\t\t$Page->Print(\"</dd></td></tr>\\n\");\r\n\t}\r\n\t$Page->HTMLInput('hidden', 'SELECT_RES', '');\r\n\t$Page->Print(\"<tr><td colspan=2><hr></td></tr>\\n\");\r\n\t\r\n\t# \u30b7\u30b9\u30c6\u30e0\u6a29\u9650\u6709\u7121\u306b\u3088\u308b\u8868\u793a\u6291\u5236\r\n\tif ($isAbone) {\r\n\t\t$common = \"onclick=\\\"DoSubmit('thread.res','DISP'\";\r\n\t\t$Page->Print(\"<tr><td colspan=2 align=right>\");\r\n\t\t$Page->Print(\"<input type=button value=\\\"\u3042\u307c\u301c\u3093\\\" $common,'ABONE')\\\"> \");\r\n\t\t$Page->Print(\"<input type=button value=\\\"\u900f\u660e\u3042\u307c\u301c\u3093\\\" $common,'DELETE')\\\">\");\r\n\t\t$Page->Print(\"</td></tr>\\n\");\r\n\t}\r\n\t$Page->Print(\"</table></dl><br>\");\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\u30ec\u30b9\u7de8\u96c6\u753b\u9762\u306e\u8868\u793a\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Page\t\u30da\u30fc\u30b8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\r\n#\t@param\t$SYS\t\u30b7\u30b9\u30c6\u30e0\u5909\u6570\r\n#\t@param\t$Form\t\u30d5\u30a9\u30fc\u30e0\u5909\u6570\r\n#\t@param\t$Dat\tdat\u5909\u6570\r\n#\t@return\t\u306a\u3057\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub PrintResEdit\r\n{\r\n\tmy ($Page, $Sys, $Form, $Dat) = @_;\r\n\tmy (@elem, $pRes, $isEdit, $common);\r\n\t\r\n\t$Sys->Set('_TITLE', 'Res Edit');\r\n\t\r\n\t$isEdit = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'}, $ZP::AUTH_RESEDIT, $Sys->Get('BBS'));\r\n\t$pRes\t= $Dat->Get($Form->Get('SELECT_RES'));\r\n\t@elem\t= split(/<>/, $$pRes);\r\n\t\r\n\t$elem[3] =~ s/^ //;\r\n\t$elem[3] =~ s/ $//;\r\n\t$elem[3] =~ s/ ?<br> ?/\\n/g;\r\n\tforeach (0 .. 3) {\r\n\t\t$elem[$_] =~ s/&/&amp;/g;\r\n\t\t$elem[$_] =~ s/\"/&quot;/g;\r\n\t\t$elem[$_] =~ s/</&lt;/g;\r\n\t\t$elem[$_] =~ s/>/&gt;/g;\r\n\t}\r\n\t\r\n\t$Page->Print(\"<center><table border=0 cellspacing=2 width=100%>\");\r\n\t$Page->Print(\"<tr><td colspan=2><hr></td></tr>\");\r\n\t$Page->Print(\"<tr><td class=\\\"DetailTitle\\\">\u540d\u524d</td><td>\");\r\n\t$Page->Print(\"<input type=text size=50 value=\\\"$elem[0]\\\" name=FROM></td></tr>\");\r\n\t$Page->Print(\"<tr><td class=\\\"DetailTitle\\\">\u30e1\u30fc\u30eb</td><td>\");\r\n\t$Page->Print(\"<input type=text size=50 value=\\\"$elem[1]\\\" name=mail></td></tr>\");\r\n\t$Page->Print(\"<tr><td class=\\\"DetailTitle\\\">\u65e5\u4ed8\u30fbID</td><td>\");\r\n\t$Page->Print(\"<input type=text size=50 value=\\\"$elem[2]\\\" name=_DATE_></td></tr>\");\r\n\t$Page->Print(\"<tr><td class=\\\"DetailTitle\\\">\u672c\u6587</td><td>\");\r\n\t$Page->Print(\"<textarea name=MESSAGE cols=70 rows=10>$elem[3]</textarea></td></tr>\");\r\n\t$Page->Print(\"<tr><td colspan=2><hr></td></tr>\");\r\n\t\r\n\t$Page->HTMLInput('hidden', 'SELECT_RES', $Form->Get('SELECT_RES'));\r\n\t\r\n\t# \u30b7\u30b9\u30c6\u30e0\u6a29\u9650\u6709\u7121\u306b\u3088\u308b\u8868\u793a\u6291\u5236\r\n\tif ($isEdit) {\r\n\t\t$common = \"onclick=\\\"DoSubmit('thread.res','FUNC'\";\r\n\t\t$Page->Print(\"<tr><td colspan=2 align=right>\");\r\n\t\t$Page->Print(\"<input type=button value=\\\"\u3000\u5909\u66f4\u3000\\\" $common,'EDIT')\\\"> \");\r\n\t\t$Page->Print(\"</td></tr>\\n\");\r\n\t}\r\n\t$Page->Print(\"</table><br>\");\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\u30ec\u30b9\u524a\u9664\u78ba\u8a8d\u306e\u8868\u793a\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Page\t\u30da\u30fc\u30b8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\r\n#\t@param\t$SYS\t\u30b7\u30b9\u30c6\u30e0\u5909\u6570\r\n#\t@param\t$Form\t\u30d5\u30a9\u30fc\u30e0\u5909\u6570\r\n#\t@param\t$Dat\tdat\u5909\u6570\r\n#\t@return\t\u306a\u3057\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub PrintResDelete\r\n{\r\n\tmy ($Page, $Sys, $Form, $Dat, $mode) = @_;\r\n\tmy (@resSet, @elem, $pRes, $num, $common, $isAbone);\r\n\t\r\n\t$Sys->Set('_TITLE', 'Res Delete Confirm');\r\n\t\r\n\t# \u9078\u629e\u30ec\u30b9\u3092\u53d6\u5f97\r\n\t@resSet = $Form->GetAtArray('RESS');\r\n\t\r\n\t# \u6a29\u9650\u53d6\u5f97\r\n\t$isAbone = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'}, $ZP::AUTH_RESDELETE, $Sys->Get('BBS'));\r\n\t\r\n\t$Page->Print(\"<center><dl><table border=0 cellspacing=2 width=100%>\");\r\n\t$Page->Print(\"<tr><td>\u4ee5\u4e0b\u306e\u30ec\u30b9\u3092\" . ($mode ? '\u3042\u307c\u301c\u3093' : '\u524a\u9664') . \"\u3057\u307e\u3059\u3002</td></tr>\\n\");\r\n\t$Page->Print(\"<tr><td><hr></td></tr>\\n\");\r\n\t$Page->Print(\"<tr><td class=\\\"DetailTitle\\\">Contents</td></tr>\\n\");\r\n\t\r\n\t# \u30ec\u30b9\u4e00\u89a7\u3092\u51fa\u529b\r\n\tforeach $num (@resSet) {\r\n\t\t$pRes\t= $Dat->Get($num);\r\n\t\t@elem\t= split(/<>/, $$pRes);\r\n\t\t\r\n\t\t$Page->Print(\"<tr><td class=\\\"Response\\\"><dt>\" . ($num + 1));\r\n\t\t$Page->Print(\"\uff1a<font color=forestgreen><b>$elem[0]</b></font>[$elem[1]]\");\r\n\t\t$Page->Print(\"\uff1a$elem[2]</dt><dd>$elem[3]<br><br></dd></td></tr>\\n\");\r\n\t\t$Page->HTMLInput('hidden', 'RESS', $num);\r\n\t}\r\n\t$Page->Print(\"<tr><td><hr></td></tr>\\n\");\r\n\t\r\n\t# \u30b7\u30b9\u30c6\u30e0\u6a29\u9650\u6709\u7121\u306b\u3088\u308b\u8868\u793a\u6291\u5236\r\n\tif ($isAbone) {\r\n\t\t$common = \"onclick=\\\"DoSubmit('thread.res','FUNC','\";\r\n\t\t$common = $common . ($mode ? 'ABONE' : 'DELETE') . \"')\\\"\";\r\n\t\t$Page->Print(\"<tr><td align=right>\");\r\n\t\t$Page->Print(\"<input type=button value=\\\"\u3000\u5b9f\u884c\u3000\\\" $common> \");\r\n\t\t$Page->Print(\"</td></tr>\\n\");\r\n\t}\r\n\t$Page->Print(\"</table></dl><br>\");\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\u30ec\u30b9\u4e00\u62ec\u524a\u9664\u306e\u8868\u793a\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Page\t\u30da\u30fc\u30b8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\r\n#\t@param\t$SYS\t\u30b7\u30b9\u30c6\u30e0\u5909\u6570\r\n#\t@param\t$Form\t\u30d5\u30a9\u30fc\u30e0\u5909\u6570\r\n#\t@param\t$Dat\tdat\u5909\u6570\r\n#\t@return\t\u306a\u3057\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub PrintResLumpDelete\r\n{\r\n\tmy ($Page, $Sys, $Form, $Dat) = @_;\r\n\tmy (@resSet, @elem, $pRes, $format, $num, $common, $isAbone);\r\n\t\r\n\t$Sys->Set('_TITLE', 'Res Lump Delete');\r\n\t\r\n\t# \u66f8\u5f0f\u306e\u89e3\u6790\r\n\t$num = 0;\r\n\t$format = $Form->Get('DEL_FORMAT');\r\n\tif ($format ne '') {\r\n\t\tAnalyzeDeleteFormat($format, $Dat, \\@resSet);\r\n\t\t$num = @resSet;\r\n\t}\r\n\t\r\n\t# \u6a29\u9650\u53d6\u5f97\r\n\t$isAbone = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'}, $ZP::AUTH_RESDELETE, $Sys->Get('BBS'));\r\n\t\r\n\t$Page->Print(\"<center><dl><table border=0 cellspacing=2 width=100%>\");\r\n\t$Page->Print(\"<tr><td colspan=2><hr></td></tr>\\n\");\r\n\t$Page->Print(\"<tr><td class=\\\"DetailTitle\\\">\u524a\u9664\u30ec\u30b9\u66f8\u5f0f</td><td>\");\r\n\t$Page->Print(\"<input type=text name=DEL_FORMAT size=40 value=$format></td></tr>\\n\");\r\n\t$Page->Print(\"<tr><td colspan=2><hr></td></tr>\\n\");\r\n\t\r\n\tif ($num > 0) {\r\n\t\t$Page->Print(\"<tr><td colspan=2 class=\\\"DetailTitle\\\">Delete Contents</td></tr>\");\r\n\t\t\r\n\t\t# \u30ec\u30b9\u4e00\u89a7\u3092\u51fa\u529b\r\n\t\tforeach $num (@resSet) {\r\n\t\t\t$pRes\t= $Dat->Get($num);\r\n\t\t\t@elem\t= split(/<>/, $$pRes);\r\n\t\t\t\r\n\t\t\t$Page->Print(\"<tr><td colspan=2 class=\\\"Response\\\"><dt>\" . ($num + 1));\r\n\t\t\t$Page->Print(\"\uff1a<font color=forestgreen><b>$elem[0]</b></font>[$elem[1]]\");\r\n\t\t\t$Page->Print(\"\uff1a$elem[2]</dt><dd>$elem[3]<br><br></dd></td></tr>\\n\");\r\n\t\t\t$Page->HTMLInput('hidden', 'RESS', $num);\r\n\t\t}\r\n\t\t$Page->Print(\"<tr><td colspan=2><hr></td></tr>\\n\");\r\n\t}\r\n\t\r\n\t# \u30b7\u30b9\u30c6\u30e0\u6a29\u9650\u6709\u7121\u306b\u3088\u308b\u8868\u793a\u6291\u5236\r\n\tif ($isAbone) {\r\n\t\t$common = \"onclick=\\\"DoSubmit('thread.res'\";\r\n\t\t$Page->Print(\"<tr><td align=right colspan=2>\");\r\n\t\t$Page->Print(\"<input type=button value=\\\"\u3000\u78ba\u8a8d\u3000\\\" $common,'DISP','DELLUMP')\\\" style=\\\"float: left;\\\"> \");\r\n\t\t$Page->Print(\"<input type=button value=\\\"\u3042\u307c\u301c\u3093\\\" $common,'FUNC','ABONE')\\\"> \");\r\n\t\t$Page->Print(\"<input type=button value=\\\"\u900f\u660e\u3042\u307c\u301c\u3093\\\" $common,'FUNC','DELETE')\\\"> \");\r\n\t\t$Page->Print(\"</td></tr>\\n\");\r\n\t}\r\n\t$Page->Print(\"</table></dl><br>\");\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\u30ec\u30b9\u7de8\u96c6\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Sys\t\u30b7\u30b9\u30c6\u30e0\u5909\u6570\r\n#\t@param\t$Form\t\u30d5\u30a9\u30fc\u30e0\u5909\u6570\r\n#\t@param\t$Dat\tDat\u5909\u6570\r\n#\t@param\t$pLog\t\u30ed\u30b0\u7528\r\n#\t@return\t\u30a8\u30e9\u30fc\u30b3\u30fc\u30c9\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub FunctionResEdit\r\n{\r\n\tmy ($Sys, $Form, $Dat, $pLog) = @_;\r\n\tmy (@elem, $pRes, $data);\r\n\t\r\n\t# \u6a29\u9650\u30c1\u30a7\u30c3\u30af\r\n\t{\r\n\t\tmy $SEC = $Sys->Get('ADMIN')->{'SECINFO'};\r\n\t\tmy $chkID = $Sys->Get('ADMIN')->{'USER'};\r\n\t\t\r\n\t\tif (($SEC->IsAuthority($chkID, $ZP::AUTH_RESEDIT, $Sys->Get('BBS'))) == 0) {\r\n\t\t\treturn 1000;\r\n\t\t}\r\n\t}\r\n\t\r\n\t# \u66f8\u304d\u8fbc\u307f\u30e2\u30fc\u30c9\u3067\u8aad\u307f\u76f4\u3059\r\n\t$Dat->ReLoad($Sys, 0);\r\n\t\r\n\t$pRes = $Dat->Get($Form->Get('SELECT_RES'));\r\n\t@elem = split(/<>/, $$pRes);\r\n\t$elem[0] = $Form->Get('FROM');\r\n\t$elem[1] = $Form->Get('mail');\r\n\t$elem[2] = $Form->Get('_DATE_');\r\n\t$elem[3] = $Form->Get('MESSAGE');\r\n\t\r\n\t# \u6539\u884c\u30fb\u7981\u5247\u6587\u5b57\u306e\u5909\u63db\r\n\t$elem[3] =~ s/\\r\\n|\\r|\\n/ <br> /g;\r\n\t$elem[3] =~ s/<>/&lt;&gt;/g;\r\n\t$elem[3] = \" $elem[3] \";\r\n\t\r\n\t# \u30c7\u30fc\u30bf\u306e\u9023\u7d50\r\n\t$data = join('<>', @elem);\r\n\t\r\n\t# \u30c7\u30fc\u30bf\u306e\u8a2d\u5b9a\u3068\u4fdd\u5b58\r\n\t$Dat->Set($Form->Get('SELECT_RES'), $data);\r\n\t$Dat->Save($Sys);\r\n\t\r\n\t# \u30ed\u30b0\u306e\u8a2d\u5b9a\r\n\tpush @$pLog, '\u756a\u53f7[' . $Form->Get('SELECT_RES') . ']\u306e\u30ec\u30b9\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3057\u305f\u3002';\r\n\tforeach (@elem) {\r\n\t\tpush @$pLog, $_;\r\n\t}\r\n\t\r\n\treturn 0;\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\u30ec\u30b9\u524a\u9664\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$Sys\t\u30b7\u30b9\u30c6\u30e0\u5909\u6570\r\n#\t@param\t$Form\t\u30d5\u30a9\u30fc\u30e0\u5909\u6570\r\n#\t@param\t$Dat\tDat\u5909\u6570\r\n#\t@param\t$pLog\t\u30ed\u30b0\u7528\r\n#\t@return\t\u30a8\u30e9\u30fc\u30b3\u30fc\u30c9\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub FunctionResDelete\r\n{\r\n\tmy ($Sys, $Form, $Dat, $pLog, $mode) = @_;\r\n\tmy (@resSet, $pRes, $abone, $path, $tm, $user, $delCnt, $num, $datPath, $LOG, $logsize, $lastnum);\r\n\t\r\n\t# \u6a29\u9650\u30c1\u30a7\u30c3\u30af\r\n\t{\r\n\t\tmy $SEC\t= $Sys->Get('ADMIN')->{'SECINFO'};\r\n\t\tmy $chkID\t= $Sys->Get('ADMIN')->{'USER'};\r\n\t\t\r\n\t\tif (($SEC->IsAuthority($chkID, $ZP::AUTH_RESDELETE, $Sys->Get('BBS'))) == 0) {\r\n\t\t\treturn 1000;\r\n\t\t}\r\n\t}\r\n\t\r\n\t# \u3042\u307c\u301c\u3093\u6642\u306f\u524a\u9664\u540d\u3092\u53d6\u5f97\r\n\tif ($mode) {\r\n\t\tmy $Setting;\r\n\t\trequire './module/isildur.pl';\r\n\t\t$Setting = ISILDUR->new;\r\n\t\t$Setting->Load($Sys);\r\n\t\t$abone\t= $Setting->Get('BBS_DELETE_NAME');\r\n\t}\r\n\telse {\r\n\t\trequire './module/peregrin.pl';\r\n\t\t$LOG = PEREGRIN->new;\r\n\t\t$LOG->Load($Sys, 'WRT', $Sys->Get('KEY'));\r\n\t\t$logsize = $LOG->Size();\r\n\t\t$lastnum = $Dat->Size() - 1;\r\n\t}\r\n\t\r\n\t# \u5404\u5024\u3092\u8a2d\u5b9a\r\n\t@resSet\t= $Form->GetAtArray('RESS');\r\n\t$datPath= $Sys->Get('BBSPATH') . '/' . $Sys->Get('BBS') . '/dat/' . $Sys->Get('KEY') . '.dat';\r\n\t$path\t= $Sys->Get('BBSPATH') . '/' . $Sys->Get('BBS') . '/log/del_' . $Sys->Get('KEY') . '.cgi';\r\n\t$tm\t\t= time;\r\n\t$user\t= $Form->Get('UserName');\r\n\t$delCnt\t= 0;\r\n\t\r\n\t# dat\u3092\u66f8\u304d\u8fbc\u307f\u30e2\u30fc\u30c9\u3067\u8aad\u307f\u76f4\u3059\r\n\t$Dat->Close();\r\n\t$Dat->Load($Sys, $datPath, 0);\r\n\t\r\n\t# \u524a\u9664\u3068\u540c\u6642\u306b\u524a\u9664\u30ed\u30b0\u3078\u524a\u9664\u3057\u305f\u5185\u5bb9\u3092\u4fdd\u5b58\u3059\u308b\r\n\tif (open(my $f_dellog, '>>', $path)) {\r\n\t\tflock($f_dellog, 2);\r\n\t\tbinmode($f_dellog);\r\n\t\tforeach $num (sort @resSet) {\r\n\t\t\tnext if ($num == 0);\r\n\t\t\t$pRes = $Dat->Get($num - $delCnt);\r\n\t\t\tprint $f_dellog \"$tm<>$user<>$num<>$mode<>$$pRes\";\r\n\t\t\tif ($mode) {\r\n\t\t\t\t$Dat->Set($num, \"$abone<>$abone<>$abone<>$abone<>$abone\\n\");\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\t$Dat->Delete($num - $delCnt);\r\n\t\t\t\t$LOG->Delete($logsize - 1 + ($num - $delCnt) - $lastnum);\r\n\t\t\t\t$delCnt ++;\r\n\t\t\t\t$logsize --;\r\n\t\t\t\t$lastnum --;\r\n\t\t\t}\r\n\t\t}\r\n\t\tclose($f_dellog);\r\n\t\tchmod($Sys->Get('PM-LOG'), $path);\r\n\t\t\r\n\t\t# \u4fdd\u5b58\r\n\t\t$Dat->Save($Sys);\r\n\t\t$LOG->Save($Sys) if (! $mode);\r\n\t}\r\n\t\r\n\t# \u30ed\u30b0\u306e\u8a2d\u5b9a\r\n\t$delCnt = 0;\r\n\t$abone\t= '';\r\n\tpush @$pLog, '\u4ee5\u4e0b\u306e\u30ec\u30b9\u3092' . ($mode ? '\u3042\u307c\u301c\u3093' : '\u524a\u9664') . '\u3057\u307e\u3057\u305f\u3002';\r\n\tforeach (@resSet) {\r\n\t\tnext if ($_ == 0);\r\n\t\tif ($delCnt > 5) {\r\n\t\t\tpush @$pLog, $abone;\r\n\t\t\t$abone = '';\r\n\t\t\t$delCnt = 0;\r\n\t\t}\r\n\t\telse {\r\n\t\t\t$abone .= ($_ + 1) . ', ';\r\n\t\t\t$delCnt ++;\r\n\t\t}\r\n\t}\r\n\tpush @$pLog, $abone;\r\n\t\r\n\treturn 0;\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\u524a\u9664\u66f8\u5f0f\u306e\u89e3\u6790\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$format\t\u66f8\u5f0f\u6587\u5b57\u5217\r\n#\t@param\t$Dat\tARAGORN\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\r\n#\t@param\t$pSet\t\u7d50\u679c\u683c\u7d0d\u914d\u5217\u306e\u53c2\u7167\r\n#\t@return\t\u306a\u3057\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub AnalyzeDeleteFormat\r\n{\r\n\tmy ($format, $Dat, $pSet) = @_;\r\n\tmy (%deleteTable, @elem, $i, $st, $ed);\r\n\t\r\n\t# \u30bb\u30d1\u30ec\u30fc\u30bf\u3067\u5206\u89e3\r\n\t@elem = split(/\\, /, $format);\r\n\t\r\n\t# 1\u533a\u5206\u305a\u3064\u66f8\u5f0f\u89e3\u6790\u3092\u3057\u3066\u30cf\u30c3\u30b7\u30e5(\u4e8c\u91cd\u767b\u9332\u9632\u6b62\u306e\u305f\u3081)\u306b\u683c\u7d0d\r\n\tforeach (@elem){\r\n\t\t($st, $ed) = AnalyzeFormat($_, $Dat);\r\n\t\tif ($st != 0 || $ed != 0) {\r\n\t\t\tfor ($i = $st ; $i < $ed ; $i++) {\r\n\t\t\t\t$deleteTable{$i} = 'true';\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\t# \u7d50\u679c\u3092\u914d\u5217\u306b\u8a2d\u5b9a\r\n\tforeach (sort {$a <=> $b} (keys %deleteTable)) {\r\n\t\tpush @$pSet, $_;\r\n\t}\r\n}\r\n\r\n#------------------------------------------------------------------------------------------------------------\r\n#\r\n#\t\u66f8\u5f0f\u306e\u89e3\u6790\r\n#\t-------------------------------------------------------------------------------------\r\n#\t@param\t$format\t\u66f8\u5f0f\u6587\u5b57\u5217\r\n#\t@param\t$Dat\tARAGORN\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\r\n#\t@return\t(\u958b\u59cb\u756a\u53f7, \u7d42\u4e86\u756a\u53f7)\r\n#\r\n#------------------------------------------------------------------------------------------------------------\r\nsub AnalyzeFormat\r\n{\r\n\tmy ($format, $Dat) = @_;\r\n\tmy ($start, $end, $max);\r\n\t\r\n\t# \u66f8\u5f0f\u30a8\u30e9\u30fc\r\n\tif ($format =~ /[^0-9\\-l]/ || $format eq '') {\r\n\t\treturn (0, 0);\r\n\t}\r\n\t$max = $Dat->Size();\r\n\t\r\n\t# \u6700\u65b0n\u4ef6\r\n\tif ($format =~ /l(\\d+)/) {\r\n\t\t$end\t= $max;\r\n\t\t$start\t= ($max - $1 + 1) > 0 ? ($max - $1 + 1) : 1;\r\n\t}\r\n\t# n\u301cm\r\n\telsif ($format =~ /(\\d+)-(\\d+)/) {\r\n\t\t$start\t= $1 > $max ? $max : $1;\r\n\t\t$end\t= $2 > $max ? $max : $2;\r\n\t}\r\n\t# n\u4ee5\u964d\u3059\u3079\u3066\r\n\telsif ($format =~ /(\\d+)-/) {\r\n\t\t$start\t= $1 > $max ? $max : $1;\r\n\t\t$end\t= $max;\r\n\t}\r\n\t# n\u4ee5\u524d\u3059\u3079\u3066\r\n\telsif ($format =~ /-(\\d+)/) {\r\n\t\t$start\t= 1;\r\n\t\t$end\t= $1 > $max ? $max : $1;\r\n\t}\r\n\t# n\u306e\u307f\r\n\telsif ($format =~ /(\\d+)/) {\r\n\t\t$start\t= $1 > $max ? $max : $1;\r\n\t\t$end\t= $1 > $max ? $max : $1;\r\n\t}\r\n\t\r\n\t# \u9806\u5e8f\u6b63\u898f\u5316\r\n\tif ($start > $end) {\r\n\t\t$max = $start;\r\n\t\t$start = $end;\r\n\t\t$end = $start;\r\n\t}\r\n\t\r\n\treturn ($start - 1, $end);\r\n}\r\n\r\n#============================================================================================================\r\n#\tModule END\r\n#============================================================================================================\r\n1;\r\n"], "filenames": ["test/mordor/thread.res.pl"], "buggy_code_start_loc": [3], "buggy_code_end_loc": [710], "fixing_code_start_loc": [3], "fixing_code_end_loc": [719], "type": "CWE-79", "message": "A vulnerability classified as problematic has been found in zerochplus. This affects the function PrintResList of the file test/mordor/thread.res.pl. The manipulation leads to cross site scripting. It is possible to initiate the attack remotely. The name of the patch is 9ddf9ecca8565341d8d26a3b2f64540bde4fa273. It is recommended to apply a patch to fix this issue. The associated identifier of this vulnerability is VDB-218007.", "other": {"cve": {"id": "CVE-2013-10010", "sourceIdentifier": "cna@vuldb.com", "published": "2023-01-11T16:15:09.510", "lastModified": "2023-01-19T02:27:08.037", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A vulnerability classified as problematic has been found in zerochplus. This affects the function PrintResList of the file test/mordor/thread.res.pl. The manipulation leads to cross site scripting. It is possible to initiate the attack remotely. The name of the patch is 9ddf9ecca8565341d8d26a3b2f64540bde4fa273. It is recommended to apply a patch to fix this issue. The associated identifier of this vulnerability is VDB-218007."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV30": [{"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 4.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 1.4}], "cvssMetricV2": [{"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 5.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 10.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "cna@vuldb.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:zerochplus_project:zerochplus:*:*:*:*:*:*:*:*", "versionEndExcluding": "2013-04-30", "matchCriteriaId": "1FBBCE47-8C82-42D1-9916-B0940216CC89"}]}]}], "references": [{"url": "https://github.com/zerochplus/zerochplus/commit/9ddf9ecca8565341d8d26a3b2f64540bde4fa273", "source": "cna@vuldb.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://vuldb.com/?ctiid.218007", "source": "cna@vuldb.com", "tags": ["Permissions Required", "Third Party Advisory"]}, {"url": "https://vuldb.com/?id.218007", "source": "cna@vuldb.com", "tags": ["Permissions Required", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/zerochplus/zerochplus/commit/9ddf9ecca8565341d8d26a3b2f64540bde4fa273"}}