{"buggy_code": ["<?php\r\n/*\r\n\tFusionPBX\r\n\tVersion: MPL 1.1\r\n\r\n\tThe contents of this file are subject to the Mozilla Public License Version\r\n\t1.1 (the \"License\"); you may not use this file except in compliance with\r\n\tthe License. You may obtain a copy of the License at\r\n\thttp://www.mozilla.org/MPL/\r\n\r\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\r\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\r\n\tfor the specific language governing rights and limitations under the\r\n\tLicense.\r\n\r\n\tThe Original Code is FusionPBX\r\n\r\n\tThe Initial Developer of the Original Code is\r\n\tMark J Crane <markjcrane@fusionpbx.com>\r\n\tPortions created by the Initial Developer are Copyright (C) 2018 - 2019\r\n\tthe Initial Developer. All Rights Reserved.\r\n\r\n\tContributor(s):\r\n\tMark J Crane <markjcrane@fusionpbx.com>\r\n*/\r\n\r\n//includes\r\n\tinclude \"root.php\";\r\n\trequire_once \"resources/require.php\";\r\n\trequire_once \"resources/check_auth.php\";\r\n\r\n//check permissions\r\n\tif (permission_exists('destination_import')) {\r\n\t\t//access granted\r\n\t}\r\n\telse {\r\n\t\techo \"access denied\";\r\n\t\texit;\r\n\t}\r\n\r\n//add multi-lingual support\r\n\t$language = new text;\r\n\t$text = $language->get();\r\n\r\n//built in str_getcsv requires PHP 5.3 or higher, this function can be used to reproduct the functionality but requirs PHP 5.1.0 or higher\r\n\tif(!function_exists('str_getcsv')) {\r\n\t\tfunction str_getcsv($input, $delimiter = \",\", $enclosure = '\"', $escape = \"\\\\\") {\r\n\t\t\t$fp = fopen(\"php://memory\", 'r+');\r\n\t\t\tfputs($fp, $input);\r\n\t\t\trewind($fp);\r\n\t\t\t$data = fgetcsv($fp, null, $delimiter, $enclosure); // $escape only got added in 5.3.0\r\n\t\t\tfclose($fp);\r\n\t\t\treturn $data;\r\n\t\t}\r\n\t}\r\n\r\n//set the max php execution time\r\n\tini_set(max_execution_time,7200);\r\n\r\n//get the http get values and set them as php variables\r\n\t$action = $_POST[\"action\"];\r\n\t$order_by = $_POST[\"order_by\"];\r\n\t$order = $_POST[\"order\"];\r\n\t$from_row = $_POST[\"from_row\"];\r\n\t$delimiter = $_POST[\"data_delimiter\"];\r\n\t$enclosure = $_POST[\"data_enclosure\"];\r\n\t$destination_type = $_POST[\"destination_type\"];\r\n\t$destination_action = $_POST[\"destination_action\"];\r\n\t$destination_context = $_POST[\"destination_context\"];\r\n\t$destination_record = $_POST[\"destination_record\"];\r\n\r\n//set the defaults\r\n\tif (strlen($destination_type) == 0) { $destination_type = 'inbound'; }\r\n\tif (strlen($destination_context) == 0) { $destination_context = 'public'; }\r\n\tif ($destination_type ==\"outbound\" && $destination_context == \"public\") { $destination_context = $_SESSION['domain_name']; }\r\n\tif ($destination_type ==\"outbound\" && strlen($destination_context) == 0) { $destination_context = $_SESSION['domain_name']; }\r\n\r\n//save the data to the csv file\r\n\tif (isset($_POST['data'])) {\r\n\t\t$file = $_SESSION['server']['temp']['dir'].\"/destinations-\".$_SESSION['domain_name'].\".csv\";\r\n\t\tfile_put_contents($file, $_POST['data']);\r\n\t\t$_SESSION['file'] = $file;\r\n\t}\r\n\r\n//copy the csv file\r\n\t//$_POST['submit'] == \"Upload\" &&\r\n\tif ( is_uploaded_file($_FILES['ulfile']['tmp_name']) && permission_exists('destination_upload')) {\r\n\t\tif ($_POST['type'] == 'csv') {\r\n\t\t\tmove_uploaded_file($_FILES['ulfile']['tmp_name'], $_SESSION['server']['temp']['dir'].'/'.$_FILES['ulfile']['name']);\r\n\t\t\t$save_msg = \"Uploaded file to \".$_SESSION['server']['temp']['dir'].\"/\". htmlentities($_FILES['ulfile']['name']);\r\n\t\t\t//system('chmod -R 744 '.$_SESSION['server']['temp']['dir'].'*');\r\n\t\t\tunset($_POST['txtCommand']);\r\n\t\t\t$file = $_SESSION['server']['temp']['dir'].'/'.$_FILES['ulfile']['name'];\r\n\t\t\t$_SESSION['file'] = $file;\r\n\t\t}\r\n\t}\r\n\r\n//get the schema\r\n\tif (strlen($delimiter) > 0) {\r\n\t\t//get the first line\r\n\t\t\t$line = fgets(fopen($_SESSION['file'], 'r'));\r\n\t\t\t$line_fields = explode($delimiter, $line);\r\n\r\n\t\t//get the schema\r\n\t\t\t$x = 0;\r\n\t\t\tinclude (\"app/destinations/app_config.php\");\r\n\t\t\t$i = 0;\r\n\t\t\tforeach($apps[0]['db'] as $table) {\r\n\t\t\t\t//get the table name and parent name\r\n\t\t\t\t$table_name = $table[\"table\"]['name'];\r\n\t\t\t\t$parent_name = $table[\"table\"]['parent'];\r\n\r\n\t\t\t\t//remove the v_ table prefix\r\n\t\t\t\tif (substr($table_name, 0, 2) == 'v_') {\r\n\t\t\t\t\t$table_name = substr($table_name, 2);\r\n\t\t\t\t}\r\n\t\t\t\tif (substr($parent_name, 0, 2) == 'v_') {\r\n\t\t\t\t\t$parent_name = substr($parent_name, 2);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//filter for specific tables and build the schema array\r\n\t\t\t\tif ($table_name == \"destinations\") {\r\n\t\t\t\t\t$schema[$i]['table'] = $table_name;\r\n\t\t\t\t\t$schema[$i]['parent'] = $parent_name;\r\n\t\t\t\t\tforeach($table['fields'] as $row) {\r\n\t\t\t\t\t\tif ($row['deprecated'] !== 'true') {\r\n\t\t\t\t\t\t\tif (is_array($row['name'])) {\r\n\t\t\t\t\t\t\t\t$field_name = $row['name']['text'];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t$field_name = $row['name'];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t$schema[$i]['fields'][] = $field_name;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t$i++;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t}\r\n\r\n//get the parent table\r\n\tfunction get_parent($schema,$table_name) {\r\n\t\tforeach ($schema as $row) {\r\n\t\t\tif ($row['table'] == $table_name) {\r\n\t\t\t\treturn $row['parent'];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n//upload the destination csv\r\n\tif (file_exists($_SESSION['file']) && $action == 'add') {\r\n\r\n\t\t//form to match the fields to the column names\r\n\t\t\t//require_once \"resources/header.php\";\r\n\r\n\t\t//user selected fields\r\n\t\t\t$fields = $_POST['fields'];\r\n\t\t\t$domain_uuid = $_POST['domain_uuid'];\r\n\t\t\t$destination_record = $_POST['destination_record'];\r\n\t\t\t$destination_type = $_POST['destination_type'];\r\n\t\t\t$destination_context = $_POST['destination_context'];\r\n\t\t\t$destination_enabled = $_POST['destination_enabled'];\r\n\r\n\t\t//set the domain_uuid\r\n\t\t\t$domain_uuid = $_SESSION['domain_uuid'];\r\n\r\n\t\t//get the contents of the csv file and convert them into an array\r\n\t\t\t$handle = @fopen($_SESSION['file'], \"r\");\r\n\t\t\tif ($handle) {\r\n\t\t\t\t//pre-set the numbers\r\n\t\t\t\t\t$row_id = 0;\r\n\t\t\t\t\t$row_number = 1;\r\n\r\n\t\t\t\t//loop through the array\r\n\t\t\t\t\twhile (($line = fgets($handle, 4096)) !== false) {\r\n\t\t\t\t\t\tif ($from_row <= $row_number) {\r\n\t\t\t\t\t\t\t//format the data\r\n\t\t\t\t\t\t\t\t$y = 0;\r\n\t\t\t\t\t\t\t\tforeach ($fields as $key => $value) {\r\n\t\t\t\t\t\t\t\t\t//get the line\r\n\t\t\t\t\t\t\t\t\t$result = str_getcsv($line, $delimiter, $enclosure);\r\n\r\n\t\t\t\t\t\t\t\t\t//get the table and field name\r\n\t\t\t\t\t\t\t\t\t$field_array = explode(\".\",$value);\r\n\t\t\t\t\t\t\t\t\t$table_name = $field_array[0];\r\n\t\t\t\t\t\t\t\t\t$field_name = $field_array[1];\r\n\t\t\t\t\t\t\t\t\t//echo \"value: $value<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t//echo \"table_name: $table_name<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t//echo \"field_name: $field_name<br />\\n\";\r\n\r\n\t\t\t\t\t\t\t\t\t//get the parent table name\r\n\t\t\t\t\t\t\t\t\t$parent = get_parent($schema, $table_name);\r\n\r\n\t\t\t\t\t\t\t\t\t//remove formatting from the phone number\r\n\t\t\t\t\t\t\t\t\tif ($field_name == \"phone_number\") {\r\n\t\t\t\t\t\t\t\t\t\t$result[$key] = preg_replace('{\\D}', '', $result[$key]);\r\n\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t//build the data array\r\n\t\t\t\t\t\t\t\t\tif (strlen($table_name) > 0) {\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($parent) == 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$table_name][$row_id]['domain_uuid'] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$table_name][$row_id][$field_name] = $result[$key];\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$parent][$row_id][$table_name][$y]['domain_uuid'] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$parent][$row_id][$table_name][$y][$field_name] = $result[$key];\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t//get the destination_number\r\n\t\t\t\t\t\t\t\t\tif ($key === 'destination_number') { $destination_number = $result[$key]; }\r\n\t\t\t\t\t\t\t\t\tif ($key === 'destination_description') { $destination_description = $result[$key]; }\r\n\t\t\t\t\t\t\t\t\tif ($key === 'destination_app') { $destination_app = $result[$key]; echo \"destination_app $destination_app\\n\"; }\r\n\t\t\t\t\t\t\t\t\tif ($key === 'destination_data') { $destination_data = $result[$key]; echo \"destination_data $destination_data\\n\"; }\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t//add the actions\r\n\t\t\t\t\t\t\t\tforeach ($array['destinations'] as $row) {\r\n\r\n\t\t\t\t\t\t\t\t\t//get the values\r\n\t\t\t\t\t\t\t\t\t\t$destination_number = $row['destination_number'];\r\n\t\t\t\t\t\t\t\t\t\t$destination_app = $row['destination_app'];\r\n\t\t\t\t\t\t\t\t\t\t$destination_data = $row['destination_data'];\r\n\t\t\t\t\t\t\t\t\t\t$destination_accountcode = $row['destination_accountcode'];\r\n\t\t\t\t\t\t\t\t\t\t$destination_cid_name_prefix = $row['destination_cid_name_prefix'];\r\n\t\t\t\t\t\t\t\t\t\t$destination_description = $row['destination_description'];\r\n\r\n\t\t\t\t\t\t\t\t\t//convert the number to a regular expression\r\n\t\t\t\t\t\t\t\t\t\t$destination_number_regex = string_to_regex($destination_number);\r\n\r\n\t\t\t\t\t\t\t\t\t//add the additional fields\r\n\t\t\t\t\t\t\t\t\t\t$dialplan_uuid = uuid();\r\n\t\t\t\t\t\t\t\t\t\t$array[\"destinations\"][$row_id]['destination_type'] = $destination_type;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"destinations\"][$row_id]['destination_record'] = $destination_record;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"destinations\"][$row_id]['destination_context'] = $destination_context;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"destinations\"][$row_id]['destination_enabled'] = $destination_enabled;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"destinations\"][$row_id]['dialplan_uuid'] = $dialplan_uuid;\r\n\r\n\t\t\t\t\t\t\t\t\t//build the dialplan array\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"app_uuid\"] = \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_uuid\"] = $dialplan_uuid;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_name\"] = ($dialplan_name != '') ? $dialplan_name : format_phone($destination_number);\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_number\"] = $destination_number;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_context\"] = $destination_context;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_continue\"] = \"false\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_order\"] = \"100\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_enabled\"] = $destination_enabled;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_description\"] = $destination_description;\r\n\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = 10;\r\n\r\n\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\r\n\t\t\t\t\t\t\t\t\t//set the dialplan detail type\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($_SESSION['dialplan']['destination']['text']) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_type = $_SESSION['dialplan']['destination']['text'];\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_type = \"destination_number\";\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t//build the xml dialplan\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] = \"<extension name=\\\"\".$dialplan_name.\"\\\" continue=\\\"false\\\" uuid=\\\"\".$dialplan_uuid.\"\\\">\\n\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t<condition field=\\\"\".$dialplan_detail_type.\"\\\" expression=\\\"\".$destination_number_regex.\"\\\">\\n\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"export\\\" data=\\\"call_direction=inbound\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"domain_uuid=\".$_SESSION['domain_uuid'].\"\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"domain_name=\".$_SESSION['domain_name'].\"\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($destination_cid_name_prefix) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"effective_caller_id_name=\".$destination_cid_name_prefix.\"#\\${caller_id_name}\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($destination_record) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"record_path=\\${recordings_dir}/\\${domain_name}/archive/\\${strftime(%Y)}/\\${strftime(%b)}/\\${strftime(%d)}\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"record_name=\\${uuid}.\\${record_ext}\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"record_append=true\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"record_in_progress=true\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"recording_follow_transfer=true\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"record_session\\\" data=\\\"\\${record_path}/\\${record_name}\\\" inline=\\\"false\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($destination_accountcode) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"accountcode=\".$destination_accountcode.\"\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($destination_carrier) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"carrier=\".$destination_carrier.\"\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($fax_uuid) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"tone_detect_hits=1\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"execute_on_tone_detect=transfer \".$fax_extension.\" XML \\${domain_name}\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"tone_detect\\\" data=\\\"fax 1100 r +5000\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"sleep\\\" data=\\\"3000\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"\".$destination_app.\"\\\" data=\\\"\".$destination_data.\"\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t</condition>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"</extension>\\n\";\r\n\r\n\t\t\t\t\t\t\t\t\t//dialplan details\r\n\t\t\t\t\t\t\t\t\t\tif ($_SESSION['destinations']['dialplan_details']['boolean'] == \"true\") {\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t//check the destination number\r\n\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"condition\";\r\n\t\t\t\t\t\t\t\t\t\t\t\tif (strlen($_SESSION['dialplan']['destination']['text']) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = $_SESSION['dialplan']['destination']['text'];\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = \"destination_number\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_data\"] = $destination_number_regex;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t//set the caller id name prefix\r\n\t\t\t\t\t\t\t\t\t\t\t\tif (strlen($destination_cid_name_prefix) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"action\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = \"set\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_data\"] = \"effective_caller_id_name=\".$destination_cid_name_prefix.\"#\\${caller_id_name}\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t//enable call recordings\r\n\t\t\t\t\t\t\t\t\t\t\t\tif ($destination_record == \"true\") {\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"action\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = \"answer\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_data\"] = \"\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"action\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = \"set\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_data\"] = \"record_path=\\${recordings_dir}/\\${domain_name}/archive/\\${strftime(%Y)}/\\${strftime(%b)}/\\${strftime(%d)}\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_inline\"] = \"true\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"action\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = \"set\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_data\"] = \"record_name=\\${uuid}.\\${record_ext}\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_inline\"] = \"true\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//add a variable\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan[\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan[\"dialplan_details\"][$y][\"dialplan_uuid\"] = $dialplan_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan[\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"action\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan[\"dialplan_details\"][$y][\"dialplan_detail_type\"] = \"set\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan[\"dialplan_details\"][$y][\"dialplan_detail_data\"] = \"recording_follow_transfer=true\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan[\"dialplan_details\"][$y][\"dialplan_detail_inline\"] = \"true\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan[\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"action\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = \"record_session\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_data\"] = \"\\${record_path}/\\${record_name}\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_inline\"] = \"false\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t//set the call accountcode\r\n\t\t\t\t\t\t\t\t\t\t\t\tif (strlen($destination_accountcode) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"action\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = \"set\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_data\"] = \"accountcode=\".$destination_accountcode;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t//set the call accountcode\r\n\t\t\t\t\t\t\t\t\t\t\t\tif (strlen($destination_app) > 0 && strlen($destination_data) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"action\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = $destination_app;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_data\"] = $destination_data;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t//set the detail id back to 0\r\n\t\t\t\t\t\t\t\t\t\t\t\t$y = 0;\r\n\r\n\t\t\t\t\t\t\t\t\t\t} //end if\r\n\t\t\t\t\t\t\t\t} //foreach\r\n\r\n\t\t\t\t\t\t\t//process a chunk of the array\r\n\t\t\t\t\t\t\t\tif ($row_id === 1000) {\r\n\r\n\t\t\t\t\t\t\t\t\t//save to the data\r\n\t\t\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t\t\t$database->app_name = 'destinations';\r\n\t\t\t\t\t\t\t\t\t\t$database->app_uuid = '5ec89622-b19c-3559-64f0-afde802ab139';\r\n\t\t\t\t\t\t\t\t\t\t$database->save($array);\r\n\t\t\t\t\t\t\t\t\t\t//$message = $database->message;\r\n\r\n\t\t\t\t\t\t\t\t\t//clear the array\r\n\t\t\t\t\t\t\t\t\t\tunset($array);\r\n\r\n\t\t\t\t\t\t\t\t\t//set the row id back to 0\r\n\t\t\t\t\t\t\t\t\t\t$row_id = 0;\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t$row_number++;\r\n\t\t\t\t\t\t$row_id++;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfclose($handle);\r\n\r\n\t\t\t\t//debug info\r\n\t\t\t\t\t//echo \"<pre>\\n\";\r\n\t\t\t\t\t//print_r($array);\r\n\t\t\t\t\t//echo \"</pre>\\n\";\r\n\t\t\t\t\t//exit;\r\n\r\n\t\t\t\t//save to the data\r\n\t\t\t\t\tif (is_array($array)) {\r\n\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t$database->app_name = 'destinations';\r\n\t\t\t\t\t\t$database->app_uuid = '5ec89622-b19c-3559-64f0-afde802ab139';\r\n\t\t\t\t\t\t$database->save($array);\r\n\t\t\t\t\t\t$message = $database->message;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t//send the redirect header\r\n\t\t\t\t\theader(\"Location: destinations.php\");\r\n\t\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t//show the header\r\n\t\t\trequire_once \"resources/header.php\";\r\n\t\t\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\r\n\t\t\techo \"<tr>\\n\";\r\n\t\t\techo \"<td align='left' width='30%' nowrap='nowrap'><b>\".$text['header-destinations_import'].\"</b></td>\\n\";\r\n\t\t\techo \"<td width='70%' align='right'>\\n\";\r\n\t\t\techo \"\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='/app/destinations/destinations.php?\".$_GET[\"query_string\"].\"'\\\" value='\".$text['button-back'].\"'>\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"</tr>\\n\";\r\n\t\t\techo \"<tr>\\n\";\r\n\t\t\techo \"<td align='left' colspan='2'>\\n\";\r\n\t\t\techo \"\t\".$text['message-results'].\"<br /><br />\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"</tr>\\n\";\r\n\t\t\techo \"</table>\\n\";\r\n\r\n\t\t//show the results\r\n\t\t\techo \"<table width='100%'  border='0' cellpadding='0' cellspacing='0' width='100%'>\\n\";\r\n\t\t\techo \"<tr>\\n\";\r\n\t\t\techo \"\t<th>\".$text['label-destination_name'].\"</th>\\n\";\r\n\t\t\techo \"\t<th>\".$text['label-destination_organization'].\"</th>\\n\";\r\n\t\t\t//echo \"\t<th>\".$text['label-destination_email'].\"</th>\\n\";\r\n\t\t\techo \"\t<th>\".$text['label-destination_url'].\"</th>\\n\";\r\n\t\t\techo \"</tr>\\n\";\r\n\t\t\tif ($results) {\r\n\t\t\t\tforeach($results as $row) {\r\n\t\t\t\t\techo \"<tr>\\n\";\r\n\t\t\t\t\techo \"\t<td class='vncell' valign='top' align='left'>\\n\";\r\n\t\t\t\t\techo \t\tescape($row['FirstName']).\" \".escape($row['LastName']);\r\n\t\t\t\t\techo \"\t</td>\\n\";\r\n\t\t\t\t\techo \"\t<td class='vncell' valign='top' align='left'>\\n\";\r\n\t\t\t\t\techo \tescape($row['Company']).\"&nbsp;\\n\";\r\n\t\t\t\t\techo \"\t</td>\\n\";\r\n\t\t\t\t\techo \"\t<td class='vncell' valign='top' align='left'>\\n\";\r\n\t\t\t\t\techo \t\tescape($row['EmailAddress']).\"&nbsp;\\n\";\r\n\t\t\t\t\techo \"\t</td>\\n\";\r\n\t\t\t\t\techo \"\t<td class='vncell' valign='top' align='left'>\\n\";\r\n\t\t\t\t\techo \t\tescape($row['Web Page']).\"&nbsp;\\n\";\r\n\t\t\t\t\techo \"\t</td>\\n\";\r\n\t\t\t\t\techo \"</tr>\\n\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\techo \"</table>\\n\";\r\n\r\n\t\t//include the footer\r\n\t\t\trequire_once \"resources/footer.php\";\r\n\r\n\t\t//end the script\r\n\t\t\texit;\r\n\t}\r\n\r\n\r\n//upload the destination csv\r\n\tif (file_exists($_SESSION['file']) && $action == 'delete') {\r\n\r\n\t\t//form to match the fields to the column names\r\n\t\t\t//require_once \"resources/header.php\";\r\n\r\n\t\t//user selected fields\r\n\t\t\t$fields = $_POST['fields'];\r\n\t\t\t$domain_uuid = $_POST['domain_uuid'];\r\n\t\t\t$destination_type = $_POST['destination_type'];\r\n\t\t\t$destination_context = $_POST['destination_context'];\r\n\t\t\t$destination_enabled = $_POST['destination_enabled'];\r\n\r\n\t\t//set the domain_uuid\r\n\t\t\t$domain_uuid = $_SESSION['domain_uuid'];\r\n\r\n\t\t//get the contents of the csv file and convert them into an array\r\n\t\t\t$handle = @fopen($_SESSION['file'], \"r\");\r\n\t\t\tif ($handle) {\r\n\t\t\t\t//set the starting identifiers\r\n\t\t\t\t\t$row_id = 0;\r\n\t\t\t\t\t$dialplan_id = 0;\r\n\t\t\t\t\t$row_number = 1;\r\n\r\n\t\t\t\t//loop through the array\r\n\t\t\t\t\twhile (($line = fgets($handle, 4096)) !== false) {\r\n\t\t\t\t\t\tif ($from_row <= $row_number) {\r\n\r\n\t\t\t\t\t\t\t//format the data\r\n\t\t\t\t\t\t\t\t$y = 0;\r\n\t\t\t\t\t\t\t\tforeach ($fields as $key => $value) {\r\n\t\t\t\t\t\t\t\t\t//get the line\r\n\t\t\t\t\t\t\t\t\t$result = str_getcsv($line, $delimiter, $enclosure);\r\n\r\n\t\t\t\t\t\t\t\t\t//get the table and field name\r\n\t\t\t\t\t\t\t\t\t$field_array = explode(\".\",$value);\r\n\t\t\t\t\t\t\t\t\t$table_name = $field_array[0];\r\n\t\t\t\t\t\t\t\t\t$field_name = $field_array[1];\r\n\t\t\t\t\t\t\t\t\t//echo \"value: $value<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t//echo \"table_name: $table_name<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t//echo \"field_name: $field_name<br />\\n\";\r\n\r\n\t\t\t\t\t\t\t\t\t//get the parent table name\r\n\t\t\t\t\t\t\t\t\t$parent = get_parent($schema, $table_name);\r\n\r\n\t\t\t\t\t\t\t\t\t//remove formatting from the phone number\r\n\t\t\t\t\t\t\t\t\tif ($field_name == \"phone_number\") {\r\n\t\t\t\t\t\t\t\t\t\t$result[$key] = preg_replace('{\\D}', '', $result[$key]);\r\n\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t//build the data array\r\n\t\t\t\t\t\t\t\t\tif (strlen($table_name) > 0) {\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($parent) == 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$table_name][$row_id]['domain_uuid'] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$table_name][$row_id][$field_name] = $result[$key];\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$parent][$row_id][$table_name][$y]['domain_uuid'] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$parent][$row_id][$table_name][$y][$field_name] = $result[$key];\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t//get the destination_number\r\n\t\t\t\t\t\t\t\t\tif ($key === 'destination_number') { $destination_number = $result[$key]; }\r\n\t\t\t\t\t\t\t\t\tif ($key === 'destination_uuid') { $destination_uuid = $result[$key]; }\r\n\t\t\t\t\t\t\t\t\tif ($key === 'dialplan_uuid') { $destination_uuid = $result[$key]; }\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t//delete the destinations\r\n\t\t\t\t\t\t\t\t$row_number = 0;\r\n\t\t\t\t\t\t\t\tforeach ($array['destinations'] as $row) {\r\n\t\t\t\t\t\t\t\t\t//get the values\r\n\t\t\t\t\t\t\t\t\t\t$domain_uuid = $row['domain_uuid'];\r\n\t\t\t\t\t\t\t\t\t\t$destination_number = $row['destination_number'];\r\n\r\n\t\t\t\t\t\t\t\t\t//get the dialplan uuid\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($row['destination_number']) == 0 || strlen($row['dialplan_uuid']) == 0 ) {\r\n\t\t\t\t\t\t\t\t\t\t\t$sql = \"select * from v_destinations \";\r\n\t\t\t\t\t\t\t\t\t\t\t$sql .= \"where domain_uuid = :domain_uuid \";\r\n\t\t\t\t\t\t\t\t\t\t\t$sql .= \"and destination_number = :destination_number; \";\r\n\t\t\t\t\t\t\t\t\t\t\t//echo $sql.\"<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$parameters['domain_uuid'] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t$parameters['destination_number'] = $destination_number;\r\n\t\t\t\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t\t\t\t$destinations = $database->select($sql, $parameters, 'all');\r\n\t\t\t\t\t\t\t\t\t\t\t$row = $destinations[0];\r\n\r\n\t\t\t\t\t\t\t\t\t\t//add to the array\r\n\t\t\t\t\t\t\t\t\t\t\t//$array['destinations'][$row_id] = $destinations[0];\r\n\t\t\t\t\t\t\t\t\t\t\t$array['destinations'][$row_id]['destination_uuid'] = $destinations[0]['destination_uuid'];\r\n\t\t\t\t\t\t\t\t\t\t\tif (strlen($row['dialplan_uuid']) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t$array['destinations'][$row_id]['dialplan_uuid'] = $destinations[0]['dialplan_uuid'];\r\n\t\t\t\t\t\t\t\t\t\t\t\t//$array['dialplans'][$row_id]['dialplan_uuid'] = $destinations[0]['dialplan_uuid'];\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t} //foreach\r\n\r\n\t\t\t\t\t\t} //if ($from_row <= $row_number)\r\n\t\t\t\t\t\t$row_number++;\r\n\r\n\t\t\t\t\t//process a chunk of the array\r\n\t\t\t\t\t\tif ($row_id === 1000) {\r\n\t\t\t\t\t\t\t//delete the destinations\r\n\t\t\t\t\t\t\t$row_number = 0;\r\n\t\t\t\t\t\t\tforeach ($array['destinations'] as $row) {\r\n\t\t\t\t\t\t\t\t//delete the dialplan\r\n\t\t\t\t\t\t\t\tif (strlen($row['dialplan_uuid']) > 0) {\r\n\t\t\t\t\t\t\t\t\t$sql = \"delete from v_dialplan_details \";\r\n\t\t\t\t\t\t\t\t\t$sql .= \"where dialplan_uuid = :dialplan_uuid \";\r\n\t\t\t\t\t\t\t\t\t//echo \"$sql<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t$parameters['dialplan_uuid'] = $row['dialplan_uuid'];\r\n\t\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t\t$database->execute($sql, $parameters);\r\n\r\n\t\t\t\t\t\t\t\t\t$sql = \"delete from v_dialplans \";\r\n\t\t\t\t\t\t\t\t\t$sql .= \"where dialplan_uuid = :dialplan_uuid \";\r\n\t\t\t\t\t\t\t\t\t//echo \"$sql<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t$parameters['dialplan_uuid'] = $row['dialplan_uuid'];\r\n\t\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t\t$database->execute($sql, $parameters);\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t//delete the destinations\r\n\t\t\t\t\t\t\t\tif (strlen($row['destination_uuid']) > 0) {\r\n\t\t\t\t\t\t\t\t\t$sql = \"delete from v_destinations \";\r\n\t\t\t\t\t\t\t\t\t$sql .= \"where destination_uuid = :destination_uuid \";\r\n\t\t\t\t\t\t\t\t\t//echo \"$sql<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t$parameters['destination_uuid'] = $row['destination_uuid'];\r\n\t\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t\t$database->execute($sql, $parameters);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t} //foreach\r\n\r\n\t\t\t\t\t\t\t//delete to the data\r\n\t\t\t\t\t\t\t//$database = new database;\r\n\t\t\t\t\t\t\t//$database->app_name = 'destinations';\r\n\t\t\t\t\t\t\t//$database->app_uuid = '5ec89622-b19c-3559-64f0-afde802ab139';\r\n\t\t\t\t\t\t\t//$database->delete($array);\r\n\t\t\t\t\t\t\t//$message = $database->message;\r\n\r\n\t\t\t\t\t\t\t//clear the array\r\n\t\t\t\t\t\t\tunset($array);\r\n\r\n\t\t\t\t\t\t\t//set the row id back to 0\r\n\t\t\t\t\t\t\t$row_id = 0;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t//increment row id\r\n\t\t\t\t\t\t\t$row_id++;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfclose($handle);\r\n\r\n\t\t\t\t//delete the remaining destinations\r\n\t\t\t\t\tif ($row_id < 1000) {\r\n\t\t\t\t\t\tforeach ($array['destinations'] as $row) {\r\n\t\t\t\t\t\t\t//delete the dialplan\r\n\t\t\t\t\t\t\tif (strlen($row['dialplan_uuid']) > 0) {\r\n\t\t\t\t\t\t\t\t$sql = \"delete from v_dialplan_details \";\r\n\t\t\t\t\t\t\t\t$sql .= \"where dialplan_uuid = :dialplan_uuid \";\r\n\t\t\t\t\t\t\t\t//echo \"$sql<br />\\n\";\r\n\t\t\t\t\t\t\t\t$parameters['dialplan_uuid'] = $row['dialplan_uuid'];\r\n\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t$database->execute($sql, $parameters);\r\n\r\n\t\t\t\t\t\t\t\t$sql = \"delete from v_dialplans \";\r\n\t\t\t\t\t\t\t\t$sql .= \"where dialplan_uuid = :dialplan_uuid \";\r\n\t\t\t\t\t\t\t\t//echo \"$sql<br />\\n\";\r\n\t\t\t\t\t\t\t\t$parameters['dialplan_uuid'] = $row['dialplan_uuid'];\r\n\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t$database->execute($sql, $parameters);\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t//delete the destinations\r\n\t\t\t\t\t\t\tif (strlen($row['destination_uuid']) > 0) {\r\n\t\t\t\t\t\t\t\t$sql = \"delete from v_destinations \";\r\n\t\t\t\t\t\t\t\t$sql .= \"where destination_uuid = :destination_uuid \";\r\n\t\t\t\t\t\t\t\t//echo \"$sql<br />\\n\";\r\n\t\t\t\t\t\t\t\t$parameters['destination_uuid'] = $row['destination_uuid'];\r\n\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t$database->execute($sql, $parameters);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} //foreach\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t//debug info\r\n\t\t\t\t\t//echo \"<pre>\\n\";\r\n\t\t\t\t\t//print_r($array);\r\n\t\t\t\t\t//echo \"</pre>\\n\";\r\n\t\t\t\t\t//exit;\r\n\r\n\t\t\t\t//save to the data\r\n\t\t\t\t\t//if (is_array($array)) {\r\n\t\t\t\t\t//\t$database = new database;\r\n\t\t\t\t\t//\t$database->app_name = 'destinations';\r\n\t\t\t\t\t//\t$database->app_uuid = '5ec89622-b19c-3559-64f0-afde802ab139';\r\n\t\t\t\t\t//\t$database->delete($array);\r\n\t\t\t\t\t//\t//$message = $database->message;\r\n\t\t\t\t\t//}\r\n\r\n\t\t\t\t//send the redirect header\r\n\t\t\t\t\theader(\"Location: /app/destinations/destinations.php\");\r\n\t\t\t\t\treturn;\r\n\t\t\t}\r\n\t}\r\n\r\n//match the column names to the field names\r\n\tif (strlen($delimiter) > 0 && file_exists($_SESSION['file']) && ($action !== 'add' or $action !== 'delete')) {\r\n\r\n\t\t//form to match the fields to the column names\r\n\t\t\trequire_once \"resources/header.php\";\r\n\r\n\t\t\techo \"<form action='' method='POST' enctype='multipart/form-data' name='frmUpload' onSubmit=''>\\n\";\r\n\t\t\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\r\n\r\n\t\t\techo \"\t<tr>\\n\";\r\n\t\t\techo \"\t<td valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\techo \"\t\t<b>\".$text['header-destination_import'].\"</b><br />\\n\";\r\n\t\t\techo \"\t</td>\\n\";\r\n\t\t\techo \"\t<td valign='top' align='right'>\\n\";\r\n\t\t\techo \"\t\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='/app/destinations/destinations.php'\\\" value='\".$text['button-back'].\"'>\\n\";\r\n\t\t\techo \"\t\t<input name='submit' type='submit' class='btn' id='import' value=\\\"\".$text['button-import'].\"\\\">\\n\";\r\n\t\t\techo \"\t</td>\\n\";\r\n\t\t\techo \"\t</tr>\\n\";\r\n\t\t\techo \"\t<tr>\\n\";\r\n\t\t\techo \"\t<td colspan='2' align='left'>\\n\";\r\n\t\t\techo \"\t\t\".$text['description-destination_import'].\"\\n\";\r\n\t\t\techo \"\t</td>\\n\";\r\n\t\t\techo \"\t</tr>\\n\";\r\n\r\n\t\t\t//echo \"<tr>\\n\";\r\n\t\t\t//echo \"<td align='left' width='30%' nowrap='nowrap'><b>\".$text['header-destinations_import'].\"</b></td>\\n\";\r\n\t\t\t//echo \"<td width='70%' align='right'>\\n\";\r\n\t\t\t//echo \"\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='/app/destinations/destinations.php'\\\" value='\".$text['button-back'].\"'>\\n\";\r\n\t\t\t//echo \"</td>\\n\";\r\n\t\t\t//echo \"</tr>\\n\";\r\n\r\n\t\t\t//loop through user columns\r\n\t\t\t$x = 0;\r\n\t\t\tforeach ($line_fields as $line_field) {\r\n\t\t\t\t$line_field = trim(trim($line_field), $enclosure);\r\n\t\t\t\techo \"<tr>\\n\";\r\n\t\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\t\t//echo \"    \".$text['label-zzz'].\"\\n\";\r\n\t\t\t\techo $line_field;\r\n\t\t\t\techo \"</td>\\n\";\r\n\t\t\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\t\t\techo \"\t\t\t\t<select class='formfld' style='' name='fields[$x]'>\\n\";\r\n\t\t\t\techo \" \t\t\t\t<option value=''></option>\\n\";\r\n\t\t\t\tforeach($schema as $row) {\r\n\t\t\t\t\techo \"\t\t\t<optgroup label='\".$row['table'].\"'>\\n\";\r\n\t\t\t\t\tforeach($row['fields'] as $field) {\r\n\t\t\t\t\t\t$selected = '';\r\n\t\t\t\t\t\tif ($field == $line_field) {\r\n\t\t\t\t\t\t\t$selected = \"selected='selected'\";\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif ($field !== 'domain_uuid') {\r\n\t\t\t\t\t\t\techo \"    \t\t\t<option value='\".escape($row['table']).\".\".$field.\"' \".$selected.\">\".$field.\"</option>\\n\";\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\techo \"\t\t\t</optgroup>\\n\";\r\n\t\t\t\t}\r\n\t\t\t\techo \"\t\t\t\t</select>\\n\";\r\n\t\t\t\t//echo \"<br />\\n\";\r\n\t\t\t\t//echo $text['description-zzz'].\"\\n\";\r\n\t\t\t\techo \"\t\t\t</td>\\n\";\r\n\t\t\t\techo \"\t\t</tr>\\n\";\r\n\t\t\t\t$x++;\r\n\t\t\t}\r\n\r\n\t\t\techo \"<tr>\\n\";\r\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\techo \"\t\".$text['label-destination_type'].\"\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\t\techo \"\t<select class='formfld' name='destination_type' id='destination_type' onchange='type_control(this.options[this.selectedIndex].value);'>\\n\";\r\n\t\t\tswitch ($destination_type) {\r\n\t\t\t\tcase \"inbound\" : \t$selected[1] = \"selected='selected'\";\tbreak;\r\n\t\t\t\tcase \"outbound\" : \t$selected[2] = \"selected='selected'\";\tbreak;\r\n\t\t\t\tcase \"local\" : \t$selected[2] = \"selected='selected'\";\tbreak;\r\n\t\t\t}\r\n\t\t\techo \"\t<option value='inbound' \".$selected[1].\">\".$text['option-inbound'].\"</option>\\n\";\r\n\t\t\techo \"\t<option value='outbound' \".$selected[2].\">\".$text['option-outbound'].\"</option>\\n\";\r\n\t\t\techo \"\t<option value='local' \".$selected[3].\">\".$text['option-local'].\"</option>\\n\";\r\n\t\t\tunset($selected);\r\n\t\t\techo \"\t</select>\\n\";\r\n\t\t\techo \"<br />\\n\";\r\n\t\t\techo $text['description-destination_type'].\"\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"</tr>\\n\";\r\n\t\t\t\r\n\t\t\techo \"<tr>\\n\";\r\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\techo \"\t\".$text['label-destination_record'].\"\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\t\techo \"\t<select class='formfld' name='destination_record' id='destination_record'>\\n\";\r\n\t\t\techo \"\t<option value=''></option>\\n\";\r\n\t\t\tswitch ($destination_record) {\r\n\t\t\t\tcase \"true\" : \t$selected[1] = \"selected='selected'\";\tbreak;\r\n\t\t\t\tcase \"false\" : \t$selected[2] = \"selected='selected'\";\tbreak;\r\n\t\t\t}\r\n\t\t\techo \"\t<option value='true' \".$selected[1].\">\".$text['option-true'].\"</option>\\n\";\r\n\t\t\techo \"\t<option value='false' \".$selected[2].\">\".$text['option-false'].\"</option>\\n\";\r\n\t\t\tunset($selected);\r\n\t\t\techo \"\t</select>\\n\";\r\n\t\t\techo \"<br />\\n\";\r\n\t\t\techo $text['description-destination_record'].\"\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"</tr>\\n\";\r\n\r\n\t\t\t//if (permission_exists('destination_context')) {\r\n\t\t\t\techo \"<tr>\\n\";\r\n\t\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\t\techo \"\t\".$text['label-destination_context'].\"\\n\";\r\n\t\t\t\techo \"</td>\\n\";\r\n\t\t\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\t\t\techo \"\t<input class='formfld' type='text' name='destination_context' id='destination_context' maxlength='255' value=\\\"\".escape($destination_context).\"\\\">\\n\";\r\n\t\t\t\techo \"<br />\\n\";\r\n\t\t\t\techo $text['description-destination_context'].\"\\n\";\r\n\t\t\t\techo \"</td>\\n\";\r\n\t\t\t\techo \"</tr>\\n\";\r\n\t\t\t//}\r\n\r\n\t\t\techo \"<tr>\\n\";\r\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\techo \"\t\".$text['label-actions'].\"\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\t\techo \"\t<select class='formfld' name='action' id='action'>\\n\";\r\n\t\t\techo \"\t<option value='add' selected='selected'>\".$text['label-add'].\"</option>\\n\";\r\n\t\t\techo \"\t<option value='delete'>\".$text['label-delete'].\"</option>\\n\";\r\n\t\t\techo \"\t</select>\\n\";\r\n\t\t\techo \"<br />\\n\";\r\n\t\t\techo $text['description-actions'].\"\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"</tr>\\n\";\r\n\r\n\t\t\tif (permission_exists('destination_domain')) {\r\n\t\t\t\techo \"<tr>\\n\";\r\n\t\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\t\techo \"\t\".$text['label-domain'].\"\\n\";\r\n\t\t\t\techo \"</td>\\n\";\r\n\t\t\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\t\t\techo \"    <select class='formfld' name='domain_uuid' id='destination_domain' onchange='context_control();'>\\n\";\r\n\t\t\t\tif (strlen($domain_uuid) == 0) {\r\n\t\t\t\t\techo \"    <option value='' selected='selected'>\".$text['select-global'].\"</option>\\n\";\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\techo \"    <option value=''>\".$text['select-global'].\"</option>\\n\";\r\n\t\t\t\t}\r\n\t\t\t\tforeach ($_SESSION['domains'] as $row) {\r\n\t\t\t\t\tif ($row['domain_uuid'] == $domain_uuid) {\r\n\t\t\t\t\t\techo \"    <option value='\".escape($row['domain_uuid']).\"' selected='selected'>\".escape($row['domain_name']).\"</option>\\n\";\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\techo \"    <option value='\".escape($row['domain_uuid']).\"'>\".escape($row['domain_name']).\"</option>\\n\";\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\techo \"    </select>\\n\";\r\n\t\t\t\techo \"<br />\\n\";\r\n\t\t\t\techo $text['description-domain_name'].\"\\n\";\r\n\t\t\t\techo \"</td>\\n\";\r\n\t\t\t\techo \"</tr>\\n\";\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\techo \"<input type='hidden' name='domain_uuid' value='\".escape($domain_uuid).\"'>\\n\";\r\n\t\t\t}\r\n\r\n\t\t\techo \"<tr>\\n\";\r\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\techo \"\t\".$text['label-destination_enabled'].\"\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\t\techo \"\t<select class='formfld' name='destination_enabled'>\\n\";\r\n\t\t\tswitch ($destination_enabled) {\r\n\t\t\t\tcase \"true\" :\t$selected[1] = \"selected='selected'\";\tbreak;\r\n\t\t\t\tcase \"false\" :\t$selected[2] = \"selected='selected'\";\tbreak;\r\n\t\t\t}\r\n\t\t\techo \"\t<option value='true' \".$selected[1].\">\".$text['label-true'].\"</option>\\n\";\r\n\t\t\techo \"\t<option value='false' \".$selected[2].\">\".$text['label-false'].\"</option>\\n\";\r\n\t\t\tunset($selected);\r\n\t\t\techo \"\t</select>\\n\";\r\n\t\t\techo \"<br />\\n\";\r\n\t\t\techo $text['description-destination_enabled'].\"\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"</tr>\\n\";\r\n\r\n\t\t\techo \"\t\t<tr>\\n\";\r\n\t\t\techo \"\t\t\t<td colspan='2' valign='top' align='right' nowrap='nowrap'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input name='from_row' type='hidden' value='$from_row'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input name='data_delimiter' type='hidden' value='$delimiter'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input name='data_enclosure' type='hidden' value='$enclosure'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input type='submit' class='btn' id='import' value=\\\"\".$text['button-import'].\"\\\">\\n\";\r\n\t\t\techo \"\t\t\t</td>\\n\";\r\n\t\t\techo \"\t\t</tr>\\n\";\r\n\r\n\t\t\techo \"\t</table>\\n\";\r\n\t\t\techo \"</form>\\n\";\r\n\t\t\trequire_once \"resources/footer.php\";\r\n\r\n\t\t//normalize the column names\r\n\t\t\t//$line = strtolower($line);\r\n\t\t\t//$line = str_replace(\"-\", \"_\", $line);\r\n\t\t\t//$line = str_replace($delimiter.\"title\".$delimiter, $delimiter.\"destination_title\".$delimiter, $line);\r\n\t\t\t//$line = str_replace(\"firstname\", \"name_given\", $line);\r\n\t\t\t//$line = str_replace(\"lastname\", \"name_family\", $line);\r\n\t\t\t//$line = str_replace(\"company\", \"organization\", $line);\r\n\t\t\t//$line = str_replace(\"company\", \"destination_email\", $line);\r\n\r\n\t\t//end the script\r\n\t\t\texit;\r\n\t}\r\n\r\n//include the header\r\n\trequire_once \"resources/header.php\";\r\n\r\n//begin the content\r\n\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\r\n\techo \"\t<tr>\\n\";\r\n\techo \"\t<td valign='top' align='left' width='30%' nowrap='nowrap'>\\n\";\r\n\techo \"\t\t<b>\".$text['header-destination_import'].\"</b><br />\\n\";\r\n\techo \"\t\t\".$text['description-destination_import'].\"\\n\";\r\n\techo \"\t</td>\\n\";\r\n\techo \"\t<td valign='top' width='70%' align='right'>\\n\";\r\n\techo \"\t\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='/app/destinations/destinations.php?\".$_GET[\"query_string\"].\"'\\\" value='\".$text['button-back'].\"'>\\n\";\r\n\t//echo \"\t\t<input name='submit' type='submit' class='btn' id='import' value=\\\"\".$text['button-import'].\"\\\">\\n\";\r\n\techo \"\t</td>\\n\";\r\n\techo \"\t</tr>\\n\";\r\n\techo \"</table>\";\r\n\r\n\techo \"<br />\\n\";\r\n\r\n\techo \"<form action='' method='POST' enctype='multipart/form-data' name='frmUpload' onSubmit=''>\\n\";\r\n\techo \"\t<table border='0' cellpadding='0' cellspacing='0' width='100%'>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"    \".$text['label-import_data'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"    <textarea name='data' id='data' rows='7' class='formfld' style='width: 100%;' wrap='off'>$data</textarea>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo $text['description-import_data'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"    \".$text['label-from_row'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"\t\t<select class='formfld' name='from_row'>\\n\";\r\n\t$i=1;\r\n\twhile($i<=99) {\r\n\t\t$selected = ($i == $from_row) ? \"selected\" : null;\r\n\t\techo \"\t\t\t<option value='$i' \".$selected.\">$i</option>\\n\";\r\n\t\t$i++;\r\n\t}\r\n\techo \"\t\t</select>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo $text['description-from_row'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"    \".$text['label-import_delimiter'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"    <select class='formfld' style='width:40px;' name='data_delimiter'>\\n\";\r\n\techo \"    <option value=','>,</option>\\n\";\r\n\techo \"    <option value='|'>|</option>\\n\";\r\n\techo \"    </select>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo $text['description-import_delimiter'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"    \".$text['label-import_enclosure'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"    <select class='formfld' style='width:40px;' name='data_enclosure'>\\n\";\r\n\techo \"    <option value='\\\"'>\\\"</option>\\n\";\r\n\techo \"    <option value=''></option>\\n\";\r\n\techo \"    </select>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo $text['description-import_enclosure'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\tif (permission_exists('destination_upload')) {\r\n\t\techo \"<tr>\\n\";\r\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\techo \"\t\t\t\".$text['label-import_file_upload'].\"\\n\";\r\n\t\techo \"</td>\\n\";\r\n\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\techo \"\t\t\t<input name='ulfile' type='file' class='formfld fileinput' id='ulfile'>\\n\";\r\n\t\techo \"<br />\\n\";\r\n\t\techo $text['description-import_file_upload'].\"\\n\";\r\n\t\techo \"</td>\\n\";\r\n\t\techo \"</tr>\\n\";\r\n\t}\r\n\r\n\techo \"\t<tr>\\n\";\r\n\techo \"\t\t<td valign='bottom'>\\n\";\r\n\techo \"\t\t</td>\\n\";\r\n\techo \"\t\t<td valign='bottom' align='right' nowrap>\\n\";\r\n\techo \"\t\t\t<input name='type' type='hidden' value='csv'>\\n\";\r\n\techo \"\t\t\t<br />\\n\";\r\n\techo \"\t\t\t<input name='submit' type='submit' class='btn' id='import' value=\\\"\".$text['button-import'].\"\\\">\\n\";\r\n\techo \"\t\t</td>\\n\";\r\n\techo \"\t</tr>\\n\";\r\n\techo \"\t</table>\\n\";\r\n\techo \"<br><br>\";\r\n\techo \"</form>\";\r\n\r\n//include the footer\r\n\trequire_once \"resources/footer.php\";\r\n\r\n?>\r\n"], "fixing_code": ["<?php\r\n/*\r\n\tFusionPBX\r\n\tVersion: MPL 1.1\r\n\r\n\tThe contents of this file are subject to the Mozilla Public License Version\r\n\t1.1 (the \"License\"); you may not use this file except in compliance with\r\n\tthe License. You may obtain a copy of the License at\r\n\thttp://www.mozilla.org/MPL/\r\n\r\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\r\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\r\n\tfor the specific language governing rights and limitations under the\r\n\tLicense.\r\n\r\n\tThe Original Code is FusionPBX\r\n\r\n\tThe Initial Developer of the Original Code is\r\n\tMark J Crane <markjcrane@fusionpbx.com>\r\n\tPortions created by the Initial Developer are Copyright (C) 2018 - 2019\r\n\tthe Initial Developer. All Rights Reserved.\r\n\r\n\tContributor(s):\r\n\tMark J Crane <markjcrane@fusionpbx.com>\r\n*/\r\n\r\n//includes\r\n\tinclude \"root.php\";\r\n\trequire_once \"resources/require.php\";\r\n\trequire_once \"resources/check_auth.php\";\r\n\r\n//check permissions\r\n\tif (permission_exists('destination_import')) {\r\n\t\t//access granted\r\n\t}\r\n\telse {\r\n\t\techo \"access denied\";\r\n\t\texit;\r\n\t}\r\n\r\n//add multi-lingual support\r\n\t$language = new text;\r\n\t$text = $language->get();\r\n\r\n//built in str_getcsv requires PHP 5.3 or higher, this function can be used to reproduct the functionality but requirs PHP 5.1.0 or higher\r\n\tif(!function_exists('str_getcsv')) {\r\n\t\tfunction str_getcsv($input, $delimiter = \",\", $enclosure = '\"', $escape = \"\\\\\") {\r\n\t\t\t$fp = fopen(\"php://memory\", 'r+');\r\n\t\t\tfputs($fp, $input);\r\n\t\t\trewind($fp);\r\n\t\t\t$data = fgetcsv($fp, null, $delimiter, $enclosure); // $escape only got added in 5.3.0\r\n\t\t\tfclose($fp);\r\n\t\t\treturn $data;\r\n\t\t}\r\n\t}\r\n\r\n//set the max php execution time\r\n\tini_set(max_execution_time,7200);\r\n\r\n//get the http get values and set them as php variables\r\n\t$action = $_POST[\"action\"];\r\n\t$order_by = $_POST[\"order_by\"];\r\n\t$order = $_POST[\"order\"];\r\n\t$from_row = $_POST[\"from_row\"];\r\n\t$delimiter = $_POST[\"data_delimiter\"];\r\n\t$enclosure = $_POST[\"data_enclosure\"];\r\n\t$destination_type = $_POST[\"destination_type\"];\r\n\t$destination_action = $_POST[\"destination_action\"];\r\n\t$destination_context = $_POST[\"destination_context\"];\r\n\t$destination_record = $_POST[\"destination_record\"];\r\n\r\n//set the defaults\r\n\tif (strlen($destination_type) == 0) { $destination_type = 'inbound'; }\r\n\tif (strlen($destination_context) == 0) { $destination_context = 'public'; }\r\n\tif ($destination_type ==\"outbound\" && $destination_context == \"public\") { $destination_context = $_SESSION['domain_name']; }\r\n\tif ($destination_type ==\"outbound\" && strlen($destination_context) == 0) { $destination_context = $_SESSION['domain_name']; }\r\n\r\n//save the data to the csv file\r\n\tif (isset($_POST['data'])) {\r\n\t\t$file = $_SESSION['server']['temp']['dir'].\"/destinations-\".$_SESSION['domain_name'].\".csv\";\r\n\t\tfile_put_contents($file, $_POST['data']);\r\n\t\t$_SESSION['file'] = $file;\r\n\t}\r\n\r\n//copy the csv file\r\n\t//$_POST['submit'] == \"Upload\" &&\r\n\tif ( is_uploaded_file($_FILES['ulfile']['tmp_name']) && permission_exists('destination_upload')) {\r\n\t\tif ($_POST['type'] == 'csv') {\r\n\t\t\tmove_uploaded_file($_FILES['ulfile']['tmp_name'], $_SESSION['server']['temp']['dir'].'/'.$_FILES['ulfile']['name']);\r\n\t\t\t$save_msg = \"Uploaded file to \".$_SESSION['server']['temp']['dir'].\"/\". htmlentities($_FILES['ulfile']['name']);\r\n\t\t\t//system('chmod -R 744 '.$_SESSION['server']['temp']['dir'].'*');\r\n\t\t\tunset($_POST['txtCommand']);\r\n\t\t\t$file = $_SESSION['server']['temp']['dir'].'/'.$_FILES['ulfile']['name'];\r\n\t\t\t$_SESSION['file'] = $file;\r\n\t\t}\r\n\t}\r\n\r\n//get the schema\r\n\tif (strlen($delimiter) > 0) {\r\n\t\t//get the first line\r\n\t\t\t$line = fgets(fopen($_SESSION['file'], 'r'));\r\n\t\t\t$line_fields = explode($delimiter, $line);\r\n\r\n\t\t//get the schema\r\n\t\t\t$x = 0;\r\n\t\t\tinclude (\"app/destinations/app_config.php\");\r\n\t\t\t$i = 0;\r\n\t\t\tforeach($apps[0]['db'] as $table) {\r\n\t\t\t\t//get the table name and parent name\r\n\t\t\t\t$table_name = $table[\"table\"]['name'];\r\n\t\t\t\t$parent_name = $table[\"table\"]['parent'];\r\n\r\n\t\t\t\t//remove the v_ table prefix\r\n\t\t\t\tif (substr($table_name, 0, 2) == 'v_') {\r\n\t\t\t\t\t$table_name = substr($table_name, 2);\r\n\t\t\t\t}\r\n\t\t\t\tif (substr($parent_name, 0, 2) == 'v_') {\r\n\t\t\t\t\t$parent_name = substr($parent_name, 2);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//filter for specific tables and build the schema array\r\n\t\t\t\tif ($table_name == \"destinations\") {\r\n\t\t\t\t\t$schema[$i]['table'] = $table_name;\r\n\t\t\t\t\t$schema[$i]['parent'] = $parent_name;\r\n\t\t\t\t\tforeach($table['fields'] as $row) {\r\n\t\t\t\t\t\tif ($row['deprecated'] !== 'true') {\r\n\t\t\t\t\t\t\tif (is_array($row['name'])) {\r\n\t\t\t\t\t\t\t\t$field_name = $row['name']['text'];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t$field_name = $row['name'];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t$schema[$i]['fields'][] = $field_name;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t$i++;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t}\r\n\r\n//get the parent table\r\n\tfunction get_parent($schema,$table_name) {\r\n\t\tforeach ($schema as $row) {\r\n\t\t\tif ($row['table'] == $table_name) {\r\n\t\t\t\treturn $row['parent'];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n//upload the destination csv\r\n\tif (file_exists($_SESSION['file']) && $action == 'add') {\r\n\r\n\t\t//form to match the fields to the column names\r\n\t\t\t//require_once \"resources/header.php\";\r\n\r\n\t\t//user selected fields\r\n\t\t\t$fields = $_POST['fields'];\r\n\t\t\t$domain_uuid = $_POST['domain_uuid'];\r\n\t\t\t$destination_record = $_POST['destination_record'];\r\n\t\t\t$destination_type = $_POST['destination_type'];\r\n\t\t\t$destination_context = $_POST['destination_context'];\r\n\t\t\t$destination_enabled = $_POST['destination_enabled'];\r\n\r\n\t\t//set the domain_uuid\r\n\t\t\t$domain_uuid = $_SESSION['domain_uuid'];\r\n\r\n\t\t//get the contents of the csv file and convert them into an array\r\n\t\t\t$handle = @fopen($_SESSION['file'], \"r\");\r\n\t\t\tif ($handle) {\r\n\t\t\t\t//pre-set the numbers\r\n\t\t\t\t\t$row_id = 0;\r\n\t\t\t\t\t$row_number = 1;\r\n\r\n\t\t\t\t//loop through the array\r\n\t\t\t\t\twhile (($line = fgets($handle, 4096)) !== false) {\r\n\t\t\t\t\t\tif ($from_row <= $row_number) {\r\n\t\t\t\t\t\t\t//format the data\r\n\t\t\t\t\t\t\t\t$y = 0;\r\n\t\t\t\t\t\t\t\tforeach ($fields as $key => $value) {\r\n\t\t\t\t\t\t\t\t\t//get the line\r\n\t\t\t\t\t\t\t\t\t$result = str_getcsv($line, $delimiter, $enclosure);\r\n\r\n\t\t\t\t\t\t\t\t\t//get the table and field name\r\n\t\t\t\t\t\t\t\t\t$field_array = explode(\".\",$value);\r\n\t\t\t\t\t\t\t\t\t$table_name = $field_array[0];\r\n\t\t\t\t\t\t\t\t\t$field_name = $field_array[1];\r\n\t\t\t\t\t\t\t\t\t//echo \"value: $value<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t//echo \"table_name: $table_name<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t//echo \"field_name: $field_name<br />\\n\";\r\n\r\n\t\t\t\t\t\t\t\t\t//get the parent table name\r\n\t\t\t\t\t\t\t\t\t$parent = get_parent($schema, $table_name);\r\n\r\n\t\t\t\t\t\t\t\t\t//remove formatting from the phone number\r\n\t\t\t\t\t\t\t\t\tif ($field_name == \"phone_number\") {\r\n\t\t\t\t\t\t\t\t\t\t$result[$key] = preg_replace('{\\D}', '', $result[$key]);\r\n\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t//build the data array\r\n\t\t\t\t\t\t\t\t\tif (strlen($table_name) > 0) {\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($parent) == 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$table_name][$row_id]['domain_uuid'] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$table_name][$row_id][$field_name] = $result[$key];\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$parent][$row_id][$table_name][$y]['domain_uuid'] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$parent][$row_id][$table_name][$y][$field_name] = $result[$key];\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t//get the destination_number\r\n\t\t\t\t\t\t\t\t\tif ($key === 'destination_number') { $destination_number = $result[$key]; }\r\n\t\t\t\t\t\t\t\t\tif ($key === 'destination_description') { $destination_description = $result[$key]; }\r\n\t\t\t\t\t\t\t\t\tif ($key === 'destination_app') { $destination_app = $result[$key]; echo \"destination_app $destination_app\\n\"; }\r\n\t\t\t\t\t\t\t\t\tif ($key === 'destination_data') { $destination_data = $result[$key]; echo \"destination_data $destination_data\\n\"; }\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t//add the actions\r\n\t\t\t\t\t\t\t\tforeach ($array['destinations'] as $row) {\r\n\r\n\t\t\t\t\t\t\t\t\t//get the values\r\n\t\t\t\t\t\t\t\t\t\t$destination_number = $row['destination_number'];\r\n\t\t\t\t\t\t\t\t\t\t$destination_app = $row['destination_app'];\r\n\t\t\t\t\t\t\t\t\t\t$destination_data = $row['destination_data'];\r\n\t\t\t\t\t\t\t\t\t\t$destination_accountcode = $row['destination_accountcode'];\r\n\t\t\t\t\t\t\t\t\t\t$destination_cid_name_prefix = $row['destination_cid_name_prefix'];\r\n\t\t\t\t\t\t\t\t\t\t$destination_description = $row['destination_description'];\r\n\r\n\t\t\t\t\t\t\t\t\t//convert the number to a regular expression\r\n\t\t\t\t\t\t\t\t\t\t$destination_number_regex = string_to_regex($destination_number);\r\n\r\n\t\t\t\t\t\t\t\t\t//add the additional fields\r\n\t\t\t\t\t\t\t\t\t\t$dialplan_uuid = uuid();\r\n\t\t\t\t\t\t\t\t\t\t$array[\"destinations\"][$row_id]['destination_type'] = $destination_type;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"destinations\"][$row_id]['destination_record'] = $destination_record;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"destinations\"][$row_id]['destination_context'] = $destination_context;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"destinations\"][$row_id]['destination_enabled'] = $destination_enabled;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"destinations\"][$row_id]['dialplan_uuid'] = $dialplan_uuid;\r\n\r\n\t\t\t\t\t\t\t\t\t//build the dialplan array\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"app_uuid\"] = \"c03b422e-13a8-bd1b-e42b-b6b9b4d27ce4\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_uuid\"] = $dialplan_uuid;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_name\"] = ($dialplan_name != '') ? $dialplan_name : format_phone($destination_number);\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_number\"] = $destination_number;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_context\"] = $destination_context;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_continue\"] = \"false\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_order\"] = \"100\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_enabled\"] = $destination_enabled;\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_description\"] = $destination_description;\r\n\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = 10;\r\n\r\n\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\r\n\t\t\t\t\t\t\t\t\t//set the dialplan detail type\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($_SESSION['dialplan']['destination']['text']) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_type = $_SESSION['dialplan']['destination']['text'];\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_type = \"destination_number\";\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t//build the xml dialplan\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] = \"<extension name=\\\"\".$dialplan_name.\"\\\" continue=\\\"false\\\" uuid=\\\"\".$dialplan_uuid.\"\\\">\\n\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t<condition field=\\\"\".$dialplan_detail_type.\"\\\" expression=\\\"\".$destination_number_regex.\"\\\">\\n\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"export\\\" data=\\\"call_direction=inbound\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"domain_uuid=\".$_SESSION['domain_uuid'].\"\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"domain_name=\".$_SESSION['domain_name'].\"\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($destination_cid_name_prefix) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"effective_caller_id_name=\".$destination_cid_name_prefix.\"#\\${caller_id_name}\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($destination_record) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"record_path=\\${recordings_dir}/\\${domain_name}/archive/\\${strftime(%Y)}/\\${strftime(%b)}/\\${strftime(%d)}\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"record_name=\\${uuid}.\\${record_ext}\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"record_append=true\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"record_in_progress=true\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"recording_follow_transfer=true\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"record_session\\\" data=\\\"\\${record_path}/\\${record_name}\\\" inline=\\\"false\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($destination_accountcode) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"accountcode=\".$destination_accountcode.\"\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($destination_carrier) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"carrier=\".$destination_carrier.\"\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($fax_uuid) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"tone_detect_hits=1\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"set\\\" data=\\\"execute_on_tone_detect=transfer \".$fax_extension.\" XML \\${domain_name}\\\" inline=\\\"true\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"tone_detect\\\" data=\\\"fax 1100 r +5000\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"sleep\\\" data=\\\"3000\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t\t<action application=\\\"\".$destination_app.\"\\\" data=\\\"\".$destination_data.\"\\\"/>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"\t</condition>\\n\";\r\n\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_xml\"] .= \"</extension>\\n\";\r\n\r\n\t\t\t\t\t\t\t\t\t//dialplan details\r\n\t\t\t\t\t\t\t\t\t\tif ($_SESSION['destinations']['dialplan_details']['boolean'] == \"true\") {\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t//check the destination number\r\n\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"condition\";\r\n\t\t\t\t\t\t\t\t\t\t\t\tif (strlen($_SESSION['dialplan']['destination']['text']) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = $_SESSION['dialplan']['destination']['text'];\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = \"destination_number\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_data\"] = $destination_number_regex;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t//set the caller id name prefix\r\n\t\t\t\t\t\t\t\t\t\t\t\tif (strlen($destination_cid_name_prefix) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"action\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = \"set\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_data\"] = \"effective_caller_id_name=\".$destination_cid_name_prefix.\"#\\${caller_id_name}\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t//enable call recordings\r\n\t\t\t\t\t\t\t\t\t\t\t\tif ($destination_record == \"true\") {\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"action\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = \"answer\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_data\"] = \"\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"action\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = \"set\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_data\"] = \"record_path=\\${recordings_dir}/\\${domain_name}/archive/\\${strftime(%Y)}/\\${strftime(%b)}/\\${strftime(%d)}\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_inline\"] = \"true\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"action\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = \"set\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_data\"] = \"record_name=\\${uuid}.\\${record_ext}\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_inline\"] = \"true\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//add a variable\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan[\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan[\"dialplan_details\"][$y][\"dialplan_uuid\"] = $dialplan_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan[\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"action\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan[\"dialplan_details\"][$y][\"dialplan_detail_type\"] = \"set\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan[\"dialplan_details\"][$y][\"dialplan_detail_data\"] = \"recording_follow_transfer=true\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan[\"dialplan_details\"][$y][\"dialplan_detail_inline\"] = \"true\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan[\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"action\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = \"record_session\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_data\"] = \"\\${record_path}/\\${record_name}\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_inline\"] = \"false\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t//set the call accountcode\r\n\t\t\t\t\t\t\t\t\t\t\t\tif (strlen($destination_accountcode) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"action\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = \"set\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_data\"] = \"accountcode=\".$destination_accountcode;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t//set the call accountcode\r\n\t\t\t\t\t\t\t\t\t\t\t\tif (strlen($destination_app) > 0 && strlen($destination_data) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"domain_uuid\"] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_tag\"] = \"action\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_type\"] = $destination_app;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_data\"] = $destination_data;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$array[\"dialplans\"][$row_id][\"dialplan_details\"][$y][\"dialplan_detail_order\"] = $dialplan_detail_order;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$y++;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//increment the dialplan detail order\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$dialplan_detail_order = $dialplan_detail_order + 10;\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t//set the detail id back to 0\r\n\t\t\t\t\t\t\t\t\t\t\t\t$y = 0;\r\n\r\n\t\t\t\t\t\t\t\t\t\t} //end if\r\n\t\t\t\t\t\t\t\t} //foreach\r\n\r\n\t\t\t\t\t\t\t//process a chunk of the array\r\n\t\t\t\t\t\t\t\tif ($row_id === 1000) {\r\n\r\n\t\t\t\t\t\t\t\t\t//save to the data\r\n\t\t\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t\t\t$database->app_name = 'destinations';\r\n\t\t\t\t\t\t\t\t\t\t$database->app_uuid = '5ec89622-b19c-3559-64f0-afde802ab139';\r\n\t\t\t\t\t\t\t\t\t\t$database->save($array);\r\n\t\t\t\t\t\t\t\t\t\t//$message = $database->message;\r\n\r\n\t\t\t\t\t\t\t\t\t//clear the array\r\n\t\t\t\t\t\t\t\t\t\tunset($array);\r\n\r\n\t\t\t\t\t\t\t\t\t//set the row id back to 0\r\n\t\t\t\t\t\t\t\t\t\t$row_id = 0;\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t$row_number++;\r\n\t\t\t\t\t\t$row_id++;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfclose($handle);\r\n\r\n\t\t\t\t//debug info\r\n\t\t\t\t\t//echo \"<pre>\\n\";\r\n\t\t\t\t\t//print_r($array);\r\n\t\t\t\t\t//echo \"</pre>\\n\";\r\n\t\t\t\t\t//exit;\r\n\r\n\t\t\t\t//save to the data\r\n\t\t\t\t\tif (is_array($array)) {\r\n\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t$database->app_name = 'destinations';\r\n\t\t\t\t\t\t$database->app_uuid = '5ec89622-b19c-3559-64f0-afde802ab139';\r\n\t\t\t\t\t\t$database->save($array);\r\n\t\t\t\t\t\t$message = $database->message;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t//send the redirect header\r\n\t\t\t\t\theader(\"Location: destinations.php\");\r\n\t\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t//show the header\r\n\t\t\trequire_once \"resources/header.php\";\r\n\t\t\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\r\n\t\t\techo \"<tr>\\n\";\r\n\t\t\techo \"<td align='left' width='30%' nowrap='nowrap'><b>\".$text['header-destinations_import'].\"</b></td>\\n\";\r\n\t\t\techo \"<td width='70%' align='right'>\\n\";\r\n\t\t\techo \"\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='/app/destinations/destinations.php'\\\" value='\".$text['button-back'].\"'>\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"</tr>\\n\";\r\n\t\t\techo \"<tr>\\n\";\r\n\t\t\techo \"<td align='left' colspan='2'>\\n\";\r\n\t\t\techo \"\t\".$text['message-results'].\"<br /><br />\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"</tr>\\n\";\r\n\t\t\techo \"</table>\\n\";\r\n\r\n\t\t//show the results\r\n\t\t\techo \"<table width='100%'  border='0' cellpadding='0' cellspacing='0' width='100%'>\\n\";\r\n\t\t\techo \"<tr>\\n\";\r\n\t\t\techo \"\t<th>\".$text['label-destination_name'].\"</th>\\n\";\r\n\t\t\techo \"\t<th>\".$text['label-destination_organization'].\"</th>\\n\";\r\n\t\t\t//echo \"\t<th>\".$text['label-destination_email'].\"</th>\\n\";\r\n\t\t\techo \"\t<th>\".$text['label-destination_url'].\"</th>\\n\";\r\n\t\t\techo \"</tr>\\n\";\r\n\t\t\tif ($results) {\r\n\t\t\t\tforeach($results as $row) {\r\n\t\t\t\t\techo \"<tr>\\n\";\r\n\t\t\t\t\techo \"\t<td class='vncell' valign='top' align='left'>\\n\";\r\n\t\t\t\t\techo \t\tescape($row['FirstName']).\" \".escape($row['LastName']);\r\n\t\t\t\t\techo \"\t</td>\\n\";\r\n\t\t\t\t\techo \"\t<td class='vncell' valign='top' align='left'>\\n\";\r\n\t\t\t\t\techo \tescape($row['Company']).\"&nbsp;\\n\";\r\n\t\t\t\t\techo \"\t</td>\\n\";\r\n\t\t\t\t\techo \"\t<td class='vncell' valign='top' align='left'>\\n\";\r\n\t\t\t\t\techo \t\tescape($row['EmailAddress']).\"&nbsp;\\n\";\r\n\t\t\t\t\techo \"\t</td>\\n\";\r\n\t\t\t\t\techo \"\t<td class='vncell' valign='top' align='left'>\\n\";\r\n\t\t\t\t\techo \t\tescape($row['Web Page']).\"&nbsp;\\n\";\r\n\t\t\t\t\techo \"\t</td>\\n\";\r\n\t\t\t\t\techo \"</tr>\\n\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\techo \"</table>\\n\";\r\n\r\n\t\t//include the footer\r\n\t\t\trequire_once \"resources/footer.php\";\r\n\r\n\t\t//end the script\r\n\t\t\texit;\r\n\t}\r\n\r\n\r\n//upload the destination csv\r\n\tif (file_exists($_SESSION['file']) && $action == 'delete') {\r\n\r\n\t\t//form to match the fields to the column names\r\n\t\t\t//require_once \"resources/header.php\";\r\n\r\n\t\t//user selected fields\r\n\t\t\t$fields = $_POST['fields'];\r\n\t\t\t$domain_uuid = $_POST['domain_uuid'];\r\n\t\t\t$destination_type = $_POST['destination_type'];\r\n\t\t\t$destination_context = $_POST['destination_context'];\r\n\t\t\t$destination_enabled = $_POST['destination_enabled'];\r\n\r\n\t\t//set the domain_uuid\r\n\t\t\t$domain_uuid = $_SESSION['domain_uuid'];\r\n\r\n\t\t//get the contents of the csv file and convert them into an array\r\n\t\t\t$handle = @fopen($_SESSION['file'], \"r\");\r\n\t\t\tif ($handle) {\r\n\t\t\t\t//set the starting identifiers\r\n\t\t\t\t\t$row_id = 0;\r\n\t\t\t\t\t$dialplan_id = 0;\r\n\t\t\t\t\t$row_number = 1;\r\n\r\n\t\t\t\t//loop through the array\r\n\t\t\t\t\twhile (($line = fgets($handle, 4096)) !== false) {\r\n\t\t\t\t\t\tif ($from_row <= $row_number) {\r\n\r\n\t\t\t\t\t\t\t//format the data\r\n\t\t\t\t\t\t\t\t$y = 0;\r\n\t\t\t\t\t\t\t\tforeach ($fields as $key => $value) {\r\n\t\t\t\t\t\t\t\t\t//get the line\r\n\t\t\t\t\t\t\t\t\t$result = str_getcsv($line, $delimiter, $enclosure);\r\n\r\n\t\t\t\t\t\t\t\t\t//get the table and field name\r\n\t\t\t\t\t\t\t\t\t$field_array = explode(\".\",$value);\r\n\t\t\t\t\t\t\t\t\t$table_name = $field_array[0];\r\n\t\t\t\t\t\t\t\t\t$field_name = $field_array[1];\r\n\t\t\t\t\t\t\t\t\t//echo \"value: $value<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t//echo \"table_name: $table_name<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t//echo \"field_name: $field_name<br />\\n\";\r\n\r\n\t\t\t\t\t\t\t\t\t//get the parent table name\r\n\t\t\t\t\t\t\t\t\t$parent = get_parent($schema, $table_name);\r\n\r\n\t\t\t\t\t\t\t\t\t//remove formatting from the phone number\r\n\t\t\t\t\t\t\t\t\tif ($field_name == \"phone_number\") {\r\n\t\t\t\t\t\t\t\t\t\t$result[$key] = preg_replace('{\\D}', '', $result[$key]);\r\n\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t//build the data array\r\n\t\t\t\t\t\t\t\t\tif (strlen($table_name) > 0) {\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($parent) == 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$table_name][$row_id]['domain_uuid'] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$table_name][$row_id][$field_name] = $result[$key];\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$parent][$row_id][$table_name][$y]['domain_uuid'] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t$array[$parent][$row_id][$table_name][$y][$field_name] = $result[$key];\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t//get the destination_number\r\n\t\t\t\t\t\t\t\t\tif ($key === 'destination_number') { $destination_number = $result[$key]; }\r\n\t\t\t\t\t\t\t\t\tif ($key === 'destination_uuid') { $destination_uuid = $result[$key]; }\r\n\t\t\t\t\t\t\t\t\tif ($key === 'dialplan_uuid') { $destination_uuid = $result[$key]; }\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t//delete the destinations\r\n\t\t\t\t\t\t\t\t$row_number = 0;\r\n\t\t\t\t\t\t\t\tforeach ($array['destinations'] as $row) {\r\n\t\t\t\t\t\t\t\t\t//get the values\r\n\t\t\t\t\t\t\t\t\t\t$domain_uuid = $row['domain_uuid'];\r\n\t\t\t\t\t\t\t\t\t\t$destination_number = $row['destination_number'];\r\n\r\n\t\t\t\t\t\t\t\t\t//get the dialplan uuid\r\n\t\t\t\t\t\t\t\t\t\tif (strlen($row['destination_number']) == 0 || strlen($row['dialplan_uuid']) == 0 ) {\r\n\t\t\t\t\t\t\t\t\t\t\t$sql = \"select * from v_destinations \";\r\n\t\t\t\t\t\t\t\t\t\t\t$sql .= \"where domain_uuid = :domain_uuid \";\r\n\t\t\t\t\t\t\t\t\t\t\t$sql .= \"and destination_number = :destination_number; \";\r\n\t\t\t\t\t\t\t\t\t\t\t//echo $sql.\"<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t\t\t$parameters['domain_uuid'] = $domain_uuid;\r\n\t\t\t\t\t\t\t\t\t\t\t$parameters['destination_number'] = $destination_number;\r\n\t\t\t\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t\t\t\t$destinations = $database->select($sql, $parameters, 'all');\r\n\t\t\t\t\t\t\t\t\t\t\t$row = $destinations[0];\r\n\r\n\t\t\t\t\t\t\t\t\t\t//add to the array\r\n\t\t\t\t\t\t\t\t\t\t\t//$array['destinations'][$row_id] = $destinations[0];\r\n\t\t\t\t\t\t\t\t\t\t\t$array['destinations'][$row_id]['destination_uuid'] = $destinations[0]['destination_uuid'];\r\n\t\t\t\t\t\t\t\t\t\t\tif (strlen($row['dialplan_uuid']) > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t$array['destinations'][$row_id]['dialplan_uuid'] = $destinations[0]['dialplan_uuid'];\r\n\t\t\t\t\t\t\t\t\t\t\t\t//$array['dialplans'][$row_id]['dialplan_uuid'] = $destinations[0]['dialplan_uuid'];\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t} //foreach\r\n\r\n\t\t\t\t\t\t} //if ($from_row <= $row_number)\r\n\t\t\t\t\t\t$row_number++;\r\n\r\n\t\t\t\t\t//process a chunk of the array\r\n\t\t\t\t\t\tif ($row_id === 1000) {\r\n\t\t\t\t\t\t\t//delete the destinations\r\n\t\t\t\t\t\t\t$row_number = 0;\r\n\t\t\t\t\t\t\tforeach ($array['destinations'] as $row) {\r\n\t\t\t\t\t\t\t\t//delete the dialplan\r\n\t\t\t\t\t\t\t\tif (strlen($row['dialplan_uuid']) > 0) {\r\n\t\t\t\t\t\t\t\t\t$sql = \"delete from v_dialplan_details \";\r\n\t\t\t\t\t\t\t\t\t$sql .= \"where dialplan_uuid = :dialplan_uuid \";\r\n\t\t\t\t\t\t\t\t\t//echo \"$sql<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t$parameters['dialplan_uuid'] = $row['dialplan_uuid'];\r\n\t\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t\t$database->execute($sql, $parameters);\r\n\r\n\t\t\t\t\t\t\t\t\t$sql = \"delete from v_dialplans \";\r\n\t\t\t\t\t\t\t\t\t$sql .= \"where dialplan_uuid = :dialplan_uuid \";\r\n\t\t\t\t\t\t\t\t\t//echo \"$sql<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t$parameters['dialplan_uuid'] = $row['dialplan_uuid'];\r\n\t\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t\t$database->execute($sql, $parameters);\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t//delete the destinations\r\n\t\t\t\t\t\t\t\tif (strlen($row['destination_uuid']) > 0) {\r\n\t\t\t\t\t\t\t\t\t$sql = \"delete from v_destinations \";\r\n\t\t\t\t\t\t\t\t\t$sql .= \"where destination_uuid = :destination_uuid \";\r\n\t\t\t\t\t\t\t\t\t//echo \"$sql<br />\\n\";\r\n\t\t\t\t\t\t\t\t\t$parameters['destination_uuid'] = $row['destination_uuid'];\r\n\t\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t\t$database->execute($sql, $parameters);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t} //foreach\r\n\r\n\t\t\t\t\t\t\t//delete to the data\r\n\t\t\t\t\t\t\t//$database = new database;\r\n\t\t\t\t\t\t\t//$database->app_name = 'destinations';\r\n\t\t\t\t\t\t\t//$database->app_uuid = '5ec89622-b19c-3559-64f0-afde802ab139';\r\n\t\t\t\t\t\t\t//$database->delete($array);\r\n\t\t\t\t\t\t\t//$message = $database->message;\r\n\r\n\t\t\t\t\t\t\t//clear the array\r\n\t\t\t\t\t\t\tunset($array);\r\n\r\n\t\t\t\t\t\t\t//set the row id back to 0\r\n\t\t\t\t\t\t\t$row_id = 0;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t//increment row id\r\n\t\t\t\t\t\t\t$row_id++;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfclose($handle);\r\n\r\n\t\t\t\t//delete the remaining destinations\r\n\t\t\t\t\tif ($row_id < 1000) {\r\n\t\t\t\t\t\tforeach ($array['destinations'] as $row) {\r\n\t\t\t\t\t\t\t//delete the dialplan\r\n\t\t\t\t\t\t\tif (strlen($row['dialplan_uuid']) > 0) {\r\n\t\t\t\t\t\t\t\t$sql = \"delete from v_dialplan_details \";\r\n\t\t\t\t\t\t\t\t$sql .= \"where dialplan_uuid = :dialplan_uuid \";\r\n\t\t\t\t\t\t\t\t//echo \"$sql<br />\\n\";\r\n\t\t\t\t\t\t\t\t$parameters['dialplan_uuid'] = $row['dialplan_uuid'];\r\n\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t$database->execute($sql, $parameters);\r\n\r\n\t\t\t\t\t\t\t\t$sql = \"delete from v_dialplans \";\r\n\t\t\t\t\t\t\t\t$sql .= \"where dialplan_uuid = :dialplan_uuid \";\r\n\t\t\t\t\t\t\t\t//echo \"$sql<br />\\n\";\r\n\t\t\t\t\t\t\t\t$parameters['dialplan_uuid'] = $row['dialplan_uuid'];\r\n\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t$database->execute($sql, $parameters);\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t//delete the destinations\r\n\t\t\t\t\t\t\tif (strlen($row['destination_uuid']) > 0) {\r\n\t\t\t\t\t\t\t\t$sql = \"delete from v_destinations \";\r\n\t\t\t\t\t\t\t\t$sql .= \"where destination_uuid = :destination_uuid \";\r\n\t\t\t\t\t\t\t\t//echo \"$sql<br />\\n\";\r\n\t\t\t\t\t\t\t\t$parameters['destination_uuid'] = $row['destination_uuid'];\r\n\t\t\t\t\t\t\t\t$database = new database;\r\n\t\t\t\t\t\t\t\t$database->execute($sql, $parameters);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} //foreach\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t//debug info\r\n\t\t\t\t\t//echo \"<pre>\\n\";\r\n\t\t\t\t\t//print_r($array);\r\n\t\t\t\t\t//echo \"</pre>\\n\";\r\n\t\t\t\t\t//exit;\r\n\r\n\t\t\t\t//save to the data\r\n\t\t\t\t\t//if (is_array($array)) {\r\n\t\t\t\t\t//\t$database = new database;\r\n\t\t\t\t\t//\t$database->app_name = 'destinations';\r\n\t\t\t\t\t//\t$database->app_uuid = '5ec89622-b19c-3559-64f0-afde802ab139';\r\n\t\t\t\t\t//\t$database->delete($array);\r\n\t\t\t\t\t//\t//$message = $database->message;\r\n\t\t\t\t\t//}\r\n\r\n\t\t\t\t//send the redirect header\r\n\t\t\t\t\theader(\"Location: /app/destinations/destinations.php\");\r\n\t\t\t\t\treturn;\r\n\t\t\t}\r\n\t}\r\n\r\n//match the column names to the field names\r\n\tif (strlen($delimiter) > 0 && file_exists($_SESSION['file']) && ($action !== 'add' or $action !== 'delete')) {\r\n\r\n\t\t//form to match the fields to the column names\r\n\t\t\trequire_once \"resources/header.php\";\r\n\r\n\t\t\techo \"<form action='' method='POST' enctype='multipart/form-data' name='frmUpload' onSubmit=''>\\n\";\r\n\t\t\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\r\n\r\n\t\t\techo \"\t<tr>\\n\";\r\n\t\t\techo \"\t<td valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\techo \"\t\t<b>\".$text['header-destination_import'].\"</b><br />\\n\";\r\n\t\t\techo \"\t</td>\\n\";\r\n\t\t\techo \"\t<td valign='top' align='right'>\\n\";\r\n\t\t\techo \"\t\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='/app/destinations/destinations.php'\\\" value='\".$text['button-back'].\"'>\\n\";\r\n\t\t\techo \"\t\t<input name='submit' type='submit' class='btn' id='import' value=\\\"\".$text['button-import'].\"\\\">\\n\";\r\n\t\t\techo \"\t</td>\\n\";\r\n\t\t\techo \"\t</tr>\\n\";\r\n\t\t\techo \"\t<tr>\\n\";\r\n\t\t\techo \"\t<td colspan='2' align='left'>\\n\";\r\n\t\t\techo \"\t\t\".$text['description-destination_import'].\"\\n\";\r\n\t\t\techo \"\t</td>\\n\";\r\n\t\t\techo \"\t</tr>\\n\";\r\n\r\n\t\t\t//echo \"<tr>\\n\";\r\n\t\t\t//echo \"<td align='left' width='30%' nowrap='nowrap'><b>\".$text['header-destinations_import'].\"</b></td>\\n\";\r\n\t\t\t//echo \"<td width='70%' align='right'>\\n\";\r\n\t\t\t//echo \"\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='/app/destinations/destinations.php'\\\" value='\".$text['button-back'].\"'>\\n\";\r\n\t\t\t//echo \"</td>\\n\";\r\n\t\t\t//echo \"</tr>\\n\";\r\n\r\n\t\t\t//loop through user columns\r\n\t\t\t$x = 0;\r\n\t\t\tforeach ($line_fields as $line_field) {\r\n\t\t\t\t$line_field = trim(trim($line_field), $enclosure);\r\n\t\t\t\techo \"<tr>\\n\";\r\n\t\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\t\t//echo \"    \".$text['label-zzz'].\"\\n\";\r\n\t\t\t\techo $line_field;\r\n\t\t\t\techo \"</td>\\n\";\r\n\t\t\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\t\t\techo \"\t\t\t\t<select class='formfld' style='' name='fields[$x]'>\\n\";\r\n\t\t\t\techo \" \t\t\t\t<option value=''></option>\\n\";\r\n\t\t\t\tforeach($schema as $row) {\r\n\t\t\t\t\techo \"\t\t\t<optgroup label='\".$row['table'].\"'>\\n\";\r\n\t\t\t\t\tforeach($row['fields'] as $field) {\r\n\t\t\t\t\t\t$selected = '';\r\n\t\t\t\t\t\tif ($field == $line_field) {\r\n\t\t\t\t\t\t\t$selected = \"selected='selected'\";\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif ($field !== 'domain_uuid') {\r\n\t\t\t\t\t\t\techo \"    \t\t\t<option value='\".escape($row['table']).\".\".$field.\"' \".$selected.\">\".$field.\"</option>\\n\";\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\techo \"\t\t\t</optgroup>\\n\";\r\n\t\t\t\t}\r\n\t\t\t\techo \"\t\t\t\t</select>\\n\";\r\n\t\t\t\t//echo \"<br />\\n\";\r\n\t\t\t\t//echo $text['description-zzz'].\"\\n\";\r\n\t\t\t\techo \"\t\t\t</td>\\n\";\r\n\t\t\t\techo \"\t\t</tr>\\n\";\r\n\t\t\t\t$x++;\r\n\t\t\t}\r\n\r\n\t\t\techo \"<tr>\\n\";\r\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\techo \"\t\".$text['label-destination_type'].\"\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\t\techo \"\t<select class='formfld' name='destination_type' id='destination_type' onchange='type_control(this.options[this.selectedIndex].value);'>\\n\";\r\n\t\t\tswitch ($destination_type) {\r\n\t\t\t\tcase \"inbound\" : \t$selected[1] = \"selected='selected'\";\tbreak;\r\n\t\t\t\tcase \"outbound\" : \t$selected[2] = \"selected='selected'\";\tbreak;\r\n\t\t\t\tcase \"local\" : \t$selected[2] = \"selected='selected'\";\tbreak;\r\n\t\t\t}\r\n\t\t\techo \"\t<option value='inbound' \".$selected[1].\">\".$text['option-inbound'].\"</option>\\n\";\r\n\t\t\techo \"\t<option value='outbound' \".$selected[2].\">\".$text['option-outbound'].\"</option>\\n\";\r\n\t\t\techo \"\t<option value='local' \".$selected[3].\">\".$text['option-local'].\"</option>\\n\";\r\n\t\t\tunset($selected);\r\n\t\t\techo \"\t</select>\\n\";\r\n\t\t\techo \"<br />\\n\";\r\n\t\t\techo $text['description-destination_type'].\"\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"</tr>\\n\";\r\n\t\t\t\r\n\t\t\techo \"<tr>\\n\";\r\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\techo \"\t\".$text['label-destination_record'].\"\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\t\techo \"\t<select class='formfld' name='destination_record' id='destination_record'>\\n\";\r\n\t\t\techo \"\t<option value=''></option>\\n\";\r\n\t\t\tswitch ($destination_record) {\r\n\t\t\t\tcase \"true\" : \t$selected[1] = \"selected='selected'\";\tbreak;\r\n\t\t\t\tcase \"false\" : \t$selected[2] = \"selected='selected'\";\tbreak;\r\n\t\t\t}\r\n\t\t\techo \"\t<option value='true' \".$selected[1].\">\".$text['option-true'].\"</option>\\n\";\r\n\t\t\techo \"\t<option value='false' \".$selected[2].\">\".$text['option-false'].\"</option>\\n\";\r\n\t\t\tunset($selected);\r\n\t\t\techo \"\t</select>\\n\";\r\n\t\t\techo \"<br />\\n\";\r\n\t\t\techo $text['description-destination_record'].\"\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"</tr>\\n\";\r\n\r\n\t\t\t//if (permission_exists('destination_context')) {\r\n\t\t\t\techo \"<tr>\\n\";\r\n\t\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\t\techo \"\t\".$text['label-destination_context'].\"\\n\";\r\n\t\t\t\techo \"</td>\\n\";\r\n\t\t\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\t\t\techo \"\t<input class='formfld' type='text' name='destination_context' id='destination_context' maxlength='255' value=\\\"\".escape($destination_context).\"\\\">\\n\";\r\n\t\t\t\techo \"<br />\\n\";\r\n\t\t\t\techo $text['description-destination_context'].\"\\n\";\r\n\t\t\t\techo \"</td>\\n\";\r\n\t\t\t\techo \"</tr>\\n\";\r\n\t\t\t//}\r\n\r\n\t\t\techo \"<tr>\\n\";\r\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\techo \"\t\".$text['label-actions'].\"\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\t\techo \"\t<select class='formfld' name='action' id='action'>\\n\";\r\n\t\t\techo \"\t<option value='add' selected='selected'>\".$text['label-add'].\"</option>\\n\";\r\n\t\t\techo \"\t<option value='delete'>\".$text['label-delete'].\"</option>\\n\";\r\n\t\t\techo \"\t</select>\\n\";\r\n\t\t\techo \"<br />\\n\";\r\n\t\t\techo $text['description-actions'].\"\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"</tr>\\n\";\r\n\r\n\t\t\tif (permission_exists('destination_domain')) {\r\n\t\t\t\techo \"<tr>\\n\";\r\n\t\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\t\techo \"\t\".$text['label-domain'].\"\\n\";\r\n\t\t\t\techo \"</td>\\n\";\r\n\t\t\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\t\t\techo \"    <select class='formfld' name='domain_uuid' id='destination_domain' onchange='context_control();'>\\n\";\r\n\t\t\t\tif (strlen($domain_uuid) == 0) {\r\n\t\t\t\t\techo \"    <option value='' selected='selected'>\".$text['select-global'].\"</option>\\n\";\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\techo \"    <option value=''>\".$text['select-global'].\"</option>\\n\";\r\n\t\t\t\t}\r\n\t\t\t\tforeach ($_SESSION['domains'] as $row) {\r\n\t\t\t\t\tif ($row['domain_uuid'] == $domain_uuid) {\r\n\t\t\t\t\t\techo \"    <option value='\".escape($row['domain_uuid']).\"' selected='selected'>\".escape($row['domain_name']).\"</option>\\n\";\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\techo \"    <option value='\".escape($row['domain_uuid']).\"'>\".escape($row['domain_name']).\"</option>\\n\";\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\techo \"    </select>\\n\";\r\n\t\t\t\techo \"<br />\\n\";\r\n\t\t\t\techo $text['description-domain_name'].\"\\n\";\r\n\t\t\t\techo \"</td>\\n\";\r\n\t\t\t\techo \"</tr>\\n\";\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\techo \"<input type='hidden' name='domain_uuid' value='\".escape($domain_uuid).\"'>\\n\";\r\n\t\t\t}\r\n\r\n\t\t\techo \"<tr>\\n\";\r\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\t\techo \"\t\".$text['label-destination_enabled'].\"\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\t\techo \"\t<select class='formfld' name='destination_enabled'>\\n\";\r\n\t\t\tswitch ($destination_enabled) {\r\n\t\t\t\tcase \"true\" :\t$selected[1] = \"selected='selected'\";\tbreak;\r\n\t\t\t\tcase \"false\" :\t$selected[2] = \"selected='selected'\";\tbreak;\r\n\t\t\t}\r\n\t\t\techo \"\t<option value='true' \".$selected[1].\">\".$text['label-true'].\"</option>\\n\";\r\n\t\t\techo \"\t<option value='false' \".$selected[2].\">\".$text['label-false'].\"</option>\\n\";\r\n\t\t\tunset($selected);\r\n\t\t\techo \"\t</select>\\n\";\r\n\t\t\techo \"<br />\\n\";\r\n\t\t\techo $text['description-destination_enabled'].\"\\n\";\r\n\t\t\techo \"</td>\\n\";\r\n\t\t\techo \"</tr>\\n\";\r\n\r\n\t\t\techo \"\t\t<tr>\\n\";\r\n\t\t\techo \"\t\t\t<td colspan='2' valign='top' align='right' nowrap='nowrap'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input name='from_row' type='hidden' value='$from_row'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input name='data_delimiter' type='hidden' value='$delimiter'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input name='data_enclosure' type='hidden' value='$enclosure'>\\n\";\r\n\t\t\techo \"\t\t\t\t<input type='submit' class='btn' id='import' value=\\\"\".$text['button-import'].\"\\\">\\n\";\r\n\t\t\techo \"\t\t\t</td>\\n\";\r\n\t\t\techo \"\t\t</tr>\\n\";\r\n\r\n\t\t\techo \"\t</table>\\n\";\r\n\t\t\techo \"</form>\\n\";\r\n\t\t\trequire_once \"resources/footer.php\";\r\n\r\n\t\t//normalize the column names\r\n\t\t\t//$line = strtolower($line);\r\n\t\t\t//$line = str_replace(\"-\", \"_\", $line);\r\n\t\t\t//$line = str_replace($delimiter.\"title\".$delimiter, $delimiter.\"destination_title\".$delimiter, $line);\r\n\t\t\t//$line = str_replace(\"firstname\", \"name_given\", $line);\r\n\t\t\t//$line = str_replace(\"lastname\", \"name_family\", $line);\r\n\t\t\t//$line = str_replace(\"company\", \"organization\", $line);\r\n\t\t\t//$line = str_replace(\"company\", \"destination_email\", $line);\r\n\r\n\t\t//end the script\r\n\t\t\texit;\r\n\t}\r\n\r\n//include the header\r\n\trequire_once \"resources/header.php\";\r\n\r\n//begin the content\r\n\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\r\n\techo \"\t<tr>\\n\";\r\n\techo \"\t<td valign='top' align='left' width='30%' nowrap='nowrap'>\\n\";\r\n\techo \"\t\t<b>\".$text['header-destination_import'].\"</b><br />\\n\";\r\n\techo \"\t\t\".$text['description-destination_import'].\"\\n\";\r\n\techo \"\t</td>\\n\";\r\n\techo \"\t<td valign='top' width='70%' align='right'>\\n\";\r\n\techo \"\t\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='/app/destinations/destinations.php'\\\" value='\".$text['button-back'].\"'>\\n\";\r\n\t//echo \"\t\t<input name='submit' type='submit' class='btn' id='import' value=\\\"\".$text['button-import'].\"\\\">\\n\";\r\n\techo \"\t</td>\\n\";\r\n\techo \"\t</tr>\\n\";\r\n\techo \"</table>\";\r\n\r\n\techo \"<br />\\n\";\r\n\r\n\techo \"<form action='' method='POST' enctype='multipart/form-data' name='frmUpload' onSubmit=''>\\n\";\r\n\techo \"\t<table border='0' cellpadding='0' cellspacing='0' width='100%'>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"    \".$text['label-import_data'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"    <textarea name='data' id='data' rows='7' class='formfld' style='width: 100%;' wrap='off'>$data</textarea>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo $text['description-import_data'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"    \".$text['label-from_row'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"\t\t<select class='formfld' name='from_row'>\\n\";\r\n\t$i=1;\r\n\twhile($i<=99) {\r\n\t\t$selected = ($i == $from_row) ? \"selected\" : null;\r\n\t\techo \"\t\t\t<option value='$i' \".$selected.\">$i</option>\\n\";\r\n\t\t$i++;\r\n\t}\r\n\techo \"\t\t</select>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo $text['description-from_row'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"    \".$text['label-import_delimiter'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"    <select class='formfld' style='width:40px;' name='data_delimiter'>\\n\";\r\n\techo \"    <option value=','>,</option>\\n\";\r\n\techo \"    <option value='|'>|</option>\\n\";\r\n\techo \"    </select>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo $text['description-import_delimiter'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\techo \"<tr>\\n\";\r\n\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\techo \"    \".$text['label-import_enclosure'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"<td class='vtable' align='left'>\\n\";\r\n\techo \"    <select class='formfld' style='width:40px;' name='data_enclosure'>\\n\";\r\n\techo \"    <option value='\\\"'>\\\"</option>\\n\";\r\n\techo \"    <option value=''></option>\\n\";\r\n\techo \"    </select>\\n\";\r\n\techo \"<br />\\n\";\r\n\techo $text['description-import_enclosure'].\"\\n\";\r\n\techo \"</td>\\n\";\r\n\techo \"</tr>\\n\";\r\n\r\n\tif (permission_exists('destination_upload')) {\r\n\t\techo \"<tr>\\n\";\r\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap='nowrap'>\\n\";\r\n\t\techo \"\t\t\t\".$text['label-import_file_upload'].\"\\n\";\r\n\t\techo \"</td>\\n\";\r\n\t\techo \"<td class='vtable' align='left'>\\n\";\r\n\t\techo \"\t\t\t<input name='ulfile' type='file' class='formfld fileinput' id='ulfile'>\\n\";\r\n\t\techo \"<br />\\n\";\r\n\t\techo $text['description-import_file_upload'].\"\\n\";\r\n\t\techo \"</td>\\n\";\r\n\t\techo \"</tr>\\n\";\r\n\t}\r\n\r\n\techo \"\t<tr>\\n\";\r\n\techo \"\t\t<td valign='bottom'>\\n\";\r\n\techo \"\t\t</td>\\n\";\r\n\techo \"\t\t<td valign='bottom' align='right' nowrap>\\n\";\r\n\techo \"\t\t\t<input name='type' type='hidden' value='csv'>\\n\";\r\n\techo \"\t\t\t<br />\\n\";\r\n\techo \"\t\t\t<input name='submit' type='submit' class='btn' id='import' value=\\\"\".$text['button-import'].\"\\\">\\n\";\r\n\techo \"\t\t</td>\\n\";\r\n\techo \"\t</tr>\\n\";\r\n\techo \"\t</table>\\n\";\r\n\techo \"<br><br>\";\r\n\techo \"</form>\";\r\n\r\n//include the footer\r\n\trequire_once \"resources/footer.php\";\r\n\r\n?>\r\n"], "filenames": ["app/destinations/destination_imports.php"], "buggy_code_start_loc": [470], "buggy_code_end_loc": [941], "fixing_code_start_loc": [470], "fixing_code_end_loc": [941], "type": "CWE-79", "message": "In FusionPBX up to 4.5.7, the file app\\destinations\\destination_imports.php uses an unsanitized \"query_string\" variable coming from the URL, which is reflected on 2 occasions in HTML, leading to XSS.", "other": {"cve": {"id": "CVE-2019-16976", "sourceIdentifier": "cve@mitre.org", "published": "2019-10-23T15:15:13.827", "lastModified": "2019-10-28T13:09:17.897", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In FusionPBX up to 4.5.7, the file app\\destinations\\destination_imports.php uses an unsanitized \"query_string\" variable coming from the URL, which is reflected on 2 occasions in HTML, leading to XSS."}, {"lang": "es", "value": "En FusionPBX versiones hasta 4.5.7, el archivo app\\destinations\\destination_imports.php utiliza una variable \"query_string\" no saneada que proviene de la URL, que es reflejada en 2 ocasiones en HTML, lo que conlleva a una vulnerabilidad de tipo XSS."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:fusionpbx:fusionpbx:*:*:*:*:*:*:*:*", "versionEndIncluding": "4.5.7", "matchCriteriaId": "A5A0C1F9-8032-46C6-8DD4-DB91FACF7330"}]}]}], "references": [{"url": "https://github.com/fusionpbx/fusionpbx/commit/d6ea02d896b2c57dec491ee3b36ec102639270be", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://resp3ctblog.wordpress.com/2019/10/19/fusionpbx-xss-9/", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/fusionpbx/fusionpbx/commit/d6ea02d896b2c57dec491ee3b36ec102639270be"}}