{"buggy_code": ["<?php\ndefined('is_running') or die('Not an entry point...');\n\nincludeFile('tool/editing.php');\n\nclass editing_page extends display{\n\n\n\tfunction editing_page($title,$type){\n\t\tparent::display($title,$type);\n\t}\n\n\tfunction RunScript(){\n\t\tglobal $langmessage,$page;\n\t\t$cmd = common::GetCommand();\n\n\t\t//prevent overwriting the content to maintain overlay editin links\n\t\t//$page->ajaxReplace = array();\n\n\t\tif( !$this->SetVars() ){\n\t\t\treturn;\n\t\t}\n\n\t\t$this->GetFile();\n\n\t\t//original alpha versions of 1.8 didn't maintain the file_type\n\t\tif( !isset($this->meta_data['file_type']) ){\n\t\t\t$this->ResetFileTypes();\n\t\t}\n\n\n\t\t//admin toolbar links\n\t\t$menu_permissions = admin_tools::HasPermission('Admin_Menu');\n\t\t$can_edit = admin_tools::CanEdit($this->gp_index);\n\t\tif( $menu_permissions ){\n\t\t\t$page->admin_links[] = common::Link($this->title,$langmessage['rename/details'],'cmd=renameform','data-cmd=\"gpajax\"');\n\n\t\t\t// Having the layout link here complicates things.. would need layout link for special pages\n\t\t\t$page->admin_links[] = common::Link('Admin_Menu',$langmessage['current_layout'],'cmd=layout&from=page&index='.urlencode($this->gp_index),array('title'=>$langmessage['current_layout'],'data-cmd'=>'gpabox'));\n\t\t\t$page->admin_links[] = common::Link('Admin_Menu',$langmessage['Copy'],'cmd=copypage&redir=redir&title='.urlencode($this->title),array('title'=>$langmessage['Copy'],'data-cmd'=>'gpabox'));\n\t\t}\n\n\t\tif( admin_tools::HasPermission('Admin_User') ){\n\t\t\t$page->admin_links[] = common::Link('Admin_Users',$langmessage['permissions'],'cmd=file_permissions&index='.urlencode($this->gp_index),array('title'=>$langmessage['permissions'],'data-cmd'=>'gpabox'));\n\t\t}\n\n\t\tif( $can_edit ){\n\t\t\t$page->admin_links[] = common::Link($this->title,$langmessage['Revision History'],'cmd=view_history',array('title'=>$langmessage['Revision History'],'data-cmd'=>'gpabox'));\n\t\t}\n\n\n\t\tif( $menu_permissions ){\n\t\t\t$page->admin_links[] = common::Link('Admin_Menu',$langmessage['delete_file'],'cmd=trash_page&index='.urlencode($this->gp_index),array('data-cmd'=>'postlink','title'=>$langmessage['delete_page'],'class'=>'gpconfirm'));\n\n\t\t}\n\n\n\t\t//allow addons to effect page actions and how a page is displayed\n\t\t$cmd_after = gpPlugin::Filter('PageRunScript',array($cmd));\n\t\tif( $cmd !== $cmd_after ){\n\t\t\t$cmd = $cmd_after;\n\t\t\tif( $cmd === 'return' ){\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\t//admin actions\n\t\tif( $menu_permissions ){\n\t\t\tswitch($cmd){\n\t\t\t\t// rename & details\n\t\t\t\tcase 'renameform':\n\t\t\t\t\t$this->RenameForm();\n\t\t\t\treturn;\n\t\t\t\tcase 'renameit':\n\t\t\t\t\tif( $this->RenameFile() ){\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\n\t\t//file editing actions\n\t\tif( $can_edit ){\n\n\t\t\tswitch($cmd){\n\n\t\t\t\tcase 'new_dir':\n\t\t\t\t\t$this->NewDirForm();\n\t\t\t\treturn;\n\n\t\t\t\t//section editing\n\t\t\t\tcase 'move_up':\n\t\t\t\t\t$this->MoveUp();\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'new_section':\n\t\t\t\t\t$this->NewSectionPrompt();\n\t\t\t\treturn;\n\n\t\t\t\tcase 'add_section':\n\t\t\t\t\t$this->AddNewSection();\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'rm_section':\n\t\t\t\t\t$this->RmSection();\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'save':\n\t\t\t\t\t$this->SaveSection();\n\t\t\t\treturn;\n\n\t\t\t\tcase 'rawcontent':\n\t\t\t\t\t$this->RawContent();\n\t\t\t\tbreak;\n\n\n\t\t\t\t/* gallery editing */\n\t\t\t\tcase 'gallery_folder':\n\t\t\t\tcase 'gallery_images':\n\t\t\t\t\t$this->GalleryImages();\n\t\t\t\treturn;\n\n\t\t\t\t/* include editing */\n\t\t\t\tcase 'preview':\n\t\t\t\t\t$this->PreviewSection();\n\t\t\t\treturn;\n\t\t\t\tcase 'include_dialog':\n\t\t\t\t\t$this->IncludeDialog();\n\t\t\t\treturn;\n\n\t\t\t\t/* inline editing */\n\t\t\t\tcase 'inlineedit':\n\t\t\t\t\t$this->InlineEdit();\n\t\t\t\tdie();\n\n\t\t\t\t/* revision history */\n\t\t\t\tcase 'view_revision':\n\t\t\t\t\t$this->ViewRevision();\n\t\t\t\treturn;\n\t\t\t\tcase 'use_revision':\n\t\t\t\t\t$this->UseRevision();\n\t\t\t\tbreak;\n\t\t\t\tcase 'view_history';\n\t\t\t\t\t$this->ViewHistory();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\t$this->contentBuffer = $this->GenerateContent_Admin();\n\t}\n\n\tfunction InlineEdit(){\n\t\t$section = $_REQUEST['section'];\n\t\tif( !is_numeric($section) || !isset($this->file_sections[$section])){\n\t\t\techo 'false';\n\t\t\treturn false;\n\t\t}\n\n\t\tincludeFile('tool/ajax.php');\n\t\tgpAjax::InlineEdit($this->file_sections[$section]);\n\t}\n\n\t/*\n\t * Send the raw content of the section to the gpResponse handler\n\t *\n\t */\n\tfunction RawContent(){\n\t\tglobal $page,$langmessage;\n\n\t\t//for ajax responses\n\t\t$page->ajaxReplace = array();\n\n\t\t$section = $_REQUEST['section'];\n\t\tif( !is_numeric($section) ){\n\t\t\tmessage($langmessage['OOPS'].'(1)');\n\t\t\treturn false;\n\t\t}\n\n\t\tif( !isset($this->file_sections[$section]) ){\n\t\t\tmessage($langmessage['OOPS'].'(1)');\n\t\t\treturn false;\n\t\t}\n\n\t\t$page->ajaxReplace[] = array('rawcontent','',$this->file_sections[$section]['content']);\n\t}\n\n\n\t/**\n\t * Recalculate the file_type string for this file\n\t * Used by AddNewSection(), RmSection()\n\t * Updates $this->meta_data and $gp_titles\n\t *\n\t */\n\tfunction ResetFileTypes($save = true){\n\t\tglobal $gp_titles;\n\n\t\t$original_types = array();\n\t\tif( isset($this->meta_data['file_type']) ){\n\t\t\t$original_types = explode(',',$this->meta_data['file_type']);\n\t\t}\n\n\t\t$new_types = array();\n\t\tforeach($this->file_sections as $section){\n\t\t\t$new_types[] = $section['type'];\n\t\t}\n\t\t$new_types = array_unique($new_types);\n\t\t$new_types = array_diff($new_types,array(''));\n\t\tsort($new_types);\n\n\t\t$new_types = implode(',',$new_types);\n\t\t$this->meta_data['file_type'] = $new_types;\n\n\t\tif( !isset($gp_titles[$this->gp_index]) ){\n\t\t\treturn;\n\t\t}\n\n\t\t$gp_titles[$this->gp_index]['type'] = $new_types;\n\t\tadmin_tools::SavePagesPHP();\n\t\tif( $save ){\n\t\t\t$this->SaveThis();\n\t\t}\n\t}\n\n\tfunction RenameFile(){\n\t\tglobal $langmessage, $gp_index, $page;\n\n\t\tincludeFile('tool/Page_Rename.php');\n\t\t$new_title = gp_rename::RenameFile($this->title);\n\t\tif( ($new_title !== false) && $new_title != $this->title ){\n\t\t\tmessage(sprintf($langmessage['will_redirect'],common::Link_Page($new_title)));\n\t\t\t$page->head .= '<meta http-equiv=\"refresh\" content=\"15;url='.common::GetUrl($new_title).'\">';\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\n\tfunction RenameForm(){\n\t\tglobal $page,$gp_index;\n\n\t\tincludeFile('tool/Page_Rename.php');\n\t\t$action = common::GetUrl($this->title);\n\t\tgp_rename::RenameForm($this->title,$action);\n\t}\n\n\n\tfunction MoveUp(){\n\t\tglobal $langmessage;\n\n\n\t\t$move_key =& $_REQUEST['section'];\n\t\tif( !isset($this->file_sections[$move_key]) ){\n\t\t\tmessage($langmessage['OOPS']);\n\t\t\treturn false;\n\t\t}\n\n\t\tif( !common::verify_nonce('move_up'.$move_key) ){\n\t\t\tmessage($langmessage['OOPS']);\n\t\t\treturn false;\n\t\t}\n\n\n\t\t$move_content = $this->file_sections[$move_key];\n\n\t\t$file_keys = array_keys($this->file_sections);\n\t\t$file_values = array_values($this->file_sections);\n\t\t$insert_key = array_search($move_key,$file_keys);\n\t\tif( ($insert_key === null) || ($insert_key === false) || ($insert_key === 0) ){\n\t\t\tmessage($langmessage['OOPS']);\n\t\t\treturn false;\n\t\t}\n\n\t\t$prev_key = $insert_key-1;\n\n\t\tif( !isset($file_keys[$prev_key]) ){\n\t\t\tmessage($langmessage['OOPS']);\n\t\t\treturn false;\n\t\t}\n\n\t\t$old_sections = $this->file_sections;\n\n\t\t//rebuild\n\t\t$new_sections = array();\n\t\tforeach($file_values as $temp_key => $file_value){\n\n\t\t\tif( $temp_key === $prev_key ){\n\t\t\t\t$new_sections[] = $move_content;\n\t\t\t}elseif( $temp_key === $insert_key ){\n\t\t\t\t//moved section\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\t$new_sections[] = $file_value;\n\t\t}\n\n\t\t$this->file_sections = $new_sections;\n\n\t\tif( !$this->SaveThis() ){\n\t\t\t$this->file_sections = $old_sections;\n\t\t\tmessage($langmessage['OOPS'].'(4)');\n\t\t\treturn;\n\t\t}\n\t}\n\n\t/**\n\t * Remove a content area from a page\n\t *\n\t */\n\tfunction RmSection(){\n\t\tglobal $langmessage,$page;\n\n\t\tif( !isset($_POST['total']) || $_POST['total'] != count($this->file_sections) ){\n\t\t\tmessage($langmessage['OOPS']);\n\t\t\treturn false;\n\t\t}\n\n\t\tif( !isset($_POST['section']) ){\n\t\t\tmessage($langmessage['OOPS'].'(1)');\n\t\t\treturn;\n\t\t}\n\n\t\t$section = $_POST['section'];\n\n\t\tif( !isset($this->file_sections[$section]) ){\n\t\t\tmessage($langmessage['OOPS'].'(2)');\n\t\t\treturn;\n\t\t}\n\n\t\t$section_data = $this->file_sections[$section];\n\n\t\tarray_splice( $this->file_sections , $section , 1 );\n\n\t\t$this->ResetFileTypes(false);\n\n\t\tif( !$this->SaveThis() ){\n\t\t\tmessage($langmessage['OOPS'].'(4)');\n\t\t\treturn;\n\t\t}\n\n\t\tif( $section_data['type'] == 'gallery' ){\n\t\t\t$this->GalleryEdited();\n\t\t}\n\n\t\t//update usage of resized images\n\t\tif( isset($section_data['resized_imgs']) ){\n\t\t\tincludeFile('image.php');\n\t\t\tgp_resized::SetIndex();\n\t\t\tgp_edit::ResizedImageUse($section_data['resized_imgs'],array());\n\t\t}\n\n\t\tmessage($langmessage['SAVED']);\n\t}\n\n\n\t/**\n\t * Add a new section to the page\n\t *\n\t */\n\tfunction AddNewSection(){\n\t\tglobal $langmessage;\n\n\t\tif( $_POST['last_mod'] != $this->fileModTime ){\n\t\t\tmessage($langmessage['OOPS']);\n\t\t\treturn false;\n\t\t}\n\n\t\tif( !isset($_POST['section']) ){\n\t\t\tmessage($langmessage['OOPS'].'(1)');\n\t\t\treturn;\n\t\t}\n\n\t\t$section = $_POST['section'];\n\n\t\tif( !isset($this->file_sections[$section]) ){\n\t\t\tmessage($langmessage['OOPS'].'(2)');\n\t\t\treturn;\n\t\t}\n\n\t\tif( isset($_POST['copy']) ){\n\t\t\t$start_content = $this->file_sections[$section];\n\t\t}else{\n\t\t\t$start_content['type'] = $_POST['content_type'];\n\t\t\t$start_content['content'] = editing_page::GetDefaultContent($start_content['type']);\n\t\t\tif( $start_content['content'] === false ){\n\t\t\t\tmessage($langmessage['OOPS'].'(3)');\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif( isset($_POST['insert']) && $_POST['insert'] == 'before' ){\n\t\t\tarray_splice( $this->file_sections , $section , 0, 'temporary' );\n\t\t\t$new_section = $section;\n\t\t}else{\n\t\t\tarray_splice( $this->file_sections , $section+1 , 0, 'temporary' );\n\t\t\t$new_section = $section+1;\n\t\t}\n\n\t\tif( $this->file_sections[$new_section] != 'temporary' ){\n\t\t\tmessage($langmessage['OOPS'].'(4)');\n\t\t\treturn;\n\t\t}\n\n\n\t\t$this->file_sections[$new_section] = $start_content;\n\n\t\t$this->ResetFileTypes(false);\n\n\t\tif( !$this->SaveThis() ){\n\t\t\tmessage($langmessage['OOPS'].'(4)');\n\t\t\treturn;\n\t\t}\n\n\n\t\tmessage($langmessage['SAVED']);\n\t}\n\n\n\t/**\n\t * Get the default content for the specified content type\n\t *\n\t * @static\n\t *\n\t */\n\tstatic function GetDefaultContent($type){\n\t\tglobal $langmessage;\n\n\t\tswitch($type){\n\t\t\tcase 'include':\n\t\t\t\t$default_content = '';\n\t\t\tbreak;\n\n\t\t\tcase 'gallery':\n\t\t\t\t$default_content = '<ul class=\"gp_gallery\"><li class=\"gp_to_remove\"></li></ul>';\n\t\t\tbreak;\n\n\t\t\tcase 'text':\n\t\t\tdefault:\n\t\t\t\t$default_content = '<p>'.$langmessage['New Section'].'</p>';\n\t\t\tbreak;\n\t\t}\n\n\t\t$default_content = gpPlugin::Filter('GetDefaultContent',array($default_content,$type));\n\n\t\treturn $default_content;\n\t}\n\n\t/**\n\t * Display a form for adding a new section to the page\n\t *\n\t */\n\tfunction NewSectionPrompt(){\n\t\tglobal $langmessage;\n\n\n\t\tob_start();\n\t\techo '<div class=\"inline_box\">';\n\t\techo '<form method=\"post\" action=\"'.common::GetUrl($this->title).'\">';\n\t\techo '<h2>'.$langmessage['new_section_about'].'</h2>';\n\n\t\techo '<table class=\"bordered full_width\">';\n\t\techo '<tr><th colspan=\"2\">'.$langmessage['New Section'].'</th></tr>';\n\n\t\techo '<tr><td>';\n\t\techo $langmessage['Content Type'];\n\t\techo '</td><td>';\n\t\tediting_page::SectionTypes();\n\t\techo '</td></tr>';\n\n\t\techo '<tr><td>';\n\t\techo $langmessage['Insert Location'];\n\t\techo '</td><td>';\n\t\techo '<label><input type=\"radio\" name=\"insert\" value=\"before\" /> ';\n\t\techo $langmessage['insert_before'];\n\t\techo '</label>';\n\t\techo '<label><input type=\"radio\" name=\"insert\" value=\"after\" checked=\"checked\" /> ';\n\t\techo $langmessage['insert_after'];\n\t\techo '</label>';\n\t\techo '</td></tr>';\n\n\t\techo '</table>';\n\n\t\techo '<p>';\n\t\techo '<input type=\"hidden\" name=\"last_mod\" value=\"'.$this->fileModTime.'\" />';\n\t\techo '<input type=\"hidden\" name=\"section\" value=\"'.$_GET['section'].'\" />';\n\t\techo '<input type=\"hidden\" name=\"cmd\" value=\"add_section\" />';\n\t\techo '<input type=\"submit\" name=\"\" value=\"'.$langmessage['save'].'\" class=\"gpsubmit\"/>';\n\t\techo ' <input type=\"button\" name=\"\" value=\"'.$langmessage['cancel'].'\" class=\"admin_box_close gpcancel\" />';\n\t\techo '</p>';\n\n\n\t\techo '</form>';\n\t\techo '</div>';\n\t\t$this->contentBuffer = ob_get_clean();\n\n\t}\n\n\t/*\n\t * @static\n\t */\n\tstatic function SectionTypes(){\n\t\tglobal $langmessage;\n\t\t$section_types['text']['label']\t\t= $langmessage['editable_text'];\n\t\t$section_types['gallery']['label']\t= $langmessage['Image Gallery'];\n\t\t$section_types['include']['label']\t= $langmessage['File Include'];\n\n\t\t$section_types = gpPlugin::Filter('SectionTypes',array($section_types));\n\n\t\t$checked = 'checked=\"checked\"';\n\t\tforeach($section_types as $type => $type_info){\n\t\t\techo '<label>';\n\t\t\techo '<input type=\"radio\" name=\"content_type\" value=\"'.htmlspecialchars($type).'\" '.$checked.'/> ';\n\t\t\techo htmlspecialchars($type_info['label']);\n\t\t\techo '</label>';\n\t\t\t$checked = '';\n\t\t}\n\t}\n\n\n\tfunction PreviewSection(){\n\t\tglobal $page,$langmessage;\n\n\t\t//for ajax responses\n\t\t$page->ajaxReplace = array();\n\n\t\t$section = $_POST['section'];\n\t\tif( !is_numeric($section) ){\n\t\t\tmessage($langmessage['OOPS'].'(1)');\n\t\t\treturn false;\n\t\t}\n\n\t\tif( !isset($this->file_sections[$section]) ){\n\t\t\tmessage($langmessage['OOPS'].'(1)');\n\t\t\treturn false;\n\t\t}\n\n\t\t$type = $this->file_sections[$section]['type'];\n\n\n\t\tswitch($type){\n\t\t\tcase 'include':\n\t\t\t\t$data = array();\n\t\t\t\t$data['type'] = $type;\n\t\t\t\tif( !empty($_POST['gadget_include']) ){\n\t\t\t\t\t$data['include_type'] = 'gadget';\n\t\t\t\t\t$data['content'] = $_POST['gadget_include'];\n\t\t\t\t}else{\n\t\t\t\t\t$data['content'] = $_POST['file_include'];\n\t\t\t\t}\n\n\n\t\t\t\tincludeFile('tool/SectionContent.php');\n\t\t\t\t$content = section_content::RenderSection($data,$section,$this->title,$this->file_stats);\n\t\t\t\t$page->ajaxReplace[] = array('gp_include_content','',$content);\n\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tmessage($langmessage['OOPS'].'(2)');\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tfunction SaveSection(){\n\t\tglobal $page,$langmessage;\n\n\t\t//for ajax responses\n\t\t$page->ajaxReplace = array();\n\n\n\t\t//check\n\t\t$section =& $_POST['section'];\n\t\tif( !is_numeric($section) ){\n\t\t\tmessage($langmessage['OOPS'].'(1)');\n\t\t\treturn false;\n\t\t}\n\n\t\tif( !isset($this->file_sections[$section]) ){\n\t\t\tmessage($langmessage['OOPS'].'(1)');\n\t\t\treturn false;\n\t\t}\n\n\t\t$type = $this->file_sections[$section]['type'];\n\t\t$check_before = serialize($this);\n\t\t$check_before = sha1( $check_before ) . md5( $check_before );\n\n\t\t$save_this = false;\n\t\tswitch($type){\n\t\t\tcase 'text':\n\t\t\t\t$save_this = true;\n\t\t\t\t$this->SaveSection_Text($section);\n\t\t\tbreak;\n\t\t\tcase 'gallery':\n\t\t\t\t$save_this = true;\n\t\t\t\t$this->SaveSection_Text($section);\n\t\t\t\t$this->GalleryEdited();\n\t\t\tbreak;\n\t\t\tcase 'include':\n\t\t\t\t$save_this = $this->SaveSection_Include($section);\n\t\t\tbreak;\n\t\t}\n\n\t\t$save_this = gpPlugin::Filter('SaveSection',array($save_this,$section,$type));\n\t\tif( $save_this !== true ){\n\t\t\tmessage($langmessage['OOPS'].'(2)');\n\t\t\treturn false;\n\t\t}\n\n\t\t//save if the file was changed\n\t\t$check_after = serialize($this);\n\t\t$check_after = sha1( $check_after ) . md5( $check_after );\n\t\tif( $check_before != $check_after ){\n\t\t\tif( !$this->SaveThis() ){\n\t\t\t\tmessage($langmessage['OOPS'].'(3)');\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\t$page->ajaxReplace[] = array('ck_saved','','');\n\t\tmessage($langmessage['SAVED']);\n\t\treturn true;\n\t}\n\n\tfunction SaveThis(){\n\n\t\tif( !is_array($this->meta_data) || !is_array($this->file_sections) ){\n\t\t\treturn false;\n\t\t}\n\n\t\t//file count\n\t\tif( !isset($this->meta_data['file_number']) ){\n\t\t\t$this->meta_data['file_number'] = gpFiles::NewFileNumber();\n\t\t}\n\t\t$this->SaveBackup(); //make a backup of the page file\n\n\t\treturn gpFiles::SaveArray($this->file,'meta_data',$this->meta_data,'file_sections',$this->file_sections);\n\t}\n\n\t/**\n\t *\tSave a backup of the file\n\t *\n\t */\n\tfunction SaveBackup(){\n\t\tglobal $dataDir;\n\n\t\t$dir = $dataDir.'/data/_backup/pages/'.$this->gp_index;\n\t\tgpFiles::CheckDir($dir);\n\n\t\t$time = time();\n\t\tif( isset($_REQUEST['revision']) && is_numeric($_REQUEST['revision']) ){\n\t\t\t$time = $_REQUEST['revision'];\n\t\t}\n\n\t\t$contents = file_get_contents( $this->file );\n\n\t\t//backup file name\n\t\t$len = strlen($contents);\n\t\t$backup_file = $dir.'/'.$time.'.'.$len;\n\n\t\t//compress\n\t\tif( function_exists('gzencode') && function_exists('readgzfile') ){\n\t\t\t$backup_file .= '.gze';\n\t\t\t$contents = gzencode($contents,9);\n\t\t}\n\n\t\tgpFiles::Save( $backup_file, $contents );\n\t\t$this->CleanBackupFolder();\n\t}\n\n\n\t/**\n\t * Reduce the number of files in the backup folder\n\t *\n\t */\n\tfunction CleanBackupFolder(){\n\t\tglobal $dataDir;\n\t\t$files = $this->BackupFiles();\n\t\t$file_count = count($files);\n\t\tif( $file_count <= gp_backup_limit ){\n\t\t\treturn;\n\t\t}\n\t\t$delete_count = $file_count - gp_backup_limit;\n\t\t$files = array_splice( $files, 0, $delete_count );\n\t\tforeach($files as $file){\n\t\t\t$full_path = $dataDir.'/data/_backup/pages/'.$this->gp_index.'/'.$file;\n\t\t\tunlink($full_path);\n\t\t}\n\t}\n\n\n\t/**\n\t * Display the revision history of the current file\n\t *\n\t */\n\tfunction ViewHistory(){\n\t\tglobal $langmessage;\n\n\t\t$files = $this->BackupFiles();\n\t\tkrsort($files);\n\n\t\tob_start();\n\t\techo '<h2>'.$langmessage['Revision History'].'</h2>';\n\t\techo '<table class=\"bordered full_width\"><tr><th>'.$langmessage['Modified'].'</th><th>'.$langmessage['File Size'].'</th><th>&nbsp;</th></tr>';\n\t\techo '<tbody>';\n\n\t\t$size = filesize($this->file);\n\t\techo '<tr><td>';\n\t\techo common::date($langmessage['strftime_datetime'],$this->fileModTime);\n\t\techo ' &nbsp; ('.$langmessage['Current Page'].')</td><td>';\n\t\techo admin_tools::FormatBytes($size);\n\t\techo '</td><td>&nbsp;</td></tr>';\n\n\t\t$i = 1;\n\t\tforeach($files as $time => $file){\n\n\t\t\t//get info from filename\n\t\t\t$name = basename($file);\n\t\t\t$parts = explode('.',$name);\n\t\t\t$time = array_shift($parts);\n\t\t\t$size = array_shift($parts);\n\n\t\t\t//output row\n\t\t\techo '<tr class=\"'.($i % 2 ? 'even' : '').'\"><td>';\n\t\t\techo common::date($langmessage['strftime_datetime'],$time);\n\t\t\techo '</td><td>';\n\t\t\tif( $size && is_numeric($size) ){\n\t\t\t\techo admin_tools::FormatBytes($size);\n\t\t\t}\n\t\t\techo '</td><td>';\n\t\t\techo common::Link($this->title,$langmessage['preview'],'cmd=view_revision&time='.$time,'data-cmd=\"cnreq\"');\n\t\t\techo '</td></tr>';\n\t\t\t$i++;\n\t\t}\n\t\techo '</tbody>';\n\t\techo '</table>';\n\t\t$this->contentBuffer = ob_get_clean();\n\t}\n\n\t/**\n\t * Display the contents of a past revision\n\t *\n\t */\n\tfunction ViewRevision(){\n\t\tglobal $langmessage;\n\t\t$time = $_REQUEST['time'];\n\t\t$full_path = $this->BackupFile($time);\n\t\tif( !$full_path ){\n\t\t\treturn false;\n\t\t}\n\n\t\t$file_sections = $file_stats = array();\n\n\t\t//if it's a compressed file, we need an uncompressed version\n\t\tif( strpos($full_path,'.gze') !== false ){\n\t\t\t$dir = common::DirName($full_path);\n\t\t\tob_start();\n\t\t\treadgzfile($full_path);\n\t\t\t$contents = ob_get_clean();\n\t\t\t$full_path = tempnam($dir,'backup');\n\t\t\tgpFiles::Save( $full_path, $contents );\n\t\t\tinclude($full_path);\n\t\t\tunlink($full_path);\n\t\t}else{\n\t\t\tinclude($full_path);\n\t\t}\n\n\t\tincludeFile('tool/SectionContent.php');\n\t\t$this->contentBuffer = section_content::Render($file_sections,$this->title,$file_stats);\n\n\n\t\t$date = common::date($langmessage['strftime_datetime'],$time);\n\t\t$message = sprintf($langmessage['viewing_revision'],$date);\n\t\t$message .= ' <br/> '.common::Link($this->title,$langmessage['Restore this revision'],'cmd=use_revision&time='.$time,'data-cmd=\"cnreq\"');\n\t\t$message .= ' &nbsp; '.common::Link($this->title,$langmessage['Revision History'],'cmd=view_history',array('title'=>$langmessage['Revision History'],'data-cmd'=>'gpabox'));\n\t\tmessage( $message );\n\t}\n\n\t/**\n\t * Revert the file data to a previous revision\n\t *\n\t */\n\tfunction UseRevision(){\n\t\tglobal $langmessage, $page;\n\n\t\t$time = $_REQUEST['time'];\n\t\t$full_path = $this->BackupFile($time);\n\t\tif( !$full_path ){\n\t\t\treturn false;\n\t\t}\n\t\tif( strpos($full_path,'.gze') !== false ){\n\t\t\tob_start();\n\t\t\treadgzfile($full_path);\n\t\t\t$contents = ob_get_clean();\n\t\t}else{\n\t\t\t$contents = file_get_contents($full_path);\n\t\t}\n\n\t\t$this->SaveBackup();\n\t\tgpFiles::Save( $this->file, $contents );\n\t\t$this->GetFile();\n\t\t$this->ResetFileTypes(false);\n\t\tmessage($langmessage['SAVED']);\n\t}\n\n\t/**\n\t * Return a list of the available backup for the current file\n\t *\n\t */\n\tfunction BackupFiles(){\n\t\tglobal $dataDir;\n\t\t$dir = $dataDir.'/data/_backup/pages/'.$this->gp_index;\n\t\tif( !file_exists($dir) ){\n\t\t\treturn array();\n\t\t}\n\t\t$all_files = scandir($dir);\n\t\t$files = array();\n\t\tforeach($all_files as $file){\n\t\t\tif( $file == '.' || $file == '..' ){\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\t$parts = explode('.',$file);\n\t\t\t$time = array_shift($parts);\n\t\t\tif( !is_numeric($time) ){\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\t$files[$time] = $file;\n\t\t}\n\n\t\tksort($files);\n\t\treturn $files;\n\t}\n\n\t/**\n\t * Return the full path of the saved revision if it exists\n\t *\n\t */\n\tfunction BackupFile( $time ){\n\t\tglobal $dataDir;\n\t\t$files = $this->BackupFiles();\n\t\tif( !isset($files[$time]) ){\n\t\t\treturn false;\n\t\t}\n\t\treturn $dataDir.'/data/_backup/pages/'.$this->gp_index.'/'.$files[$time];\n\t}\n\n\n\tfunction SaveSection_Include($section){\n\t\tglobal $page, $langmessage, $gp_index, $config;\n\n\n\t\t$section_data = $this->file_sections[$section];\n\t\tunset($section_data['index']);\n\n\t\tif( !empty($_POST['gadget_include']) ){\n\t\t\t$gadget = $_POST['gadget_include'];\n\t\t\tif( !isset($config['gadgets'][$gadget]) ){\n\t\t\t\tmessage($langmessage['OOPS_TITLE']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t$section_data['include_type'] = 'gadget';\n\t\t\t$section_data['content'] = $gadget;\n\t\t}else{\n\t\t\t$title = $_POST['file_include'];\n\t\t\tif( !isset($gp_index[$title]) ){\n\t\t\t\tmessage($langmessage['OOPS_TITLE']);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\t$section_data['include_type'] = common::SpecialOrAdmin($title);\n\t\t\t$section_data['index'] = $gp_index[$title];\n\t\t\t$section_data['content'] = $title;\n\t\t}\n\n\t\t$this->file_sections[$section] = $section_data;\n\n\t\t//send replacement content\n\t\tincludeFile('tool/SectionContent.php');\n\t\t$content = section_content::RenderSection($section_data,$section,$this->title,$this->file_stats);\n\t\t$page->ajaxReplace[] = array('gp_include_content','',$content);\n\t\treturn true;\n\t}\n\n\n\tfunction SaveSection_Text($section){\n\t\tglobal $config;\n\t\t$content =& $_POST['gpcontent'];\n\t\tgpFiles::cleanText($content);\n\t\t$this->file_sections[$section]['content'] = $content;\n\n\t\tif( $config['resize_images'] ){\n\t\t\tgp_edit::ResizeImages($this->file_sections[$section]['content'],$this->file_sections[$section]['resized_imgs']);\n\t\t}\n\n\t\treturn true;\n\t}\n\n\n\t/**\n\t * Extract information about the gallery from it's html: img_count, icon_src\n\t * Call GalleryEdited when a gallery section is removed, edited\n\t *\n\t */\n\tfunction GalleryEdited(){\n\t\tincludeFile('special/special_galleries.php');\n\t\tspecial_galleries::UpdateGalleryInfo($this->title,$this->file_sections);\n\t}\n\n\tfunction GenerateContent_Admin(){\n\t\tglobal $langmessage,$GP_NESTED_EDIT;\n\n\t\t//add to all pages in case a user adds a gallery\n\t\tgpPlugin::Action('GenerateContent_Admin');\n\t\tincludeFile('tool/SectionContent.php');\n\t\tcommon::ShowingGallery();\n\n\t\t$content = '';\n\t\t$section_num = 0;\n\t\tforeach($this->file_sections as $section_key => $section_data){\n\t\t\t$content .= \"\\n\";\n\t\t\t$type = isset($section_data['type']) ? $section_data['type'] : 'text';\n\n\t\t\tif( gpOutput::ShowEditLink() && admin_tools::CanEdit($this->gp_index) ){\n\n\t\t\t\t$link_name = 'inline_edit_generic';\n\t\t\t\t$link_rel = $type.'_inline_edit';\n\n\n\t\t\t\t$title_attr = sprintf($langmessage['Section %s'],$section_key+1);\n\t\t\t\t$link = gpOutput::EditAreaLink($edit_index,$this->title,$langmessage['edit'],'section='.$section_key.'&amp;revision='.$this->fileModTime,array('title'=>$title_attr,'data-cmd'=>$link_name,'data-arg'=>$link_rel));\n\n\t\t\t\t//section control links\n\t\t\t\tob_start();\n\t\t\t\techo '<span class=\"nodisplay\" id=\"ExtraEditLnks'.$edit_index.'\">';\n\t\t\t\techo $link;\n\n\t\t\t\tif( $section_num > 0 ){\n\t\t\t\t\techo common::Link($this->title,$langmessage['move_up'],'cmd=move_up&section='.$section_key,' data-cmd=\"creq\"','move_up'.$section_key);\n\t\t\t\t}\n\n\t\t\t\techo common::Link($this->title,$langmessage['New Section'],'cmd=new_section&section='.$section_key,array('data-cmd'=>'gpabox'));\n\n\t\t\t\t$q = 'cmd=add_section&copy=copy&section='.$section_key.'&last_mod='.rawurlencode($this->fileModTime);\n\t\t\t\techo common::Link($this->title,$langmessage['Copy'],$q,' data-cmd=\"creq\"');\n\n\n\t\t\t\t//remove section link\n\t\t\t\tif( count($this->file_sections) > 1 ){\n\t\t\t\t\t$title_attr = $langmessage['rm_section_confirm'];\n\t\t\t\t\tif( $type != 'include' ){\n\t\t\t\t\t\t$title_attr .= \"\\n\\n\".$langmessage['rm_section_confirm_deleting'];\n\t\t\t\t\t}\n\n\t\t\t\t\techo common::Link($this->title,$langmessage['Remove Section'],'cmd=rm_section&section='.$section_key.'&total='.count($this->file_sections), array('title'=>$title_attr,'data-cmd'=>'creq','class'=>'gpconfirm'));\n\t\t\t\t}\n\t\t\t\techo '</span>';\n\t\t\t\tgpOutput::$editlinks .= ob_get_clean();\n\n\t\t\t\t$content .= '<div class=\"editable_area GPAREA filetype-'.$type.'\" id=\"ExtraEditArea'.$edit_index.'\">'; // class=\"edit_area\" added by javascript\n\t\t\t}else{\n\t\t\t\t$content .= '<div class=\"GPAREA filetype-'.$type.'\">';\n\t\t\t}\n\n\t\t\t$GP_NESTED_EDIT = true;\n\t\t\t$content .= section_content::RenderSection($section_data,$section_num,$this->title,$this->file_stats);\n\t\t\t$GP_NESTED_EDIT = false;\n\n\t\t\t$content .= '<div class=\"gpclear\"></div>';\n\t\t\t$content .= '</div>';\n\t\t\t$section_num++;\n\t\t}\n\t\treturn $content;\n\t}\n\n\n\t/*\n\t * sends image information to gallery editor\n\t *\n\t *\n\t * gallery editor uses this html to create the new gallery html\n\t\t<li>\n\t\t\t<a href=\"'.$imgPath.'\" data-cmd=\"gallery\" data-arg=\"gallery_gallery\" title=\"'.htmlspecialchars($caption).'\">\n\t\t\t<img src=\"'.$thumbPath.'\" height=\"100\" width=\"100\" alt=\"\"/>\n\t\t\t</a>\n\t\t\t<div class=\"caption\">\n\t\t\t$caption\n\t\t\t</div>\n\t\t</li>\n\t *\n\t */\n\n\tfunction GalleryImages(){\n\n\t\tif( isset($_GET['dir']) ){\n\t\t\t$dir_piece = $_GET['dir'];\n\t\t}elseif( isset($this->meta_data['gallery_dir']) ){\n\t\t\t$dir_piece = $this->meta_data['gallery_dir'];\n\t\t}else{\n\t\t\t$dir_piece = '/image';\n\t\t}\n\t\t//remember browse directory\n\t\t$this->meta_data['gallery_dir'] = $dir_piece;\n\t\t$this->SaveThis();\n\n\t\tincludeFile('admin/admin_uploaded.php');\n\t\tadmin_uploaded::InlineList($dir_piece);\n\t}\n\n\n\tfunction NewDirForm(){\n\t\tglobal $langmessage;\n\t\tincludeFile('admin/admin_uploaded.php');\n\n\t\tob_start();\n\n\t\techo '<div class=\"inline_box\">';\n\t\t$img = '<img src=\"'.common::GetDir('/include/imgs/folder.png').'\" height=\"16\" width=\"16\" alt=\"\"/> ';\n\t\techo '<h2>'.$img.$langmessage['create_dir'].'</h2>';\n\t\techo '<form action=\"'.common::GetUrl($this->title).'\" method=\"post\" >';\n\t\techo '<p>';\n\t\techo htmlspecialchars($_GET['dir']).'/';\n\t\techo ' <input type=\"text\" class=\"gpinput\" name=\"newdir\" size=\"30\" />';\n\t\techo '</p>';\n\t\techo '<p>';\n\t\tif( !empty($_GET['dir']) ){\n\t\t\techo ' <input type=\"hidden\" name=\"dir\" value=\"'.htmlspecialchars($_GET['dir']).'\" />';\n\t\t}\n\t\techo '<input type=\"submit\" name=\"aaa\" value=\"'.$langmessage['create_dir'].'\" class=\"gp_gallery_folder_add gpsubmit\"/>';\n\t\techo ' <input type=\"submit\" name=\"\" value=\"'.$langmessage['cancel'].'\" class=\"admin_box_close gpcancel\"/>';\n\t\techo '</p>';\n\t\techo '</form>';\n\t\techo '</div>';\n\n\t\t$this->contentBuffer = ob_get_clean();\n\t}\n\n\t/*\n\t * Include Editing\n\t */\n\tfunction IncludeDialog(){\n\t\tglobal $page,$langmessage,$config;\n\n\t\t$page->ajaxReplace = array();\n\n\t\t$section =& $_GET['section'];\n\t\tif( !isset($this->file_sections[$section]) ){\n\t\t\tmessage($langmessage['OOPS']);\n\t\t\treturn;\n\t\t}\n\n\t\t$include_type =& $this->file_sections[$section]['include_type'];\n\n\t\t$gadget_content = '';\n\t\t$file_content = '';\n\t\tswitch($include_type){\n\t\t\tcase 'gadget':\n\t\t\t\t$gadget_content =& $this->file_sections[$section]['content'];\n\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\t$file_content =& $this->file_sections[$section]['content'];\n\t\t\tbreak;\n\t\t}\n\n\t\tob_start();\n\n\t\techo '<form id=\"gp_include_form\">';\n\n\t\techo '<div class=\"gp_inlude_edit\">';\n\t\techo '<span class=\"label\">';\n\t\techo $langmessage['File Include'];\n\t\techo '</span>';\n\t\techo '<input type=\"text\" size=\"\" id=\"gp_file_include\" name=\"file_include\" class=\"autocomplete\" value=\"'.htmlspecialchars($file_content).'\" />';\n\t\techo '</div>';\n\n\t\techo '<div class=\"gp_inlude_edit\">';\n\t\techo '<span class=\"label\">';\n\t\techo $langmessage['gadgets'];\n\t\techo '</span>';\n\t\techo '<input type=\"text\" size=\"\" id=\"gp_gadget_include\" name=\"gadget_include\" class=\"autocomplete\" value=\"'.htmlspecialchars($gadget_content).'\" />';\n\t\techo '</div>';\n\n\t\techo '<div id=\"gp_option_area\">';\n\t\techo '<a data-cmd=\"gp_include_preview\" class=\"ckeditor_control full_width\">Preview</a>';\n\t\techo '</div>';\n\n\t\techo '</form>';\n\n\n\t\t$content = ob_get_clean();\n\t\t$page->ajaxReplace[] = array('gp_include_dialog','',$content);\n\n\n\t\t//file include autocomplete\n\t\t$options['admin_vals'] = false;\n\t\t$options['var_name'] = 'source';\n\t\t$file_includes = gp_edit::AutoCompleteValues(false,$options);\n\t\t$page->ajaxReplace[] = array('gp_autocomplete_include','file',$file_includes);\n\n\n\t\t//gadget include autocomplete\n\t\t$code = 'var source=[';\n\t\tif( isset($config['gadgets']) ){\n\t\t\tforeach($config['gadgets'] as $uniq => $info){\n\t\t\t\t$code .= '[\"'.addslashes($uniq).'\",\"'.addslashes($uniq).'\"],';\n\t\t\t}\n\t\t}\n\t\t$code .= ']';\n\n\t\t$page->ajaxReplace[] = array('gp_autocomplete_include','gadget',$code);\n\n\t}\n\n}\n"], "fixing_code": ["<?php\ndefined('is_running') or die('Not an entry point...');\n\nincludeFile('tool/editing.php');\n\nclass editing_page extends display{\n\n\n\tfunction editing_page($title,$type){\n\t\tparent::display($title,$type);\n\t}\n\n\tfunction RunScript(){\n\t\tglobal $langmessage,$page;\n\t\t$cmd = common::GetCommand();\n\n\t\t//prevent overwriting the content to maintain overlay editin links\n\t\t//$page->ajaxReplace = array();\n\n\t\tif( !$this->SetVars() ){\n\t\t\treturn;\n\t\t}\n\n\t\t$this->GetFile();\n\n\t\t//original alpha versions of 1.8 didn't maintain the file_type\n\t\tif( !isset($this->meta_data['file_type']) ){\n\t\t\t$this->ResetFileTypes();\n\t\t}\n\n\n\t\t//admin toolbar links\n\t\t$menu_permissions = admin_tools::HasPermission('Admin_Menu');\n\t\t$can_edit = admin_tools::CanEdit($this->gp_index);\n\t\tif( $menu_permissions ){\n\t\t\t$page->admin_links[] = common::Link($this->title,$langmessage['rename/details'],'cmd=renameform','data-cmd=\"gpajax\"');\n\n\t\t\t// Having the layout link here complicates things.. would need layout link for special pages\n\t\t\t$page->admin_links[] = common::Link('Admin_Menu',$langmessage['current_layout'],'cmd=layout&from=page&index='.urlencode($this->gp_index),array('title'=>$langmessage['current_layout'],'data-cmd'=>'gpabox'));\n\t\t\t$page->admin_links[] = common::Link('Admin_Menu',$langmessage['Copy'],'cmd=copypage&redir=redir&title='.urlencode($this->title),array('title'=>$langmessage['Copy'],'data-cmd'=>'gpabox'));\n\t\t}\n\n\t\tif( admin_tools::HasPermission('Admin_User') ){\n\t\t\t$page->admin_links[] = common::Link('Admin_Users',$langmessage['permissions'],'cmd=file_permissions&index='.urlencode($this->gp_index),array('title'=>$langmessage['permissions'],'data-cmd'=>'gpabox'));\n\t\t}\n\n\t\tif( $can_edit ){\n\t\t\t$page->admin_links[] = common::Link($this->title,$langmessage['Revision History'],'cmd=view_history',array('title'=>$langmessage['Revision History'],'data-cmd'=>'gpabox'));\n\t\t}\n\n\n\t\tif( $menu_permissions ){\n\t\t\t$page->admin_links[] = common::Link('Admin_Menu',$langmessage['delete_file'],'cmd=trash_page&index='.urlencode($this->gp_index),array('data-cmd'=>'postlink','title'=>$langmessage['delete_page'],'class'=>'gpconfirm'));\n\n\t\t}\n\n\n\t\t//allow addons to effect page actions and how a page is displayed\n\t\t$cmd_after = gpPlugin::Filter('PageRunScript',array($cmd));\n\t\tif( $cmd !== $cmd_after ){\n\t\t\t$cmd = $cmd_after;\n\t\t\tif( $cmd === 'return' ){\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\t//admin actions\n\t\tif( $menu_permissions ){\n\t\t\tswitch($cmd){\n\t\t\t\t// rename & details\n\t\t\t\tcase 'renameform':\n\t\t\t\t\t$this->RenameForm();\n\t\t\t\treturn;\n\t\t\t\tcase 'renameit':\n\t\t\t\t\tif( $this->RenameFile() ){\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\n\t\t//file editing actions\n\t\tif( $can_edit ){\n\n\t\t\tswitch($cmd){\n\n\t\t\t\tcase 'new_dir':\n\t\t\t\t\t$this->NewDirForm();\n\t\t\t\treturn;\n\n\t\t\t\t//section editing\n\t\t\t\tcase 'move_up':\n\t\t\t\t\t$this->MoveUp();\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'new_section':\n\t\t\t\t\t$this->NewSectionPrompt();\n\t\t\t\treturn;\n\n\t\t\t\tcase 'add_section':\n\t\t\t\t\t$this->AddNewSection();\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'rm_section':\n\t\t\t\t\t$this->RmSection();\n\t\t\t\tbreak;\n\n\t\t\t\tcase 'save':\n\t\t\t\t\t$this->SaveSection();\n\t\t\t\treturn;\n\n\t\t\t\tcase 'rawcontent':\n\t\t\t\t\t$this->RawContent();\n\t\t\t\tbreak;\n\n\n\t\t\t\t/* gallery editing */\n\t\t\t\tcase 'gallery_folder':\n\t\t\t\tcase 'gallery_images':\n\t\t\t\t\t$this->GalleryImages();\n\t\t\t\treturn;\n\n\t\t\t\t/* include editing */\n\t\t\t\tcase 'preview':\n\t\t\t\t\t$this->PreviewSection();\n\t\t\t\treturn;\n\t\t\t\tcase 'include_dialog':\n\t\t\t\t\t$this->IncludeDialog();\n\t\t\t\treturn;\n\n\t\t\t\t/* inline editing */\n\t\t\t\tcase 'inlineedit':\n\t\t\t\t\t$this->InlineEdit();\n\t\t\t\tdie();\n\n\t\t\t\t/* revision history */\n\t\t\t\tcase 'view_revision':\n\t\t\t\t\t$this->ViewRevision();\n\t\t\t\treturn;\n\t\t\t\tcase 'use_revision':\n\t\t\t\t\t$this->UseRevision();\n\t\t\t\tbreak;\n\t\t\t\tcase 'view_history';\n\t\t\t\t\t$this->ViewHistory();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\t$this->contentBuffer = $this->GenerateContent_Admin();\n\t}\n\n\tfunction InlineEdit(){\n\t\t$section = $_REQUEST['section'];\n\t\tif( !is_numeric($section) || !isset($this->file_sections[$section])){\n\t\t\techo 'false';\n\t\t\treturn false;\n\t\t}\n\n\t\tincludeFile('tool/ajax.php');\n\t\tgpAjax::InlineEdit($this->file_sections[$section]);\n\t}\n\n\t/*\n\t * Send the raw content of the section to the gpResponse handler\n\t *\n\t */\n\tfunction RawContent(){\n\t\tglobal $page,$langmessage;\n\n\t\t//for ajax responses\n\t\t$page->ajaxReplace = array();\n\n\t\t$section = $_REQUEST['section'];\n\t\tif( !is_numeric($section) ){\n\t\t\tmessage($langmessage['OOPS'].'(1)');\n\t\t\treturn false;\n\t\t}\n\n\t\tif( !isset($this->file_sections[$section]) ){\n\t\t\tmessage($langmessage['OOPS'].'(1)');\n\t\t\treturn false;\n\t\t}\n\n\t\t$page->ajaxReplace[] = array('rawcontent','',$this->file_sections[$section]['content']);\n\t}\n\n\n\t/**\n\t * Recalculate the file_type string for this file\n\t * Used by AddNewSection(), RmSection()\n\t * Updates $this->meta_data and $gp_titles\n\t *\n\t */\n\tfunction ResetFileTypes($save = true){\n\t\tglobal $gp_titles;\n\n\t\t$original_types = array();\n\t\tif( isset($this->meta_data['file_type']) ){\n\t\t\t$original_types = explode(',',$this->meta_data['file_type']);\n\t\t}\n\n\t\t$new_types = array();\n\t\tforeach($this->file_sections as $section){\n\t\t\t$new_types[] = $section['type'];\n\t\t}\n\t\t$new_types = array_unique($new_types);\n\t\t$new_types = array_diff($new_types,array(''));\n\t\tsort($new_types);\n\n\t\t$new_types = implode(',',$new_types);\n\t\t$this->meta_data['file_type'] = $new_types;\n\n\t\tif( !isset($gp_titles[$this->gp_index]) ){\n\t\t\treturn;\n\t\t}\n\n\t\t$gp_titles[$this->gp_index]['type'] = $new_types;\n\t\tadmin_tools::SavePagesPHP();\n\t\tif( $save ){\n\t\t\t$this->SaveThis();\n\t\t}\n\t}\n\n\tfunction RenameFile(){\n\t\tglobal $langmessage, $gp_index, $page;\n\n\t\tincludeFile('tool/Page_Rename.php');\n\t\t$new_title = gp_rename::RenameFile($this->title);\n\t\tif( ($new_title !== false) && $new_title != $this->title ){\n\t\t\tmessage(sprintf($langmessage['will_redirect'],common::Link_Page($new_title)));\n\t\t\t$page->head .= '<meta http-equiv=\"refresh\" content=\"15;url='.common::GetUrl($new_title).'\">';\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\n\tfunction RenameForm(){\n\t\tglobal $page,$gp_index;\n\n\t\tincludeFile('tool/Page_Rename.php');\n\t\t$action = common::GetUrl($this->title);\n\t\tgp_rename::RenameForm($this->title,$action);\n\t}\n\n\n\tfunction MoveUp(){\n\t\tglobal $langmessage;\n\n\n\t\t$move_key =& $_REQUEST['section'];\n\t\tif( !isset($this->file_sections[$move_key]) ){\n\t\t\tmessage($langmessage['OOPS']);\n\t\t\treturn false;\n\t\t}\n\n\t\tif( !common::verify_nonce('move_up'.$move_key) ){\n\t\t\tmessage($langmessage['OOPS']);\n\t\t\treturn false;\n\t\t}\n\n\n\t\t$move_content = $this->file_sections[$move_key];\n\n\t\t$file_keys = array_keys($this->file_sections);\n\t\t$file_values = array_values($this->file_sections);\n\t\t$insert_key = array_search($move_key,$file_keys);\n\t\tif( ($insert_key === null) || ($insert_key === false) || ($insert_key === 0) ){\n\t\t\tmessage($langmessage['OOPS']);\n\t\t\treturn false;\n\t\t}\n\n\t\t$prev_key = $insert_key-1;\n\n\t\tif( !isset($file_keys[$prev_key]) ){\n\t\t\tmessage($langmessage['OOPS']);\n\t\t\treturn false;\n\t\t}\n\n\t\t$old_sections = $this->file_sections;\n\n\t\t//rebuild\n\t\t$new_sections = array();\n\t\tforeach($file_values as $temp_key => $file_value){\n\n\t\t\tif( $temp_key === $prev_key ){\n\t\t\t\t$new_sections[] = $move_content;\n\t\t\t}elseif( $temp_key === $insert_key ){\n\t\t\t\t//moved section\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\t$new_sections[] = $file_value;\n\t\t}\n\n\t\t$this->file_sections = $new_sections;\n\n\t\tif( !$this->SaveThis() ){\n\t\t\t$this->file_sections = $old_sections;\n\t\t\tmessage($langmessage['OOPS'].'(4)');\n\t\t\treturn;\n\t\t}\n\t}\n\n\t/**\n\t * Remove a content area from a page\n\t *\n\t */\n\tfunction RmSection(){\n\t\tglobal $langmessage,$page;\n\n\t\tif( !isset($_POST['total']) || $_POST['total'] != count($this->file_sections) ){\n\t\t\tmessage($langmessage['OOPS']);\n\t\t\treturn false;\n\t\t}\n\n\t\tif( !isset($_POST['section']) ){\n\t\t\tmessage($langmessage['OOPS'].'(1)');\n\t\t\treturn;\n\t\t}\n\n\t\t$section = $_POST['section'];\n\n\t\tif( !isset($this->file_sections[$section]) ){\n\t\t\tmessage($langmessage['OOPS'].'(2)');\n\t\t\treturn;\n\t\t}\n\n\t\t$section_data = $this->file_sections[$section];\n\n\t\tarray_splice( $this->file_sections , $section , 1 );\n\n\t\t$this->ResetFileTypes(false);\n\n\t\tif( !$this->SaveThis() ){\n\t\t\tmessage($langmessage['OOPS'].'(4)');\n\t\t\treturn;\n\t\t}\n\n\t\tif( $section_data['type'] == 'gallery' ){\n\t\t\t$this->GalleryEdited();\n\t\t}\n\n\t\t//update usage of resized images\n\t\tif( isset($section_data['resized_imgs']) ){\n\t\t\tincludeFile('image.php');\n\t\t\tgp_resized::SetIndex();\n\t\t\tgp_edit::ResizedImageUse($section_data['resized_imgs'],array());\n\t\t}\n\n\t\tmessage($langmessage['SAVED']);\n\t}\n\n\n\t/**\n\t * Add a new section to the page\n\t *\n\t */\n\tfunction AddNewSection(){\n\t\tglobal $langmessage;\n\n\t\tif( $_POST['last_mod'] != $this->fileModTime ){\n\t\t\tmessage($langmessage['OOPS']);\n\t\t\treturn false;\n\t\t}\n\n\t\tif( !isset($_POST['section']) ){\n\t\t\tmessage($langmessage['OOPS'].'(1)');\n\t\t\treturn;\n\t\t}\n\n\t\t$section = $_POST['section'];\n\n\t\tif( !isset($this->file_sections[$section]) ){\n\t\t\tmessage($langmessage['OOPS'].'(2)');\n\t\t\treturn;\n\t\t}\n\n\t\tif( isset($_POST['copy']) ){\n\t\t\t$start_content = $this->file_sections[$section];\n\t\t}else{\n\t\t\t$start_content['type'] = $_POST['content_type'];\n\t\t\t$start_content['content'] = editing_page::GetDefaultContent($start_content['type']);\n\t\t\tif( $start_content['content'] === false ){\n\t\t\t\tmessage($langmessage['OOPS'].'(3)');\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif( isset($_POST['insert']) && $_POST['insert'] == 'before' ){\n\t\t\tarray_splice( $this->file_sections , $section , 0, 'temporary' );\n\t\t\t$new_section = $section;\n\t\t}else{\n\t\t\tarray_splice( $this->file_sections , $section+1 , 0, 'temporary' );\n\t\t\t$new_section = $section+1;\n\t\t}\n\n\t\tif( $this->file_sections[$new_section] != 'temporary' ){\n\t\t\tmessage($langmessage['OOPS'].'(4)');\n\t\t\treturn;\n\t\t}\n\n\n\t\t$this->file_sections[$new_section] = $start_content;\n\n\t\t$this->ResetFileTypes(false);\n\n\t\tif( !$this->SaveThis() ){\n\t\t\tmessage($langmessage['OOPS'].'(4)');\n\t\t\treturn;\n\t\t}\n\n\n\t\tmessage($langmessage['SAVED']);\n\t}\n\n\n\t/**\n\t * Get the default content for the specified content type\n\t *\n\t * @static\n\t *\n\t */\n\tstatic function GetDefaultContent($type){\n\t\tglobal $langmessage;\n\n\t\tswitch($type){\n\t\t\tcase 'include':\n\t\t\t\t$default_content = '';\n\t\t\tbreak;\n\n\t\t\tcase 'gallery':\n\t\t\t\t$default_content = '<ul class=\"gp_gallery\"><li class=\"gp_to_remove\"></li></ul>';\n\t\t\tbreak;\n\n\t\t\tcase 'text':\n\t\t\tdefault:\n\t\t\t\t$default_content = '<p>'.$langmessage['New Section'].'</p>';\n\t\t\tbreak;\n\t\t}\n\n\t\t$default_content = gpPlugin::Filter('GetDefaultContent',array($default_content,$type));\n\n\t\treturn $default_content;\n\t}\n\n\t/**\n\t * Display a form for adding a new section to the page\n\t *\n\t */\n\tfunction NewSectionPrompt(){\n\t\tglobal $langmessage;\n\n\t\tob_start();\n\t\techo '<div class=\"inline_box\">';\n\t\techo '<form method=\"post\" action=\"'.common::GetUrl($this->title).'\">';\n\t\techo '<h2>'.$langmessage['new_section_about'].'</h2>';\n\n\t\techo '<table class=\"bordered full_width\">';\n\t\techo '<tr><th colspan=\"2\">'.$langmessage['New Section'].'</th></tr>';\n\n\t\techo '<tr><td>';\n\t\techo $langmessage['Content Type'];\n\t\techo '</td><td>';\n\t\tediting_page::SectionTypes();\n\t\techo '</td></tr>';\n\n\t\techo '<tr><td>';\n\t\techo $langmessage['Insert Location'];\n\t\techo '</td><td>';\n\t\techo '<label><input type=\"radio\" name=\"insert\" value=\"before\" /> ';\n\t\techo $langmessage['insert_before'];\n\t\techo '</label>';\n\t\techo '<label><input type=\"radio\" name=\"insert\" value=\"after\" checked=\"checked\" /> ';\n\t\techo $langmessage['insert_after'];\n\t\techo '</label>';\n\t\techo '</td></tr>';\n\n\t\techo '</table>';\n\n\t\techo '<p>';\n\t\techo '<input type=\"hidden\" name=\"last_mod\" value=\"'.$this->fileModTime.'\" />';\n\t\techo '<input type=\"hidden\" name=\"section\" value=\"'.htmlspecialchars($_GET['section']).'\" />';\n\t\techo '<input type=\"hidden\" name=\"cmd\" value=\"add_section\" />';\n\t\techo '<input type=\"submit\" name=\"\" value=\"'.$langmessage['save'].'\" class=\"gpsubmit\"/>';\n\t\techo ' <input type=\"button\" name=\"\" value=\"'.$langmessage['cancel'].'\" class=\"admin_box_close gpcancel\" />';\n\t\techo '</p>';\n\n\n\t\techo '</form>';\n\t\techo '</div>';\n\t\t$this->contentBuffer = ob_get_clean();\n\n\t}\n\n\t/*\n\t * @static\n\t */\n\tstatic function SectionTypes(){\n\t\tglobal $langmessage;\n\t\t$section_types['text']['label']\t\t= $langmessage['editable_text'];\n\t\t$section_types['gallery']['label']\t= $langmessage['Image Gallery'];\n\t\t$section_types['include']['label']\t= $langmessage['File Include'];\n\n\t\t$section_types = gpPlugin::Filter('SectionTypes',array($section_types));\n\n\t\t$checked = 'checked=\"checked\"';\n\t\tforeach($section_types as $type => $type_info){\n\t\t\techo '<label>';\n\t\t\techo '<input type=\"radio\" name=\"content_type\" value=\"'.htmlspecialchars($type).'\" '.$checked.'/> ';\n\t\t\techo htmlspecialchars($type_info['label']);\n\t\t\techo '</label>';\n\t\t\t$checked = '';\n\t\t}\n\t}\n\n\n\tfunction PreviewSection(){\n\t\tglobal $page,$langmessage;\n\n\t\t//for ajax responses\n\t\t$page->ajaxReplace = array();\n\n\t\t$section = $_POST['section'];\n\t\tif( !is_numeric($section) ){\n\t\t\tmessage($langmessage['OOPS'].'(1)');\n\t\t\treturn false;\n\t\t}\n\n\t\tif( !isset($this->file_sections[$section]) ){\n\t\t\tmessage($langmessage['OOPS'].'(1)');\n\t\t\treturn false;\n\t\t}\n\n\t\t$type = $this->file_sections[$section]['type'];\n\n\n\t\tswitch($type){\n\t\t\tcase 'include':\n\t\t\t\t$data = array();\n\t\t\t\t$data['type'] = $type;\n\t\t\t\tif( !empty($_POST['gadget_include']) ){\n\t\t\t\t\t$data['include_type'] = 'gadget';\n\t\t\t\t\t$data['content'] = $_POST['gadget_include'];\n\t\t\t\t}else{\n\t\t\t\t\t$data['content'] = $_POST['file_include'];\n\t\t\t\t}\n\n\n\t\t\t\tincludeFile('tool/SectionContent.php');\n\t\t\t\t$content = section_content::RenderSection($data,$section,$this->title,$this->file_stats);\n\t\t\t\t$page->ajaxReplace[] = array('gp_include_content','',$content);\n\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tmessage($langmessage['OOPS'].'(2)');\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tfunction SaveSection(){\n\t\tglobal $page,$langmessage;\n\n\t\t//for ajax responses\n\t\t$page->ajaxReplace = array();\n\n\n\t\t//check\n\t\t$section =& $_POST['section'];\n\t\tif( !is_numeric($section) ){\n\t\t\tmessage($langmessage['OOPS'].'(1)');\n\t\t\treturn false;\n\t\t}\n\n\t\tif( !isset($this->file_sections[$section]) ){\n\t\t\tmessage($langmessage['OOPS'].'(1)');\n\t\t\treturn false;\n\t\t}\n\n\t\t$type = $this->file_sections[$section]['type'];\n\t\t$check_before = serialize($this);\n\t\t$check_before = sha1( $check_before ) . md5( $check_before );\n\n\t\t$save_this = false;\n\t\tswitch($type){\n\t\t\tcase 'text':\n\t\t\t\t$save_this = true;\n\t\t\t\t$this->SaveSection_Text($section);\n\t\t\tbreak;\n\t\t\tcase 'gallery':\n\t\t\t\t$save_this = true;\n\t\t\t\t$this->SaveSection_Text($section);\n\t\t\t\t$this->GalleryEdited();\n\t\t\tbreak;\n\t\t\tcase 'include':\n\t\t\t\t$save_this = $this->SaveSection_Include($section);\n\t\t\tbreak;\n\t\t}\n\n\t\t$save_this = gpPlugin::Filter('SaveSection',array($save_this,$section,$type));\n\t\tif( $save_this !== true ){\n\t\t\tmessage($langmessage['OOPS'].'(2)');\n\t\t\treturn false;\n\t\t}\n\n\t\t//save if the file was changed\n\t\t$check_after = serialize($this);\n\t\t$check_after = sha1( $check_after ) . md5( $check_after );\n\t\tif( $check_before != $check_after ){\n\t\t\tif( !$this->SaveThis() ){\n\t\t\t\tmessage($langmessage['OOPS'].'(3)');\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\t$page->ajaxReplace[] = array('ck_saved','','');\n\t\tmessage($langmessage['SAVED']);\n\t\treturn true;\n\t}\n\n\tfunction SaveThis(){\n\n\t\tif( !is_array($this->meta_data) || !is_array($this->file_sections) ){\n\t\t\treturn false;\n\t\t}\n\n\t\t//file count\n\t\tif( !isset($this->meta_data['file_number']) ){\n\t\t\t$this->meta_data['file_number'] = gpFiles::NewFileNumber();\n\t\t}\n\t\t$this->SaveBackup(); //make a backup of the page file\n\n\t\treturn gpFiles::SaveArray($this->file,'meta_data',$this->meta_data,'file_sections',$this->file_sections);\n\t}\n\n\t/**\n\t *\tSave a backup of the file\n\t *\n\t */\n\tfunction SaveBackup(){\n\t\tglobal $dataDir;\n\n\t\t$dir = $dataDir.'/data/_backup/pages/'.$this->gp_index;\n\t\tgpFiles::CheckDir($dir);\n\n\t\t$time = time();\n\t\tif( isset($_REQUEST['revision']) && is_numeric($_REQUEST['revision']) ){\n\t\t\t$time = $_REQUEST['revision'];\n\t\t}\n\n\t\t$contents = file_get_contents( $this->file );\n\n\t\t//backup file name\n\t\t$len = strlen($contents);\n\t\t$backup_file = $dir.'/'.$time.'.'.$len;\n\n\t\t//compress\n\t\tif( function_exists('gzencode') && function_exists('readgzfile') ){\n\t\t\t$backup_file .= '.gze';\n\t\t\t$contents = gzencode($contents,9);\n\t\t}\n\n\t\tgpFiles::Save( $backup_file, $contents );\n\t\t$this->CleanBackupFolder();\n\t}\n\n\n\t/**\n\t * Reduce the number of files in the backup folder\n\t *\n\t */\n\tfunction CleanBackupFolder(){\n\t\tglobal $dataDir;\n\t\t$files = $this->BackupFiles();\n\t\t$file_count = count($files);\n\t\tif( $file_count <= gp_backup_limit ){\n\t\t\treturn;\n\t\t}\n\t\t$delete_count = $file_count - gp_backup_limit;\n\t\t$files = array_splice( $files, 0, $delete_count );\n\t\tforeach($files as $file){\n\t\t\t$full_path = $dataDir.'/data/_backup/pages/'.$this->gp_index.'/'.$file;\n\t\t\tunlink($full_path);\n\t\t}\n\t}\n\n\n\t/**\n\t * Display the revision history of the current file\n\t *\n\t */\n\tfunction ViewHistory(){\n\t\tglobal $langmessage;\n\n\t\t$files = $this->BackupFiles();\n\t\tkrsort($files);\n\n\t\tob_start();\n\t\techo '<h2>'.$langmessage['Revision History'].'</h2>';\n\t\techo '<table class=\"bordered full_width\"><tr><th>'.$langmessage['Modified'].'</th><th>'.$langmessage['File Size'].'</th><th>&nbsp;</th></tr>';\n\t\techo '<tbody>';\n\n\t\t$size = filesize($this->file);\n\t\techo '<tr><td>';\n\t\techo common::date($langmessage['strftime_datetime'],$this->fileModTime);\n\t\techo ' &nbsp; ('.$langmessage['Current Page'].')</td><td>';\n\t\techo admin_tools::FormatBytes($size);\n\t\techo '</td><td>&nbsp;</td></tr>';\n\n\t\t$i = 1;\n\t\tforeach($files as $time => $file){\n\n\t\t\t//get info from filename\n\t\t\t$name = basename($file);\n\t\t\t$parts = explode('.',$name);\n\t\t\t$time = array_shift($parts);\n\t\t\t$size = array_shift($parts);\n\n\t\t\t//output row\n\t\t\techo '<tr class=\"'.($i % 2 ? 'even' : '').'\"><td>';\n\t\t\techo common::date($langmessage['strftime_datetime'],$time);\n\t\t\techo '</td><td>';\n\t\t\tif( $size && is_numeric($size) ){\n\t\t\t\techo admin_tools::FormatBytes($size);\n\t\t\t}\n\t\t\techo '</td><td>';\n\t\t\techo common::Link($this->title,$langmessage['preview'],'cmd=view_revision&time='.$time,'data-cmd=\"cnreq\"');\n\t\t\techo '</td></tr>';\n\t\t\t$i++;\n\t\t}\n\t\techo '</tbody>';\n\t\techo '</table>';\n\t\t$this->contentBuffer = ob_get_clean();\n\t}\n\n\t/**\n\t * Display the contents of a past revision\n\t *\n\t */\n\tfunction ViewRevision(){\n\t\tglobal $langmessage;\n\t\t$time = $_REQUEST['time'];\n\t\t$full_path = $this->BackupFile($time);\n\t\tif( !$full_path ){\n\t\t\treturn false;\n\t\t}\n\n\t\t$file_sections = $file_stats = array();\n\n\t\t//if it's a compressed file, we need an uncompressed version\n\t\tif( strpos($full_path,'.gze') !== false ){\n\t\t\t$dir = common::DirName($full_path);\n\t\t\tob_start();\n\t\t\treadgzfile($full_path);\n\t\t\t$contents = ob_get_clean();\n\t\t\t$full_path = tempnam($dir,'backup');\n\t\t\tgpFiles::Save( $full_path, $contents );\n\t\t\tinclude($full_path);\n\t\t\tunlink($full_path);\n\t\t}else{\n\t\t\tinclude($full_path);\n\t\t}\n\n\t\tincludeFile('tool/SectionContent.php');\n\t\t$this->contentBuffer = section_content::Render($file_sections,$this->title,$file_stats);\n\n\n\t\t$date = common::date($langmessage['strftime_datetime'],$time);\n\t\t$message = sprintf($langmessage['viewing_revision'],$date);\n\t\t$message .= ' <br/> '.common::Link($this->title,$langmessage['Restore this revision'],'cmd=use_revision&time='.$time,'data-cmd=\"cnreq\"');\n\t\t$message .= ' &nbsp; '.common::Link($this->title,$langmessage['Revision History'],'cmd=view_history',array('title'=>$langmessage['Revision History'],'data-cmd'=>'gpabox'));\n\t\tmessage( $message );\n\t}\n\n\t/**\n\t * Revert the file data to a previous revision\n\t *\n\t */\n\tfunction UseRevision(){\n\t\tglobal $langmessage, $page;\n\n\t\t$time = $_REQUEST['time'];\n\t\t$full_path = $this->BackupFile($time);\n\t\tif( !$full_path ){\n\t\t\treturn false;\n\t\t}\n\t\tif( strpos($full_path,'.gze') !== false ){\n\t\t\tob_start();\n\t\t\treadgzfile($full_path);\n\t\t\t$contents = ob_get_clean();\n\t\t}else{\n\t\t\t$contents = file_get_contents($full_path);\n\t\t}\n\n\t\t$this->SaveBackup();\n\t\tgpFiles::Save( $this->file, $contents );\n\t\t$this->GetFile();\n\t\t$this->ResetFileTypes(false);\n\t\tmessage($langmessage['SAVED']);\n\t}\n\n\t/**\n\t * Return a list of the available backup for the current file\n\t *\n\t */\n\tfunction BackupFiles(){\n\t\tglobal $dataDir;\n\t\t$dir = $dataDir.'/data/_backup/pages/'.$this->gp_index;\n\t\tif( !file_exists($dir) ){\n\t\t\treturn array();\n\t\t}\n\t\t$all_files = scandir($dir);\n\t\t$files = array();\n\t\tforeach($all_files as $file){\n\t\t\tif( $file == '.' || $file == '..' ){\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\t$parts = explode('.',$file);\n\t\t\t$time = array_shift($parts);\n\t\t\tif( !is_numeric($time) ){\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\t$files[$time] = $file;\n\t\t}\n\n\t\tksort($files);\n\t\treturn $files;\n\t}\n\n\t/**\n\t * Return the full path of the saved revision if it exists\n\t *\n\t */\n\tfunction BackupFile( $time ){\n\t\tglobal $dataDir;\n\t\t$files = $this->BackupFiles();\n\t\tif( !isset($files[$time]) ){\n\t\t\treturn false;\n\t\t}\n\t\treturn $dataDir.'/data/_backup/pages/'.$this->gp_index.'/'.$files[$time];\n\t}\n\n\n\tfunction SaveSection_Include($section){\n\t\tglobal $page, $langmessage, $gp_index, $config;\n\n\n\t\t$section_data = $this->file_sections[$section];\n\t\tunset($section_data['index']);\n\n\t\tif( !empty($_POST['gadget_include']) ){\n\t\t\t$gadget = $_POST['gadget_include'];\n\t\t\tif( !isset($config['gadgets'][$gadget]) ){\n\t\t\t\tmessage($langmessage['OOPS_TITLE']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t$section_data['include_type'] = 'gadget';\n\t\t\t$section_data['content'] = $gadget;\n\t\t}else{\n\t\t\t$title = $_POST['file_include'];\n\t\t\tif( !isset($gp_index[$title]) ){\n\t\t\t\tmessage($langmessage['OOPS_TITLE']);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\t$section_data['include_type'] = common::SpecialOrAdmin($title);\n\t\t\t$section_data['index'] = $gp_index[$title];\n\t\t\t$section_data['content'] = $title;\n\t\t}\n\n\t\t$this->file_sections[$section] = $section_data;\n\n\t\t//send replacement content\n\t\tincludeFile('tool/SectionContent.php');\n\t\t$content = section_content::RenderSection($section_data,$section,$this->title,$this->file_stats);\n\t\t$page->ajaxReplace[] = array('gp_include_content','',$content);\n\t\treturn true;\n\t}\n\n\n\tfunction SaveSection_Text($section){\n\t\tglobal $config;\n\t\t$content =& $_POST['gpcontent'];\n\t\tgpFiles::cleanText($content);\n\t\t$this->file_sections[$section]['content'] = $content;\n\n\t\tif( $config['resize_images'] ){\n\t\t\tgp_edit::ResizeImages($this->file_sections[$section]['content'],$this->file_sections[$section]['resized_imgs']);\n\t\t}\n\n\t\treturn true;\n\t}\n\n\n\t/**\n\t * Extract information about the gallery from it's html: img_count, icon_src\n\t * Call GalleryEdited when a gallery section is removed, edited\n\t *\n\t */\n\tfunction GalleryEdited(){\n\t\tincludeFile('special/special_galleries.php');\n\t\tspecial_galleries::UpdateGalleryInfo($this->title,$this->file_sections);\n\t}\n\n\tfunction GenerateContent_Admin(){\n\t\tglobal $langmessage,$GP_NESTED_EDIT;\n\n\t\t//add to all pages in case a user adds a gallery\n\t\tgpPlugin::Action('GenerateContent_Admin');\n\t\tincludeFile('tool/SectionContent.php');\n\t\tcommon::ShowingGallery();\n\n\t\t$content = '';\n\t\t$section_num = 0;\n\t\tforeach($this->file_sections as $section_key => $section_data){\n\t\t\t$content .= \"\\n\";\n\t\t\t$type = isset($section_data['type']) ? $section_data['type'] : 'text';\n\n\t\t\tif( gpOutput::ShowEditLink() && admin_tools::CanEdit($this->gp_index) ){\n\n\t\t\t\t$link_name = 'inline_edit_generic';\n\t\t\t\t$link_rel = $type.'_inline_edit';\n\n\n\t\t\t\t$title_attr = sprintf($langmessage['Section %s'],$section_key+1);\n\t\t\t\t$link = gpOutput::EditAreaLink($edit_index,$this->title,$langmessage['edit'],'section='.$section_key.'&amp;revision='.$this->fileModTime,array('title'=>$title_attr,'data-cmd'=>$link_name,'data-arg'=>$link_rel));\n\n\t\t\t\t//section control links\n\t\t\t\tob_start();\n\t\t\t\techo '<span class=\"nodisplay\" id=\"ExtraEditLnks'.$edit_index.'\">';\n\t\t\t\techo $link;\n\n\t\t\t\tif( $section_num > 0 ){\n\t\t\t\t\techo common::Link($this->title,$langmessage['move_up'],'cmd=move_up&section='.$section_key,' data-cmd=\"creq\"','move_up'.$section_key);\n\t\t\t\t}\n\n\t\t\t\techo common::Link($this->title,$langmessage['New Section'],'cmd=new_section&section='.$section_key,array('data-cmd'=>'gpabox'));\n\n\t\t\t\t$q = 'cmd=add_section&copy=copy&section='.$section_key.'&last_mod='.rawurlencode($this->fileModTime);\n\t\t\t\techo common::Link($this->title,$langmessage['Copy'],$q,' data-cmd=\"creq\"');\n\n\n\t\t\t\t//remove section link\n\t\t\t\tif( count($this->file_sections) > 1 ){\n\t\t\t\t\t$title_attr = $langmessage['rm_section_confirm'];\n\t\t\t\t\tif( $type != 'include' ){\n\t\t\t\t\t\t$title_attr .= \"\\n\\n\".$langmessage['rm_section_confirm_deleting'];\n\t\t\t\t\t}\n\n\t\t\t\t\techo common::Link($this->title,$langmessage['Remove Section'],'cmd=rm_section&section='.$section_key.'&total='.count($this->file_sections), array('title'=>$title_attr,'data-cmd'=>'creq','class'=>'gpconfirm'));\n\t\t\t\t}\n\t\t\t\techo '</span>';\n\t\t\t\tgpOutput::$editlinks .= ob_get_clean();\n\n\t\t\t\t$content .= '<div class=\"editable_area GPAREA filetype-'.$type.'\" id=\"ExtraEditArea'.$edit_index.'\">'; // class=\"edit_area\" added by javascript\n\t\t\t}else{\n\t\t\t\t$content .= '<div class=\"GPAREA filetype-'.$type.'\">';\n\t\t\t}\n\n\t\t\t$GP_NESTED_EDIT = true;\n\t\t\t$content .= section_content::RenderSection($section_data,$section_num,$this->title,$this->file_stats);\n\t\t\t$GP_NESTED_EDIT = false;\n\n\t\t\t$content .= '<div class=\"gpclear\"></div>';\n\t\t\t$content .= '</div>';\n\t\t\t$section_num++;\n\t\t}\n\t\treturn $content;\n\t}\n\n\n\t/*\n\t * sends image information to gallery editor\n\t *\n\t *\n\t * gallery editor uses this html to create the new gallery html\n\t\t<li>\n\t\t\t<a href=\"'.$imgPath.'\" data-cmd=\"gallery\" data-arg=\"gallery_gallery\" title=\"'.htmlspecialchars($caption).'\">\n\t\t\t<img src=\"'.$thumbPath.'\" height=\"100\" width=\"100\" alt=\"\"/>\n\t\t\t</a>\n\t\t\t<div class=\"caption\">\n\t\t\t$caption\n\t\t\t</div>\n\t\t</li>\n\t *\n\t */\n\n\tfunction GalleryImages(){\n\n\t\tif( isset($_GET['dir']) ){\n\t\t\t$dir_piece = $_GET['dir'];\n\t\t}elseif( isset($this->meta_data['gallery_dir']) ){\n\t\t\t$dir_piece = $this->meta_data['gallery_dir'];\n\t\t}else{\n\t\t\t$dir_piece = '/image';\n\t\t}\n\t\t//remember browse directory\n\t\t$this->meta_data['gallery_dir'] = $dir_piece;\n\t\t$this->SaveThis();\n\n\t\tincludeFile('admin/admin_uploaded.php');\n\t\tadmin_uploaded::InlineList($dir_piece);\n\t}\n\n\n\tfunction NewDirForm(){\n\t\tglobal $langmessage;\n\t\tincludeFile('admin/admin_uploaded.php');\n\n\t\tob_start();\n\n\t\techo '<div class=\"inline_box\">';\n\t\t$img = '<img src=\"'.common::GetDir('/include/imgs/folder.png').'\" height=\"16\" width=\"16\" alt=\"\"/> ';\n\t\techo '<h2>'.$img.$langmessage['create_dir'].'</h2>';\n\t\techo '<form action=\"'.common::GetUrl($this->title).'\" method=\"post\" >';\n\t\techo '<p>';\n\t\techo htmlspecialchars($_GET['dir']).'/';\n\t\techo ' <input type=\"text\" class=\"gpinput\" name=\"newdir\" size=\"30\" />';\n\t\techo '</p>';\n\t\techo '<p>';\n\t\tif( !empty($_GET['dir']) ){\n\t\t\techo ' <input type=\"hidden\" name=\"dir\" value=\"'.htmlspecialchars($_GET['dir']).'\" />';\n\t\t}\n\t\techo '<input type=\"submit\" name=\"aaa\" value=\"'.$langmessage['create_dir'].'\" class=\"gp_gallery_folder_add gpsubmit\"/>';\n\t\techo ' <input type=\"submit\" name=\"\" value=\"'.$langmessage['cancel'].'\" class=\"admin_box_close gpcancel\"/>';\n\t\techo '</p>';\n\t\techo '</form>';\n\t\techo '</div>';\n\n\t\t$this->contentBuffer = ob_get_clean();\n\t}\n\n\t/*\n\t * Include Editing\n\t */\n\tfunction IncludeDialog(){\n\t\tglobal $page,$langmessage,$config;\n\n\t\t$page->ajaxReplace = array();\n\n\t\t$section =& $_GET['section'];\n\t\tif( !isset($this->file_sections[$section]) ){\n\t\t\tmessage($langmessage['OOPS']);\n\t\t\treturn;\n\t\t}\n\n\t\t$include_type =& $this->file_sections[$section]['include_type'];\n\n\t\t$gadget_content = '';\n\t\t$file_content = '';\n\t\tswitch($include_type){\n\t\t\tcase 'gadget':\n\t\t\t\t$gadget_content =& $this->file_sections[$section]['content'];\n\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\t$file_content =& $this->file_sections[$section]['content'];\n\t\t\tbreak;\n\t\t}\n\n\t\tob_start();\n\n\t\techo '<form id=\"gp_include_form\">';\n\n\t\techo '<div class=\"gp_inlude_edit\">';\n\t\techo '<span class=\"label\">';\n\t\techo $langmessage['File Include'];\n\t\techo '</span>';\n\t\techo '<input type=\"text\" size=\"\" id=\"gp_file_include\" name=\"file_include\" class=\"autocomplete\" value=\"'.htmlspecialchars($file_content).'\" />';\n\t\techo '</div>';\n\n\t\techo '<div class=\"gp_inlude_edit\">';\n\t\techo '<span class=\"label\">';\n\t\techo $langmessage['gadgets'];\n\t\techo '</span>';\n\t\techo '<input type=\"text\" size=\"\" id=\"gp_gadget_include\" name=\"gadget_include\" class=\"autocomplete\" value=\"'.htmlspecialchars($gadget_content).'\" />';\n\t\techo '</div>';\n\n\t\techo '<div id=\"gp_option_area\">';\n\t\techo '<a data-cmd=\"gp_include_preview\" class=\"ckeditor_control full_width\">Preview</a>';\n\t\techo '</div>';\n\n\t\techo '</form>';\n\n\n\t\t$content = ob_get_clean();\n\t\t$page->ajaxReplace[] = array('gp_include_dialog','',$content);\n\n\n\t\t//file include autocomplete\n\t\t$options['admin_vals'] = false;\n\t\t$options['var_name'] = 'source';\n\t\t$file_includes = gp_edit::AutoCompleteValues(false,$options);\n\t\t$page->ajaxReplace[] = array('gp_autocomplete_include','file',$file_includes);\n\n\n\t\t//gadget include autocomplete\n\t\t$code = 'var source=[';\n\t\tif( isset($config['gadgets']) ){\n\t\t\tforeach($config['gadgets'] as $uniq => $info){\n\t\t\t\t$code .= '[\"'.addslashes($uniq).'\",\"'.addslashes($uniq).'\"],';\n\t\t\t}\n\t\t}\n\t\t$code .= ']';\n\n\t\t$page->ajaxReplace[] = array('gp_autocomplete_include','gadget',$code);\n\n\t}\n\n}\n"], "filenames": ["include/tool/editing_page.php"], "buggy_code_start_loc": [454], "buggy_code_end_loc": [485], "fixing_code_start_loc": [453], "fixing_code_end_loc": [484], "type": "CWE-79", "message": "Cross-site scripting (XSS) vulnerability in the NewSectionPrompt function in include/tool/editing_page.php in gpEasy CMS 3.5.2 and earlier allows remote attackers to inject arbitrary web script or HTML via the section parameter in a new_section action to index.php.", "other": {"cve": {"id": "CVE-2013-0807", "sourceIdentifier": "cve@mitre.org", "published": "2014-03-28T15:55:08.483", "lastModified": "2017-08-29T01:33:08.557", "vulnStatus": "Modified", "descriptions": [{"lang": "en", "value": "Cross-site scripting (XSS) vulnerability in the NewSectionPrompt function in include/tool/editing_page.php in gpEasy CMS 3.5.2 and earlier allows remote attackers to inject arbitrary web script or HTML via the section parameter in a new_section action to index.php."}, {"lang": "es", "value": "Vulnerabilidad de XSS en la funci\u00f3n NewSectionPrompt en include/tool/editing_page.php en gpEasy CMS 3.5.2 y anteriores permite a atacantes remotos inyectar script Web o HTML arbitrarios a trav\u00e9s del par\u00e1metro section en una acci\u00f3n new_section hacia index.php."}], "metrics": {"cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:*:*:*:*:*:*:*:*", "versionEndIncluding": "3.5.2", "matchCriteriaId": "97379DB4-29D7-4DD8-8AC5-8A4B88058146"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:1.5:*:*:*:*:*:*:*", "matchCriteriaId": "0DF2976A-EBAD-4A71-87C7-58E4311904F8"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:1.5:rc2:*:*:*:*:*:*", "matchCriteriaId": "9F1BC763-BA60-40C2-AC3A-10C817FAE0F3"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:1.5:rc3:*:*:*:*:*:*", "matchCriteriaId": "4000B360-BE2E-429D-9CEC-C0886C679384"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:1.5:rc4:*:*:*:*:*:*", "matchCriteriaId": "0C4F029B-CF0E-41B0-8588-249DF0006922"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:1.6:*:*:*:*:*:*:*", "matchCriteriaId": "71F277EE-C80A-4D9A-BDCB-3075864A762B"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:1.6:rc1:*:*:*:*:*:*", "matchCriteriaId": "DDC0182A-7D10-4ACF-B40D-716FF6967389"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:1.6:rc2:*:*:*:*:*:*", "matchCriteriaId": "142F2215-449B-4615-8897-CCC481E087B4"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:1.6:rc3:*:*:*:*:*:*", "matchCriteriaId": "0BC43ECE-9746-449C-B8F6-6F1BD60E3203"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:1.6:rc4:*:*:*:*:*:*", "matchCriteriaId": "3D4581F3-DDD1-45FC-A875-9D519FCB2D8E"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:1.6:rc5:*:*:*:*:*:*", "matchCriteriaId": "D0C0AD75-8598-4216-8EE1-91BA2D186A5B"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:1.6.1:*:*:*:*:*:*:*", "matchCriteriaId": "53E37F66-20A2-4FEC-8648-E9056AAA7774"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:1.6.2:*:*:*:*:*:*:*", "matchCriteriaId": "D8C70739-2A53-41E3-9198-72BEE9F2A0D1"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:1.6.3:*:*:*:*:*:*:*", "matchCriteriaId": "50EEA808-5C4B-43FF-8D04-FDE01638FBB5"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:2.0.1:*:*:*:*:*:*:*", "matchCriteriaId": "2D36E332-73A4-4459-8A26-96F0F0F127AF"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:2.1:*:*:*:*:*:*:*", "matchCriteriaId": "D6E9E9A8-E0A3-4F89-B558-D8003BFB7406"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:2.2:*:*:*:*:*:*:*", "matchCriteriaId": "9B98ED04-7971-467A-AD19-A225D49A47EF"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:2.3:*:*:*:*:*:*:*", "matchCriteriaId": "E7B641E5-ABFA-4BA0-9554-965B0F71277E"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:2.3.1:*:*:*:*:*:*:*", "matchCriteriaId": "E375D95F-4ABC-4988-A459-D41ADC834CF7"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:2.3.2:*:*:*:*:*:*:*", "matchCriteriaId": "B582211F-5481-4B70-858F-F569C376F504"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:2.3.3:*:*:*:*:*:*:*", "matchCriteriaId": "EF487385-1962-4820-BCEE-2148A02CB875"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:2.4:*:*:*:*:*:*:*", "matchCriteriaId": "6D4B221E-2877-4400-ABA3-1A271BDEAE89"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:3.0:*:*:*:*:*:*:*", "matchCriteriaId": "C66DE2FB-3562-4986-BCE6-778B2CD4DDAE"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:3.0.1:*:*:*:*:*:*:*", "matchCriteriaId": "8BAEFD16-38B7-44CB-87CC-9923F4DDE4C3"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:3.0.2:*:*:*:*:*:*:*", "matchCriteriaId": "A39F2A95-16CA-4FAB-B2DC-4F4BE0C4E7DF"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:3.0.3:*:*:*:*:*:*:*", "matchCriteriaId": "F876E601-187A-4B06-B907-8111B179E49F"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:3.0.4:*:*:*:*:*:*:*", "matchCriteriaId": "EAECF75C-4B2C-472D-9DFB-32E397E50398"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:3.0.5:*:*:*:*:*:*:*", "matchCriteriaId": "51382AB3-F26B-4279-8CF1-AC1E15938ADF"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:3.5:*:*:*:*:*:*:*", "matchCriteriaId": "423CF458-E40A-4AED-ACBA-1AA90BB4BE5A"}, {"vulnerable": true, "criteria": "cpe:2.3:a:gpeasy:gpeasy_cms:3.5.1:*:*:*:*:*:*:*", "matchCriteriaId": "7B4E0D8A-02F5-44D8-B2A4-75736EC271DE"}]}]}], "references": [{"url": "http://archives.neohapsis.com/archives/bugtraq/2013-01/0104.html", "source": "cve@mitre.org", "tags": ["Exploit"]}, {"url": "http://packetstormsecurity.com/files/119805/gpEasy-3.5.2-Cross-Site-Scripting.html", "source": "cve@mitre.org", "tags": ["Exploit"]}, {"url": "https://exchange.xforce.ibmcloud.com/vulnerabilities/81472", "source": "cve@mitre.org"}, {"url": "https://github.com/oyejorge/gpEasy-CMS/commit/40f1b4a5749a621cd27c5ca39900dbcf8701969d", "source": "cve@mitre.org", "tags": ["Exploit", "Patch"]}, {"url": "https://www.htbridge.com/advisory/HTB23137", "source": "cve@mitre.org", "tags": ["Exploit"]}]}, "github_commit_url": "https://github.com/oyejorge/gpEasy-CMS/commit/40f1b4a5749a621cd27c5ca39900dbcf8701969d"}}