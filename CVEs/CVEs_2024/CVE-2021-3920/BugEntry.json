{"buggy_code": ["# v1.10.24\n## 10/26/2021\n\n1. [](#new)\n   * Require **Grav 1.7.24**\n2. [](#improved)\n   * Use new `Http\\Response` rather than deprecated `GPM\\Response`\n3. [](#bugfix)\n   * Fixed an issue with invalid HTML throwing errors on HTML security scanning\n   * Clear cache when installing plugins\n\n# v1.10.23\n## 09/29/2021\n\n1. [](#new)\n   * Updated SCSS compiler to v1.8\n2. [](#improved)\n   * Updated with latest language strings from Crowdin.com\n3. [](#bugfix)\n   * Fixed images from plugins/themes disappearing when saving twice\n\n# v1.10.22\n## 09/16/2021\n\n1. [](#new)\n    * Updated SCSS compiler to v1.7\n\n# v1.10.21\n## 09/14/2021\n\n1. [](#new)\n    * Require **Grav 1.7.21**\n2. [](#improved)\n    * Added a note about UTC times in scheduler AT syntax help\n    * Now using a monospaced text-based scheduler AT field in scheduler for simplicity\n    * Improved `Admin:data()` and `Admin::getConfigurationData()` to be more strict\n3. [](#bugfix)\n    * Fixed configuration save location to point to existing config folder [#2176](https://github.com/getgrav/grav-plugin-admin/issues/2176)\n\n# v1.10.20\n## 09/01/2021\n\n1. [](#bugfix)\n    * Fixed regression `Argument 4 passed to Grav\\Plugin\\Form\\TwigExtension::prepareFormField() must be of the type array` [#2177](https://github.com/getgrav/grav-plugin-admin/issues/2177)\n    * Fixed `X-Frame-Options` to be `DENY` in all admin pages to prevent a clickjacking attack\n\n# v1.10.19\n## 08/31/2021\n\n1. [](#new)\n    * Require **Grav 1.7.19** and **Form 5.1.0** and **Login 3.5.0**\n    * Updated SCSS compiler to v1.6\n2. [](#improved)\n    * Updated forms and nested fields to use new form logic\n    * Admin form now use layout `admin`, meaning you can create admin specific field templates by `forms/fields/myfield/admin-field.html.twig`\n    * Stop using `|tu` filter, Grav already has the same logic in `|t` for admin\n    * Remove unneeded escapes\n    * Allow removal of plugin when disabled [#2167](https://github.com/getgrav/grav-plugin-admin/issues/2167)\n3. [](#bugfix)\n    * Fixed missing values in `fieldset` form field\n\n# v1.10.18\n## 07/19/2021\n\n1. [](#improved)\n    * Add logic to allow fieldset form field inside a list field [#2159](https://github.com/getgrav/grav-plugin-admin/pull/2159)\n\n# v1.10.17\n## 06/15/2021\n\n1. [](#improved)\n    * Added timestamp as title in logs date [#2141](https://github.com/getgrav/grav-plugin-admin/issues/2141)\n    * Use `base64_encode` filter rather than function\n    * Composer update\n1. [](#bugfix)\n    * Fixed missing `Remove Theme` button when the theme is inactive\n    * Update taskGetChildTypes() to use Flex Pages (works without the plugin) [#2087](https://github.com/getgrav/grav-plugin-admin/issues/2087)\n\n# v1.10.16\n## 06/02/2021\n\n1. [](#bugfix)\n    * Fixed issue with some elements overflowing closed list items [#2146](https://github.com/getgrav/grav-plugin-admin/issues/2146)\n    * Fixed configuration not fully updating on save [#2149](https://github.com/getgrav/grav-plugin-admin/issues/2149)\n    * Fixed display issue with \"+ Add Page\" and picking a different route [#2136](https://github.com/getgrav/grav-plugin-admin/issues/2136), [#2145](https://github.com/getgrav/grav-plugin-admin/issues/2145)\n    * Treat WebP as image when inserting / drag & dropping [#2150](https://github.com/getgrav/grav-plugin-admin/issues/2150)\n\n# v1.10.15\n## 05/19/2021\n\n1. [](#new)\n    * Updated SCSS compiler to v1.5\n1. [](#improved)\n    * Updated node modules dev dependencies\n    * Package.json scripts cleanup\n    * Recompiled JS for production\n    * Use `base645_encode` filter rather than function\n    * Editor: Do not assume images URLs are going to be `http://` (wrong assumption plus not SSL) [#2127](https://github.com/getgrav/grav-plugin-admin/issues/2127)\n    * Improved Theme Activation + Plugin Enabled logic to ensure configuration is not displayed unless activation/enabled state. Fixes [#2140](https://github.com/getgrav/grav-plugin-admin/issues/2140)\n1. [](#bugfix)\n    * Fixed issue with slugify where single curly quotes in titles would translate to straight single quote [#2101](https://github.com/getgrav/grav-plugin-admin/issues/2101)\n    * Fix z-index issue with fullscreeen editor (and toolips) [#2143](https://github.com/getgrav/grav-plugin-admin/issues/2143)\n\n# v1.10.14\n## 04/29/2021\n\n1. [](#improved)\n    * Added a `min_height:` option for list field\n1. [](#bugfix)\n    * Fixed z-index issue for tooltips in sidebar\n    * Fixed custom files being overridden during theme update [#2135](https://github.com/getgrav/grav-plugin-admin/issues/2135)\n\n# v1.10.13\n## 04/23/2021\n\n1. [](#new)\n    * Added refresh action button for Folder to ease the regeneration of the slug based on the title. Available also as API entry `Grav.default.Forms.Fields.FolderField.Regenerate()` [#1738](https://github.com/getgrav/grav-plugin-admin/issues/1738)\n1. [](#improved)\n    * Removed sourcemaps references from fork-awesome.min.css [#2122](https://github.com/getgrav/grav-plugin-admin/issues/2122)\n    * Support native spell checkers in CodeMirror editor [#1266](https://github.com/getgrav/grav-plugin-admin/issues/1266)\n    * Added new 'Content Highlight' color to presets\n    * Copying Pages now prompts a dedicated modal that allows for picking title, folder name, parent location, page template and visibility [#1738](https://github.com/getgrav/grav-plugin-admin/issues/1738)\n    * Updated with latest language translations from Crowdin.com\n1. [](#bugfix)\n    * Moved preset CSS compile to earlier in the process to ensure compilation happens in time.\n    * Prevent Save actions from Flex Objects to trigger the unsaved unload notice [#2125](https://github.com/getgrav/grav-plugin-admin/issues/2125)\n    * Fixed audit vulnerabilities in module dependencies and house cleanup [#2096](https://github.com/getgrav/grav-plugin-admin/issues/2096)\n    * Fixed issue preventing Drag & Drop of media files while in Expert Mode [#1927](https://github.com/getgrav/grav-plugin-admin/issues/1927)\n    * Fixed broken link colors in `preset.css` which was causing issues with tabs and dropdowns\n    * Fixed permissions for page related tasks and actions\n    * Fixed permission check for configuration save [#2130](https://github.com/getgrav/grav-plugin-admin/issues/2130)\n    * Fixed missing/wrong page categories and tags when multi-language support is enabled [#2107](https://github.com/getgrav/grav-plugin-admin/issues/2107)\n\n# v1.10.12\n## 04/15/2021\n\n1. [](#bugfix)\n    * Regression: Fixed broken plugin/theme installer in admin\n    * Fixed error reporting for AJAX tasks if user has no permissions\n    * Fixed missing slash in password reset URL [#2119](https://github.com/getgrav/grav-plugin-admin/issues/2119)\n\n# v1.10.11\n## 04/13/2021\n\n1. [](#bugfix)\n    * **IMPORTANT** Fixed security vulnerability that allows installation of plugins with minimal admin privileges [GHSA-wg37-cf5x-55hq](https://github.com/getgrav/grav-plugin-admin/security/advisories/GHSA-wg37-cf5x-55hq)\n    * Fixed `You have been logged out` message when entering to 2FA authentication due to `/admin/task:getNotifications` AJAX call\n    * Fixed broken 2FA login when site is not configured to use Flex Users [#2109](https://github.com/getgrav/grav-plugin-admin/issues/2109)\n    * Fixed error message when user clicks logout link after the session has been expired\n\n# v1.10.10\n## 04/07/2021\n\n1. [](#bugfix)\n    * Fixed missing `admin-preset.css` in multisite environments\n    * Regression: Fixed broken 2FA form [#2109](https://github.com/getgrav/grav-plugin-admin/issues/2109)\n\n# v1.10.9\n## 04/06/2021\n\n1. [](#new)\n    * Requires **Grav 1.7.10**\n1. [](#improved)\n    * Better isolate admin to prevent session related vulnerabilities\n    * Removed support for custom login redirects for improved security\n    * Shorten forgot password link lifetime from 7 days to 1 hour\n    * Updated with latest language translations from Crowdin.com\n1. [](#bugfix)\n    * Fixed issue where Adding a new page and canceling from within Editing would alter the Parent location of the edited page [#2067](https://github.com/getgrav/grav-plugin-admin/issues/2067)\n    * Fixed and enhanced Range field to be Lists compatible [#2062](https://github.com/getgrav/grav-plugin-admin/issues/2062)\n    * Fixed ERR_TOO_MANY_REDIRECTS with HTTPS = 'On' [#2100](https://github.com/getgrav/grav-plugin-admin/issues/2100)\n    * Prevent expert editing mode from anyone else than super users [#2094](https://github.com/getgrav/grav-plugin-admin/issues/2094)\n    * Fixed login related pages being accessible from admin when user has logged in\n    * Fixed admin user creation and password reset allowing unsafe passwords\n    * Fixed missing validation when registering the first admin user\n    * Fixed reset password email not to have session specific token in it\n    * Fixed admin controller running before setting `$grav['page']`\n\n# v1.10.8\n## 03/19/2021\n\n1. [](#improved)\n    * Include alt text and title for images added to the editor [#2098](https://github.com/getgrav/grav-plugin-admin/issues/2098)\n1. [](#bugfix)\n    * Fixed issue replacing `wildcard` field names in flex collections [#2092](https://github.com/getgrav/grav-plugin-admin/pull/2092)\n    * Fixed legacy Pages having old `modular` reference instead of `module` [#2093](https://github.com/getgrav/grav-plugin-admin/issues/2093)\n    * Fixed issue where Add New modal would close if selecting an item outside of the modal window. It is now necessary go through the Cancel button and clicking the overlay won't trigger the closing of the modal [#2089](https://github.com/getgrav/grav-plugin-admin/issues/2089), [#2065](https://github.com/getgrav/grav-plugin-admin/issues/2065)\n\n# v1.10.7\n## 03/17/2021\n\n1. [](#improved)\n    * Force height of Flex pages admin to fit available space\n    * Updated languages from Crowdin.com\n    * Better field type definitions for file, pagemedia, filepicker and pagemediafield\n1. [](#bugfix)\n    * Fixed error when checking missing log file [#2088](https://github.com/getgrav/grav-plugin-admin/issues/2088)\n\n# v1.10.6\n## 02/23/2021\n\n1. [](#new)\n    * Vastly improved support for RTL languages [#2078](https://github.com/getgrav/grav-plugin-admin/pull/2078)\n1. [](#improved)\n    * Flex pages admin better uses available space [#2075](https://github.com/getgrav/grav/issues/2075)\n1. [](#bugfix)\n    * Regression: Fixed enabling/disabling plugin or theme corrupting configuration\n    * Fixed unnecessary closing bracket causing JS error [#2079](https://github.com/getgrav/grav-plugin-admin/issues/2079)\n    * Fixed wrong language in Admin Tools [#2077](https://github.com/getgrav/grav-plugin-admin/issues/2077)\n\n# v1.10.5\n## 02/18/2021\n\n1. [](#bugfix)\n    * Regression: Fixed fatal error in admin if POST request has `data` in it [#2074](https://github.com/getgrav/grav-plugin-admin/issues/2074)\n    * Fixed Admin creating empty `user/config/info.yaml` file (the file can be safely removed, it is not in use)\n    * Fixed ACL for users with mixed case usernames [#2073](https://github.com/getgrav/grav-plugin-admin/issues/2073)\n\n# v1.10.4\n## 02/17/2021\n\n1. [](#new)\n    * Added support to include new page creation modals in other pages by using `form_action` twig variable [#2024](https://github.com/getgrav/grav-plugin-admin/pull/2024)\n    * Updated all languages from [Crowdin](https://crowdin.com/project/grav-admin) - Please update any translations here\n1. [](#improved)\n    * Removed `noscript` template, because 2021...\n    * List field: added new `placement` property to decide wether to add new items at the top, bottom or based on the *position* of the clicked button [#2055](https://github.com/getgrav/grav-plugin-admin/pull/2055)\n    * Ensure admin default CSS styles load **first**, and presets loads **last**\n    * Tweaked handling of uploaded files [#1429](https://github.com/getgrav/grav-plugin-admin/issues/1429)\n    * Provide media object and filename in `onAdminAfterDelMedia` event [#1905](https://github.com/getgrav/grav-plugin-admin/pull/1905)\n1. [](#bugfix)\n    * Fixed case-sensitive `accept` in `filepicker` field\n    * Fixed HTML Entities in titles [#2028](https://github.com/getgrav/grav-plugin-admin/issues/2028)\n    * Fixed deleting list field options completely, didn't save changes [#2056](https://github.com/getgrav/grav-plugin-admin/issues/2056)\n    * Fixed `onAdminAfterAddMedia` and `onAdminAfterDelMedia` events always pointing to the home page\n    * Fixed ACL for Configuration tabs [#771](https://github.com/getgrav/grav-plugin-admin/issues/771)\n    * Fixed changelog button showing up in Info page even if user cannot access it\n    * Fixed toggleable checkboxes being unchecked in fieldset columns [#2063](https://github.com/getgrav/grav-plugin-admin/issues/2063)\n    * Fixed issue with max backups of zero [#2070](https://github.com/getgrav/grav-plugin-admin/issues/2070)\n\n# v1.10.3\n## 02/01/2021\n\n1. [](#new)\n    * Requires **Grav 1.7.4** (SemVer library moved to Grav)\n    * Added back special fonts (including Gantry)\n2. [](#bugfix)\n    * Fixed field type `range` not taking into account legitimate `0` values\n    * Fixed `Call to a member function trackHit() on null` [#2049](https://github.com/getgrav/grav-plugin-admin/issues/2049)\n\n# v1.10.2\n## 01/21/2021\n\n2. [](#bugfix)\n    * Fixed admin style compilation failing to save CSS if assets folder does not exist\n\n# v1.10.1\n## 01/20/2021\n\n1. [](#improved)\n    * Added `watch.sh` for compiling SCSS with native sass compiler\n2. [](#bugfix)\n    * Fixed issue with overlapping sidebar when using fullscreen editor [#2022](https://github.com/getgrav/grav-plugin-admin/issues/2022)\n\n# v1.10.0\n## 01/19/2021\n\n1. [](#new)\n    * Requires **Grav 1.7 and PHP 7.3.6**\n    * Read about this release in the [Grav 1.7 Released](https://getgrav.org/blog/grav-1.7-released) blog post\n    * Read the full list of changes in the [Changelog on GitHub](https://github.com/getgrav/grav-plugin-admin/blob/1.10.0/CHANGELOG.md)\n    * Please read [Grav 1.7 Upgrade Guide](https://learn.getgrav.org/17/advanced/grav-development/grav-17-upgrade-guide) before upgrading!\n1. [](#improved)\n    * Various notifications improvements\n1. [](#bugfix)\n    * Fixed missed highlight on the selected page in Parents field\n    * Fixed notifications that would not be remembered as hidden\n    * Fixed taxonomy field not listing existing options in Flex Pages\n    * Fixed taxonomy field not working outside pages\n    * Fixed fatal error when moving a page using the old implementation [#2019](https://github.com/getgrav/grav-plugin-admin/issues/2019)\n    * Fixed evaluating default value in `hidden` field (thanks @NicoHood)\n\n# v1.10.0-rc.20\n## 12/14/2020\n\n1. [](#improved)\n    * Cookies now explicitly set `SameSite` to `Lax` unless otherwise specified [#1998](https://github.com/getgrav/grav-plugin-admin/issues/1998)\n    * Exposed **Cookies** class (`Grav.default.Utils.Cookies`) for developers that need it in Admin.\n1. [](#bugfix)\n    * Fixed Plugins references in Themes details page.\n    * Fixed issue preventing purchase of Themes within Admin and redirecting instead.\n    * Regression: Values inside Fieldset do not display [#1995](https://github.com/getgrav/grav-plugin-admin/issues/1995)\n\n# v1.10.0-rc.19\n## 12/02/2020\n\n1. [](#improved)\n    * Just keeping sync with Grav rc.19\n\n# v1.10.0-rc.18\n## 12/02/2020\n\n1. [](#new)\n    * Retired \"Secure Delete\" and \"Warn on page delete\". You are now always warned and asked to confirm a deletion.\n1. [](#improved)\n    * Auto-link a plugin/theme license in details if it starts with `http`\n    * Allow to fallback to `docs:` instead of `readme:`\n    * Forward a `sid` to GPM when downloading a premium package\n    * Better support for array field key/value when either key or value is stored empty [#1972](https://github.com/getgrav/grav-plugin-admin/issues/1972)\n    * Remember the open state of the sidebar [#1973](https://github.com/getgrav/grav-plugin-admin/issues/1973)\n    * Upgraded node dependencies to latest version. Improved speed of JS compilation.\n    * Added modal to confirm updating Grav as well as cool down counter before enabling Update button [#1257](https://github.com/getgrav/grav-plugin-admin/issues/1257)\n    * Better handling of offline/intranet mode when the repository index is missing. Faster admin. [#1916](https://github.com/getgrav/grav-plugin-admin/issues/1916)\n    * Statistics is now Page View Statistics [#1885](https://github.com/getgrav/grav-plugin-admin/issues/1885)\n    * It is now possible to use regex as values for \"Hide page types in Admin\" and \"Hide modular page types in Admin\" settings [#1828](https://github.com/getgrav/grav-plugin-admin/issues/1828)\n    * Default to `disabled` state for all cron-jobs\n1. [](#bugfix)\n    * Fixed Safari issue with new ACL picker field [#1955](https://github.com/getgrav/grav-plugin-admin/issues/1955)\n    * Stop propagation of ACL add button in ACL picker [flex-objects#83](https://github.com/trilbymedia/grav-plugin-flex-objects/issues/83)\n    * Fixed missing special groups `authors` and `defaults` for pages\n    * Fixed Page Move action and selection highlight in Parents selector modal [flex-objects#80](https://github.com/trilbymedia/grav-plugin-flex-objects/issues/80)\n    * Fixed folder auto-naming in Add Module [#1937](https://github.com/getgrav/grav-plugin-admin/issues/1937)\n    * Fixed remodal issue triggering close when selecting a dropdown item ending outside of scope [#1682](https://github.com/getgrav/grav-plugin-admin/issues/1682)\n    * Reworked how collapsed lists work so the tooltip is not cut off [#1928](https://github.com/getgrav/grav-plugin-admin/issues/1928)\n    * Fixed KeepAlive issue where too large of a session value would fire the keep alive immediately [#1860](https://github.com/getgrav/grav-plugin-admin/issues/1860)\n    * Fixed stringable objects breaking the inputs\n    * Fixed filepicker, pagemediaselect fields with `multiple: true` and `array: true` [#1580](https://github.com/getgrav/grav-plugin-admin/issues/1580)\n\n# v1.10.0-rc.17\n## 10/07/2020\n\n1. [](#new)\n    * Support premium themes\n1. [](#improved)\n    * Improved some error messages for better readability\n    * Strip tags from browser title\n1. [](#bugfix)\n    * More multi-site routing fixes\n    * Fixed issue that would force a page reload when failing to install/update a plugin or theme.\n    * Fixed proxy/browser caching issues in admin pages\n\n# v1.10.0-rc.16\n## 09/01/2020\n\n1. [](#improved)\n    * Made all the `onAdmin*` CRUD events to pass `object` (and backwards compatible `page`) to make them easier to use\n    * Updated vendor libraries including `SCSSPHP` to v1.2\n1. [](#bugfix)\n    * Fixed issue with File field being used in Theme/Plugins\n    * Fixed bad redirection after successful admin login in subdirectory multisite [#1487](https://github.com/getgrav/grav-plugin-admin/issues/1487)\n\n# v1.10.0-rc.15\n## 07/22/2020\n\n1. [](#bugfix)\n    * Disabled the EXIF library for Dropzone for fixing the orientation as it was getting applied twice [#1923](https://github.com/getgrav/grav-plugin-admin/issues/1923)\n    * Forked Dropzone fo fix issue with Resize + Exif orientation [#1923](https://github.com/getgrav/grav-plugin-admin/issues/1923)\n    * Fixed URI encode for the preview of images names\n\n# v1.10.0-rc.14\n## 07/09/2020\n\n1. [](#improved)\n    * Completely removed old Google font support for upgrade compatibility\n1. [](#bugfix)\n    * Fixed bad `use` reference to `UserObject`\n\n# v1.10.0-rc.13\n## 07/01/2020\n\n1. [](#improved)\n    * Improved color picker field\n    * Trim login route for safety\n    * Composer update to grab latest vendor libs\n\n# v1.10.0-rc.12\n## 06/08/2020\n\n1. [](#new)\n    * Added ability to set a preferred markdown editor in user profile\n    * Added new `onAdminListContentEditors` event to add a custom editor to the list of available\n1. [](#bugfix)\n    * Fixed issue deleting file from a plugin's configuration\n    * Use `Pages::find()` instead of `Pages::dispatch()` as we do not want to redirect out of admin\n    * Fixed broken `parent` field when using the old pages\n    * Fixed broken `file` field preview when using streams in the path\n\n# v1.10.0-rc.11\n## 05/14/2020\n\n1. [](#new)\n    * Major enhancements to \"White Label\" functionality including ability to export/import presets\n    * New horizontal scroller for theme presets\n    * Codemirror Fontsize / Preset / Font preference options\n1. [](#improved)\n    * Fixed lots of styling issues related to \"White Label\" presets\n    * Changed out \"One Light\" theme for new \"Firewatch Light\" theme\n    * New scrolling system based on `SimpleBar` + native CSS scrollbar styling\n\n# v1.10.0-rc.10\n## 04/30/2020\n\n1. [](#new)\n    * Addd new `taskConvertUrls` method for use with 3rd party editors\n\n# v1.10.0-rc.9\n## 04/27/2020\n\n1. [](#new)\n    * Added new \"White Label\" functionality to customize admin colors + logos\n    * Added badge count for children in the Parents field\n1. [](#improved)\n    * Added markdown support to `text` in `section` field\n1. [](#bugfix)\n    * Prevent loading Pages in Parents field if they don't have children\n    * Fixed custom folder in `mediapicker` field not working with streams\n    * Fixed language redirect adding extra language prefix in Flex\n    * Fixed `Invalid input in \"Parent\"` when saving page in raw mode [#1869](https://github.com/getgrav/grav-plugin-admin/issues/1869)\n\n# v1.10.0-rc.8\n## 03/19/2020\n\n1. [](#new)\n    * Added `has-children` flag in parent field data response\n    * Added `RESET` en lang string\n1. [](#bugfix)\n    * Fixed parent field not working with regular pages\n\n# v1.10.0-rc.7\n## 03/05/2020\n\n1. [](#new)\n    * Enable admin cache by default (for existing sites, check `Plugins > Admin Panel > Enable Admin Caching`)\n1. [](#improved)\n    * Removed old `scss.sh` and `watch.sh` scripts, use `gulp watch-css`\n    * Added keysOnly parameter to `AdminPlugin::pagesTypes()` and `AdminPlugin::pagesModularTypes()` methods\n    * Added ignore parameter to `Admin::types()` and `Admin::modularTypes()` methods\n    * Improved configuration fields for hiding page types in Admin\n1. [](#bugfix)\n    * Fixed minor UI padding in Flex pages [#1825](https://github.com/getgrav/grav-plugin-admin/issues/1825)\n    * Fixed `column` and `section` fields loosing user entered value when form submit fails\n    * Fixed `order` field not working with a new Flex Page\n\n# v1.10.0-rc.6\n## 02/11/2020\n\n1. [](#new)\n    * Pass phpstan level 1 tests\n    * Updated semver library to v1.5\n    * Require flex-objects plugin\n1. [](#improved)\n    * Added some debugging messages (turned off by default)\n\n# v1.10.0-rc.5\n## 02/03/2020\n\n1. [](#new)\n    * No changes, just keeping things in sync with Grav RC version\n\n# v1.10.0-rc.4\n## 02/03/2020\n\n1. [](#new)\n    * Added message to dashboard to install Flex Objects plugin if it is missing\n    * Updated `permissions` field to use new `$grav['permissions']`\n    * DEPRECATED `onAdminRegisterPermissions` event, use `PermissionsRegisterEvent::class` event instead\n    * DEPRECATED `Admin::setPermissions()` and `Admin::addPermissions()`, use `PermissionsRegisterEvent::class` event instead\n    * DEPRECATED `Admin::getPermissions()`, use `$grav['permissions']->getInstances()` instead\n1. [](#improved)\n    * Added `field.show_label` and `field.label` display logic from frontend forms\n1. [](#bugfix)\n    * Fixed user profile when using `Flex Users` only in admin\n    * Fixed saving data with empty field, default value (from config, plugin, theme) was used instead\n    * Fixed JS bug is using empty Grav URI param key\n    * Fixed bug in toggleable field being disabled with empty value (`''` `0`, `false`, `[]`...)\n    * Fixed `admin_route()` twig function to work properly with Grav 1.7.0-rc.4, which fixes `Route` base\n    * Fixed misleading 'Show sensitive data' configuration option wording [#1818](https://github.com/getgrav/grav-plugin-admin/issues/1818)\n\n# v1.10.0-rc.3\n## 01/02/2020\n\n1. [](#new)\n    * Added ability to display **Changelogs** for `Grav`, `Plugins` and `Themes`\n    * Added raw root page support for `Flex Pages`\n\n# v1.10.0-rc.2\n## 12/04/2019\n\n1. [](#new)\n    * Added support for hiding parts of admin by `Deny` permissions (`Flex Users` only)\n    * Optimized `parent` field for Flex Pages\n1. [](#improved)\n    * Improved `permissions` field to add support for displaying calculated permissions\n    * Grav 1.7: Updated deprecated `$page->modular()` method calls to `$page->isModule()`\n    * Output the current process user name in Scheduler instructions\n    * Translations: rename MODULAR to MODULE everywhere\n1. [](#bugfix)\n    * Fixed `permissions` field with nested permissions\n    * Fixed Save Shortcut (CTRL + S / CMD + S) not working with new Flex Pages [#1787](https://github.com/getgrav/grav-plugin-admin/issues/1787)\n\n# v1.10.0-rc.1\n## 11/06/2019\n\n1. [](#new)\n    * Added a new `onAdminLogFiles()` event for 3rd party plugins to register log files for log viewer [#1765](https://github.com/getgrav/grav-plugin-admin/issues/1765)\n1. [](#improved)\n    * Improved delete button UI [#1769](https://github.com/getgrav/grav-plugin-admin/issues/1769)\n    * Ability to configure display of 3rd party dashboard widgets [#1766](https://github.com/getgrav/grav-plugin-admin/issues/1766)\n1. [](#bugfix)\n    * Fixed administrator user creation when `Flex Users` is enabled\n    * Fixed minor button alignment in FF [#1760](https://github.com/getgrav/grav-plugin-admin/issues/1760)\n\n# v1.10.0-beta.10\n## 10/03/2019\n\n1. [](#bugfix)\n    * Regression: Fixed language assignments for the pages without set language\n\n# v1.10.0-beta.9\n## 09/26/2019\n\n1. [](#bugfix)\n    * Make pages field to work with Flex Pages\n\n# v1.10.0-beta.8\n## 09/19/2019\n\n1. [](#new)\n    * Add ability to Sanitize SVGs on file upload\n    * Add ability to Sanitize SVGs in Page media\n1. [](#improved)\n    * YAML linter report now supports multi-language\n    * Better colors/placement of toolbar buttons in page edit view\n1. [](#bugfix)\n    * Fixed missing language for AJAX requests\n    * Fixed redirect with absolute language URL\n    * Fixed issue with user avatar reference not being deleted when image removed\n\n# v1.10.0-beta.7\n## 08/30/2019\n\n1. [](#bugfix)\n    * Fixed regression: Do not require Flex Objects plugin [grav#2653](https://github.com/getgrav/grav/issues/2653)\n\n# v1.10.0-beta.6\n## 08/29/2019\n\n1. [](#improved)\n    * Optimized admin for speed (only load frontend pages on demand)\n    * Updated navigation menu to be fully controlled and overrideable by `onAdminMenu` event\n    * Lots of Flex Page speed improvements\n\n# v1.10.0-beta.5\n## 08/11/2019\n\n1. [](#new)\n    * Added `data()` twig function to create data object from an array\n1. [](#improved)\n    * Better support for `array` field into `list` field\n    * Made RAW blueprints (expert mode) to work properly with Flex Form\n    * Better support for `clockwork` logs\n1. [](#bugfix)\n    * Fixed issue with nested `list` fields both utilizing the custom `key` functionality\n    * Regression: Page Preview not working, bad url [#1715](https://github.com/getgrav/grav-plugin-admin/issues/1715)\n    * Fixed '+New Folder' to work with new parent picker\n    * Fixed missing XSS check field when editing modular page as raw\n    * Fixed minor CSS layout issue [#1717](https://github.com/getgrav/grav-plugin-admin/issues/1717)\n\n# v1.10.0-beta.4\n## 07/01/2019\n\n1. [](#new)\n    * Added `Admin::redirect()` method to allow redirects to be used outside of controllers\n    * Added `$admin->adminRoute()` method and `admin_route()` twig function to create language aware admin page links\n    * Renamed `Admin::route()` to `Admin::getCurrentRoute()` and deprecated the old call\n1. [](#improved)\n    * Much improved multi-language support for pages\n    * Admin redirects should now work better with multiple languages enabled\n1. [](#bugfix)\n    * Fixed default language being renamed to `page.en.md` (English) instead of keeping existing `page.md` filename\n    * Fixed possibility to override already existing translation by `Save As Language`\n    * Fixed missing default translation if page used plain `.md` file extension without language code\n    * Fixed wrong translation showing up as page fallback language\n    * Integrated Admin 1.9.8 bug fixes\n\n# v1.10.0-beta.3\n## 06/24/2019\n\n1. [](#improved)\n    * Smarter handling of symlinks in parent field\n1. [](#bugfix)\n    * Fixed issue with windows paths in `parent` field [#1699](https://github.com/getgrav/grav-plugin-admin/issues/1699)\n\n# v1.10.0-beta.2\n## 06/21/2019\n\n1. [](#improved)\n    * Moved Remodal in-house and added support for stackable modals [#1698](https://github.com/getgrav/grav-plugin-admin/issues/1698), [#1699](https://github.com/getgrav/grav-plugin-admin/issues/1699)\n1. [](#bugfix)\n    * Fixed missing check for maximum allowed files in `files` field\n\n# v1.10.0-beta.1\n## 06/14/2019\n\n1. [](#new)\n    * New Parent/Move field using Ajax for better performance\n    * Improvements to cache clearing when admin cache is enabled\n    * Require Grav v1.7\n    * Use PSR-4 for plugin classes\n    * Added support for Twig 2.11 (compatible with Twig 1.40+)\n1. [](#improved)\n    * Various admin performance improvements\n1. [](#bugfix)\n    * Fixed admin caching issues\n\n# v1.9.19\n## 12/14/2020\n\n1. [](#bugfix)\n    * Fixed `pages` field escaping issues, needs Grav update, too [#1990](https://github.com/getgrav/grav-plugin-admin/issues/1990)\n    * Fixed Plugins references in Themes details page.\n    * Fixed issue preventing purchase of Themes within Admin and redirecting instead.\n    * Fixed Page Picker not passing admin token\n\n# v1.9.18\n## 12/02/2020\n\n1. [](#new)\n    * Never allow Admin pages to be rendered in `<frame>`, `<iframe>`, `<embed>` or `<object>` for improved security\n1. [](#improved)\n    * Auto-link a plugin/theme license in details if it starts with `http`\n    * Allow to fallback to `docs:` instead of `readme:`\n    * Backported finder/pages navigation from 1.10 (you will still need 1.10 for the fancy Parent Picker)\n    * Forward a `sid` to GPM when downloading a premium package\n    * Add focus states to login buttons [#1839](https://github.com/getgrav/grav-plugin-admin/pull/1839)\n    * Output raw text in paragraph for fieldset [#1956](https://github.com/getgrav/grav-plugin-admin/pull/1956)\n    * Set scheduled items to be 'disabled' by default\n    * Added scheduler warning about potential dangers of use\n1. [](#bugfix)\n    * Escape page title in `pages` field\n    * Fixed unused task RemoveMedia, it cannot be used directly anymore [GHSA-945r-cjfm-642c](https://github.com/getgrav/grav-plugin-admin/security/advisories/GHSA-945r-cjfm-642c)\n    * Tightened checks when removing a media file [GHSA-945r-cjfm-642c](https://github.com/getgrav/grav-plugin-admin/security/advisories/GHSA-945r-cjfm-642c)\n    * Removed unused parameter in file field [GHSA-945r-cjfm-642c](https://github.com/getgrav/grav-plugin-admin/security/advisories/GHSA-945r-cjfm-642c)\n    * Fixed backup download URL [GHSA-vrvq-2pxg-rw5r](https://github.com/getgrav/grav-plugin-admin/security/advisories/GHSA-vrvq-2pxg-rw5r)\n    * Fixed deleting backup [GHSA-85r3-mf4x-qp8f](https://github.com/getgrav/grav-plugin-admin/security/advisories/GHSA-85r3-mf4x-qp8f)\n\n# v1.9.17\n## 10/07/2020\n\n1. [](#new)\n    * Support premium themes\n    * Back-ported functionality from Admin 1.10 required for upcoming WYSIWYM Nextgen Editor\n1. [](#improved)\n    * Improved some error messages for better readability\n1. [](#bugfix)\n    * Fixed issue that would force a page reload when failing to install/update a plugin or theme\n    * Fixed proxy/browser caching issues in admin pages\n\n# v1.9.16\n## 09/01/2020\n\n1. [](#bugfix)\n    * Fixed a glitch which allows user to delete entire pages directory [#1941](https://github.com/getgrav/grav-plugin-admin/issues/1941)\n    * Fixed the hidden login plugin toggle\n\n# v1.9.15\n## 06/08/2020\n\n1. [](#bugfix)\n    * Support markdown in `fieldset.text` [#2934](https://github.com/getgrav/grav/issues/2934)\n    * Fix data URLs in avatar images [#1889](https://github.com/getgrav/grav/issues/1889)\n    * Fix for deleting files in plugin configurations\n\n# v1.9.14\n## 04/27/2020\n\n1. [](#improved)\n    * Added `slug` and `type` to blueprints\n1. [](#bugfix)\n    * Support markdown in `fieldset.text` [#2934](https://github.com/getgrav/grav/issues/2934)\n\n# v1.9.13\n## 03/05/2020\n\n1. [](#improved)\n    * Updated vendor libs\n1. [](#bugfix)\n    * Fixed toggleable buttons no longer holding false state [form#406](ttps://github.com/getgrav/grav-plugin-form/issues/406)\n\n# v1.9.12\n## 12/04/2019\n\n1. [](#bugfix)\n    * Fixed saving configuration in PHP 7.4\n\n# v1.9.11\n## 11/06/2019\n\n1. [](#improved)\n    * Added new \"secure delete\" functionality [#1752](https://github.com/getgrav/grav-plugin-admin/issues/1752)\n    * Center text logo [#1751](https://github.com/getgrav/grav-plugin-admin/issues/1751)\n    * Added required span to editor field [#1748](https://github.com/getgrav/grav-plugin-admin/issues/1748)\n    * Warn users if JS is disabled [#1722](https://github.com/getgrav/grav-plugin-admin/issues/1722)\n    * Added target rule to quick links [#1518](https://github.com/getgrav/grav-plugin-admin/issues/1518)\n1. [](#bugfix)\n    * Fixed `Badly encoded JSON data` warning when uploading files [grav#2663](https://github.com/getgrav/grav/issues/2663)\n    * Fixed `accept` for SVG in `file` uploaders [#1732](https://github.com/getgrav/grav-plugin-admin/issues/1732)\n\n# v1.9.10\n## 09/19/2019\n\n1. [](#bugfix)\n    * Fixed `Badly encoded JSON data` warning when uploading files [grav#2663](https://github.com/getgrav/grav/issues/2663)\n\n# v1.9.9\n## 08/21/2019\n\n1. [](#bugfix)\n    * Fixed regression with files in admin not allowing types other than images [#1737](https://github.com/getgrav/grav-plugin-admin/issues/1737)\n    * Fixed preview link for non-images files in **Page Media** [#1727](https://github.com/getgrav/grav-plugin-admin/issues/1727)\n\n# v1.9.8\n## 08/11/2019\n\n1. [](#improved)\n    * Better support for `array` field into `list` field\n    * Attach `_list_index` to fields within list items so that the index/key is available\n1. [](#bugfix)\n    * Fixed 2FA regenerate for Flex Users\n    * Added missing closing </li> in language loops\n    * Fixed issue with nested `list` fields both utilizing the custom `key` functionality\n    * Fixed issue with `array` field nested in `list` that were losing their index order when the list reordered\n    * Fixed file form field failing resolution checks in certain circumstances\n    * Fixed issue with deleting files in config based YAML files\n\n# v1.9.7\n## 06/21/2019\n\n1. [](#bugfix)\n    * Fixed issue with charts in dashboard where label would cut off [#1700](https://github.com/getgrav/grav-plugin-admin/issues/1700)\n    * Resetting a user's password clears the user's site access [grav#2528](https://github.com/getgrav/grav/issues/2528)\n    * Fixed issue with permissions toggle [#1702](https://github.com/getgrav/grav-plugin-admin/issues/1702)\n\n# v1.9.6\n## 06/15/2019\n\n1. [](#bugfix)\n    * Fixed regression issue with `parents_levels` defaulting to `2`\n\n# v1.9.5\n## 06/14/2019\n\n1. [](#improved)\n    * Display error message if GPM class fails to initialize\n    * Better append/prepend logic that was breaking some layouts\n    * Default `backups` to an array if used outside of tools\n    * PSR 7 fixes\n\n# v1.9.4\n## 05/09/2019\n\n1. [](#new)\n    * Added support for `field.copy-to-clipboard` on Text input fields\n1. [](#improved)\n    * Only invalidate cache on creating new/deleting page to speed up the recovery\n    * Updated language strings from https://crowdin.com/project/grav-admin\n    * Use `plugins://` stream rather than `user://plugins` [#1674](https://github.com/getgrav/grav-plugin-admin/issues/1674)\n1. [](#bugfix)\n    * Fixed admin cache to detect moved and deleted pages\n    * Fixed avatar URLs with `?` in them being broken\n    * Fixed issue saving page with language that was not exactly `2` or `5` chars long [#1667](https://github.com/getgrav/grav-plugin-admin/issues/1667)\n    * Fixed admin not detecting any existing users when Flex users are being used\n    * Fixed issue with append/prepend not respecting `size:`\n    * Fixed issue with `unset` on file fields [#1427](https://github.com/getgrav/grav/issues/1427), [#1670](https://github.com/getgrav/grav/issues/1670), [#1982](https://github.com/getgrav/grav/issues/1982)\n\n# v1.9.3\n## 04/22/2019\n\n1. [](#new)\n    * Added a new **YAML Linter** report to the `Tools - Reports` section\n1. [](#improved)\n    * Updated package.json scripts to properly use gulp compiler\n\n# v1.9.2\n## 04/15/2019\n\n1. [](#bugfix)\n    * Fix for homepage admin preview [#2426](https://github.com/getgrav/grav/issues/2426)\n    * Uploaded Avatar removed from user's yaml when editing the user [#1647](https://github.com/getgrav/grav-plugin-admin/issues/1647)\n\n# v1.9.1\n## 04/13/2019\n\n1. [](#bugfix)\n    * Fix for Page saving issues [#1648](https://github.com/getgrav/grav-plugin-admin/issues/1648)\n    * Remove status message when picking folder for move [#1650](https://github.com/getgrav/grav-plugin-admin/issues/1650)\n\n# v1.9.0\n## 04/11/2019\n\n1. [](#new)\n    * New `Scheduler` configuration panel in tools\n    * New `Backups` configuration panel in tools\n    * New `Cache::purge()` option in cache drop-down to clear out old cache only\n    * New `Tools - Reports` section with event `onAdminGenerateReports()` for 3rd party plugin support\n    * Added support for the new `Flex User` object\n    * Allow admin forms to use `Form` classes\n    * Added new `Logs` section to tools to allow quick view of Grav log files\n1. [](#improved)\n    * Improved the UI for the Parent Page Route dropdown when adding a new Page / Folder\n    * Use `$grav['accounts']` instead of `$grav['users']`\n    * Improved image background overlay and tools\n    * Better unauthorized user rendering\n    * Update all Form classes to rely on `PageInterface` instead of `Page` class\n    * Removed `media.upload_limit` references\n    * Improve error when upload exceeds `upload_max_filesize`\n    * Delegate Dropzone for checking maximum file size and avoid uploading if not necessary\n    * Low level unauthorized user handling in `base-root.html.twig`\n    * Refactored \"NewsFeeds\" and \"Notifications\" for better performance and to address CORS issues\n    * Flex user profile now uses Flex Form\n    * Moved dashboard `notifications` logic to server-side for increased performance (1 request instead of 3)\n    * Refactored feeds logic for better performance\n    * Better logic for delete action to support Ajax. Fixes Flex lists\n    * Cleanly handle session corruption due to changing Flex object types\n    * Implemented [ForkAwesome](https://forkawesome.github.io/Fork-Awesome/) and removed FontAwesome + LineAwesome\n    * Various default admin theme improvements and cleanup\n    * Make new System Config layout responsive [#1579](https://github.com/getgrav/grav-plugin-admin/issues/1579)\n    * Homepage link should be `https://` [#1564](https://github.com/getgrav/grav-plugin-admin/issues/1564)\n    * Improve lang string to describe XSS security settings [#1566](https://github.com/getgrav/grav-plugin-admin/issues/1566)\n    * Take admin setting for 2FA into account when showing user 2FA badge [#1568](https://github.com/getgrav/grav-plugin-admin/issues/1568)\n    * Moved `ignore` and `key` field into form plugin\n    * Improved usability of `System` configuration blueprint with side-tabs\n    * Cleaned up UI in `Scheduler` tools page\n    * Updated languages\n1. [](#bugfix)\n    * Fixed user edit links if Flex Objects plugin is installed but user isn't Flex User\n    * Fixed deprecated `sameas()` Twig test\n    * Regression: Fixed lost user access when saving user profile without super user permissions [#1639](https://github.com/getgrav/grav-plugin-admin/issues/1639)\n    * Fixed `Page.menu` displaying in edit view rather than `Page.title` [#1642](https://github.com/getgrav/grav-plugin-admin/issues/1642)\n    * Regression from beta.8: Deleting files other than from plugins/themes fail on error\n    * Fixed issue with Safari browser and blueprint fields with `toggleable: true` [#1643](https://github.com/getgrav/grav-plugin-admin/issues/1643)\n    * Incorrect 2FA lang code [#1618](https://github.com/getgrav/grav-plugin-admin/issues/1618)\n    * Fixed potential undefined property in `onPageNotFound` event handling\n    * Proper fix for `vUndefined` when updating plugins/themes\n    * Text in Tab Tools/Direct install disappears [#1613](https://github.com/getgrav/grav-plugin-admin/issues/1613)\n    * Fallback to page `slug` in Pages list if title is empty [grav#2267](https://github.com/getgrav/grav/issues/2267)\n    * Fixes backup button issues with `;` param separator [#1602](https://github.com/getgrav/grav-plugin-admin/issues/1602) [#1502](https://github.com/getgrav/grav-plugin-admin/issues/1502)\n    * Set default state for `show_modular` to `true` [#1599](https://github.com/getgrav/grav-plugin-admin/issues/1599)\n    * Removed `tabs`, `tab`, and `toggle` fields as they are now in Form plugin\n    * Fix issue with new page always showing modular page templates [#1573](https://github.com/getgrav/grav-plugin-admin/issues/1573)\n    * Fixed issue deleting files in plugins/themes/config\n    * Fixed array support in admin languages, e.g. `DAYS_OF_THE_WEEK`\n    * Fixed user login / remember me triggering before admin gets initialized\n    * Fixed a bug when deleting files via AJAX\n    * Fixed error page not to be the frontend version\n    * Added `merge_items` option for `field.selectize` to allow storing custom items [#1461](https://github.com/getgrav/grav-plugin-admin/issues/1461)\n    * Better handling of unset in uploaded files [#1427](https://github.com/getgrav/grav-plugin-admin/issues/1427)\n    * Prefix Backup/Scheduler titles with `Tools`\n    * Regression: Media settings have bad layout [#1529](https://github.com/getgrav/grav-plugin-admin/issues/1529)\n    * Fixed Direct Install Uploader, failing to validate the uploaded files\n    * Regression: Editing interface does not keep settings properly without manual intervention on each edit [#1527](https://github.com/getgrav/grav-plugin-admin/issues/1527)\n    * Removed duplicate language strings\n    * Fixed default `job_at` so it does not fail if missing\n    * Minor JS group `bottom` fix\n\n# v1.8.20\n## 03/20/2019\n\n1. [](#improved)\n    * Added security field to column [#1622](https://github.com/getgrav/grav-plugin-admin/pull/1622)\n\n# v1.8.19\n## 02/13/2019\n\n1. [](#bugfix)\n    * Moved `show_modular` to proper place - Doh! [grav#2362](https://github.com/getgrav/grav/issues/2362)\n\n# v1.8.18\n## 02/12/2019\n\n1. [](#bugfix)\n    * Set default value for `show_modular` [grav#2362](https://github.com/getgrav/grav/issues/2362)\n\n# v1.8.17\n## 02/07/2019\n\n1. [](#improved)\n    * Improved Grav Core installer/updater to run installer script (if available)\n    * Added `unauthorized.html.twig` file that was missing [#1609](https://github.com/getgrav/grav-plugin-admin/pull/1609)\n1. [](#bugfix)\n    * Fixed direct install deleting backups and logs if used with full Grav package instead of with update package\n\n# v1.8.16\n## 01/25/2019\n\n1. [](#improved)\n    * IP pseudonymization for rate limiter [#1589](https://github.com/getgrav/grav-plugin-admin/pull/1589)\n    * Add option to hide modular pages in parent select [#1571](https://github.com/getgrav/grav-plugin-admin/pull/1571)\n    * Added `admin.tools` permission [#1550](https://github.com/getgrav/grav-plugin-admin/pull/1550)\n1. [](#bugfix)\n    * Fixed calendar js module not properly loading for datetime field [#1581](https://github.com/getgrav/grav-plugin-admin/issues/1581)\n    * Fixed deleting file when using file field type [#1558](https://github.com/getgrav/grav-plugin-admin/issues/1558)\n    * Unset state from user if not super or user admin\n\n# v1.8.15\n## 12/14/2018\n\n1. [](#improved)\n    * Fire `onAdminSave()` event during `AdminController::taskSaveAs()` [#1544](https://github.com/getgrav/grav-plugin-admin/issues/1544)\n1. [](#bugfix)\n    * Clean user post to ensure dynamically added form fields are not saved\n\n# v1.8.14\n## 11/12/2018\n\n1. [](#bugfix)\n    * Fixed Grav core update potentially spinning forever because of an error which happens after a successful upgrade\n    * Saving in expert mode can cause `undefined index: header` error [#1537](https://github.com/getgrav/grav-plugin-admin/issues/1537)\n\n# v1.8.13\n## 11/05/2018\n\n1. [](#new)\n    * Added new `|nested()` Twig filter to access array objects with dot notation syntax\n1. [](#bugfix)\n    * Fixed issue with complex lists structure and nested dot-notation [admin#2236](https://github.com/getgrav/grav/issues/2236)\n\n# v1.8.12\n## 10/24/2018\n\n1. [](#improved)\n    * Updated various lang strings\n    * Removed duplicate lang strings\n1. [](#bugfix)\n    * Fix XSS checking when empty content [#1533](https://github.com/getgrav/grav-plugin-admin/issues/1533)\n    * Fix DirectInstall not working [#1535](https://github.com/getgrav/grav-plugin-admin/issues/1535)\n\n# v1.8.11\n## 10/08/2018\n\n1. [](#improved)\n    * Change usage of basename where possible [#1480](https://github.com/getgrav/grav-plugin-admin/pull/1480)\n    * Improved filename validation (requires Grav 1.5.3)\n    * Updated various lang codes\n1. [](#bugfix)\n    * File Uploads: Do not trust mimetype sent by the browser\n    * Fixed file extension detection\n    * Fix for HTML entities in page slug [#1524](https://github.com/getgrav/grav-plugin-admin/issues/1524)\n    * Fix for port in backup download links [#1521](https://github.com/getgrav/grav-plugin-admin/issues/1521)\n\n# v1.8.10\n## 10/01/2018\n\n1. [](#new)\n    * IMPORTANT: Non `admin.super` users are now subject to XSS validation in Page content.  Configurable via Configuration / Security\n    * New XSS content warnings and integration into page save\n    * Added new event `onAdminPage()` which allows plugins to customize `Page` object in `$event['page']`\n1. [](#improved)\n    * Use `Url:post()` to get the `$_POST` variable (allows common security checks/filtering for the POST data)\n    * Requires Grav 1.5.2\n1. [](#bugfix)\n    * Fixed redirect to correct URL after failed login\n    * Fixed issue in `filepicker` where missing images would cause a loop to try to load them\n    * Twig 2 compatibility fixes for macros\n    * Updated `composer.json` to better match Grav 1.5\n    * Remove `package-lock.json` as it was referencing an insecure JS package\n\n# v1.8.9\n## 08/23/2018\n\n1. [](#improved)\n    * Make order field to use context, not data\n    * Switched to new Grav Yaml class to support Native + Fallback YAML libraries\n    * Minor fix for `file` thumbnails display\n    * Requires Grav 1.5.1\n\n# v1.8.8\n## 08/17/2018\n\n1. [](#improved)\n    * Support URI Params and Query attributes in Login redirect\n    * Added support for textarea value type in `array` field\n    * Added some new lang strings for Grav 1.5.0\n1. [](#bugfix)\n    * Support params and querystring in login redirect\n    * Added field name nesting with tab field\n\n# v1.8.7\n## 07/31/2018\n\n1. [](#bugfix)\n    * Fix for deleting 'extra' media files [grav#2100](https://githubcom/getgrav/grav/issues/2100)\n\n# v1.8.6\n## 07/13/2018\n\n1. [](#bugfix)\n    * Force `html` for markdown preview [grav#2066](https://github.com/getgrav/grav/issues/2066)\n    * Add missing `authorizeTask()` checks in controller [#1483](https://github.com/getgrav/grav/issues/1483)\n    * Add support for `force_ssl` to admin URLs [#1479](https://github.com/getgrav/grav-plugin-admin/issues/1479)\n\n# v1.8.5\n## 06/20/2018\n\n1. [](#bugfix)\n    * Fixed broken folder attribute on filepicker [#1465](https://github.com/getgrav/grav-plugin-admin/issues/1465)\n    * Added translation for system.session.initialize\n    * Slight updates on new translation strings\n\n# v1.8.4\n## 06/11/2018\n\n1. [](#improved)\n    * Including EXIF JS library in the modules dependencies to fix orientation when uploading images\n1. [](#bugfix)\n    * Initialize session on setup [#1451](https://github.com/getgrav/grav-plugin-admin/issues/1451)\n    * Force a `null` order when empty in the post request\n    * Fixed some 2FA form styling issues\n\n# v1.8.3\n## 05/31/2018\n\n1. [](#new)\n    * Added support for selectize plugins as options in the selectize field\n1. [](#bugfix)\n    * Fixed deep linking in admin after login [#1456](https://github.com/getgrav/grav-plugin-admin/issues/1456)\n    * Fixed Undefined property: `stdClass::$image` in v1.8.2 [#1454](https://github.com/getgrav/grav-plugin-admin/issues/1454)\n    * Pass media order when calling `task:listmedia`\n\n# v1.8.2\n## 05/24/2018\n\n1. [](#new)\n    * Added custom object support for filepicker field\n    * Don't allow saving of a user with no local account file\n    * Controls for `list` field were not in sync between top and bottom\n1. [](#improved)\n    * More subtle `fieldset` styling\n1. [](#bugfix)\n    * Check if `$object->blueprints()` exists in `onAdminAfterSave`\n    * When creating first user, check `admin.login` not `site.login`\n    * Fix admin login redirects for multisite setups\n    * Fixed issue with filepicker field where images wouldn't properly merge with the current value if in a page header\n    * Fixed media delete for streams\n\n# v1.8.1\n## 05/15/2018\n\n1. [](#improved)\n    * use SHA1 hashing of IP addressed to support GDPR rules [#1436](https://github.com/getgrav/grav-plugin-admin/pull/1436)\n1. [](#bugfix)\n    * Fixed 2FA form showing up even if user has not turned on the feature [#1442](https://github.com/getgrav/grav-plugin-admin/issues/1442)\n    * Fixed previews of images in Pagemedia field not properly URI encoded [#1438](https://github.com/getgrav/grav-plugin-admin/issues/1438)\n\n# v1.8.0\n## 05/11/2018\n\n1. [](#new)\n    * Moved 2FA authentication to login plugin\n    * Admin login now uses login plugin events\n    * Added new decoupled `pagemedia` field that is no longer tied to just pages\n    * Updated plugin dependencies (Grav >= 1.4.4, Form >=2.14.0, Login >=2.7.0, Email >=2.7.0)\n1. [](#improved)\n    * Added support for JavaScript `bottom` block [#1425](https://github.com/getgrav/grav-plugin-admin/pull/1425)\n    * Added better typography styling for blockquote and markdown in `display` field\n    * Vendor updates\n1. [](#bugfix)\n    * Added missing MarkdownExtra strings [#1385](https://github.com/getgrav/grav-plugin-admin/pull/1385)\n    * Updated `blueprints.yaml` with missing `step` attribute [#1415](https://github.com/getgrav/grav-plugin-admin/pull/1415)\n    * Fixed preview target setting [#1430](https://github.com/getgrav/grav-plugin-admin/pull/1430)\n    * Added new modular string [#1433](https://github.com/getgrav/grav-plugin-admin/pull/1433)\n    * Fixed Firefox issue with the Regenerate button for 2FA. Forcing the page to reload\n    * Fixed jumpiness behavior for Regenerate button when on active state.\n    * Prevent the prompt for unsaved state when Regenerating a 2FA code and trying to reload/leave the page.\n\n# v1.7.4\n## 04/02/2018\n\n1. [](#bugfix)\n    * Fixed a bug for page copy caused by last release [#1409](https://github.com/getgrav/grav-plugin-admin/pull/1409)\n    * Fixed collapsible `list` option [#1410](https://github.com/getgrav/grav-plugin-admin/pull/1410)\n    * Fixed a minor typo in a label [#1397](https://github.com/getgrav/grav-plugin-admin/pull/1397)\n\n# v1.7.3\n## 04/01/2018\n\n1. [](#new)\n    * Implemented Resize Media and Resolution ('resizeWidth', 'resizeHeight', 'resizeQuality', 'resolution')\n    * Updated Dropzone to latest\n1. [](#bugfix)\n    * Implemented workaround for required text fields [#1390](https://github.com/getgrav/grav-plugin-admin/issues/1390)\n    * Fixed highlight color in Firefox [getgrav/grav#1949](https://github.com/getgrav/grav/issues/1949)\n    * Fix for bad redirect on saving simplesearch (possibly others)\n\n# v1.7.2\n## 03/21/2018\n\n1. [](#improved)\n    * Table CSS improvements for use in 3rd party plugins\n    * Translatable `add_modals` button labels [#1388](https://github.com/getgrav/grav-plugin-admin/issues/1388)\n    * Check for `SHIFT` key on editor save shortcut [#1383](https://github.com/getgrav/grav-plugin-admin/issues/1383)\n    * Fixed User permissions responsive UI [#1379](https://github.com/getgrav/grav-plugin-admin/issues/1379)\n    * Optimization to stop admin for looking for pages in disabled plugins\n    * Added configuration option to choose if you want to use new 'inline' preview or `new tab'\n1. [](#bugfix)\n    * Fix redirect bug when changing admin route to `admin-*`\n    * Changed Twig `|count` to `|length` filter [#1391](https://github.com/getgrav/grav-plugin-admin/issues/1391)\n    * Fix for page preview when `HTTP_REFERRER` is not set [grav#1930](https://github.com/getgrav/grav/issues/1930)\n\n# v1.7.1\n## 03/11/2018\n\n1. [](#new)\n    * New built-in page preview system\n1. [](#improved)\n    * Added `CTRL+K` / `CMD+K` shortcuts for editor links [#1279](https://github.com/getgrav/grav-plugin-admin/issues/1279)\n1. [](#bugfix)\n    * Automatically redirect to new `admin_route` after changing it [#1371](https://github.com/getgrav/grav-plugin-admin/issues/1371)\n    * Remove bad-shadows on alerts\n    * Fixed notifications titles not html escaped [#1272](https://github.com/getgrav/grav-plugin-admin/issues/1272)\n    * Fixed extra horizontal scrollbar with `Editor` field\n    * Fixed `mediapicker` field in lists [#1369](https://github.com/getgrav/grav-plugin-admin/issues/1369)\n\n# v1.7.0\n## 03/09/2018\n\n1. [](#new)\n    * Added styling and lang for **Route Overrides** in the default page blueprint\n    * Added clear cache permanently to quick-tray [#1353](https://github.com/getgrav/grav-plugin-admin/issues/1353)\n1. [](#improved)\n    * Added option to toggle between `line-awesome` and `font-awesome` icon sets [#1334](https://github.com/getgrav/grav-plugin-admin/issues/1334)\n    * Added preview from page list view [#1250](https://github.com/getgrav/grav-plugin-admin/pull/1250)\n    * Added `Add` plugins button to plugins details page [#1352](https://github.com/getgrav/grav-plugin-admin/pull/1352)\n    * Added support for `default` and `options` fields in taxonomy field [#1364](https://github.com/getgrav/grav-plugin-admin/issues/1364)\n    * Added support to limit parent field levels [#1298](https://github.com/getgrav/grav-plugin-admin/issues/1298)\n1. [](#bugfix)\n    * Fixed issue with custom logo text overlapping the sidebar toggle [#1334](https://github.com/getgrav/grav-plugin-admin/issues/1334)\n    * Fixed issues with minimum PHP versions in resource upgrades\n    * Fixed issue with default lang translation in admin [#1361](https://github.com/getgrav/grav-plugin-admin/issues/1361)\n    * Typos in `Tools` -> `Direct Install` page [#1345](https://github.com/getgrav/grav-plugin-admin/issues/1345)\n    * Fixed bug with frontmatter being killed when in `Expert Mode` [#1354](https://github.com/getgrav/grav-plugin-admin/issues/1354)\n\n# v1.7.0-rc.3\n## 02/15/2018\n\n1. [](#improved)\n    * Tab optimization with fixes for 'onpage' tabs\n    * Stopped Chrome from auto-completing admin user profile form [grav#1847](https://github.com/getgrav/grav/issues/1847)\n    * Added a fixed `ga-theme-17x` body class to help styling compatibility\n    * Outputs an iterable field as a string if `yaml: true` or `validate: type: yaml` set in blueprint\n1. [](#bugfix)\n    * Rolled back JS to known working versions [#1323](https://github.com/getgrav/grav-plugin-admin/issues/1323)\n    * Fixed missing translation in order field [#1324](https://github.com/getgrav/grav-plugin-admin/issues/1324)\n    * Fixed UI issue with last drop-down in button group [1325](https://github.com/getgrav/grav-plugin-admin/issues/1325)\n    * Fixed fieldset field outdated rendering [#1313](https://github.com/getgrav/grav-plugin-admin/issues/1313)\n\n# v1.7.0-rc.2\n## 01/24/2018\n\n1. [](#new)\n    * Moved to LineAwesome icons rather than FontAwesome (still compatible w/FA 4.7.0)\n1. [](#improved)\n    * Simplified open/close nav button\n    * Tidied Tools panel and added translations\n    * Tooltip and new icon for site preview\n    * Updated JS library dependencies\n    * Changed CodeMirror editor to use sans-serif font for readability\n1. [](#bugfix)\n    * Fixed z-index issue in fullscreen mode [#1317](https://github.com/getgrav/grav-plugin-admin/issues/1317)\n\n# v1.7.0-rc.1\n## 01/22/2018\n\n1. [](#new)\n    * Added support for markdown in all form fields for `label`, `help`, and `description` when `markdown: true` is set on field\n    * Changed \"made by\" to Trilby Media from RocketTheme\n1. [](#improved)\n    * Lightened tabs in new theme\n    * Sort languages by key [#1303](https://github.com/getgrav/grav-plugin-admin/issues/1303)\n    * Add limit to Parent Levels [#1298](https://github.com/getgrav/grav-plugin-admin/pull/1298)\n1. [](#bugfix)\n    * Fixed alignment issue with language drop-down\n    * Fixed a z-index issue with fullscreen editor [#1302](https://github.com/getgrav/grav-plugin-admin/issues/1302)\n    * Fixed missing background on register [#1307](https://github.com/getgrav/grav-plugin-admin/issues/1307)\n    * Fixed some style issues with field descriptions\n    * Fixed an issue with `File` field losing download size setting\n    * Fixed distorted thumbnails in `File` field by using `object-fit: cover`\n\n# v1.7.0-beta.1\n## 12/29/2017\n\n1. [](#new)\n    * New lighter-and-tighter admin theme developed\n1. [](#improved)\n    * Added simple value support for list field type\n    * Added checks to automatically hide collapse buttons when there's only single value in list type\n\n# v1.6.7\n## 12/05/2017\n\n1. [](#new)\n    * Logout of admin goes straight to login form with a message (that then fades out)\n    * Added `sl`, `id`, `he`, `eu`, `et` languages\n1. [](#improved)\n    * Added code to use new `GPM::loadRemoteGrav` if it exists in Gav [grav#1746](https://github.com/getgrav/grav/pull/1746)\n    * Add vertical style for order field [#1253](https://github.com/getgrav/grav-plugin-admin/pull/1253)\n    * Added classes to pagemedia field [#1274](https://github.com/getgrav/grav-plugin-admin/issues/1274)\n    * Fixed selectize field not properly updating value when `option` is provided [#1236](https://github.com/getgrav/grav-plugin-admin/pull/1236)\n    * Tab layout tweaks\n    * Updated all language files with latest from [Crowdin](https://crowdin.com/project/grav-admin)\n1. [](#bugfix)\n    * Manual image metadata can now display in pagemedia when auto-generation is disabled [#1275](https://github.com/getgrav/grav-plugin-admin/issues/1275)\n    * Removed broken `home.hide_in_urls` code in `AdminBaseController::save()` that was throwing move errors\n    * Security fix to ensure file uploads are not manipulated mid-post - thnx @FLH!\n\n# v1.6.6\n## 10/27/2017\n\n1. [](#new)\n    * Fixed issue where sortable media in expert mode would reset frontmatter [#1252](https://github.com/getgrav/grav-plugin-admin/issues/1252)\n\n# v1.6.5\n## 10/26/2017\n\n1. [](#new)\n    * Added ability to **order** page media (requires latest Grav update)\n\n# v1.6.4\n## 10/11/2017\n\n1. [](#improved)\n    * Use system PHP size for upload limit rather than `system.media.upload_limit` or `file.filesize` plugin options\n1. [](#bugfix)\n    * Fixed Dropzone timeout to address slow internet connections [#1239](https://github.com/getgrav/grav-plugin-admin/pull/1239)\n\n# v1.6.3\n## 10/02/2017\n\n1. [](#bugfix)\n    * Fixed chart labels not parsing HTML [#1234](https://github.com/getgrav/grav-plugin-admin/issues/1234)\n\n# v1.6.2\n## 09/29/2017\n\n1. [](#improved)\n    * Removed extraneous files in vendor folder for smaller download package\n\n# v1.6.1\n## 09/29/2017\n\n1. [](#improved)\n    * Added support for Latin Extended fonts [#1211](https://github.com/getgrav/grav-plugin-admin/pull/1221)\n    * Added collapsible attribute to lists [#1231](https://github.com/getgrav/grav-plugin-admin/pull/1231)\n1. [](#bugfix)\n    * Fix editor not clickable in list field [#1224](https://github.com/getgrav/grav-plugin-admin/pull/1124)\n    * Updated Google Font URLs to always connect over HTTPS. [#1106](https://github.com/getgrav/grav-plugin-admin/pull/1106)\n    * Fixed fieldset field not allowing to properly save when contained within a list [#1225](https://github.com/getgrav/grav-plugin-admin/issues/1225)\n    * Fixed Video markdown syntax when drag & dropping in the content editor [#1160](https://github.com/getgrav/grav-plugin-admin/issues/1160)\n    * Fixed headers drop-down in editor to properly align\n    * Fixed fields not working in Microsoft Edge with Selectize.js [#1222](https://github.com/getgrav/grav-plugin-admin/pull/1222)\n    * Replaced a left-over \"is empty\" check [#1232](https://github.com/getgrav/grav-plugin-admin/pull/1232)\n    * Fixed headers drop-down in editor to align properly\n\n\n# v1.6.0\n## 09/07/2017\n\n1. [](#new)\n    * **Added 2-Factor Authentication support to the admin!**\n    * **Added rate-limiting for \"failed login attempts\" and \"forgot password\"**\n1. [](#improved)\n    * Revamped the toggle switch CSS so it's more flexible and works better [#1198](https://github.com/getgrav/grav-plugin-admin/issues/1198)\n    * Improved toggle/button alignment on Page edit view\n1. [](#bugfix)\n    * Fixed an issue where icon-picker style was hiding field elements [#1199](https://github.com/getgrav/grav-plugin-admin/issues/1199)\n    * Fixed https -> http redirect issue [#1195](https://github.com/getgrav/grav-plugin-admin/issues/1195)\n    * Also check `/.` for home route [#1191](https://github.com/getgrav/grav-plugin-admin/issues/1191)\n    * Fixed administration being broken in multi-site environments with plugin overrides\n    * Fixed lang-switcher broken in MS Edge browser [#1213](https://github.com/getgrav/grav-plugin-admin/pull/1213)\n    * Added custom `form_id` attribute for modal forms [#1216](https://github.com/getgrav/grav-plugin-admin/issues/1216)\n    * Fixed partially cropped line in Markdown editor for MS Edge/Firefox [#1219](https://github.com/getgrav/grav-plugin-admin/pull/1219)\n    * Downgraded Babel libraries to v6.x for compatibility with webpack [#1218](https://github.com/getgrav/grav-plugin-admin/pull/1218)\n\n# v1.5.2\n## 08/16/2017\n\n1. [](#new)\n    * Added a new icon quick-tray in side navigation that plugins can utilize\n    * Added ability to set and retrieve temporary admin messages\n1. [](#improved)\n    * Allow different field to be used as page label in list of pages [#1122](https://github.com/getgrav/grav-plugin-admin/pull/1122)\n    * Updated `en` language for `cache-control` + `clear_images_by_default` system settings\n    * Allow sorting of page based on custom ordering [#1182](https://github.com/getgrav/grav-plugin-admin/pull/1182)\n    * Search for pages by slug and folder name [#1183](https://github.com/getgrav/grav-plugin-admin/pull/1183)\n    * Allow all page data to be used during `onAdminCreatePageFrontmatter()` event [#1175](https://github.com/getgrav/grav-plugin-admin/pull/1175)\n    * Remove single quotes when slugifying title [#1178](https://github.com/getgrav/grav-plugin-admin/pull/1178)\n1. [](#bugfix)\n    * Ignore missing Twig files [#1169](https://github.com/getgrav/grav-plugin-admin/issues/1169)\n    * If from is already defined, don't override it [#1129](https://github.com/getgrav/grav-plugin-admin/issues/1129)\n    * Fixed SelectUnique field not working with files with spaces\n\n# v1.5.1\n## 07/19/2017\n\n1. [](#bugfix)\n    * Fixes issue when saving pages without a `folder` element [#1163](https://github.com/getgrav/grav-plugin-admin/issues/1163)\n    * Fixed mediapicker field inside lists not properly updating the value on the target input [#1157](https://github.com/getgrav/grav-plugin-admin/issues/1157)\n\n# v1.5.0\n## 07/16/2017\n\n1. [](#new)\n    * Implemented Offline mode. Notifies in the admin when disconnected.\n1. [](#bugfix)\n    * Fixed fetch issue throwing error when request not completed and while unloading the page [#1301](https://github.com/getgrav/grav-plugin-admin/issues/1301)\n    * Fixed ordering when > 100 pages [grav#1564](https://github.com/getgrav/grav/pull/1564)\n    * Fixed Lists issue when reindexing, causing Radio fields to potentially lose their `checked` status ([#1154](https://github.com/getgrav/grav-plugin-admin/issues/1154) | related: [1d55ffc](https://github.com/getgrav/grav-plugin-admin/commit/1d55ffc616125047f245efe9f2180ef2c16b4949))\n\n# v1.5.0-rc.4\n## 07/05/2017\n\n1. [](#new)\n    * New `multilevel` field, useful for defining collections definitions, metadata and other complex YAML data [#1135](https://github.com/getgrav/grav-plugin-admin/pull/1135) - (EXPERIMENTAL)\n    * Fix plugins hooked nav authorize not working with array of permissions [#1148](https://github.com/getgrav/grav-plugin-admin/pull/1148)\n1. [](#improved)\n    * Add badge to plugins hooked into nav [#1147](https://github.com/getgrav/grav-plugin-admin/pull/1147)\n    * Added `field.outerclasses` to default form field [#1124](https://github.com/getgrav/grav-plugin-admin/pull/1124)\n    * Reverted back to textarea/YAML for `media.yaml` image options\n    * Fixed color of textarea fields in admin\n1. [](#bugfix)\n    * Fix for bad referenced to `shouldLoadAdditionalFilesInBackground()` [#1145](https://github.com/getgrav/grav-plugin-admin/pull/1145)\n    * Expose Page Media instance to Grav Admin JS API\n    * Fixed mediapicker issue where newly added list items would not work\n    * Fixed issue with min/max setting of list collections. Removing a list item would not refresh properly the count\n    * If folder is empty/not sent, fallback to page slug [#1146](https://github.com/getgrav/grav-plugin-admin/issues/1146)\n    * Escape the URI basename before using it in Twig\n    * Ignore missing Twig file in the Tools page\n\n# v1.5.0-rc.3\n## 06/22/2017\n\n1. [](#new)\n    * New `Admin::getPageMedia()` static method that can be used in blueprints\n    * Added a new `mediapicker` form field which allows to select a media from any page [#1125](https://github.com/getgrav/grav-plugin-admin/pull/1125)\n    * Added info metadata button for images to view EXIF and other useful details about an image\n1. [](#improved)\n    * Pass original image filename via the `AdminController::taskListedia()` task\n    * Various form styling improvements\n    * Provided an option to control how parent select field displays\n1. [](#bugfix)\n    * Fix referencing DI element when not initialized [#1141](https://github.com/getgrav/grav-plugin-admin/pull/1141)\n\n# v1.5.0-rc.2\n## 05/22/2017\n\n1. [](#improved)\n    * Remove save button and save location notification on Config Info tab [#1116](https://github.com/getgrav/grav-plugin-admin/pull/1116)\n    * Allow taxonomy field to just list one or more specific taxonomies if the `taxonomies` field is filled in the blueprint\n    * `File` field now renders thumbnail previews of the selected value on load\n    * Use new unified `Utils::getPagePathFromToken()` method rather\n1. [](#bugfix)\n    * Fix for undefined `include_metadata` error\n\n\n# v1.5.0-rc.1\n## 05/16/2017\n\n1. [](#new)\n    * Add support for a single array field in forms\n    * Added Prev/Next support on page editing view [#1112](https://github.com/getgrav/grav-plugin-admin/pull/1112)\n1. [](#improved)\n    * Improved full-screen editor for better browser compatibility [#1093](https://github.com/getgrav/grav-plugin-admin/pull/1093)\n    * Added ability to choose how you want the preview button to open [#1096](https://github.com/getgrav/grav-plugin-admin/pull/1096)\n    * `base.html.twig` now extends a `base-root.html.twig` file\n    * Add month+date indication to the stats graph to avoid confusion when there are days without visits\n    * Added `min` and `max` options for `list` form field [#1113](https://github.com/getgrav/grav-plugin-admin/pull/1113)\n    * Remove page metadata file on deletion of media\n    * Improved layout on pages list for pages with long titles [#1102](https://github.com/getgrav/grav-plugin-admin/pull/1102)\n    * Added option to make custom \"Add page\" dropdown entries [#1104](https://github.com/getgrav/grav-plugin-admin/pull/1104)\n1. [](#bugfix)\n    * Fixed issue with tab widths on Pages overlapping non-english toggle switch [#1089](https://github.com/getgrav/grav-plugin-admin/issues/1089)\n    * Added `vendor` to ignores for direct install of Grav\n    * Translated `field.default` for `editor` form field\n    * Fixed an quote error in `en.yaml`\n    * Resolved z-index issues with mobile nav and pages form elements\n    * Fixed issue with file picker where the selected file preview would not show\n    * Refresh page media on media upload\n    * Default to config file slug if translation is missing, otherwise use translation also in the tab title, not just in the page heading [#1039](https://github.com/getgrav/grav-plugin-admin/issues/1039)\n    * Fix language toggle button in admin top bar visible also in fullscreen mode [#1110](https://github.com/getgrav/grav-plugin-admin/issues/1110)\n    * Fix for editor padding [#1111](https://github.com/getgrav/grav-plugin-admin/issues/1111)\n    * Fix tabs inside blueprint overlapping above content [#1115](https://github.com/getgrav/grav-plugin-admin/pull/1115)\n\n# v1.4.2\n## 04/24/2017\n\n1. [](#new)\n    * Added a new `Content Padding` option to tighten up UI padding space (default `true`)\n1. [](#bugfix)\n    * Added back `Admin::initTheme()` relying on Grav fix [#1069](https://github.com/getgrav/grav-plugin-admin/pull/1069) as it conflicts ith Gantry5\n    * Fix for missing scrollbar when in full-size editor for Firefox [#1077](https://github.com/getgrav/grav-plugin-admin/issues/1077)\n    * Fix for overlay of Add-Page button in full-size editor [#1077](https://github.com/getgrav/grav-plugin-admin/issues/1077)\n    * Better fix for session-based parent overriding root page parents [#1078](https://github.com/getgrav/grav-plugin-admin/issues/1078)\n    * Allow support for `Pages::getList()` with `show_modular` option [#1080](https://github.com/getgrav/grav-plugin-admin/issues/1080)\n    * Added `[tmp,user]` ignores for direct install of Grav [grav#1447](https://github.com/getgrav/grav/issues/1447)\n\n# v1.4.1\n## 04/19/2017\n\n1. [](#bugfix)\n    * Reverted [#1069](https://github.com/getgrav/grav-plugin-admin/pull/1069) as it conflicts ith Gantry5\n\n# v1.4.0\n## 04/19/2017\n\n1. [](#new)\n    * Added ability to add new pages/folders while editing existing page\n1. [](#improved)\n    * Initialize theme in Admin Plugin [#1069](https://github.com/getgrav/grav-plugin-admin/pull/1069)\n    * Use new system configuration entries for username and password format\n    * Reworked Page parent field to use `Pages::getList()` rather than logic in Twig field itself\n    * More robust styling of admin themes page [#1067](https://github.com/getgrav/grav-plugin-admin/pull/1067)\n    * Fix fullscreen editor height [#1065](https://github.com/getgrav/grav-plugin-admin/pull/1065)\n    * Fix small UI issue in the editor with `codemirror.lineNumbers` && `codemirror.styleActiveLine` enabled\n    * Fix UI performance issue in the dashboard [#1064](https://github.com/getgrav/grav-plugin-admin/issues/1064)\n1. [](#bugfix)\n    * Fixed issue with parent not working with custom slug [#1068](https://github.com/getgrav/grav-plugin-admin/issues/1068)\n    * Fixed issue with new page modal not remembering last choice [#1072](https://github.com/getgrav/grav-plugin-admin/issues/1072)\n\n# v1.3.3\n## 04/12/2017\n\n1. [](#bugfix)\n    * Fix for regression introduced in the automatic page template switch when changing page parent [#1059](https://github.com/getgrav/grav-plugin-admin/issues/1059) [grav#1403](https://github.com/getgrav/grav/issues/1403) [#1062](https://github.com/getgrav/grav-plugin-admin/issues/1062)\n    * Fix issue with editor field in lists [#1037](https://github.com/getgrav/grav-plugin-admin/issues/1037)\n\n# v1.3.2\n## 04/10/2017\n\n1. [](#improved)\n    * Added new 'parents' field and switched Page blueprints to use this\n1. [](#bugfix)\n    * Fix for regression in h3 style in the Spacer field [#267](https://github.com/getgrav/grav-plugin-admin/issues/267)\n    * Fix missing preview in page media for SVG images [#1051](https://github.com/getgrav/grav-plugin-admin/issues/1051)\n    * Fix missing check when reordering [#1053](https://github.com/getgrav/grav-plugin-admin/issues/1053)\n    * Fix for editors not getting refreshed when changing tab [#1052](https://github.com/getgrav/grav-plugin-admin/issues/1052)\n    * Fix for mobile tabs in page editing [#1057](https://github.com/getgrav/grav-plugin-admin/issues/1057)\n\n# v1.3.1\n## 03/31/2017\n\n1. [](#bugfix)\n    * Fix for `Undefined index: file_path` error with Direct Install [#1043](https://github.com/getgrav/grav-plugin-admin/issues/1043)\n\n# v1.3.0\n## 03/31/2017\n\n1. [](#new)\n    * User uploadable avatar (still falls back to Gravatar if not provided)\n1. [](#improved)\n    * Improved tabs CSS to handle long titles [#1036](https://github.com/getgrav/grav-plugin-admin/issues/1036)\n    * Fixed `step` in range field [Form#136](https://github.com/getgrav/grav-plugin-form/issues/136)\n1. [](#bugfix)\n    * Fixed issue with exception thrown when `copying` and `moving` a page [#1042](https://github.com/getgrav/grav-plugin-admin/issues/1042)\n    * Automatically calculate the *next* numeric folder prefix [Core#1386](https://github.com/getgrav/grav/issues/1386)\n\n# v1.3.0-rc.3\n## 03/22/2017\n\n1. [](#new)\n    * All new `Page Ordering` implementation.  Completely revamped and will only reorder with folder-prefix enabled.  You can now reorder all siblings at the same time.\n    * Added a new `Advanced - Override` to allow option to display pages by folder name (default) or Collection definition\n    * Improved `range` form field with touch and counter support [#1016](https://github.com/getgrav/grav-plugin-admin/pull/1016)\n1. [](#bugfix)\n    * Cleanup package files via GPM install to make them more windows-friendly [#1361](https://github.com/getgrav/grav/pull/1361)\n\n# v1.3.0-rc.2\n## 03/17/2017\n\n1. [](#improved)\n    * Do not attempt to fetch any notification if settings are disabled [#942](https://github.com/getgrav/grav-plugin-admin/issues/942)\n\n# v1.3.0-rc.1\n## 03/13/2017\n\n1. [](#new)\n    * New flex-based/js Tabs system for better flexibility and improved UX.\n    * Added new **toolbox** with `Direct-Install` option via ZIP or URL.\n    * Added an option to reinstall a plugin/theme already installed [#984](https://github.com/getgrav/grav-plugin-admin/issues/984)\n    * Added a new **range field** [#995](https://github.com/getgrav/grav-plugin-admin/issues/995)\n    * When creating a new page, automatically select the Page Template based on Parent Page Child Type [#1008](https://github.com/getgrav/grav-plugin-admin/issues/1008)\n1. [](#improved)\n    * Page Media field now is available when folder is created, not just markdown file [#1000](https://github.com/getgrav/grav-plugin-admin/issues/1000)\n    * Separated user details and avatar in separate twig to allow more granular overriding in plugins [#989](https://github.com/getgrav/grav-plugin-admin/issues/989)\n    * Nicer layout of themes list on wider screen\n    * Editor full-screen option displays title/save options [#948](https://github.com/getgrav/grav-plugin-admin/issues/948)\n    * Use native OS highlight colors for the editor [#977](https://github.com/getgrav/grav-plugin-admin/issues/977)\n    * Force admin pages to set `Page::expires(0)` so it's not cached [#1009](https://github.com/getgrav/grav-plugin-admin/issues/1009)\n    * Added support for up to 15 tabs (was 10) [#954](https://github.com/getgrav/grav-plugin-admin/issues/954)\n    * Only reorder pages in the admin if collection uses `@self` and `order.by`\n    * Improved configuration tab sizes when you have lots of tabs\n    * Modified default media select size from 150px x 100px to 200px x 150px\n1. [](#bugfix)\n    * Fixed rendering issue with Chrome and sortables collections [#1002](https://github.com/getgrav/grav-plugin-admin/issues/1002)\n    * Fixed issue with removal of file that has been just uploaded and stored in the session\n\n\n# v1.2.14\n## 02/17/2017\n\n1. [](#bugfix)\n    * Fixed bad bug with `GPM::install()` from a change in Admin v1.2.13\n\n# v1.2.13\n## 02/17/2017\n\n1. [](#bugfix)\n    * Fix issue with validating page when switching language [#963](https://github.com/getgrav/grav-plugin-admin/issues/963)\n    * Fix issue with quotes in Admin strings used in JS [#965](https://github.com/getgrav/grav-plugin-admin/issues/965)\n    * Refactored `AdminController::taskGetUpdates` to use standard task/response [#980](https://github.com/getgrav/grav-plugin-admin/issues/980)\n    * Sync Admin pages blueprints with core [core#212d35221a9bbcc242508ba49a551b3f6e62af8e](https://github.com/getgrav/grav/commit/212d35221a9bbcc242508ba49a551b3f6e62af8e)\n\n# v1.2.12\n## 02/12/2017\n\n1. [](#bugfix)\n    * Rebuilt the JS bundle to address various JS-related issues that cropped up in `v1.2.11`\n    * Fixed Firefox Network Error issue when updating multiple plugins/themes at concurrently [#1301](https://github.com/getgrav/grav/issues/1301)\n\n# v1.2.11\n## 02/10/2017\n\n1. [](#new)\n    * Added lang strings for `CLI_COMPATIBILITY` which is new in Grav v1.1.16\n1. [](#improved)\n    * Allow plugin to set custom 'authorize' and 'location' in `onAdminMenu()` event\n    * Updated all language files with latest from [Crowdin](https://crowdin.com/project/grav-admin)\n1. [](#bugfix)\n    * Fixed issue `admin.super` or `admin.users` users changing the account when saving another user [#713](https://github.com/getgrav/grav-plugin-admin/issues/713)\n    * Fix issue where non `admin.super`/`admin.users` users could see other users profiles [#713](https://github.com/getgrav/grav-plugin-admin/issues/713)\n    * Fix removing responsive image from page media [#111](https://github.com/getgrav/grav-plugin-admin/issues/111) [#952](https://github.com/getgrav/grav-plugin-admin/issues/952)\n    * Use @2x & @3x fallback images in the filepicker. [#952](https://github.com/getgrav/grav-plugin-admin/issues/952)\n\n# v1.2.10\n## 1/30/2017\n\n1. [](#improved)\n    * It is now possible to manually specify a format for the `datetime` field [#1261](https://github.com/getgrav/grav/issues/1261)\n    * Allow to see plugins and themes list without internet connection. Also add a more helpful message in the \"add\" view [grav#1008](https://github.com/getgrav/grav/issues/1008)\n1. [](#bugfix)\n    * Fixed issue with downloaded package when installing a testing release\n    * Allow non admin.super users to change their account information. Allow `admin.super` and `admin.users` to change other users information. [#943](https://github.com/getgrav/grav/issues/943)\n    * Handle removing a media file also if it's not a json request. Was not working after https://github.com/getgrav/grav-plugin-admin/commit/6b343365996ce838759d80fa3917d4d994f1aeb4\n\n# v1.2.9\n## 01/18/2017\n\n1. [](#improved)\n    * Added lang strings for `ALLOW_WEBSERVER_GZIP` in System configuration\n\n# v1.2.8\n## 01/17/2017\n\n1. [](#improved)\n    * Allow the ability to clear the cache if `admin.maintenance`, as stated in the docs [#908](https://github.com/getgrav/grav-plugin-admin/issues/908)\n    * Added lang strings for `DEFAULT_LANG` in Site configuration\n    * Added lang strings for `NEVER_CACHE_TWIG` in System and Page configuration\n1. [](#bugfix)\n    * Fixed saving the configuration if not `admin.super`\n    * Show the clear cache buttons if the user has `admin.cache` permissions [#908](https://github.com/getgrav/grav-plugin-admin/issues/908#issuecomment-270748616)\n    * Fix colorpicker validation when transparency is set to 1.00 [#921](https://github.com/getgrav/grav-plugin-admin/issues/921)\n    * Fix html markup in section twig [#922](https://github.com/getgrav/grav-plugin-admin/pull/922)\n    * Fix bug in deleting a file uploaded with the `file` field [#920](github.com/getgrav/grav-plugin-admin/issues/920)\n    * Fix for plugin throwing event-based errors when plugin is removed and no longer available to process said event\n\n# v1.2.7\n## 12/22/2016\n\n1. [](#improved)\n    * Fixed an issue with non `.html` extensions not setting application type properly when fallback template not found.\n1. [](#bugfix)\n    * Fix plugins and themes json calls after the introduction of [HTML fallback for templates not found](https://github.com/getgrav/grav/commit/364209a27da0f5dfba5fde9c4b07b6d5844cda47)\n\n\n# v1.2.6\n## 12/21/2016\n\n1. [](#improved)\n    * Added a delay before reloading the page when a plugin or theme get installed\n    * Fix prompting to remove Grav itself when removing a package that requires a specific Grav version\n    * Remove cli-server exception since we now have compatibility with a custom router in Grav [#1219](https://github.com/getgrav/grav/pull/1219)\n1. [](#bugfix)\n    * Fix issue with array field and `value_only: true`\n\n# v1.2.5\n## 12/13/2016\n\n1. [](#new)\n    * RC released as stable\n1. [](#bugfix)\n    * YAML syntax fixes\n\n# v1.2.5-rc.4\n## 12/07/2016\n\n1. [](#new)\n    * Added a new `permissions` form field, used in the user profile to simplify editing permissions\n    * Added several new `onAdminAfter...()` events to allow for more 3rd party plugin interaction\n1. [](#bugfix)\n    * Updated admin-user-details to allow longer user names in the sidebar [#879](https://github.com/getgrav/grav-plugin-admin/issues/879)\n    * Redirect to a 404 page when accessing nonexistent plugins and themes [#880](https://github.com/getgrav/grav-plugin-admin/issues/880)\n\n# v1.2.5-rc.3\n## 11/26/2016\n\n1. [](#bugfix)\n    * Update class namespace for Admin class [#874](https://github.com/getgrav/grav-plugin-admin/issues/874)\n    * Fix updating/installing packages from admin\n\n# v1.2.5-rc.2\n## 11/19/2016\n\n1. [](#bugfix)\n    * Make default value work for filepicker [#859](https://github.com/getgrav/grav-plugin-admin/issues/859)\n\n# v1.2.5-rc.1\n## 11/09/2016\n\n1. [](#new)\n    * Updated to FontAwesome 4.7.0 with [Grav icon](http://fontawesome.io/icon/grav/)\n1. [](#improved)\n    * Always delete image alternatives in AdminController#taskDelmedia [#814](https://github.com/getgrav/grav-plugin-admin/issues/814)\n    * Use Media class to retrieve files in AdminController#taskGetFilesInFolder [#842](https://github.com/getgrav/grav-plugin-admin/issues/842)\n    * Increased specificity for Colorpicker field to prevent 3rd party conflicts\n1. [](#bugfix)\n    * Editor link button doesn't prefix links with `http://` anymore [#813](https://github.com/getgrav/grav-plugin-admin/issues/813)\n    * Dashboard Charts now always refresh no matter what [#753](https://github.com/getgrav/grav-plugin-admin/issues/753)\n    * Use rawRoute for parent too when saving [#843](https://github.com/getgrav/grav-plugin-admin/issues/843)\n    * Avoid different output when users exist or not in password recovery [#849](https://github.com/getgrav/grav/issues/849)\n    * Fix login to admin with permission inherited from group [#857](https://github.com/getgrav/grav-plugin-admin/issues/857)\n\n\n# v1.2.4\n## 10/22/2016\n\n1. [](#bugfix)\n    * Fix for accented media files [#833](https://github.com/getgrav/grav-plugin-admin/issues/833)\n    * Fix for `CTRL + s` not saving in editor [#832](https://github.com/getgrav/grav-plugin-admin/pull/832)\n    * Fix for missing REDIS translations in admin [#1123](https://github.com/getgrav/grav/issues/1123)\n\n# v1.2.3\n## 10/19/2016\n\n1. [](#new)\n    * Added new `onAdminCreatePageFrontmatter()` event to support plugins such as `auto-date` by allowing frontmatter to be modified by plugins.\n    * Added a new independent `cache_enabled` option for admin plugin (default is `false`). Should fix various sync issues.\n    * Add an `onAdminData` event to allow plugins to add additional blueprints data\n1. [](#improved)\n    * Handle errors when a resource fails to install\n    * Page media and File field images thumbnail are now properly proportionate and 150x100\n    * Added the Codeception testing suite with an initial test\n1. [](#bugfix)\n    * Fix [#1034](https://github.com/getgrav/grav/issues/1034) redirect of page creation procedure when system.home.hide_in_urls is enabled\n    * Media (Page): Do not extend parent metehod for sending files since Safari and IE API for FormData don\u2019t implement `delete` ([#772](https://github.com/getgrav/grav-plugin-admin/issues/772))\n    * Clean up POST keys containing square brackets, allows for regex ranges in routes ([#776](https://github.com/getgrav/grav-plugin-admin/issues/776))\n    * Fix [#773](https://github.com/getgrav/grav-plugin-admin/issues/773) allow filepicker work inside lists, respond to mutation event\n    * Better error handling for Feed when unable to connect\n    * Fixed UI for Pagemedia note when files cannot yet be uploaded ([#798](https://github.com/getgrav/grav-plugin-admin/issues/798))\n    * Fixed Submit buttons getting disabled in case of form invalidity disallowing to submit again ([#802](https://github.com/getgrav/grav-plugin-admin/issues/802))\n    * Fixed issue when reading the file size setting if set to `0` (in Pagemedia and File fields)\n    * Fixed issue with `file` field in collections that caused unexpected duplication of items ([#775](https://github.com/getgrav/grav-plugin-admin/issues/775))\n    * Dramatically improved `filepicker` performance. Data is only ever loaded when the drop-down is on focus, as it was supposed to be. Image preview of a selected item won't be rendered unless the field gains focus to avoid wasting resources. ([#788](https://github.com/getgrav/grav-plugin-admin/issues/788))\n    * Allow `filepicker` field to peak at the pending uploaded files and optimistically select them ([#792](https://github.com/getgrav/grav-plugin-admin/issues/792))\n    * Fix [#821](https://github.com/getgrav/grav-plugin-admin/issues/821) issue in saving a page to a new language when the filename does not contain the filename yet.\n\n# v1.2.2\n## 09/08/2016\n\n1. [](#bugfix)\n    * Fix [#767](https://github.com/getgrav/grav-plugin-admin/issues/767) Add styling for new HTML5 input field types\n    * Fix issue with checking the package dependencies when more than one package is being inspected\n\n# v1.2.1\n## 09/07/2016\n\n1. [](#bugfix)\n    * Fixed `tmp://` stream issue with Admin updated to 1.2 before Grav updated 1.1.4\n\n# v1.2.0\n## 09/07/2016\n\n1. [](#new)\n    * All new `file` field. All files get uploaded via Ajax and are stored upon Save. This improves the Save task tremendously as now there is no longer the need of waiting for the files to finish uploading. Fully backward compatible, `file` field now includes also a `limit` and `filesize` option in the blueprints. The former determines how many files are allowed to be uploaded when in combination with `multiple: true` (default: 10), the latter determines the file size limit (in MB) allowed for each file (default: 5MB)\n    * Added a new `filepicker` field, which allows to pick any file from an ajax-powered select box. The `pagemediaselect` field now internally uses the `filepicker` field to live-reload the available files, and to show image previews.\n1. [](#improved)\n    * Better error handling for 500 Internal Server Errors, when Fetch fails\n    * Various notifications style and other CSS fixes\n    * More language strings added\n    * Added `clear-tmp` to cache clear drop-down\n    * Unified JSON twig templates\n    * Better error handling for 500 Internal Server Errors, when Fetch fails.\n    * Updated vendor Libraries\n1. [](#bugfix)\n    * Curl fix for invalid cert errors with News Feed\n    * Avoid requiring `admin.super` for ajax calls [#739](https://github.com/getgrav/grav-plugin-admin/issues/739)\n    * Fix showing HTML in notifications, in the feed\n    * Fixed broken page type filtering\n    * Fixed `beforeunload` event not prompting to offer the choice to stay on the page in case of unsaved changes\n    * Fixed click-away detection for preventing loss of changes, that would get ignored in some circumstances (ie, from modal confirmation)\n    * Fixed issue with `_json` elements where nested fields merging would get stored in an unexpected way\n    * Fixed composer dependencies missing error message\n\n# v1.1.4\n## 08/14/2016\n\n1. [](#bugfix)\n    * Fixed Firefox News Feed dashboard widget layout\n\n# v1.1.3\n## 08/10/2016\n\n1. [](#new)\n    * Admin notifications system.  Admin will pull and cache notifications.  This will be used to announce important updates, security vulnerabilities, and general interest news.\n    * Ability to disable widgets in the dashboard\n    * Added news feed widget to the dashboard\n1. [](#improved)\n    * Updated FontAwesome to v4.6.3\n    * Use new List functionality for Media Configuration\n    * Get fresh media list for `Controller::getListMedia()` rather that cache so always latest.\n    * Add translation strings for the new system.force_ssl option\n    * Reworked List UI to better handle drag & drop sort. To sort it is now required to use the left drag handle [#724](https://github.com/getgrav/grav-plugin-admin/issues/724)\n    * Lists now features a new YAML option `controls: [top|bottom|both]` (default: bottom) which will display the \"Add Item\" button at the Top and/or Bottom position relative to the list. When the Top button is pressed, a new item will be added at the beginning of the list, when the Bottom button is pressed, a new item will be appended to the list.\n    * Lists now features two new YAML options `sortby: [field]` (default: disabled) and `sortby_dir: [asc|desc]` (default: asc) which will display a new Sorting button in the list allowing to automatically reindex the collection based on the given sort field set.\n    * Lists now features a new YAML option `collapsed: [true|false]` (default: false) and a new UI/UX that allows for collapsing / expanding collection items, allowing to better managing long lists of items. It is advised to always put as first field the most significant one, so that when a list is collapsed it can be still easily browsed.\n    * It is now possible to sort Array fields via drag & drop [#950](https://github.com/getgrav/grav/issues/950)\n1. [](#bugfix)\n    * Fixed issue in Admin favicon URL [#704](https://github.com/getgrav/grav-plugin-admin/issues/704)\n    * Fixed issue in `selfupgrade` where the package would get downloaded in the wrong destination\n    * Hide tab when user is not authorized to access it [#712](https://github.com/getgrav/grav-plugin-admin/issues/712)\n    * Fixed Lists issue when reindexing, causing Radio fields to potentially lose their `checked` status\n    * Avoid overwriting a file when uploaded with the same filename through the Admin blueprint `file` field type if `avoid_overwriting` is enabled on the field\n    * Fixed issue with Array field in `value_only` mode, improperly displaying the key when no value was set\n    * Translate the description of a blueprint field [#729](https://github.com/getgrav/grav-plugin-admin/issues/729)\n\n# v1.1.2\n## 07/16/2016\n\n1. [](#improved)\n    * Forcing limit of upload files based on System settings\n1. [](#bugfix)\n    * Definitive fix for multi form submission in Microsoft Edge causing the Save to not work [#694](https://github.com/getgrav/grav-plugin-admin/issues/694)\n    * Fix issue with calculating the `theme_url` with `open_basedir` restrictions [#699](https://github.com/getgrav/grav-plugin-admin/issues/699)\n    * Check for null payload before going on [#526](https://github.com/getgrav/grav-plugin-admin/issues/526)\n    * Redraw Dashboard Charts when collapsing/expanding the sidebar\n    * Fix for `cache/compiled` errors resulting from page media uploads [getgrav/grav#938](https://github.com/getgrav/grav/issues/938)\n\n# v1.1.1\n## 07/14/2016\n\n1. [](#bugfix)\n    * Fixed issue with forms causing creation of new pages not to work [#698](https://github.com/getgrav/grav-plugin-admin/issues/698) and [getgrav/grav#934](https://github.com/getgrav/grav/issues/934)\n\n# v1.1.0\n## 07/14/2016\n\n1. [](#improved)\n    * Added the ability to login with the email in addition to the username. [#674](https://github.com/getgrav/grav-plugin-admin/issues/674)\n    * It is now possible to sort the Plugins and Themes views by 'Name', 'Author', 'GravTeam', 'Release Date', 'Updates Available' and 'Testing' releases (if in Testing Channel), both Ascending and Descending. [#583](https://github.com/getgrav/grav-plugin-admin/issues/583)\n    * Prevent external links (like the Preview button) to trigger the \"Changes Detected\" notice [#689](https://github.com/getgrav/grav-plugin-admin/issues/689)\n    * Added a filter field in Plugins and Themes list views, to allow for quick search of a particular resource\n    * Added new `Enabled` sorting option for Plugins list view\n1. [](#bugfix)\n    * Fixed an issue that prevented removing more than one page, in the pages listng [#672](https://github.com/getgrav/grav-plugin-admin/issues/672)\n    * Fixed toggleables in lists that were always loading as checked even when not stored [#688](https://github.com/getgrav/grav-plugin-admin/issues/688)\n    * Fixed Fullscreen tooltip in Editor displaying off screen (when in fullscreen mode) [#677](https://github.com/getgrav/grav-plugin-admin/issues/677)\n    * Fixed inconsistency in the way selectized fields would be rendered [#692](https://github.com/getgrav/grav-plugin-admin/issues/692)\n    * Fixed issue with Save in Microsoft Edge [#694](https://github.com/getgrav/grav-plugin-admin/issues/694)\n\n# v1.1.0-rc.4\n## 06/21/2016\n\n1. [](#bugfix)\n    * Fix for 'front-end' shortcut showing in mobile sidebar incorrectly.\n    * Append progressive number to the copied page title. [#394](https://github.com/getgrav/grav-plugin-admin/issues/394)\n    * Add field description to forms [#667](https://github.com/getgrav/grav-plugin-admin/pull/667)\n    * Fix clearing all cache [#658](https://github.com/getgrav/grav-plugin-admin/issues/658)\n    * Assign the correct ordering when saving a page that didn't have ordering set before [#628](https://github.com/getgrav/grav-plugin-admin/issues/628)\n    * Fix issue when saving a modular child folder as 05.somethin and being reset to 01.something upon save [#628](https://github.com/getgrav/grav-plugin-admin/issues/628)\n\n# v1.1.0-rc.3\n## 06/14/2016\n\n1. [](#bugfix)\n    * Fix for Gemini Scrollbar CSS breaking layout in IE 9+ [#644](https://github.com/getgrav/grav-plugin-admin/issues/644)\n    * Fall back to english for UI language if admin's language is not set [#641](https://github.com/getgrav/grav-plugin-admin/issues/641)\n    * List field has the wrong label/field width.  Switched to \"1/3 | 2/3\" like all other fields.\n    * Correctly set the page slug on page copy. Avoids having two pages with the same slug [#394](https://github.com/getgrav/grav-plugin-admin/issues/394)\n    * When copying a page, if there's a page prefix (used for ordering), update the value to avoid having two pages with the same order number [#429](https://github.com/getgrav/grav-plugin-admin/issues/429)\n    * Fixed size of dropdown text in responsive views to be readable [#647](https://github.com/getgrav/grav-plugin-admin/issues/647)\n    * Fixed issue with checkbox in toggleables getting submitted with the form even when disabled (fixes #646)\n\n# v1.1.0-rc.2\n## 06/02/2016\n\n1. [](#improved)\n    * Cleaned up the Page Preview CSS to make it more 'standard' [#634](https://github.com/getgrav/grav-plugin-admin/issues/634)\n    * Added a legend with the Page colors explained [#637](https://github.com/getgrav/grav-plugin-admin/issues/637)\n    * Hide email output when sending forgot password instructions [#571](https://github.com/getgrav/grav-plugin-admin/issues/571)\n1. [](#bugfix)\n    * Fixed \"Data type `System` doesn't exist!\" error when activating a theme [#635](https://github.com/getgrav/grav-plugin-admin/issues/635)\n    * Fixed issue with custom media types not deleting on save [#633](https://github.com/getgrav/grav-plugin-admin/issues/633)\n    * Fixed issue when saving `List` field type in plugins + pages\n    * Fixed JS error on login/logout page due to jQuery not being loaded\n\n\n# v1.1.0-rc.1\n## 06/01/2016\n\n1. [](#new)\n    * Major improvements with the **File Upload** (`file`) field type.  Now fully supports themes, plugins, configuration + pages\n1. [](#improved)\n    * Updated with latest languages via [Crowdin](https://crowdin.com/project/grav-admin/)\n    * Provide security options for single tabs [#615](https://github.com/getgrav/grav-plugin-admin/issues/615)\n    * Disable double clicking on Save/Delete/Copy page actions [#611](https://github.com/getgrav/grav-plugin-admin/issues/611)\n    * Tweaked the avatar alignment in sidebar [#592](https://github.com/getgrav/grav-plugin-admin/issues/592)\n    * Added page name to delete dialog [#511](https://github.com/getgrav/grav-plugin-admin/issues/511)\n    * Enabling / Disabling a Plugin doesn't trigger the expand / collapse details anymore [#614](https://github.com/getgrav/grav-plugin-admin/issues/614)\n    * Added hover on plugins list rows to match pages [#619](https://github.com/getgrav/grav-plugin-admin/issues/619)\n    * Translate media configuration [#608](https://github.com/getgrav/grav-plugin-admin/issues/608)\n    * Use raw routes in blueprints to better support multi-language [#798](https://github.com/getgrav/grav-plugin-admin/issues/798)\n    * Updated NPM modules dependencies\n1. [](#bugfix)\n    * Fix double \"Removed successfully\" appearing when removing a package [#609](https://github.com/getgrav/grav-plugin-admin/issues/609)\n    * Prevent removing required plugins dependencies when removing a package [#613](https://github.com/getgrav/grav-plugin-admin/issues/613)\n    * Show page title in Delete Confirmation modal if this information is available\n    * Don't try to uninstall admin/form/login/email plugins\n    * Only check for updates if not `admin.maintenance` or `admin.super` [#557](https://github.com/getgrav/grav-plugin-admin/issues/557)\n    * Always submit checkboxes that are not checked and force a 0 value [#616](https://github.com/getgrav/grav-plugin-admin/issues/616)\n    * Fix encoding in tooltips again [#622](https://github.com/getgrav/grav-plugin-admin/issues/622)\n    * Do not show `move` cursor for Collections that aren't sortable [#624](https://github.com/getgrav/grav-plugin-admin/issues/624)\n    * Properly handle Collections that specify a custom key, rather than falling back to indexed list [#632](https://github.com/getgrav/grav-plugin-admin/issues/632)\n\n# v1.1.0-beta.5\n## 05/23/2016\n\n1. [](#improved)\n    * Set sidebar navigation defaults back to \"Tab Activation\" and \"Auto Width\"\n    * Custom logo text is displayed as first letter in small sidebar view [#829](https://github.com/getgrav/grav/issues/829)\n    * Copied admin-only blueprints from Grav core to the Admin plugin\n    * Allow `field.label` to have HTML in it [#601](https://github.com/getgrav/grav-plugin-admin/issues/601)\n1. [](#bugfix)\n    * Fixed Togggle field with doubled `checked=\"checked\"` when `toggleable: true` [#579](https://github.com/getgrav/grav-plugin-admin/issues/579)\n    * Strip HTML tags and lowercase username from login/reset forms [#577](https://github.com/getgrav/grav-plugin-admin/issues/577)\n    * Fixed issue with version numbers not showing up for dependencies [#581](https://github.com/getgrav/grav-plugin-admin/issues/581)\n    * Fixed editor tooltips in fullscreen mode and tablet devices rendering [#566](https://github.com/getgrav/grav-plugin-admin/issues/566)\n    * Fixed issue with `file` form field not functioning [#838](https://github.com/getgrav/grav/issues/838)\n    * Fixed issue with creating pages [#595](https://github.com/getgrav/grav-plugin-admin/issues/595)\n\n# v1.1.0-beta.4\n## 05/09/2016\n\n1. [](#new)\n    * Implemented Quickopen functionality to automatically open / close the Sidebar when mouseover\n1. [](#improved)\n    * Better error handling when `obj->validate()` fails with exception [#594](https://github.com/getgrav/grav-plugin-admin/issues/564)\n    * Improve markup of update and add package dependencies in update modal [#560](https://github.com/getgrav/grav-plugin-admin/issues/560)\n1. [](#bugfix)\n    * Fix for admin translation filter (`|tu`) not substituting text - [#567](https://github.com/getgrav/grav-plugin-admin/issues/567)\n    * Translated \"Publishing\" tab text [#561](https://github.com/getgrav/grav-plugin-admin/issues/561)\n    * Fix invalid argument supplied in foreach [#563](https://github.com/getgrav/grav-plugin-admin/issues/563)\n    * CSS fixes for editor button alignment\n    * Fix for forgot password not finding anyone\n    * Fix UI issue with update button on a package page in Firefox\n    * Fix issue with update button when automatic check for updates is disabled\n    * Fix issue caused by clicking \"Check for updates\" multiple times\n    * Added missing translations\n    * Fix for Themes with an array of keywords [#823](https://github.com/getgrav/grav/issues/823)\n\n# v1.1.0-beta.3\n## 05/04/2016\n\n1. [](#new)\n    * Added a `|adminNicetime` Twig filter to show 'nicetime' in admin user's language\n    * Added a `prepend` and `append` field option for text input type\n    * Added a WIP `onAdminRegisterPermissions` event\n    * Added several new languages: Arabic, Danish, Greek, Farsi, Korean, Romanian, Thai. Huge thanks to the [translation teams](https://crowdin.com/project/grav-admin)\n1. [](#improved)\n    * Fixed UI issue with Backup / Update buttons positioning\n    * Tweaked placeholders color in login/new user panels [#542](https://github.com/getgrav/grav-plugin-admin/issues/542)\n1. [](#bugfix)\n    * Fixed several untranslated strings\n    * Fix the version information after updating Grav from Admin\n    * Fix a Twig autoescape issue on Plugins descriptions\n    * Fix for showing empty drop-down with only one supported language [#522](https://github.com/getgrav/grav-plugin-admin/issues/522)\n    * Fix for visibility toggle on new page not working [#551](https://github.com/getgrav/grav-plugin-admin/issues/551)\n    * Page tooltips usability issue [#496](https://github.com/getgrav/grav-plugin-admin/issues/496)\n    * Fix removed title attribute from editor toolbar buttons [#539](https://github.com/getgrav/grav-plugin-admin/issues/539)\n    * Allow Incognito / Private browsing to still function in Safari [#527](https://github.com/getgrav/grav-plugin-admin/issues/527)\n\n# v1.1.0-beta.2\n## 04/27/2016\n\n1. [](#new)\n    * Added `grav ~1.1` to dependencies\n    * Added a persistent message if you try to run Admin 1.1 on Grav 1.0\n1. [](#improved)\n    * Used locator instead of `CACHE_DIR`\n    * Added a better way to get Admin version\n    * Show account page for users with certain ACL [#524](https://github.com/getgrav/grav-plugin-admin/pull/524)\n1. [](#bugfix)\n    * Fixed Editor Preview using wrong parameters for the ajax call\n    * Fixed toggle for stable/testing channel\n    * Fixed blueprint JSON fields\n    * If not logged in redirect to base path [#445](https://github.com/getgrav/grav-plugin-admin/pull/445)\n    * Various autoescape fixes\n    * ColorPicker CSS fixes\n    * Fix for translation of admin login [#500](https://github.com/getgrav/grav-plugin-admin/issues/500)\n    * Fix list not applying `toggleable: true` and `style: vertical` [#518](https://github.com/getgrav/grav-plugin-admin/pull/518)\n    * Fixed issue with update for wrong plugin displaying on plugin details pages\n    * Fixed error with the **close sidebar** toggle in some browsers (Firefox, iOS Safari)\n\n# v1.1.0-beta.1\n## 04/20/2016\n\n1. [](#new)\n    * JavaScript Rewrite. Admin is now built in ES6\n    * Lists can now be nested and 'fancy fields' (such as editor, datetime picker, selectize, other lists) get automatically initialized so they are always available no matter if you add or remove items from the lists\n    * The Editor has been reworked to be more flexible. In fact you can now pass any CodeMirror setting via blueprints, through the codemirror: attribute. The buttons have also a new API that allow to add or ignore buttons and behaviors into the toolbar from any plugin (see grav-plugin-editor-buttons). We also added the headers buttons (H1-H6) and Undo / Redo buttons, due to popular demand\n    * We introduced a new colorpicker field. You can now add more colors to your admin plugins :)\n    * Along with the versioning support added in the Grav Core for 1.1, the admin plugin can now install dependencies with the same versioning requirements as the GPM CLI commands.\n    * New System configuration field for toggling GPM release version (testing/stable)\n    * Several new system configuration options for new functionality such as `Process frontmatter Twig`\n    * Ability to collapse the sidebar to a smaller icon view if you need more room.\n1. [](#improved)\n    * The default Grav theme has been tweaked and in many places completely rewritten to ensure that it's as flexible as possible. The primary reason for this was to ensure theming and customization compatibility for the upcoming Admin Pro plugin, but a key benefit includes greatly improved mobile compatibility.\n    * We reworked the Datetimepicker, you will notice a new refreshed UI with a much better support for translations\n    * Tabs are now persistent. In views such as Page editing, when switching tab and saving or refreshing, would cause the tab to be reset to the initial one.\n    * When editing a page in Expert mode, the frontmatter editor is now more friendly. You will now get line numbers, undo/redo and YAML linter.\n    * Behind the scenes we have reworked how the form and toggleables work. This added a lot more reliability and consistency across the whole admin.\n    * The Pages view has more persistent states. It will now remember your expanded/collapsed states as well as filtering.\n    * Lists can now accept a custom button label with the 'btnLabel' property\n    * After login to Admin, redirect to the original URL called\n    * Admin now has an unique cache key compared to the 'site' so pages can be cached independently\n    * Improved the layout of the User Profile page.\n    * Set cache key uniquely for admin so cache does not colide with site\n1. [](#bugfix)\n    * Fix for modular preview - [#254](https://github.com/getgrav/grav-plugin-admin/issues/254)\n    * Fix for long content and page tabs - [#441](https://github.com/getgrav/grav-plugin-admin/issues/441)\n    * Fix for clear cache after adding new folder - [#393](https://github.com/getgrav/grav-plugin-admin/issues/393)\n\n# v1.0.9\n## 02/11/2016\n\n1. [](#bugfix)\n    * Fix language translation files\n\n# v1.0.8\n## 02/05/2016\n\n1. [](#new)\n    * Added a logout button when not authorized to access a page in Admin\n    * Added the option to hide a tab from an extended blueprint (https://github.com/getgrav/grav/issues/620)\n    * Many new languages and updates to existing languages from the Translation team.\n1. [](#improved)\n    * Check frontmatter for validity prior to saving\n    * Add noindex, nofollow across the entire admin theme if no other robots headers are set on a page\n    * Allow to hide a configuration blueprint section / tab and still save its values\n    * Allow to show user defined blueprints in configuration\n    * Updated FontAwesome to latest 4.5.0 version\n1. [](#bugfix)\n    * Fixed an issue with user registration on Linux caused by `glob()` possibly returning false.\n    * Fixed an issue preventing Admin to work correctly in a multisite configuration\n    * Fixed preview and insertion of images with non-lowercase extension\n    * Fixed an incorrect number of pages being displayed in the sidebar in some cases\n    * [Security] Don't reveal Grav filesystem path when trying to delete non-existing images\n    * [Security] Fix PHP error happening when uploading file without extension if the JS dropzone uploader is configured to allow empty file extensions\n    * [Security] Ensure correct escaping in various Twig files\n\n# v1.0.7\n## 01/15/2016\n\n1. [](#new)\n    * Added onAdminDashboard event\n    * Added onAdminSave event\n    * New lang strings for reverse proxy toggle\n1. [](#improved)\n    * More robust YAML file checking in config folders\n    * Removed deprecated menu event\n    * Removed old logs code\n    * Used new onAdminDashboard event for current dashboard widgets\n1. [](#bugfix)\n    * Fix for missing access checks on config pages #397\n    * Fix parent not loaded on admin form save #587\n    * When no route field is added to a page blueprint, add it as page root\n    * Fix for wrong page count (will show dynamic added pages in count too - Need to fix this)\n    * Fix for IE/Edge saving forms #391\n\n# v1.0.6\n## 01/07/2016\n\n1. [](#bugfix)\n    * Fix for forms appending `_json` fields on every save\n\n# v1.0.5\n## 01/07/2016\n\n1. [](#new)\n    * Added a pointer to Grav's contributing guide\n    * Handle the optional logic to strip home from Page routes and urls\n    * The Configuration page now shows any blueprint found in the user/blueprints/config/ folder, thus allowing to add custom configurations\n1. [](#improved)\n    * Allow the nonce for a POST action to be set in the query url\n    * Add a fallback twig template to use in case Twig cannot find a template file\n    * Modified update Theme and Plugin buttons to use more reliably markup\n1. [](#bugfix)\n    * Fix additional `on` parameter when saving plugins configs that contain tabs in their blueprint\n    * Fixes for the `pagemediaselect` form field\n    * Fix an untranslated message in the logout form when `system.languages.translations` is disabled\n    * Fixed a hardcoded `http://` reference throwing warnings under HTTPS\n    * Ensure download package has `.zip` extension, just in case\n\n# v1.0.4\n## 12/22/2015\n\n1. [](#improved)\n    * Improved File input field for admin\n    * Restore file inputs functionality and process form via JS if no inputs found\n1. [](#bugfix)\n    * Fix for the image preview in the file field on multi-lang sites\n    * Fix problem in form code introduced by fix to allow file uploads\n    * Fix redirect in deleting page media\n\n# v1.0.3\n## 12/20/2015\n\n1. [](#new)\n    * Added `pagemediaselect` field for use in pages\n1. [](#improved)\n    * Updated various languages\n    * Check for method `meetsRequirements()` prior to using\n    * Enable `file` form field to be used in plugins and theme blueprints\n\n# v1.0.2\n## 12/18/2015\n\n1. [](#bugfix)\n    * Fixed issue with user edit page causing error due to individual language files\n\n# v1.0.1\n## 12/18/2015\n\n1. [](#new)\n    * Moved languages into individual files under `languages/` folder\n    * Added a check for PHP version\n    * Dutch translation added\n1. [](#improved)\n    * Let forms work with file inputs\n    * Various file input improvements\n    * Language updates\n    * Better checks for existence of Popularity JSON data\n    * Add file processing to admin forms\n    * More Admin Pro integration fixes\n1. [](#bugfix)\n    * Set form to multipart if it contains a file field\n    * `cleanFilesData()` now returns just the filename\n\n# v1.0.0\n## 12/11/2015\n\n1. [](#new)\n    * New built-in admin registration process\n    * Added security check to `section` form field\n    * Added new RocketTheme font with various icons\n    * Add `onAdminThemeInitialized()` event to admin `Themes::init()`\n    * Force timestamp on CSS/JS assets based on `GRAV_VERSION`\n    * Additions for Gantry5 support\n1. [](#improved)\n    * Force lowercase `username` when logging in\n    * Hide markdown preview except for pages\n    * Added a notice if you don't have permission to see dashboard\n    * Updated admin login page logic\n    * Return \"Invalid Security Token\" instead of \"Unauthorized\"\n    * Throw exception if you used with built-in PHP web server\n    * Updated languages\n    * Removed `noreply@getgrav.org` default email address\n    * Use new methods to disable CSS/JS pipeline if available\n    * Various code cleanups\n1. [](#bugfix)\n    * Handle case when email `from` is not configured\n    * Fix tabs support in plugin/themes settings\n    * Fix param separator in page media Ajax call\n    * Fix favicon base URL\n\n# v1.0.0-rc.7\n## 12/01/2015\n\n1. [](#new)\n    * Display error page if page does not exist in admin\n    * Removed Beta message option and added toggle for GitHub message\n    * Added functionality to support Admin Pro plugin (in development)\n1. [](#improved)\n    * Added support for Markdown editor in lists #239\n    * Better Markdown Editor API with dynamic initialization\n    * Various language updates\n    * Removed some unused variables\n    * Added admin check for pages existence\n    * Prevent the admin to cause an error when an Ajax action is in progress\n    * Force translations to be active even when disabled in site #299\n    * Do not reinitialize `Selectize` if already available\n1. [](#bugfix)\n    * Fixed full-screen markdown Editor\n    * Fix modular preview not working reliably #254\n    * **Nonce fixes** (hopefully the last of them!)\n    * Fix broken plugin enable/disable\n    * Fix issue where `_redirect: /plugins` was getting stored in the plugin configuration\n    * Replace default them service with admin one\n    * Fix saving array fields #304\n    * Fix missing translations when default language is not english\n    * Fix title variables not translated #310\n\n# v1.0.0-rc.6\n## 11/21/2015\n\n1. [](#improved)\n    * Implemented logic to detect when offline and suppress Ajax calls\n    * Added nonce logic to be used by JS\n1. [](#bugfix)\n    * Nonce fix for updating themes\n    * Nonce fix for deleting pages\n\n# v1.0.0-rc.5\n## 11/20/2015\n\n1. [](#new)\n    * Use **Nonce** mechanism for form security\n    * Added Hungarian translation\n    * Add support for Markdown labels #271\n    * Added support for Markdown Editor in all the things\n    * Implemented save keyboard shortcut (Ctrl + S / CMD + S)\n1. [](#improved)\n    * Better error for \"Internal Server Error\" when accessing GPM\n    * Updated French translation\n    * Updated Russian translation\n    * Load Gravatar image with protocol-less `//:` syntax\n    * Improved header UI in mobile browsers #265\n    * Dropped unused version of JQuery\n    * More visible Preview link icon\n    * Hide **Latest pages** if there are none\n    * Improved toggle to better support different length strings\n1. [](#bugfix)\n    * Force rescanning fields when submitting a form #243\n    * Set default lang for pages on fresh session\n    * Escaped values in `array.html.twig`\n    * Fix saving in IE Edge\n    * Fixed various typos\n    * Fixed JS button issues #370\n    * Fixed JS error in private browsing #272\n    * Fixed date field border\n    * Fixed multiple instance of Markdown Editor #285\n    * Fixed Spacer CSS #267\n\n# v1.0.0-rc.4\n## 10/29/2015\n\n1. [](#improved)\n    * Changed admin menu event hook to `onAdminMenu()`\n    * Minor improvements for admin page location\n    * Additional lang strings for Grav 1.0.0-rc.3\n\n# v1.0.0-rc.3\n## 10/27/2015\n\n1. [](#improved)\n    * Rely on context-language for active language\n    * Improved some Russian translations\n    * Only show login if not already logged in\n1. [](#bugfix)\n    * Disable asset pipeline in admin only\n    * Fix Editor cursor insertion point when text is selected in some actions\n\n# v1.0.0-rc.2\n## 10/23/2015\n\n1. [](#bugfix)\n    * Reverted lang redirect code. Needs to be reworked to be more reliable\n\n# v1.0.0-rc.1\n## 10/23/2015\n\n1. [](#new)\n    * Redirect to non-language URL except for `pages/`\n1. [](#improved)\n    * New language strings for new `system.yaml` fields\n    * Improved Russian translations\n    * Improved compatibility with PECL Yaml parser\n1. [](#bugfix)\n    * Redirect to correct page if you change folder/slug\n    * Fix issue with Asset pipeline not being disabled in admin\n    * Fix for HTML in text input fields\n    * Fixed various icons in headers\n\n# v0.6.2\n## 10/15/2015\n\n1. [](#improved)\n    * Use `title` rather than `menu` in Page listing\n    * Wrapped language strings in double-quotes\n    * New language strings for new fields\n1. [](#bugfix)\n    * Fixed issue with IE not able to save pages\n\n# v0.6.1\n## 10/07/2015\n\n1. [](#new)\n    * Added the ability to render front-end templates in markdown preview\n    * Option to disable Google-based fonts. Useful for Cyrillic languages.\n    * Couple of new static helper methods used by new page blueprints\n    * New `fieldset` form field (thanks @Sommerregen!)\n1. [](#improved)\n    * Hide editor buttons in preview mode\n    * Improved support for admin when offline\n    * Use relative URL in Login form\n    * Added some more missing lang strings\n    * Improved German translation\n    * Compressed CSS files for improved performance\n    * Only get last 7 days in week count calculation\n1. [](#bugfix)\n    * Fix saving pages in local-specific languages\n    * Only track 'human' page hits in statistics\n    * Responsive fixes for 'wordy' languages\n    * Fixed delete issue with array field type\n    * Fixed some hardcoded `admin` references to allow admin path change\n    * Fix for issue with lang code being added twice\n    * Fix language name in admin buttons\n\n# v0.6.0\n## 09/16/2015\n\n1. [](#new)\n    * Support for custom markdown editor buttons!\n    * Added Russian translations\n    * Added Japanese translations\n    * Ajax session keep-alive when editing forms\n1. [](#improved)\n    * Added missing Italian translations\n    * Added additional options field into the pages form field\n1. [](#bugfix)\n    * Fix GPM errors in offline mode\n    * Fix for duplicate status messages\n\n# v0.5.0\n## 09/11/2015\n\n1. [](#new)\n    * Responsive layout for mobile compatibility (thanks @Vivalldi!)\n    * Added page type and many other new filters to Page list view\n    * Added granular ACL requirements to admin pages\n    * Ability to define page date format\n    * Added `onAdminTemplateNavPluginHook` to allow for plugins to hook into sidebar\n    * Added YAML Twig filters (to and from)\n    * Support for nested metadata\n    * Added ability to disable automatic update checks via admin plugin configuration\n    * Initial Spanish translation\n1. [](#improved)\n    * Check for existence of a user account\n    * Various language additions\n    * Refactored form fields to remove duplicates from form plugin\n    * Improved date picker\n    * Improved display field\n    * Add page template type to page list view\n    * Various UI fixes\n    * Added some default field 'focus' to save clicking\n    * Only allow \"Add Modular\" if the theme has modular templates\n    * Updated `chartist.js` library\n    * Updated 'fontawesome' fonts to the latest v4.4\n1. [](#bugfix)\n    * Fix for \"drag-n-drop\" of non-image media\n    * Fix a fatal error in GPM when offline\n    * Fix a z-index bug with tooltips\n    * Fix a z-index bug in lang dropdowns\n    * Don't allow deleting of last empty array field\n    * Fix for images with parenthesis in filenames\n    * Fix for page title visualization when not set\n    * Fix for cursor position in folder/array fields\n\n# v0.4.3\n## 08/31/2015\n\n1. [](#new)\n    * Added Japanese translation\n    * Support for independent file name and template override\n1. [](#improved)\n    * Improved slug generation using `slugify.js`\n    * Allow the `title` twig variables to set the page title\n    * Improved Page media handling with several bugfixes\n    * Prevent error when there are no pages on a site\n    * If all updates are applied, show \"Fully Updated\" text in dashboard\n    * Better preview link (requires `rtrim` filter from Grav 0.9.40)\n    * Order all plugins and themes alphabetically\n    * Removed duplicate language entries\n1. [](#bugfix)\n    * Fix for redirect after saving when multilang not enabled\n    * Fix for deleting responsive media\n    * Fix for HTML encoding in markdown field\n\n# v0.4.2\n## 08/25/2015\n\n1. [](#bugfix)\n    * Fix for current admin lang not showing up in page lang dropdown\n    * Fix for incorrect NAME/CONTENT lang keys\n    * Fix for incorrect site link\n\n# v0.4.1\n## 08/24/2015\n\n1. [](#bugfix)\n    * Fix for broken **Add Page** - Doh!\n    * Fix for empty site link when at root\n\n# v0.4.0\n## 08/24/2015\n\n1. [](#new)\n    * Multi-language Page support!!!\n    * Admin languages configurable per user\n    * Toastr messages for `check updates`\n    * new `tu` filter for admin translations\n    * Italian and German admin translations\n    * Added a save location in system and site configuration\n    * Page metadata now uses flexible array field\n1. [](#improved)\n    * Allow subpages of modular pages to display in pages list\n    * Open external pages in new tabs\n    * Reworked `visibility` of pages\n    * Use `PLUGIN_ADMIN` prefix for translations\n    * Added link to gravatar.com to avoid confusion on avatar\n    * Limit page count to 200 in ordering field\n    * Fixed various Safari _flex_ issues\n    * Use `rawRoute()` for page links\n    * Minor `param separator` fixes\n    * Various CSS fixes\n    * Improved CodeMirror to force spaces\n    * Added **Selectize** dropdowns to various forms and modals\n1. [](#bugfix)\n    * Fix for `Call to a member function path() on non-object` error\n    * Fixed dropdown z-index issues\n    * Correctly set the filename including language if set\n    * Fix for empty taxonomies on page save\n    * Fix for page not redirecting properly on folder change\n    * Fix for table headers styling\n    * Added missing translation strings\n    * Unique page counting in total page counts\n    * Fixed JS warning with page filtering and deleting\n\n\n# v0.3.0\n## 08/11/2015\n\n1. [](#new)\n    * Show current date in form date format fields\n    * Added a new **check for updates** button to flush GPM\n    * Added session timeout configuration for admin\n    * Added `isSymlink` logic for Grav\n    * Added new `phpinfo` page\n1. [](#improved)\n    * Improved toggleables\n    * Support `param_separator` for Apache on windows\n    * Logout now goes to interstitial to provide session messages\n    * Updated hints and improved formatting\n    * Encoding URI for images in editor preview\n    * Create user `system.yaml` and `site.yaml` if they are missing\n    * Open external links in new tab by default\n    * Set edit mode to `normal` by default\n    * Disable CSS/JS pipelining in the admin\n1. [](#bugfix)\n    * Fixed form submission not working in IE\n    * Fix fatal error when deleting homepage\n    * Prevent admin plugin activating when the URL of a page contains partial route\n\n# v0.2.0\n## 08/06/2015\n\n1. [](#new)\n    * Added multiple **clear cache** types\n    * Added back to themes link when adding new themes\n    * Properly handles visibility and ordering and guesses best option on new\n    * Added new templates field with support for custom (unsupported) template type\n    * Added new display field for displaying simple text value\n    * **Update Grav** button now works\n    * Added spanish translation\n    * Added german translation\n1. [](#improved)\n    * Improved page order handling logic\n    * Implemented 2-step theme switching logic with warning\n    * Force `modular` page class for modular template\n    * Clear page cache on page delete (ghost pages still showing)\n    * Clears route on page save so changes such as `slug` are picked up\n    * Fix dashboard layout in Safari\n    * Added tooltips for official 'Team Grav' themes/plugins\n1. [](#bugfix)\n    * Handle modular page templates on create\n    * Fixed Firefox JS error for arrays\n    * Ensure we don't change page type to empty and save (causing page to be deleted)\n    * Fixed some minor CSS issues with editor\n    * Fixed link to RocketTheme.com\n    * Disabled fields now stay properly disabled\n\n# v0.1.1\n## 08/04/2015\n\n1. [](#bugfix)\n    * Fixed GitHub URLs\n    * Hiding toggle for disabling Admin plugin\n    * Removed extra text not needed\n\n# v0.1.0\n## 08/04/2015\n\n1. [](#new)\n    * ChangeLog started...\n", "<?php\n\nnamespace Grav\\Plugin\\Admin;\n\nuse Grav\\Common\\Cache;\nuse Grav\\Common\\Config\\Config;\nuse Grav\\Common\\Data\\Data;\nuse Grav\\Common\\Debugger;\nuse Grav\\Common\\Filesystem\\Folder;\nuse Grav\\Common\\Grav;\nuse Grav\\Common\\Media\\Interfaces\\MediaInterface;\nuse Grav\\Common\\Page\\Interfaces\\PageInterface;\nuse Grav\\Common\\Page\\Media;\nuse Grav\\Common\\Security;\nuse Grav\\Common\\Uri;\nuse Grav\\Common\\User\\Interfaces\\UserInterface;\nuse Grav\\Common\\Utils;\nuse Grav\\Common\\Plugin;\nuse Grav\\Common\\Theme;\nuse Grav\\Framework\\Controller\\Traits\\ControllerResponseTrait;\nuse Grav\\Framework\\RequestHandler\\Exception\\RequestException;\nuse JsonException;\nuse Psr\\Http\\Message\\ResponseInterface;\nuse Psr\\Http\\Message\\ServerRequestInterface;\nuse RocketTheme\\Toolbox\\Event\\Event;\nuse RocketTheme\\Toolbox\\File\\File;\nuse RocketTheme\\Toolbox\\ResourceLocator\\UniformResourceLocator;\n\n/**\n * Class AdminController\n *\n * @package Grav\\Plugin\n */\nclass AdminBaseController\n{\n    use ControllerResponseTrait;\n\n    /** @var Grav */\n    public $grav;\n    /** @var string */\n    public $view;\n    /** @var string */\n    public $task;\n    /** @var string */\n    public $route;\n    /** @var array */\n    public $post;\n    /** @var array|null */\n    public $data;\n    /** @var array */\n    public $blacklist_views = [];\n\n    /** @var Uri */\n    protected $uri;\n    /** @var Admin */\n    protected $admin;\n    /** @var string */\n    protected $redirect;\n    /** @var int */\n    protected $redirectCode;\n\n    /** @var string[] */\n    protected $upload_errors = [\n        0 => 'There is no error, the file uploaded with success',\n        1 => 'The uploaded file exceeds the max upload size',\n        2 => 'The uploaded file exceeds the MAX_FILE_SIZE directive that was specified in the HTML',\n        3 => 'The uploaded file was only partially uploaded',\n        4 => 'No file was uploaded',\n        6 => 'Missing a temporary folder',\n        7 => 'Failed to write file to disk',\n        8 => 'A PHP extension stopped the file upload'\n    ];\n\n    /**\n     * Performs a task.\n     *\n     * @return bool True if the action was performed successfully.\n     */\n    public function execute()\n    {\n        if (null === $this->admin) {\n            $this->admin = $this->grav['admin'];\n        }\n\n        // Ignore blacklisted views.\n        if (in_array($this->view, $this->blacklist_views, true)) {\n            return false;\n        }\n\n        // Make sure that user is logged into admin.\n        if (!$this->admin->authorize()) {\n            return false;\n        }\n\n        // Always validate nonce.\n        if (!$this->validateNonce()) {\n            return false;\n        }\n\n        $method = 'task' . ucfirst($this->task);\n\n        if (method_exists($this, $method)) {\n            try {\n                $response = $this->{$method}();\n            } catch (RequestException $e) {\n                /** @var Debugger $debugger */\n                $debugger = $this->grav['debugger'];\n                $debugger->addException($e);\n\n                $response = $this->createErrorResponse($e);\n            } catch (\\RuntimeException $e) {\n                /** @var Debugger $debugger */\n                $debugger = $this->grav['debugger'];\n                $debugger->addException($e);\n\n                $response = true;\n                $this->admin->setMessage($e->getMessage(), 'error');\n            }\n        } else {\n            $response = $this->grav->fireEvent('onAdminTaskExecute',\n                new Event(['controller' => $this, 'method' => $method]));\n        }\n\n        if ($response instanceof ResponseInterface) {\n            $this->close($response);\n        }\n\n        // Grab redirect parameter.\n        $redirect = $this->post['_redirect'] ?? null;\n        unset($this->post['_redirect']);\n\n        // Redirect if requested.\n        if ($redirect) {\n            $this->setRedirect($redirect);\n        }\n\n        return $response;\n    }\n\n    protected function validateNonce()\n    {\n        if (strtolower($_SERVER['REQUEST_METHOD']) === 'post') {\n            if (isset($this->post['admin-nonce'])) {\n                $nonce = $this->post['admin-nonce'];\n            } else {\n                $nonce = $this->grav['uri']->param('admin-nonce');\n            }\n\n            if (!$nonce || !Utils::verifyNonce($nonce, 'admin-form')) {\n                if ($this->task === 'addmedia') {\n\n                    $message = sprintf($this->admin::translate('PLUGIN_ADMIN.FILE_TOO_LARGE', null),\n                        ini_get('post_max_size'));\n\n                    //In this case it's more likely that the image is too big than POST can handle. Show message\n                    $this->admin->json_response = [\n                        'status'  => 'error',\n                        'message' => $message\n                    ];\n\n                    return false;\n                }\n\n                $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.INVALID_SECURITY_TOKEN'), 'error');\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.INVALID_SECURITY_TOKEN')\n                ];\n\n                return false;\n            }\n            unset($this->post['admin-nonce']);\n        } else {\n            if ($this->task === 'logout') {\n                $nonce = $this->grav['uri']->param('logout-nonce');\n                if (null === $nonce || !Utils::verifyNonce($nonce, 'logout-form')) {\n                    $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.INVALID_SECURITY_TOKEN'),\n                        'error');\n                    $this->admin->json_response = [\n                        'status'  => 'error',\n                        'message' => $this->admin::translate('PLUGIN_ADMIN.INVALID_SECURITY_TOKEN')\n                    ];\n\n                    return false;\n                }\n            } else {\n                $nonce = $this->grav['uri']->param('admin-nonce');\n                if (null === $nonce || !Utils::verifyNonce($nonce, 'admin-form')) {\n                    $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.INVALID_SECURITY_TOKEN'),\n                        'error');\n                    $this->admin->json_response = [\n                        'status'  => 'error',\n                        'message' => $this->admin::translate('PLUGIN_ADMIN.INVALID_SECURITY_TOKEN')\n                    ];\n\n                    return false;\n                }\n            }\n        }\n\n        return true;\n    }\n\n    /**\n     * Sets the page redirect.\n     *\n     * @param string $path The path to redirect to\n     * @param int    $code The HTTP redirect code\n     * @return void\n     */\n    public function setRedirect($path, $code = 303)\n    {\n        $this->redirect     = $path;\n        $this->redirectCode = $code;\n    }\n\n    /**\n     * Sends JSON response and terminates the call.\n     *\n     * @param array $json\n     * @param int $code\n     * @return never-return\n     */\n    protected function sendJsonResponse(array $json, $code = 200): void\n    {\n        // JSON response.\n        $response = $this->createJsonResponse($json, $code);\n\n        $this->close($response);\n    }\n\n    /**\n     * @param ResponseInterface $response\n     * @return never-return\n     */\n    protected function close(ResponseInterface $response): void\n    {\n        $this->grav->close($response);\n    }\n\n    /**\n     * Handles ajax upload for files.\n     * Stores in a flash object the temporary file and deals with potential file errors.\n     *\n     * @return bool True if the action was performed.\n     */\n    public function taskFilesUpload()\n    {\n        if (null === $_FILES || !$this->authorizeTask('upload file', $this->dataPermissions())) {\n            return false;\n        }\n\n        /** @var Config $config */\n        $config   = $this->grav['config'];\n        $data     = $this->view === 'pages' ? $this->admin->page(true) : $this->prepareData([]);\n        $settings = $data->blueprints()->schema()->getProperty($this->post['name']);\n        $settings = (object)array_merge([\n            'avoid_overwriting' => false,\n            'random_name'       => false,\n            'accept'            => ['image/*'],\n            'limit'             => 10,\n            'filesize'          => Utils::getUploadLimit()\n        ], (array)$settings, ['name' => $this->post['name']]);\n\n        $upload = $this->normalizeFiles($_FILES['data'], $settings->name);\n\n        $filename = $upload->file->name;\n\n        // Handle bad filenames.\n        if (!Utils::checkFilename($filename)) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => sprintf($this->admin::translate('PLUGIN_ADMIN.FILEUPLOAD_UNABLE_TO_UPLOAD', null),\n                    $filename, 'Bad filename')\n            ];\n\n            return false;\n        }\n\n        if (!isset($settings->destination)) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.DESTINATION_NOT_SPECIFIED', null)\n            ];\n\n            return false;\n        }\n\n        // Do not use self@ outside of pages\n        if ($this->view !== 'pages' && in_array($settings->destination, ['@self', 'self@', '@self@'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => sprintf($this->admin::translate('PLUGIN_ADMIN.FILEUPLOAD_PREVENT_SELF', null),\n                    $settings->destination)\n            ];\n\n            return false;\n        }\n\n        // Handle errors and breaks without proceeding further\n        if ($upload->file->error !== UPLOAD_ERR_OK) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => sprintf($this->admin::translate('PLUGIN_ADMIN.FILEUPLOAD_UNABLE_TO_UPLOAD', null),\n                    $filename, $this->upload_errors[$upload->file->error])\n            ];\n\n            return false;\n        }\n\n        // Handle file size limits\n        $settings->filesize *= 1048576; // 2^20 [MB in Bytes]\n        if ($settings->filesize > 0 && $upload->file->size > $settings->filesize) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.EXCEEDED_GRAV_FILESIZE_LIMIT')\n            ];\n\n            return false;\n        }\n\n        // Handle Accepted file types\n        // Accept can only be mime types (image/png | image/*) or file extensions (.pdf|.jpg)\n        $accepted = false;\n        $errors   = [];\n\n        // Do not trust mimetype sent by the browser\n        $mime = Utils::getMimeByFilename($filename);\n\n        foreach ((array)$settings->accept as $type) {\n            // Force acceptance of any file when star notation\n            if ($type === '*') {\n                $accepted = true;\n                break;\n            }\n\n            $isMime = strstr($type, '/');\n            $find   = str_replace(['.', '*', '+'], ['\\.', '.*', '\\+'], $type);\n\n            if ($isMime) {\n                $match = preg_match('#' . $find . '$#', $mime);\n                if (!$match) {\n                    $errors[] = 'The MIME type \"' . $mime . '\" for the file \"' . $filename . '\" is not an accepted.';\n                } else {\n                    $accepted = true;\n                    break;\n                }\n            } else {\n                $match = preg_match('#' . $find . '$#', $filename);\n                if (!$match) {\n                    $errors[] = 'The File Extension for the file \"' . $filename . '\" is not an accepted.';\n                } else {\n                    $accepted = true;\n                    break;\n                }\n            }\n        }\n\n        if (!$accepted) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => implode('<br />', $errors)\n            ];\n\n            return false;\n        }\n\n        // Remove the error object to avoid storing it\n        unset($upload->file->error);\n\n        // we need to move the file at this stage or else\n        // it won't be available upon save later on\n        // since php removes it from the upload location\n        $tmp_dir  = Admin::getTempDir();\n        $tmp_file = $upload->file->tmp_name;\n        $tmp      = $tmp_dir . '/uploaded-files/' . basename($tmp_file);\n\n        Folder::create(dirname($tmp));\n        if (!move_uploaded_file($tmp_file, $tmp)) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => sprintf($this->admin::translate('PLUGIN_ADMIN.FILEUPLOAD_UNABLE_TO_MOVE', null), '',\n                    $tmp)\n            ];\n\n            return false;\n        }\n\n        // Special Sanitization for SVG\n        if (Utils::contains($mime, 'svg', false)) {\n            Security::sanitizeSVG($tmp);\n        }\n\n        $upload->file->tmp_name = $tmp;\n\n        // Retrieve the current session of the uploaded files for the field\n        // and initialize it if it doesn't exist\n        $sessionField = base64_encode($this->grav['uri']->url());\n        $flash        = $this->admin->session()->getFlashObject('files-upload') ?? [];\n        if (!isset($flash[$sessionField])) {\n            $flash[$sessionField] = [];\n        }\n        if (!isset($flash[$sessionField][$upload->field])) {\n            $flash[$sessionField][$upload->field] = [];\n        }\n\n        // Set destination\n        if ($this->grav['locator']->isStream($settings->destination)) {\n            $destination = $this->grav['locator']->findResource($settings->destination, false, true);\n        } else {\n            $destination = Folder::getRelativePath(rtrim($settings->destination, '/'));\n            $destination = $this->admin->getPagePathFromToken($destination);\n        }\n\n        // Create destination if needed\n        if (!is_dir($destination)) {\n            Folder::mkdir($destination);\n        }\n\n        // Generate random name if required\n        if ($settings->random_name) { // TODO: document\n            $extension          = pathinfo($upload->file->name, PATHINFO_EXTENSION);\n            $upload->file->name = Utils::generateRandomString(15) . '.' . $extension;\n        }\n\n        // Handle conflicting name if needed\n        if ($settings->avoid_overwriting) { // TODO: document\n            if (file_exists($destination . '/' . $upload->file->name)) {\n                $upload->file->name = date('YmdHis') . '-' . $upload->file->name;\n            }\n        }\n\n        // Prepare object for later save\n        $path               = $destination . '/' . $upload->file->name;\n        $upload->file->path = $path;\n        // $upload->file->route = $page ? $path : null;\n\n        // Prepare data to be saved later\n        $flash[$sessionField][$upload->field][$path] = (array)$upload->file;\n\n        // Finally store the new uploaded file in the field session\n        $this->admin->session()->setFlashObject('files-upload', $flash);\n        $this->admin->json_response = [\n            'status'  => 'success',\n            'session' => \\json_encode([\n                'sessionField' => base64_encode($this->grav['uri']->url()),\n                'path'         => $upload->file->path,\n                'field'        => $settings->name\n            ])\n        ];\n\n        return true;\n    }\n\n    /**\n     * Checks if the user is allowed to perform the given task with its associated permissions\n     *\n     * @param string $task        The task to execute\n     * @param array  $permissions The permissions given\n     *\n     * @return bool True if authorized. False if not.\n     */\n    public function authorizeTask($task = '', $permissions = [])\n    {\n        if (!$this->admin->authorize($permissions)) {\n            if ($this->grav['uri']->extension() === 'json') {\n                $this->admin->json_response = [\n                    'status'  => 'unauthorized',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK') . ' ' . $task . '.'\n                ];\n            } else {\n                $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK') . ' ' . $task . '.',\n                    'error');\n            }\n\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * Checks if the user is allowed to perform the given task with its associated permissions.\n     * Throws exception if the check fails.\n     *\n     * @param string $task        The task to execute\n     * @param array  $permissions The permissions given\n     * @throws RequestException\n     */\n    public function checkTaskAuthorization($task = '', $permissions = [])\n    {\n        if (!$this->admin->authorize($permissions)) {\n            throw new RequestException($this->getRequest(), $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK') . ' ' . $task . '.', 403);\n        }\n    }\n\n    /**\n     * Gets the permissions needed to access a given view\n     *\n     * @return array An array of permissions\n     */\n    protected function dataPermissions()\n    {\n        $type        = $this->view;\n        $permissions = ['admin.super'];\n\n        switch ($type) {\n            case 'config':\n                $type = $this->route ?: 'system';\n                $permissions[] = 'admin.configuration.' . $type;\n                break;\n            case 'plugins':\n                $permissions[] = 'admin.plugins';\n                break;\n            case 'themes':\n                $permissions[] = 'admin.themes';\n                break;\n            case 'users':\n                $permissions[] = 'admin.users';\n                break;\n            case 'user':\n                $permissions[] = 'admin.login';\n                $permissions[] = 'admin.users';\n                break;\n            case 'pages':\n                $permissions[] = 'admin.pages';\n                break;\n            default:\n                $permissions[] = 'admin.configuration.' . $type;\n                $permissions[] = 'admin.configuration_' . $type;\n        }\n\n        return $permissions;\n    }\n\n    /**\n     * Gets the configuration data for a given view & post\n     *\n     * @param array $data\n     *\n     * @return array\n     */\n    protected function prepareData(array $data)\n    {\n        return $data;\n    }\n\n    /**\n     * Internal method to normalize the $_FILES array\n     *\n     * @param array  $data $_FILES starting point data\n     * @param string $key\n     *\n     * @return object a new Object with a normalized list of files\n     */\n    protected function normalizeFiles($data, $key = '')\n    {\n        $files        = new \\stdClass();\n        $files->field = $key;\n        $files->file  = new \\stdClass();\n\n        foreach ($data as $fieldName => $fieldValue) {\n            // Since Files Upload are always happening via Ajax\n            // we are not interested in handling `multiple=\"true\"`\n            // because they are always handled one at a time.\n            // For this reason we normalize the value to string,\n            // in case it is arriving as an array.\n            $value                     = (array)Utils::getDotNotation($fieldValue, $key);\n            $files->file->{$fieldName} = array_shift($value);\n        }\n\n        return $files;\n    }\n\n    /**\n     * Removes a file from the flash object session, before it gets saved\n     *\n     * @return bool True if the action was performed.\n     */\n    public function taskFilesSessionRemove()\n    {\n        if (!$this->authorizeTask('delete file', $this->dataPermissions())) {\n            return false;\n        }\n\n        // Retrieve the current session of the uploaded files for the field\n        // and initialize it if it doesn't exist\n        $sessionField = base64_encode($this->grav['uri']->url());\n        $request      = \\json_decode($this->post['session']);\n\n        // Ensure the URI requested matches the current one, otherwise fail\n        if ($request->sessionField !== $sessionField) {\n            return false;\n        }\n\n        // Retrieve the flash object and remove the requested file from it\n        $flash    = $this->admin->session()->getFlashObject('files-upload') ?? [];\n        $endpoint = $flash[$request->sessionField][$request->field][$request->path] ?? null;\n\n        if (isset($endpoint)) {\n            if (file_exists($endpoint['tmp_name'])) {\n                unlink($endpoint['tmp_name']);\n            }\n\n            unset($endpoint);\n        }\n\n        // Walk backward to cleanup any empty field that's left\n        // Field\n        if (isset($flash[$request->sessionField][$request->field][$request->path])) {\n            unset($flash[$request->sessionField][$request->field][$request->path]);\n        }\n\n        // Field\n        if (isset($flash[$request->sessionField][$request->field]) && empty($flash[$request->sessionField][$request->field])) {\n            unset($flash[$request->sessionField][$request->field]);\n        }\n\n        // Session Field\n        if (isset($flash[$request->sessionField]) && empty($flash[$request->sessionField])) {\n            unset($flash[$request->sessionField]);\n        }\n\n\n        // If there's anything left to restore in the flash object, do so\n        if (count($flash)) {\n            $this->admin->session()->setFlashObject('files-upload', $flash);\n        }\n\n        $this->admin->json_response = ['status' => 'success'];\n\n        return true;\n    }\n\n    /**\n     * Redirect to the route stored in $this->redirect\n     *\n     * Route may or may not be prefixed by /en or /admin or /en/admin.\n     *\n     * @return void\n     */\n    public function redirect()\n    {\n        $this->admin->redirect($this->redirect, $this->redirectCode);\n    }\n\n    /**\n     * Prepare and return POST data.\n     *\n     * @param array $post\n     * @return array\n     */\n    protected function getPost($post)\n    {\n        if (!is_array($post)) {\n            return [];\n        }\n\n        unset($post['task']);\n\n        // Decode JSON encoded fields and merge them to data.\n        if (isset($post['_json'])) {\n            $post = array_replace_recursive($post, $this->jsonDecode($post['_json']));\n            unset($post['_json']);\n        }\n\n        return $this->cleanDataKeys($post);\n    }\n\n    /**\n     * Recursively JSON decode data.\n     *\n     * @param array $data\n     * @return array\n     * @throws JsonException\n     * @internal Do not use directly!\n     */\n    protected function jsonDecode(array $data): array\n    {\n        foreach ($data as &$value) {\n            if (is_array($value)) {\n                $value = $this->jsonDecode($value);\n            } else {\n                $value = json_decode($value, true, 512, JSON_THROW_ON_ERROR);\n            }\n        }\n\n        return $data;\n    }\n\n    /**\n     * @param array $source\n     * @return array\n     * @internal Do not use directly!\n     */\n    protected function cleanDataKeys(array $source): array\n    {\n        $out = [];\n        foreach ($source as $key => $value) {\n            $key = str_replace(['%5B', '%5D'], ['[', ']'], $key);\n            if (is_array($value)) {\n                $out[$key] = $this->cleanDataKeys($value);\n            } else {\n                $out[$key] = $value;\n            }\n        }\n\n        return $out;\n    }\n\n    /**\n     * Return true if multilang is active\n     *\n     * @return bool True if multilang is active\n     */\n    protected function isMultilang()\n    {\n        return count($this->grav['config']->get('system.languages.supported', [])) > 1;\n    }\n\n    /**\n     * @param PageInterface|UserInterface|Data $obj\n     *\n     * @return PageInterface|UserInterface|Data\n     */\n    protected function storeFiles($obj)\n    {\n        // Process previously uploaded files for the current URI\n        // and finally store them. Everything else will get discarded\n        $queue = $this->admin->session()->getFlashObject('files-upload');\n        if (is_array($queue)) {\n            $queue = $queue[base64_encode($this->grav['uri']->url())];\n            foreach ($queue as $key => $files) {\n                foreach ($files as $destination => $file) {\n                    if (!rename($file['tmp_name'], $destination)) {\n                        throw new \\RuntimeException(sprintf($this->admin->translate('PLUGIN_ADMIN.FILEUPLOAD_UNABLE_TO_MOVE',\n                            null), '\"' . $file['tmp_name'] . '\"', $destination));\n                    }\n\n                    unset($files[$destination]['tmp_name']);\n                }\n\n                if ($this->view === 'pages') {\n                    $keys     = explode('.', preg_replace('/^header./', '', $key));\n                    $init_key = array_shift($keys);\n                    if (count($keys) > 0) {\n                        $new_data = $obj->header()->{$init_key} ?? [];\n                        Utils::setDotNotation($new_data, implode('.', $keys), $files, true);\n                    } else {\n                        $new_data = $files;\n                    }\n                    if (isset($obj->header()->{$init_key})) {\n                        $obj->modifyHeader($init_key,\n                            array_replace_recursive([], $obj->header()->{$init_key}, $new_data));\n                    } else {\n                        $obj->modifyHeader($init_key, $new_data);\n                    }\n                } elseif ($obj instanceof UserInterface and $key === 'avatar') {\n                    $obj->set($key, $files);\n                } else {\n                    // TODO: [this is JS handled] if it's single file, remove existing and use set, if it's multiple, use join\n                    $obj->join($key, $files); // stores\n                }\n\n            }\n        }\n\n        return $obj;\n    }\n\n    /**\n     * Used by the filepicker field to get a list of files in a folder.\n     *\n     * @return bool\n     */\n    protected function taskGetFilesInFolder()\n    {\n        if (!$this->authorizeTask('get files', $this->dataPermissions())) {\n            return false;\n        }\n\n        $data = $this->view === 'pages' ? $this->admin->page(true) : $this->prepareData([]);\n\n        if (null === $data) {\n            return false;\n        }\n\n        if (method_exists($data, 'blueprints')) {\n            $settings = $data->blueprints()->schema()->getProperty($this->post['name']);\n        } elseif (method_exists($data, 'getBlueprint')) {\n            $settings = $data->getBlueprint()->schema()->getProperty($this->post['name']);\n        }\n\n        if (isset($settings['folder'])) {\n            $folder = $settings['folder'];\n        } else {\n            $folder = 'self@';\n        }\n\n        // Do not use self@ outside of pages\n        if ($this->view !== 'pages' && in_array($folder, ['@self', 'self@', '@self@'])) {\n            if (!$data instanceof MediaInterface) {\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => sprintf($this->admin::translate('PLUGIN_ADMIN.FILEUPLOAD_PREVENT_SELF', null), $folder)\n                ];\n\n                return false;\n            }\n\n            $media = $data->getMedia();\n        } else {\n            /** @var UniformResourceLocator $locator */\n            $locator = $this->grav['locator'];\n            if ($locator->isStream($folder)) {\n                $folder = $locator->findResource($folder);\n            }\n\n            // Set destination\n            $folder = Folder::getRelativePath(rtrim($folder, '/'));\n            $folder = $this->admin->getPagePathFromToken($folder);\n\n            $media = new Media($folder);\n        }\n\n        $available_files = [];\n        $metadata = [];\n        $thumbs = [];\n\n\n        foreach ($media->all() as $name => $medium) {\n\n           $available_files[] = $name;\n\n            if (isset($settings['include_metadata'])) {\n                $img_metadata = $medium->metadata();\n                if ($img_metadata) {\n                    $metadata[$name] = $img_metadata;\n                }\n            }\n\n        }\n\n        // Peak in the flashObject for optimistic filepicker updates\n        $pending_files = [];\n        $sessionField  = base64_encode($this->grav['uri']->url());\n        $flash         = $this->admin->session()->getFlashObject('files-upload');\n\n        if ($flash && isset($flash[$sessionField])) {\n            foreach ($flash[$sessionField] as $field => $data) {\n                foreach ($data as $file) {\n                    if (dirname($file['path']) === $folder) {\n                        $pending_files[] = $file['name'];\n                    }\n                }\n            }\n        }\n\n        $this->admin->session()->setFlashObject('files-upload', $flash);\n\n        // Handle Accepted file types\n        // Accept can only be file extensions (.pdf|.jpg)\n        if (isset($settings['accept'])) {\n            $available_files = array_filter($available_files, function ($file) use ($settings) {\n                return $this->filterAcceptedFiles($file, $settings);\n            });\n\n            $pending_files = array_filter($pending_files, function ($file) use ($settings) {\n                return $this->filterAcceptedFiles($file, $settings);\n            });\n        }\n\n        // Generate thumbs if needed\n        if (isset($settings['preview_images']) && $settings['preview_images'] === true) {\n            foreach ($available_files as $filename) {\n                $thumbs[$filename] = $media[$filename]->zoomCrop(100,100)->url();\n            }\n        }\n\n        $this->admin->json_response = [\n            'status'  => 'success',\n            'files'   => array_values($available_files),\n            'pending' => array_values($pending_files),\n            'folder'  => $folder,\n            'metadata' => $metadata,\n            'thumbs' => $thumbs\n        ];\n\n        return true;\n    }\n\n    /**\n     * @param string $file\n     * @param array $settings\n     * @return false\n     */\n    protected function filterAcceptedFiles($file, $settings)\n    {\n        $valid = false;\n\n        foreach ((array)$settings['accept'] as $type) {\n            $find = str_replace('*', '.*', $type);\n            $valid |= preg_match('#' . $find . '$#i', $file);\n        }\n\n        return $valid;\n    }\n\n    /**\n     * Handle deleting a file from a blueprint\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskRemoveFileFromBlueprint()\n    {\n        if (!$this->authorizeTask('remove file', $this->dataPermissions())) {\n            return false;\n        }\n\n        /** @var Uri $uri */\n        $uri       = $this->grav['uri'];\n        $blueprint = base64_decode($uri->param('blueprint'));\n        $path      = base64_decode($uri->param('path'));\n        $route     = base64_decode($uri->param('proute'));\n        $type      = $uri->param('type');\n        $field     = $uri->param('field');\n\n        $filename  = basename($this->post['filename'] ?? '');\n        if ($filename === '') {\n           $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => 'Filename is empty'\n            ];\n\n            return false;\n        }\n\n        // Get Blueprint\n        if ($type === 'pages' || strpos($blueprint, 'pages/') === 0) {\n            $page = $this->admin->page(true, $route);\n            if (!$page) {\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => 'Page not found'\n                ];\n\n                return false;\n            }\n            $blueprints = $page->blueprints();\n            $path = Folder::getRelativePath($page->path());\n            $settings = (object)$blueprints->schema()->getProperty($field);\n        } else {\n            $page = null;\n            if ($type === 'themes' || $type === 'plugins') {\n                $obj = $this->grav[$type]->get(Utils::substrToString($blueprint, '/')); //here\n                $settings = (object) $obj->blueprints()->schema()->getProperty($field);\n            } else {\n                $settings = (object)$this->admin->blueprints($blueprint)->schema()->getProperty($field);\n            }\n        }\n\n        // Get destination\n        if ($this->grav['locator']->isStream($settings->destination)) {\n            $destination = $this->grav['locator']->findResource($settings->destination, false, true);\n\n        } else {\n            $destination = Folder::getRelativePath(rtrim($settings->destination, '/'));\n            $destination = $this->admin->getPagePathFromToken($destination, $page);\n        }\n\n        // Not in path\n        if (!Utils::startsWith($path, $destination)) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => 'Path not valid for this data type'\n            ];\n\n            return false;\n        }\n\n        // Only remove files from correct destination...\n        $this->taskRemoveMedia($destination . '/' . $filename);\n\n        if ($page) {\n            $keys = explode('.', preg_replace('/^header./', '', $field));\n            $header = (array)$page->header();\n            $data_path = implode('.', $keys);\n            $data = Utils::getDotNotation($header, $data_path);\n\n            if (isset($data[$path])) {\n                unset($data[$path]);\n                Utils::setDotNotation($header, $data_path, $data);\n                $page->header($header);\n            }\n\n            $page->save();\n        } elseif ($type === 'user') {\n            $user = Grav::instance()['user'];\n            unset($user->avatar);\n            $user->save();\n        } else {\n\n            $blueprint_prefix = $type === 'config' ? '' : $type . '.';\n            $blueprint_name   = str_replace(['config/', '/blueprints'], '', $blueprint);\n            $blueprint_field  = $blueprint_prefix . $blueprint_name . '.' . $field;\n\n            $files            = $this->grav['config']->get($blueprint_field);\n\n            if ($files) {\n                foreach ($files as $key => $value) {\n                    if ($key == $path) {\n                        unset($files[$key]);\n                    }\n                }\n            }\n\n            $this->grav['config']->set($blueprint_field, $files);\n\n            switch ($type) {\n                case 'config':\n                    $data   = $this->grav['config']->get($blueprint_name);\n                    $config = $this->admin->data($blueprint, $data);\n                    $config->save();\n                    break;\n                case 'themes':\n                    Theme::saveConfig($blueprint_name);\n                    break;\n                case 'plugins':\n                    Plugin::saveConfig($blueprint_name);\n                    break;\n            }\n        }\n\n        Cache::clearCache('invalidate');\n\n        $this->admin->json_response = [\n            'status'  => 'success',\n            'message' => $this->admin::translate('PLUGIN_ADMIN.REMOVE_SUCCESSFUL')\n        ];\n\n        return true;\n    }\n\n    /**\n     * Handles removing a media file\n     *\n     * @note This task cannot be used anymore.\n     *\n     * @return bool True if the action was performed\n     */\n    public function taskRemoveMedia($filename = null)\n    {\n        if (!$this->canEditMedia()) {\n            return false;\n        }\n\n        if (null === $filename) {\n            throw new \\RuntimeException('Admin task RemoveMedia has been disabled.');\n        }\n\n        $file                  = File::instance($filename);\n        $resultRemoveMedia     = false;\n\n        if ($file->exists()) {\n            $resultRemoveMedia = $file->delete();\n\n            $fileParts = pathinfo($filename);\n\n            foreach (scandir($fileParts['dirname']) as $file) {\n                $regex_pattern = '/' . preg_quote($fileParts['filename'], '/') . \"@\\d+x\\.\" . $fileParts['extension'] . \"(?:\\.meta\\.yaml)?$|\" . preg_quote($fileParts['basename'], '/') . \"\\.meta\\.yaml$/\";\n                if (preg_match($regex_pattern, $file)) {\n                    $path = $fileParts['dirname'] . '/' . $file;\n                    @unlink($path);\n                }\n            }\n\n        }\n\n        if ($resultRemoveMedia) {\n            if ($this->grav['uri']->extension() === 'json') {\n                $this->admin->json_response = [\n                    'status'  => 'success',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.REMOVE_SUCCESSFUL')\n                ];\n            } else {\n                $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.REMOVE_SUCCESSFUL'), 'info');\n                $this->clearMediaCache();\n                $this->setRedirect('/media-manager');\n            }\n\n            return true;\n        }\n\n        if ($this->grav['uri']->extension() === 'json') {\n            $this->admin->json_response = [\n                'status'  => 'success',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.REMOVE_FAILED')\n            ];\n        } else {\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.REMOVE_FAILED'), 'error');\n        }\n\n        return false;\n    }\n\n    /**\n     * Handles clearing the media cache\n     *\n     * @return bool True if the action was performed\n     */\n    protected function clearMediaCache()\n    {\n        $key   = 'media-manager-files';\n        $cache = $this->grav['cache'];\n        $cache->delete(md5($key));\n\n        return true;\n    }\n\n    /**\n     * Determine if the user can edit media\n     *\n     * @param string $type\n     *\n     * @return bool True if the media action is allowed\n     */\n    protected function canEditMedia($type = 'media')\n    {\n        if (!$this->authorizeTask('edit media', ['admin.' . $type, 'admin.super'])) {\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * @param string $message\n     * @param string $type\n     * @return $this\n     */\n    protected function setMessage($message, $type = 'info')\n    {\n        $this->admin->setMessage($message, $type);\n\n        return $this;\n    }\n\n    /**\n     * @return Config\n     */\n    protected function getConfig(): Config\n    {\n        return $this->grav['config'];\n    }\n\n    /**\n     * @return ServerRequestInterface\n     */\n    protected function getRequest(): ServerRequestInterface\n    {\n        return $this->grav['request'];\n    }\n}\n", "<?php\n\nnamespace Grav\\Plugin\\Admin;\n\nuse Grav\\Common\\Backup\\Backups;\nuse Grav\\Common\\Cache;\nuse Grav\\Common\\Config\\Config;\nuse Grav\\Common\\Debugger;\nuse Grav\\Common\\File\\CompiledYamlFile;\nuse Grav\\Common\\Filesystem\\Folder;\nuse Grav\\Common\\Flex\\Types\\Pages\\PageIndex;\nuse Grav\\Common\\GPM\\GPM as GravGPM;\nuse Grav\\Common\\GPM\\Installer;\nuse Grav\\Common\\Grav;\nuse Grav\\Common\\Data;\nuse Grav\\Common\\Helpers\\Excerpts;\nuse Grav\\Common\\Language\\Language;\nuse Grav\\Common\\Page\\Interfaces\\PageInterface;\nuse Grav\\Common\\Page\\Media;\nuse Grav\\Common\\Page\\Medium\\ImageMedium;\nuse Grav\\Common\\Page\\Medium\\Medium;\nuse Grav\\Common\\Page\\Page;\nuse Grav\\Common\\Page\\Pages;\nuse Grav\\Common\\Page\\Collection;\nuse Grav\\Common\\Security;\nuse Grav\\Common\\User\\Interfaces\\UserCollectionInterface;\nuse Grav\\Common\\User\\Interfaces\\UserInterface;\nuse Grav\\Common\\Utils;\nuse Grav\\Framework\\Flex\\Flex;\nuse Grav\\Framework\\Psr7\\Response;\nuse Grav\\Framework\\RequestHandler\\Exception\\RequestException;\nuse Grav\\Plugin\\Login\\TwoFactorAuth\\TwoFactorAuth;\nuse Grav\\Common\\Yaml;\nuse PicoFeed\\Parser\\MalformedXmlException;\nuse Psr\\Http\\Message\\ResponseInterface;\nuse RocketTheme\\Toolbox\\Event\\Event;\nuse RocketTheme\\Toolbox\\File\\File;\nuse RocketTheme\\Toolbox\\ResourceLocator\\UniformResourceLocator;\nuse Twig\\Loader\\FilesystemLoader;\n\n/**\n * Class AdminController\n *\n * @package Grav\\Plugin\n */\nclass AdminController extends AdminBaseController\n{\n    /**\n     * @param Grav|null $grav\n     * @param string|null $view\n     * @param string|null $task\n     * @param string|null $route\n     * @param array|null $post\n     * @return void\n     */\n    public function initialize(Grav $grav = null, $view = null, $task = null, $route = null, $post = null)\n    {\n        $this->grav = $grav;\n        $this->admin = $this->grav['admin'];\n        $this->view = $view;\n        $this->task = $task ?: 'display';\n        if (isset($post['data'])) {\n            $this->data = $this->getPost($post['data']);\n            unset($post['data']);\n        } else {\n            // Backwards compatibility for Form plugin <= 1.2\n            $this->data = $this->getPost($post);\n        }\n        $this->post  = $this->getPost($post);\n        $this->route = $route;\n\n        $this->grav->fireEvent('onAdminControllerInit', new Event(['controller' => &$this]));\n    }\n\n    // GENERAL TASKS\n\n    /**\n     * Keep alive\n     *\n     * Route: POST /task:keepAlive (AJAX call)\n     *\n     * @return void\n     */\n    protected function taskKeepAlive(): void\n    {\n        // This task is available for all admin users.\n        $response = new Response(200);\n\n        $this->close($response);\n    }\n\n    /**\n     * Clear the cache.\n     *\n     * Route: GET /cache.json/task:clearCache (AJAX call)\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskClearCache()\n    {\n        if (!$this->authorizeTask('clear cache', ['admin.cache', 'admin.maintenance', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        // get optional cleartype param\n        $clear_type = $this->grav['uri']->param('cleartype');\n\n        if ($clear_type) {\n            $clear = $clear_type;\n        } else {\n            $clear = 'standard';\n        }\n\n        if ($clear === 'purge') {\n            $msg = Cache::purgeJob();\n            $this->admin->json_response = [\n                'status'  => 'success',\n                'message' => $msg,\n            ];\n        } else {\n            $results = Cache::clearCache($clear);\n            if (count($results) > 0) {\n                $this->admin->json_response = [\n                    'status'  => 'success',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.CACHE_CLEARED') . ' <br />' . $this->admin::translate('PLUGIN_ADMIN.METHOD') . ': ' . $clear . ''\n                ];\n            } else {\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.ERROR_CLEARING_CACHE')\n                ];\n            }\n        }\n\n        return true;\n    }\n\n    /**\n     * Handles form and saves the input data if its valid.\n     *\n     * Route: POST /pages?task:save\n     * Route: POST /user?task:save\n     * Route: POST /*?task:save\n     *\n     * @return bool True if the action was performed.\n     */\n    public function taskSave()\n    {\n        if (!$this->authorizeTask('save', $this->dataPermissions())) {\n            return false;\n        }\n\n        $this->grav['twig']->twig_vars['current_form_data'] = (array)$this->data;\n\n        switch ($this->view) {\n            case 'pages':\n                // Not used if Flex-Objects plugin handles pages.\n                return $this->savePage();\n            case 'user':\n                // Not used if Flex-Objects plugin handles users.\n                return $this->saveUser();\n            default:\n                if ($this->saveDefault()) {\n                    $route = $this->grav['uri']::getCurrentRoute();\n                    $this->setRedirect($route->withGravParam('task', null)->toString(), 302);\n                    $this->redirect();\n                }\n\n                return false;\n        }\n    }\n\n    /**\n     * @return bool\n     */\n    protected function saveDefault()\n    {\n        try {\n            // Handle standard data types.\n            $type = $this->getDataType();\n\n            $obj = $this->admin->getConfigurationData($type, $this->data);\n            $obj->validate();\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->setMessage($e->getMessage(), 'error');\n\n            return false;\n        }\n\n        $obj->filter(false, true);\n\n        $obj = $this->storeFiles($obj);\n\n        if ($obj) {\n            // Event to manipulate data before saving the object\n            $this->grav->fireEvent('onAdminSave', new Event(['object' => &$obj]));\n            $obj->save();\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_SAVED'), 'info');\n            $this->grav->fireEvent('onAdminAfterSave', new Event(['object' => $obj]));\n        }\n\n        Cache::clearCache('invalidate');\n\n        // Force configuration reload.\n        /** @var Config $config */\n        $config = $this->grav['config'];\n        $config->reload();\n\n        if ($this->view === 'config') {\n            $this->setRedirect($this->admin->getAdminRoute(\"/{$this->view}/{$this->route}\")->toString());\n        }\n\n        return true;\n    }\n\n    // USER TASKS\n\n    /**\n     * Handle logout.\n     *\n     * Route: GET /task:logout\n     * Route: POST ?task=logout\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskLogout()\n    {\n        if (!$this->authorizeTask('logout', ['admin.login', 'admin.super'])) {\n            return false;\n        }\n\n        $this->admin->logout($this->data, $this->post);\n    }\n\n    /**\n     * Route: POST /ajax.json/task:regenerate2FASecret (AJAX call)\n     *\n     * @return bool\n     */\n    public function taskRegenerate2FASecret()\n    {\n        if (!$this->authorizeTask('regenerate 2FA Secret', ['admin.login', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        try {\n            /** @var UserInterface $user */\n            $user = $this->grav['user'];\n\n            /** @var TwoFactorAuth $twoFa */\n            $twoFa = $this->grav['login']->twoFactorAuth();\n            $secret = $twoFa->createSecret();\n            $image = $twoFa->getQrImageData($user->username, $secret);\n\n            $user->set('twofa_secret', $secret);\n\n            // TODO: data user can also use save, but please test it before removing this code.\n            if ($user instanceof \\Grav\\Common\\User\\DataUser\\User) {\n                // Save secret into the user file.\n                $file = $user->file();\n                if ($file->exists()) {\n                    $content = (array)$file->content();\n                    $content['twofa_secret'] = $secret;\n                    $file->save($content);\n                    $file->free();\n                }\n            } else {\n                $user->save();\n            }\n\n            $this->admin->json_response = ['status' => 'success', 'image' => $image, 'secret' => preg_replace('|(\\w{4})|', '\\\\1 ', $secret)];\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->json_response = ['status' => 'error', 'message' => $e->getMessage()];\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * Save user account.\n     *\n     * Called by more general save task.\n     *\n     * @note Not used if Flex-Objects plugin handles users.\n     *\n     * @return bool\n     */\n    protected function saveUser()\n    {\n        /** @var UserCollectionInterface $users */\n        $users = $this->grav['accounts'];\n\n        $user = $users->load($this->admin->route);\n\n        if (!$this->admin->authorize(['admin.super', 'admin.users'])) {\n            // no user file or not admin.super or admin.users\n            if ($user->username !== $this->grav['user']->username) {\n                $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK') . ' save.','error');\n\n                return false;\n            }\n        }\n\n        /** @var Data\\Blueprint $blueprint */\n        $blueprint = $user->blueprints();\n        $data = $blueprint->processForm($this->admin->cleanUserPost((array)$this->data));\n        $data = new Data\\Data($data, $blueprint);\n\n        try {\n            $data->validate();\n            $data->filter();\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->setMessage($e->getMessage(), 'error');\n\n            return false;\n        }\n\n        $user->update($data->toArray());\n\n        $user = $this->storeFiles($user);\n\n        if ($user) {\n            // Event to manipulate data before saving the object\n            $this->grav->fireEvent('onAdminSave', new Event(['object' => &$user]));\n            $user->save();\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_SAVED'), 'info');\n            $this->grav->fireEvent('onAdminAfterSave', new Event(['object' => $user]));\n        }\n\n        if ($user->username === $this->grav['user']->username) {\n            /** @var UserCollectionInterface $users */\n            $users = $this->grav['accounts'];\n\n            //Editing current user. Reload user object\n            $this->grav['user']->undef('avatar');\n            $this->grav['user']->merge($users->load($this->admin->route)->toArray());\n        }\n\n        return true;\n    }\n\n    // DASHBOARD TASKS\n\n    /**\n     * Get Notifications\n     *\n     * Route: POST /task:getNotifications (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskGetNotifications()\n    {\n        if (!$this->authorizeTask('dashboard', ['admin.login', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        // do we need to force a reload\n        $refresh = $this->data['refresh'] === 'true';\n        $filter = $this->data['filter'] ?? '';\n        $filter_types = !empty($filter) ? array_map('trim', explode(',', $filter)) : [];\n\n        try {\n            $notifications = $this->admin->getNotifications($refresh);\n            $notification_data = [];\n\n            foreach ($notifications as $type => $type_notifications) {\n                if ($filter_types && in_array($type, $filter_types, true)) {\n                    $twig_template = 'partials/notification-' . $type . '-block.html.twig';\n                    $notification_data[$type] = $this->grav['twig']->processTemplate($twig_template, ['notifications' => $type_notifications]);\n                }\n            }\n\n            $json_response = [\n                'status'        => 'success',\n                'notifications' => $notification_data\n            ];\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $json_response = ['status' => 'error', 'message' => $e->getMessage()];\n        }\n\n        $this->sendJsonResponse($json_response);\n    }\n\n\n    /**\n     * Hide notifications.\n     *\n     * Route: POST /notifications.json/task:hideNotification/notification_id:ID (AJAX call)\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskHideNotification()\n    {\n        if (!$this->authorizeTask('hide notification', ['admin.login', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $notification_id = $this->grav['uri']->param('notification_id');\n\n        if (!$notification_id) {\n            $this->admin->json_response = [\n                'status' => 'error'\n            ];\n\n            return false;\n        }\n\n        $filename = $this->grav['locator']->findResource('user://data/notifications/' . $this->grav['user']->username . YAML_EXT, true, true);\n        $file     = CompiledYamlFile::instance($filename);\n        $data     = (array)$file->content();\n\n        $date = new \\DateTime();\n        $data[$notification_id] = $date->format('r');\n        $file->save($data);\n\n        $this->admin->json_response = [\n            'status' => 'success'\n        ];\n\n        return true;\n    }\n\n    /**\n     * Get Newsfeeds\n     *\n     * Route: POST /ajax.json/task:getNewsFeed (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskGetNewsFeed()\n    {\n        if (!$this->authorizeTask('dashboard', ['admin.login', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $refresh = $this->data['refresh'] === 'true' ? true : false;\n\n        try {\n            $feed = $this->admin->getFeed($refresh);\n            $feed_data = $this->grav['twig']->processTemplate('partials/feed-block.html.twig', ['feed' => $feed]);\n\n            $json_response = [\n                'status'    => 'success',\n                'feed_data' => $feed_data\n            ];\n        } catch (MalformedXmlException $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $json_response = ['status' => 'error', 'message' => $e->getMessage()];\n        }\n\n        $this->sendJsonResponse($json_response);\n    }\n\n    // BACKUP TASKS\n\n    /**\n     * Handle the backup action\n     *\n     * Route: GET /backup.json/id:BACKUP_ID/task:backup (AJAX call)\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskBackup()\n    {\n        if (!$this->authorizeTask('backup', ['admin.maintenance', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $param_sep = $this->grav['config']->get('system.param_sep', ':');\n        $download = $this->grav['uri']->param('download');\n\n        try {\n            if ($download) {\n                $filename = basename(base64_decode(urldecode($download)));\n                $file = $this->grav['locator']->findResource(\"backup://{$filename}\", true);\n                if (!$file || !Utils::endsWith($filename, '.zip', false)) {\n                    header('HTTP/1.1 401 Unauthorized');\n                    exit();\n                }\n\n                Utils::download($file, true);\n            }\n\n            $id = $this->grav['uri']->param('id', 0);\n            $backup = Backups::backup($id);\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->json_response = [\n                'status' => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.AN_ERROR_OCCURRED') . '. ' . $e->getMessage()\n            ];\n\n            return true;\n        }\n\n        $download = urlencode(base64_encode($backup));\n        $url = rtrim($this->grav['uri']->rootUrl(false), '/') . '/' . trim($this->admin->base,\n                '/') . '/task' . $param_sep . 'backup/download' . $param_sep . $download . '/admin-nonce' . $param_sep . Utils::getNonce('admin-form');\n\n        $this->admin->json_response = [\n            'status' => 'success',\n            'message' => $this->admin::translate('PLUGIN_ADMIN.YOUR_BACKUP_IS_READY_FOR_DOWNLOAD') . '. <a href=\"' . $url . '\" class=\"button\">' . $this->admin::translate('PLUGIN_ADMIN.DOWNLOAD_BACKUP') . '</a>',\n            'toastr' => [\n                'timeOut' => 0,\n                'extendedTimeOut' => 0,\n                'closeButton' => true\n            ]\n        ];\n\n        return true;\n    }\n\n    /**\n     * Handle delete backup action\n     *\n     * Route: GET /backup.json/backup:BACKUP_FILE/task:backupDelete (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskBackupDelete()\n    {\n        if (!$this->authorizeTask('backup', ['admin.maintenance', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $backup = $this->grav['uri']->param('backup', null);\n\n        if (null !== $backup) {\n            $filename = basename(base64_decode(urldecode($backup)));\n            $file = $this->grav['locator']->findResource(\"backup://{$filename}\", true);\n\n            if ($file && Utils::endsWith($filename, '.zip', false)) {\n                unlink($file);\n\n                $this->admin->json_response = [\n                    'status'  => 'success',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.BACKUP_DELETED'),\n                    'toastr'  => [\n                        'closeButton' => true\n                    ]\n                ];\n\n                return true;\n            }\n        }\n\n        $this->admin->json_response = [\n            'status'  => 'error',\n            'message' => $this->admin::translate('PLUGIN_ADMIN.BACKUP_NOT_FOUND'),\n        ];\n\n        return true;\n    }\n\n    // PLUGIN / THEME TASKS\n\n    /**\n     * Enable a plugin.\n     *\n     * Route: GET /plugins/SLUG/task:enable\n     *\n     * @return bool True if the action was performed.\n     */\n    public function taskEnable()\n    {\n        if ($this->view !== 'plugins') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('enable plugin', ['admin.plugins', 'admin.super'])) {\n            return false;\n        }\n\n        // Filter value and save it.\n        $this->post = ['enabled' => true];\n        $obj        = $this->prepareData($this->post);\n        $obj->save();\n\n        $this->post = ['_redirect' => 'plugins'];\n        if ($this->grav['uri']->param('redirect')) {\n            $this->post = ['_redirect' => 'plugins/' . $this->route];\n        }\n        $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_ENABLED_PLUGIN'), 'info');\n\n        Cache::clearCache('invalidate');\n\n        return true;\n    }\n\n    /**\n     * Disable a plugin.\n     *\n     * Route: GET /plugins/SLUG/task:disable\n     *\n     * @return bool True if the action was performed.\n     */\n    public function taskDisable()\n    {\n        if ($this->view !== 'plugins') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('disable plugin', ['admin.plugins', 'admin.super'])) {\n            return false;\n        }\n\n        // Filter value and save it.\n        $this->post = ['enabled' => false];\n        $obj        = $this->prepareData($this->post);\n        $obj->save();\n\n        $this->post = ['_redirect' => 'plugins'];\n        $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_DISABLED_PLUGIN'), 'info');\n\n        Cache::clearCache('invalidate');\n\n        return true;\n    }\n\n    /**\n     * Set the default theme.\n     *\n     * Route: GET /themes/SLUG/task:activate\n     *\n     * @return bool True if the action was performed.\n     */\n    public function taskActivate()\n    {\n        if ($this->view !== 'themes') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('activate theme', ['admin.themes', 'admin.super'])) {\n            return false;\n        }\n\n        $this->post = ['_redirect' => 'themes' ];\n\n        // Make sure theme exists (throws exception)\n        $name = $this->route;\n        $this->grav['themes']->get($name);\n\n        // Store system configuration.\n        $system = $this->admin->getConfigurationData('config/system');\n        $system->set('pages.theme', $name);\n        $system->save();\n\n        // Force configuration reload and save.\n        /** @var Config $config */\n        $config = $this->grav['config'];\n        $config->reload()->save();\n\n        $config->set('system.pages.theme', $name);\n\n        $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_CHANGED_THEME'), 'info');\n\n        Cache::clearCache('invalidate');\n\n        $this->post = ['_redirect' => 'themes/' . $name ];\n\n        return true;\n    }\n\n    // INSTALL & UPGRADE\n\n    /**\n     * Handles updating Grav\n     *\n     * Route: GET /update.json/task:updategrav (AJAX call)\n     *\n     * @return bool False if user has no permissions.\n     */\n    public function taskUpdategrav()\n    {\n        if (!$this->authorizeTask('install grav', ['admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $gpm     = Gpm::GPM();\n        $version = $gpm->grav->getVersion();\n        $result  = Gpm::selfupgrade();\n\n        if ($result) {\n            $json_response = [\n                'status'  => 'success',\n                'type'    => 'updategrav',\n                'version' => $version,\n                'message' => $this->admin::translate('PLUGIN_ADMIN.GRAV_WAS_SUCCESSFULLY_UPDATED_TO') . ' ' . $version\n            ];\n        } else {\n            $json_response = [\n                'status'  => 'error',\n                'type'    => 'updategrav',\n                'version' => GRAV_VERSION,\n                'message' => $this->admin::translate('PLUGIN_ADMIN.GRAV_UPDATE_FAILED') . ' <br>' . Installer::lastErrorMsg()\n            ];\n        }\n\n        $this->sendJsonResponse($json_response);\n    }\n\n    /**\n     * Handles uninstalling plugins and themes\n     *\n     * @return bool True if the action was performed\n     * @deprecated Not being used anymore\n     */\n    public function taskUninstall()\n    {\n        $type = $this->view;\n        if ($type !== 'plugins' && $type !== 'themes') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('uninstall ' . $type, ['admin.' . $type, 'admin.super'])) {\n            return false;\n        }\n\n        $package = $this->route;\n\n        $result = Gpm::uninstall($package, []);\n\n        if ($result) {\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.UNINSTALL_SUCCESSFUL'), 'info');\n        } else {\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.UNINSTALL_FAILED'), 'error');\n        }\n\n        $this->post = ['_redirect' => $this->view];\n\n        return true;\n    }\n\n    /**\n     * Toggle the gpm.releases setting\n     *\n     * Route: POST /ajax.json/task:gpmRelease (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskGpmRelease()\n    {\n        if (!$this->authorizeTask('configuration', ['admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        // Default release state\n        $release = 'stable';\n        $reload  = false;\n\n        // Get the testing release value if set\n        if ($this->post['release'] === 'testing') {\n            $release = 'testing';\n        }\n\n        $config          = $this->grav['config'];\n        $current_release = $config->get('system.gpm.releases');\n\n        // If the releases setting is different, save it in the system config\n        if ($current_release !== $release) {\n            $data = new Data\\Data($config->get('system'));\n            $data->set('gpm.releases', $release);\n\n            // Get the file location\n            $file = CompiledYamlFile::instance($this->grav['locator']->findResource('config://system.yaml'));\n            $data->file($file);\n\n            // Save the configuration\n            $data->save();\n            $config->reload();\n            $reload = true;\n        }\n\n        $this->admin->json_response = ['status' => 'success', 'reload' => $reload];\n\n        return true;\n    }\n\n    /**\n     * Get update status from GPM\n     *\n     * Request: POST /update.json/task:getUpdates (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskGetUpdates()\n    {\n        if ($this->view !== 'update') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('dashboard', ['admin.plugins', 'admin.themes', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $data  = $this->post;\n        $flush = !empty($data['flush']);\n\n        if (isset($this->grav['session'])) {\n            $this->grav['session']->close();\n        }\n\n        try {\n            $gpm = new GravGPM($flush);\n\n            $resources_updates = $gpm->getUpdatable();\n            foreach ($resources_updates as $key => $update) {\n                if (!is_iterable($update)) {\n                    continue;\n                }\n\n                foreach ($update as $slug => $item) {\n                    $resources_updates[$key][$slug] = $item;\n                }\n            }\n\n            if ($gpm->grav !== null) {\n                $grav_updates = [\n                    'isUpdatable' => $gpm->grav->isUpdatable(),\n                    'assets'      => $gpm->grav->getAssets(),\n                    'version'     => GRAV_VERSION,\n                    'available'   => $gpm->grav->getVersion(),\n                    'date'        => $gpm->grav->getDate(),\n                    'isSymlink'   => $gpm->grav->isSymlink()\n                ];\n\n                $this->admin->json_response = [\n                    'status'  => 'success',\n                    'payload' => [\n                        'resources' => $resources_updates,\n                        'grav'      => $grav_updates,\n                        'installed' => $gpm->countInstalled(),\n                        'flushed'   => $flush\n                    ]\n                ];\n            } else {\n                $this->admin->json_response = ['status' => 'error', 'message' => 'Cannot connect to the GPM'];\n\n                return false;\n            }\n\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->json_response = ['status' => 'error', 'message' => $e->getMessage()];\n\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * Handle getting a new package dependencies needed to be installed.\n     *\n     * Route: /plugins.json/task:getPackagesDependencies (AJAX call)\n     * Route: /themes.json/task:getPackagesDependencies (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskGetPackagesDependencies()\n    {\n        $type = $this->view;\n        if ($type !== 'plugins' && $type !== 'themes') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('get package dependencies', ['admin.' . $type, 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $data     = $this->post;\n        $packages = isset($data['packages']) ? explode(',', $data['packages']) : '';\n        $packages = (array)$packages;\n\n        try {\n            $this->admin->checkPackagesCanBeInstalled($packages);\n            $dependencies = $this->admin->getDependenciesNeededToInstall($packages);\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->json_response = ['status' => 'error', 'message' => $e->getMessage()];\n\n            return false;\n        }\n\n        $this->admin->json_response = ['status' => 'success', 'dependencies' => $dependencies];\n\n        return true;\n    }\n\n    /**\n     * Route: /plugins.json/task:installDependenciesOfPackages (AJAX call)\n     * Route: /themes.json/task:installDependenciesOfPackages (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskInstallDependenciesOfPackages()\n    {\n        $type = $this->view;\n        if ($type !== 'plugins' && $type !== 'themes') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('install dependencies', ['admin.' . $type, 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $data = $this->post;\n        $packages = isset($data['packages']) ? explode(',', $data['packages']) : '';\n        $packages = (array)$packages;\n\n        try {\n            $dependencies = $this->admin->getDependenciesNeededToInstall($packages);\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->json_response = ['status' => 'error', 'message' => $e->getMessage()];\n\n            return false;\n        }\n\n        $result = Gpm::install(array_keys($dependencies), ['theme' => $type === 'themes']);\n\n        if ($result) {\n            $this->admin->json_response = ['status' => 'success', 'message' => 'Dependencies installed successfully'];\n        } else {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSTALLATION_FAILED')\n            ];\n        }\n\n        return true;\n    }\n\n    /**\n     * Route: /plugins.json/task:installPackage (AJAX call)\n     * Route: /themes.json/task:installPackage (AJAX call)\n     *\n     * @param bool $reinstall\n     * @return bool\n     */\n    protected function taskInstallPackage($reinstall = false)\n    {\n        $type = $this->view;\n        if ($type !== 'plugins' && $type !== 'themes') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('install ' . $type, ['admin.' . $type, 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $data = $this->post;\n        $package = $data['package'] ?? '';\n        try {\n            $result = Gpm::install($package, ['theme' => $type === 'themes']);\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $msg = $e->getMessage();\n            $msg = Utils::contains($msg, '401 Unauthorized') ? \"ERROR: License key for this resource is invalid.\" : $msg;\n            $msg = Utils::contains($msg, '404 Not Found') ? \"ERROR: Resource not found\" : $msg;\n\n            $this->admin->json_response = ['status' => 'error', 'message' => $msg];\n\n            return false;\n        }\n\n        if ($result) {\n            $this->admin->json_response = [\n                'status'  => 'success',\n                'message' => $this->admin::translate(is_string($result) ? $result : sprintf($this->admin::translate($reinstall ?: 'PLUGIN_ADMIN.PACKAGE_X_REINSTALLED_SUCCESSFULLY',\n                    null), $package))\n            ];\n        } else {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate($reinstall ?: 'PLUGIN_ADMIN.INSTALLATION_FAILED')\n            ];\n        }\n\n        return true;\n    }\n\n    /**\n     * Handle removing a package\n     *\n     * Route: /plugins.json/task:removePackage (AJAX call)\n     * Route: /themes.json/task:removePackage (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskRemovePackage(): bool\n    {\n        $type = $this->view;\n        if ($type !== 'plugins' && $type !== 'themes') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('uninstall ' . $type, ['admin.' . $type, 'admin.super'])) {\n            $json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            $this->sendJsonResponse($json_response, 403);\n        }\n\n        $data    = $this->post;\n        $package = $data['package'] ?? '';\n        $result = false;\n\n        //check if there are packages that have this as a dependency. Abort and show which ones\n        $dependent_packages = $this->admin->getPackagesThatDependOnPackage($package);\n        if (count($dependent_packages) > 0) {\n            if (count($dependent_packages) > 1) {\n                $message = 'The installed packages <cyan>' . implode('</cyan>, <cyan>',\n                        $dependent_packages) . '</cyan> depends on this package. Please remove those first.';\n            } else {\n                $message = 'The installed package <cyan>' . implode('</cyan>, <cyan>',\n                        $dependent_packages) . '</cyan> depends on this package. Please remove it first.';\n            }\n\n            $json_response = ['status' => 'error', 'message' => $message];\n\n            $this->sendJsonResponse($json_response, 200);\n        }\n\n        $dependencies = false;\n        try {\n            $dependencies = $this->admin->dependenciesThatCanBeRemovedWhenRemoving($package);\n            $result       = Gpm::uninstall($package, []);\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $json_response = ['status' => 'error', 'message' => $e->getMessage()];\n\n            $this->sendJsonResponse($json_response, 200);\n        }\n\n        if ($result) {\n            $json_response = [\n                'status'       => 'success',\n                'dependencies' => $dependencies,\n                'message'      => $this->admin::translate(is_string($result) ? $result : 'PLUGIN_ADMIN.UNINSTALL_SUCCESSFUL')\n            ];\n\n            $this->sendJsonResponse($json_response, 200);\n        }\n\n        $json_response = [\n            'status'  => 'error',\n            'message' => $this->admin::translate('PLUGIN_ADMIN.UNINSTALL_FAILED')\n        ];\n\n        $this->sendJsonResponse($json_response, 200);\n    }\n\n    /**\n     * Handle reinstalling a package\n     *\n     * Route: /plugins.json/task:reinstallPackage (AJAX call)\n     * Route: /themes.json/task:reinstallPackage (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskReinstallPackage()\n    {\n        $type = $this->view;\n        if ($type !== 'plugins' && $type !== 'themes') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('install ' . $type, ['admin.' . $type, 'admin.super'])) {\n            $json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            $this->sendJsonResponse($json_response, 403);\n        }\n\n        $data = $this->post;\n        $slug            = $data['slug'] ?? '';\n        $package_name    = $data['package_name'] ?? '';\n        $current_version = $data['current_version'] ?? '';\n\n        $url = \"https://getgrav.org/download/{$type}s/$slug/$current_version\";\n\n        $result = Gpm::directInstall($url);\n\n        if ($result === true) {\n            $this->admin->json_response = [\n                'status'  => 'success',\n                'message' => $this->admin::translate(sprintf($this->admin::translate('PLUGIN_ADMIN.PACKAGE_X_REINSTALLED_SUCCESSFULLY',\n                    null), $package_name))\n            ];\n        } else {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.REINSTALLATION_FAILED')\n            ];\n        }\n\n        return true;\n    }\n\n    /**\n     * Handle direct install.\n     *\n     * Request: POST /tools/direct-install?task=directInstall\n     *\n     * @return bool\n     */\n    protected function taskDirectInstall()\n    {\n        if (!$this->authorizeTask('install', ['admin.super'])) {\n            return false;\n        }\n\n        $file_path = $this->data['file_path'] ?? null;\n\n        if (isset($_FILES['uploaded_file'])) {\n\n            // Check $_FILES['file']['error'] value.\n            switch ($_FILES['uploaded_file']['error']) {\n                case UPLOAD_ERR_OK:\n                    break;\n                case UPLOAD_ERR_NO_FILE:\n                    $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.NO_FILES_SENT'), 'error');\n                    return false;\n                case UPLOAD_ERR_INI_SIZE:\n                case UPLOAD_ERR_FORM_SIZE:\n                    $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.EXCEEDED_FILESIZE_LIMIT'), 'error');\n                    return false;\n                case UPLOAD_ERR_NO_TMP_DIR:\n                    $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.UPLOAD_ERR_NO_TMP_DIR'), 'error');\n                    return false;\n                default:\n                    $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.UNKNOWN_ERRORS'), 'error');\n                    return false;\n            }\n\n            $file_name = $_FILES['uploaded_file']['name'];\n            $file_path = $_FILES['uploaded_file']['tmp_name'];\n\n            // Handle bad filenames.\n            if (!Utils::checkFilename($file_name)) {\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.UNKNOWN_ERRORS')\n                ];\n\n                return false;\n            }\n        }\n\n\n        $result = Gpm::directInstall($file_path);\n\n        if ($result === true) {\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.INSTALLATION_SUCCESSFUL'), 'info');\n        } else {\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.INSTALLATION_FAILED') . ': ' . $result,\n                'error');\n        }\n\n        $this->setRedirect('/tools');\n\n        return true;\n    }\n\n    // PAGE TASKS\n\n    /**\n     * Handles creating an empty page folder (without markdown file)\n     *\n     * Route: /pages\n     *\n     * @note Not used if Flex-Objects plugin handles pages.\n     *\n     * @return bool True if the action was performed.\n     */\n    public function taskSaveNewFolder()\n    {\n        if ($this->view !== 'pages') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('new folder', ['admin.pages', 'admin.pages.create', 'admin.super'])) {\n            return false;\n        }\n\n        $data = (array)$this->data;\n\n        $folder = $data['folder'] ?? '';\n        if ($folder === '' || mb_strpos($folder, '/') !== false) {\n            throw new \\RuntimeException('Creating folder failed: bad folder name', 400);\n        }\n\n        if ($data['route'] === '' || $data['route'] === '/') {\n            $path = $this->grav['locator']->findResource('page://');\n        } else {\n            $pages = $this->admin::enablePages();\n\n            $page = $pages->find($data['route']);\n            if (!$page) {\n                return false;\n            }\n            $path = $page->path();\n        }\n\n        $orderOfNewFolder = static::getNextOrderInFolder($path);\n        $new_path         = $path . '/' . $orderOfNewFolder . '.' . $folder;\n\n        Folder::create($new_path);\n        Cache::clearCache('invalidate');\n\n        $this->grav->fireEvent('onAdminAfterSaveAs', new Event(['path' => $new_path]));\n\n        $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_SAVED'), 'info');\n\n        $this->setRedirect($this->admin->getAdminRoute(\"/{$this->view}\")->toString());\n\n        return true;\n    }\n\n    /**\n     * @note Not used if Flex-Objects plugin handles pages.\n     *\n     * @return bool\n     */\n    protected function savePage()\n    {\n        $reorder = true;\n\n        $data = (array)$this->data;\n        $this->grav['twig']->twig_vars['current_form_data'] = $data;\n\n        $pages = $this->admin::enablePages();\n\n        // Find new parent page in order to build the path.\n        $path = trim($data['route'] ?? dirname($this->admin->route), '/');\n        if ($path === '.') {\n            $path = '';\n        }\n\n        /** @var PageInterface $obj */\n        $obj = $this->admin->page(true);\n\n        $folder = $data['folder'] ?? null;\n        if ($folder === '' || mb_strpos($folder, '/') !== false) {\n            throw new \\RuntimeException('Saving page failed: bad folder name', 400);\n        }\n\n        if (!isset($data['folder']) || !$data['folder']) {\n            $data['folder'] = $obj->slug();\n            $this->data['folder'] = $obj->slug();\n        }\n\n        // Check for valid frontmatter\n        if (isset($data['frontmatter']) && !$this->checkValidFrontmatter($data['frontmatter'])) {\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.INVALID_FRONTMATTER_COULD_NOT_SAVE'),\n                'error');\n            return false;\n        }\n\n        // XSS Checks for page content\n        $xss_whitelist = $this->grav['config']->get('security.xss_whitelist', 'admin.super');\n        if (!$this->admin->authorize($xss_whitelist)) {\n            $check_what = ['header' => $data['header'] ?? '', 'frontmatter' => $data['frontmatter'] ?? '', 'content' => $data['content'] ?? ''];\n            $results = Security::detectXssFromArray($check_what);\n            if (!empty($results)) {\n                $this->admin->setMessage('<i class=\"fa fa-ban\"></i> ' . $this->admin::translate('PLUGIN_ADMIN.XSS_ONSAVE_ISSUE'),\n                    'error');\n                return false;\n            }\n        }\n\n        if ($path !== '') {\n            // First try to get page by its path.\n            $parent = $pages->get(GRAV_ROOT . '/' . $path);\n            if (!$parent) {\n                // Fall back using the route.\n                $route = '/' . preg_replace(PageIndex::PAGE_ROUTE_REGEX, '/', $path);\n                $parent = $pages->find($route, true);\n                if (!$parent) {\n                    throw new \\RuntimeException('New parent page cannot be resolved!');\n                }\n            }\n        } else {\n            $parent = $pages->root();\n        }\n\n        $original_order = (int)trim($obj->order(), '.');\n\n        try {\n            // Change parent if needed and initialize move (might be needed also on ordering/folder change).\n            $obj = $obj->move($parent);\n            $this->preparePage($obj, false, $obj->language());\n            $obj->validate();\n\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->setMessage($e->getMessage(), 'error');\n\n            return false;\n        }\n        $obj->filter();\n\n        // rename folder based on visible\n        if ($original_order === 1000) {\n            // increment order to force reshuffle\n            $obj->order($original_order + 1);\n        }\n\n        if (isset($data['order']) && !empty($data['order'])) {\n            $reorder = explode(',', $data['order']);\n        }\n\n        // add or remove numeric prefix based on ordering value\n        if (isset($data['ordering'])) {\n            if ($data['ordering'] && !$obj->order()) {\n                $obj->order(static::getNextOrderInFolder($obj->parent()->path()));\n                $reorder = false;\n            } elseif (!$data['ordering'] && $obj->order()) {\n                $obj->folder($obj->slug());\n            }\n        }\n\n        $obj = $this->storeFiles($obj);\n\n        if ($obj) {\n            // Event to manipulate data before saving the object\n            // DEPRECATED: page\n            $this->grav->fireEvent('onAdminSave', new Event(['object' => &$obj, 'page' => &$obj]));\n\n            $obj->save($reorder);\n\n            Cache::clearCache('invalidate');\n\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_SAVED'), 'info');\n            // DEPRECATED: page\n            $this->grav->fireEvent('onAdminAfterSave', new Event(['object' => $obj, 'page' => $obj]));\n        }\n\n        if (method_exists($obj, 'unsetRouteSlug')) {\n            $obj->unsetRouteSlug();\n        }\n\n        $multilang = $this->isMultilang();\n\n        if ($multilang && !$obj->language()) {\n            $obj->language($this->admin->getLanguage());\n        }\n        $admin_route = $this->admin->base;\n\n        $route           = $obj->rawRoute();\n        $redirect_url = ($multilang ? '/' . $obj->language() : '') . $admin_route . '/' . $this->view . $route;\n        $this->setRedirect($redirect_url);\n\n        return true;\n    }\n\n    /**\n     * Save page as a new copy.\n     *\n     * Route: /pages\n     *\n     * @note Not used if Flex-Objects plugin handles pages.\n     *\n     * @return bool True if the action was performed.\n     * @throws \\RuntimeException\n     */\n    protected function taskCopy()\n    {\n        if ($this->view !== 'pages') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('copy page', ['admin.pages', 'admin.pages.create', 'admin.super'])) {\n            return false;\n        }\n\n        try {\n            $pages = $this->admin::enablePages();\n\n            // Get the current page.\n            $original_page = $this->admin->page(true);\n\n            // Find new parent page in order to build the path.\n            $parent = $original_page->parent() ?: $pages->root();\n            // Make a copy of the current page and fill the updated information into it.\n            $page = $original_page->copy($parent);\n\n            $order = 0;\n            if ($page->order()) {\n                $order = $this->getNextOrderInFolder($page->parent()->path());\n            }\n\n            // Make sure the header is loaded in case content was set through raw() (expert mode)\n            $page->header();\n\n            if ($page->order()) {\n                $page->order($order);\n            }\n\n            $folder = $this->findFirstAvailable('folder', $page);\n            $slug   = $this->findFirstAvailable('slug', $page);\n\n            $page->path($page->parent()->path() . DS . $page->order() . $folder);\n            $page->route($page->parent()->route() . '/' . $slug);\n            $page->rawRoute($page->parent()->rawRoute() . '/' . $slug);\n\n            // Append progressive number to the copied page title\n            $match  = preg_split('/(\\d+)(?!.*\\d)/', $original_page->title(), 2, PREG_SPLIT_DELIM_CAPTURE);\n            $header = $page->header();\n            if (!isset($match[1])) {\n                $header->title = $match[0] . ' 2';\n            } else {\n                $header->title = $match[0] . ((int)$match[1] + 1);\n            }\n\n            $page->header($header);\n            $page->save(false);\n\n            $redirect = $this->view . $page->rawRoute();\n            $header   = $page->header();\n\n            if (isset($header->slug)) {\n                $match        = preg_split('/-(\\d+)$/', $header->slug, 2, PREG_SPLIT_DELIM_CAPTURE);\n                $header->slug = $match[0] . '-' . (isset($match[1]) ? (int)$match[1] + 1 : 2);\n            }\n\n            $page->header($header);\n\n            $page->save();\n\n            Cache::clearCache('invalidate');\n\n            // DEPRECATED: page\n            $this->grav->fireEvent('onAdminAfterSave', new Event(['object' => $page, 'page' => $page]));\n\n            // Enqueue message and redirect to new location.\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_COPIED'), 'info');\n            $this->setRedirect($redirect);\n\n        } catch (\\Exception $e) {\n            throw new \\RuntimeException('Copying page failed on error: ' . $e->getMessage());\n        }\n\n        return true;\n    }\n\n    /**\n     * Reorder pages.\n     *\n     * Route: /pages\n     *\n     * @note Not used if Flex-Objects plugin handles pages.\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskReorder()\n    {\n        if ($this->view !== 'pages') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('reorder pages', ['admin.pages', 'admin.pages.update', 'admin.super'])) {\n            return false;\n        }\n\n        $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.REORDERING_WAS_SUCCESSFUL'), 'info');\n\n        return true;\n    }\n\n    /**\n     * Delete page.\n     *\n     * Route: /pages\n     *\n     * @note Not used if Flex-Objects plugin handles pages.\n     *\n     * @return bool True if the action was performed.\n     * @throws \\RuntimeException\n     */\n    protected function taskDelete()\n    {\n        if ($this->view !== 'pages') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('delete page', ['admin.pages', 'admin.pages.delete', 'admin.super'])) {\n            return false;\n        }\n\n        try {\n            $page = $this->admin->page();\n\n            if (count($page->translatedLanguages()) > 1) {\n                $page->file()->delete();\n            } else {\n                Folder::delete($page->path());\n            }\n\n            // DEPRECATED: page\n            $this->grav->fireEvent('onAdminAfterDelete', new Event(['object' => $page, 'page' => $page]));\n\n            Cache::clearCache('invalidate');\n\n            // Set redirect to pages list.\n            $redirect = 'pages';\n\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_DELETED'), 'info');\n            $this->setRedirect($redirect);\n\n        } catch (\\Exception $e) {\n            throw new \\RuntimeException('Deleting page failed on error: ' . $e->getMessage());\n        }\n\n        return true;\n    }\n\n    /**\n     * Switch the content language. Optionally redirect to a different page.\n     *\n     * Route: /pages\n     *\n     * @note Not used if Flex-Objects plugin handles pages.\n     *\n     * @return bool\n     */\n    protected function taskSwitchlanguage()\n    {\n        if ($this->view !== 'pages') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('switch language', ['admin.pages', 'admin.pages.list', 'admin.super'])) {\n            return false;\n        }\n\n        $data = (array)$this->data;\n\n        $language = $data['lang'] ?? $this->grav['uri']->param('lang');\n\n        if (isset($data['redirect'])) {\n            $redirect = '/pages/' . $data['redirect'];\n        } else {\n            $redirect = '/pages';\n        }\n\n\n        if ($language) {\n            $this->grav['session']->admin_lang = $language ?: 'en';\n        }\n\n        $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_SWITCHED_LANGUAGE'), 'info');\n\n        $this->setRedirect($this->admin->getAdminRoute($redirect)->toString());\n\n        return true;\n    }\n\n    /**\n     * Save the current page in a different language. Automatically switches to that language.\n     *\n     * Route: /pages\n     *\n     * @note Not used if Flex-Objects plugin handles pages.\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskSaveas()\n    {\n        if ($this->view !== 'pages') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('save as', ['admin.pages', 'admin.pages.create', 'admin.super'])) {\n            return false;\n        }\n\n        /** @var Language $language */\n        $language = $this->grav['language'];\n\n        $data     = (array)$this->data;\n        $lang = $data['lang'] ?? null;\n\n        if ($lang) {\n            $this->grav['session']->admin_lang = $lang ?: 'en';\n        }\n\n        $uri = $this->grav['uri'];\n        $obj = $this->admin->page($uri->route());\n        $this->preparePage($obj, false, $lang);\n\n        $file = $obj->file();\n        if ($file) {\n            $filename = $this->determineFilenameIncludingLanguage($obj->name(), $lang);\n\n            $path  = $obj->path() . DS . $filename;\n            $aFile = File::instance($path);\n            $aFile->save();\n\n            $aPage = new Page();\n            $aPage->init(new \\SplFileInfo($path), $lang . '.md');\n            $aPage->header($obj->header());\n            $aPage->rawMarkdown($obj->rawMarkdown());\n            $aPage->template($obj->template());\n            $aPage->validate();\n            $aPage->filter();\n\n            // DEPRECATED: page\n            $this->grav->fireEvent('onAdminSave', new Event(['object' => $aPage, 'page' => &$aPage]));\n\n            $aPage->save();\n\n            Cache::clearCache('invalidate');\n\n            // DEPRECATED: page\n            $this->grav->fireEvent('onAdminAfterSave', new Event(['object' => $aPage, 'page' => $aPage]));\n        }\n\n        $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_SWITCHED_LANGUAGE'), 'info');\n\n        // TODO: better multilanguage support needed.\n        $this->setRedirect($language->getLanguageURLPrefix($lang) . $uri->route());\n\n        return true;\n    }\n\n    /**\n     * Continue to the new page.\n     *\n     * @note Not used if Flex-Objects plugin handles pages, users and user groups.\n     *\n     * @return bool True if the action was performed.\n     */\n    public function taskContinue()\n    {\n        $data = (array)$this->data;\n\n        if ($this->view === 'users') {\n            $username = strip_tags(strtolower($data['username']));\n            $this->setRedirect(\"{$this->view}/{$username}\");\n\n            return true;\n        }\n\n        if ($this->view !== 'pages') {\n            return false;\n        }\n\n        $route  = $data['route'] !== '/' ? $data['route'] : '';\n        $folder = $data['folder'] ?? null;\n        $title = $data['title'] ?? null;\n\n        // Handle @slugify-{field} value, automatically slugifies the specified field\n        if (null !== $folder && 0 === strpos($folder, '@slugify-')) {\n            $folder = \\Grav\\Plugin\\Admin\\Utils::slug($data[substr($folder, 9)] ?? '');\n        }\n        if (!$folder) {\n            $folder = \\Grav\\Plugin\\Admin\\Utils::slug($title) ?: '';\n        }\n        $folder = ltrim($folder, '_');\n        if ($folder === '' || mb_strpos($folder, '/') !== false) {\n            throw new \\RuntimeException('Creating page failed: bad folder name', 400);\n        }\n\n        if (!empty($data['modular'])) {\n            $folder = '_' . $folder;\n        }\n\n        $data['folder'] = $folder;\n\n        $path = $route . '/' . $folder;\n        $this->admin->session()->{$path} = $data;\n\n        // Store the name and route of a page, to be used pre-filled defaults of the form in the future\n        $this->admin->session()->lastPageName  = $data['name'];\n        $this->admin->session()->lastPageRoute = $data['route'];\n\n        $this->setRedirect(\"{$this->view}/\" . ltrim($path, '/'));\n\n        return true;\n    }\n\n    /**\n     * $data['route'] = $this->grav['uri']->param('route');\n     * $data['sortby'] = $this->grav['uri']->param('sortby', null);\n     * $data['filters'] = $this->grav['uri']->param('filters', null);\n     * $data['page'] $this->grav['uri']->param('page', true);\n     * $data['base'] = $this->grav['uri']->param('base');\n     * $initial = (bool) $this->grav['uri']->param('initial');\n     *\n     * @return ResponseInterface\n     * @throws RequestException\n     */\n    protected function taskGetLevelListing(): ResponseInterface\n    {\n        $this->checkTaskAuthorization('save', $this->dataPermissions());\n\n        $request = $this->getRequest();\n        $data = $request->getParsedBody();\n\n        if (!isset($data['field'])) {\n            throw new RequestException($request, 'Bad Request', 400);\n        }\n\n        // Base64 decode the route\n        $data['route'] = isset($data['route']) ? base64_decode($data['route']) : null;\n\n        $initial = $data['initial'] ?? null;\n        if ($initial) {\n            $data['leaf_route'] = $data['route'];\n            $data['route'] = null;\n            $data['level'] = 1;\n        }\n\n        [$status, $message, $response,] = $this->getLevelListing($data);\n\n        $json = [\n            'status'  => $status,\n            'message' => $this->admin::translate($message ?? 'PLUGIN_ADMIN.NO_ROUTE_PROVIDED'),\n            'data' => array_values($response)\n        ];\n\n        return $this->createJsonResponse($json, 200);\n    }\n\n    /**\n     * Route: /ajax.json\n     *\n     * @note Not used if Flex-Objects plugin handles pages.\n     *\n     * @return bool\n     */\n    protected function taskGetChildTypes()\n    {\n        if ($this->view !== 'ajax') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('get childtypes', ['admin.pages', 'admin.pages.list', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $data = $this->post;\n\n        $route = $data['rawroute'] ?? null;\n        if ($route) {\n            /** @var Flex $flex */\n            $flex = $this->grav['flex'];\n            $page = $flex->getObject(trim($route, '/'), 'pages');\n            if ($page instanceof PageInterface) {\n                $child_type = $page->childType();\n                if ($child_type !== '') {\n                    $this->admin->json_response = [\n                        'status' => 'success',\n                        'child_type' => $child_type\n                    ];\n                    return true;\n                }\n            }\n        }\n\n        $this->admin->json_response = [\n            'status'  => 'success',\n            'child_type' => '',\n        ];\n\n        return true;\n    }\n\n    /**\n     * Handles filtering the page by modular/visible/routable in the pages list.\n     *\n     * @note Used only in legacy pages.\n     *\n     * @return bool\n     */\n    protected function taskFilterPages()\n    {\n        if ($this->view !== 'pages-filter') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('filter pages', ['admin.pages', 'admin.pages.list', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $data = $this->post;\n\n        $flags   = !empty($data['flags']) ? array_map('strtolower', explode(',', $data['flags'])) : [];\n        $queries = !empty($data['query']) ? explode(',', $data['query']) : [];\n\n        $pages = $this->admin::enablePages();\n\n        /** @var Collection $collection */\n        $collection = $pages->all();\n\n        if (count($flags)) {\n            // Filter by state\n            $pageStates = [\n                'modular',\n                'nonmodular',\n                'visible',\n                'nonvisible',\n                'routable',\n                'nonroutable',\n                'published',\n                'nonpublished'\n            ];\n\n            if (count(array_intersect($pageStates, $flags)) > 0) {\n                if (in_array('modular', $flags, true)) {\n                    $collection = $collection->modular();\n                }\n\n                if (in_array('nonmodular', $flags, true)) {\n                    $collection = $collection->nonModular();\n                }\n\n                if (in_array('visible', $flags, true)) {\n                    $collection = $collection->visible();\n                }\n\n                if (in_array('nonvisible', $flags, true)) {\n                    $collection = $collection->nonVisible();\n                }\n\n                if (in_array('routable', $flags, true)) {\n                    $collection = $collection->routable();\n                }\n\n                if (in_array('nonroutable', $flags, true)) {\n                    $collection = $collection->nonRoutable();\n                }\n\n                if (in_array('published', $flags, true)) {\n                    $collection = $collection->published();\n                }\n\n                if (in_array('nonpublished', $flags, true)) {\n                    $collection = $collection->nonPublished();\n                }\n            }\n            foreach ($pageStates as $pageState) {\n                if (($pageState = array_search($pageState, $flags, true)) !== false) {\n                    unset($flags[$pageState]);\n                }\n            }\n\n            // Filter by page type\n            if ($flags) {\n                $types = [];\n\n                $pageTypes = array_keys(Pages::pageTypes());\n                foreach ($pageTypes as $pageType) {\n                    if (($pageKey = array_search($pageType, $flags, true)) !== false) {\n                        $types[] = $pageType;\n                        unset($flags[$pageKey]);\n                    }\n                }\n\n                if (count($types)) {\n                    $collection = $collection->ofOneOfTheseTypes($types);\n                }\n            }\n\n            // Filter by page type\n            if ($flags) {\n                $accessLevels = $flags;\n                $collection   = $collection->ofOneOfTheseAccessLevels($accessLevels);\n            }\n        }\n\n        if (!empty($queries)) {\n            foreach ($collection as $page) {\n                foreach ($queries as $query) {\n                    $query = trim($query);\n                    if (stripos($page->getRawContent(), $query) === false\n                        && stripos($page->title(), $query) === false\n                        && stripos($page->folder(), $query) === false\n                        && stripos($page->slug(), \\Grav\\Plugin\\Admin\\Utils::slug($query)) === false\n                    ) {\n                        $collection->remove($page);\n                    }\n                }\n            }\n        }\n\n        $results = [];\n        foreach ($collection as $path => $page) {\n            $results[] = $page->route();\n        }\n\n        $this->admin->json_response = [\n            'status'  => 'success',\n            'message' => $this->admin::translate('PLUGIN_ADMIN.PAGES_FILTERED'),\n            'results' => $results\n        ];\n        $this->admin->collection = $collection;\n\n        return true;\n    }\n\n\n    /**\n     * Process the page Markdown\n     *\n     * Preview task in the builtin editor.\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskProcessMarkdown()\n    {\n        if (!$this->authorizeTask('process markdown', ['admin.pages', 'admin.pages.read', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        try {\n            $page = $this->admin->page(true);\n\n            if (!$page) {\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.NO_PAGE_FOUND')\n                ];\n\n                return false;\n            }\n\n            $this->preparePage($page, true);\n            $page->header();\n            $page->templateFormat('html');\n\n            // Add theme template paths to Twig loader\n            $template_paths = $this->grav['locator']->findResources('theme://templates');\n            $this->grav['twig']->twig->getLoader()->addLoader(new FilesystemLoader($template_paths));\n\n            $html = $page->content();\n\n            $this->admin->json_response = ['status' => 'success', 'preview' => $html];\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->json_response = ['status' => 'error', 'message' => $e->getMessage()];\n\n            return false;\n        }\n\n        return true;\n    }\n\n    // MEDIA TASKS\n\n    /**\n     * Determines the file types allowed to be uploaded\n     *\n     * Used by pagemedia field. Works only within legacy pages.\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskListmedia()\n    {\n        if ($this->view !== 'media') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('list media', ['admin.pages', 'admin.pages.read', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $media = $this->getMedia();\n        if (!$media) {\n            $this->admin->json_response = [\n                'status' => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.NO_PAGE_FOUND')\n            ];\n\n            return false;\n        }\n\n        $media_list = [];\n        /**\n         * @var string $name\n         * @var Medium|ImageMedium $medium\n         */\n        foreach ($media->all() as $name => $medium) {\n\n            $metadata = [];\n            $img_metadata = $medium->metadata();\n            if ($img_metadata) {\n                $metadata = $img_metadata;\n            }\n\n            // Get original name\n            /** @var ImageMedium $source */\n            $source = method_exists($medium, 'higherQualityAlternative') ? $medium->higherQualityAlternative() : null;\n\n            $media_list[$name] = [\n                'url' => $medium->display($medium->get('extension') === 'svg' ? 'source' : 'thumbnail')->cropZoom(400, 300)->url(),\n                'size' => $medium->get('size'),\n                'metadata' => $metadata,\n                'original' => $source ? $source->get('filename') : null\n            ];\n        }\n\n        $this->admin->json_response = ['status' => 'success', 'results' => $media_list];\n\n        return true;\n    }\n\n    /**\n     * Handles adding a media file to a page.\n     *\n     * Used by pagemedia field. Works only within legacy pages.\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskAddmedia()\n    {\n        if ($this->view !== 'media') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('add media', ['admin.pages', 'admin.pages.update', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        /** @var Config $config */\n        $config = $this->grav['config'];\n\n        if (empty($_FILES)) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.EXCEEDED_POSTMAX_LIMIT')\n            ];\n\n            return false;\n        }\n\n        if (!isset($_FILES['file']['error']) || is_array($_FILES['file']['error'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INVALID_PARAMETERS')\n            ];\n\n            return false;\n        }\n\n        // Check $_FILES['file']['error'] value.\n        switch ($_FILES['file']['error']) {\n            case UPLOAD_ERR_OK:\n                break;\n            case UPLOAD_ERR_NO_FILE:\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.NO_FILES_SENT')\n                ];\n\n                return false;\n            case UPLOAD_ERR_INI_SIZE:\n            case UPLOAD_ERR_FORM_SIZE:\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.EXCEEDED_FILESIZE_LIMIT')\n                ];\n\n                return false;\n            case UPLOAD_ERR_NO_TMP_DIR:\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.UPLOAD_ERR_NO_TMP_DIR')\n                ];\n\n                return false;\n            default:\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.UNKNOWN_ERRORS')\n                ];\n\n                return false;\n        }\n\n        $filename = $_FILES['file']['name'];\n\n        // Handle bad filenames.\n        if (!Utils::checkFilename($filename)) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => sprintf($this->admin::translate('PLUGIN_ADMIN.FILEUPLOAD_UNABLE_TO_UPLOAD'),\n                    $filename, 'Bad filename')\n            ];\n\n            return false;\n        }\n\n        // You should also check filesize here.\n        $grav_limit = Utils::getUploadLimit();\n        if ($grav_limit > 0 && $_FILES['file']['size'] > $grav_limit) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.EXCEEDED_GRAV_FILESIZE_LIMIT')\n            ];\n\n            return false;\n        }\n\n\n        // Check extension\n        $extension = strtolower(pathinfo($filename, PATHINFO_EXTENSION));\n\n        // If not a supported type, return\n        if (!$extension || !$config->get(\"media.types.{$extension}\")) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.UNSUPPORTED_FILE_TYPE') . ': ' . $extension\n            ];\n\n            return false;\n        }\n\n        $page = $this->admin->page($this->route);\n        $media = $page ? $this->getMedia($page) : null;\n        if (!$media) {\n            $this->admin->json_response = [\n                'status' => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.NO_PAGE_FOUND')\n            ];\n\n            return false;\n        }\n\n        /** @var UniformResourceLocator $locator */\n        $locator = $this->grav['locator'];\n        $path = $media->getPath();\n        if ($locator->isStream($path)) {\n            $path = $locator->findResource($path, true, true);\n        }\n\n        // Special Sanitization for SVG\n        if (Utils::contains($extension, 'svg', false)) {\n            Security::sanitizeSVG($_FILES['file']['tmp_name']);\n        }\n\n        // Upload it\n        if (!move_uploaded_file($_FILES['file']['tmp_name'], sprintf('%s/%s', $path, $filename))) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.FAILED_TO_MOVE_UPLOADED_FILE')\n            ];\n\n            return false;\n        }\n\n        Cache::clearCache('invalidate');\n\n        // Add metadata if needed\n        $include_metadata = Grav::instance()['config']->get('system.media.auto_metadata_exif', false);\n        $basename = str_replace(['@3x', '@2x'], '', pathinfo($filename, PATHINFO_BASENAME));\n\n        $metadata = [];\n\n        if ($include_metadata && isset($media[$basename])) {\n            $img_metadata = $media[$basename]->metadata();\n            if ($img_metadata) {\n                $metadata = $img_metadata;\n            }\n        }\n\n        // DEPRECATED: page\n        $this->grav->fireEvent('onAdminAfterAddMedia', new Event(['object' => $page, 'page' => $page]));\n\n        $this->admin->json_response = [\n            'status'  => 'success',\n            'message' => $this->admin::translate('PLUGIN_ADMIN.FILE_UPLOADED_SUCCESSFULLY'),\n            'metadata' => $metadata,\n        ];\n\n        return true;\n    }\n\n    /**\n     * Request: POST .json/task:compileScss (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskCompileScss()\n    {\n        if (!$this->authorizeTask('compile scss', ['admin.plugins', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $default_scheme = $this->grav['config']->get('plugins.admin.whitelabel.color_scheme');\n\n        $preview = $this->post['preview'] ?? false;\n        $data = ['color_scheme' => $this->data['whitelabel']['color_scheme'] ?? $default_scheme];\n        $output_file = $preview ? 'admin-preset.css' : 'admin-preset__tmp.css';\n\n        $options = [\n            'input' => 'plugin://admin/themes/grav/scss/preset.scss',\n            'output' => 'asset://' .$output_file\n        ];\n\n        [$compile_status, $msg] = $this->grav['admin-whitelabel']->compilePresetScss($data, $options);\n\n        $json_response = [\n            'status'  => $compile_status ? 'success' : 'error',\n            'message' => ($preview ? 'Preview ' : 'SCSS ') . $msg,\n            'files' => [\n                'color_scheme' => Utils::url($options['output'])\n            ]\n        ];\n\n        $this->sendJsonResponse($json_response);\n    }\n\n    /**\n     * Request: POST .json/task:exportScss (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskExportScss()\n    {\n        if (!$this->authorizeTask('export scss', ['admin.plugins', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $data = ['color_scheme' => $this->data['whitelabel']['color_scheme'] ?? null];\n        $name = empty($this->data['whitelabel']['color_scheme']['name']) ? 'admin-theme-export' : \\Grav\\Plugin\\Admin\\Utils::slug($this->data['whitelabel']['color_scheme']['name']);\n\n        $location  = 'asset://' . $name . '.yaml';\n\n        [$status, $msg] = $this->grav['admin-whitelabel']->exportPresetScsss($data, $location);\n\n        $json_response = [\n            'status'  => $status ? 'success' : 'error',\n            'message' => $msg,\n            'files' => [\n                'download' => Utils::url($location)\n            ]\n        ];\n\n        $this->sendJsonResponse($json_response);\n    }\n\n    /**\n     * Handles deleting a media file from a page.\n     *\n     * Used by pagemedia field.\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskDelmedia()\n    {\n        if ($this->view !== 'media') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('delete media', ['admin.pages', 'admin.pages.update', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $page = $this->admin->page($this->route);\n        $media = $page ? $this->getMedia($page) : null;\n        if (null === $media) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.NO_PAGE_FOUND')\n            ];\n\n            return false;\n        }\n\n        $filename = !empty($this->post['filename']) ? basename($this->post['filename']) : null;\n\n        // Handle bad filenames.\n        if (!$filename || !Utils::checkFilename($filename)) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.NO_FILE_FOUND')\n            ];\n\n            return false;\n        }\n\n        /** @var UniformResourceLocator $locator */\n        $locator = $this->grav['locator'];\n\n        $targetPath = $media->getPath() . '/' . $filename;\n        if ($locator->isStream($targetPath)) {\n            $targetPath = $locator->findResource($targetPath, true, true);\n        }\n        $fileParts  = pathinfo($filename);\n\n        $found = false;\n\n        if (file_exists($targetPath)) {\n            $found  = true;\n            $result = unlink($targetPath);\n\n            if (!$result) {\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.FILE_COULD_NOT_BE_DELETED') . ': ' . $filename\n                ];\n\n                return false;\n            }\n        }\n\n        // Remove Extra Files\n        foreach (scandir($media->getPath(), SCANDIR_SORT_NONE) as $file) {\n            if (preg_match(\"/{$fileParts['filename']}@\\d+x\\.{$fileParts['extension']}(?:\\.meta\\.yaml)?$|{$filename}\\.meta\\.yaml$/\", $file)) {\n\n                $targetPath = $media->getPath() . '/' . $file;\n                if ($locator->isStream($targetPath)) {\n                    $targetPath = $locator->findResource($targetPath, true, true);\n                }\n\n                $result = unlink($targetPath);\n\n                if (!$result) {\n                    $this->admin->json_response = [\n                        'status'  => 'error',\n                        'message' => $this->admin::translate('PLUGIN_ADMIN.FILE_COULD_NOT_BE_DELETED') . ': ' . $filename\n                    ];\n\n                    return false;\n                }\n\n                $found = true;\n            }\n        }\n\n        Cache::clearCache('invalidate');\n\n        if (!$found) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.FILE_NOT_FOUND') . ': ' . $filename\n            ];\n\n            return false;\n        }\n\n        // DEPRECATED: page\n        $this->grav->fireEvent('onAdminAfterDelMedia', new Event(['object' => $page, 'page' => $page, 'media' => $media, 'filename' => $filename]));\n\n        $this->admin->json_response = [\n            'status'  => 'success',\n            'message' => $this->admin::translate('PLUGIN_ADMIN.FILE_DELETED') . ': ' . $filename\n        ];\n\n        return true;\n    }\n\n    /**\n     * @param array $data\n     * @return array\n     */\n    protected function getLevelListing($data)\n    {\n        // Valid types are dir|file|link\n        $default_filters =  ['type'=> ['root', 'dir'], 'name' => null, 'extension' => null];\n\n        $pages = $this->admin::enablePages();\n\n        $page_instances = $pages->instances();\n\n        $is_page = $data['page'] ?? true;\n        $route = $data['route'] ?? null;\n        $leaf_route = $data['leaf_route'] ?? null;\n        $sortby = $data['sortby'] ?? 'filename';\n        $order = $data['order'] ?? SORT_ASC;\n        $initial = $data['initial'] ?? null;\n        $filters = isset($data['filters']) ? $default_filters + json_decode($data['filters']) : $default_filters;\n        $filter_type = (array) $filters['type'];\n\n        $status = 'error';\n        $msg = null;\n        $response = [];\n        $children = null;\n        $sub_route = null;\n        $extra = null;\n        $root = false;\n\n        // Handle leaf_route\n        if ($leaf_route && $route !== $leaf_route) {\n            $nodes = explode('/', $leaf_route);\n            $sub_route =  '/' . implode('/', array_slice($nodes, 1, $data['level']++));\n            $data['route'] = $sub_route;\n\n            [$status, $msg, $children, $extra] = $this->getLevelListing($data);\n        }\n\n        // Handle no route, assume page tree root\n        if (!$route) {\n            $is_page = false;\n            $route = $this->grav['locator']->findResource('page://', true);\n            $root = true;\n        }\n\n        if ($is_page) {\n            // Try the path\n            /** @var PageInterface $page */\n            $page = $pages->get(GRAV_ROOT . $route);\n\n            // Try a real route (like homepage)\n            if (is_null($page)) {\n                $page = $pages->find($route);\n            }\n\n            $path = $page ? $page->path() : null;\n        } else {\n            // Try a physical path\n            if (!Utils::startsWith($route, GRAV_ROOT)) {\n                $try_path = GRAV_ROOT . $route;\n            } else {\n                $try_path = $route;\n            }\n\n            $path = file_exists($try_path) ? $try_path : null;\n        }\n\n        $blueprintsData = $this->admin->page(true);\n\n        if (null !== $blueprintsData) {\n            if (method_exists($blueprintsData, 'blueprints')) {\n                $settings = $blueprintsData->blueprints()->schema()->getProperty($data['field']);\n            } elseif (method_exists($blueprintsData, 'getBlueprint')) {\n                $settings = $blueprintsData->getBlueprint()->schema()->getProperty($data['field']);\n            }\n\n            $filters = array_merge([], $filters, ($settings['filters'] ?? []));\n            $filter_type = $filters['type'] ?? $filter_type;\n        }\n\n\n        if ($path) {\n            $status = 'success';\n            $msg = 'PLUGIN_ADMIN.PAGE_ROUTE_FOUND';\n            foreach (new \\DirectoryIterator($path) as $fileInfo) {\n                $fileName = $fileInfo->getFilename();\n                $filePath = str_replace('\\\\', '/', $fileInfo->getPathname());\n\n                if (($fileInfo->isDot() && $fileName !== '.' && $initial) || (Utils::startsWith($fileName, '.') && strlen($fileName) > 1)) {\n                    continue;\n                }\n\n                if ($fileInfo->isDot()) {\n                    if ($root) {\n                        $payload = [\n                            'name' => '<root>',\n                            'value' => '',\n                            'item-key' => '',\n                            'filename' => '.',\n                            'extension' => '',\n                            'type' => 'root',\n                            'modified' => $fileInfo->getMTime(),\n                            'size' => 0,\n                            'has-children' => false\n                        ];\n                    } else {\n                        continue;\n                    }\n                } else {\n                    $file_page = $page_instances[$filePath] ?? null;\n                    $file_path = Utils::replaceFirstOccurrence(GRAV_ROOT, '', $filePath);\n                    $type = $fileInfo->getType();\n\n                    $child_path = $file_page ? $file_page->path() : $filePath;\n                    $count_children = Folder::countChildren($child_path);\n\n                    $payload = [\n                        'name' => $file_page ? $file_page->title() : $fileName,\n                        'value' => $file_page ? $file_page->rawRoute() : $file_path,\n                        'item-key' => basename($file_page ? $file_page->route() : $file_path),\n                        'filename' => $fileName,\n                        'extension' => $type === 'dir' ? '' : $fileInfo->getExtension(),\n                        'type' => $type,\n                        'modified' => $fileInfo->getMTime(),\n                        'size' => $count_children,\n                        'symlink' => false,\n                        'has-children' => $count_children > 0\n                    ];\n                }\n\n                // Fix for symlink\n                if ($payload['type'] === 'link') {\n                    $payload['symlink'] = true;\n                    $physical_path = $fileInfo->getRealPath();\n                    $payload['type'] = is_dir($physical_path) ? 'dir' : 'file';\n                }\n\n                // filter types\n                if ($filters['type']) {\n                    if (!in_array($payload['type'], $filter_type)) {\n                        continue;\n                    }\n                }\n\n                // Simple filter for name or extension\n                if (($filters['name'] && Utils::contains($payload['basename'], $filters['name'])) ||\n                    ($filters['extension'] && Utils::contains($payload['extension'], $filters['extension']))) {\n                    continue;\n                }\n\n                // Add children if any\n                if ($filePath === $extra && is_array($children)) {\n                    $payload['children'] = array_values($children);\n                }\n\n                $response[] = $payload;\n            }\n        } else {\n            $msg = 'PLUGIN_ADMIN.PAGE_ROUTE_NOT_FOUND';\n        }\n\n        // Sorting\n        $response = Utils::sortArrayByKey($response, $sortby, $order);\n\n        $temp_array = [];\n        foreach ($response as $index => $item) {\n            $temp_array[$item['type']][$index] = $item;\n        }\n\n        $sorted = Utils::sortArrayByArray($temp_array, $filter_type);\n        $response = Utils::arrayFlatten($sorted);\n\n        return [$status, $this->admin::translate($msg ?? 'PLUGIN_ADMIN.NO_ROUTE_PROVIDED'), $response, $path];\n    }\n\n    /**\n     * Get page media.\n     *\n     * @param PageInterface|null $page\n     * @return Media|null\n     */\n    public function getMedia(PageInterface $page = null)\n    {\n        $page = $page ?? $this->admin->page($this->route);\n        if (!$page) {\n            return null;\n        }\n\n        $this->uri = $this->uri ?? $this->grav['uri'];\n\n        $field = (string)$this->uri->post('field', '');\n        $order = $this->uri->post('order') ?: null;\n        if ($order && is_string($order)) {\n            $order = array_map('trim', explode(',', $order));\n        }\n\n        $blueprints = $page->blueprints();\n        $settings = $this->getMediaFieldSettings($blueprints, $field);\n        $path = $settings['destination'] ?? $page->path();\n\n        return $path ? new Media($path, $order) : null;\n    }\n\n    /**\n     * @param Data\\Blueprint|null $blueprint\n     * @param string $field\n     * @return array|null\n     */\n    protected function getMediaFieldSettings(?Data\\Blueprint $blueprint, string $field): ?array\n    {\n        $schema = $blueprint ? $blueprint->schema() : null;\n        if (!$schema || $field === '') {\n            return null;\n        }\n\n        $settings = is_object($schema) ? (array)$schema->getProperty($field) : null;\n        if (null === $settings) {\n            return null;\n        }\n\n        if (empty($settings['destination']) || \\in_array($settings['destination'], ['@self', 'self@', '@self@'], true)) {\n            unset($settings['destination']);\n        }\n\n        return $settings + ['accept' => '*', 'limit' => 1000];\n    }\n\n    /**\n     * @return string\n     */\n    protected function getDataType()\n    {\n        return trim(\"{$this->view}/{$this->admin->route}\", '/');\n    }\n\n    /**\n     * Gets the configuration data for a given view & post\n     *\n     * @param array $data\n     * @return object\n     */\n    protected function prepareData(array $data)\n    {\n        $type = $this->getDataType();\n\n        return $this->admin->data($type, $data);\n    }\n\n    /**\n     * Prepare a page to be stored: update its folder, name, template, header and content\n     *\n     * @param PageInterface          $page\n     * @param bool                   $clean_header\n     * @param string                 $languageCode\n     * @return void\n     */\n    protected function preparePage(PageInterface $page, $clean_header = false, $languageCode = ''): void\n    {\n        $input = (array)$this->data;\n\n        $this->admin::enablePages();\n\n        if (isset($input['folder']) && $input['folder'] !== $page->value('folder')) {\n            $order    = $page->value('order');\n            $ordering = $order ? sprintf('%02d.', $order) : '';\n            $page->folder($ordering . $input['folder']);\n        }\n\n        if (isset($input['name']) && !empty($input['name'])) {\n            $type = strtolower($input['name']);\n            $page->template($type);\n            $name = preg_replace('|.*/|', '', $type);\n\n            /** @var Language $language */\n            $language = $this->grav['language'];\n            if ($language->enabled()) {\n                $languageCode = $languageCode ?: $language->getLanguage();\n                if ($languageCode) {\n                    $isDefault = $languageCode === $language->getDefault();\n                    $includeLang = !$isDefault || (bool)$this->grav['config']->get('system.languages.include_default_lang_file_extension', true);\n                    if (!$includeLang) {\n                        // Check if the language specific file exists; use it if it does.\n                        $includeLang = file_exists(\"{$page->path()}/{$name}.{$languageCode}.md\");\n                    }\n                    // Keep existing .md file if we're updating default language, otherwise always append the language.\n                    if ($includeLang) {\n                        $name .= '.' . $languageCode;\n                    }\n                }\n            }\n\n            $name .= '.md';\n            $page->name($name);\n        }\n\n        // Special case for Expert mode: build the raw, unset content\n        if (isset($input['frontmatter'], $input['content'])) {\n            $page->raw(\"---\\n\" . (string)$input['frontmatter'] . \"\\n---\\n\" . (string)$input['content']);\n            unset($input['content']);\n        // Handle header normally\n        } elseif (isset($input['header'])) {\n            $header = $input['header'];\n\n            foreach ($header as $key => $value) {\n                if ($key === 'metadata' && is_array($header[$key])) {\n                    foreach ($header['metadata'] as $key2 => $value2) {\n                        if (isset($input['toggleable_header']['metadata'][$key2]) && !$input['toggleable_header']['metadata'][$key2]) {\n                            $header['metadata'][$key2] = '';\n                        }\n                    }\n                } elseif ($key === 'taxonomy' && is_array($header[$key])) {\n                    foreach ($header[$key] as $taxkey => $taxonomy) {\n                        if (is_array($taxonomy) && \\count($taxonomy) === 1 && trim($taxonomy[0]) === '') {\n                            unset($header[$key][$taxkey]);\n                        }\n                    }\n                } else {\n                    if (isset($input['toggleable_header'][$key]) && !$input['toggleable_header'][$key]) {\n                        $header[$key] = null;\n                    }\n                }\n            }\n            if ($clean_header) {\n                $header = Utils::arrayFilterRecursive($header, function ($k, $v) {\n                    return !(null === $v || $v === '');\n                });\n            }\n            $page->header((object)$header);\n            $page->frontmatter(Yaml::dump((array)$page->header(), 20));\n        }\n        // Fill content last because it also renders the output.\n        if (isset($input['content'])) {\n            $page->rawMarkdown((string)$input['content']);\n        }\n    }\n\n    /**\n     * Find the first available $item ('slug' | 'folder') for a page\n     * Used when copying a page, to determine the first available slot\n     *\n     * @param string        $item\n     * @param PageInterface $page\n     * @return string The first available slot\n     */\n    protected function findFirstAvailable($item, PageInterface $page)\n    {\n        $parent = $page->parent();\n        if (!$parent || !$parent->children()) {\n            return $page->{$item}();\n        }\n\n        $withoutPrefix = function ($string) {\n            $match = preg_split('/^[0-9]+\\./u', $string, 2, PREG_SPLIT_DELIM_CAPTURE);\n\n            return $match[1] ?? $match[0];\n        };\n\n        $withoutPostfix = function ($string) {\n            $match = preg_split('/-(\\d+)$/', $string, 2, PREG_SPLIT_DELIM_CAPTURE);\n\n            return $match[0];\n        };\n\n        /* $appendedNumber = function ($string) {\n            $match  = preg_split('/-(\\d+)$/', $string, 2, PREG_SPLIT_DELIM_CAPTURE);\n            $append = (isset($match[1]) ? (int)$match[1] + 1 : 2);\n\n            return $append;\n        };*/\n\n        $highest                   = 1;\n        $siblings                  = $parent->children();\n        $findCorrectAppendedNumber = function ($item, $page_item, $highest) use (\n            $siblings,\n            &$findCorrectAppendedNumber,\n            &$withoutPrefix\n        ) {\n            foreach ($siblings as $sibling) {\n                if ($withoutPrefix($sibling->{$item}()) == ($highest === 1 ? $page_item : $page_item . '-' . $highest)) {\n                    $highest = $findCorrectAppendedNumber($item, $page_item, $highest + 1);\n\n                    return $highest;\n                }\n            }\n\n            return $highest;\n        };\n\n        $base = $withoutPrefix($withoutPostfix($page->$item()));\n\n        $return  = $base;\n        $highest = $findCorrectAppendedNumber($item, $base, $highest);\n\n        if ($highest > 1) {\n            $return .= '-' . $highest;\n        }\n\n        return $return;\n    }\n\n    /**\n     * @param string $frontmatter\n     * @return bool\n     */\n    public function checkValidFrontmatter($frontmatter)\n    {\n        try {\n            Yaml::parse($frontmatter);\n        } catch (\\RuntimeException $e) {\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * The what should be the new filename when saving as a new language\n     *\n     * @param string $current_filename the current file name, including .md. Example: default.en.md\n     * @param string $language         The new language it will be saved as. Example: 'it' or 'en-GB'.\n     * @return string The new filename. Example: 'default.it'\n     */\n    public function determineFilenameIncludingLanguage($current_filename, $language)\n    {\n        $ext = '.md';\n        $filename = substr($current_filename, 0, -strlen($ext));\n        $languages_enabled = $this->grav['config']->get('system.languages.supported', []);\n\n        $parts = explode('.', trim($filename, '.'));\n        $lang = array_pop($parts);\n\n        if ($lang === $language) {\n            return $filename . $ext;\n        }\n\n        if (in_array($lang, $languages_enabled, true)) {\n            $filename = implode('.', $parts);\n        }\n\n        return $filename . '.' . $language . $ext;\n    }\n\n    /**\n     * Get the next available ordering number in a folder\n     *\n     * @param string $path\n     * @return string the correct order string to prepend\n     */\n    public static function getNextOrderInFolder($path)\n    {\n        $files = Folder::all($path, ['recursive' => false]);\n\n        $highestOrder = 0;\n        foreach ($files as $file) {\n            preg_match(PAGE_ORDER_PREFIX_REGEX, $file, $order);\n\n            if (isset($order[0])) {\n                $theOrder = (int)trim($order[0], '.');\n            } else {\n                $theOrder = 0;\n            }\n\n            if ($theOrder >= $highestOrder) {\n                $highestOrder = $theOrder;\n            }\n        }\n\n        $orderOfNewFolder = $highestOrder + 1;\n\n        if ($orderOfNewFolder < 10) {\n            $orderOfNewFolder = '0' . $orderOfNewFolder;\n        }\n\n        return $orderOfNewFolder;\n    }\n\n    /**\n     * Used in 3rd party editors (e.g. next-gen).\n     *\n     * @return ResponseInterface|false\n     */\n    protected function taskConvertUrls()\n    {\n        if (!$this->authorizeTask('access page', ['admin.pages', 'admin.pages.list', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $request = $this->getRequest();\n        $data = $request->getParsedBody();\n        $converted_links = [];\n        $converted_images = [];\n        $status = 'success';\n        $message = 'All links converted';\n\n        $data['route'] = isset($data['route']) ? base64_decode($data['route']) : null;\n        $data['data'] = json_decode($data['data'] ?? '{}', true);\n\n        // use the route if passed, else use current page in admin as reference\n        $page_route = $data['route'] ?? $this->admin->page(true);\n\n        /** @var PageInterface */\n        $pages = $this->admin::enablePages();\n        $page = $pages->find($page_route);\n\n        if (!$page) {\n            throw new RequestException($request,'Page Not Found', 404);\n        }\n\n\n        if (!isset($data['data'])) {\n            throw new RequestException($request, 'Bad Request', 400);\n        }\n\n        foreach ($data['data']['a'] ?? [] as $link) {\n            $converted_links[$link] = Excerpts::processLinkHtml($link, $page);\n        }\n\n        foreach ($data['data']['img'] ?? [] as $image) {\n            $converted_images[$image] = Excerpts::processImageHtml($image, $page);\n        }\n\n        $json = [\n            'status'  => $status,\n            'message' => $message,\n            'data' => ['links' => $converted_links, 'images' => $converted_images]\n        ];\n\n        return $this->createJsonResponse($json, 200);\n    }\n}\n", "<?php\n\ndeclare(strict_types=1);\n\nnamespace Grav\\Plugin\\Admin\\Controllers;\n\nuse Grav\\Common\\Debugger;\nuse Grav\\Common\\Grav;\nuse Grav\\Common\\Inflector;\nuse Grav\\Common\\Language\\Language;\nuse Grav\\Common\\Utils;\nuse Grav\\Framework\\Flex\\Interfaces\\FlexObjectInterface;\nuse Grav\\Framework\\Form\\Interfaces\\FormInterface;\nuse Grav\\Framework\\Psr7\\Response;\nuse Grav\\Framework\\RequestHandler\\Exception\\NotFoundException;\nuse Grav\\Framework\\RequestHandler\\Exception\\PageExpiredException;\nuse Grav\\Framework\\RequestHandler\\Exception\\RequestException;\nuse Grav\\Framework\\Route\\Route;\nuse Grav\\Framework\\Session\\SessionInterface;\nuse Psr\\Http\\Message\\ResponseInterface;\nuse Psr\\Http\\Message\\ServerRequestInterface;\nuse Psr\\Http\\Server\\RequestHandlerInterface;\nuse RocketTheme\\Toolbox\\Event\\Event;\nuse RocketTheme\\Toolbox\\Session\\Message;\n\nabstract class AbstractController implements RequestHandlerInterface\n{\n    /** @var string */\n    protected $nonce_action = 'admin-form';\n\n    /** @var string */\n    protected $nonce_name = 'admin-nonce';\n\n    /** @var ServerRequestInterface */\n    protected $request;\n\n    /** @var Grav */\n    protected $grav;\n\n    /** @var string */\n    protected $type;\n\n    /** @var string */\n    protected $key;\n\n    /**\n     * Handle request.\n     *\n     * Fires event: admin.[directory].[task|action].[command]\n     *\n     * @param ServerRequestInterface $request\n     * @return Response\n     */\n    public function handle(ServerRequestInterface $request): ResponseInterface\n    {\n        $attributes = $request->getAttributes();\n        $this->request = $request;\n        $this->grav = $attributes['grav'] ?? Grav::instance();\n        $this->type =  $attributes['type'] ?? null;\n        $this->key =  $attributes['key'] ?? null;\n\n        /** @var Route $route */\n        $route = $attributes['route'];\n        $post = $this->getPost();\n\n        if ($this->isFormSubmit()) {\n            $form = $this->getForm();\n            $this->nonce_name = $attributes['nonce_name'] ?? $form->getNonceName();\n            $this->nonce_action = $attributes['nonce_action'] ?? $form->getNonceAction();\n        }\n\n        try {\n            $task = $request->getAttribute('task') ?? $post['task'] ?? $route->getParam('task');\n            if ($task) {\n                if (empty($attributes['forwarded'])) {\n                    $this->checkNonce($task);\n                }\n                $type = 'task';\n                $command = $task;\n            } else {\n                $type = 'action';\n                $command = $request->getAttribute('action') ?? $post['action'] ?? $route->getParam('action') ?? 'display';\n            }\n            $command = strtolower($command);\n\n            $event = new Event(\n                [\n                    'controller' => $this,\n                    'response' => null\n                ]\n            );\n\n            $this->grav->fireEvent(\"admin.{$this->type}.{$type}.{$command}\", $event);\n\n            $response = $event['response'];\n            if (!$response) {\n                /** @var Inflector $inflector */\n                $inflector = $this->grav['inflector'];\n                $method = $type . $inflector::camelize($command);\n                if ($method && method_exists($this, $method)) {\n                    $response = $this->{$method}($request);\n                } else {\n                    throw new NotFoundException($request);\n                }\n            }\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $response = $this->createErrorResponse($e);\n        }\n\n        if ($response instanceof Response) {\n            return $response;\n        }\n\n        return $this->createJsonResponse($response);\n    }\n\n    /**\n     * Get request.\n     *\n     * @return ServerRequestInterface\n     */\n    public function getRequest(): ServerRequestInterface\n    {\n        return $this->request;\n    }\n\n    /**\n     * @param string|null $name\n     * @param mixed $default\n     * @return mixed\n     */\n    public function getPost(string $name = null, $default = null)\n    {\n        $body = $this->request->getParsedBody();\n\n        if ($name) {\n            return $body[$name] ?? $default;\n        }\n\n        return $body;\n    }\n\n    /**\n     * Check if a form has been submitted.\n     *\n     * @return bool\n     */\n    public function isFormSubmit(): bool\n    {\n        return (bool)$this->getPost('__form-name__');\n    }\n\n    /**\n     * Get form.\n     *\n     * @param string|null $type\n     * @return FormInterface\n     */\n    public function getForm(string $type = null): FormInterface\n    {\n        $object = $this->getObject();\n        if (!$object) {\n            throw new \\RuntimeException('Not Found', 404);\n        }\n\n        $formName = $this->getPost('__form-name__');\n        $uniqueId = $this->getPost('__unique_form_id__') ?: $formName;\n\n        $form = $object->getForm($type ?? 'edit');\n        if ($uniqueId) {\n            $form->setUniqueId($uniqueId);\n        }\n\n        return $form;\n    }\n\n    /**\n     * @return FlexObjectInterface\n     */\n    abstract public function getObject();\n\n    /**\n     * Get Grav instance.\n     *\n     * @return Grav\n     */\n    public function getGrav(): Grav\n    {\n        return $this->grav;\n    }\n\n    /**\n     * Get session.\n     *\n     * @return SessionInterface\n     */\n    public function getSession(): SessionInterface\n    {\n        return $this->getGrav()['session'];\n    }\n\n    /**\n     * Display the current admin page.\n     *\n     * @return Response\n     */\n    public function createDisplayResponse(): ResponseInterface\n    {\n        return new Response(418);\n    }\n\n    /**\n     * Create custom HTML response.\n     *\n     * @param string $content\n     * @param int $code\n     * @return Response\n     */\n    public function createHtmlResponse(string $content, int $code = null): ResponseInterface\n    {\n        return new Response($code ?: 200, [], $content);\n    }\n\n    /**\n     * Create JSON response.\n     *\n     * @param array $content\n     * @return Response\n     */\n    public function createJsonResponse(array $content): ResponseInterface\n    {\n        $code = $content['code'] ?? 200;\n        if ($code >= 301 && $code <= 307) {\n            $code = 200;\n        }\n\n        return new Response($code, ['Content-Type' => 'application/json'], json_encode($content));\n    }\n\n    /**\n     * Create redirect response.\n     *\n     * @param string $url\n     * @param int $code\n     * @return Response\n     */\n    public function createRedirectResponse(string $url, int $code = null): ResponseInterface\n    {\n        if (null === $code || $code < 301 || $code > 307) {\n            $code = $this->grav['config']->get('system.pages.redirect_default_code', 302);\n        }\n\n        $accept = $this->getAccept(['application/json', 'text/html']);\n\n        if ($accept === 'application/json') {\n            return $this->createJsonResponse(['code' => $code, 'status' => 'redirect', 'redirect' => $url]);\n        }\n\n        return new Response($code, ['Location' => $url]);\n    }\n\n    /**\n     * Create error response.\n     *\n     * @param  \\Exception $exception\n     * @return Response\n     */\n    public function createErrorResponse(\\Exception $exception): ResponseInterface\n    {\n        $validCodes = [\n            400, 401, 402, 403, 404, 405, 406, 407, 408, 409, 410, 411, 412, 413, 414, 415, 416, 417, 418,\n            422, 423, 424, 425, 426, 428, 429, 431, 451, 500, 501, 502, 503, 504, 505, 506, 507, 508, 511\n        ];\n\n        if ($exception instanceof RequestException) {\n            $code = $exception->getHttpCode();\n            $reason = $exception->getHttpReason();\n        } else {\n            $code = $exception->getCode();\n            $reason = null;\n        }\n\n        if (!in_array($code, $validCodes, true)) {\n            $code = 500;\n        }\n\n        $message = $exception->getMessage();\n        $response = [\n            'code' => $code,\n            'status' => 'error',\n            'message' => $message\n        ];\n\n        $accept = $this->getAccept(['application/json', 'text/html']);\n\n        if ($accept === 'text/html') {\n            $method = $this->getRequest()->getMethod();\n\n            // On POST etc, redirect back to the previous page.\n            if ($method !== 'GET' && $method !== 'HEAD') {\n                $this->setMessage($message, 'error');\n                $referer = $this->request->getHeaderLine('Referer');\n                return $this->createRedirectResponse($referer, 303);\n            }\n\n            // TODO: improve error page\n            return $this->createHtmlResponse($response['message']);\n        }\n\n        return new Response($code, ['Content-Type' => 'application/json'], json_encode($response), '1.1', $reason);\n    }\n\n    /**\n     * Translate a string.\n     *\n     * @param  string $string\n     * @return string\n     */\n    public function translate(string $string): string\n    {\n        /** @var Language $language */\n        $language = $this->grav['language'];\n\n        return $language->translate($string);\n    }\n\n    /**\n     * Set message to be shown in the admin.\n     *\n     * @param  string $message\n     * @param  string $type\n     * @return $this\n     */\n    public function setMessage($message, $type = 'info')\n    {\n        /** @var Message $messages */\n        $messages = $this->grav['messages'];\n        $messages->add($message, $type);\n\n        return $this;\n    }\n\n    /**\n     * Check if request nonce is valid.\n     *\n     * @param  string $task\n     * @throws PageExpiredException  If nonce is not valid.\n     */\n    protected function checkNonce(string $task): void\n    {\n        $nonce = null;\n\n        if (\\in_array(strtoupper($this->request->getMethod()), ['POST', 'PUT', 'PATCH', 'DELETE'])) {\n            $nonce = $this->getPost($this->nonce_name);\n        }\n\n        if (!$nonce) {\n            $nonce = $this->grav['uri']->param($this->nonce_name);\n        }\n\n        if (!$nonce) {\n            $nonce = $this->grav['uri']->query($this->nonce_name);\n        }\n\n        if (!$nonce || !Utils::verifyNonce($nonce, $this->nonce_action)) {\n            throw new PageExpiredException($this->request);\n        }\n    }\n\n    /**\n     * Return the best matching mime type for the request.\n     *\n     * @param  string[] $compare\n     * @return string|null\n     */\n    protected function getAccept(array $compare): ?string\n    {\n        $accepted = [];\n        foreach ($this->request->getHeader('Accept') as $accept) {\n            foreach (explode(',', $accept) as $item) {\n                if (!$item) {\n                    continue;\n                }\n\n                $split = explode(';q=', $item);\n                $mime = array_shift($split);\n                $priority = array_shift($split) ?? 1.0;\n\n                $accepted[$mime] = $priority;\n            }\n        }\n\n        arsort($accepted);\n\n        // TODO: add support for image/* etc\n        $list = array_intersect($compare, array_keys($accepted));\n        if (!$list && (isset($accepted['*/*']) || isset($accepted['*']))) {\n            return reset($compare) ?: null;\n        }\n\n        return reset($list) ?: null;\n    }\n}\n"], "fixing_code": ["# v1.10.25\n## mm/dd/2021\n\n3. [](#bugfix)\n   * Fixed unescaped messages in JSON responses\n\n# v1.10.24\n## 10/26/2021\n\n1. [](#new)\n   * Require **Grav 1.7.24**\n2. [](#improved)\n   * Use new `Http\\Response` rather than deprecated `GPM\\Response`\n3. [](#bugfix)\n   * Fixed an issue with invalid HTML throwing errors on HTML security scanning\n   * Clear cache when installing plugins\n\n# v1.10.23\n## 09/29/2021\n\n1. [](#new)\n   * Updated SCSS compiler to v1.8\n2. [](#improved)\n   * Updated with latest language strings from Crowdin.com\n3. [](#bugfix)\n   * Fixed images from plugins/themes disappearing when saving twice\n\n# v1.10.22\n## 09/16/2021\n\n1. [](#new)\n    * Updated SCSS compiler to v1.7\n\n# v1.10.21\n## 09/14/2021\n\n1. [](#new)\n    * Require **Grav 1.7.21**\n2. [](#improved)\n    * Added a note about UTC times in scheduler AT syntax help\n    * Now using a monospaced text-based scheduler AT field in scheduler for simplicity\n    * Improved `Admin:data()` and `Admin::getConfigurationData()` to be more strict\n3. [](#bugfix)\n    * Fixed configuration save location to point to existing config folder [#2176](https://github.com/getgrav/grav-plugin-admin/issues/2176)\n\n# v1.10.20\n## 09/01/2021\n\n1. [](#bugfix)\n    * Fixed regression `Argument 4 passed to Grav\\Plugin\\Form\\TwigExtension::prepareFormField() must be of the type array` [#2177](https://github.com/getgrav/grav-plugin-admin/issues/2177)\n    * Fixed `X-Frame-Options` to be `DENY` in all admin pages to prevent a clickjacking attack\n\n# v1.10.19\n## 08/31/2021\n\n1. [](#new)\n    * Require **Grav 1.7.19** and **Form 5.1.0** and **Login 3.5.0**\n    * Updated SCSS compiler to v1.6\n2. [](#improved)\n    * Updated forms and nested fields to use new form logic\n    * Admin form now use layout `admin`, meaning you can create admin specific field templates by `forms/fields/myfield/admin-field.html.twig`\n    * Stop using `|tu` filter, Grav already has the same logic in `|t` for admin\n    * Remove unneeded escapes\n    * Allow removal of plugin when disabled [#2167](https://github.com/getgrav/grav-plugin-admin/issues/2167)\n3. [](#bugfix)\n    * Fixed missing values in `fieldset` form field\n\n# v1.10.18\n## 07/19/2021\n\n1. [](#improved)\n    * Add logic to allow fieldset form field inside a list field [#2159](https://github.com/getgrav/grav-plugin-admin/pull/2159)\n\n# v1.10.17\n## 06/15/2021\n\n1. [](#improved)\n    * Added timestamp as title in logs date [#2141](https://github.com/getgrav/grav-plugin-admin/issues/2141)\n    * Use `base64_encode` filter rather than function\n    * Composer update\n1. [](#bugfix)\n    * Fixed missing `Remove Theme` button when the theme is inactive\n    * Update taskGetChildTypes() to use Flex Pages (works without the plugin) [#2087](https://github.com/getgrav/grav-plugin-admin/issues/2087)\n\n# v1.10.16\n## 06/02/2021\n\n1. [](#bugfix)\n    * Fixed issue with some elements overflowing closed list items [#2146](https://github.com/getgrav/grav-plugin-admin/issues/2146)\n    * Fixed configuration not fully updating on save [#2149](https://github.com/getgrav/grav-plugin-admin/issues/2149)\n    * Fixed display issue with \"+ Add Page\" and picking a different route [#2136](https://github.com/getgrav/grav-plugin-admin/issues/2136), [#2145](https://github.com/getgrav/grav-plugin-admin/issues/2145)\n    * Treat WebP as image when inserting / drag & dropping [#2150](https://github.com/getgrav/grav-plugin-admin/issues/2150)\n\n# v1.10.15\n## 05/19/2021\n\n1. [](#new)\n    * Updated SCSS compiler to v1.5\n1. [](#improved)\n    * Updated node modules dev dependencies\n    * Package.json scripts cleanup\n    * Recompiled JS for production\n    * Use `base645_encode` filter rather than function\n    * Editor: Do not assume images URLs are going to be `http://` (wrong assumption plus not SSL) [#2127](https://github.com/getgrav/grav-plugin-admin/issues/2127)\n    * Improved Theme Activation + Plugin Enabled logic to ensure configuration is not displayed unless activation/enabled state. Fixes [#2140](https://github.com/getgrav/grav-plugin-admin/issues/2140)\n1. [](#bugfix)\n    * Fixed issue with slugify where single curly quotes in titles would translate to straight single quote [#2101](https://github.com/getgrav/grav-plugin-admin/issues/2101)\n    * Fix z-index issue with fullscreeen editor (and toolips) [#2143](https://github.com/getgrav/grav-plugin-admin/issues/2143)\n\n# v1.10.14\n## 04/29/2021\n\n1. [](#improved)\n    * Added a `min_height:` option for list field\n1. [](#bugfix)\n    * Fixed z-index issue for tooltips in sidebar\n    * Fixed custom files being overridden during theme update [#2135](https://github.com/getgrav/grav-plugin-admin/issues/2135)\n\n# v1.10.13\n## 04/23/2021\n\n1. [](#new)\n    * Added refresh action button for Folder to ease the regeneration of the slug based on the title. Available also as API entry `Grav.default.Forms.Fields.FolderField.Regenerate()` [#1738](https://github.com/getgrav/grav-plugin-admin/issues/1738)\n1. [](#improved)\n    * Removed sourcemaps references from fork-awesome.min.css [#2122](https://github.com/getgrav/grav-plugin-admin/issues/2122)\n    * Support native spell checkers in CodeMirror editor [#1266](https://github.com/getgrav/grav-plugin-admin/issues/1266)\n    * Added new 'Content Highlight' color to presets\n    * Copying Pages now prompts a dedicated modal that allows for picking title, folder name, parent location, page template and visibility [#1738](https://github.com/getgrav/grav-plugin-admin/issues/1738)\n    * Updated with latest language translations from Crowdin.com\n1. [](#bugfix)\n    * Moved preset CSS compile to earlier in the process to ensure compilation happens in time.\n    * Prevent Save actions from Flex Objects to trigger the unsaved unload notice [#2125](https://github.com/getgrav/grav-plugin-admin/issues/2125)\n    * Fixed audit vulnerabilities in module dependencies and house cleanup [#2096](https://github.com/getgrav/grav-plugin-admin/issues/2096)\n    * Fixed issue preventing Drag & Drop of media files while in Expert Mode [#1927](https://github.com/getgrav/grav-plugin-admin/issues/1927)\n    * Fixed broken link colors in `preset.css` which was causing issues with tabs and dropdowns\n    * Fixed permissions for page related tasks and actions\n    * Fixed permission check for configuration save [#2130](https://github.com/getgrav/grav-plugin-admin/issues/2130)\n    * Fixed missing/wrong page categories and tags when multi-language support is enabled [#2107](https://github.com/getgrav/grav-plugin-admin/issues/2107)\n\n# v1.10.12\n## 04/15/2021\n\n1. [](#bugfix)\n    * Regression: Fixed broken plugin/theme installer in admin\n    * Fixed error reporting for AJAX tasks if user has no permissions\n    * Fixed missing slash in password reset URL [#2119](https://github.com/getgrav/grav-plugin-admin/issues/2119)\n\n# v1.10.11\n## 04/13/2021\n\n1. [](#bugfix)\n    * **IMPORTANT** Fixed security vulnerability that allows installation of plugins with minimal admin privileges [GHSA-wg37-cf5x-55hq](https://github.com/getgrav/grav-plugin-admin/security/advisories/GHSA-wg37-cf5x-55hq)\n    * Fixed `You have been logged out` message when entering to 2FA authentication due to `/admin/task:getNotifications` AJAX call\n    * Fixed broken 2FA login when site is not configured to use Flex Users [#2109](https://github.com/getgrav/grav-plugin-admin/issues/2109)\n    * Fixed error message when user clicks logout link after the session has been expired\n\n# v1.10.10\n## 04/07/2021\n\n1. [](#bugfix)\n    * Fixed missing `admin-preset.css` in multisite environments\n    * Regression: Fixed broken 2FA form [#2109](https://github.com/getgrav/grav-plugin-admin/issues/2109)\n\n# v1.10.9\n## 04/06/2021\n\n1. [](#new)\n    * Requires **Grav 1.7.10**\n1. [](#improved)\n    * Better isolate admin to prevent session related vulnerabilities\n    * Removed support for custom login redirects for improved security\n    * Shorten forgot password link lifetime from 7 days to 1 hour\n    * Updated with latest language translations from Crowdin.com\n1. [](#bugfix)\n    * Fixed issue where Adding a new page and canceling from within Editing would alter the Parent location of the edited page [#2067](https://github.com/getgrav/grav-plugin-admin/issues/2067)\n    * Fixed and enhanced Range field to be Lists compatible [#2062](https://github.com/getgrav/grav-plugin-admin/issues/2062)\n    * Fixed ERR_TOO_MANY_REDIRECTS with HTTPS = 'On' [#2100](https://github.com/getgrav/grav-plugin-admin/issues/2100)\n    * Prevent expert editing mode from anyone else than super users [#2094](https://github.com/getgrav/grav-plugin-admin/issues/2094)\n    * Fixed login related pages being accessible from admin when user has logged in\n    * Fixed admin user creation and password reset allowing unsafe passwords\n    * Fixed missing validation when registering the first admin user\n    * Fixed reset password email not to have session specific token in it\n    * Fixed admin controller running before setting `$grav['page']`\n\n# v1.10.8\n## 03/19/2021\n\n1. [](#improved)\n    * Include alt text and title for images added to the editor [#2098](https://github.com/getgrav/grav-plugin-admin/issues/2098)\n1. [](#bugfix)\n    * Fixed issue replacing `wildcard` field names in flex collections [#2092](https://github.com/getgrav/grav-plugin-admin/pull/2092)\n    * Fixed legacy Pages having old `modular` reference instead of `module` [#2093](https://github.com/getgrav/grav-plugin-admin/issues/2093)\n    * Fixed issue where Add New modal would close if selecting an item outside of the modal window. It is now necessary go through the Cancel button and clicking the overlay won't trigger the closing of the modal [#2089](https://github.com/getgrav/grav-plugin-admin/issues/2089), [#2065](https://github.com/getgrav/grav-plugin-admin/issues/2065)\n\n# v1.10.7\n## 03/17/2021\n\n1. [](#improved)\n    * Force height of Flex pages admin to fit available space\n    * Updated languages from Crowdin.com\n    * Better field type definitions for file, pagemedia, filepicker and pagemediafield\n1. [](#bugfix)\n    * Fixed error when checking missing log file [#2088](https://github.com/getgrav/grav-plugin-admin/issues/2088)\n\n# v1.10.6\n## 02/23/2021\n\n1. [](#new)\n    * Vastly improved support for RTL languages [#2078](https://github.com/getgrav/grav-plugin-admin/pull/2078)\n1. [](#improved)\n    * Flex pages admin better uses available space [#2075](https://github.com/getgrav/grav/issues/2075)\n1. [](#bugfix)\n    * Regression: Fixed enabling/disabling plugin or theme corrupting configuration\n    * Fixed unnecessary closing bracket causing JS error [#2079](https://github.com/getgrav/grav-plugin-admin/issues/2079)\n    * Fixed wrong language in Admin Tools [#2077](https://github.com/getgrav/grav-plugin-admin/issues/2077)\n\n# v1.10.5\n## 02/18/2021\n\n1. [](#bugfix)\n    * Regression: Fixed fatal error in admin if POST request has `data` in it [#2074](https://github.com/getgrav/grav-plugin-admin/issues/2074)\n    * Fixed Admin creating empty `user/config/info.yaml` file (the file can be safely removed, it is not in use)\n    * Fixed ACL for users with mixed case usernames [#2073](https://github.com/getgrav/grav-plugin-admin/issues/2073)\n\n# v1.10.4\n## 02/17/2021\n\n1. [](#new)\n    * Added support to include new page creation modals in other pages by using `form_action` twig variable [#2024](https://github.com/getgrav/grav-plugin-admin/pull/2024)\n    * Updated all languages from [Crowdin](https://crowdin.com/project/grav-admin) - Please update any translations here\n1. [](#improved)\n    * Removed `noscript` template, because 2021...\n    * List field: added new `placement` property to decide wether to add new items at the top, bottom or based on the *position* of the clicked button [#2055](https://github.com/getgrav/grav-plugin-admin/pull/2055)\n    * Ensure admin default CSS styles load **first**, and presets loads **last**\n    * Tweaked handling of uploaded files [#1429](https://github.com/getgrav/grav-plugin-admin/issues/1429)\n    * Provide media object and filename in `onAdminAfterDelMedia` event [#1905](https://github.com/getgrav/grav-plugin-admin/pull/1905)\n1. [](#bugfix)\n    * Fixed case-sensitive `accept` in `filepicker` field\n    * Fixed HTML Entities in titles [#2028](https://github.com/getgrav/grav-plugin-admin/issues/2028)\n    * Fixed deleting list field options completely, didn't save changes [#2056](https://github.com/getgrav/grav-plugin-admin/issues/2056)\n    * Fixed `onAdminAfterAddMedia` and `onAdminAfterDelMedia` events always pointing to the home page\n    * Fixed ACL for Configuration tabs [#771](https://github.com/getgrav/grav-plugin-admin/issues/771)\n    * Fixed changelog button showing up in Info page even if user cannot access it\n    * Fixed toggleable checkboxes being unchecked in fieldset columns [#2063](https://github.com/getgrav/grav-plugin-admin/issues/2063)\n    * Fixed issue with max backups of zero [#2070](https://github.com/getgrav/grav-plugin-admin/issues/2070)\n\n# v1.10.3\n## 02/01/2021\n\n1. [](#new)\n    * Requires **Grav 1.7.4** (SemVer library moved to Grav)\n    * Added back special fonts (including Gantry)\n2. [](#bugfix)\n    * Fixed field type `range` not taking into account legitimate `0` values\n    * Fixed `Call to a member function trackHit() on null` [#2049](https://github.com/getgrav/grav-plugin-admin/issues/2049)\n\n# v1.10.2\n## 01/21/2021\n\n2. [](#bugfix)\n    * Fixed admin style compilation failing to save CSS if assets folder does not exist\n\n# v1.10.1\n## 01/20/2021\n\n1. [](#improved)\n    * Added `watch.sh` for compiling SCSS with native sass compiler\n2. [](#bugfix)\n    * Fixed issue with overlapping sidebar when using fullscreen editor [#2022](https://github.com/getgrav/grav-plugin-admin/issues/2022)\n\n# v1.10.0\n## 01/19/2021\n\n1. [](#new)\n    * Requires **Grav 1.7 and PHP 7.3.6**\n    * Read about this release in the [Grav 1.7 Released](https://getgrav.org/blog/grav-1.7-released) blog post\n    * Read the full list of changes in the [Changelog on GitHub](https://github.com/getgrav/grav-plugin-admin/blob/1.10.0/CHANGELOG.md)\n    * Please read [Grav 1.7 Upgrade Guide](https://learn.getgrav.org/17/advanced/grav-development/grav-17-upgrade-guide) before upgrading!\n1. [](#improved)\n    * Various notifications improvements\n1. [](#bugfix)\n    * Fixed missed highlight on the selected page in Parents field\n    * Fixed notifications that would not be remembered as hidden\n    * Fixed taxonomy field not listing existing options in Flex Pages\n    * Fixed taxonomy field not working outside pages\n    * Fixed fatal error when moving a page using the old implementation [#2019](https://github.com/getgrav/grav-plugin-admin/issues/2019)\n    * Fixed evaluating default value in `hidden` field (thanks @NicoHood)\n\n# v1.10.0-rc.20\n## 12/14/2020\n\n1. [](#improved)\n    * Cookies now explicitly set `SameSite` to `Lax` unless otherwise specified [#1998](https://github.com/getgrav/grav-plugin-admin/issues/1998)\n    * Exposed **Cookies** class (`Grav.default.Utils.Cookies`) for developers that need it in Admin.\n1. [](#bugfix)\n    * Fixed Plugins references in Themes details page.\n    * Fixed issue preventing purchase of Themes within Admin and redirecting instead.\n    * Regression: Values inside Fieldset do not display [#1995](https://github.com/getgrav/grav-plugin-admin/issues/1995)\n\n# v1.10.0-rc.19\n## 12/02/2020\n\n1. [](#improved)\n    * Just keeping sync with Grav rc.19\n\n# v1.10.0-rc.18\n## 12/02/2020\n\n1. [](#new)\n    * Retired \"Secure Delete\" and \"Warn on page delete\". You are now always warned and asked to confirm a deletion.\n1. [](#improved)\n    * Auto-link a plugin/theme license in details if it starts with `http`\n    * Allow to fallback to `docs:` instead of `readme:`\n    * Forward a `sid` to GPM when downloading a premium package\n    * Better support for array field key/value when either key or value is stored empty [#1972](https://github.com/getgrav/grav-plugin-admin/issues/1972)\n    * Remember the open state of the sidebar [#1973](https://github.com/getgrav/grav-plugin-admin/issues/1973)\n    * Upgraded node dependencies to latest version. Improved speed of JS compilation.\n    * Added modal to confirm updating Grav as well as cool down counter before enabling Update button [#1257](https://github.com/getgrav/grav-plugin-admin/issues/1257)\n    * Better handling of offline/intranet mode when the repository index is missing. Faster admin. [#1916](https://github.com/getgrav/grav-plugin-admin/issues/1916)\n    * Statistics is now Page View Statistics [#1885](https://github.com/getgrav/grav-plugin-admin/issues/1885)\n    * It is now possible to use regex as values for \"Hide page types in Admin\" and \"Hide modular page types in Admin\" settings [#1828](https://github.com/getgrav/grav-plugin-admin/issues/1828)\n    * Default to `disabled` state for all cron-jobs\n1. [](#bugfix)\n    * Fixed Safari issue with new ACL picker field [#1955](https://github.com/getgrav/grav-plugin-admin/issues/1955)\n    * Stop propagation of ACL add button in ACL picker [flex-objects#83](https://github.com/trilbymedia/grav-plugin-flex-objects/issues/83)\n    * Fixed missing special groups `authors` and `defaults` for pages\n    * Fixed Page Move action and selection highlight in Parents selector modal [flex-objects#80](https://github.com/trilbymedia/grav-plugin-flex-objects/issues/80)\n    * Fixed folder auto-naming in Add Module [#1937](https://github.com/getgrav/grav-plugin-admin/issues/1937)\n    * Fixed remodal issue triggering close when selecting a dropdown item ending outside of scope [#1682](https://github.com/getgrav/grav-plugin-admin/issues/1682)\n    * Reworked how collapsed lists work so the tooltip is not cut off [#1928](https://github.com/getgrav/grav-plugin-admin/issues/1928)\n    * Fixed KeepAlive issue where too large of a session value would fire the keep alive immediately [#1860](https://github.com/getgrav/grav-plugin-admin/issues/1860)\n    * Fixed stringable objects breaking the inputs\n    * Fixed filepicker, pagemediaselect fields with `multiple: true` and `array: true` [#1580](https://github.com/getgrav/grav-plugin-admin/issues/1580)\n\n# v1.10.0-rc.17\n## 10/07/2020\n\n1. [](#new)\n    * Support premium themes\n1. [](#improved)\n    * Improved some error messages for better readability\n    * Strip tags from browser title\n1. [](#bugfix)\n    * More multi-site routing fixes\n    * Fixed issue that would force a page reload when failing to install/update a plugin or theme.\n    * Fixed proxy/browser caching issues in admin pages\n\n# v1.10.0-rc.16\n## 09/01/2020\n\n1. [](#improved)\n    * Made all the `onAdmin*` CRUD events to pass `object` (and backwards compatible `page`) to make them easier to use\n    * Updated vendor libraries including `SCSSPHP` to v1.2\n1. [](#bugfix)\n    * Fixed issue with File field being used in Theme/Plugins\n    * Fixed bad redirection after successful admin login in subdirectory multisite [#1487](https://github.com/getgrav/grav-plugin-admin/issues/1487)\n\n# v1.10.0-rc.15\n## 07/22/2020\n\n1. [](#bugfix)\n    * Disabled the EXIF library for Dropzone for fixing the orientation as it was getting applied twice [#1923](https://github.com/getgrav/grav-plugin-admin/issues/1923)\n    * Forked Dropzone fo fix issue with Resize + Exif orientation [#1923](https://github.com/getgrav/grav-plugin-admin/issues/1923)\n    * Fixed URI encode for the preview of images names\n\n# v1.10.0-rc.14\n## 07/09/2020\n\n1. [](#improved)\n    * Completely removed old Google font support for upgrade compatibility\n1. [](#bugfix)\n    * Fixed bad `use` reference to `UserObject`\n\n# v1.10.0-rc.13\n## 07/01/2020\n\n1. [](#improved)\n    * Improved color picker field\n    * Trim login route for safety\n    * Composer update to grab latest vendor libs\n\n# v1.10.0-rc.12\n## 06/08/2020\n\n1. [](#new)\n    * Added ability to set a preferred markdown editor in user profile\n    * Added new `onAdminListContentEditors` event to add a custom editor to the list of available\n1. [](#bugfix)\n    * Fixed issue deleting file from a plugin's configuration\n    * Use `Pages::find()` instead of `Pages::dispatch()` as we do not want to redirect out of admin\n    * Fixed broken `parent` field when using the old pages\n    * Fixed broken `file` field preview when using streams in the path\n\n# v1.10.0-rc.11\n## 05/14/2020\n\n1. [](#new)\n    * Major enhancements to \"White Label\" functionality including ability to export/import presets\n    * New horizontal scroller for theme presets\n    * Codemirror Fontsize / Preset / Font preference options\n1. [](#improved)\n    * Fixed lots of styling issues related to \"White Label\" presets\n    * Changed out \"One Light\" theme for new \"Firewatch Light\" theme\n    * New scrolling system based on `SimpleBar` + native CSS scrollbar styling\n\n# v1.10.0-rc.10\n## 04/30/2020\n\n1. [](#new)\n    * Addd new `taskConvertUrls` method for use with 3rd party editors\n\n# v1.10.0-rc.9\n## 04/27/2020\n\n1. [](#new)\n    * Added new \"White Label\" functionality to customize admin colors + logos\n    * Added badge count for children in the Parents field\n1. [](#improved)\n    * Added markdown support to `text` in `section` field\n1. [](#bugfix)\n    * Prevent loading Pages in Parents field if they don't have children\n    * Fixed custom folder in `mediapicker` field not working with streams\n    * Fixed language redirect adding extra language prefix in Flex\n    * Fixed `Invalid input in \"Parent\"` when saving page in raw mode [#1869](https://github.com/getgrav/grav-plugin-admin/issues/1869)\n\n# v1.10.0-rc.8\n## 03/19/2020\n\n1. [](#new)\n    * Added `has-children` flag in parent field data response\n    * Added `RESET` en lang string\n1. [](#bugfix)\n    * Fixed parent field not working with regular pages\n\n# v1.10.0-rc.7\n## 03/05/2020\n\n1. [](#new)\n    * Enable admin cache by default (for existing sites, check `Plugins > Admin Panel > Enable Admin Caching`)\n1. [](#improved)\n    * Removed old `scss.sh` and `watch.sh` scripts, use `gulp watch-css`\n    * Added keysOnly parameter to `AdminPlugin::pagesTypes()` and `AdminPlugin::pagesModularTypes()` methods\n    * Added ignore parameter to `Admin::types()` and `Admin::modularTypes()` methods\n    * Improved configuration fields for hiding page types in Admin\n1. [](#bugfix)\n    * Fixed minor UI padding in Flex pages [#1825](https://github.com/getgrav/grav-plugin-admin/issues/1825)\n    * Fixed `column` and `section` fields loosing user entered value when form submit fails\n    * Fixed `order` field not working with a new Flex Page\n\n# v1.10.0-rc.6\n## 02/11/2020\n\n1. [](#new)\n    * Pass phpstan level 1 tests\n    * Updated semver library to v1.5\n    * Require flex-objects plugin\n1. [](#improved)\n    * Added some debugging messages (turned off by default)\n\n# v1.10.0-rc.5\n## 02/03/2020\n\n1. [](#new)\n    * No changes, just keeping things in sync with Grav RC version\n\n# v1.10.0-rc.4\n## 02/03/2020\n\n1. [](#new)\n    * Added message to dashboard to install Flex Objects plugin if it is missing\n    * Updated `permissions` field to use new `$grav['permissions']`\n    * DEPRECATED `onAdminRegisterPermissions` event, use `PermissionsRegisterEvent::class` event instead\n    * DEPRECATED `Admin::setPermissions()` and `Admin::addPermissions()`, use `PermissionsRegisterEvent::class` event instead\n    * DEPRECATED `Admin::getPermissions()`, use `$grav['permissions']->getInstances()` instead\n1. [](#improved)\n    * Added `field.show_label` and `field.label` display logic from frontend forms\n1. [](#bugfix)\n    * Fixed user profile when using `Flex Users` only in admin\n    * Fixed saving data with empty field, default value (from config, plugin, theme) was used instead\n    * Fixed JS bug is using empty Grav URI param key\n    * Fixed bug in toggleable field being disabled with empty value (`''` `0`, `false`, `[]`...)\n    * Fixed `admin_route()` twig function to work properly with Grav 1.7.0-rc.4, which fixes `Route` base\n    * Fixed misleading 'Show sensitive data' configuration option wording [#1818](https://github.com/getgrav/grav-plugin-admin/issues/1818)\n\n# v1.10.0-rc.3\n## 01/02/2020\n\n1. [](#new)\n    * Added ability to display **Changelogs** for `Grav`, `Plugins` and `Themes`\n    * Added raw root page support for `Flex Pages`\n\n# v1.10.0-rc.2\n## 12/04/2019\n\n1. [](#new)\n    * Added support for hiding parts of admin by `Deny` permissions (`Flex Users` only)\n    * Optimized `parent` field for Flex Pages\n1. [](#improved)\n    * Improved `permissions` field to add support for displaying calculated permissions\n    * Grav 1.7: Updated deprecated `$page->modular()` method calls to `$page->isModule()`\n    * Output the current process user name in Scheduler instructions\n    * Translations: rename MODULAR to MODULE everywhere\n1. [](#bugfix)\n    * Fixed `permissions` field with nested permissions\n    * Fixed Save Shortcut (CTRL + S / CMD + S) not working with new Flex Pages [#1787](https://github.com/getgrav/grav-plugin-admin/issues/1787)\n\n# v1.10.0-rc.1\n## 11/06/2019\n\n1. [](#new)\n    * Added a new `onAdminLogFiles()` event for 3rd party plugins to register log files for log viewer [#1765](https://github.com/getgrav/grav-plugin-admin/issues/1765)\n1. [](#improved)\n    * Improved delete button UI [#1769](https://github.com/getgrav/grav-plugin-admin/issues/1769)\n    * Ability to configure display of 3rd party dashboard widgets [#1766](https://github.com/getgrav/grav-plugin-admin/issues/1766)\n1. [](#bugfix)\n    * Fixed administrator user creation when `Flex Users` is enabled\n    * Fixed minor button alignment in FF [#1760](https://github.com/getgrav/grav-plugin-admin/issues/1760)\n\n# v1.10.0-beta.10\n## 10/03/2019\n\n1. [](#bugfix)\n    * Regression: Fixed language assignments for the pages without set language\n\n# v1.10.0-beta.9\n## 09/26/2019\n\n1. [](#bugfix)\n    * Make pages field to work with Flex Pages\n\n# v1.10.0-beta.8\n## 09/19/2019\n\n1. [](#new)\n    * Add ability to Sanitize SVGs on file upload\n    * Add ability to Sanitize SVGs in Page media\n1. [](#improved)\n    * YAML linter report now supports multi-language\n    * Better colors/placement of toolbar buttons in page edit view\n1. [](#bugfix)\n    * Fixed missing language for AJAX requests\n    * Fixed redirect with absolute language URL\n    * Fixed issue with user avatar reference not being deleted when image removed\n\n# v1.10.0-beta.7\n## 08/30/2019\n\n1. [](#bugfix)\n    * Fixed regression: Do not require Flex Objects plugin [grav#2653](https://github.com/getgrav/grav/issues/2653)\n\n# v1.10.0-beta.6\n## 08/29/2019\n\n1. [](#improved)\n    * Optimized admin for speed (only load frontend pages on demand)\n    * Updated navigation menu to be fully controlled and overrideable by `onAdminMenu` event\n    * Lots of Flex Page speed improvements\n\n# v1.10.0-beta.5\n## 08/11/2019\n\n1. [](#new)\n    * Added `data()` twig function to create data object from an array\n1. [](#improved)\n    * Better support for `array` field into `list` field\n    * Made RAW blueprints (expert mode) to work properly with Flex Form\n    * Better support for `clockwork` logs\n1. [](#bugfix)\n    * Fixed issue with nested `list` fields both utilizing the custom `key` functionality\n    * Regression: Page Preview not working, bad url [#1715](https://github.com/getgrav/grav-plugin-admin/issues/1715)\n    * Fixed '+New Folder' to work with new parent picker\n    * Fixed missing XSS check field when editing modular page as raw\n    * Fixed minor CSS layout issue [#1717](https://github.com/getgrav/grav-plugin-admin/issues/1717)\n\n# v1.10.0-beta.4\n## 07/01/2019\n\n1. [](#new)\n    * Added `Admin::redirect()` method to allow redirects to be used outside of controllers\n    * Added `$admin->adminRoute()` method and `admin_route()` twig function to create language aware admin page links\n    * Renamed `Admin::route()` to `Admin::getCurrentRoute()` and deprecated the old call\n1. [](#improved)\n    * Much improved multi-language support for pages\n    * Admin redirects should now work better with multiple languages enabled\n1. [](#bugfix)\n    * Fixed default language being renamed to `page.en.md` (English) instead of keeping existing `page.md` filename\n    * Fixed possibility to override already existing translation by `Save As Language`\n    * Fixed missing default translation if page used plain `.md` file extension without language code\n    * Fixed wrong translation showing up as page fallback language\n    * Integrated Admin 1.9.8 bug fixes\n\n# v1.10.0-beta.3\n## 06/24/2019\n\n1. [](#improved)\n    * Smarter handling of symlinks in parent field\n1. [](#bugfix)\n    * Fixed issue with windows paths in `parent` field [#1699](https://github.com/getgrav/grav-plugin-admin/issues/1699)\n\n# v1.10.0-beta.2\n## 06/21/2019\n\n1. [](#improved)\n    * Moved Remodal in-house and added support for stackable modals [#1698](https://github.com/getgrav/grav-plugin-admin/issues/1698), [#1699](https://github.com/getgrav/grav-plugin-admin/issues/1699)\n1. [](#bugfix)\n    * Fixed missing check for maximum allowed files in `files` field\n\n# v1.10.0-beta.1\n## 06/14/2019\n\n1. [](#new)\n    * New Parent/Move field using Ajax for better performance\n    * Improvements to cache clearing when admin cache is enabled\n    * Require Grav v1.7\n    * Use PSR-4 for plugin classes\n    * Added support for Twig 2.11 (compatible with Twig 1.40+)\n1. [](#improved)\n    * Various admin performance improvements\n1. [](#bugfix)\n    * Fixed admin caching issues\n\n# v1.9.19\n## 12/14/2020\n\n1. [](#bugfix)\n    * Fixed `pages` field escaping issues, needs Grav update, too [#1990](https://github.com/getgrav/grav-plugin-admin/issues/1990)\n    * Fixed Plugins references in Themes details page.\n    * Fixed issue preventing purchase of Themes within Admin and redirecting instead.\n    * Fixed Page Picker not passing admin token\n\n# v1.9.18\n## 12/02/2020\n\n1. [](#new)\n    * Never allow Admin pages to be rendered in `<frame>`, `<iframe>`, `<embed>` or `<object>` for improved security\n1. [](#improved)\n    * Auto-link a plugin/theme license in details if it starts with `http`\n    * Allow to fallback to `docs:` instead of `readme:`\n    * Backported finder/pages navigation from 1.10 (you will still need 1.10 for the fancy Parent Picker)\n    * Forward a `sid` to GPM when downloading a premium package\n    * Add focus states to login buttons [#1839](https://github.com/getgrav/grav-plugin-admin/pull/1839)\n    * Output raw text in paragraph for fieldset [#1956](https://github.com/getgrav/grav-plugin-admin/pull/1956)\n    * Set scheduled items to be 'disabled' by default\n    * Added scheduler warning about potential dangers of use\n1. [](#bugfix)\n    * Escape page title in `pages` field\n    * Fixed unused task RemoveMedia, it cannot be used directly anymore [GHSA-945r-cjfm-642c](https://github.com/getgrav/grav-plugin-admin/security/advisories/GHSA-945r-cjfm-642c)\n    * Tightened checks when removing a media file [GHSA-945r-cjfm-642c](https://github.com/getgrav/grav-plugin-admin/security/advisories/GHSA-945r-cjfm-642c)\n    * Removed unused parameter in file field [GHSA-945r-cjfm-642c](https://github.com/getgrav/grav-plugin-admin/security/advisories/GHSA-945r-cjfm-642c)\n    * Fixed backup download URL [GHSA-vrvq-2pxg-rw5r](https://github.com/getgrav/grav-plugin-admin/security/advisories/GHSA-vrvq-2pxg-rw5r)\n    * Fixed deleting backup [GHSA-85r3-mf4x-qp8f](https://github.com/getgrav/grav-plugin-admin/security/advisories/GHSA-85r3-mf4x-qp8f)\n\n# v1.9.17\n## 10/07/2020\n\n1. [](#new)\n    * Support premium themes\n    * Back-ported functionality from Admin 1.10 required for upcoming WYSIWYM Nextgen Editor\n1. [](#improved)\n    * Improved some error messages for better readability\n1. [](#bugfix)\n    * Fixed issue that would force a page reload when failing to install/update a plugin or theme\n    * Fixed proxy/browser caching issues in admin pages\n\n# v1.9.16\n## 09/01/2020\n\n1. [](#bugfix)\n    * Fixed a glitch which allows user to delete entire pages directory [#1941](https://github.com/getgrav/grav-plugin-admin/issues/1941)\n    * Fixed the hidden login plugin toggle\n\n# v1.9.15\n## 06/08/2020\n\n1. [](#bugfix)\n    * Support markdown in `fieldset.text` [#2934](https://github.com/getgrav/grav/issues/2934)\n    * Fix data URLs in avatar images [#1889](https://github.com/getgrav/grav/issues/1889)\n    * Fix for deleting files in plugin configurations\n\n# v1.9.14\n## 04/27/2020\n\n1. [](#improved)\n    * Added `slug` and `type` to blueprints\n1. [](#bugfix)\n    * Support markdown in `fieldset.text` [#2934](https://github.com/getgrav/grav/issues/2934)\n\n# v1.9.13\n## 03/05/2020\n\n1. [](#improved)\n    * Updated vendor libs\n1. [](#bugfix)\n    * Fixed toggleable buttons no longer holding false state [form#406](ttps://github.com/getgrav/grav-plugin-form/issues/406)\n\n# v1.9.12\n## 12/04/2019\n\n1. [](#bugfix)\n    * Fixed saving configuration in PHP 7.4\n\n# v1.9.11\n## 11/06/2019\n\n1. [](#improved)\n    * Added new \"secure delete\" functionality [#1752](https://github.com/getgrav/grav-plugin-admin/issues/1752)\n    * Center text logo [#1751](https://github.com/getgrav/grav-plugin-admin/issues/1751)\n    * Added required span to editor field [#1748](https://github.com/getgrav/grav-plugin-admin/issues/1748)\n    * Warn users if JS is disabled [#1722](https://github.com/getgrav/grav-plugin-admin/issues/1722)\n    * Added target rule to quick links [#1518](https://github.com/getgrav/grav-plugin-admin/issues/1518)\n1. [](#bugfix)\n    * Fixed `Badly encoded JSON data` warning when uploading files [grav#2663](https://github.com/getgrav/grav/issues/2663)\n    * Fixed `accept` for SVG in `file` uploaders [#1732](https://github.com/getgrav/grav-plugin-admin/issues/1732)\n\n# v1.9.10\n## 09/19/2019\n\n1. [](#bugfix)\n    * Fixed `Badly encoded JSON data` warning when uploading files [grav#2663](https://github.com/getgrav/grav/issues/2663)\n\n# v1.9.9\n## 08/21/2019\n\n1. [](#bugfix)\n    * Fixed regression with files in admin not allowing types other than images [#1737](https://github.com/getgrav/grav-plugin-admin/issues/1737)\n    * Fixed preview link for non-images files in **Page Media** [#1727](https://github.com/getgrav/grav-plugin-admin/issues/1727)\n\n# v1.9.8\n## 08/11/2019\n\n1. [](#improved)\n    * Better support for `array` field into `list` field\n    * Attach `_list_index` to fields within list items so that the index/key is available\n1. [](#bugfix)\n    * Fixed 2FA regenerate for Flex Users\n    * Added missing closing </li> in language loops\n    * Fixed issue with nested `list` fields both utilizing the custom `key` functionality\n    * Fixed issue with `array` field nested in `list` that were losing their index order when the list reordered\n    * Fixed file form field failing resolution checks in certain circumstances\n    * Fixed issue with deleting files in config based YAML files\n\n# v1.9.7\n## 06/21/2019\n\n1. [](#bugfix)\n    * Fixed issue with charts in dashboard where label would cut off [#1700](https://github.com/getgrav/grav-plugin-admin/issues/1700)\n    * Resetting a user's password clears the user's site access [grav#2528](https://github.com/getgrav/grav/issues/2528)\n    * Fixed issue with permissions toggle [#1702](https://github.com/getgrav/grav-plugin-admin/issues/1702)\n\n# v1.9.6\n## 06/15/2019\n\n1. [](#bugfix)\n    * Fixed regression issue with `parents_levels` defaulting to `2`\n\n# v1.9.5\n## 06/14/2019\n\n1. [](#improved)\n    * Display error message if GPM class fails to initialize\n    * Better append/prepend logic that was breaking some layouts\n    * Default `backups` to an array if used outside of tools\n    * PSR 7 fixes\n\n# v1.9.4\n## 05/09/2019\n\n1. [](#new)\n    * Added support for `field.copy-to-clipboard` on Text input fields\n1. [](#improved)\n    * Only invalidate cache on creating new/deleting page to speed up the recovery\n    * Updated language strings from https://crowdin.com/project/grav-admin\n    * Use `plugins://` stream rather than `user://plugins` [#1674](https://github.com/getgrav/grav-plugin-admin/issues/1674)\n1. [](#bugfix)\n    * Fixed admin cache to detect moved and deleted pages\n    * Fixed avatar URLs with `?` in them being broken\n    * Fixed issue saving page with language that was not exactly `2` or `5` chars long [#1667](https://github.com/getgrav/grav-plugin-admin/issues/1667)\n    * Fixed admin not detecting any existing users when Flex users are being used\n    * Fixed issue with append/prepend not respecting `size:`\n    * Fixed issue with `unset` on file fields [#1427](https://github.com/getgrav/grav/issues/1427), [#1670](https://github.com/getgrav/grav/issues/1670), [#1982](https://github.com/getgrav/grav/issues/1982)\n\n# v1.9.3\n## 04/22/2019\n\n1. [](#new)\n    * Added a new **YAML Linter** report to the `Tools - Reports` section\n1. [](#improved)\n    * Updated package.json scripts to properly use gulp compiler\n\n# v1.9.2\n## 04/15/2019\n\n1. [](#bugfix)\n    * Fix for homepage admin preview [#2426](https://github.com/getgrav/grav/issues/2426)\n    * Uploaded Avatar removed from user's yaml when editing the user [#1647](https://github.com/getgrav/grav-plugin-admin/issues/1647)\n\n# v1.9.1\n## 04/13/2019\n\n1. [](#bugfix)\n    * Fix for Page saving issues [#1648](https://github.com/getgrav/grav-plugin-admin/issues/1648)\n    * Remove status message when picking folder for move [#1650](https://github.com/getgrav/grav-plugin-admin/issues/1650)\n\n# v1.9.0\n## 04/11/2019\n\n1. [](#new)\n    * New `Scheduler` configuration panel in tools\n    * New `Backups` configuration panel in tools\n    * New `Cache::purge()` option in cache drop-down to clear out old cache only\n    * New `Tools - Reports` section with event `onAdminGenerateReports()` for 3rd party plugin support\n    * Added support for the new `Flex User` object\n    * Allow admin forms to use `Form` classes\n    * Added new `Logs` section to tools to allow quick view of Grav log files\n1. [](#improved)\n    * Improved the UI for the Parent Page Route dropdown when adding a new Page / Folder\n    * Use `$grav['accounts']` instead of `$grav['users']`\n    * Improved image background overlay and tools\n    * Better unauthorized user rendering\n    * Update all Form classes to rely on `PageInterface` instead of `Page` class\n    * Removed `media.upload_limit` references\n    * Improve error when upload exceeds `upload_max_filesize`\n    * Delegate Dropzone for checking maximum file size and avoid uploading if not necessary\n    * Low level unauthorized user handling in `base-root.html.twig`\n    * Refactored \"NewsFeeds\" and \"Notifications\" for better performance and to address CORS issues\n    * Flex user profile now uses Flex Form\n    * Moved dashboard `notifications` logic to server-side for increased performance (1 request instead of 3)\n    * Refactored feeds logic for better performance\n    * Better logic for delete action to support Ajax. Fixes Flex lists\n    * Cleanly handle session corruption due to changing Flex object types\n    * Implemented [ForkAwesome](https://forkawesome.github.io/Fork-Awesome/) and removed FontAwesome + LineAwesome\n    * Various default admin theme improvements and cleanup\n    * Make new System Config layout responsive [#1579](https://github.com/getgrav/grav-plugin-admin/issues/1579)\n    * Homepage link should be `https://` [#1564](https://github.com/getgrav/grav-plugin-admin/issues/1564)\n    * Improve lang string to describe XSS security settings [#1566](https://github.com/getgrav/grav-plugin-admin/issues/1566)\n    * Take admin setting for 2FA into account when showing user 2FA badge [#1568](https://github.com/getgrav/grav-plugin-admin/issues/1568)\n    * Moved `ignore` and `key` field into form plugin\n    * Improved usability of `System` configuration blueprint with side-tabs\n    * Cleaned up UI in `Scheduler` tools page\n    * Updated languages\n1. [](#bugfix)\n    * Fixed user edit links if Flex Objects plugin is installed but user isn't Flex User\n    * Fixed deprecated `sameas()` Twig test\n    * Regression: Fixed lost user access when saving user profile without super user permissions [#1639](https://github.com/getgrav/grav-plugin-admin/issues/1639)\n    * Fixed `Page.menu` displaying in edit view rather than `Page.title` [#1642](https://github.com/getgrav/grav-plugin-admin/issues/1642)\n    * Regression from beta.8: Deleting files other than from plugins/themes fail on error\n    * Fixed issue with Safari browser and blueprint fields with `toggleable: true` [#1643](https://github.com/getgrav/grav-plugin-admin/issues/1643)\n    * Incorrect 2FA lang code [#1618](https://github.com/getgrav/grav-plugin-admin/issues/1618)\n    * Fixed potential undefined property in `onPageNotFound` event handling\n    * Proper fix for `vUndefined` when updating plugins/themes\n    * Text in Tab Tools/Direct install disappears [#1613](https://github.com/getgrav/grav-plugin-admin/issues/1613)\n    * Fallback to page `slug` in Pages list if title is empty [grav#2267](https://github.com/getgrav/grav/issues/2267)\n    * Fixes backup button issues with `;` param separator [#1602](https://github.com/getgrav/grav-plugin-admin/issues/1602) [#1502](https://github.com/getgrav/grav-plugin-admin/issues/1502)\n    * Set default state for `show_modular` to `true` [#1599](https://github.com/getgrav/grav-plugin-admin/issues/1599)\n    * Removed `tabs`, `tab`, and `toggle` fields as they are now in Form plugin\n    * Fix issue with new page always showing modular page templates [#1573](https://github.com/getgrav/grav-plugin-admin/issues/1573)\n    * Fixed issue deleting files in plugins/themes/config\n    * Fixed array support in admin languages, e.g. `DAYS_OF_THE_WEEK`\n    * Fixed user login / remember me triggering before admin gets initialized\n    * Fixed a bug when deleting files via AJAX\n    * Fixed error page not to be the frontend version\n    * Added `merge_items` option for `field.selectize` to allow storing custom items [#1461](https://github.com/getgrav/grav-plugin-admin/issues/1461)\n    * Better handling of unset in uploaded files [#1427](https://github.com/getgrav/grav-plugin-admin/issues/1427)\n    * Prefix Backup/Scheduler titles with `Tools`\n    * Regression: Media settings have bad layout [#1529](https://github.com/getgrav/grav-plugin-admin/issues/1529)\n    * Fixed Direct Install Uploader, failing to validate the uploaded files\n    * Regression: Editing interface does not keep settings properly without manual intervention on each edit [#1527](https://github.com/getgrav/grav-plugin-admin/issues/1527)\n    * Removed duplicate language strings\n    * Fixed default `job_at` so it does not fail if missing\n    * Minor JS group `bottom` fix\n\n# v1.8.20\n## 03/20/2019\n\n1. [](#improved)\n    * Added security field to column [#1622](https://github.com/getgrav/grav-plugin-admin/pull/1622)\n\n# v1.8.19\n## 02/13/2019\n\n1. [](#bugfix)\n    * Moved `show_modular` to proper place - Doh! [grav#2362](https://github.com/getgrav/grav/issues/2362)\n\n# v1.8.18\n## 02/12/2019\n\n1. [](#bugfix)\n    * Set default value for `show_modular` [grav#2362](https://github.com/getgrav/grav/issues/2362)\n\n# v1.8.17\n## 02/07/2019\n\n1. [](#improved)\n    * Improved Grav Core installer/updater to run installer script (if available)\n    * Added `unauthorized.html.twig` file that was missing [#1609](https://github.com/getgrav/grav-plugin-admin/pull/1609)\n1. [](#bugfix)\n    * Fixed direct install deleting backups and logs if used with full Grav package instead of with update package\n\n# v1.8.16\n## 01/25/2019\n\n1. [](#improved)\n    * IP pseudonymization for rate limiter [#1589](https://github.com/getgrav/grav-plugin-admin/pull/1589)\n    * Add option to hide modular pages in parent select [#1571](https://github.com/getgrav/grav-plugin-admin/pull/1571)\n    * Added `admin.tools` permission [#1550](https://github.com/getgrav/grav-plugin-admin/pull/1550)\n1. [](#bugfix)\n    * Fixed calendar js module not properly loading for datetime field [#1581](https://github.com/getgrav/grav-plugin-admin/issues/1581)\n    * Fixed deleting file when using file field type [#1558](https://github.com/getgrav/grav-plugin-admin/issues/1558)\n    * Unset state from user if not super or user admin\n\n# v1.8.15\n## 12/14/2018\n\n1. [](#improved)\n    * Fire `onAdminSave()` event during `AdminController::taskSaveAs()` [#1544](https://github.com/getgrav/grav-plugin-admin/issues/1544)\n1. [](#bugfix)\n    * Clean user post to ensure dynamically added form fields are not saved\n\n# v1.8.14\n## 11/12/2018\n\n1. [](#bugfix)\n    * Fixed Grav core update potentially spinning forever because of an error which happens after a successful upgrade\n    * Saving in expert mode can cause `undefined index: header` error [#1537](https://github.com/getgrav/grav-plugin-admin/issues/1537)\n\n# v1.8.13\n## 11/05/2018\n\n1. [](#new)\n    * Added new `|nested()` Twig filter to access array objects with dot notation syntax\n1. [](#bugfix)\n    * Fixed issue with complex lists structure and nested dot-notation [admin#2236](https://github.com/getgrav/grav/issues/2236)\n\n# v1.8.12\n## 10/24/2018\n\n1. [](#improved)\n    * Updated various lang strings\n    * Removed duplicate lang strings\n1. [](#bugfix)\n    * Fix XSS checking when empty content [#1533](https://github.com/getgrav/grav-plugin-admin/issues/1533)\n    * Fix DirectInstall not working [#1535](https://github.com/getgrav/grav-plugin-admin/issues/1535)\n\n# v1.8.11\n## 10/08/2018\n\n1. [](#improved)\n    * Change usage of basename where possible [#1480](https://github.com/getgrav/grav-plugin-admin/pull/1480)\n    * Improved filename validation (requires Grav 1.5.3)\n    * Updated various lang codes\n1. [](#bugfix)\n    * File Uploads: Do not trust mimetype sent by the browser\n    * Fixed file extension detection\n    * Fix for HTML entities in page slug [#1524](https://github.com/getgrav/grav-plugin-admin/issues/1524)\n    * Fix for port in backup download links [#1521](https://github.com/getgrav/grav-plugin-admin/issues/1521)\n\n# v1.8.10\n## 10/01/2018\n\n1. [](#new)\n    * IMPORTANT: Non `admin.super` users are now subject to XSS validation in Page content.  Configurable via Configuration / Security\n    * New XSS content warnings and integration into page save\n    * Added new event `onAdminPage()` which allows plugins to customize `Page` object in `$event['page']`\n1. [](#improved)\n    * Use `Url:post()` to get the `$_POST` variable (allows common security checks/filtering for the POST data)\n    * Requires Grav 1.5.2\n1. [](#bugfix)\n    * Fixed redirect to correct URL after failed login\n    * Fixed issue in `filepicker` where missing images would cause a loop to try to load them\n    * Twig 2 compatibility fixes for macros\n    * Updated `composer.json` to better match Grav 1.5\n    * Remove `package-lock.json` as it was referencing an insecure JS package\n\n# v1.8.9\n## 08/23/2018\n\n1. [](#improved)\n    * Make order field to use context, not data\n    * Switched to new Grav Yaml class to support Native + Fallback YAML libraries\n    * Minor fix for `file` thumbnails display\n    * Requires Grav 1.5.1\n\n# v1.8.8\n## 08/17/2018\n\n1. [](#improved)\n    * Support URI Params and Query attributes in Login redirect\n    * Added support for textarea value type in `array` field\n    * Added some new lang strings for Grav 1.5.0\n1. [](#bugfix)\n    * Support params and querystring in login redirect\n    * Added field name nesting with tab field\n\n# v1.8.7\n## 07/31/2018\n\n1. [](#bugfix)\n    * Fix for deleting 'extra' media files [grav#2100](https://githubcom/getgrav/grav/issues/2100)\n\n# v1.8.6\n## 07/13/2018\n\n1. [](#bugfix)\n    * Force `html` for markdown preview [grav#2066](https://github.com/getgrav/grav/issues/2066)\n    * Add missing `authorizeTask()` checks in controller [#1483](https://github.com/getgrav/grav/issues/1483)\n    * Add support for `force_ssl` to admin URLs [#1479](https://github.com/getgrav/grav-plugin-admin/issues/1479)\n\n# v1.8.5\n## 06/20/2018\n\n1. [](#bugfix)\n    * Fixed broken folder attribute on filepicker [#1465](https://github.com/getgrav/grav-plugin-admin/issues/1465)\n    * Added translation for system.session.initialize\n    * Slight updates on new translation strings\n\n# v1.8.4\n## 06/11/2018\n\n1. [](#improved)\n    * Including EXIF JS library in the modules dependencies to fix orientation when uploading images\n1. [](#bugfix)\n    * Initialize session on setup [#1451](https://github.com/getgrav/grav-plugin-admin/issues/1451)\n    * Force a `null` order when empty in the post request\n    * Fixed some 2FA form styling issues\n\n# v1.8.3\n## 05/31/2018\n\n1. [](#new)\n    * Added support for selectize plugins as options in the selectize field\n1. [](#bugfix)\n    * Fixed deep linking in admin after login [#1456](https://github.com/getgrav/grav-plugin-admin/issues/1456)\n    * Fixed Undefined property: `stdClass::$image` in v1.8.2 [#1454](https://github.com/getgrav/grav-plugin-admin/issues/1454)\n    * Pass media order when calling `task:listmedia`\n\n# v1.8.2\n## 05/24/2018\n\n1. [](#new)\n    * Added custom object support for filepicker field\n    * Don't allow saving of a user with no local account file\n    * Controls for `list` field were not in sync between top and bottom\n1. [](#improved)\n    * More subtle `fieldset` styling\n1. [](#bugfix)\n    * Check if `$object->blueprints()` exists in `onAdminAfterSave`\n    * When creating first user, check `admin.login` not `site.login`\n    * Fix admin login redirects for multisite setups\n    * Fixed issue with filepicker field where images wouldn't properly merge with the current value if in a page header\n    * Fixed media delete for streams\n\n# v1.8.1\n## 05/15/2018\n\n1. [](#improved)\n    * use SHA1 hashing of IP addressed to support GDPR rules [#1436](https://github.com/getgrav/grav-plugin-admin/pull/1436)\n1. [](#bugfix)\n    * Fixed 2FA form showing up even if user has not turned on the feature [#1442](https://github.com/getgrav/grav-plugin-admin/issues/1442)\n    * Fixed previews of images in Pagemedia field not properly URI encoded [#1438](https://github.com/getgrav/grav-plugin-admin/issues/1438)\n\n# v1.8.0\n## 05/11/2018\n\n1. [](#new)\n    * Moved 2FA authentication to login plugin\n    * Admin login now uses login plugin events\n    * Added new decoupled `pagemedia` field that is no longer tied to just pages\n    * Updated plugin dependencies (Grav >= 1.4.4, Form >=2.14.0, Login >=2.7.0, Email >=2.7.0)\n1. [](#improved)\n    * Added support for JavaScript `bottom` block [#1425](https://github.com/getgrav/grav-plugin-admin/pull/1425)\n    * Added better typography styling for blockquote and markdown in `display` field\n    * Vendor updates\n1. [](#bugfix)\n    * Added missing MarkdownExtra strings [#1385](https://github.com/getgrav/grav-plugin-admin/pull/1385)\n    * Updated `blueprints.yaml` with missing `step` attribute [#1415](https://github.com/getgrav/grav-plugin-admin/pull/1415)\n    * Fixed preview target setting [#1430](https://github.com/getgrav/grav-plugin-admin/pull/1430)\n    * Added new modular string [#1433](https://github.com/getgrav/grav-plugin-admin/pull/1433)\n    * Fixed Firefox issue with the Regenerate button for 2FA. Forcing the page to reload\n    * Fixed jumpiness behavior for Regenerate button when on active state.\n    * Prevent the prompt for unsaved state when Regenerating a 2FA code and trying to reload/leave the page.\n\n# v1.7.4\n## 04/02/2018\n\n1. [](#bugfix)\n    * Fixed a bug for page copy caused by last release [#1409](https://github.com/getgrav/grav-plugin-admin/pull/1409)\n    * Fixed collapsible `list` option [#1410](https://github.com/getgrav/grav-plugin-admin/pull/1410)\n    * Fixed a minor typo in a label [#1397](https://github.com/getgrav/grav-plugin-admin/pull/1397)\n\n# v1.7.3\n## 04/01/2018\n\n1. [](#new)\n    * Implemented Resize Media and Resolution ('resizeWidth', 'resizeHeight', 'resizeQuality', 'resolution')\n    * Updated Dropzone to latest\n1. [](#bugfix)\n    * Implemented workaround for required text fields [#1390](https://github.com/getgrav/grav-plugin-admin/issues/1390)\n    * Fixed highlight color in Firefox [getgrav/grav#1949](https://github.com/getgrav/grav/issues/1949)\n    * Fix for bad redirect on saving simplesearch (possibly others)\n\n# v1.7.2\n## 03/21/2018\n\n1. [](#improved)\n    * Table CSS improvements for use in 3rd party plugins\n    * Translatable `add_modals` button labels [#1388](https://github.com/getgrav/grav-plugin-admin/issues/1388)\n    * Check for `SHIFT` key on editor save shortcut [#1383](https://github.com/getgrav/grav-plugin-admin/issues/1383)\n    * Fixed User permissions responsive UI [#1379](https://github.com/getgrav/grav-plugin-admin/issues/1379)\n    * Optimization to stop admin for looking for pages in disabled plugins\n    * Added configuration option to choose if you want to use new 'inline' preview or `new tab'\n1. [](#bugfix)\n    * Fix redirect bug when changing admin route to `admin-*`\n    * Changed Twig `|count` to `|length` filter [#1391](https://github.com/getgrav/grav-plugin-admin/issues/1391)\n    * Fix for page preview when `HTTP_REFERRER` is not set [grav#1930](https://github.com/getgrav/grav/issues/1930)\n\n# v1.7.1\n## 03/11/2018\n\n1. [](#new)\n    * New built-in page preview system\n1. [](#improved)\n    * Added `CTRL+K` / `CMD+K` shortcuts for editor links [#1279](https://github.com/getgrav/grav-plugin-admin/issues/1279)\n1. [](#bugfix)\n    * Automatically redirect to new `admin_route` after changing it [#1371](https://github.com/getgrav/grav-plugin-admin/issues/1371)\n    * Remove bad-shadows on alerts\n    * Fixed notifications titles not html escaped [#1272](https://github.com/getgrav/grav-plugin-admin/issues/1272)\n    * Fixed extra horizontal scrollbar with `Editor` field\n    * Fixed `mediapicker` field in lists [#1369](https://github.com/getgrav/grav-plugin-admin/issues/1369)\n\n# v1.7.0\n## 03/09/2018\n\n1. [](#new)\n    * Added styling and lang for **Route Overrides** in the default page blueprint\n    * Added clear cache permanently to quick-tray [#1353](https://github.com/getgrav/grav-plugin-admin/issues/1353)\n1. [](#improved)\n    * Added option to toggle between `line-awesome` and `font-awesome` icon sets [#1334](https://github.com/getgrav/grav-plugin-admin/issues/1334)\n    * Added preview from page list view [#1250](https://github.com/getgrav/grav-plugin-admin/pull/1250)\n    * Added `Add` plugins button to plugins details page [#1352](https://github.com/getgrav/grav-plugin-admin/pull/1352)\n    * Added support for `default` and `options` fields in taxonomy field [#1364](https://github.com/getgrav/grav-plugin-admin/issues/1364)\n    * Added support to limit parent field levels [#1298](https://github.com/getgrav/grav-plugin-admin/issues/1298)\n1. [](#bugfix)\n    * Fixed issue with custom logo text overlapping the sidebar toggle [#1334](https://github.com/getgrav/grav-plugin-admin/issues/1334)\n    * Fixed issues with minimum PHP versions in resource upgrades\n    * Fixed issue with default lang translation in admin [#1361](https://github.com/getgrav/grav-plugin-admin/issues/1361)\n    * Typos in `Tools` -> `Direct Install` page [#1345](https://github.com/getgrav/grav-plugin-admin/issues/1345)\n    * Fixed bug with frontmatter being killed when in `Expert Mode` [#1354](https://github.com/getgrav/grav-plugin-admin/issues/1354)\n\n# v1.7.0-rc.3\n## 02/15/2018\n\n1. [](#improved)\n    * Tab optimization with fixes for 'onpage' tabs\n    * Stopped Chrome from auto-completing admin user profile form [grav#1847](https://github.com/getgrav/grav/issues/1847)\n    * Added a fixed `ga-theme-17x` body class to help styling compatibility\n    * Outputs an iterable field as a string if `yaml: true` or `validate: type: yaml` set in blueprint\n1. [](#bugfix)\n    * Rolled back JS to known working versions [#1323](https://github.com/getgrav/grav-plugin-admin/issues/1323)\n    * Fixed missing translation in order field [#1324](https://github.com/getgrav/grav-plugin-admin/issues/1324)\n    * Fixed UI issue with last drop-down in button group [1325](https://github.com/getgrav/grav-plugin-admin/issues/1325)\n    * Fixed fieldset field outdated rendering [#1313](https://github.com/getgrav/grav-plugin-admin/issues/1313)\n\n# v1.7.0-rc.2\n## 01/24/2018\n\n1. [](#new)\n    * Moved to LineAwesome icons rather than FontAwesome (still compatible w/FA 4.7.0)\n1. [](#improved)\n    * Simplified open/close nav button\n    * Tidied Tools panel and added translations\n    * Tooltip and new icon for site preview\n    * Updated JS library dependencies\n    * Changed CodeMirror editor to use sans-serif font for readability\n1. [](#bugfix)\n    * Fixed z-index issue in fullscreen mode [#1317](https://github.com/getgrav/grav-plugin-admin/issues/1317)\n\n# v1.7.0-rc.1\n## 01/22/2018\n\n1. [](#new)\n    * Added support for markdown in all form fields for `label`, `help`, and `description` when `markdown: true` is set on field\n    * Changed \"made by\" to Trilby Media from RocketTheme\n1. [](#improved)\n    * Lightened tabs in new theme\n    * Sort languages by key [#1303](https://github.com/getgrav/grav-plugin-admin/issues/1303)\n    * Add limit to Parent Levels [#1298](https://github.com/getgrav/grav-plugin-admin/pull/1298)\n1. [](#bugfix)\n    * Fixed alignment issue with language drop-down\n    * Fixed a z-index issue with fullscreen editor [#1302](https://github.com/getgrav/grav-plugin-admin/issues/1302)\n    * Fixed missing background on register [#1307](https://github.com/getgrav/grav-plugin-admin/issues/1307)\n    * Fixed some style issues with field descriptions\n    * Fixed an issue with `File` field losing download size setting\n    * Fixed distorted thumbnails in `File` field by using `object-fit: cover`\n\n# v1.7.0-beta.1\n## 12/29/2017\n\n1. [](#new)\n    * New lighter-and-tighter admin theme developed\n1. [](#improved)\n    * Added simple value support for list field type\n    * Added checks to automatically hide collapse buttons when there's only single value in list type\n\n# v1.6.7\n## 12/05/2017\n\n1. [](#new)\n    * Logout of admin goes straight to login form with a message (that then fades out)\n    * Added `sl`, `id`, `he`, `eu`, `et` languages\n1. [](#improved)\n    * Added code to use new `GPM::loadRemoteGrav` if it exists in Gav [grav#1746](https://github.com/getgrav/grav/pull/1746)\n    * Add vertical style for order field [#1253](https://github.com/getgrav/grav-plugin-admin/pull/1253)\n    * Added classes to pagemedia field [#1274](https://github.com/getgrav/grav-plugin-admin/issues/1274)\n    * Fixed selectize field not properly updating value when `option` is provided [#1236](https://github.com/getgrav/grav-plugin-admin/pull/1236)\n    * Tab layout tweaks\n    * Updated all language files with latest from [Crowdin](https://crowdin.com/project/grav-admin)\n1. [](#bugfix)\n    * Manual image metadata can now display in pagemedia when auto-generation is disabled [#1275](https://github.com/getgrav/grav-plugin-admin/issues/1275)\n    * Removed broken `home.hide_in_urls` code in `AdminBaseController::save()` that was throwing move errors\n    * Security fix to ensure file uploads are not manipulated mid-post - thnx @FLH!\n\n# v1.6.6\n## 10/27/2017\n\n1. [](#new)\n    * Fixed issue where sortable media in expert mode would reset frontmatter [#1252](https://github.com/getgrav/grav-plugin-admin/issues/1252)\n\n# v1.6.5\n## 10/26/2017\n\n1. [](#new)\n    * Added ability to **order** page media (requires latest Grav update)\n\n# v1.6.4\n## 10/11/2017\n\n1. [](#improved)\n    * Use system PHP size for upload limit rather than `system.media.upload_limit` or `file.filesize` plugin options\n1. [](#bugfix)\n    * Fixed Dropzone timeout to address slow internet connections [#1239](https://github.com/getgrav/grav-plugin-admin/pull/1239)\n\n# v1.6.3\n## 10/02/2017\n\n1. [](#bugfix)\n    * Fixed chart labels not parsing HTML [#1234](https://github.com/getgrav/grav-plugin-admin/issues/1234)\n\n# v1.6.2\n## 09/29/2017\n\n1. [](#improved)\n    * Removed extraneous files in vendor folder for smaller download package\n\n# v1.6.1\n## 09/29/2017\n\n1. [](#improved)\n    * Added support for Latin Extended fonts [#1211](https://github.com/getgrav/grav-plugin-admin/pull/1221)\n    * Added collapsible attribute to lists [#1231](https://github.com/getgrav/grav-plugin-admin/pull/1231)\n1. [](#bugfix)\n    * Fix editor not clickable in list field [#1224](https://github.com/getgrav/grav-plugin-admin/pull/1124)\n    * Updated Google Font URLs to always connect over HTTPS. [#1106](https://github.com/getgrav/grav-plugin-admin/pull/1106)\n    * Fixed fieldset field not allowing to properly save when contained within a list [#1225](https://github.com/getgrav/grav-plugin-admin/issues/1225)\n    * Fixed Video markdown syntax when drag & dropping in the content editor [#1160](https://github.com/getgrav/grav-plugin-admin/issues/1160)\n    * Fixed headers drop-down in editor to properly align\n    * Fixed fields not working in Microsoft Edge with Selectize.js [#1222](https://github.com/getgrav/grav-plugin-admin/pull/1222)\n    * Replaced a left-over \"is empty\" check [#1232](https://github.com/getgrav/grav-plugin-admin/pull/1232)\n    * Fixed headers drop-down in editor to align properly\n\n\n# v1.6.0\n## 09/07/2017\n\n1. [](#new)\n    * **Added 2-Factor Authentication support to the admin!**\n    * **Added rate-limiting for \"failed login attempts\" and \"forgot password\"**\n1. [](#improved)\n    * Revamped the toggle switch CSS so it's more flexible and works better [#1198](https://github.com/getgrav/grav-plugin-admin/issues/1198)\n    * Improved toggle/button alignment on Page edit view\n1. [](#bugfix)\n    * Fixed an issue where icon-picker style was hiding field elements [#1199](https://github.com/getgrav/grav-plugin-admin/issues/1199)\n    * Fixed https -> http redirect issue [#1195](https://github.com/getgrav/grav-plugin-admin/issues/1195)\n    * Also check `/.` for home route [#1191](https://github.com/getgrav/grav-plugin-admin/issues/1191)\n    * Fixed administration being broken in multi-site environments with plugin overrides\n    * Fixed lang-switcher broken in MS Edge browser [#1213](https://github.com/getgrav/grav-plugin-admin/pull/1213)\n    * Added custom `form_id` attribute for modal forms [#1216](https://github.com/getgrav/grav-plugin-admin/issues/1216)\n    * Fixed partially cropped line in Markdown editor for MS Edge/Firefox [#1219](https://github.com/getgrav/grav-plugin-admin/pull/1219)\n    * Downgraded Babel libraries to v6.x for compatibility with webpack [#1218](https://github.com/getgrav/grav-plugin-admin/pull/1218)\n\n# v1.5.2\n## 08/16/2017\n\n1. [](#new)\n    * Added a new icon quick-tray in side navigation that plugins can utilize\n    * Added ability to set and retrieve temporary admin messages\n1. [](#improved)\n    * Allow different field to be used as page label in list of pages [#1122](https://github.com/getgrav/grav-plugin-admin/pull/1122)\n    * Updated `en` language for `cache-control` + `clear_images_by_default` system settings\n    * Allow sorting of page based on custom ordering [#1182](https://github.com/getgrav/grav-plugin-admin/pull/1182)\n    * Search for pages by slug and folder name [#1183](https://github.com/getgrav/grav-plugin-admin/pull/1183)\n    * Allow all page data to be used during `onAdminCreatePageFrontmatter()` event [#1175](https://github.com/getgrav/grav-plugin-admin/pull/1175)\n    * Remove single quotes when slugifying title [#1178](https://github.com/getgrav/grav-plugin-admin/pull/1178)\n1. [](#bugfix)\n    * Ignore missing Twig files [#1169](https://github.com/getgrav/grav-plugin-admin/issues/1169)\n    * If from is already defined, don't override it [#1129](https://github.com/getgrav/grav-plugin-admin/issues/1129)\n    * Fixed SelectUnique field not working with files with spaces\n\n# v1.5.1\n## 07/19/2017\n\n1. [](#bugfix)\n    * Fixes issue when saving pages without a `folder` element [#1163](https://github.com/getgrav/grav-plugin-admin/issues/1163)\n    * Fixed mediapicker field inside lists not properly updating the value on the target input [#1157](https://github.com/getgrav/grav-plugin-admin/issues/1157)\n\n# v1.5.0\n## 07/16/2017\n\n1. [](#new)\n    * Implemented Offline mode. Notifies in the admin when disconnected.\n1. [](#bugfix)\n    * Fixed fetch issue throwing error when request not completed and while unloading the page [#1301](https://github.com/getgrav/grav-plugin-admin/issues/1301)\n    * Fixed ordering when > 100 pages [grav#1564](https://github.com/getgrav/grav/pull/1564)\n    * Fixed Lists issue when reindexing, causing Radio fields to potentially lose their `checked` status ([#1154](https://github.com/getgrav/grav-plugin-admin/issues/1154) | related: [1d55ffc](https://github.com/getgrav/grav-plugin-admin/commit/1d55ffc616125047f245efe9f2180ef2c16b4949))\n\n# v1.5.0-rc.4\n## 07/05/2017\n\n1. [](#new)\n    * New `multilevel` field, useful for defining collections definitions, metadata and other complex YAML data [#1135](https://github.com/getgrav/grav-plugin-admin/pull/1135) - (EXPERIMENTAL)\n    * Fix plugins hooked nav authorize not working with array of permissions [#1148](https://github.com/getgrav/grav-plugin-admin/pull/1148)\n1. [](#improved)\n    * Add badge to plugins hooked into nav [#1147](https://github.com/getgrav/grav-plugin-admin/pull/1147)\n    * Added `field.outerclasses` to default form field [#1124](https://github.com/getgrav/grav-plugin-admin/pull/1124)\n    * Reverted back to textarea/YAML for `media.yaml` image options\n    * Fixed color of textarea fields in admin\n1. [](#bugfix)\n    * Fix for bad referenced to `shouldLoadAdditionalFilesInBackground()` [#1145](https://github.com/getgrav/grav-plugin-admin/pull/1145)\n    * Expose Page Media instance to Grav Admin JS API\n    * Fixed mediapicker issue where newly added list items would not work\n    * Fixed issue with min/max setting of list collections. Removing a list item would not refresh properly the count\n    * If folder is empty/not sent, fallback to page slug [#1146](https://github.com/getgrav/grav-plugin-admin/issues/1146)\n    * Escape the URI basename before using it in Twig\n    * Ignore missing Twig file in the Tools page\n\n# v1.5.0-rc.3\n## 06/22/2017\n\n1. [](#new)\n    * New `Admin::getPageMedia()` static method that can be used in blueprints\n    * Added a new `mediapicker` form field which allows to select a media from any page [#1125](https://github.com/getgrav/grav-plugin-admin/pull/1125)\n    * Added info metadata button for images to view EXIF and other useful details about an image\n1. [](#improved)\n    * Pass original image filename via the `AdminController::taskListedia()` task\n    * Various form styling improvements\n    * Provided an option to control how parent select field displays\n1. [](#bugfix)\n    * Fix referencing DI element when not initialized [#1141](https://github.com/getgrav/grav-plugin-admin/pull/1141)\n\n# v1.5.0-rc.2\n## 05/22/2017\n\n1. [](#improved)\n    * Remove save button and save location notification on Config Info tab [#1116](https://github.com/getgrav/grav-plugin-admin/pull/1116)\n    * Allow taxonomy field to just list one or more specific taxonomies if the `taxonomies` field is filled in the blueprint\n    * `File` field now renders thumbnail previews of the selected value on load\n    * Use new unified `Utils::getPagePathFromToken()` method rather\n1. [](#bugfix)\n    * Fix for undefined `include_metadata` error\n\n\n# v1.5.0-rc.1\n## 05/16/2017\n\n1. [](#new)\n    * Add support for a single array field in forms\n    * Added Prev/Next support on page editing view [#1112](https://github.com/getgrav/grav-plugin-admin/pull/1112)\n1. [](#improved)\n    * Improved full-screen editor for better browser compatibility [#1093](https://github.com/getgrav/grav-plugin-admin/pull/1093)\n    * Added ability to choose how you want the preview button to open [#1096](https://github.com/getgrav/grav-plugin-admin/pull/1096)\n    * `base.html.twig` now extends a `base-root.html.twig` file\n    * Add month+date indication to the stats graph to avoid confusion when there are days without visits\n    * Added `min` and `max` options for `list` form field [#1113](https://github.com/getgrav/grav-plugin-admin/pull/1113)\n    * Remove page metadata file on deletion of media\n    * Improved layout on pages list for pages with long titles [#1102](https://github.com/getgrav/grav-plugin-admin/pull/1102)\n    * Added option to make custom \"Add page\" dropdown entries [#1104](https://github.com/getgrav/grav-plugin-admin/pull/1104)\n1. [](#bugfix)\n    * Fixed issue with tab widths on Pages overlapping non-english toggle switch [#1089](https://github.com/getgrav/grav-plugin-admin/issues/1089)\n    * Added `vendor` to ignores for direct install of Grav\n    * Translated `field.default` for `editor` form field\n    * Fixed an quote error in `en.yaml`\n    * Resolved z-index issues with mobile nav and pages form elements\n    * Fixed issue with file picker where the selected file preview would not show\n    * Refresh page media on media upload\n    * Default to config file slug if translation is missing, otherwise use translation also in the tab title, not just in the page heading [#1039](https://github.com/getgrav/grav-plugin-admin/issues/1039)\n    * Fix language toggle button in admin top bar visible also in fullscreen mode [#1110](https://github.com/getgrav/grav-plugin-admin/issues/1110)\n    * Fix for editor padding [#1111](https://github.com/getgrav/grav-plugin-admin/issues/1111)\n    * Fix tabs inside blueprint overlapping above content [#1115](https://github.com/getgrav/grav-plugin-admin/pull/1115)\n\n# v1.4.2\n## 04/24/2017\n\n1. [](#new)\n    * Added a new `Content Padding` option to tighten up UI padding space (default `true`)\n1. [](#bugfix)\n    * Added back `Admin::initTheme()` relying on Grav fix [#1069](https://github.com/getgrav/grav-plugin-admin/pull/1069) as it conflicts ith Gantry5\n    * Fix for missing scrollbar when in full-size editor for Firefox [#1077](https://github.com/getgrav/grav-plugin-admin/issues/1077)\n    * Fix for overlay of Add-Page button in full-size editor [#1077](https://github.com/getgrav/grav-plugin-admin/issues/1077)\n    * Better fix for session-based parent overriding root page parents [#1078](https://github.com/getgrav/grav-plugin-admin/issues/1078)\n    * Allow support for `Pages::getList()` with `show_modular` option [#1080](https://github.com/getgrav/grav-plugin-admin/issues/1080)\n    * Added `[tmp,user]` ignores for direct install of Grav [grav#1447](https://github.com/getgrav/grav/issues/1447)\n\n# v1.4.1\n## 04/19/2017\n\n1. [](#bugfix)\n    * Reverted [#1069](https://github.com/getgrav/grav-plugin-admin/pull/1069) as it conflicts ith Gantry5\n\n# v1.4.0\n## 04/19/2017\n\n1. [](#new)\n    * Added ability to add new pages/folders while editing existing page\n1. [](#improved)\n    * Initialize theme in Admin Plugin [#1069](https://github.com/getgrav/grav-plugin-admin/pull/1069)\n    * Use new system configuration entries for username and password format\n    * Reworked Page parent field to use `Pages::getList()` rather than logic in Twig field itself\n    * More robust styling of admin themes page [#1067](https://github.com/getgrav/grav-plugin-admin/pull/1067)\n    * Fix fullscreen editor height [#1065](https://github.com/getgrav/grav-plugin-admin/pull/1065)\n    * Fix small UI issue in the editor with `codemirror.lineNumbers` && `codemirror.styleActiveLine` enabled\n    * Fix UI performance issue in the dashboard [#1064](https://github.com/getgrav/grav-plugin-admin/issues/1064)\n1. [](#bugfix)\n    * Fixed issue with parent not working with custom slug [#1068](https://github.com/getgrav/grav-plugin-admin/issues/1068)\n    * Fixed issue with new page modal not remembering last choice [#1072](https://github.com/getgrav/grav-plugin-admin/issues/1072)\n\n# v1.3.3\n## 04/12/2017\n\n1. [](#bugfix)\n    * Fix for regression introduced in the automatic page template switch when changing page parent [#1059](https://github.com/getgrav/grav-plugin-admin/issues/1059) [grav#1403](https://github.com/getgrav/grav/issues/1403) [#1062](https://github.com/getgrav/grav-plugin-admin/issues/1062)\n    * Fix issue with editor field in lists [#1037](https://github.com/getgrav/grav-plugin-admin/issues/1037)\n\n# v1.3.2\n## 04/10/2017\n\n1. [](#improved)\n    * Added new 'parents' field and switched Page blueprints to use this\n1. [](#bugfix)\n    * Fix for regression in h3 style in the Spacer field [#267](https://github.com/getgrav/grav-plugin-admin/issues/267)\n    * Fix missing preview in page media for SVG images [#1051](https://github.com/getgrav/grav-plugin-admin/issues/1051)\n    * Fix missing check when reordering [#1053](https://github.com/getgrav/grav-plugin-admin/issues/1053)\n    * Fix for editors not getting refreshed when changing tab [#1052](https://github.com/getgrav/grav-plugin-admin/issues/1052)\n    * Fix for mobile tabs in page editing [#1057](https://github.com/getgrav/grav-plugin-admin/issues/1057)\n\n# v1.3.1\n## 03/31/2017\n\n1. [](#bugfix)\n    * Fix for `Undefined index: file_path` error with Direct Install [#1043](https://github.com/getgrav/grav-plugin-admin/issues/1043)\n\n# v1.3.0\n## 03/31/2017\n\n1. [](#new)\n    * User uploadable avatar (still falls back to Gravatar if not provided)\n1. [](#improved)\n    * Improved tabs CSS to handle long titles [#1036](https://github.com/getgrav/grav-plugin-admin/issues/1036)\n    * Fixed `step` in range field [Form#136](https://github.com/getgrav/grav-plugin-form/issues/136)\n1. [](#bugfix)\n    * Fixed issue with exception thrown when `copying` and `moving` a page [#1042](https://github.com/getgrav/grav-plugin-admin/issues/1042)\n    * Automatically calculate the *next* numeric folder prefix [Core#1386](https://github.com/getgrav/grav/issues/1386)\n\n# v1.3.0-rc.3\n## 03/22/2017\n\n1. [](#new)\n    * All new `Page Ordering` implementation.  Completely revamped and will only reorder with folder-prefix enabled.  You can now reorder all siblings at the same time.\n    * Added a new `Advanced - Override` to allow option to display pages by folder name (default) or Collection definition\n    * Improved `range` form field with touch and counter support [#1016](https://github.com/getgrav/grav-plugin-admin/pull/1016)\n1. [](#bugfix)\n    * Cleanup package files via GPM install to make them more windows-friendly [#1361](https://github.com/getgrav/grav/pull/1361)\n\n# v1.3.0-rc.2\n## 03/17/2017\n\n1. [](#improved)\n    * Do not attempt to fetch any notification if settings are disabled [#942](https://github.com/getgrav/grav-plugin-admin/issues/942)\n\n# v1.3.0-rc.1\n## 03/13/2017\n\n1. [](#new)\n    * New flex-based/js Tabs system for better flexibility and improved UX.\n    * Added new **toolbox** with `Direct-Install` option via ZIP or URL.\n    * Added an option to reinstall a plugin/theme already installed [#984](https://github.com/getgrav/grav-plugin-admin/issues/984)\n    * Added a new **range field** [#995](https://github.com/getgrav/grav-plugin-admin/issues/995)\n    * When creating a new page, automatically select the Page Template based on Parent Page Child Type [#1008](https://github.com/getgrav/grav-plugin-admin/issues/1008)\n1. [](#improved)\n    * Page Media field now is available when folder is created, not just markdown file [#1000](https://github.com/getgrav/grav-plugin-admin/issues/1000)\n    * Separated user details and avatar in separate twig to allow more granular overriding in plugins [#989](https://github.com/getgrav/grav-plugin-admin/issues/989)\n    * Nicer layout of themes list on wider screen\n    * Editor full-screen option displays title/save options [#948](https://github.com/getgrav/grav-plugin-admin/issues/948)\n    * Use native OS highlight colors for the editor [#977](https://github.com/getgrav/grav-plugin-admin/issues/977)\n    * Force admin pages to set `Page::expires(0)` so it's not cached [#1009](https://github.com/getgrav/grav-plugin-admin/issues/1009)\n    * Added support for up to 15 tabs (was 10) [#954](https://github.com/getgrav/grav-plugin-admin/issues/954)\n    * Only reorder pages in the admin if collection uses `@self` and `order.by`\n    * Improved configuration tab sizes when you have lots of tabs\n    * Modified default media select size from 150px x 100px to 200px x 150px\n1. [](#bugfix)\n    * Fixed rendering issue with Chrome and sortables collections [#1002](https://github.com/getgrav/grav-plugin-admin/issues/1002)\n    * Fixed issue with removal of file that has been just uploaded and stored in the session\n\n\n# v1.2.14\n## 02/17/2017\n\n1. [](#bugfix)\n    * Fixed bad bug with `GPM::install()` from a change in Admin v1.2.13\n\n# v1.2.13\n## 02/17/2017\n\n1. [](#bugfix)\n    * Fix issue with validating page when switching language [#963](https://github.com/getgrav/grav-plugin-admin/issues/963)\n    * Fix issue with quotes in Admin strings used in JS [#965](https://github.com/getgrav/grav-plugin-admin/issues/965)\n    * Refactored `AdminController::taskGetUpdates` to use standard task/response [#980](https://github.com/getgrav/grav-plugin-admin/issues/980)\n    * Sync Admin pages blueprints with core [core#212d35221a9bbcc242508ba49a551b3f6e62af8e](https://github.com/getgrav/grav/commit/212d35221a9bbcc242508ba49a551b3f6e62af8e)\n\n# v1.2.12\n## 02/12/2017\n\n1. [](#bugfix)\n    * Rebuilt the JS bundle to address various JS-related issues that cropped up in `v1.2.11`\n    * Fixed Firefox Network Error issue when updating multiple plugins/themes at concurrently [#1301](https://github.com/getgrav/grav/issues/1301)\n\n# v1.2.11\n## 02/10/2017\n\n1. [](#new)\n    * Added lang strings for `CLI_COMPATIBILITY` which is new in Grav v1.1.16\n1. [](#improved)\n    * Allow plugin to set custom 'authorize' and 'location' in `onAdminMenu()` event\n    * Updated all language files with latest from [Crowdin](https://crowdin.com/project/grav-admin)\n1. [](#bugfix)\n    * Fixed issue `admin.super` or `admin.users` users changing the account when saving another user [#713](https://github.com/getgrav/grav-plugin-admin/issues/713)\n    * Fix issue where non `admin.super`/`admin.users` users could see other users profiles [#713](https://github.com/getgrav/grav-plugin-admin/issues/713)\n    * Fix removing responsive image from page media [#111](https://github.com/getgrav/grav-plugin-admin/issues/111) [#952](https://github.com/getgrav/grav-plugin-admin/issues/952)\n    * Use @2x & @3x fallback images in the filepicker. [#952](https://github.com/getgrav/grav-plugin-admin/issues/952)\n\n# v1.2.10\n## 1/30/2017\n\n1. [](#improved)\n    * It is now possible to manually specify a format for the `datetime` field [#1261](https://github.com/getgrav/grav/issues/1261)\n    * Allow to see plugins and themes list without internet connection. Also add a more helpful message in the \"add\" view [grav#1008](https://github.com/getgrav/grav/issues/1008)\n1. [](#bugfix)\n    * Fixed issue with downloaded package when installing a testing release\n    * Allow non admin.super users to change their account information. Allow `admin.super` and `admin.users` to change other users information. [#943](https://github.com/getgrav/grav/issues/943)\n    * Handle removing a media file also if it's not a json request. Was not working after https://github.com/getgrav/grav-plugin-admin/commit/6b343365996ce838759d80fa3917d4d994f1aeb4\n\n# v1.2.9\n## 01/18/2017\n\n1. [](#improved)\n    * Added lang strings for `ALLOW_WEBSERVER_GZIP` in System configuration\n\n# v1.2.8\n## 01/17/2017\n\n1. [](#improved)\n    * Allow the ability to clear the cache if `admin.maintenance`, as stated in the docs [#908](https://github.com/getgrav/grav-plugin-admin/issues/908)\n    * Added lang strings for `DEFAULT_LANG` in Site configuration\n    * Added lang strings for `NEVER_CACHE_TWIG` in System and Page configuration\n1. [](#bugfix)\n    * Fixed saving the configuration if not `admin.super`\n    * Show the clear cache buttons if the user has `admin.cache` permissions [#908](https://github.com/getgrav/grav-plugin-admin/issues/908#issuecomment-270748616)\n    * Fix colorpicker validation when transparency is set to 1.00 [#921](https://github.com/getgrav/grav-plugin-admin/issues/921)\n    * Fix html markup in section twig [#922](https://github.com/getgrav/grav-plugin-admin/pull/922)\n    * Fix bug in deleting a file uploaded with the `file` field [#920](github.com/getgrav/grav-plugin-admin/issues/920)\n    * Fix for plugin throwing event-based errors when plugin is removed and no longer available to process said event\n\n# v1.2.7\n## 12/22/2016\n\n1. [](#improved)\n    * Fixed an issue with non `.html` extensions not setting application type properly when fallback template not found.\n1. [](#bugfix)\n    * Fix plugins and themes json calls after the introduction of [HTML fallback for templates not found](https://github.com/getgrav/grav/commit/364209a27da0f5dfba5fde9c4b07b6d5844cda47)\n\n\n# v1.2.6\n## 12/21/2016\n\n1. [](#improved)\n    * Added a delay before reloading the page when a plugin or theme get installed\n    * Fix prompting to remove Grav itself when removing a package that requires a specific Grav version\n    * Remove cli-server exception since we now have compatibility with a custom router in Grav [#1219](https://github.com/getgrav/grav/pull/1219)\n1. [](#bugfix)\n    * Fix issue with array field and `value_only: true`\n\n# v1.2.5\n## 12/13/2016\n\n1. [](#new)\n    * RC released as stable\n1. [](#bugfix)\n    * YAML syntax fixes\n\n# v1.2.5-rc.4\n## 12/07/2016\n\n1. [](#new)\n    * Added a new `permissions` form field, used in the user profile to simplify editing permissions\n    * Added several new `onAdminAfter...()` events to allow for more 3rd party plugin interaction\n1. [](#bugfix)\n    * Updated admin-user-details to allow longer user names in the sidebar [#879](https://github.com/getgrav/grav-plugin-admin/issues/879)\n    * Redirect to a 404 page when accessing nonexistent plugins and themes [#880](https://github.com/getgrav/grav-plugin-admin/issues/880)\n\n# v1.2.5-rc.3\n## 11/26/2016\n\n1. [](#bugfix)\n    * Update class namespace for Admin class [#874](https://github.com/getgrav/grav-plugin-admin/issues/874)\n    * Fix updating/installing packages from admin\n\n# v1.2.5-rc.2\n## 11/19/2016\n\n1. [](#bugfix)\n    * Make default value work for filepicker [#859](https://github.com/getgrav/grav-plugin-admin/issues/859)\n\n# v1.2.5-rc.1\n## 11/09/2016\n\n1. [](#new)\n    * Updated to FontAwesome 4.7.0 with [Grav icon](http://fontawesome.io/icon/grav/)\n1. [](#improved)\n    * Always delete image alternatives in AdminController#taskDelmedia [#814](https://github.com/getgrav/grav-plugin-admin/issues/814)\n    * Use Media class to retrieve files in AdminController#taskGetFilesInFolder [#842](https://github.com/getgrav/grav-plugin-admin/issues/842)\n    * Increased specificity for Colorpicker field to prevent 3rd party conflicts\n1. [](#bugfix)\n    * Editor link button doesn't prefix links with `http://` anymore [#813](https://github.com/getgrav/grav-plugin-admin/issues/813)\n    * Dashboard Charts now always refresh no matter what [#753](https://github.com/getgrav/grav-plugin-admin/issues/753)\n    * Use rawRoute for parent too when saving [#843](https://github.com/getgrav/grav-plugin-admin/issues/843)\n    * Avoid different output when users exist or not in password recovery [#849](https://github.com/getgrav/grav/issues/849)\n    * Fix login to admin with permission inherited from group [#857](https://github.com/getgrav/grav-plugin-admin/issues/857)\n\n\n# v1.2.4\n## 10/22/2016\n\n1. [](#bugfix)\n    * Fix for accented media files [#833](https://github.com/getgrav/grav-plugin-admin/issues/833)\n    * Fix for `CTRL + s` not saving in editor [#832](https://github.com/getgrav/grav-plugin-admin/pull/832)\n    * Fix for missing REDIS translations in admin [#1123](https://github.com/getgrav/grav/issues/1123)\n\n# v1.2.3\n## 10/19/2016\n\n1. [](#new)\n    * Added new `onAdminCreatePageFrontmatter()` event to support plugins such as `auto-date` by allowing frontmatter to be modified by plugins.\n    * Added a new independent `cache_enabled` option for admin plugin (default is `false`). Should fix various sync issues.\n    * Add an `onAdminData` event to allow plugins to add additional blueprints data\n1. [](#improved)\n    * Handle errors when a resource fails to install\n    * Page media and File field images thumbnail are now properly proportionate and 150x100\n    * Added the Codeception testing suite with an initial test\n1. [](#bugfix)\n    * Fix [#1034](https://github.com/getgrav/grav/issues/1034) redirect of page creation procedure when system.home.hide_in_urls is enabled\n    * Media (Page): Do not extend parent metehod for sending files since Safari and IE API for FormData don\u2019t implement `delete` ([#772](https://github.com/getgrav/grav-plugin-admin/issues/772))\n    * Clean up POST keys containing square brackets, allows for regex ranges in routes ([#776](https://github.com/getgrav/grav-plugin-admin/issues/776))\n    * Fix [#773](https://github.com/getgrav/grav-plugin-admin/issues/773) allow filepicker work inside lists, respond to mutation event\n    * Better error handling for Feed when unable to connect\n    * Fixed UI for Pagemedia note when files cannot yet be uploaded ([#798](https://github.com/getgrav/grav-plugin-admin/issues/798))\n    * Fixed Submit buttons getting disabled in case of form invalidity disallowing to submit again ([#802](https://github.com/getgrav/grav-plugin-admin/issues/802))\n    * Fixed issue when reading the file size setting if set to `0` (in Pagemedia and File fields)\n    * Fixed issue with `file` field in collections that caused unexpected duplication of items ([#775](https://github.com/getgrav/grav-plugin-admin/issues/775))\n    * Dramatically improved `filepicker` performance. Data is only ever loaded when the drop-down is on focus, as it was supposed to be. Image preview of a selected item won't be rendered unless the field gains focus to avoid wasting resources. ([#788](https://github.com/getgrav/grav-plugin-admin/issues/788))\n    * Allow `filepicker` field to peak at the pending uploaded files and optimistically select them ([#792](https://github.com/getgrav/grav-plugin-admin/issues/792))\n    * Fix [#821](https://github.com/getgrav/grav-plugin-admin/issues/821) issue in saving a page to a new language when the filename does not contain the filename yet.\n\n# v1.2.2\n## 09/08/2016\n\n1. [](#bugfix)\n    * Fix [#767](https://github.com/getgrav/grav-plugin-admin/issues/767) Add styling for new HTML5 input field types\n    * Fix issue with checking the package dependencies when more than one package is being inspected\n\n# v1.2.1\n## 09/07/2016\n\n1. [](#bugfix)\n    * Fixed `tmp://` stream issue with Admin updated to 1.2 before Grav updated 1.1.4\n\n# v1.2.0\n## 09/07/2016\n\n1. [](#new)\n    * All new `file` field. All files get uploaded via Ajax and are stored upon Save. This improves the Save task tremendously as now there is no longer the need of waiting for the files to finish uploading. Fully backward compatible, `file` field now includes also a `limit` and `filesize` option in the blueprints. The former determines how many files are allowed to be uploaded when in combination with `multiple: true` (default: 10), the latter determines the file size limit (in MB) allowed for each file (default: 5MB)\n    * Added a new `filepicker` field, which allows to pick any file from an ajax-powered select box. The `pagemediaselect` field now internally uses the `filepicker` field to live-reload the available files, and to show image previews.\n1. [](#improved)\n    * Better error handling for 500 Internal Server Errors, when Fetch fails\n    * Various notifications style and other CSS fixes\n    * More language strings added\n    * Added `clear-tmp` to cache clear drop-down\n    * Unified JSON twig templates\n    * Better error handling for 500 Internal Server Errors, when Fetch fails.\n    * Updated vendor Libraries\n1. [](#bugfix)\n    * Curl fix for invalid cert errors with News Feed\n    * Avoid requiring `admin.super` for ajax calls [#739](https://github.com/getgrav/grav-plugin-admin/issues/739)\n    * Fix showing HTML in notifications, in the feed\n    * Fixed broken page type filtering\n    * Fixed `beforeunload` event not prompting to offer the choice to stay on the page in case of unsaved changes\n    * Fixed click-away detection for preventing loss of changes, that would get ignored in some circumstances (ie, from modal confirmation)\n    * Fixed issue with `_json` elements where nested fields merging would get stored in an unexpected way\n    * Fixed composer dependencies missing error message\n\n# v1.1.4\n## 08/14/2016\n\n1. [](#bugfix)\n    * Fixed Firefox News Feed dashboard widget layout\n\n# v1.1.3\n## 08/10/2016\n\n1. [](#new)\n    * Admin notifications system.  Admin will pull and cache notifications.  This will be used to announce important updates, security vulnerabilities, and general interest news.\n    * Ability to disable widgets in the dashboard\n    * Added news feed widget to the dashboard\n1. [](#improved)\n    * Updated FontAwesome to v4.6.3\n    * Use new List functionality for Media Configuration\n    * Get fresh media list for `Controller::getListMedia()` rather that cache so always latest.\n    * Add translation strings for the new system.force_ssl option\n    * Reworked List UI to better handle drag & drop sort. To sort it is now required to use the left drag handle [#724](https://github.com/getgrav/grav-plugin-admin/issues/724)\n    * Lists now features a new YAML option `controls: [top|bottom|both]` (default: bottom) which will display the \"Add Item\" button at the Top and/or Bottom position relative to the list. When the Top button is pressed, a new item will be added at the beginning of the list, when the Bottom button is pressed, a new item will be appended to the list.\n    * Lists now features two new YAML options `sortby: [field]` (default: disabled) and `sortby_dir: [asc|desc]` (default: asc) which will display a new Sorting button in the list allowing to automatically reindex the collection based on the given sort field set.\n    * Lists now features a new YAML option `collapsed: [true|false]` (default: false) and a new UI/UX that allows for collapsing / expanding collection items, allowing to better managing long lists of items. It is advised to always put as first field the most significant one, so that when a list is collapsed it can be still easily browsed.\n    * It is now possible to sort Array fields via drag & drop [#950](https://github.com/getgrav/grav/issues/950)\n1. [](#bugfix)\n    * Fixed issue in Admin favicon URL [#704](https://github.com/getgrav/grav-plugin-admin/issues/704)\n    * Fixed issue in `selfupgrade` where the package would get downloaded in the wrong destination\n    * Hide tab when user is not authorized to access it [#712](https://github.com/getgrav/grav-plugin-admin/issues/712)\n    * Fixed Lists issue when reindexing, causing Radio fields to potentially lose their `checked` status\n    * Avoid overwriting a file when uploaded with the same filename through the Admin blueprint `file` field type if `avoid_overwriting` is enabled on the field\n    * Fixed issue with Array field in `value_only` mode, improperly displaying the key when no value was set\n    * Translate the description of a blueprint field [#729](https://github.com/getgrav/grav-plugin-admin/issues/729)\n\n# v1.1.2\n## 07/16/2016\n\n1. [](#improved)\n    * Forcing limit of upload files based on System settings\n1. [](#bugfix)\n    * Definitive fix for multi form submission in Microsoft Edge causing the Save to not work [#694](https://github.com/getgrav/grav-plugin-admin/issues/694)\n    * Fix issue with calculating the `theme_url` with `open_basedir` restrictions [#699](https://github.com/getgrav/grav-plugin-admin/issues/699)\n    * Check for null payload before going on [#526](https://github.com/getgrav/grav-plugin-admin/issues/526)\n    * Redraw Dashboard Charts when collapsing/expanding the sidebar\n    * Fix for `cache/compiled` errors resulting from page media uploads [getgrav/grav#938](https://github.com/getgrav/grav/issues/938)\n\n# v1.1.1\n## 07/14/2016\n\n1. [](#bugfix)\n    * Fixed issue with forms causing creation of new pages not to work [#698](https://github.com/getgrav/grav-plugin-admin/issues/698) and [getgrav/grav#934](https://github.com/getgrav/grav/issues/934)\n\n# v1.1.0\n## 07/14/2016\n\n1. [](#improved)\n    * Added the ability to login with the email in addition to the username. [#674](https://github.com/getgrav/grav-plugin-admin/issues/674)\n    * It is now possible to sort the Plugins and Themes views by 'Name', 'Author', 'GravTeam', 'Release Date', 'Updates Available' and 'Testing' releases (if in Testing Channel), both Ascending and Descending. [#583](https://github.com/getgrav/grav-plugin-admin/issues/583)\n    * Prevent external links (like the Preview button) to trigger the \"Changes Detected\" notice [#689](https://github.com/getgrav/grav-plugin-admin/issues/689)\n    * Added a filter field in Plugins and Themes list views, to allow for quick search of a particular resource\n    * Added new `Enabled` sorting option for Plugins list view\n1. [](#bugfix)\n    * Fixed an issue that prevented removing more than one page, in the pages listng [#672](https://github.com/getgrav/grav-plugin-admin/issues/672)\n    * Fixed toggleables in lists that were always loading as checked even when not stored [#688](https://github.com/getgrav/grav-plugin-admin/issues/688)\n    * Fixed Fullscreen tooltip in Editor displaying off screen (when in fullscreen mode) [#677](https://github.com/getgrav/grav-plugin-admin/issues/677)\n    * Fixed inconsistency in the way selectized fields would be rendered [#692](https://github.com/getgrav/grav-plugin-admin/issues/692)\n    * Fixed issue with Save in Microsoft Edge [#694](https://github.com/getgrav/grav-plugin-admin/issues/694)\n\n# v1.1.0-rc.4\n## 06/21/2016\n\n1. [](#bugfix)\n    * Fix for 'front-end' shortcut showing in mobile sidebar incorrectly.\n    * Append progressive number to the copied page title. [#394](https://github.com/getgrav/grav-plugin-admin/issues/394)\n    * Add field description to forms [#667](https://github.com/getgrav/grav-plugin-admin/pull/667)\n    * Fix clearing all cache [#658](https://github.com/getgrav/grav-plugin-admin/issues/658)\n    * Assign the correct ordering when saving a page that didn't have ordering set before [#628](https://github.com/getgrav/grav-plugin-admin/issues/628)\n    * Fix issue when saving a modular child folder as 05.somethin and being reset to 01.something upon save [#628](https://github.com/getgrav/grav-plugin-admin/issues/628)\n\n# v1.1.0-rc.3\n## 06/14/2016\n\n1. [](#bugfix)\n    * Fix for Gemini Scrollbar CSS breaking layout in IE 9+ [#644](https://github.com/getgrav/grav-plugin-admin/issues/644)\n    * Fall back to english for UI language if admin's language is not set [#641](https://github.com/getgrav/grav-plugin-admin/issues/641)\n    * List field has the wrong label/field width.  Switched to \"1/3 | 2/3\" like all other fields.\n    * Correctly set the page slug on page copy. Avoids having two pages with the same slug [#394](https://github.com/getgrav/grav-plugin-admin/issues/394)\n    * When copying a page, if there's a page prefix (used for ordering), update the value to avoid having two pages with the same order number [#429](https://github.com/getgrav/grav-plugin-admin/issues/429)\n    * Fixed size of dropdown text in responsive views to be readable [#647](https://github.com/getgrav/grav-plugin-admin/issues/647)\n    * Fixed issue with checkbox in toggleables getting submitted with the form even when disabled (fixes #646)\n\n# v1.1.0-rc.2\n## 06/02/2016\n\n1. [](#improved)\n    * Cleaned up the Page Preview CSS to make it more 'standard' [#634](https://github.com/getgrav/grav-plugin-admin/issues/634)\n    * Added a legend with the Page colors explained [#637](https://github.com/getgrav/grav-plugin-admin/issues/637)\n    * Hide email output when sending forgot password instructions [#571](https://github.com/getgrav/grav-plugin-admin/issues/571)\n1. [](#bugfix)\n    * Fixed \"Data type `System` doesn't exist!\" error when activating a theme [#635](https://github.com/getgrav/grav-plugin-admin/issues/635)\n    * Fixed issue with custom media types not deleting on save [#633](https://github.com/getgrav/grav-plugin-admin/issues/633)\n    * Fixed issue when saving `List` field type in plugins + pages\n    * Fixed JS error on login/logout page due to jQuery not being loaded\n\n\n# v1.1.0-rc.1\n## 06/01/2016\n\n1. [](#new)\n    * Major improvements with the **File Upload** (`file`) field type.  Now fully supports themes, plugins, configuration + pages\n1. [](#improved)\n    * Updated with latest languages via [Crowdin](https://crowdin.com/project/grav-admin/)\n    * Provide security options for single tabs [#615](https://github.com/getgrav/grav-plugin-admin/issues/615)\n    * Disable double clicking on Save/Delete/Copy page actions [#611](https://github.com/getgrav/grav-plugin-admin/issues/611)\n    * Tweaked the avatar alignment in sidebar [#592](https://github.com/getgrav/grav-plugin-admin/issues/592)\n    * Added page name to delete dialog [#511](https://github.com/getgrav/grav-plugin-admin/issues/511)\n    * Enabling / Disabling a Plugin doesn't trigger the expand / collapse details anymore [#614](https://github.com/getgrav/grav-plugin-admin/issues/614)\n    * Added hover on plugins list rows to match pages [#619](https://github.com/getgrav/grav-plugin-admin/issues/619)\n    * Translate media configuration [#608](https://github.com/getgrav/grav-plugin-admin/issues/608)\n    * Use raw routes in blueprints to better support multi-language [#798](https://github.com/getgrav/grav-plugin-admin/issues/798)\n    * Updated NPM modules dependencies\n1. [](#bugfix)\n    * Fix double \"Removed successfully\" appearing when removing a package [#609](https://github.com/getgrav/grav-plugin-admin/issues/609)\n    * Prevent removing required plugins dependencies when removing a package [#613](https://github.com/getgrav/grav-plugin-admin/issues/613)\n    * Show page title in Delete Confirmation modal if this information is available\n    * Don't try to uninstall admin/form/login/email plugins\n    * Only check for updates if not `admin.maintenance` or `admin.super` [#557](https://github.com/getgrav/grav-plugin-admin/issues/557)\n    * Always submit checkboxes that are not checked and force a 0 value [#616](https://github.com/getgrav/grav-plugin-admin/issues/616)\n    * Fix encoding in tooltips again [#622](https://github.com/getgrav/grav-plugin-admin/issues/622)\n    * Do not show `move` cursor for Collections that aren't sortable [#624](https://github.com/getgrav/grav-plugin-admin/issues/624)\n    * Properly handle Collections that specify a custom key, rather than falling back to indexed list [#632](https://github.com/getgrav/grav-plugin-admin/issues/632)\n\n# v1.1.0-beta.5\n## 05/23/2016\n\n1. [](#improved)\n    * Set sidebar navigation defaults back to \"Tab Activation\" and \"Auto Width\"\n    * Custom logo text is displayed as first letter in small sidebar view [#829](https://github.com/getgrav/grav/issues/829)\n    * Copied admin-only blueprints from Grav core to the Admin plugin\n    * Allow `field.label` to have HTML in it [#601](https://github.com/getgrav/grav-plugin-admin/issues/601)\n1. [](#bugfix)\n    * Fixed Togggle field with doubled `checked=\"checked\"` when `toggleable: true` [#579](https://github.com/getgrav/grav-plugin-admin/issues/579)\n    * Strip HTML tags and lowercase username from login/reset forms [#577](https://github.com/getgrav/grav-plugin-admin/issues/577)\n    * Fixed issue with version numbers not showing up for dependencies [#581](https://github.com/getgrav/grav-plugin-admin/issues/581)\n    * Fixed editor tooltips in fullscreen mode and tablet devices rendering [#566](https://github.com/getgrav/grav-plugin-admin/issues/566)\n    * Fixed issue with `file` form field not functioning [#838](https://github.com/getgrav/grav/issues/838)\n    * Fixed issue with creating pages [#595](https://github.com/getgrav/grav-plugin-admin/issues/595)\n\n# v1.1.0-beta.4\n## 05/09/2016\n\n1. [](#new)\n    * Implemented Quickopen functionality to automatically open / close the Sidebar when mouseover\n1. [](#improved)\n    * Better error handling when `obj->validate()` fails with exception [#594](https://github.com/getgrav/grav-plugin-admin/issues/564)\n    * Improve markup of update and add package dependencies in update modal [#560](https://github.com/getgrav/grav-plugin-admin/issues/560)\n1. [](#bugfix)\n    * Fix for admin translation filter (`|tu`) not substituting text - [#567](https://github.com/getgrav/grav-plugin-admin/issues/567)\n    * Translated \"Publishing\" tab text [#561](https://github.com/getgrav/grav-plugin-admin/issues/561)\n    * Fix invalid argument supplied in foreach [#563](https://github.com/getgrav/grav-plugin-admin/issues/563)\n    * CSS fixes for editor button alignment\n    * Fix for forgot password not finding anyone\n    * Fix UI issue with update button on a package page in Firefox\n    * Fix issue with update button when automatic check for updates is disabled\n    * Fix issue caused by clicking \"Check for updates\" multiple times\n    * Added missing translations\n    * Fix for Themes with an array of keywords [#823](https://github.com/getgrav/grav/issues/823)\n\n# v1.1.0-beta.3\n## 05/04/2016\n\n1. [](#new)\n    * Added a `|adminNicetime` Twig filter to show 'nicetime' in admin user's language\n    * Added a `prepend` and `append` field option for text input type\n    * Added a WIP `onAdminRegisterPermissions` event\n    * Added several new languages: Arabic, Danish, Greek, Farsi, Korean, Romanian, Thai. Huge thanks to the [translation teams](https://crowdin.com/project/grav-admin)\n1. [](#improved)\n    * Fixed UI issue with Backup / Update buttons positioning\n    * Tweaked placeholders color in login/new user panels [#542](https://github.com/getgrav/grav-plugin-admin/issues/542)\n1. [](#bugfix)\n    * Fixed several untranslated strings\n    * Fix the version information after updating Grav from Admin\n    * Fix a Twig autoescape issue on Plugins descriptions\n    * Fix for showing empty drop-down with only one supported language [#522](https://github.com/getgrav/grav-plugin-admin/issues/522)\n    * Fix for visibility toggle on new page not working [#551](https://github.com/getgrav/grav-plugin-admin/issues/551)\n    * Page tooltips usability issue [#496](https://github.com/getgrav/grav-plugin-admin/issues/496)\n    * Fix removed title attribute from editor toolbar buttons [#539](https://github.com/getgrav/grav-plugin-admin/issues/539)\n    * Allow Incognito / Private browsing to still function in Safari [#527](https://github.com/getgrav/grav-plugin-admin/issues/527)\n\n# v1.1.0-beta.2\n## 04/27/2016\n\n1. [](#new)\n    * Added `grav ~1.1` to dependencies\n    * Added a persistent message if you try to run Admin 1.1 on Grav 1.0\n1. [](#improved)\n    * Used locator instead of `CACHE_DIR`\n    * Added a better way to get Admin version\n    * Show account page for users with certain ACL [#524](https://github.com/getgrav/grav-plugin-admin/pull/524)\n1. [](#bugfix)\n    * Fixed Editor Preview using wrong parameters for the ajax call\n    * Fixed toggle for stable/testing channel\n    * Fixed blueprint JSON fields\n    * If not logged in redirect to base path [#445](https://github.com/getgrav/grav-plugin-admin/pull/445)\n    * Various autoescape fixes\n    * ColorPicker CSS fixes\n    * Fix for translation of admin login [#500](https://github.com/getgrav/grav-plugin-admin/issues/500)\n    * Fix list not applying `toggleable: true` and `style: vertical` [#518](https://github.com/getgrav/grav-plugin-admin/pull/518)\n    * Fixed issue with update for wrong plugin displaying on plugin details pages\n    * Fixed error with the **close sidebar** toggle in some browsers (Firefox, iOS Safari)\n\n# v1.1.0-beta.1\n## 04/20/2016\n\n1. [](#new)\n    * JavaScript Rewrite. Admin is now built in ES6\n    * Lists can now be nested and 'fancy fields' (such as editor, datetime picker, selectize, other lists) get automatically initialized so they are always available no matter if you add or remove items from the lists\n    * The Editor has been reworked to be more flexible. In fact you can now pass any CodeMirror setting via blueprints, through the codemirror: attribute. The buttons have also a new API that allow to add or ignore buttons and behaviors into the toolbar from any plugin (see grav-plugin-editor-buttons). We also added the headers buttons (H1-H6) and Undo / Redo buttons, due to popular demand\n    * We introduced a new colorpicker field. You can now add more colors to your admin plugins :)\n    * Along with the versioning support added in the Grav Core for 1.1, the admin plugin can now install dependencies with the same versioning requirements as the GPM CLI commands.\n    * New System configuration field for toggling GPM release version (testing/stable)\n    * Several new system configuration options for new functionality such as `Process frontmatter Twig`\n    * Ability to collapse the sidebar to a smaller icon view if you need more room.\n1. [](#improved)\n    * The default Grav theme has been tweaked and in many places completely rewritten to ensure that it's as flexible as possible. The primary reason for this was to ensure theming and customization compatibility for the upcoming Admin Pro plugin, but a key benefit includes greatly improved mobile compatibility.\n    * We reworked the Datetimepicker, you will notice a new refreshed UI with a much better support for translations\n    * Tabs are now persistent. In views such as Page editing, when switching tab and saving or refreshing, would cause the tab to be reset to the initial one.\n    * When editing a page in Expert mode, the frontmatter editor is now more friendly. You will now get line numbers, undo/redo and YAML linter.\n    * Behind the scenes we have reworked how the form and toggleables work. This added a lot more reliability and consistency across the whole admin.\n    * The Pages view has more persistent states. It will now remember your expanded/collapsed states as well as filtering.\n    * Lists can now accept a custom button label with the 'btnLabel' property\n    * After login to Admin, redirect to the original URL called\n    * Admin now has an unique cache key compared to the 'site' so pages can be cached independently\n    * Improved the layout of the User Profile page.\n    * Set cache key uniquely for admin so cache does not colide with site\n1. [](#bugfix)\n    * Fix for modular preview - [#254](https://github.com/getgrav/grav-plugin-admin/issues/254)\n    * Fix for long content and page tabs - [#441](https://github.com/getgrav/grav-plugin-admin/issues/441)\n    * Fix for clear cache after adding new folder - [#393](https://github.com/getgrav/grav-plugin-admin/issues/393)\n\n# v1.0.9\n## 02/11/2016\n\n1. [](#bugfix)\n    * Fix language translation files\n\n# v1.0.8\n## 02/05/2016\n\n1. [](#new)\n    * Added a logout button when not authorized to access a page in Admin\n    * Added the option to hide a tab from an extended blueprint (https://github.com/getgrav/grav/issues/620)\n    * Many new languages and updates to existing languages from the Translation team.\n1. [](#improved)\n    * Check frontmatter for validity prior to saving\n    * Add noindex, nofollow across the entire admin theme if no other robots headers are set on a page\n    * Allow to hide a configuration blueprint section / tab and still save its values\n    * Allow to show user defined blueprints in configuration\n    * Updated FontAwesome to latest 4.5.0 version\n1. [](#bugfix)\n    * Fixed an issue with user registration on Linux caused by `glob()` possibly returning false.\n    * Fixed an issue preventing Admin to work correctly in a multisite configuration\n    * Fixed preview and insertion of images with non-lowercase extension\n    * Fixed an incorrect number of pages being displayed in the sidebar in some cases\n    * [Security] Don't reveal Grav filesystem path when trying to delete non-existing images\n    * [Security] Fix PHP error happening when uploading file without extension if the JS dropzone uploader is configured to allow empty file extensions\n    * [Security] Ensure correct escaping in various Twig files\n\n# v1.0.7\n## 01/15/2016\n\n1. [](#new)\n    * Added onAdminDashboard event\n    * Added onAdminSave event\n    * New lang strings for reverse proxy toggle\n1. [](#improved)\n    * More robust YAML file checking in config folders\n    * Removed deprecated menu event\n    * Removed old logs code\n    * Used new onAdminDashboard event for current dashboard widgets\n1. [](#bugfix)\n    * Fix for missing access checks on config pages #397\n    * Fix parent not loaded on admin form save #587\n    * When no route field is added to a page blueprint, add it as page root\n    * Fix for wrong page count (will show dynamic added pages in count too - Need to fix this)\n    * Fix for IE/Edge saving forms #391\n\n# v1.0.6\n## 01/07/2016\n\n1. [](#bugfix)\n    * Fix for forms appending `_json` fields on every save\n\n# v1.0.5\n## 01/07/2016\n\n1. [](#new)\n    * Added a pointer to Grav's contributing guide\n    * Handle the optional logic to strip home from Page routes and urls\n    * The Configuration page now shows any blueprint found in the user/blueprints/config/ folder, thus allowing to add custom configurations\n1. [](#improved)\n    * Allow the nonce for a POST action to be set in the query url\n    * Add a fallback twig template to use in case Twig cannot find a template file\n    * Modified update Theme and Plugin buttons to use more reliably markup\n1. [](#bugfix)\n    * Fix additional `on` parameter when saving plugins configs that contain tabs in their blueprint\n    * Fixes for the `pagemediaselect` form field\n    * Fix an untranslated message in the logout form when `system.languages.translations` is disabled\n    * Fixed a hardcoded `http://` reference throwing warnings under HTTPS\n    * Ensure download package has `.zip` extension, just in case\n\n# v1.0.4\n## 12/22/2015\n\n1. [](#improved)\n    * Improved File input field for admin\n    * Restore file inputs functionality and process form via JS if no inputs found\n1. [](#bugfix)\n    * Fix for the image preview in the file field on multi-lang sites\n    * Fix problem in form code introduced by fix to allow file uploads\n    * Fix redirect in deleting page media\n\n# v1.0.3\n## 12/20/2015\n\n1. [](#new)\n    * Added `pagemediaselect` field for use in pages\n1. [](#improved)\n    * Updated various languages\n    * Check for method `meetsRequirements()` prior to using\n    * Enable `file` form field to be used in plugins and theme blueprints\n\n# v1.0.2\n## 12/18/2015\n\n1. [](#bugfix)\n    * Fixed issue with user edit page causing error due to individual language files\n\n# v1.0.1\n## 12/18/2015\n\n1. [](#new)\n    * Moved languages into individual files under `languages/` folder\n    * Added a check for PHP version\n    * Dutch translation added\n1. [](#improved)\n    * Let forms work with file inputs\n    * Various file input improvements\n    * Language updates\n    * Better checks for existence of Popularity JSON data\n    * Add file processing to admin forms\n    * More Admin Pro integration fixes\n1. [](#bugfix)\n    * Set form to multipart if it contains a file field\n    * `cleanFilesData()` now returns just the filename\n\n# v1.0.0\n## 12/11/2015\n\n1. [](#new)\n    * New built-in admin registration process\n    * Added security check to `section` form field\n    * Added new RocketTheme font with various icons\n    * Add `onAdminThemeInitialized()` event to admin `Themes::init()`\n    * Force timestamp on CSS/JS assets based on `GRAV_VERSION`\n    * Additions for Gantry5 support\n1. [](#improved)\n    * Force lowercase `username` when logging in\n    * Hide markdown preview except for pages\n    * Added a notice if you don't have permission to see dashboard\n    * Updated admin login page logic\n    * Return \"Invalid Security Token\" instead of \"Unauthorized\"\n    * Throw exception if you used with built-in PHP web server\n    * Updated languages\n    * Removed `noreply@getgrav.org` default email address\n    * Use new methods to disable CSS/JS pipeline if available\n    * Various code cleanups\n1. [](#bugfix)\n    * Handle case when email `from` is not configured\n    * Fix tabs support in plugin/themes settings\n    * Fix param separator in page media Ajax call\n    * Fix favicon base URL\n\n# v1.0.0-rc.7\n## 12/01/2015\n\n1. [](#new)\n    * Display error page if page does not exist in admin\n    * Removed Beta message option and added toggle for GitHub message\n    * Added functionality to support Admin Pro plugin (in development)\n1. [](#improved)\n    * Added support for Markdown editor in lists #239\n    * Better Markdown Editor API with dynamic initialization\n    * Various language updates\n    * Removed some unused variables\n    * Added admin check for pages existence\n    * Prevent the admin to cause an error when an Ajax action is in progress\n    * Force translations to be active even when disabled in site #299\n    * Do not reinitialize `Selectize` if already available\n1. [](#bugfix)\n    * Fixed full-screen markdown Editor\n    * Fix modular preview not working reliably #254\n    * **Nonce fixes** (hopefully the last of them!)\n    * Fix broken plugin enable/disable\n    * Fix issue where `_redirect: /plugins` was getting stored in the plugin configuration\n    * Replace default them service with admin one\n    * Fix saving array fields #304\n    * Fix missing translations when default language is not english\n    * Fix title variables not translated #310\n\n# v1.0.0-rc.6\n## 11/21/2015\n\n1. [](#improved)\n    * Implemented logic to detect when offline and suppress Ajax calls\n    * Added nonce logic to be used by JS\n1. [](#bugfix)\n    * Nonce fix for updating themes\n    * Nonce fix for deleting pages\n\n# v1.0.0-rc.5\n## 11/20/2015\n\n1. [](#new)\n    * Use **Nonce** mechanism for form security\n    * Added Hungarian translation\n    * Add support for Markdown labels #271\n    * Added support for Markdown Editor in all the things\n    * Implemented save keyboard shortcut (Ctrl + S / CMD + S)\n1. [](#improved)\n    * Better error for \"Internal Server Error\" when accessing GPM\n    * Updated French translation\n    * Updated Russian translation\n    * Load Gravatar image with protocol-less `//:` syntax\n    * Improved header UI in mobile browsers #265\n    * Dropped unused version of JQuery\n    * More visible Preview link icon\n    * Hide **Latest pages** if there are none\n    * Improved toggle to better support different length strings\n1. [](#bugfix)\n    * Force rescanning fields when submitting a form #243\n    * Set default lang for pages on fresh session\n    * Escaped values in `array.html.twig`\n    * Fix saving in IE Edge\n    * Fixed various typos\n    * Fixed JS button issues #370\n    * Fixed JS error in private browsing #272\n    * Fixed date field border\n    * Fixed multiple instance of Markdown Editor #285\n    * Fixed Spacer CSS #267\n\n# v1.0.0-rc.4\n## 10/29/2015\n\n1. [](#improved)\n    * Changed admin menu event hook to `onAdminMenu()`\n    * Minor improvements for admin page location\n    * Additional lang strings for Grav 1.0.0-rc.3\n\n# v1.0.0-rc.3\n## 10/27/2015\n\n1. [](#improved)\n    * Rely on context-language for active language\n    * Improved some Russian translations\n    * Only show login if not already logged in\n1. [](#bugfix)\n    * Disable asset pipeline in admin only\n    * Fix Editor cursor insertion point when text is selected in some actions\n\n# v1.0.0-rc.2\n## 10/23/2015\n\n1. [](#bugfix)\n    * Reverted lang redirect code. Needs to be reworked to be more reliable\n\n# v1.0.0-rc.1\n## 10/23/2015\n\n1. [](#new)\n    * Redirect to non-language URL except for `pages/`\n1. [](#improved)\n    * New language strings for new `system.yaml` fields\n    * Improved Russian translations\n    * Improved compatibility with PECL Yaml parser\n1. [](#bugfix)\n    * Redirect to correct page if you change folder/slug\n    * Fix issue with Asset pipeline not being disabled in admin\n    * Fix for HTML in text input fields\n    * Fixed various icons in headers\n\n# v0.6.2\n## 10/15/2015\n\n1. [](#improved)\n    * Use `title` rather than `menu` in Page listing\n    * Wrapped language strings in double-quotes\n    * New language strings for new fields\n1. [](#bugfix)\n    * Fixed issue with IE not able to save pages\n\n# v0.6.1\n## 10/07/2015\n\n1. [](#new)\n    * Added the ability to render front-end templates in markdown preview\n    * Option to disable Google-based fonts. Useful for Cyrillic languages.\n    * Couple of new static helper methods used by new page blueprints\n    * New `fieldset` form field (thanks @Sommerregen!)\n1. [](#improved)\n    * Hide editor buttons in preview mode\n    * Improved support for admin when offline\n    * Use relative URL in Login form\n    * Added some more missing lang strings\n    * Improved German translation\n    * Compressed CSS files for improved performance\n    * Only get last 7 days in week count calculation\n1. [](#bugfix)\n    * Fix saving pages in local-specific languages\n    * Only track 'human' page hits in statistics\n    * Responsive fixes for 'wordy' languages\n    * Fixed delete issue with array field type\n    * Fixed some hardcoded `admin` references to allow admin path change\n    * Fix for issue with lang code being added twice\n    * Fix language name in admin buttons\n\n# v0.6.0\n## 09/16/2015\n\n1. [](#new)\n    * Support for custom markdown editor buttons!\n    * Added Russian translations\n    * Added Japanese translations\n    * Ajax session keep-alive when editing forms\n1. [](#improved)\n    * Added missing Italian translations\n    * Added additional options field into the pages form field\n1. [](#bugfix)\n    * Fix GPM errors in offline mode\n    * Fix for duplicate status messages\n\n# v0.5.0\n## 09/11/2015\n\n1. [](#new)\n    * Responsive layout for mobile compatibility (thanks @Vivalldi!)\n    * Added page type and many other new filters to Page list view\n    * Added granular ACL requirements to admin pages\n    * Ability to define page date format\n    * Added `onAdminTemplateNavPluginHook` to allow for plugins to hook into sidebar\n    * Added YAML Twig filters (to and from)\n    * Support for nested metadata\n    * Added ability to disable automatic update checks via admin plugin configuration\n    * Initial Spanish translation\n1. [](#improved)\n    * Check for existence of a user account\n    * Various language additions\n    * Refactored form fields to remove duplicates from form plugin\n    * Improved date picker\n    * Improved display field\n    * Add page template type to page list view\n    * Various UI fixes\n    * Added some default field 'focus' to save clicking\n    * Only allow \"Add Modular\" if the theme has modular templates\n    * Updated `chartist.js` library\n    * Updated 'fontawesome' fonts to the latest v4.4\n1. [](#bugfix)\n    * Fix for \"drag-n-drop\" of non-image media\n    * Fix a fatal error in GPM when offline\n    * Fix a z-index bug with tooltips\n    * Fix a z-index bug in lang dropdowns\n    * Don't allow deleting of last empty array field\n    * Fix for images with parenthesis in filenames\n    * Fix for page title visualization when not set\n    * Fix for cursor position in folder/array fields\n\n# v0.4.3\n## 08/31/2015\n\n1. [](#new)\n    * Added Japanese translation\n    * Support for independent file name and template override\n1. [](#improved)\n    * Improved slug generation using `slugify.js`\n    * Allow the `title` twig variables to set the page title\n    * Improved Page media handling with several bugfixes\n    * Prevent error when there are no pages on a site\n    * If all updates are applied, show \"Fully Updated\" text in dashboard\n    * Better preview link (requires `rtrim` filter from Grav 0.9.40)\n    * Order all plugins and themes alphabetically\n    * Removed duplicate language entries\n1. [](#bugfix)\n    * Fix for redirect after saving when multilang not enabled\n    * Fix for deleting responsive media\n    * Fix for HTML encoding in markdown field\n\n# v0.4.2\n## 08/25/2015\n\n1. [](#bugfix)\n    * Fix for current admin lang not showing up in page lang dropdown\n    * Fix for incorrect NAME/CONTENT lang keys\n    * Fix for incorrect site link\n\n# v0.4.1\n## 08/24/2015\n\n1. [](#bugfix)\n    * Fix for broken **Add Page** - Doh!\n    * Fix for empty site link when at root\n\n# v0.4.0\n## 08/24/2015\n\n1. [](#new)\n    * Multi-language Page support!!!\n    * Admin languages configurable per user\n    * Toastr messages for `check updates`\n    * new `tu` filter for admin translations\n    * Italian and German admin translations\n    * Added a save location in system and site configuration\n    * Page metadata now uses flexible array field\n1. [](#improved)\n    * Allow subpages of modular pages to display in pages list\n    * Open external pages in new tabs\n    * Reworked `visibility` of pages\n    * Use `PLUGIN_ADMIN` prefix for translations\n    * Added link to gravatar.com to avoid confusion on avatar\n    * Limit page count to 200 in ordering field\n    * Fixed various Safari _flex_ issues\n    * Use `rawRoute()` for page links\n    * Minor `param separator` fixes\n    * Various CSS fixes\n    * Improved CodeMirror to force spaces\n    * Added **Selectize** dropdowns to various forms and modals\n1. [](#bugfix)\n    * Fix for `Call to a member function path() on non-object` error\n    * Fixed dropdown z-index issues\n    * Correctly set the filename including language if set\n    * Fix for empty taxonomies on page save\n    * Fix for page not redirecting properly on folder change\n    * Fix for table headers styling\n    * Added missing translation strings\n    * Unique page counting in total page counts\n    * Fixed JS warning with page filtering and deleting\n\n\n# v0.3.0\n## 08/11/2015\n\n1. [](#new)\n    * Show current date in form date format fields\n    * Added a new **check for updates** button to flush GPM\n    * Added session timeout configuration for admin\n    * Added `isSymlink` logic for Grav\n    * Added new `phpinfo` page\n1. [](#improved)\n    * Improved toggleables\n    * Support `param_separator` for Apache on windows\n    * Logout now goes to interstitial to provide session messages\n    * Updated hints and improved formatting\n    * Encoding URI for images in editor preview\n    * Create user `system.yaml` and `site.yaml` if they are missing\n    * Open external links in new tab by default\n    * Set edit mode to `normal` by default\n    * Disable CSS/JS pipelining in the admin\n1. [](#bugfix)\n    * Fixed form submission not working in IE\n    * Fix fatal error when deleting homepage\n    * Prevent admin plugin activating when the URL of a page contains partial route\n\n# v0.2.0\n## 08/06/2015\n\n1. [](#new)\n    * Added multiple **clear cache** types\n    * Added back to themes link when adding new themes\n    * Properly handles visibility and ordering and guesses best option on new\n    * Added new templates field with support for custom (unsupported) template type\n    * Added new display field for displaying simple text value\n    * **Update Grav** button now works\n    * Added spanish translation\n    * Added german translation\n1. [](#improved)\n    * Improved page order handling logic\n    * Implemented 2-step theme switching logic with warning\n    * Force `modular` page class for modular template\n    * Clear page cache on page delete (ghost pages still showing)\n    * Clears route on page save so changes such as `slug` are picked up\n    * Fix dashboard layout in Safari\n    * Added tooltips for official 'Team Grav' themes/plugins\n1. [](#bugfix)\n    * Handle modular page templates on create\n    * Fixed Firefox JS error for arrays\n    * Ensure we don't change page type to empty and save (causing page to be deleted)\n    * Fixed some minor CSS issues with editor\n    * Fixed link to RocketTheme.com\n    * Disabled fields now stay properly disabled\n\n# v0.1.1\n## 08/04/2015\n\n1. [](#bugfix)\n    * Fixed GitHub URLs\n    * Hiding toggle for disabling Admin plugin\n    * Removed extra text not needed\n\n# v0.1.0\n## 08/04/2015\n\n1. [](#new)\n    * ChangeLog started...\n", "<?php\n\nnamespace Grav\\Plugin\\Admin;\n\nuse Grav\\Common\\Cache;\nuse Grav\\Common\\Config\\Config;\nuse Grav\\Common\\Data\\Data;\nuse Grav\\Common\\Debugger;\nuse Grav\\Common\\Filesystem\\Folder;\nuse Grav\\Common\\Grav;\nuse Grav\\Common\\Media\\Interfaces\\MediaInterface;\nuse Grav\\Common\\Page\\Interfaces\\PageInterface;\nuse Grav\\Common\\Page\\Media;\nuse Grav\\Common\\Security;\nuse Grav\\Common\\Uri;\nuse Grav\\Common\\User\\Interfaces\\UserInterface;\nuse Grav\\Common\\Utils;\nuse Grav\\Common\\Plugin;\nuse Grav\\Common\\Theme;\nuse Grav\\Framework\\Controller\\Traits\\ControllerResponseTrait;\nuse Grav\\Framework\\RequestHandler\\Exception\\RequestException;\nuse JsonException;\nuse Psr\\Http\\Message\\ResponseInterface;\nuse Psr\\Http\\Message\\ServerRequestInterface;\nuse RocketTheme\\Toolbox\\Event\\Event;\nuse RocketTheme\\Toolbox\\File\\File;\nuse RocketTheme\\Toolbox\\ResourceLocator\\UniformResourceLocator;\n\n/**\n * Class AdminController\n *\n * @package Grav\\Plugin\n */\nclass AdminBaseController\n{\n    use ControllerResponseTrait;\n\n    /** @var Grav */\n    public $grav;\n    /** @var string */\n    public $view;\n    /** @var string */\n    public $task;\n    /** @var string */\n    public $route;\n    /** @var array */\n    public $post;\n    /** @var array|null */\n    public $data;\n    /** @var array */\n    public $blacklist_views = [];\n\n    /** @var Uri */\n    protected $uri;\n    /** @var Admin */\n    protected $admin;\n    /** @var string */\n    protected $redirect;\n    /** @var int */\n    protected $redirectCode;\n\n    /** @var string[] */\n    protected $upload_errors = [\n        0 => 'There is no error, the file uploaded with success',\n        1 => 'The uploaded file exceeds the max upload size',\n        2 => 'The uploaded file exceeds the MAX_FILE_SIZE directive that was specified in the HTML',\n        3 => 'The uploaded file was only partially uploaded',\n        4 => 'No file was uploaded',\n        6 => 'Missing a temporary folder',\n        7 => 'Failed to write file to disk',\n        8 => 'A PHP extension stopped the file upload'\n    ];\n\n    /**\n     * Performs a task.\n     *\n     * @return bool True if the action was performed successfully.\n     */\n    public function execute()\n    {\n        if (null === $this->admin) {\n            $this->admin = $this->grav['admin'];\n        }\n\n        // Ignore blacklisted views.\n        if (in_array($this->view, $this->blacklist_views, true)) {\n            return false;\n        }\n\n        // Make sure that user is logged into admin.\n        if (!$this->admin->authorize()) {\n            return false;\n        }\n\n        // Always validate nonce.\n        if (!$this->validateNonce()) {\n            return false;\n        }\n\n        $method = 'task' . ucfirst($this->task);\n\n        if (method_exists($this, $method)) {\n            try {\n                $response = $this->{$method}();\n            } catch (RequestException $e) {\n                /** @var Debugger $debugger */\n                $debugger = $this->grav['debugger'];\n                $debugger->addException($e);\n\n                $response = $this->createErrorResponse($e);\n            } catch (\\RuntimeException $e) {\n                /** @var Debugger $debugger */\n                $debugger = $this->grav['debugger'];\n                $debugger->addException($e);\n\n                $response = true;\n                $this->admin->setMessage($e->getMessage(), 'error');\n            }\n        } else {\n            $response = $this->grav->fireEvent('onAdminTaskExecute',\n                new Event(['controller' => $this, 'method' => $method]));\n        }\n\n        if ($response instanceof ResponseInterface) {\n            $this->close($response);\n        }\n\n        // Grab redirect parameter.\n        $redirect = $this->post['_redirect'] ?? null;\n        unset($this->post['_redirect']);\n\n        // Redirect if requested.\n        if ($redirect) {\n            $this->setRedirect($redirect);\n        }\n\n        return $response;\n    }\n\n    protected function validateNonce()\n    {\n        if (strtolower($_SERVER['REQUEST_METHOD']) === 'post') {\n            if (isset($this->post['admin-nonce'])) {\n                $nonce = $this->post['admin-nonce'];\n            } else {\n                $nonce = $this->grav['uri']->param('admin-nonce');\n            }\n\n            if (!$nonce || !Utils::verifyNonce($nonce, 'admin-form')) {\n                if ($this->task === 'addmedia') {\n\n                    $message = sprintf($this->admin::translate('PLUGIN_ADMIN.FILE_TOO_LARGE', null),\n                        ini_get('post_max_size'));\n\n                    //In this case it's more likely that the image is too big than POST can handle. Show message\n                    $this->admin->json_response = [\n                        'status'  => 'error',\n                        'message' => $message\n                    ];\n\n                    return false;\n                }\n\n                $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.INVALID_SECURITY_TOKEN'), 'error');\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.INVALID_SECURITY_TOKEN')\n                ];\n\n                return false;\n            }\n            unset($this->post['admin-nonce']);\n        } else {\n            if ($this->task === 'logout') {\n                $nonce = $this->grav['uri']->param('logout-nonce');\n                if (null === $nonce || !Utils::verifyNonce($nonce, 'logout-form')) {\n                    $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.INVALID_SECURITY_TOKEN'),\n                        'error');\n                    $this->admin->json_response = [\n                        'status'  => 'error',\n                        'message' => $this->admin::translate('PLUGIN_ADMIN.INVALID_SECURITY_TOKEN')\n                    ];\n\n                    return false;\n                }\n            } else {\n                $nonce = $this->grav['uri']->param('admin-nonce');\n                if (null === $nonce || !Utils::verifyNonce($nonce, 'admin-form')) {\n                    $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.INVALID_SECURITY_TOKEN'),\n                        'error');\n                    $this->admin->json_response = [\n                        'status'  => 'error',\n                        'message' => $this->admin::translate('PLUGIN_ADMIN.INVALID_SECURITY_TOKEN')\n                    ];\n\n                    return false;\n                }\n            }\n        }\n\n        return true;\n    }\n\n    /**\n     * Sets the page redirect.\n     *\n     * @param string $path The path to redirect to\n     * @param int    $code The HTTP redirect code\n     * @return void\n     */\n    public function setRedirect($path, $code = 303)\n    {\n        $this->redirect     = $path;\n        $this->redirectCode = $code;\n    }\n\n    /**\n     * Sends JSON response and terminates the call.\n     *\n     * @param array $json\n     * @param int $code\n     * @return never-return\n     */\n    protected function sendJsonResponse(array $json, $code = 200): void\n    {\n        // JSON response.\n        $response = $this->createJsonResponse($json, $code);\n\n        $this->close($response);\n    }\n\n    /**\n     * @param ResponseInterface $response\n     * @return never-return\n     */\n    protected function close(ResponseInterface $response): void\n    {\n        $this->grav->close($response);\n    }\n\n    /**\n     * Handles ajax upload for files.\n     * Stores in a flash object the temporary file and deals with potential file errors.\n     *\n     * @return bool True if the action was performed.\n     */\n    public function taskFilesUpload()\n    {\n        if (null === $_FILES || !$this->authorizeTask('upload file', $this->dataPermissions())) {\n            return false;\n        }\n\n        /** @var Config $config */\n        $config   = $this->grav['config'];\n        $data     = $this->view === 'pages' ? $this->admin->page(true) : $this->prepareData([]);\n        $settings = $data->blueprints()->schema()->getProperty($this->post['name']);\n        $settings = (object)array_merge([\n            'avoid_overwriting' => false,\n            'random_name'       => false,\n            'accept'            => ['image/*'],\n            'limit'             => 10,\n            'filesize'          => Utils::getUploadLimit()\n        ], (array)$settings, ['name' => $this->post['name']]);\n\n        $upload = $this->normalizeFiles($_FILES['data'], $settings->name);\n\n        $filename = $upload->file->name;\n\n        // Handle bad filenames.\n        if (!Utils::checkFilename($filename)) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => sprintf($this->admin::translate('PLUGIN_ADMIN.FILEUPLOAD_UNABLE_TO_UPLOAD', null),\n                    htmlspecialchars($filename, ENT_QUOTES | ENT_HTML5, 'UTF-8'), 'Bad filename')\n            ];\n\n            return false;\n        }\n\n        if (!isset($settings->destination)) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.DESTINATION_NOT_SPECIFIED', null)\n            ];\n\n            return false;\n        }\n\n        // Do not use self@ outside of pages\n        if ($this->view !== 'pages' && in_array($settings->destination, ['@self', 'self@', '@self@'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => sprintf($this->admin::translate('PLUGIN_ADMIN.FILEUPLOAD_PREVENT_SELF', null),\n                    htmlspecialchars($settings->destination, ENT_QUOTES | ENT_HTML5, 'UTF-8'))\n            ];\n\n            return false;\n        }\n\n        // Handle errors and breaks without proceeding further\n        if ($upload->file->error !== UPLOAD_ERR_OK) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => sprintf($this->admin::translate('PLUGIN_ADMIN.FILEUPLOAD_UNABLE_TO_UPLOAD', null),\n                    htmlspecialchars($filename, ENT_QUOTES | ENT_HTML5, 'UTF-8'),\n                    $this->upload_errors[$upload->file->error])\n            ];\n\n            return false;\n        }\n\n        // Handle file size limits\n        $settings->filesize *= 1048576; // 2^20 [MB in Bytes]\n        if ($settings->filesize > 0 && $upload->file->size > $settings->filesize) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.EXCEEDED_GRAV_FILESIZE_LIMIT')\n            ];\n\n            return false;\n        }\n\n        // Handle Accepted file types\n        // Accept can only be mime types (image/png | image/*) or file extensions (.pdf|.jpg)\n        $accepted = false;\n        $errors   = [];\n\n        // Do not trust mimetype sent by the browser\n        $mime = Utils::getMimeByFilename($filename);\n\n        foreach ((array)$settings->accept as $type) {\n            // Force acceptance of any file when star notation\n            if ($type === '*') {\n                $accepted = true;\n                break;\n            }\n\n            $isMime = strstr($type, '/');\n            $find   = str_replace(['.', '*', '+'], ['\\.', '.*', '\\+'], $type);\n\n            if ($isMime) {\n                $match = preg_match('#' . $find . '$#', $mime);\n                if (!$match) {\n                    $errors[] = htmlspecialchars('The MIME type \"' . $mime . '\" for the file \"' . $filename . '\" is not an accepted.', ENT_QUOTES | ENT_HTML5, 'UTF-8');\n                } else {\n                    $accepted = true;\n                    break;\n                }\n            } else {\n                $match = preg_match('#' . $find . '$#', $filename);\n                if (!$match) {\n                    $errors[] = htmlspecialchars('The File Extension for the file \"' . $filename . '\" is not an accepted.', ENT_QUOTES | ENT_HTML5, 'UTF-8');\n                } else {\n                    $accepted = true;\n                    break;\n                }\n            }\n        }\n\n        if (!$accepted) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => implode('<br />', $errors)\n            ];\n\n            return false;\n        }\n\n        // Remove the error object to avoid storing it\n        unset($upload->file->error);\n\n        // we need to move the file at this stage or else\n        // it won't be available upon save later on\n        // since php removes it from the upload location\n        $tmp_dir  = Admin::getTempDir();\n        $tmp_file = $upload->file->tmp_name;\n        $tmp      = $tmp_dir . '/uploaded-files/' . basename($tmp_file);\n\n        Folder::create(dirname($tmp));\n        if (!move_uploaded_file($tmp_file, $tmp)) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => sprintf(\n                    $this->admin::translate('PLUGIN_ADMIN.FILEUPLOAD_UNABLE_TO_MOVE', null),\n                    '',\n                    htmlspecialchars($tmp, ENT_QUOTES | ENT_HTML5, 'UTF-8')\n                )\n            ];\n\n            return false;\n        }\n\n        // Special Sanitization for SVG\n        if (Utils::contains($mime, 'svg', false)) {\n            Security::sanitizeSVG($tmp);\n        }\n\n        $upload->file->tmp_name = $tmp;\n\n        // Retrieve the current session of the uploaded files for the field\n        // and initialize it if it doesn't exist\n        $sessionField = base64_encode($this->grav['uri']->url());\n        $flash        = $this->admin->session()->getFlashObject('files-upload') ?? [];\n        if (!isset($flash[$sessionField])) {\n            $flash[$sessionField] = [];\n        }\n        if (!isset($flash[$sessionField][$upload->field])) {\n            $flash[$sessionField][$upload->field] = [];\n        }\n\n        // Set destination\n        if ($this->grav['locator']->isStream($settings->destination)) {\n            $destination = $this->grav['locator']->findResource($settings->destination, false, true);\n        } else {\n            $destination = Folder::getRelativePath(rtrim($settings->destination, '/'));\n            $destination = $this->admin->getPagePathFromToken($destination);\n        }\n\n        // Create destination if needed\n        if (!is_dir($destination)) {\n            Folder::mkdir($destination);\n        }\n\n        // Generate random name if required\n        if ($settings->random_name) { // TODO: document\n            $extension          = pathinfo($upload->file->name, PATHINFO_EXTENSION);\n            $upload->file->name = Utils::generateRandomString(15) . '.' . $extension;\n        }\n\n        // Handle conflicting name if needed\n        if ($settings->avoid_overwriting) { // TODO: document\n            if (file_exists($destination . '/' . $upload->file->name)) {\n                $upload->file->name = date('YmdHis') . '-' . $upload->file->name;\n            }\n        }\n\n        // Prepare object for later save\n        $path               = $destination . '/' . $upload->file->name;\n        $upload->file->path = $path;\n        // $upload->file->route = $page ? $path : null;\n\n        // Prepare data to be saved later\n        $flash[$sessionField][$upload->field][$path] = (array)$upload->file;\n\n        // Finally store the new uploaded file in the field session\n        $this->admin->session()->setFlashObject('files-upload', $flash);\n        $this->admin->json_response = [\n            'status'  => 'success',\n            'session' => \\json_encode([\n                'sessionField' => base64_encode($this->grav['uri']->url()),\n                'path'         => $upload->file->path,\n                'field'        => $settings->name\n            ])\n        ];\n\n        return true;\n    }\n\n    /**\n     * Checks if the user is allowed to perform the given task with its associated permissions\n     *\n     * @param string $task        The task to execute\n     * @param array  $permissions The permissions given\n     *\n     * @return bool True if authorized. False if not.\n     */\n    public function authorizeTask($task = '', $permissions = [])\n    {\n        if (!$this->admin->authorize($permissions)) {\n            if ($this->grav['uri']->extension() === 'json') {\n                $this->admin->json_response = [\n                    'status'  => 'unauthorized',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK') . ' ' . $task . '.'\n                ];\n            } else {\n                $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK') . ' ' . $task . '.',\n                    'error');\n            }\n\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * Checks if the user is allowed to perform the given task with its associated permissions.\n     * Throws exception if the check fails.\n     *\n     * @param string $task        The task to execute\n     * @param array  $permissions The permissions given\n     * @throws RequestException\n     */\n    public function checkTaskAuthorization($task = '', $permissions = [])\n    {\n        if (!$this->admin->authorize($permissions)) {\n            throw new RequestException($this->getRequest(), $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK') . ' ' . $task . '.', 403);\n        }\n    }\n\n    /**\n     * Gets the permissions needed to access a given view\n     *\n     * @return array An array of permissions\n     */\n    protected function dataPermissions()\n    {\n        $type        = $this->view;\n        $permissions = ['admin.super'];\n\n        switch ($type) {\n            case 'config':\n                $type = $this->route ?: 'system';\n                $permissions[] = 'admin.configuration.' . $type;\n                break;\n            case 'plugins':\n                $permissions[] = 'admin.plugins';\n                break;\n            case 'themes':\n                $permissions[] = 'admin.themes';\n                break;\n            case 'users':\n                $permissions[] = 'admin.users';\n                break;\n            case 'user':\n                $permissions[] = 'admin.login';\n                $permissions[] = 'admin.users';\n                break;\n            case 'pages':\n                $permissions[] = 'admin.pages';\n                break;\n            default:\n                $permissions[] = 'admin.configuration.' . $type;\n                $permissions[] = 'admin.configuration_' . $type;\n        }\n\n        return $permissions;\n    }\n\n    /**\n     * Gets the configuration data for a given view & post\n     *\n     * @param array $data\n     *\n     * @return array\n     */\n    protected function prepareData(array $data)\n    {\n        return $data;\n    }\n\n    /**\n     * Internal method to normalize the $_FILES array\n     *\n     * @param array  $data $_FILES starting point data\n     * @param string $key\n     *\n     * @return object a new Object with a normalized list of files\n     */\n    protected function normalizeFiles($data, $key = '')\n    {\n        $files        = new \\stdClass();\n        $files->field = $key;\n        $files->file  = new \\stdClass();\n\n        foreach ($data as $fieldName => $fieldValue) {\n            // Since Files Upload are always happening via Ajax\n            // we are not interested in handling `multiple=\"true\"`\n            // because they are always handled one at a time.\n            // For this reason we normalize the value to string,\n            // in case it is arriving as an array.\n            $value                     = (array)Utils::getDotNotation($fieldValue, $key);\n            $files->file->{$fieldName} = array_shift($value);\n        }\n\n        return $files;\n    }\n\n    /**\n     * Removes a file from the flash object session, before it gets saved\n     *\n     * @return bool True if the action was performed.\n     */\n    public function taskFilesSessionRemove()\n    {\n        if (!$this->authorizeTask('delete file', $this->dataPermissions())) {\n            return false;\n        }\n\n        // Retrieve the current session of the uploaded files for the field\n        // and initialize it if it doesn't exist\n        $sessionField = base64_encode($this->grav['uri']->url());\n        $request      = \\json_decode($this->post['session']);\n\n        // Ensure the URI requested matches the current one, otherwise fail\n        if ($request->sessionField !== $sessionField) {\n            return false;\n        }\n\n        // Retrieve the flash object and remove the requested file from it\n        $flash    = $this->admin->session()->getFlashObject('files-upload') ?? [];\n        $endpoint = $flash[$request->sessionField][$request->field][$request->path] ?? null;\n\n        if (isset($endpoint)) {\n            if (file_exists($endpoint['tmp_name'])) {\n                unlink($endpoint['tmp_name']);\n            }\n\n            unset($endpoint);\n        }\n\n        // Walk backward to cleanup any empty field that's left\n        // Field\n        if (isset($flash[$request->sessionField][$request->field][$request->path])) {\n            unset($flash[$request->sessionField][$request->field][$request->path]);\n        }\n\n        // Field\n        if (isset($flash[$request->sessionField][$request->field]) && empty($flash[$request->sessionField][$request->field])) {\n            unset($flash[$request->sessionField][$request->field]);\n        }\n\n        // Session Field\n        if (isset($flash[$request->sessionField]) && empty($flash[$request->sessionField])) {\n            unset($flash[$request->sessionField]);\n        }\n\n\n        // If there's anything left to restore in the flash object, do so\n        if (count($flash)) {\n            $this->admin->session()->setFlashObject('files-upload', $flash);\n        }\n\n        $this->admin->json_response = ['status' => 'success'];\n\n        return true;\n    }\n\n    /**\n     * Redirect to the route stored in $this->redirect\n     *\n     * Route may or may not be prefixed by /en or /admin or /en/admin.\n     *\n     * @return void\n     */\n    public function redirect()\n    {\n        $this->admin->redirect($this->redirect, $this->redirectCode);\n    }\n\n    /**\n     * Prepare and return POST data.\n     *\n     * @param array $post\n     * @return array\n     */\n    protected function getPost($post)\n    {\n        if (!is_array($post)) {\n            return [];\n        }\n\n        unset($post['task']);\n\n        // Decode JSON encoded fields and merge them to data.\n        if (isset($post['_json'])) {\n            $post = array_replace_recursive($post, $this->jsonDecode($post['_json']));\n            unset($post['_json']);\n        }\n\n        return $this->cleanDataKeys($post);\n    }\n\n    /**\n     * Recursively JSON decode data.\n     *\n     * @param array $data\n     * @return array\n     * @throws JsonException\n     * @internal Do not use directly!\n     */\n    protected function jsonDecode(array $data): array\n    {\n        foreach ($data as &$value) {\n            if (is_array($value)) {\n                $value = $this->jsonDecode($value);\n            } else {\n                $value = json_decode($value, true, 512, JSON_THROW_ON_ERROR);\n            }\n        }\n\n        return $data;\n    }\n\n    /**\n     * @param array $source\n     * @return array\n     * @internal Do not use directly!\n     */\n    protected function cleanDataKeys(array $source): array\n    {\n        $out = [];\n        foreach ($source as $key => $value) {\n            $key = str_replace(['%5B', '%5D'], ['[', ']'], $key);\n            if (is_array($value)) {\n                $out[$key] = $this->cleanDataKeys($value);\n            } else {\n                $out[$key] = $value;\n            }\n        }\n\n        return $out;\n    }\n\n    /**\n     * Return true if multilang is active\n     *\n     * @return bool True if multilang is active\n     */\n    protected function isMultilang()\n    {\n        return count($this->grav['config']->get('system.languages.supported', [])) > 1;\n    }\n\n    /**\n     * @param PageInterface|UserInterface|Data $obj\n     *\n     * @return PageInterface|UserInterface|Data\n     */\n    protected function storeFiles($obj)\n    {\n        // Process previously uploaded files for the current URI\n        // and finally store them. Everything else will get discarded\n        $queue = $this->admin->session()->getFlashObject('files-upload');\n        if (is_array($queue)) {\n            $queue = $queue[base64_encode($this->grav['uri']->url())];\n            foreach ($queue as $key => $files) {\n                foreach ($files as $destination => $file) {\n                    if (!rename($file['tmp_name'], $destination)) {\n                        throw new \\RuntimeException(sprintf($this->admin->translate('PLUGIN_ADMIN.FILEUPLOAD_UNABLE_TO_MOVE',\n                            null), '\"' . $file['tmp_name'] . '\"', $destination));\n                    }\n\n                    unset($files[$destination]['tmp_name']);\n                }\n\n                if ($this->view === 'pages') {\n                    $keys     = explode('.', preg_replace('/^header./', '', $key));\n                    $init_key = array_shift($keys);\n                    if (count($keys) > 0) {\n                        $new_data = $obj->header()->{$init_key} ?? [];\n                        Utils::setDotNotation($new_data, implode('.', $keys), $files, true);\n                    } else {\n                        $new_data = $files;\n                    }\n                    if (isset($obj->header()->{$init_key})) {\n                        $obj->modifyHeader($init_key,\n                            array_replace_recursive([], $obj->header()->{$init_key}, $new_data));\n                    } else {\n                        $obj->modifyHeader($init_key, $new_data);\n                    }\n                } elseif ($obj instanceof UserInterface and $key === 'avatar') {\n                    $obj->set($key, $files);\n                } else {\n                    // TODO: [this is JS handled] if it's single file, remove existing and use set, if it's multiple, use join\n                    $obj->join($key, $files); // stores\n                }\n\n            }\n        }\n\n        return $obj;\n    }\n\n    /**\n     * Used by the filepicker field to get a list of files in a folder.\n     *\n     * @return bool\n     */\n    protected function taskGetFilesInFolder()\n    {\n        if (!$this->authorizeTask('get files', $this->dataPermissions())) {\n            return false;\n        }\n\n        $data = $this->view === 'pages' ? $this->admin->page(true) : $this->prepareData([]);\n\n        if (null === $data) {\n            return false;\n        }\n\n        if (method_exists($data, 'blueprints')) {\n            $settings = $data->blueprints()->schema()->getProperty($this->post['name']);\n        } elseif (method_exists($data, 'getBlueprint')) {\n            $settings = $data->getBlueprint()->schema()->getProperty($this->post['name']);\n        }\n\n        if (isset($settings['folder'])) {\n            $folder = $settings['folder'];\n        } else {\n            $folder = 'self@';\n        }\n\n        // Do not use self@ outside of pages\n        if ($this->view !== 'pages' && in_array($folder, ['@self', 'self@', '@self@'])) {\n            if (!$data instanceof MediaInterface) {\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => sprintf($this->admin::translate('PLUGIN_ADMIN.FILEUPLOAD_PREVENT_SELF', null), $folder)\n                ];\n\n                return false;\n            }\n\n            $media = $data->getMedia();\n        } else {\n            /** @var UniformResourceLocator $locator */\n            $locator = $this->grav['locator'];\n            if ($locator->isStream($folder)) {\n                $folder = $locator->findResource($folder);\n            }\n\n            // Set destination\n            $folder = Folder::getRelativePath(rtrim($folder, '/'));\n            $folder = $this->admin->getPagePathFromToken($folder);\n\n            $media = new Media($folder);\n        }\n\n        $available_files = [];\n        $metadata = [];\n        $thumbs = [];\n\n\n        foreach ($media->all() as $name => $medium) {\n\n           $available_files[] = $name;\n\n            if (isset($settings['include_metadata'])) {\n                $img_metadata = $medium->metadata();\n                if ($img_metadata) {\n                    $metadata[$name] = $img_metadata;\n                }\n            }\n\n        }\n\n        // Peak in the flashObject for optimistic filepicker updates\n        $pending_files = [];\n        $sessionField  = base64_encode($this->grav['uri']->url());\n        $flash         = $this->admin->session()->getFlashObject('files-upload');\n\n        if ($flash && isset($flash[$sessionField])) {\n            foreach ($flash[$sessionField] as $field => $data) {\n                foreach ($data as $file) {\n                    if (dirname($file['path']) === $folder) {\n                        $pending_files[] = $file['name'];\n                    }\n                }\n            }\n        }\n\n        $this->admin->session()->setFlashObject('files-upload', $flash);\n\n        // Handle Accepted file types\n        // Accept can only be file extensions (.pdf|.jpg)\n        if (isset($settings['accept'])) {\n            $available_files = array_filter($available_files, function ($file) use ($settings) {\n                return $this->filterAcceptedFiles($file, $settings);\n            });\n\n            $pending_files = array_filter($pending_files, function ($file) use ($settings) {\n                return $this->filterAcceptedFiles($file, $settings);\n            });\n        }\n\n        // Generate thumbs if needed\n        if (isset($settings['preview_images']) && $settings['preview_images'] === true) {\n            foreach ($available_files as $filename) {\n                $thumbs[$filename] = $media[$filename]->zoomCrop(100,100)->url();\n            }\n        }\n\n        $this->admin->json_response = [\n            'status'  => 'success',\n            'files'   => array_values($available_files),\n            'pending' => array_values($pending_files),\n            'folder'  => $folder,\n            'metadata' => $metadata,\n            'thumbs' => $thumbs\n        ];\n\n        return true;\n    }\n\n    /**\n     * @param string $file\n     * @param array $settings\n     * @return false\n     */\n    protected function filterAcceptedFiles($file, $settings)\n    {\n        $valid = false;\n\n        foreach ((array)$settings['accept'] as $type) {\n            $find = str_replace('*', '.*', $type);\n            $valid |= preg_match('#' . $find . '$#i', $file);\n        }\n\n        return $valid;\n    }\n\n    /**\n     * Handle deleting a file from a blueprint\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskRemoveFileFromBlueprint()\n    {\n        if (!$this->authorizeTask('remove file', $this->dataPermissions())) {\n            return false;\n        }\n\n        /** @var Uri $uri */\n        $uri       = $this->grav['uri'];\n        $blueprint = base64_decode($uri->param('blueprint'));\n        $path      = base64_decode($uri->param('path'));\n        $route     = base64_decode($uri->param('proute'));\n        $type      = $uri->param('type');\n        $field     = $uri->param('field');\n\n        $filename  = basename($this->post['filename'] ?? '');\n        if ($filename === '') {\n           $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => 'Filename is empty'\n            ];\n\n            return false;\n        }\n\n        // Get Blueprint\n        if ($type === 'pages' || strpos($blueprint, 'pages/') === 0) {\n            $page = $this->admin->page(true, $route);\n            if (!$page) {\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => 'Page not found'\n                ];\n\n                return false;\n            }\n            $blueprints = $page->blueprints();\n            $path = Folder::getRelativePath($page->path());\n            $settings = (object)$blueprints->schema()->getProperty($field);\n        } else {\n            $page = null;\n            if ($type === 'themes' || $type === 'plugins') {\n                $obj = $this->grav[$type]->get(Utils::substrToString($blueprint, '/')); //here\n                $settings = (object) $obj->blueprints()->schema()->getProperty($field);\n            } else {\n                $settings = (object)$this->admin->blueprints($blueprint)->schema()->getProperty($field);\n            }\n        }\n\n        // Get destination\n        if ($this->grav['locator']->isStream($settings->destination)) {\n            $destination = $this->grav['locator']->findResource($settings->destination, false, true);\n\n        } else {\n            $destination = Folder::getRelativePath(rtrim($settings->destination, '/'));\n            $destination = $this->admin->getPagePathFromToken($destination, $page);\n        }\n\n        // Not in path\n        if (!Utils::startsWith($path, $destination)) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => 'Path not valid for this data type'\n            ];\n\n            return false;\n        }\n\n        // Only remove files from correct destination...\n        $this->taskRemoveMedia($destination . '/' . $filename);\n\n        if ($page) {\n            $keys = explode('.', preg_replace('/^header./', '', $field));\n            $header = (array)$page->header();\n            $data_path = implode('.', $keys);\n            $data = Utils::getDotNotation($header, $data_path);\n\n            if (isset($data[$path])) {\n                unset($data[$path]);\n                Utils::setDotNotation($header, $data_path, $data);\n                $page->header($header);\n            }\n\n            $page->save();\n        } elseif ($type === 'user') {\n            $user = Grav::instance()['user'];\n            unset($user->avatar);\n            $user->save();\n        } else {\n\n            $blueprint_prefix = $type === 'config' ? '' : $type . '.';\n            $blueprint_name   = str_replace(['config/', '/blueprints'], '', $blueprint);\n            $blueprint_field  = $blueprint_prefix . $blueprint_name . '.' . $field;\n\n            $files            = $this->grav['config']->get($blueprint_field);\n\n            if ($files) {\n                foreach ($files as $key => $value) {\n                    if ($key == $path) {\n                        unset($files[$key]);\n                    }\n                }\n            }\n\n            $this->grav['config']->set($blueprint_field, $files);\n\n            switch ($type) {\n                case 'config':\n                    $data   = $this->grav['config']->get($blueprint_name);\n                    $config = $this->admin->data($blueprint, $data);\n                    $config->save();\n                    break;\n                case 'themes':\n                    Theme::saveConfig($blueprint_name);\n                    break;\n                case 'plugins':\n                    Plugin::saveConfig($blueprint_name);\n                    break;\n            }\n        }\n\n        Cache::clearCache('invalidate');\n\n        $this->admin->json_response = [\n            'status'  => 'success',\n            'message' => $this->admin::translate('PLUGIN_ADMIN.REMOVE_SUCCESSFUL')\n        ];\n\n        return true;\n    }\n\n    /**\n     * Handles removing a media file\n     *\n     * @note This task cannot be used anymore.\n     *\n     * @return bool True if the action was performed\n     */\n    public function taskRemoveMedia($filename = null)\n    {\n        if (!$this->canEditMedia()) {\n            return false;\n        }\n\n        if (null === $filename) {\n            throw new \\RuntimeException('Admin task RemoveMedia has been disabled.');\n        }\n\n        $file                  = File::instance($filename);\n        $resultRemoveMedia     = false;\n\n        if ($file->exists()) {\n            $resultRemoveMedia = $file->delete();\n\n            $fileParts = pathinfo($filename);\n\n            foreach (scandir($fileParts['dirname']) as $file) {\n                $regex_pattern = '/' . preg_quote($fileParts['filename'], '/') . \"@\\d+x\\.\" . $fileParts['extension'] . \"(?:\\.meta\\.yaml)?$|\" . preg_quote($fileParts['basename'], '/') . \"\\.meta\\.yaml$/\";\n                if (preg_match($regex_pattern, $file)) {\n                    $path = $fileParts['dirname'] . '/' . $file;\n                    @unlink($path);\n                }\n            }\n\n        }\n\n        if ($resultRemoveMedia) {\n            if ($this->grav['uri']->extension() === 'json') {\n                $this->admin->json_response = [\n                    'status'  => 'success',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.REMOVE_SUCCESSFUL')\n                ];\n            } else {\n                $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.REMOVE_SUCCESSFUL'), 'info');\n                $this->clearMediaCache();\n                $this->setRedirect('/media-manager');\n            }\n\n            return true;\n        }\n\n        if ($this->grav['uri']->extension() === 'json') {\n            $this->admin->json_response = [\n                'status'  => 'success',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.REMOVE_FAILED')\n            ];\n        } else {\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.REMOVE_FAILED'), 'error');\n        }\n\n        return false;\n    }\n\n    /**\n     * Handles clearing the media cache\n     *\n     * @return bool True if the action was performed\n     */\n    protected function clearMediaCache()\n    {\n        $key   = 'media-manager-files';\n        $cache = $this->grav['cache'];\n        $cache->delete(md5($key));\n\n        return true;\n    }\n\n    /**\n     * Determine if the user can edit media\n     *\n     * @param string $type\n     *\n     * @return bool True if the media action is allowed\n     */\n    protected function canEditMedia($type = 'media')\n    {\n        if (!$this->authorizeTask('edit media', ['admin.' . $type, 'admin.super'])) {\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * @param string $message\n     * @param string $type\n     * @return $this\n     */\n    protected function setMessage($message, $type = 'info')\n    {\n        $this->admin->setMessage($message, $type);\n\n        return $this;\n    }\n\n    /**\n     * @return Config\n     */\n    protected function getConfig(): Config\n    {\n        return $this->grav['config'];\n    }\n\n    /**\n     * @return ServerRequestInterface\n     */\n    protected function getRequest(): ServerRequestInterface\n    {\n        return $this->grav['request'];\n    }\n}\n", "<?php\n\nnamespace Grav\\Plugin\\Admin;\n\nuse Grav\\Common\\Backup\\Backups;\nuse Grav\\Common\\Cache;\nuse Grav\\Common\\Config\\Config;\nuse Grav\\Common\\Debugger;\nuse Grav\\Common\\File\\CompiledYamlFile;\nuse Grav\\Common\\Filesystem\\Folder;\nuse Grav\\Common\\Flex\\Types\\Pages\\PageIndex;\nuse Grav\\Common\\GPM\\GPM as GravGPM;\nuse Grav\\Common\\GPM\\Installer;\nuse Grav\\Common\\Grav;\nuse Grav\\Common\\Data;\nuse Grav\\Common\\Helpers\\Excerpts;\nuse Grav\\Common\\Language\\Language;\nuse Grav\\Common\\Page\\Interfaces\\PageInterface;\nuse Grav\\Common\\Page\\Media;\nuse Grav\\Common\\Page\\Medium\\ImageMedium;\nuse Grav\\Common\\Page\\Medium\\Medium;\nuse Grav\\Common\\Page\\Page;\nuse Grav\\Common\\Page\\Pages;\nuse Grav\\Common\\Page\\Collection;\nuse Grav\\Common\\Security;\nuse Grav\\Common\\User\\Interfaces\\UserCollectionInterface;\nuse Grav\\Common\\User\\Interfaces\\UserInterface;\nuse Grav\\Common\\Utils;\nuse Grav\\Framework\\Flex\\Flex;\nuse Grav\\Framework\\Psr7\\Response;\nuse Grav\\Framework\\RequestHandler\\Exception\\RequestException;\nuse Grav\\Plugin\\Login\\TwoFactorAuth\\TwoFactorAuth;\nuse Grav\\Common\\Yaml;\nuse PicoFeed\\Parser\\MalformedXmlException;\nuse Psr\\Http\\Message\\ResponseInterface;\nuse RocketTheme\\Toolbox\\Event\\Event;\nuse RocketTheme\\Toolbox\\File\\File;\nuse RocketTheme\\Toolbox\\ResourceLocator\\UniformResourceLocator;\nuse Twig\\Loader\\FilesystemLoader;\n\n/**\n * Class AdminController\n *\n * @package Grav\\Plugin\n */\nclass AdminController extends AdminBaseController\n{\n    /**\n     * @param Grav|null $grav\n     * @param string|null $view\n     * @param string|null $task\n     * @param string|null $route\n     * @param array|null $post\n     * @return void\n     */\n    public function initialize(Grav $grav = null, $view = null, $task = null, $route = null, $post = null)\n    {\n        $this->grav = $grav;\n        $this->admin = $this->grav['admin'];\n        $this->view = $view;\n        $this->task = $task ?: 'display';\n        if (isset($post['data'])) {\n            $this->data = $this->getPost($post['data']);\n            unset($post['data']);\n        } else {\n            // Backwards compatibility for Form plugin <= 1.2\n            $this->data = $this->getPost($post);\n        }\n        $this->post  = $this->getPost($post);\n        $this->route = $route;\n\n        $this->grav->fireEvent('onAdminControllerInit', new Event(['controller' => &$this]));\n    }\n\n    // GENERAL TASKS\n\n    /**\n     * Keep alive\n     *\n     * Route: POST /task:keepAlive (AJAX call)\n     *\n     * @return void\n     */\n    protected function taskKeepAlive(): void\n    {\n        // This task is available for all admin users.\n        $response = new Response(200);\n\n        $this->close($response);\n    }\n\n    /**\n     * Clear the cache.\n     *\n     * Route: GET /cache.json/task:clearCache (AJAX call)\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskClearCache()\n    {\n        if (!$this->authorizeTask('clear cache', ['admin.cache', 'admin.maintenance', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        // get optional cleartype param\n        $clear_type = $this->grav['uri']->param('cleartype');\n\n        if ($clear_type) {\n            $clear = $clear_type;\n        } else {\n            $clear = 'standard';\n        }\n\n        if ($clear === 'purge') {\n            $msg = Cache::purgeJob();\n            $this->admin->json_response = [\n                'status'  => 'success',\n                'message' => $msg,\n            ];\n        } else {\n            $results = Cache::clearCache($clear);\n            if (count($results) > 0) {\n                $this->admin->json_response = [\n                    'status'  => 'success',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.CACHE_CLEARED') . ' <br />' . $this->admin::translate('PLUGIN_ADMIN.METHOD') . ': ' . $clear . ''\n                ];\n            } else {\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.ERROR_CLEARING_CACHE')\n                ];\n            }\n        }\n\n        return true;\n    }\n\n    /**\n     * Handles form and saves the input data if its valid.\n     *\n     * Route: POST /pages?task:save\n     * Route: POST /user?task:save\n     * Route: POST /*?task:save\n     *\n     * @return bool True if the action was performed.\n     */\n    public function taskSave()\n    {\n        if (!$this->authorizeTask('save', $this->dataPermissions())) {\n            return false;\n        }\n\n        $this->grav['twig']->twig_vars['current_form_data'] = (array)$this->data;\n\n        switch ($this->view) {\n            case 'pages':\n                // Not used if Flex-Objects plugin handles pages.\n                return $this->savePage();\n            case 'user':\n                // Not used if Flex-Objects plugin handles users.\n                return $this->saveUser();\n            default:\n                if ($this->saveDefault()) {\n                    $route = $this->grav['uri']::getCurrentRoute();\n                    $this->setRedirect($route->withGravParam('task', null)->toString(), 302);\n                    $this->redirect();\n                }\n\n                return false;\n        }\n    }\n\n    /**\n     * @return bool\n     */\n    protected function saveDefault()\n    {\n        try {\n            // Handle standard data types.\n            $type = $this->getDataType();\n\n            $obj = $this->admin->getConfigurationData($type, $this->data);\n            $obj->validate();\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->setMessage($e->getMessage(), 'error');\n\n            return false;\n        }\n\n        $obj->filter(false, true);\n\n        $obj = $this->storeFiles($obj);\n\n        if ($obj) {\n            // Event to manipulate data before saving the object\n            $this->grav->fireEvent('onAdminSave', new Event(['object' => &$obj]));\n            $obj->save();\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_SAVED'), 'info');\n            $this->grav->fireEvent('onAdminAfterSave', new Event(['object' => $obj]));\n        }\n\n        Cache::clearCache('invalidate');\n\n        // Force configuration reload.\n        /** @var Config $config */\n        $config = $this->grav['config'];\n        $config->reload();\n\n        if ($this->view === 'config') {\n            $this->setRedirect($this->admin->getAdminRoute(\"/{$this->view}/{$this->route}\")->toString());\n        }\n\n        return true;\n    }\n\n    // USER TASKS\n\n    /**\n     * Handle logout.\n     *\n     * Route: GET /task:logout\n     * Route: POST ?task=logout\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskLogout()\n    {\n        if (!$this->authorizeTask('logout', ['admin.login', 'admin.super'])) {\n            return false;\n        }\n\n        $this->admin->logout($this->data, $this->post);\n    }\n\n    /**\n     * Route: POST /ajax.json/task:regenerate2FASecret (AJAX call)\n     *\n     * @return bool\n     */\n    public function taskRegenerate2FASecret()\n    {\n        if (!$this->authorizeTask('regenerate 2FA Secret', ['admin.login', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        try {\n            /** @var UserInterface $user */\n            $user = $this->grav['user'];\n\n            /** @var TwoFactorAuth $twoFa */\n            $twoFa = $this->grav['login']->twoFactorAuth();\n            $secret = $twoFa->createSecret();\n            $image = $twoFa->getQrImageData($user->username, $secret);\n\n            $user->set('twofa_secret', $secret);\n\n            // TODO: data user can also use save, but please test it before removing this code.\n            if ($user instanceof \\Grav\\Common\\User\\DataUser\\User) {\n                // Save secret into the user file.\n                $file = $user->file();\n                if ($file->exists()) {\n                    $content = (array)$file->content();\n                    $content['twofa_secret'] = $secret;\n                    $file->save($content);\n                    $file->free();\n                }\n            } else {\n                $user->save();\n            }\n\n            $this->admin->json_response = ['status' => 'success', 'image' => $image, 'secret' => preg_replace('|(\\w{4})|', '\\\\1 ', $secret)];\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->json_response = ['status' => 'error', 'message' => htmlspecialchars($e->getMessage(), ENT_QUOTES | ENT_HTML5, 'UTF-8')];\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * Save user account.\n     *\n     * Called by more general save task.\n     *\n     * @note Not used if Flex-Objects plugin handles users.\n     *\n     * @return bool\n     */\n    protected function saveUser()\n    {\n        /** @var UserCollectionInterface $users */\n        $users = $this->grav['accounts'];\n\n        $user = $users->load($this->admin->route);\n\n        if (!$this->admin->authorize(['admin.super', 'admin.users'])) {\n            // no user file or not admin.super or admin.users\n            if ($user->username !== $this->grav['user']->username) {\n                $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK') . ' save.','error');\n\n                return false;\n            }\n        }\n\n        /** @var Data\\Blueprint $blueprint */\n        $blueprint = $user->blueprints();\n        $data = $blueprint->processForm($this->admin->cleanUserPost((array)$this->data));\n        $data = new Data\\Data($data, $blueprint);\n\n        try {\n            $data->validate();\n            $data->filter();\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->setMessage($e->getMessage(), 'error');\n\n            return false;\n        }\n\n        $user->update($data->toArray());\n\n        $user = $this->storeFiles($user);\n\n        if ($user) {\n            // Event to manipulate data before saving the object\n            $this->grav->fireEvent('onAdminSave', new Event(['object' => &$user]));\n            $user->save();\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_SAVED'), 'info');\n            $this->grav->fireEvent('onAdminAfterSave', new Event(['object' => $user]));\n        }\n\n        if ($user->username === $this->grav['user']->username) {\n            /** @var UserCollectionInterface $users */\n            $users = $this->grav['accounts'];\n\n            //Editing current user. Reload user object\n            $this->grav['user']->undef('avatar');\n            $this->grav['user']->merge($users->load($this->admin->route)->toArray());\n        }\n\n        return true;\n    }\n\n    // DASHBOARD TASKS\n\n    /**\n     * Get Notifications\n     *\n     * Route: POST /task:getNotifications (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskGetNotifications()\n    {\n        if (!$this->authorizeTask('dashboard', ['admin.login', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        // do we need to force a reload\n        $refresh = $this->data['refresh'] === 'true';\n        $filter = $this->data['filter'] ?? '';\n        $filter_types = !empty($filter) ? array_map('trim', explode(',', $filter)) : [];\n\n        try {\n            $notifications = $this->admin->getNotifications($refresh);\n            $notification_data = [];\n\n            foreach ($notifications as $type => $type_notifications) {\n                if ($filter_types && in_array($type, $filter_types, true)) {\n                    $twig_template = 'partials/notification-' . $type . '-block.html.twig';\n                    $notification_data[$type] = $this->grav['twig']->processTemplate($twig_template, ['notifications' => $type_notifications]);\n                }\n            }\n\n            $json_response = [\n                'status'        => 'success',\n                'notifications' => $notification_data\n            ];\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $json_response = ['status' => 'error', 'message' => htmlspecialchars($e->getMessage(), ENT_QUOTES | ENT_HTML5, 'UTF-8')];\n        }\n\n        $this->sendJsonResponse($json_response);\n    }\n\n\n    /**\n     * Hide notifications.\n     *\n     * Route: POST /notifications.json/task:hideNotification/notification_id:ID (AJAX call)\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskHideNotification()\n    {\n        if (!$this->authorizeTask('hide notification', ['admin.login', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $notification_id = $this->grav['uri']->param('notification_id');\n\n        if (!$notification_id) {\n            $this->admin->json_response = [\n                'status' => 'error'\n            ];\n\n            return false;\n        }\n\n        $filename = $this->grav['locator']->findResource('user://data/notifications/' . $this->grav['user']->username . YAML_EXT, true, true);\n        $file     = CompiledYamlFile::instance($filename);\n        $data     = (array)$file->content();\n\n        $date = new \\DateTime();\n        $data[$notification_id] = $date->format('r');\n        $file->save($data);\n\n        $this->admin->json_response = [\n            'status' => 'success'\n        ];\n\n        return true;\n    }\n\n    /**\n     * Get Newsfeeds\n     *\n     * Route: POST /ajax.json/task:getNewsFeed (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskGetNewsFeed()\n    {\n        if (!$this->authorizeTask('dashboard', ['admin.login', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $refresh = $this->data['refresh'] === 'true' ? true : false;\n\n        try {\n            $feed = $this->admin->getFeed($refresh);\n            $feed_data = $this->grav['twig']->processTemplate('partials/feed-block.html.twig', ['feed' => $feed]);\n\n            $json_response = [\n                'status'    => 'success',\n                'feed_data' => $feed_data\n            ];\n        } catch (MalformedXmlException $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $json_response = ['status' => 'error', 'message' => htmlspecialchars($e->getMessage(), ENT_QUOTES | ENT_HTML5, 'UTF-8')];\n        }\n\n        $this->sendJsonResponse($json_response);\n    }\n\n    // BACKUP TASKS\n\n    /**\n     * Handle the backup action\n     *\n     * Route: GET /backup.json/id:BACKUP_ID/task:backup (AJAX call)\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskBackup()\n    {\n        if (!$this->authorizeTask('backup', ['admin.maintenance', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $param_sep = $this->grav['config']->get('system.param_sep', ':');\n        $download = $this->grav['uri']->param('download');\n\n        try {\n            if ($download) {\n                $filename = basename(base64_decode(urldecode($download)));\n                $file = $this->grav['locator']->findResource(\"backup://{$filename}\", true);\n                if (!$file || !Utils::endsWith($filename, '.zip', false)) {\n                    header('HTTP/1.1 401 Unauthorized');\n                    exit();\n                }\n\n                Utils::download($file, true);\n            }\n\n            $id = $this->grav['uri']->param('id', 0);\n            $backup = Backups::backup($id);\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->json_response = [\n                'status' => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.AN_ERROR_OCCURRED') . '. ' . htmlspecialchars($e->getMessage(), ENT_QUOTES | ENT_HTML5, 'UTF-8')\n            ];\n\n            return true;\n        }\n\n        $download = urlencode(base64_encode($backup));\n        $url = rtrim($this->grav['uri']->rootUrl(false), '/') . '/' . trim($this->admin->base,\n                '/') . '/task' . $param_sep . 'backup/download' . $param_sep . $download . '/admin-nonce' . $param_sep . Utils::getNonce('admin-form');\n\n        $this->admin->json_response = [\n            'status' => 'success',\n            'message' => $this->admin::translate('PLUGIN_ADMIN.YOUR_BACKUP_IS_READY_FOR_DOWNLOAD') . '. <a href=\"' . $url . '\" class=\"button\">' . $this->admin::translate('PLUGIN_ADMIN.DOWNLOAD_BACKUP') . '</a>',\n            'toastr' => [\n                'timeOut' => 0,\n                'extendedTimeOut' => 0,\n                'closeButton' => true\n            ]\n        ];\n\n        return true;\n    }\n\n    /**\n     * Handle delete backup action\n     *\n     * Route: GET /backup.json/backup:BACKUP_FILE/task:backupDelete (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskBackupDelete()\n    {\n        if (!$this->authorizeTask('backup', ['admin.maintenance', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $backup = $this->grav['uri']->param('backup', null);\n\n        if (null !== $backup) {\n            $filename = basename(base64_decode(urldecode($backup)));\n            $file = $this->grav['locator']->findResource(\"backup://{$filename}\", true);\n\n            if ($file && Utils::endsWith($filename, '.zip', false)) {\n                unlink($file);\n\n                $this->admin->json_response = [\n                    'status'  => 'success',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.BACKUP_DELETED'),\n                    'toastr'  => [\n                        'closeButton' => true\n                    ]\n                ];\n\n                return true;\n            }\n        }\n\n        $this->admin->json_response = [\n            'status'  => 'error',\n            'message' => $this->admin::translate('PLUGIN_ADMIN.BACKUP_NOT_FOUND'),\n        ];\n\n        return true;\n    }\n\n    // PLUGIN / THEME TASKS\n\n    /**\n     * Enable a plugin.\n     *\n     * Route: GET /plugins/SLUG/task:enable\n     *\n     * @return bool True if the action was performed.\n     */\n    public function taskEnable()\n    {\n        if ($this->view !== 'plugins') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('enable plugin', ['admin.plugins', 'admin.super'])) {\n            return false;\n        }\n\n        // Filter value and save it.\n        $this->post = ['enabled' => true];\n        $obj        = $this->prepareData($this->post);\n        $obj->save();\n\n        $this->post = ['_redirect' => 'plugins'];\n        if ($this->grav['uri']->param('redirect')) {\n            $this->post = ['_redirect' => 'plugins/' . $this->route];\n        }\n        $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_ENABLED_PLUGIN'), 'info');\n\n        Cache::clearCache('invalidate');\n\n        return true;\n    }\n\n    /**\n     * Disable a plugin.\n     *\n     * Route: GET /plugins/SLUG/task:disable\n     *\n     * @return bool True if the action was performed.\n     */\n    public function taskDisable()\n    {\n        if ($this->view !== 'plugins') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('disable plugin', ['admin.plugins', 'admin.super'])) {\n            return false;\n        }\n\n        // Filter value and save it.\n        $this->post = ['enabled' => false];\n        $obj        = $this->prepareData($this->post);\n        $obj->save();\n\n        $this->post = ['_redirect' => 'plugins'];\n        $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_DISABLED_PLUGIN'), 'info');\n\n        Cache::clearCache('invalidate');\n\n        return true;\n    }\n\n    /**\n     * Set the default theme.\n     *\n     * Route: GET /themes/SLUG/task:activate\n     *\n     * @return bool True if the action was performed.\n     */\n    public function taskActivate()\n    {\n        if ($this->view !== 'themes') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('activate theme', ['admin.themes', 'admin.super'])) {\n            return false;\n        }\n\n        $this->post = ['_redirect' => 'themes' ];\n\n        // Make sure theme exists (throws exception)\n        $name = $this->route;\n        $this->grav['themes']->get($name);\n\n        // Store system configuration.\n        $system = $this->admin->getConfigurationData('config/system');\n        $system->set('pages.theme', $name);\n        $system->save();\n\n        // Force configuration reload and save.\n        /** @var Config $config */\n        $config = $this->grav['config'];\n        $config->reload()->save();\n\n        $config->set('system.pages.theme', $name);\n\n        $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_CHANGED_THEME'), 'info');\n\n        Cache::clearCache('invalidate');\n\n        $this->post = ['_redirect' => 'themes/' . $name ];\n\n        return true;\n    }\n\n    // INSTALL & UPGRADE\n\n    /**\n     * Handles updating Grav\n     *\n     * Route: GET /update.json/task:updategrav (AJAX call)\n     *\n     * @return bool False if user has no permissions.\n     */\n    public function taskUpdategrav()\n    {\n        if (!$this->authorizeTask('install grav', ['admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $gpm     = Gpm::GPM();\n        $version = $gpm->grav->getVersion();\n        $result  = Gpm::selfupgrade();\n\n        if ($result) {\n            $json_response = [\n                'status'  => 'success',\n                'type'    => 'updategrav',\n                'version' => $version,\n                'message' => $this->admin::translate('PLUGIN_ADMIN.GRAV_WAS_SUCCESSFULLY_UPDATED_TO') . ' ' . $version\n            ];\n        } else {\n            $json_response = [\n                'status'  => 'error',\n                'type'    => 'updategrav',\n                'version' => GRAV_VERSION,\n                'message' => $this->admin::translate('PLUGIN_ADMIN.GRAV_UPDATE_FAILED') . ' <br>' . Installer::lastErrorMsg()\n            ];\n        }\n\n        $this->sendJsonResponse($json_response);\n    }\n\n    /**\n     * Handles uninstalling plugins and themes\n     *\n     * @return bool True if the action was performed\n     * @deprecated Not being used anymore\n     */\n    public function taskUninstall()\n    {\n        $type = $this->view;\n        if ($type !== 'plugins' && $type !== 'themes') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('uninstall ' . $type, ['admin.' . $type, 'admin.super'])) {\n            return false;\n        }\n\n        $package = $this->route;\n\n        $result = Gpm::uninstall($package, []);\n\n        if ($result) {\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.UNINSTALL_SUCCESSFUL'), 'info');\n        } else {\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.UNINSTALL_FAILED'), 'error');\n        }\n\n        $this->post = ['_redirect' => $this->view];\n\n        return true;\n    }\n\n    /**\n     * Toggle the gpm.releases setting\n     *\n     * Route: POST /ajax.json/task:gpmRelease (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskGpmRelease()\n    {\n        if (!$this->authorizeTask('configuration', ['admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        // Default release state\n        $release = 'stable';\n        $reload  = false;\n\n        // Get the testing release value if set\n        if ($this->post['release'] === 'testing') {\n            $release = 'testing';\n        }\n\n        $config          = $this->grav['config'];\n        $current_release = $config->get('system.gpm.releases');\n\n        // If the releases setting is different, save it in the system config\n        if ($current_release !== $release) {\n            $data = new Data\\Data($config->get('system'));\n            $data->set('gpm.releases', $release);\n\n            // Get the file location\n            $file = CompiledYamlFile::instance($this->grav['locator']->findResource('config://system.yaml'));\n            $data->file($file);\n\n            // Save the configuration\n            $data->save();\n            $config->reload();\n            $reload = true;\n        }\n\n        $this->admin->json_response = ['status' => 'success', 'reload' => $reload];\n\n        return true;\n    }\n\n    /**\n     * Get update status from GPM\n     *\n     * Request: POST /update.json/task:getUpdates (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskGetUpdates()\n    {\n        if ($this->view !== 'update') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('dashboard', ['admin.plugins', 'admin.themes', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $data  = $this->post;\n        $flush = !empty($data['flush']);\n\n        if (isset($this->grav['session'])) {\n            $this->grav['session']->close();\n        }\n\n        try {\n            $gpm = new GravGPM($flush);\n\n            $resources_updates = $gpm->getUpdatable();\n            foreach ($resources_updates as $key => $update) {\n                if (!is_iterable($update)) {\n                    continue;\n                }\n\n                foreach ($update as $slug => $item) {\n                    $resources_updates[$key][$slug] = $item;\n                }\n            }\n\n            if ($gpm->grav !== null) {\n                $grav_updates = [\n                    'isUpdatable' => $gpm->grav->isUpdatable(),\n                    'assets'      => $gpm->grav->getAssets(),\n                    'version'     => GRAV_VERSION,\n                    'available'   => $gpm->grav->getVersion(),\n                    'date'        => $gpm->grav->getDate(),\n                    'isSymlink'   => $gpm->grav->isSymlink()\n                ];\n\n                $this->admin->json_response = [\n                    'status'  => 'success',\n                    'payload' => [\n                        'resources' => $resources_updates,\n                        'grav'      => $grav_updates,\n                        'installed' => $gpm->countInstalled(),\n                        'flushed'   => $flush\n                    ]\n                ];\n            } else {\n                $this->admin->json_response = ['status' => 'error', 'message' => 'Cannot connect to the GPM'];\n\n                return false;\n            }\n\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->json_response = ['status' => 'error', 'message' => htmlspecialchars($e->getMessage(), ENT_QUOTES | ENT_HTML5, 'UTF-8')];\n\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * Handle getting a new package dependencies needed to be installed.\n     *\n     * Route: /plugins.json/task:getPackagesDependencies (AJAX call)\n     * Route: /themes.json/task:getPackagesDependencies (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskGetPackagesDependencies()\n    {\n        $type = $this->view;\n        if ($type !== 'plugins' && $type !== 'themes') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('get package dependencies', ['admin.' . $type, 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $data     = $this->post;\n        $packages = isset($data['packages']) ? explode(',', $data['packages']) : '';\n        $packages = (array)$packages;\n\n        try {\n            $this->admin->checkPackagesCanBeInstalled($packages);\n            $dependencies = $this->admin->getDependenciesNeededToInstall($packages);\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->json_response = ['status' => 'error', 'message' => htmlspecialchars($e->getMessage(), ENT_QUOTES | ENT_HTML5, 'UTF-8')];\n\n            return false;\n        }\n\n        $this->admin->json_response = ['status' => 'success', 'dependencies' => $dependencies];\n\n        return true;\n    }\n\n    /**\n     * Route: /plugins.json/task:installDependenciesOfPackages (AJAX call)\n     * Route: /themes.json/task:installDependenciesOfPackages (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskInstallDependenciesOfPackages()\n    {\n        $type = $this->view;\n        if ($type !== 'plugins' && $type !== 'themes') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('install dependencies', ['admin.' . $type, 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $data = $this->post;\n        $packages = isset($data['packages']) ? explode(',', $data['packages']) : '';\n        $packages = (array)$packages;\n\n        try {\n            $dependencies = $this->admin->getDependenciesNeededToInstall($packages);\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->json_response = ['status' => 'error', 'message' => htmlspecialchars($e->getMessage(), ENT_QUOTES | ENT_HTML5, 'UTF-8')];\n\n            return false;\n        }\n\n        $result = Gpm::install(array_keys($dependencies), ['theme' => $type === 'themes']);\n\n        if ($result) {\n            $this->admin->json_response = ['status' => 'success', 'message' => 'Dependencies installed successfully'];\n        } else {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSTALLATION_FAILED')\n            ];\n        }\n\n        return true;\n    }\n\n    /**\n     * Route: /plugins.json/task:installPackage (AJAX call)\n     * Route: /themes.json/task:installPackage (AJAX call)\n     *\n     * @param bool $reinstall\n     * @return bool\n     */\n    protected function taskInstallPackage($reinstall = false)\n    {\n        $type = $this->view;\n        if ($type !== 'plugins' && $type !== 'themes') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('install ' . $type, ['admin.' . $type, 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $data = $this->post;\n        $package = $data['package'] ?? '';\n        try {\n            $result = Gpm::install($package, ['theme' => $type === 'themes']);\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $msg = $e->getMessage();\n            $msg = Utils::contains($msg, '401 Unauthorized') ? \"ERROR: License key for this resource is invalid.\" : $msg;\n            $msg = Utils::contains($msg, '404 Not Found') ? \"ERROR: Resource not found\" : $msg;\n\n            $this->admin->json_response = ['status' => 'error', 'message' => htmlspecialchars($msg, ENT_QUOTES | ENT_HTML5, 'UTF-8')];\n\n            return false;\n        }\n\n        if ($result) {\n            $this->admin->json_response = [\n                'status'  => 'success',\n                'message' => $this->admin::translate(is_string($result) ? $result : sprintf($this->admin::translate($reinstall ?: 'PLUGIN_ADMIN.PACKAGE_X_REINSTALLED_SUCCESSFULLY',\n                    null), $package))\n            ];\n        } else {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate($reinstall ?: 'PLUGIN_ADMIN.INSTALLATION_FAILED')\n            ];\n        }\n\n        return true;\n    }\n\n    /**\n     * Handle removing a package\n     *\n     * Route: /plugins.json/task:removePackage (AJAX call)\n     * Route: /themes.json/task:removePackage (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskRemovePackage(): bool\n    {\n        $type = $this->view;\n        if ($type !== 'plugins' && $type !== 'themes') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('uninstall ' . $type, ['admin.' . $type, 'admin.super'])) {\n            $json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            $this->sendJsonResponse($json_response, 403);\n        }\n\n        $data    = $this->post;\n        $package = $data['package'] ?? '';\n        $result = false;\n\n        //check if there are packages that have this as a dependency. Abort and show which ones\n        $dependent_packages = $this->admin->getPackagesThatDependOnPackage($package);\n        if (count($dependent_packages) > 0) {\n            if (count($dependent_packages) > 1) {\n                $message = 'The installed packages <cyan>' . implode('</cyan>, <cyan>',\n                        $dependent_packages) . '</cyan> depends on this package. Please remove those first.';\n            } else {\n                $message = 'The installed package <cyan>' . implode('</cyan>, <cyan>',\n                        $dependent_packages) . '</cyan> depends on this package. Please remove it first.';\n            }\n\n            $json_response = ['status' => 'error', 'message' => $message];\n\n            $this->sendJsonResponse($json_response, 200);\n        }\n\n        $dependencies = false;\n        try {\n            $dependencies = $this->admin->dependenciesThatCanBeRemovedWhenRemoving($package);\n            $result       = Gpm::uninstall($package, []);\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $json_response = ['status' => 'error', 'message' => htmlspecialchars($e->getMessage(), ENT_QUOTES | ENT_HTML5, 'UTF-8')];\n\n            $this->sendJsonResponse($json_response, 200);\n        }\n\n        if ($result) {\n            $json_response = [\n                'status'       => 'success',\n                'dependencies' => $dependencies,\n                'message'      => $this->admin::translate(is_string($result) ? $result : 'PLUGIN_ADMIN.UNINSTALL_SUCCESSFUL')\n            ];\n\n            $this->sendJsonResponse($json_response, 200);\n        }\n\n        $json_response = [\n            'status'  => 'error',\n            'message' => $this->admin::translate('PLUGIN_ADMIN.UNINSTALL_FAILED')\n        ];\n\n        $this->sendJsonResponse($json_response, 200);\n    }\n\n    /**\n     * Handle reinstalling a package\n     *\n     * Route: /plugins.json/task:reinstallPackage (AJAX call)\n     * Route: /themes.json/task:reinstallPackage (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskReinstallPackage()\n    {\n        $type = $this->view;\n        if ($type !== 'plugins' && $type !== 'themes') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('install ' . $type, ['admin.' . $type, 'admin.super'])) {\n            $json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            $this->sendJsonResponse($json_response, 403);\n        }\n\n        $data = $this->post;\n        $slug            = $data['slug'] ?? '';\n        $package_name    = $data['package_name'] ?? '';\n        $current_version = $data['current_version'] ?? '';\n\n        $url = \"https://getgrav.org/download/{$type}s/$slug/$current_version\";\n\n        $result = Gpm::directInstall($url);\n\n        if ($result === true) {\n            $this->admin->json_response = [\n                'status'  => 'success',\n                'message' => $this->admin::translate(sprintf($this->admin::translate('PLUGIN_ADMIN.PACKAGE_X_REINSTALLED_SUCCESSFULLY',\n                    null), $package_name))\n            ];\n        } else {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.REINSTALLATION_FAILED')\n            ];\n        }\n\n        return true;\n    }\n\n    /**\n     * Handle direct install.\n     *\n     * Request: POST /tools/direct-install?task=directInstall\n     *\n     * @return bool\n     */\n    protected function taskDirectInstall()\n    {\n        if (!$this->authorizeTask('install', ['admin.super'])) {\n            return false;\n        }\n\n        $file_path = $this->data['file_path'] ?? null;\n\n        if (isset($_FILES['uploaded_file'])) {\n\n            // Check $_FILES['file']['error'] value.\n            switch ($_FILES['uploaded_file']['error']) {\n                case UPLOAD_ERR_OK:\n                    break;\n                case UPLOAD_ERR_NO_FILE:\n                    $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.NO_FILES_SENT'), 'error');\n                    return false;\n                case UPLOAD_ERR_INI_SIZE:\n                case UPLOAD_ERR_FORM_SIZE:\n                    $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.EXCEEDED_FILESIZE_LIMIT'), 'error');\n                    return false;\n                case UPLOAD_ERR_NO_TMP_DIR:\n                    $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.UPLOAD_ERR_NO_TMP_DIR'), 'error');\n                    return false;\n                default:\n                    $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.UNKNOWN_ERRORS'), 'error');\n                    return false;\n            }\n\n            $file_name = $_FILES['uploaded_file']['name'];\n            $file_path = $_FILES['uploaded_file']['tmp_name'];\n\n            // Handle bad filenames.\n            if (!Utils::checkFilename($file_name)) {\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.UNKNOWN_ERRORS')\n                ];\n\n                return false;\n            }\n        }\n\n\n        $result = Gpm::directInstall($file_path);\n\n        if ($result === true) {\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.INSTALLATION_SUCCESSFUL'), 'info');\n        } else {\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.INSTALLATION_FAILED') . ': ' . $result,\n                'error');\n        }\n\n        $this->setRedirect('/tools');\n\n        return true;\n    }\n\n    // PAGE TASKS\n\n    /**\n     * Handles creating an empty page folder (without markdown file)\n     *\n     * Route: /pages\n     *\n     * @note Not used if Flex-Objects plugin handles pages.\n     *\n     * @return bool True if the action was performed.\n     */\n    public function taskSaveNewFolder()\n    {\n        if ($this->view !== 'pages') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('new folder', ['admin.pages', 'admin.pages.create', 'admin.super'])) {\n            return false;\n        }\n\n        $data = (array)$this->data;\n\n        $folder = $data['folder'] ?? '';\n        if ($folder === '' || mb_strpos($folder, '/') !== false) {\n            throw new \\RuntimeException('Creating folder failed: bad folder name', 400);\n        }\n\n        if ($data['route'] === '' || $data['route'] === '/') {\n            $path = $this->grav['locator']->findResource('page://');\n        } else {\n            $pages = $this->admin::enablePages();\n\n            $page = $pages->find($data['route']);\n            if (!$page) {\n                return false;\n            }\n            $path = $page->path();\n        }\n\n        $orderOfNewFolder = static::getNextOrderInFolder($path);\n        $new_path         = $path . '/' . $orderOfNewFolder . '.' . $folder;\n\n        Folder::create($new_path);\n        Cache::clearCache('invalidate');\n\n        $this->grav->fireEvent('onAdminAfterSaveAs', new Event(['path' => $new_path]));\n\n        $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_SAVED'), 'info');\n\n        $this->setRedirect($this->admin->getAdminRoute(\"/{$this->view}\")->toString());\n\n        return true;\n    }\n\n    /**\n     * @note Not used if Flex-Objects plugin handles pages.\n     *\n     * @return bool\n     */\n    protected function savePage()\n    {\n        $reorder = true;\n\n        $data = (array)$this->data;\n        $this->grav['twig']->twig_vars['current_form_data'] = $data;\n\n        $pages = $this->admin::enablePages();\n\n        // Find new parent page in order to build the path.\n        $path = trim($data['route'] ?? dirname($this->admin->route), '/');\n        if ($path === '.') {\n            $path = '';\n        }\n\n        /** @var PageInterface $obj */\n        $obj = $this->admin->page(true);\n\n        $folder = $data['folder'] ?? null;\n        if ($folder === '' || mb_strpos($folder, '/') !== false) {\n            throw new \\RuntimeException('Saving page failed: bad folder name', 400);\n        }\n\n        if (!isset($data['folder']) || !$data['folder']) {\n            $data['folder'] = $obj->slug();\n            $this->data['folder'] = $obj->slug();\n        }\n\n        // Check for valid frontmatter\n        if (isset($data['frontmatter']) && !$this->checkValidFrontmatter($data['frontmatter'])) {\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.INVALID_FRONTMATTER_COULD_NOT_SAVE'),\n                'error');\n            return false;\n        }\n\n        // XSS Checks for page content\n        $xss_whitelist = $this->grav['config']->get('security.xss_whitelist', 'admin.super');\n        if (!$this->admin->authorize($xss_whitelist)) {\n            $check_what = ['header' => $data['header'] ?? '', 'frontmatter' => $data['frontmatter'] ?? '', 'content' => $data['content'] ?? ''];\n            $results = Security::detectXssFromArray($check_what);\n            if (!empty($results)) {\n                $this->admin->setMessage('<i class=\"fa fa-ban\"></i> ' . $this->admin::translate('PLUGIN_ADMIN.XSS_ONSAVE_ISSUE'),\n                    'error');\n                return false;\n            }\n        }\n\n        if ($path !== '') {\n            // First try to get page by its path.\n            $parent = $pages->get(GRAV_ROOT . '/' . $path);\n            if (!$parent) {\n                // Fall back using the route.\n                $route = '/' . preg_replace(PageIndex::PAGE_ROUTE_REGEX, '/', $path);\n                $parent = $pages->find($route, true);\n                if (!$parent) {\n                    throw new \\RuntimeException('New parent page cannot be resolved!');\n                }\n            }\n        } else {\n            $parent = $pages->root();\n        }\n\n        $original_order = (int)trim($obj->order(), '.');\n\n        try {\n            // Change parent if needed and initialize move (might be needed also on ordering/folder change).\n            $obj = $obj->move($parent);\n            $this->preparePage($obj, false, $obj->language());\n            $obj->validate();\n\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->setMessage($e->getMessage(), 'error');\n\n            return false;\n        }\n        $obj->filter();\n\n        // rename folder based on visible\n        if ($original_order === 1000) {\n            // increment order to force reshuffle\n            $obj->order($original_order + 1);\n        }\n\n        if (isset($data['order']) && !empty($data['order'])) {\n            $reorder = explode(',', $data['order']);\n        }\n\n        // add or remove numeric prefix based on ordering value\n        if (isset($data['ordering'])) {\n            if ($data['ordering'] && !$obj->order()) {\n                $obj->order(static::getNextOrderInFolder($obj->parent()->path()));\n                $reorder = false;\n            } elseif (!$data['ordering'] && $obj->order()) {\n                $obj->folder($obj->slug());\n            }\n        }\n\n        $obj = $this->storeFiles($obj);\n\n        if ($obj) {\n            // Event to manipulate data before saving the object\n            // DEPRECATED: page\n            $this->grav->fireEvent('onAdminSave', new Event(['object' => &$obj, 'page' => &$obj]));\n\n            $obj->save($reorder);\n\n            Cache::clearCache('invalidate');\n\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_SAVED'), 'info');\n            // DEPRECATED: page\n            $this->grav->fireEvent('onAdminAfterSave', new Event(['object' => $obj, 'page' => $obj]));\n        }\n\n        if (method_exists($obj, 'unsetRouteSlug')) {\n            $obj->unsetRouteSlug();\n        }\n\n        $multilang = $this->isMultilang();\n\n        if ($multilang && !$obj->language()) {\n            $obj->language($this->admin->getLanguage());\n        }\n        $admin_route = $this->admin->base;\n\n        $route           = $obj->rawRoute();\n        $redirect_url = ($multilang ? '/' . $obj->language() : '') . $admin_route . '/' . $this->view . $route;\n        $this->setRedirect($redirect_url);\n\n        return true;\n    }\n\n    /**\n     * Save page as a new copy.\n     *\n     * Route: /pages\n     *\n     * @note Not used if Flex-Objects plugin handles pages.\n     *\n     * @return bool True if the action was performed.\n     * @throws \\RuntimeException\n     */\n    protected function taskCopy()\n    {\n        if ($this->view !== 'pages') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('copy page', ['admin.pages', 'admin.pages.create', 'admin.super'])) {\n            return false;\n        }\n\n        try {\n            $pages = $this->admin::enablePages();\n\n            // Get the current page.\n            $original_page = $this->admin->page(true);\n\n            // Find new parent page in order to build the path.\n            $parent = $original_page->parent() ?: $pages->root();\n            // Make a copy of the current page and fill the updated information into it.\n            $page = $original_page->copy($parent);\n\n            $order = 0;\n            if ($page->order()) {\n                $order = $this->getNextOrderInFolder($page->parent()->path());\n            }\n\n            // Make sure the header is loaded in case content was set through raw() (expert mode)\n            $page->header();\n\n            if ($page->order()) {\n                $page->order($order);\n            }\n\n            $folder = $this->findFirstAvailable('folder', $page);\n            $slug   = $this->findFirstAvailable('slug', $page);\n\n            $page->path($page->parent()->path() . DS . $page->order() . $folder);\n            $page->route($page->parent()->route() . '/' . $slug);\n            $page->rawRoute($page->parent()->rawRoute() . '/' . $slug);\n\n            // Append progressive number to the copied page title\n            $match  = preg_split('/(\\d+)(?!.*\\d)/', $original_page->title(), 2, PREG_SPLIT_DELIM_CAPTURE);\n            $header = $page->header();\n            if (!isset($match[1])) {\n                $header->title = $match[0] . ' 2';\n            } else {\n                $header->title = $match[0] . ((int)$match[1] + 1);\n            }\n\n            $page->header($header);\n            $page->save(false);\n\n            $redirect = $this->view . $page->rawRoute();\n            $header   = $page->header();\n\n            if (isset($header->slug)) {\n                $match        = preg_split('/-(\\d+)$/', $header->slug, 2, PREG_SPLIT_DELIM_CAPTURE);\n                $header->slug = $match[0] . '-' . (isset($match[1]) ? (int)$match[1] + 1 : 2);\n            }\n\n            $page->header($header);\n\n            $page->save();\n\n            Cache::clearCache('invalidate');\n\n            // DEPRECATED: page\n            $this->grav->fireEvent('onAdminAfterSave', new Event(['object' => $page, 'page' => $page]));\n\n            // Enqueue message and redirect to new location.\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_COPIED'), 'info');\n            $this->setRedirect($redirect);\n\n        } catch (\\Exception $e) {\n            throw new \\RuntimeException('Copying page failed on error: ' . $e->getMessage());\n        }\n\n        return true;\n    }\n\n    /**\n     * Reorder pages.\n     *\n     * Route: /pages\n     *\n     * @note Not used if Flex-Objects plugin handles pages.\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskReorder()\n    {\n        if ($this->view !== 'pages') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('reorder pages', ['admin.pages', 'admin.pages.update', 'admin.super'])) {\n            return false;\n        }\n\n        $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.REORDERING_WAS_SUCCESSFUL'), 'info');\n\n        return true;\n    }\n\n    /**\n     * Delete page.\n     *\n     * Route: /pages\n     *\n     * @note Not used if Flex-Objects plugin handles pages.\n     *\n     * @return bool True if the action was performed.\n     * @throws \\RuntimeException\n     */\n    protected function taskDelete()\n    {\n        if ($this->view !== 'pages') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('delete page', ['admin.pages', 'admin.pages.delete', 'admin.super'])) {\n            return false;\n        }\n\n        try {\n            $page = $this->admin->page();\n\n            if (count($page->translatedLanguages()) > 1) {\n                $page->file()->delete();\n            } else {\n                Folder::delete($page->path());\n            }\n\n            // DEPRECATED: page\n            $this->grav->fireEvent('onAdminAfterDelete', new Event(['object' => $page, 'page' => $page]));\n\n            Cache::clearCache('invalidate');\n\n            // Set redirect to pages list.\n            $redirect = 'pages';\n\n            $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_DELETED'), 'info');\n            $this->setRedirect($redirect);\n\n        } catch (\\Exception $e) {\n            throw new \\RuntimeException('Deleting page failed on error: ' . $e->getMessage());\n        }\n\n        return true;\n    }\n\n    /**\n     * Switch the content language. Optionally redirect to a different page.\n     *\n     * Route: /pages\n     *\n     * @note Not used if Flex-Objects plugin handles pages.\n     *\n     * @return bool\n     */\n    protected function taskSwitchlanguage()\n    {\n        if ($this->view !== 'pages') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('switch language', ['admin.pages', 'admin.pages.list', 'admin.super'])) {\n            return false;\n        }\n\n        $data = (array)$this->data;\n\n        $language = $data['lang'] ?? $this->grav['uri']->param('lang');\n\n        if (isset($data['redirect'])) {\n            $redirect = '/pages/' . $data['redirect'];\n        } else {\n            $redirect = '/pages';\n        }\n\n\n        if ($language) {\n            $this->grav['session']->admin_lang = $language ?: 'en';\n        }\n\n        $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_SWITCHED_LANGUAGE'), 'info');\n\n        $this->setRedirect($this->admin->getAdminRoute($redirect)->toString());\n\n        return true;\n    }\n\n    /**\n     * Save the current page in a different language. Automatically switches to that language.\n     *\n     * Route: /pages\n     *\n     * @note Not used if Flex-Objects plugin handles pages.\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskSaveas()\n    {\n        if ($this->view !== 'pages') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('save as', ['admin.pages', 'admin.pages.create', 'admin.super'])) {\n            return false;\n        }\n\n        /** @var Language $language */\n        $language = $this->grav['language'];\n\n        $data     = (array)$this->data;\n        $lang = $data['lang'] ?? null;\n\n        if ($lang) {\n            $this->grav['session']->admin_lang = $lang ?: 'en';\n        }\n\n        $uri = $this->grav['uri'];\n        $obj = $this->admin->page($uri->route());\n        $this->preparePage($obj, false, $lang);\n\n        $file = $obj->file();\n        if ($file) {\n            $filename = $this->determineFilenameIncludingLanguage($obj->name(), $lang);\n\n            $path  = $obj->path() . DS . $filename;\n            $aFile = File::instance($path);\n            $aFile->save();\n\n            $aPage = new Page();\n            $aPage->init(new \\SplFileInfo($path), $lang . '.md');\n            $aPage->header($obj->header());\n            $aPage->rawMarkdown($obj->rawMarkdown());\n            $aPage->template($obj->template());\n            $aPage->validate();\n            $aPage->filter();\n\n            // DEPRECATED: page\n            $this->grav->fireEvent('onAdminSave', new Event(['object' => $aPage, 'page' => &$aPage]));\n\n            $aPage->save();\n\n            Cache::clearCache('invalidate');\n\n            // DEPRECATED: page\n            $this->grav->fireEvent('onAdminAfterSave', new Event(['object' => $aPage, 'page' => $aPage]));\n        }\n\n        $this->admin->setMessage($this->admin::translate('PLUGIN_ADMIN.SUCCESSFULLY_SWITCHED_LANGUAGE'), 'info');\n\n        // TODO: better multilanguage support needed.\n        $this->setRedirect($language->getLanguageURLPrefix($lang) . $uri->route());\n\n        return true;\n    }\n\n    /**\n     * Continue to the new page.\n     *\n     * @note Not used if Flex-Objects plugin handles pages, users and user groups.\n     *\n     * @return bool True if the action was performed.\n     */\n    public function taskContinue()\n    {\n        $data = (array)$this->data;\n\n        if ($this->view === 'users') {\n            $username = strip_tags(strtolower($data['username']));\n            $this->setRedirect(\"{$this->view}/{$username}\");\n\n            return true;\n        }\n\n        if ($this->view !== 'pages') {\n            return false;\n        }\n\n        $route  = $data['route'] !== '/' ? $data['route'] : '';\n        $folder = $data['folder'] ?? null;\n        $title = $data['title'] ?? null;\n\n        // Handle @slugify-{field} value, automatically slugifies the specified field\n        if (null !== $folder && 0 === strpos($folder, '@slugify-')) {\n            $folder = \\Grav\\Plugin\\Admin\\Utils::slug($data[substr($folder, 9)] ?? '');\n        }\n        if (!$folder) {\n            $folder = \\Grav\\Plugin\\Admin\\Utils::slug($title) ?: '';\n        }\n        $folder = ltrim($folder, '_');\n        if ($folder === '' || mb_strpos($folder, '/') !== false) {\n            throw new \\RuntimeException('Creating page failed: bad folder name', 400);\n        }\n\n        if (!empty($data['modular'])) {\n            $folder = '_' . $folder;\n        }\n\n        $data['folder'] = $folder;\n\n        $path = $route . '/' . $folder;\n        $this->admin->session()->{$path} = $data;\n\n        // Store the name and route of a page, to be used pre-filled defaults of the form in the future\n        $this->admin->session()->lastPageName  = $data['name'];\n        $this->admin->session()->lastPageRoute = $data['route'];\n\n        $this->setRedirect(\"{$this->view}/\" . ltrim($path, '/'));\n\n        return true;\n    }\n\n    /**\n     * $data['route'] = $this->grav['uri']->param('route');\n     * $data['sortby'] = $this->grav['uri']->param('sortby', null);\n     * $data['filters'] = $this->grav['uri']->param('filters', null);\n     * $data['page'] $this->grav['uri']->param('page', true);\n     * $data['base'] = $this->grav['uri']->param('base');\n     * $initial = (bool) $this->grav['uri']->param('initial');\n     *\n     * @return ResponseInterface\n     * @throws RequestException\n     */\n    protected function taskGetLevelListing(): ResponseInterface\n    {\n        $this->checkTaskAuthorization('save', $this->dataPermissions());\n\n        $request = $this->getRequest();\n        $data = $request->getParsedBody();\n\n        if (!isset($data['field'])) {\n            throw new RequestException($request, 'Bad Request', 400);\n        }\n\n        // Base64 decode the route\n        $data['route'] = isset($data['route']) ? base64_decode($data['route']) : null;\n\n        $initial = $data['initial'] ?? null;\n        if ($initial) {\n            $data['leaf_route'] = $data['route'];\n            $data['route'] = null;\n            $data['level'] = 1;\n        }\n\n        [$status, $message, $response,] = $this->getLevelListing($data);\n\n        $json = [\n            'status'  => $status,\n            'message' => $this->admin::translate($message ?? 'PLUGIN_ADMIN.NO_ROUTE_PROVIDED'),\n            'data' => array_values($response)\n        ];\n\n        return $this->createJsonResponse($json, 200);\n    }\n\n    /**\n     * Route: /ajax.json\n     *\n     * @note Not used if Flex-Objects plugin handles pages.\n     *\n     * @return bool\n     */\n    protected function taskGetChildTypes()\n    {\n        if ($this->view !== 'ajax') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('get childtypes', ['admin.pages', 'admin.pages.list', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $data = $this->post;\n\n        $route = $data['rawroute'] ?? null;\n        if ($route) {\n            /** @var Flex $flex */\n            $flex = $this->grav['flex'];\n            $page = $flex->getObject(trim($route, '/'), 'pages');\n            if ($page instanceof PageInterface) {\n                $child_type = $page->childType();\n                if ($child_type !== '') {\n                    $this->admin->json_response = [\n                        'status' => 'success',\n                        'child_type' => $child_type\n                    ];\n                    return true;\n                }\n            }\n        }\n\n        $this->admin->json_response = [\n            'status'  => 'success',\n            'child_type' => '',\n        ];\n\n        return true;\n    }\n\n    /**\n     * Handles filtering the page by modular/visible/routable in the pages list.\n     *\n     * @note Used only in legacy pages.\n     *\n     * @return bool\n     */\n    protected function taskFilterPages()\n    {\n        if ($this->view !== 'pages-filter') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('filter pages', ['admin.pages', 'admin.pages.list', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $data = $this->post;\n\n        $flags   = !empty($data['flags']) ? array_map('strtolower', explode(',', $data['flags'])) : [];\n        $queries = !empty($data['query']) ? explode(',', $data['query']) : [];\n\n        $pages = $this->admin::enablePages();\n\n        /** @var Collection $collection */\n        $collection = $pages->all();\n\n        if (count($flags)) {\n            // Filter by state\n            $pageStates = [\n                'modular',\n                'nonmodular',\n                'visible',\n                'nonvisible',\n                'routable',\n                'nonroutable',\n                'published',\n                'nonpublished'\n            ];\n\n            if (count(array_intersect($pageStates, $flags)) > 0) {\n                if (in_array('modular', $flags, true)) {\n                    $collection = $collection->modular();\n                }\n\n                if (in_array('nonmodular', $flags, true)) {\n                    $collection = $collection->nonModular();\n                }\n\n                if (in_array('visible', $flags, true)) {\n                    $collection = $collection->visible();\n                }\n\n                if (in_array('nonvisible', $flags, true)) {\n                    $collection = $collection->nonVisible();\n                }\n\n                if (in_array('routable', $flags, true)) {\n                    $collection = $collection->routable();\n                }\n\n                if (in_array('nonroutable', $flags, true)) {\n                    $collection = $collection->nonRoutable();\n                }\n\n                if (in_array('published', $flags, true)) {\n                    $collection = $collection->published();\n                }\n\n                if (in_array('nonpublished', $flags, true)) {\n                    $collection = $collection->nonPublished();\n                }\n            }\n            foreach ($pageStates as $pageState) {\n                if (($pageState = array_search($pageState, $flags, true)) !== false) {\n                    unset($flags[$pageState]);\n                }\n            }\n\n            // Filter by page type\n            if ($flags) {\n                $types = [];\n\n                $pageTypes = array_keys(Pages::pageTypes());\n                foreach ($pageTypes as $pageType) {\n                    if (($pageKey = array_search($pageType, $flags, true)) !== false) {\n                        $types[] = $pageType;\n                        unset($flags[$pageKey]);\n                    }\n                }\n\n                if (count($types)) {\n                    $collection = $collection->ofOneOfTheseTypes($types);\n                }\n            }\n\n            // Filter by page type\n            if ($flags) {\n                $accessLevels = $flags;\n                $collection   = $collection->ofOneOfTheseAccessLevels($accessLevels);\n            }\n        }\n\n        if (!empty($queries)) {\n            foreach ($collection as $page) {\n                foreach ($queries as $query) {\n                    $query = trim($query);\n                    if (stripos($page->getRawContent(), $query) === false\n                        && stripos($page->title(), $query) === false\n                        && stripos($page->folder(), $query) === false\n                        && stripos($page->slug(), \\Grav\\Plugin\\Admin\\Utils::slug($query)) === false\n                    ) {\n                        $collection->remove($page);\n                    }\n                }\n            }\n        }\n\n        $results = [];\n        foreach ($collection as $path => $page) {\n            $results[] = $page->route();\n        }\n\n        $this->admin->json_response = [\n            'status'  => 'success',\n            'message' => $this->admin::translate('PLUGIN_ADMIN.PAGES_FILTERED'),\n            'results' => $results\n        ];\n        $this->admin->collection = $collection;\n\n        return true;\n    }\n\n\n    /**\n     * Process the page Markdown\n     *\n     * Preview task in the builtin editor.\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskProcessMarkdown()\n    {\n        if (!$this->authorizeTask('process markdown', ['admin.pages', 'admin.pages.read', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        try {\n            $page = $this->admin->page(true);\n\n            if (!$page) {\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.NO_PAGE_FOUND')\n                ];\n\n                return false;\n            }\n\n            $this->preparePage($page, true);\n            $page->header();\n            $page->templateFormat('html');\n\n            // Add theme template paths to Twig loader\n            $template_paths = $this->grav['locator']->findResources('theme://templates');\n            $this->grav['twig']->twig->getLoader()->addLoader(new FilesystemLoader($template_paths));\n\n            $html = $page->content();\n\n            $this->admin->json_response = ['status' => 'success', 'preview' => $html];\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $this->admin->json_response = ['status' => 'error', 'message' => htmlspecialchars($e->getMessage(), ENT_QUOTES | ENT_HTML5, 'UTF-8')];\n\n            return false;\n        }\n\n        return true;\n    }\n\n    // MEDIA TASKS\n\n    /**\n     * Determines the file types allowed to be uploaded\n     *\n     * Used by pagemedia field. Works only within legacy pages.\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskListmedia()\n    {\n        if ($this->view !== 'media') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('list media', ['admin.pages', 'admin.pages.read', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $media = $this->getMedia();\n        if (!$media) {\n            $this->admin->json_response = [\n                'status' => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.NO_PAGE_FOUND')\n            ];\n\n            return false;\n        }\n\n        $media_list = [];\n        /**\n         * @var string $name\n         * @var Medium|ImageMedium $medium\n         */\n        foreach ($media->all() as $name => $medium) {\n\n            $metadata = [];\n            $img_metadata = $medium->metadata();\n            if ($img_metadata) {\n                $metadata = $img_metadata;\n            }\n\n            // Get original name\n            /** @var ImageMedium $source */\n            $source = method_exists($medium, 'higherQualityAlternative') ? $medium->higherQualityAlternative() : null;\n\n            $media_list[$name] = [\n                'url' => $medium->display($medium->get('extension') === 'svg' ? 'source' : 'thumbnail')->cropZoom(400, 300)->url(),\n                'size' => $medium->get('size'),\n                'metadata' => $metadata,\n                'original' => $source ? $source->get('filename') : null\n            ];\n        }\n\n        $this->admin->json_response = ['status' => 'success', 'results' => $media_list];\n\n        return true;\n    }\n\n    /**\n     * Handles adding a media file to a page.\n     *\n     * Used by pagemedia field. Works only within legacy pages.\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskAddmedia()\n    {\n        if ($this->view !== 'media') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('add media', ['admin.pages', 'admin.pages.update', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        /** @var Config $config */\n        $config = $this->grav['config'];\n\n        if (empty($_FILES)) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.EXCEEDED_POSTMAX_LIMIT')\n            ];\n\n            return false;\n        }\n\n        if (!isset($_FILES['file']['error']) || is_array($_FILES['file']['error'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INVALID_PARAMETERS')\n            ];\n\n            return false;\n        }\n\n        // Check $_FILES['file']['error'] value.\n        switch ($_FILES['file']['error']) {\n            case UPLOAD_ERR_OK:\n                break;\n            case UPLOAD_ERR_NO_FILE:\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.NO_FILES_SENT')\n                ];\n\n                return false;\n            case UPLOAD_ERR_INI_SIZE:\n            case UPLOAD_ERR_FORM_SIZE:\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.EXCEEDED_FILESIZE_LIMIT')\n                ];\n\n                return false;\n            case UPLOAD_ERR_NO_TMP_DIR:\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.UPLOAD_ERR_NO_TMP_DIR')\n                ];\n\n                return false;\n            default:\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.UNKNOWN_ERRORS')\n                ];\n\n                return false;\n        }\n\n        $filename = $_FILES['file']['name'];\n\n        // Handle bad filenames.\n        if (!Utils::checkFilename($filename)) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => sprintf($this->admin::translate('PLUGIN_ADMIN.FILEUPLOAD_UNABLE_TO_UPLOAD'),\n                    htmlspecialchars($filename, ENT_QUOTES | ENT_HTML5, 'UTF-8'), 'Bad filename')\n            ];\n\n            return false;\n        }\n\n        // You should also check filesize here.\n        $grav_limit = Utils::getUploadLimit();\n        if ($grav_limit > 0 && $_FILES['file']['size'] > $grav_limit) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.EXCEEDED_GRAV_FILESIZE_LIMIT')\n            ];\n\n            return false;\n        }\n\n\n        // Check extension\n        $extension = strtolower(pathinfo($filename, PATHINFO_EXTENSION));\n\n        // If not a supported type, return\n        if (!$extension || !$config->get(\"media.types.{$extension}\")) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.UNSUPPORTED_FILE_TYPE') . ': ' . $extension\n            ];\n\n            return false;\n        }\n\n        $page = $this->admin->page($this->route);\n        $media = $page ? $this->getMedia($page) : null;\n        if (!$media) {\n            $this->admin->json_response = [\n                'status' => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.NO_PAGE_FOUND')\n            ];\n\n            return false;\n        }\n\n        /** @var UniformResourceLocator $locator */\n        $locator = $this->grav['locator'];\n        $path = $media->getPath();\n        if ($locator->isStream($path)) {\n            $path = $locator->findResource($path, true, true);\n        }\n\n        // Special Sanitization for SVG\n        if (Utils::contains($extension, 'svg', false)) {\n            Security::sanitizeSVG($_FILES['file']['tmp_name']);\n        }\n\n        // Upload it\n        if (!move_uploaded_file($_FILES['file']['tmp_name'], sprintf('%s/%s', $path, $filename))) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.FAILED_TO_MOVE_UPLOADED_FILE')\n            ];\n\n            return false;\n        }\n\n        Cache::clearCache('invalidate');\n\n        // Add metadata if needed\n        $include_metadata = Grav::instance()['config']->get('system.media.auto_metadata_exif', false);\n        $basename = str_replace(['@3x', '@2x'], '', pathinfo($filename, PATHINFO_BASENAME));\n\n        $metadata = [];\n\n        if ($include_metadata && isset($media[$basename])) {\n            $img_metadata = $media[$basename]->metadata();\n            if ($img_metadata) {\n                $metadata = $img_metadata;\n            }\n        }\n\n        // DEPRECATED: page\n        $this->grav->fireEvent('onAdminAfterAddMedia', new Event(['object' => $page, 'page' => $page]));\n\n        $this->admin->json_response = [\n            'status'  => 'success',\n            'message' => $this->admin::translate('PLUGIN_ADMIN.FILE_UPLOADED_SUCCESSFULLY'),\n            'metadata' => $metadata,\n        ];\n\n        return true;\n    }\n\n    /**\n     * Request: POST .json/task:compileScss (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskCompileScss()\n    {\n        if (!$this->authorizeTask('compile scss', ['admin.plugins', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $default_scheme = $this->grav['config']->get('plugins.admin.whitelabel.color_scheme');\n\n        $preview = $this->post['preview'] ?? false;\n        $data = ['color_scheme' => $this->data['whitelabel']['color_scheme'] ?? $default_scheme];\n        $output_file = $preview ? 'admin-preset.css' : 'admin-preset__tmp.css';\n\n        $options = [\n            'input' => 'plugin://admin/themes/grav/scss/preset.scss',\n            'output' => 'asset://' .$output_file\n        ];\n\n        [$compile_status, $msg] = $this->grav['admin-whitelabel']->compilePresetScss($data, $options);\n\n        $json_response = [\n            'status'  => $compile_status ? 'success' : 'error',\n            'message' => ($preview ? 'Preview ' : 'SCSS ') . $msg,\n            'files' => [\n                'color_scheme' => Utils::url($options['output'])\n            ]\n        ];\n\n        $this->sendJsonResponse($json_response);\n    }\n\n    /**\n     * Request: POST .json/task:exportScss (AJAX call)\n     *\n     * @return bool\n     */\n    protected function taskExportScss()\n    {\n        if (!$this->authorizeTask('export scss', ['admin.plugins', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $data = ['color_scheme' => $this->data['whitelabel']['color_scheme'] ?? null];\n        $name = empty($this->data['whitelabel']['color_scheme']['name']) ? 'admin-theme-export' : \\Grav\\Plugin\\Admin\\Utils::slug($this->data['whitelabel']['color_scheme']['name']);\n\n        $location  = 'asset://' . $name . '.yaml';\n\n        [$status, $msg] = $this->grav['admin-whitelabel']->exportPresetScsss($data, $location);\n\n        $json_response = [\n            'status'  => $status ? 'success' : 'error',\n            'message' => $msg,\n            'files' => [\n                'download' => Utils::url($location)\n            ]\n        ];\n\n        $this->sendJsonResponse($json_response);\n    }\n\n    /**\n     * Handles deleting a media file from a page.\n     *\n     * Used by pagemedia field.\n     *\n     * @return bool True if the action was performed.\n     */\n    protected function taskDelmedia()\n    {\n        if ($this->view !== 'media') {\n            return false;\n        }\n\n        if (!$this->authorizeTask('delete media', ['admin.pages', 'admin.pages.update', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $page = $this->admin->page($this->route);\n        $media = $page ? $this->getMedia($page) : null;\n        if (null === $media) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.NO_PAGE_FOUND')\n            ];\n\n            return false;\n        }\n\n        $filename = !empty($this->post['filename']) ? basename($this->post['filename']) : null;\n\n        // Handle bad filenames.\n        if (!$filename || !Utils::checkFilename($filename)) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.NO_FILE_FOUND')\n            ];\n\n            return false;\n        }\n\n        /** @var UniformResourceLocator $locator */\n        $locator = $this->grav['locator'];\n\n        $targetPath = $media->getPath() . '/' . $filename;\n        if ($locator->isStream($targetPath)) {\n            $targetPath = $locator->findResource($targetPath, true, true);\n        }\n        $fileParts  = pathinfo($filename);\n\n        $found = false;\n\n        if (file_exists($targetPath)) {\n            $found  = true;\n            $result = unlink($targetPath);\n\n            if (!$result) {\n                $this->admin->json_response = [\n                    'status'  => 'error',\n                    'message' => $this->admin::translate('PLUGIN_ADMIN.FILE_COULD_NOT_BE_DELETED') . ': ' . htmlspecialchars($filename, ENT_QUOTES | ENT_HTML5, 'UTF-8')\n                ];\n\n                return false;\n            }\n        }\n\n        // Remove Extra Files\n        foreach (scandir($media->getPath(), SCANDIR_SORT_NONE) as $file) {\n            if (preg_match(\"/{$fileParts['filename']}@\\d+x\\.{$fileParts['extension']}(?:\\.meta\\.yaml)?$|{$filename}\\.meta\\.yaml$/\", $file)) {\n\n                $targetPath = $media->getPath() . '/' . $file;\n                if ($locator->isStream($targetPath)) {\n                    $targetPath = $locator->findResource($targetPath, true, true);\n                }\n\n                $result = unlink($targetPath);\n\n                if (!$result) {\n                    $this->admin->json_response = [\n                        'status'  => 'error',\n                        'message' => $this->admin::translate('PLUGIN_ADMIN.FILE_COULD_NOT_BE_DELETED') . ': ' . htmlspecialchars($filename, ENT_QUOTES | ENT_HTML5, 'UTF-8')\n                    ];\n\n                    return false;\n                }\n\n                $found = true;\n            }\n        }\n\n        Cache::clearCache('invalidate');\n\n        if (!$found) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.FILE_NOT_FOUND') . ': ' . htmlspecialchars($filename, ENT_QUOTES | ENT_HTML5, 'UTF-8')\n            ];\n\n            return false;\n        }\n\n        // DEPRECATED: page\n        $this->grav->fireEvent('onAdminAfterDelMedia', new Event(['object' => $page, 'page' => $page, 'media' => $media, 'filename' => $filename]));\n\n        $this->admin->json_response = [\n            'status'  => 'success',\n            'message' => $this->admin::translate('PLUGIN_ADMIN.FILE_DELETED') . ': ' . htmlspecialchars($filename, ENT_QUOTES | ENT_HTML5, 'UTF-8')\n        ];\n\n        return true;\n    }\n\n    /**\n     * @param array $data\n     * @return array\n     */\n    protected function getLevelListing($data)\n    {\n        // Valid types are dir|file|link\n        $default_filters =  ['type'=> ['root', 'dir'], 'name' => null, 'extension' => null];\n\n        $pages = $this->admin::enablePages();\n\n        $page_instances = $pages->instances();\n\n        $is_page = $data['page'] ?? true;\n        $route = $data['route'] ?? null;\n        $leaf_route = $data['leaf_route'] ?? null;\n        $sortby = $data['sortby'] ?? 'filename';\n        $order = $data['order'] ?? SORT_ASC;\n        $initial = $data['initial'] ?? null;\n        $filters = isset($data['filters']) ? $default_filters + json_decode($data['filters']) : $default_filters;\n        $filter_type = (array) $filters['type'];\n\n        $status = 'error';\n        $msg = null;\n        $response = [];\n        $children = null;\n        $sub_route = null;\n        $extra = null;\n        $root = false;\n\n        // Handle leaf_route\n        if ($leaf_route && $route !== $leaf_route) {\n            $nodes = explode('/', $leaf_route);\n            $sub_route =  '/' . implode('/', array_slice($nodes, 1, $data['level']++));\n            $data['route'] = $sub_route;\n\n            [$status, $msg, $children, $extra] = $this->getLevelListing($data);\n        }\n\n        // Handle no route, assume page tree root\n        if (!$route) {\n            $is_page = false;\n            $route = $this->grav['locator']->findResource('page://', true);\n            $root = true;\n        }\n\n        if ($is_page) {\n            // Try the path\n            /** @var PageInterface $page */\n            $page = $pages->get(GRAV_ROOT . $route);\n\n            // Try a real route (like homepage)\n            if (is_null($page)) {\n                $page = $pages->find($route);\n            }\n\n            $path = $page ? $page->path() : null;\n        } else {\n            // Try a physical path\n            if (!Utils::startsWith($route, GRAV_ROOT)) {\n                $try_path = GRAV_ROOT . $route;\n            } else {\n                $try_path = $route;\n            }\n\n            $path = file_exists($try_path) ? $try_path : null;\n        }\n\n        $blueprintsData = $this->admin->page(true);\n\n        if (null !== $blueprintsData) {\n            if (method_exists($blueprintsData, 'blueprints')) {\n                $settings = $blueprintsData->blueprints()->schema()->getProperty($data['field']);\n            } elseif (method_exists($blueprintsData, 'getBlueprint')) {\n                $settings = $blueprintsData->getBlueprint()->schema()->getProperty($data['field']);\n            }\n\n            $filters = array_merge([], $filters, ($settings['filters'] ?? []));\n            $filter_type = $filters['type'] ?? $filter_type;\n        }\n\n\n        if ($path) {\n            $status = 'success';\n            $msg = 'PLUGIN_ADMIN.PAGE_ROUTE_FOUND';\n            foreach (new \\DirectoryIterator($path) as $fileInfo) {\n                $fileName = $fileInfo->getFilename();\n                $filePath = str_replace('\\\\', '/', $fileInfo->getPathname());\n\n                if (($fileInfo->isDot() && $fileName !== '.' && $initial) || (Utils::startsWith($fileName, '.') && strlen($fileName) > 1)) {\n                    continue;\n                }\n\n                if ($fileInfo->isDot()) {\n                    if ($root) {\n                        $payload = [\n                            'name' => '<root>',\n                            'value' => '',\n                            'item-key' => '',\n                            'filename' => '.',\n                            'extension' => '',\n                            'type' => 'root',\n                            'modified' => $fileInfo->getMTime(),\n                            'size' => 0,\n                            'has-children' => false\n                        ];\n                    } else {\n                        continue;\n                    }\n                } else {\n                    $file_page = $page_instances[$filePath] ?? null;\n                    $file_path = Utils::replaceFirstOccurrence(GRAV_ROOT, '', $filePath);\n                    $type = $fileInfo->getType();\n\n                    $child_path = $file_page ? $file_page->path() : $filePath;\n                    $count_children = Folder::countChildren($child_path);\n\n                    $payload = [\n                        'name' => $file_page ? $file_page->title() : $fileName,\n                        'value' => $file_page ? $file_page->rawRoute() : $file_path,\n                        'item-key' => basename($file_page ? $file_page->route() : $file_path),\n                        'filename' => $fileName,\n                        'extension' => $type === 'dir' ? '' : $fileInfo->getExtension(),\n                        'type' => $type,\n                        'modified' => $fileInfo->getMTime(),\n                        'size' => $count_children,\n                        'symlink' => false,\n                        'has-children' => $count_children > 0\n                    ];\n                }\n\n                // Fix for symlink\n                if ($payload['type'] === 'link') {\n                    $payload['symlink'] = true;\n                    $physical_path = $fileInfo->getRealPath();\n                    $payload['type'] = is_dir($physical_path) ? 'dir' : 'file';\n                }\n\n                // filter types\n                if ($filters['type']) {\n                    if (!in_array($payload['type'], $filter_type)) {\n                        continue;\n                    }\n                }\n\n                // Simple filter for name or extension\n                if (($filters['name'] && Utils::contains($payload['basename'], $filters['name'])) ||\n                    ($filters['extension'] && Utils::contains($payload['extension'], $filters['extension']))) {\n                    continue;\n                }\n\n                // Add children if any\n                if ($filePath === $extra && is_array($children)) {\n                    $payload['children'] = array_values($children);\n                }\n\n                $response[] = $payload;\n            }\n        } else {\n            $msg = 'PLUGIN_ADMIN.PAGE_ROUTE_NOT_FOUND';\n        }\n\n        // Sorting\n        $response = Utils::sortArrayByKey($response, $sortby, $order);\n\n        $temp_array = [];\n        foreach ($response as $index => $item) {\n            $temp_array[$item['type']][$index] = $item;\n        }\n\n        $sorted = Utils::sortArrayByArray($temp_array, $filter_type);\n        $response = Utils::arrayFlatten($sorted);\n\n        return [$status, $this->admin::translate($msg ?? 'PLUGIN_ADMIN.NO_ROUTE_PROVIDED'), $response, $path];\n    }\n\n    /**\n     * Get page media.\n     *\n     * @param PageInterface|null $page\n     * @return Media|null\n     */\n    public function getMedia(PageInterface $page = null)\n    {\n        $page = $page ?? $this->admin->page($this->route);\n        if (!$page) {\n            return null;\n        }\n\n        $this->uri = $this->uri ?? $this->grav['uri'];\n\n        $field = (string)$this->uri->post('field', '');\n        $order = $this->uri->post('order') ?: null;\n        if ($order && is_string($order)) {\n            $order = array_map('trim', explode(',', $order));\n        }\n\n        $blueprints = $page->blueprints();\n        $settings = $this->getMediaFieldSettings($blueprints, $field);\n        $path = $settings['destination'] ?? $page->path();\n\n        return $path ? new Media($path, $order) : null;\n    }\n\n    /**\n     * @param Data\\Blueprint|null $blueprint\n     * @param string $field\n     * @return array|null\n     */\n    protected function getMediaFieldSettings(?Data\\Blueprint $blueprint, string $field): ?array\n    {\n        $schema = $blueprint ? $blueprint->schema() : null;\n        if (!$schema || $field === '') {\n            return null;\n        }\n\n        $settings = is_object($schema) ? (array)$schema->getProperty($field) : null;\n        if (null === $settings) {\n            return null;\n        }\n\n        if (empty($settings['destination']) || \\in_array($settings['destination'], ['@self', 'self@', '@self@'], true)) {\n            unset($settings['destination']);\n        }\n\n        return $settings + ['accept' => '*', 'limit' => 1000];\n    }\n\n    /**\n     * @return string\n     */\n    protected function getDataType()\n    {\n        return trim(\"{$this->view}/{$this->admin->route}\", '/');\n    }\n\n    /**\n     * Gets the configuration data for a given view & post\n     *\n     * @param array $data\n     * @return object\n     */\n    protected function prepareData(array $data)\n    {\n        $type = $this->getDataType();\n\n        return $this->admin->data($type, $data);\n    }\n\n    /**\n     * Prepare a page to be stored: update its folder, name, template, header and content\n     *\n     * @param PageInterface          $page\n     * @param bool                   $clean_header\n     * @param string                 $languageCode\n     * @return void\n     */\n    protected function preparePage(PageInterface $page, $clean_header = false, $languageCode = ''): void\n    {\n        $input = (array)$this->data;\n\n        $this->admin::enablePages();\n\n        if (isset($input['folder']) && $input['folder'] !== $page->value('folder')) {\n            $order    = $page->value('order');\n            $ordering = $order ? sprintf('%02d.', $order) : '';\n            $page->folder($ordering . $input['folder']);\n        }\n\n        if (isset($input['name']) && !empty($input['name'])) {\n            $type = strtolower($input['name']);\n            $page->template($type);\n            $name = preg_replace('|.*/|', '', $type);\n\n            /** @var Language $language */\n            $language = $this->grav['language'];\n            if ($language->enabled()) {\n                $languageCode = $languageCode ?: $language->getLanguage();\n                if ($languageCode) {\n                    $isDefault = $languageCode === $language->getDefault();\n                    $includeLang = !$isDefault || (bool)$this->grav['config']->get('system.languages.include_default_lang_file_extension', true);\n                    if (!$includeLang) {\n                        // Check if the language specific file exists; use it if it does.\n                        $includeLang = file_exists(\"{$page->path()}/{$name}.{$languageCode}.md\");\n                    }\n                    // Keep existing .md file if we're updating default language, otherwise always append the language.\n                    if ($includeLang) {\n                        $name .= '.' . $languageCode;\n                    }\n                }\n            }\n\n            $name .= '.md';\n            $page->name($name);\n        }\n\n        // Special case for Expert mode: build the raw, unset content\n        if (isset($input['frontmatter'], $input['content'])) {\n            $page->raw(\"---\\n\" . (string)$input['frontmatter'] . \"\\n---\\n\" . (string)$input['content']);\n            unset($input['content']);\n        // Handle header normally\n        } elseif (isset($input['header'])) {\n            $header = $input['header'];\n\n            foreach ($header as $key => $value) {\n                if ($key === 'metadata' && is_array($header[$key])) {\n                    foreach ($header['metadata'] as $key2 => $value2) {\n                        if (isset($input['toggleable_header']['metadata'][$key2]) && !$input['toggleable_header']['metadata'][$key2]) {\n                            $header['metadata'][$key2] = '';\n                        }\n                    }\n                } elseif ($key === 'taxonomy' && is_array($header[$key])) {\n                    foreach ($header[$key] as $taxkey => $taxonomy) {\n                        if (is_array($taxonomy) && \\count($taxonomy) === 1 && trim($taxonomy[0]) === '') {\n                            unset($header[$key][$taxkey]);\n                        }\n                    }\n                } else {\n                    if (isset($input['toggleable_header'][$key]) && !$input['toggleable_header'][$key]) {\n                        $header[$key] = null;\n                    }\n                }\n            }\n            if ($clean_header) {\n                $header = Utils::arrayFilterRecursive($header, function ($k, $v) {\n                    return !(null === $v || $v === '');\n                });\n            }\n            $page->header((object)$header);\n            $page->frontmatter(Yaml::dump((array)$page->header(), 20));\n        }\n        // Fill content last because it also renders the output.\n        if (isset($input['content'])) {\n            $page->rawMarkdown((string)$input['content']);\n        }\n    }\n\n    /**\n     * Find the first available $item ('slug' | 'folder') for a page\n     * Used when copying a page, to determine the first available slot\n     *\n     * @param string        $item\n     * @param PageInterface $page\n     * @return string The first available slot\n     */\n    protected function findFirstAvailable($item, PageInterface $page)\n    {\n        $parent = $page->parent();\n        if (!$parent || !$parent->children()) {\n            return $page->{$item}();\n        }\n\n        $withoutPrefix = function ($string) {\n            $match = preg_split('/^[0-9]+\\./u', $string, 2, PREG_SPLIT_DELIM_CAPTURE);\n\n            return $match[1] ?? $match[0];\n        };\n\n        $withoutPostfix = function ($string) {\n            $match = preg_split('/-(\\d+)$/', $string, 2, PREG_SPLIT_DELIM_CAPTURE);\n\n            return $match[0];\n        };\n\n        /* $appendedNumber = function ($string) {\n            $match  = preg_split('/-(\\d+)$/', $string, 2, PREG_SPLIT_DELIM_CAPTURE);\n            $append = (isset($match[1]) ? (int)$match[1] + 1 : 2);\n\n            return $append;\n        };*/\n\n        $highest                   = 1;\n        $siblings                  = $parent->children();\n        $findCorrectAppendedNumber = function ($item, $page_item, $highest) use (\n            $siblings,\n            &$findCorrectAppendedNumber,\n            &$withoutPrefix\n        ) {\n            foreach ($siblings as $sibling) {\n                if ($withoutPrefix($sibling->{$item}()) == ($highest === 1 ? $page_item : $page_item . '-' . $highest)) {\n                    $highest = $findCorrectAppendedNumber($item, $page_item, $highest + 1);\n\n                    return $highest;\n                }\n            }\n\n            return $highest;\n        };\n\n        $base = $withoutPrefix($withoutPostfix($page->$item()));\n\n        $return  = $base;\n        $highest = $findCorrectAppendedNumber($item, $base, $highest);\n\n        if ($highest > 1) {\n            $return .= '-' . $highest;\n        }\n\n        return $return;\n    }\n\n    /**\n     * @param string $frontmatter\n     * @return bool\n     */\n    public function checkValidFrontmatter($frontmatter)\n    {\n        try {\n            Yaml::parse($frontmatter);\n        } catch (\\RuntimeException $e) {\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * The what should be the new filename when saving as a new language\n     *\n     * @param string $current_filename the current file name, including .md. Example: default.en.md\n     * @param string $language         The new language it will be saved as. Example: 'it' or 'en-GB'.\n     * @return string The new filename. Example: 'default.it'\n     */\n    public function determineFilenameIncludingLanguage($current_filename, $language)\n    {\n        $ext = '.md';\n        $filename = substr($current_filename, 0, -strlen($ext));\n        $languages_enabled = $this->grav['config']->get('system.languages.supported', []);\n\n        $parts = explode('.', trim($filename, '.'));\n        $lang = array_pop($parts);\n\n        if ($lang === $language) {\n            return $filename . $ext;\n        }\n\n        if (in_array($lang, $languages_enabled, true)) {\n            $filename = implode('.', $parts);\n        }\n\n        return $filename . '.' . $language . $ext;\n    }\n\n    /**\n     * Get the next available ordering number in a folder\n     *\n     * @param string $path\n     * @return string the correct order string to prepend\n     */\n    public static function getNextOrderInFolder($path)\n    {\n        $files = Folder::all($path, ['recursive' => false]);\n\n        $highestOrder = 0;\n        foreach ($files as $file) {\n            preg_match(PAGE_ORDER_PREFIX_REGEX, $file, $order);\n\n            if (isset($order[0])) {\n                $theOrder = (int)trim($order[0], '.');\n            } else {\n                $theOrder = 0;\n            }\n\n            if ($theOrder >= $highestOrder) {\n                $highestOrder = $theOrder;\n            }\n        }\n\n        $orderOfNewFolder = $highestOrder + 1;\n\n        if ($orderOfNewFolder < 10) {\n            $orderOfNewFolder = '0' . $orderOfNewFolder;\n        }\n\n        return $orderOfNewFolder;\n    }\n\n    /**\n     * Used in 3rd party editors (e.g. next-gen).\n     *\n     * @return ResponseInterface|false\n     */\n    protected function taskConvertUrls()\n    {\n        if (!$this->authorizeTask('access page', ['admin.pages', 'admin.pages.list', 'admin.super'])) {\n            $this->admin->json_response = [\n                'status'  => 'error',\n                'message' => $this->admin::translate('PLUGIN_ADMIN.INSUFFICIENT_PERMISSIONS_FOR_TASK')\n            ];\n\n            return false;\n        }\n\n        $request = $this->getRequest();\n        $data = $request->getParsedBody();\n        $converted_links = [];\n        $converted_images = [];\n        $status = 'success';\n        $message = 'All links converted';\n\n        $data['route'] = isset($data['route']) ? base64_decode($data['route']) : null;\n        $data['data'] = json_decode($data['data'] ?? '{}', true);\n\n        // use the route if passed, else use current page in admin as reference\n        $page_route = $data['route'] ?? $this->admin->page(true);\n\n        /** @var PageInterface */\n        $pages = $this->admin::enablePages();\n        $page = $pages->find($page_route);\n\n        if (!$page) {\n            throw new RequestException($request,'Page Not Found', 404);\n        }\n\n\n        if (!isset($data['data'])) {\n            throw new RequestException($request, 'Bad Request', 400);\n        }\n\n        foreach ($data['data']['a'] ?? [] as $link) {\n            $converted_links[$link] = Excerpts::processLinkHtml($link, $page);\n        }\n\n        foreach ($data['data']['img'] ?? [] as $image) {\n            $converted_images[$image] = Excerpts::processImageHtml($image, $page);\n        }\n\n        $json = [\n            'status'  => $status,\n            'message' => $message,\n            'data' => ['links' => $converted_links, 'images' => $converted_images]\n        ];\n\n        return $this->createJsonResponse($json, 200);\n    }\n}\n", "<?php\n\ndeclare(strict_types=1);\n\nnamespace Grav\\Plugin\\Admin\\Controllers;\n\nuse Grav\\Common\\Debugger;\nuse Grav\\Common\\Grav;\nuse Grav\\Common\\Inflector;\nuse Grav\\Common\\Language\\Language;\nuse Grav\\Common\\Utils;\nuse Grav\\Framework\\Flex\\Interfaces\\FlexObjectInterface;\nuse Grav\\Framework\\Form\\Interfaces\\FormInterface;\nuse Grav\\Framework\\Psr7\\Response;\nuse Grav\\Framework\\RequestHandler\\Exception\\NotFoundException;\nuse Grav\\Framework\\RequestHandler\\Exception\\PageExpiredException;\nuse Grav\\Framework\\RequestHandler\\Exception\\RequestException;\nuse Grav\\Framework\\Route\\Route;\nuse Grav\\Framework\\Session\\SessionInterface;\nuse Psr\\Http\\Message\\ResponseInterface;\nuse Psr\\Http\\Message\\ServerRequestInterface;\nuse Psr\\Http\\Server\\RequestHandlerInterface;\nuse RocketTheme\\Toolbox\\Event\\Event;\nuse RocketTheme\\Toolbox\\Session\\Message;\n\nabstract class AbstractController implements RequestHandlerInterface\n{\n    /** @var string */\n    protected $nonce_action = 'admin-form';\n\n    /** @var string */\n    protected $nonce_name = 'admin-nonce';\n\n    /** @var ServerRequestInterface */\n    protected $request;\n\n    /** @var Grav */\n    protected $grav;\n\n    /** @var string */\n    protected $type;\n\n    /** @var string */\n    protected $key;\n\n    /**\n     * Handle request.\n     *\n     * Fires event: admin.[directory].[task|action].[command]\n     *\n     * @param ServerRequestInterface $request\n     * @return Response\n     */\n    public function handle(ServerRequestInterface $request): ResponseInterface\n    {\n        $attributes = $request->getAttributes();\n        $this->request = $request;\n        $this->grav = $attributes['grav'] ?? Grav::instance();\n        $this->type =  $attributes['type'] ?? null;\n        $this->key =  $attributes['key'] ?? null;\n\n        /** @var Route $route */\n        $route = $attributes['route'];\n        $post = $this->getPost();\n\n        if ($this->isFormSubmit()) {\n            $form = $this->getForm();\n            $this->nonce_name = $attributes['nonce_name'] ?? $form->getNonceName();\n            $this->nonce_action = $attributes['nonce_action'] ?? $form->getNonceAction();\n        }\n\n        try {\n            $task = $request->getAttribute('task') ?? $post['task'] ?? $route->getParam('task');\n            if ($task) {\n                if (empty($attributes['forwarded'])) {\n                    $this->checkNonce($task);\n                }\n                $type = 'task';\n                $command = $task;\n            } else {\n                $type = 'action';\n                $command = $request->getAttribute('action') ?? $post['action'] ?? $route->getParam('action') ?? 'display';\n            }\n            $command = strtolower($command);\n\n            $event = new Event(\n                [\n                    'controller' => $this,\n                    'response' => null\n                ]\n            );\n\n            $this->grav->fireEvent(\"admin.{$this->type}.{$type}.{$command}\", $event);\n\n            $response = $event['response'];\n            if (!$response) {\n                /** @var Inflector $inflector */\n                $inflector = $this->grav['inflector'];\n                $method = $type . $inflector::camelize($command);\n                if ($method && method_exists($this, $method)) {\n                    $response = $this->{$method}($request);\n                } else {\n                    throw new NotFoundException($request);\n                }\n            }\n        } catch (\\Exception $e) {\n            /** @var Debugger $debugger */\n            $debugger = $this->grav['debugger'];\n            $debugger->addException($e);\n\n            $response = $this->createErrorResponse($e);\n        }\n\n        if ($response instanceof Response) {\n            return $response;\n        }\n\n        return $this->createJsonResponse($response);\n    }\n\n    /**\n     * Get request.\n     *\n     * @return ServerRequestInterface\n     */\n    public function getRequest(): ServerRequestInterface\n    {\n        return $this->request;\n    }\n\n    /**\n     * @param string|null $name\n     * @param mixed $default\n     * @return mixed\n     */\n    public function getPost(string $name = null, $default = null)\n    {\n        $body = $this->request->getParsedBody();\n\n        if ($name) {\n            return $body[$name] ?? $default;\n        }\n\n        return $body;\n    }\n\n    /**\n     * Check if a form has been submitted.\n     *\n     * @return bool\n     */\n    public function isFormSubmit(): bool\n    {\n        return (bool)$this->getPost('__form-name__');\n    }\n\n    /**\n     * Get form.\n     *\n     * @param string|null $type\n     * @return FormInterface\n     */\n    public function getForm(string $type = null): FormInterface\n    {\n        $object = $this->getObject();\n        if (!$object) {\n            throw new \\RuntimeException('Not Found', 404);\n        }\n\n        $formName = $this->getPost('__form-name__');\n        $uniqueId = $this->getPost('__unique_form_id__') ?: $formName;\n\n        $form = $object->getForm($type ?? 'edit');\n        if ($uniqueId) {\n            $form->setUniqueId($uniqueId);\n        }\n\n        return $form;\n    }\n\n    /**\n     * @return FlexObjectInterface\n     */\n    abstract public function getObject();\n\n    /**\n     * Get Grav instance.\n     *\n     * @return Grav\n     */\n    public function getGrav(): Grav\n    {\n        return $this->grav;\n    }\n\n    /**\n     * Get session.\n     *\n     * @return SessionInterface\n     */\n    public function getSession(): SessionInterface\n    {\n        return $this->getGrav()['session'];\n    }\n\n    /**\n     * Display the current admin page.\n     *\n     * @return Response\n     */\n    public function createDisplayResponse(): ResponseInterface\n    {\n        return new Response(418);\n    }\n\n    /**\n     * Create custom HTML response.\n     *\n     * @param string $content\n     * @param int $code\n     * @return Response\n     */\n    public function createHtmlResponse(string $content, int $code = null): ResponseInterface\n    {\n        return new Response($code ?: 200, [], $content);\n    }\n\n    /**\n     * Create JSON response.\n     *\n     * @param array $content\n     * @return Response\n     */\n    public function createJsonResponse(array $content): ResponseInterface\n    {\n        $code = $content['code'] ?? 200;\n        if ($code >= 301 && $code <= 307) {\n            $code = 200;\n        }\n\n        return new Response($code, ['Content-Type' => 'application/json'], json_encode($content));\n    }\n\n    /**\n     * Create redirect response.\n     *\n     * @param string $url\n     * @param int $code\n     * @return Response\n     */\n    public function createRedirectResponse(string $url, int $code = null): ResponseInterface\n    {\n        if (null === $code || $code < 301 || $code > 307) {\n            $code = $this->grav['config']->get('system.pages.redirect_default_code', 302);\n        }\n\n        $accept = $this->getAccept(['application/json', 'text/html']);\n\n        if ($accept === 'application/json') {\n            return $this->createJsonResponse(['code' => $code, 'status' => 'redirect', 'redirect' => $url]);\n        }\n\n        return new Response($code, ['Location' => $url]);\n    }\n\n    /**\n     * Create error response.\n     *\n     * @param  \\Exception $exception\n     * @return Response\n     */\n    public function createErrorResponse(\\Exception $exception): ResponseInterface\n    {\n        $validCodes = [\n            400, 401, 402, 403, 404, 405, 406, 407, 408, 409, 410, 411, 412, 413, 414, 415, 416, 417, 418,\n            422, 423, 424, 425, 426, 428, 429, 431, 451, 500, 501, 502, 503, 504, 505, 506, 507, 508, 511\n        ];\n\n        if ($exception instanceof RequestException) {\n            $code = $exception->getHttpCode();\n            $reason = $exception->getHttpReason();\n        } else {\n            $code = $exception->getCode();\n            $reason = null;\n        }\n\n        if (!in_array($code, $validCodes, true)) {\n            $code = 500;\n        }\n\n        $message = $exception->getMessage();\n        $response = [\n            'code' => $code,\n            'status' => 'error',\n            'message' => htmlspecialchars($message, ENT_QUOTES | ENT_HTML5, 'UTF-8')\n        ];\n\n        $accept = $this->getAccept(['application/json', 'text/html']);\n\n        if ($accept === 'text/html') {\n            $method = $this->getRequest()->getMethod();\n\n            // On POST etc, redirect back to the previous page.\n            if ($method !== 'GET' && $method !== 'HEAD') {\n                $this->setMessage($message, 'error');\n                $referer = $this->request->getHeaderLine('Referer');\n                return $this->createRedirectResponse($referer, 303);\n            }\n\n            // TODO: improve error page\n            return $this->createHtmlResponse($response['message']);\n        }\n\n        return new Response($code, ['Content-Type' => 'application/json'], json_encode($response), '1.1', $reason);\n    }\n\n    /**\n     * Translate a string.\n     *\n     * @param  string $string\n     * @return string\n     */\n    public function translate(string $string): string\n    {\n        /** @var Language $language */\n        $language = $this->grav['language'];\n\n        return $language->translate($string);\n    }\n\n    /**\n     * Set message to be shown in the admin.\n     *\n     * @param  string $message\n     * @param  string $type\n     * @return $this\n     */\n    public function setMessage($message, $type = 'info')\n    {\n        /** @var Message $messages */\n        $messages = $this->grav['messages'];\n        $messages->add($message, $type);\n\n        return $this;\n    }\n\n    /**\n     * Check if request nonce is valid.\n     *\n     * @param  string $task\n     * @throws PageExpiredException  If nonce is not valid.\n     */\n    protected function checkNonce(string $task): void\n    {\n        $nonce = null;\n\n        if (\\in_array(strtoupper($this->request->getMethod()), ['POST', 'PUT', 'PATCH', 'DELETE'])) {\n            $nonce = $this->getPost($this->nonce_name);\n        }\n\n        if (!$nonce) {\n            $nonce = $this->grav['uri']->param($this->nonce_name);\n        }\n\n        if (!$nonce) {\n            $nonce = $this->grav['uri']->query($this->nonce_name);\n        }\n\n        if (!$nonce || !Utils::verifyNonce($nonce, $this->nonce_action)) {\n            throw new PageExpiredException($this->request);\n        }\n    }\n\n    /**\n     * Return the best matching mime type for the request.\n     *\n     * @param  string[] $compare\n     * @return string|null\n     */\n    protected function getAccept(array $compare): ?string\n    {\n        $accepted = [];\n        foreach ($this->request->getHeader('Accept') as $accept) {\n            foreach (explode(',', $accept) as $item) {\n                if (!$item) {\n                    continue;\n                }\n\n                $split = explode(';q=', $item);\n                $mime = array_shift($split);\n                $priority = array_shift($split) ?? 1.0;\n\n                $accepted[$mime] = $priority;\n            }\n        }\n\n        arsort($accepted);\n\n        // TODO: add support for image/* etc\n        $list = array_intersect($compare, array_keys($accepted));\n        if (!$list && (isset($accepted['*/*']) || isset($accepted['*']))) {\n            return reset($compare) ?: null;\n        }\n\n        return reset($list) ?: null;\n    }\n}\n"], "filenames": ["CHANGELOG.md", "classes/plugin/AdminBaseController.php", "classes/plugin/AdminController.php", "classes/plugin/Controllers/AbstractController.php"], "buggy_code_start_loc": [0, 274, 291, 295], "buggy_code_end_loc": [0, 384, 2504, 296], "fixing_code_start_loc": [1, 274, 291, 295], "fixing_code_end_loc": [7, 388, 2504, 296], "type": "CWE-79", "message": "grav-plugin-admin is vulnerable to Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')", "other": {"cve": {"id": "CVE-2021-3920", "sourceIdentifier": "security@huntr.dev", "published": "2021-11-19T13:15:09.830", "lastModified": "2021-11-23T17:46:38.040", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "grav-plugin-admin is vulnerable to Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')"}, {"lang": "es", "value": "grav-plugin-admin es vulnerable a una Neutralizaci\u00f3n Inapropiada de Entradas durante la Generaci\u00f3n de P\u00e1ginas Web (\"Cross-site Scripting\")"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:U/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 4.6, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.1, "impactScore": 2.5}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 3.5}, "baseSeverity": "LOW", "exploitabilityScore": 6.8, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}, {"source": "security@huntr.dev", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:getgrav:grav-plugin-admin:*:*:*:*:*:*:*:*", "versionEndExcluding": "1.10.25", "matchCriteriaId": "D8845823-7B7D-41B3-99BC-1219F221BB5F"}]}]}], "references": [{"url": "https://github.com/getgrav/grav-plugin-admin/commit/6463135bf046d8131189c163158cd5db8f7a9675", "source": "security@huntr.dev", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://huntr.dev/bounties/ab564760-90c6-4e1d-80c2-852f45034cd1", "source": "security@huntr.dev", "tags": ["Exploit", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/getgrav/grav-plugin-admin/commit/6463135bf046d8131189c163158cd5db8f7a9675"}}