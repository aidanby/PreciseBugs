{"buggy_code": ["<?php\n\n/**\n * The send2friend page.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @package   phpMyFAQ\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2002-2022 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      https://www.phpmyfaq.de\n * @since     2002-09-16\n */\n\nuse phpMyFAQ\\Captcha;\nuse phpMyFAQ\\Filter;\nuse phpMyFAQ\\Helper\\CaptchaHelper;\nuse phpMyFAQ\\Helper\\HttpHelper;\nuse phpMyFAQ\\Strings;\nuse phpMyFAQ\\User\\CurrentUser;\n\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    http_response_code(400);\n    exit();\n}\n\n$http = new HttpHelper();\n$captcha = new Captcha($faqConfig);\n$captchaHelper = new CaptchaHelper($faqConfig);\n\nif (!$faqConfig->get('main.enableSendToFriend')) {\n    $http->setStatus(403);\n    $http->redirect($faqConfig->getDefaultUrl());\n}\n\n$captcha->setSessionId($sids);\n\nif (!is_null($showCaptcha)) {\n    $captcha->drawCaptchaImage();\n    exit;\n}\n\ntry {\n    $faqSession->userTracking('send2friend', 0);\n} catch (Exception $e) {\n    // @todo handle the exception\n}\n\n$cat = Filter::filterInput(INPUT_GET, 'cat', FILTER_VALIDATE_INT);\n$id = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);\n$faqLanguage = Filter::filterInput(INPUT_GET, 'artlang', FILTER_UNSAFE_RAW);\n\n$send2friendLink = sprintf(\n    '%sindex.php?action=faq&amp;cat=%d&amp;id=%d&amp;artlang=%s',\n    $faqConfig->getDefaultUrl(),\n    (int)$cat,\n    (int)$id,\n    urlencode($faqLanguage)\n);\n\n\n$template->parse(\n    'mainPageContent',\n    [\n        'lang' => $faqLanguage,\n        'msgSend2Friend' => $PMF_LANG['msgSend2Friend'],\n        'msgS2FReferrer' => 'link',\n        'msgS2FName' => $PMF_LANG['msgS2FName'],\n        'msgS2FEMail' => $PMF_LANG['msgS2FEMail'],\n        'defaultContentMail' => ($user instanceof CurrentUser) ? $user->getUserData('email') : '',\n        'defaultContentName' => ($user instanceof CurrentUser) ? $user->getUserData('display_name') : '',\n        'msgS2FFriends' => $PMF_LANG['msgS2FFriends'],\n        'msgS2FEMails' => $PMF_LANG['msgS2FEMails'],\n        'msgS2FText' => $PMF_LANG['msgS2FText'],\n        'send2friend_text' => Strings::htmlentities($faqConfig->get('main.send2friendText')),\n        'msgS2FText2' => $PMF_LANG['msgS2FText2'],\n        'send2friendLink' => $send2friendLink,\n        'msgS2FMessage' => $PMF_LANG['msgS2FMessage'],\n        'captchaFieldset' => $captchaHelper->renderCaptcha($captcha, 'send2friend', $PMF_LANG['msgCaptcha'], $auth),\n        'msgS2FButton' => $PMF_LANG['msgS2FButton'],\n    ]\n);\n\n$template->parseBlock(\n    'index',\n    'breadcrumb',\n    [\n        'breadcrumbHeadline' => $PMF_LANG['msgSend2Friend']\n    ]\n);\n", "<?php\n\n/**\n * HTML5 Export class for phpMyFAQ.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @package   phpMyFAQ\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2009-2022 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      https://www.phpmyfaq.de\n * @since     2009-10-07\n */\n\nnamespace phpMyFAQ\\Export;\n\nuse phpMyFAQ\\Category;\nuse phpMyFAQ\\Configuration;\nuse phpMyFAQ\\Date;\nuse phpMyFAQ\\Export;\nuse phpMyFAQ\\Faq;\nuse phpMyFAQ\\Init;\nuse phpMyFAQ\\Strings;\nuse XMLWriter;\n\n/**\n * Class Html5\n *\n * @package phpMyFAQ\\Export\n */\nclass Html5 extends Export\n{\n    /**\n     * XMLWriter object.\n     *\n     * @var XMLWriter\n     */\n    private $xml;\n\n    /**\n     * Constructor.\n     *\n     * @param Faq           $faq      FaqHelper object\n     * @param Category      $category CategoryHelper object\n     * @param Configuration $config   Configuration\n     *                                return\n     *                                PMF_Export_Xhtml\n     */\n    public function __construct(Faq $faq, Category $category, Configuration $config)\n    {\n        $this->faq = $faq;\n        $this->category = $category;\n        $this->config = $config;\n        $this->xml = new XMLWriter();\n\n        $this->xml->openMemory();\n        $this->xml->setIndent(true);\n    }\n\n    /**\n     * Generates the export.\n     *\n     * @param int    $categoryId CategoryHelper Id\n     * @param bool   $downwards  If true, downwards, otherwise upward ordering\n     * @param string $language   Language\n     *\n     * @return string\n     */\n    public function generate(int $categoryId = 0, bool $downwards = true, string $language = ''): string\n    {\n        global $PMF_LANG;\n\n        // Initialize categories\n        $this->category->transform($categoryId);\n\n        $faqData = $this->faq->get(FAQ_QUERY_TYPE_EXPORT_XHTML, $categoryId, $downwards, $language);\n        $version = $this->config->getVersion();\n        $comment = sprintf(\n            ' HTML5 output by phpMyFAQ %s | Date: %s ',\n            $version,\n            Date::createIsoDate(date('YmdHis'))\n        );\n\n        $this->xml->startDTD('html');\n        $this->xml->startElement('html');\n\n        $this->xml->writeComment($comment);\n\n        $this->xml->startElement('head');\n        $this->xml->writeElement('title', $this->config->getTitle());\n        $this->xml->startElement('meta');\n        $this->xml->writeAttribute('charset', 'utf-8');\n        $this->xml->endElement();\n        $this->xml->endElement(); // </head>\n\n        $this->xml->startElement('body');\n        $this->xml->writeAttribute('dir', $PMF_LANG['dir']);\n\n        if (count($faqData)) {\n            $lastCategory = 0;\n            foreach ($faqData as $data) {\n                if ($data['category_id'] != $lastCategory) {\n                    $this->xml->writeElement('h1', $this->category->getPath($data['category_id'], ' >> '));\n                }\n\n                $this->xml->startElement('h2');\n                $this->xml->writeAttribute('id', \"entry-\" . $data['solution_id']);\n                $this->xml->text(strip_tags($data['topic']));\n                $this->xml->endElement();\n                $this->xml->startElement('p');\n                $this->xml->writeCdata(html_entity_decode($data['content'], ENT_HTML5, 'UTF-8'));\n                $this->xml->endElement();\n                $this->xml->writeElement('p', $PMF_LANG['msgAuthor'] . ': ' . $data['author_email']);\n                $this->xml->writeElement(\n                    'p',\n                    $PMF_LANG['msgLastUpdateArticle'] . Date::createIsoDate($data['lastmodified'])\n                );\n\n                $lastCategory = $data['category_id'];\n            }\n        }\n\n        $this->xml->endElement(); // </body>\n        $this->xml->endElement(); // </html>\n\n        header('Content-type: text/html');\n\n        return $this->xml->outputMemory();\n    }\n}\n"], "fixing_code": ["<?php\n\n/**\n * The send2friend page.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @package   phpMyFAQ\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2002-2022 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      https://www.phpmyfaq.de\n * @since     2002-09-16\n */\n\nuse phpMyFAQ\\Captcha;\nuse phpMyFAQ\\Filter;\nuse phpMyFAQ\\Helper\\CaptchaHelper;\nuse phpMyFAQ\\Helper\\HttpHelper;\nuse phpMyFAQ\\Strings;\nuse phpMyFAQ\\User\\CurrentUser;\n\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    http_response_code(400);\n    exit();\n}\n\n$http = new HttpHelper();\n$captcha = new Captcha($faqConfig);\n$captchaHelper = new CaptchaHelper($faqConfig);\n\nif (!$faqConfig->get('main.enableSendToFriend')) {\n    $http->setStatus(403);\n    $http->redirect($faqConfig->getDefaultUrl());\n}\n\n$captcha->setSessionId($sids);\n\nif (!is_null($showCaptcha)) {\n    $captcha->drawCaptchaImage();\n    exit;\n}\n\ntry {\n    $faqSession->userTracking('send2friend', 0);\n} catch (Exception $e) {\n    // @todo handle the exception\n}\n\n$cat = Filter::filterInput(INPUT_GET, 'cat', FILTER_VALIDATE_INT);\n$id = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);\n$faqLanguage = Filter::filterInput(INPUT_GET, 'artlang', FILTER_UNSAFE_RAW);\n\n$send2friendLink = sprintf(\n    '%sindex.php?action=faq&amp;cat=%d&amp;id=%d&amp;artlang=%s',\n    $faqConfig->getDefaultUrl(),\n    (int)$cat,\n    (int)$id,\n    urlencode($faqLanguage)\n);\n\n\n$template->parse(\n    'mainPageContent',\n    [\n        'lang' => Strings::htmlentities($faqLanguage),\n        'msgSend2Friend' => $PMF_LANG['msgSend2Friend'],\n        'msgS2FReferrer' => 'link',\n        'msgS2FName' => $PMF_LANG['msgS2FName'],\n        'msgS2FEMail' => $PMF_LANG['msgS2FEMail'],\n        'defaultContentMail' => ($user instanceof CurrentUser) ? $user->getUserData('email') : '',\n        'defaultContentName' => ($user instanceof CurrentUser) ? $user->getUserData('display_name') : '',\n        'msgS2FFriends' => $PMF_LANG['msgS2FFriends'],\n        'msgS2FEMails' => $PMF_LANG['msgS2FEMails'],\n        'msgS2FText' => $PMF_LANG['msgS2FText'],\n        'send2friend_text' => Strings::htmlentities($faqConfig->get('main.send2friendText')),\n        'msgS2FText2' => $PMF_LANG['msgS2FText2'],\n        'send2friendLink' => $send2friendLink,\n        'msgS2FMessage' => $PMF_LANG['msgS2FMessage'],\n        'captchaFieldset' => $captchaHelper->renderCaptcha($captcha, 'send2friend', $PMF_LANG['msgCaptcha'], $auth),\n        'msgS2FButton' => $PMF_LANG['msgS2FButton'],\n    ]\n);\n\n$template->parseBlock(\n    'index',\n    'breadcrumb',\n    [\n        'breadcrumbHeadline' => $PMF_LANG['msgSend2Friend']\n    ]\n);\n", "<?php\n\n/**\n * HTML5 Export class for phpMyFAQ.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @package   phpMyFAQ\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2009-2022 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      https://www.phpmyfaq.de\n * @since     2009-10-07\n */\n\nnamespace phpMyFAQ\\Export;\n\nuse phpMyFAQ\\Category;\nuse phpMyFAQ\\Configuration;\nuse phpMyFAQ\\Date;\nuse phpMyFAQ\\Export;\nuse phpMyFAQ\\Faq;\nuse phpMyFAQ\\Strings;\nuse XMLWriter;\n\n/**\n * Class Html5\n *\n * @package phpMyFAQ\\Export\n */\nclass Html5 extends Export\n{\n    /**\n     * XMLWriter object.\n     *\n     * @var XMLWriter\n     */\n    private $xml;\n\n    /**\n     * Constructor.\n     *\n     * @param Faq           $faq      FaqHelper object\n     * @param Category      $category CategoryHelper object\n     * @param Configuration $config   Configuration\n     *                                return\n     *                                PMF_Export_Xhtml\n     */\n    public function __construct(Faq $faq, Category $category, Configuration $config)\n    {\n        $this->faq = $faq;\n        $this->category = $category;\n        $this->config = $config;\n        $this->xml = new XMLWriter();\n\n        $this->xml->openMemory();\n        $this->xml->setIndent(true);\n    }\n\n    /**\n     * Generates the export.\n     *\n     * @param int    $categoryId CategoryHelper Id\n     * @param bool   $downwards  If true, downwards, otherwise upward ordering\n     * @param string $language   Language\n     *\n     * @return string\n     */\n    public function generate(int $categoryId = 0, bool $downwards = true, string $language = ''): string\n    {\n        global $PMF_LANG;\n\n        // Initialize categories\n        $this->category->transform($categoryId);\n\n        $faqData = $this->faq->get(FAQ_QUERY_TYPE_EXPORT_XHTML, $categoryId, $downwards, $language);\n        $version = $this->config->getVersion();\n        $comment = sprintf(\n            ' HTML5 output by phpMyFAQ %s | Date: %s ',\n            $version,\n            Date::createIsoDate(date('YmdHis'))\n        );\n\n        $this->xml->startDTD('html');\n        $this->xml->startElement('html');\n\n        $this->xml->writeComment($comment);\n\n        $this->xml->startElement('head');\n        $this->xml->writeElement('title', $this->config->getTitle());\n        $this->xml->startElement('meta');\n        $this->xml->writeAttribute('charset', 'utf-8');\n        $this->xml->endElement();\n        $this->xml->endElement(); // </head>\n\n        $this->xml->startElement('body');\n        $this->xml->writeAttribute('dir', $PMF_LANG['dir']);\n\n        if (count($faqData)) {\n            $lastCategory = 0;\n            foreach ($faqData as $data) {\n                if ($data['category_id'] != $lastCategory) {\n                    $this->xml->writeElement('h1', $this->category->getPath($data['category_id'], ' >> '));\n                }\n\n                $this->xml->startElement('h2');\n                $this->xml->writeAttribute('id', \"entry-\" . $data['solution_id']);\n                $this->xml->text(Strings::htmlentities($data['topic']));\n                $this->xml->endElement();\n                $this->xml->startElement('p');\n                $this->xml->writeCdata(html_entity_decode($data['content'], ENT_HTML5, 'UTF-8'));\n                $this->xml->endElement();\n                $this->xml->writeElement('p', $PMF_LANG['msgAuthor'] . ': ' . $data['author_email']);\n                $this->xml->writeElement(\n                    'p',\n                    $PMF_LANG['msgLastUpdateArticle'] . Date::createIsoDate($data['lastmodified'])\n                );\n\n                $lastCategory = $data['category_id'];\n            }\n        }\n\n        $this->xml->endElement(); // </body>\n        $this->xml->endElement(); // </html>\n\n        header('Content-type: text/html');\n\n        return $this->xml->outputMemory();\n    }\n}\n"], "filenames": ["phpmyfaq/send2friend.php", "phpmyfaq/src/phpMyFAQ/Export/Html5.php"], "buggy_code_start_loc": [68, 25], "buggy_code_end_loc": [69, 112], "fixing_code_start_loc": [68, 24], "fixing_code_end_loc": [69, 111], "type": "CWE-79", "message": "Cross-site Scripting (XSS) - Reflected in GitHub repository thorsten/phpmyfaq prior to 3.1.12.", "other": {"cve": {"id": "CVE-2023-1880", "sourceIdentifier": "security@huntr.dev", "published": "2023-04-05T17:15:07.133", "lastModified": "2023-04-11T18:16:15.267", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Cross-site Scripting (XSS) - Reflected in GitHub repository thorsten/phpmyfaq prior to 3.1.12."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:L", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "LOW", "baseScore": 8.3, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.5}]}, "weaknesses": [{"source": "security@huntr.dev", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:phpmyfaq:phpmyfaq:*:*:*:*:*:*:*:*", "versionEndExcluding": "3.1.12", "matchCriteriaId": "653EC167-06FC-4D30-AAF8-B75F596519AE"}]}]}], "references": [{"url": "https://github.com/thorsten/phpmyfaq/commit/bbc5d4aa4a4375c14e34dd9fcad2042066fe476d", "source": "security@huntr.dev", "tags": ["Patch"]}, {"url": "https://huntr.dev/bounties/ece5f051-674e-4919-b998-594714910f9e", "source": "security@huntr.dev", "tags": ["Exploit", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/thorsten/phpmyfaq/commit/bbc5d4aa4a4375c14e34dd9fcad2042066fe476d"}}