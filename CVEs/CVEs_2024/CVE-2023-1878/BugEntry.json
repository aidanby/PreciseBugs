{"buggy_code": ["<?php\n\n/**\n * Overview of actions in the admin section.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @package   phpMyFAQ\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2003-2022 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      https://www.phpmyfaq.de\n * @since     2003-02-23\n */\n\nuse phpMyFAQ\\Date;\nuse phpMyFAQ\\Filter;\nuse phpMyFAQ\\Logging;\nuse phpMyFAQ\\Pagination;\nuse phpMyFAQ\\Strings;\n\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    http_response_code(400);\n    exit();\n}\n\n$logging = new Logging($faqConfig);\n$csrfToken = Filter::filterInput(INPUT_GET, 'csrf', FILTER_UNSAFE_RAW);\n\nif (!isset($_SESSION['phpmyfaq_csrf_token']) || $_SESSION['phpmyfaq_csrf_token'] !== $csrfToken) {\n    $deleteLog = false;\n} else {\n    $deleteLog = true;\n}\n\nif ($user->perm->hasPermission($user->getUserId(), 'adminlog') && 'adminlog' == $action) {\n    $date = new Date($faqConfig);\n    $perpage = 15;\n    $pages = Filter::filterInput(INPUT_GET, 'pages', FILTER_VALIDATE_INT);\n    $page = Filter::filterInput(INPUT_GET, 'page', FILTER_VALIDATE_INT, 1);\n\n    if (is_null($pages)) {\n        $pages = round(($logging->getNumberOfEntries() + ($perpage / 3)) / $perpage, 0);\n    }\n\n    $start = ($page - 1) * $perpage;\n    $lastPage = $start + $perpage;\n\n    $baseUrl = sprintf(\n        '%sadmin/?action=adminlog&amp;page=%d',\n        $faqConfig->getDefaultUrl(),\n        $page\n    );\n\n    // Pagination options\n    $options = [\n        'baseUrl' => $baseUrl,\n        'total' => $logging->getNumberOfEntries(),\n        'perPage' => $perpage,\n        'pageParamName' => 'page',\n    ];\n    $pagination = new Pagination($faqConfig, $options);\n\n    $loggingData = $logging->getAll();\n    ?>\n    <header class=\"row\">\n        <div class=\"col-lg-12\">\n            <h2 class=\"page-header\">\n                <i aria-hidden=\"true\" class=\"fa fa-tasks\"></i> <?= $PMF_LANG['ad_menu_adminlog'] ?>\n                <div class=\"float-right\">\n                    <a class=\"btn btn-danger\"\n                       href=\"?action=deleteadminlog&csrf=<?= $user->getCsrfTokenFromSession() ?>\">\n                        <i aria-hidden=\"true\" class=\"fa fa-trash\"></i> <?= $PMF_LANG['ad_adminlog_del_older_30d'] ?>\n                    </a>\n                </div>\n            </h2>\n        </div>\n    </header>\n\n    <table class=\"table table-striped\">\n    <thead>\n        <tr>\n            <th><?= $PMF_LANG['ad_categ_id'] ?></th>\n            <th><?= $PMF_LANG['ad_adminlog_date'] ?></th>\n            <th><?= $PMF_LANG['ad_adminlog_user'] ?></th>\n            <th colspan=\"2\"><?= $PMF_LANG['ad_adminlog_ip'] ?></th>\n        </tr>\n    </thead>\n    <tfoot>\n        <tr>\n            <td colspan=\"5\"><?= $pagination->render() ?></td>\n        </tr>\n    </tfoot>\n    <tbody>\n    <?php\n    $counter = $displayedCounter = 0;\n\n    foreach ($loggingData as $loggingId => $loggingValue) {\n        if ($displayedCounter >= $perpage) {\n            ++$displayedCounter;\n            continue;\n        }\n\n        ++$counter;\n        if ($counter <= $start) {\n            continue;\n        }\n        ++$displayedCounter;\n\n        $user->getUserById($loggingValue['usr'], true);\n        ?>\n        <tr>\n            <td><?= $loggingId ?></td>\n            <td><?= $date->format(date('Y-m-d H:i', $loggingValue['time'])) ?></td>\n            <td><?= Strings::htmlentities($user->getLogin()) ?></td>\n            <td><?= $loggingValue['ip'] ?></td>\n            <td><small><?php\n            $text = $loggingValue['text'];\n            $text = str_replace('Loginerror', $PMF_LANG['ad_log_lger'], $text);\n            $text = str_replace('Session expired', $PMF_LANG['ad_log_sess'], $text);\n            $text = str_replace('Useredit, ', $PMF_LANG['ad_log_edit'], $text);\n            $text = str_replace('admin-save-new-faq', $PMF_LANG['ad_log_crsa'], $text);\n            $text = str_replace('admin-add-faq', $PMF_LANG['ad_log_crea'], $text);\n            $text = str_replace('Usersave, ', $PMF_LANG['ad_log_ussa'], $text);\n            $text = str_replace('Userdel, ', $PMF_LANG['ad_log_usde'], $text);\n            $text = str_replace('admin-edit-faq, ', $PMF_LANG['ad_log_beed'], $text);\n            $text = str_replace('Beitragdel, ', $PMF_LANG['ad_log_bede'], $text);\n            echo $text;\n            ?></small>\n            </td>\n        </tr>\n        <?php\n    }\n    ?>\n    </tbody>\n    </table>\n\n    <?php\n} elseif ($user->perm->hasPermission($user->getUserId(), 'adminlog') && 'deleteadminlog' == $action && $deleteLog) {\n    if ($logging->delete()) {\n        printf('<p class=\"alert alert-success\">%s</p>', $PMF_LANG['ad_adminlog_delete_success']);\n    } else {\n        printf('<p class=\"alert alert-danger\">%s</p>', $PMF_LANG['ad_adminlog_delete_failure']);\n    }\n} else {\n    echo $PMF_LANG['err_NotAuth'];\n}\n"], "fixing_code": ["<?php\n\n/**\n * Overview of actions in the admin section.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @package   phpMyFAQ\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2003-2022 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      https://www.phpmyfaq.de\n * @since     2003-02-23\n */\n\nuse phpMyFAQ\\Date;\nuse phpMyFAQ\\Filter;\nuse phpMyFAQ\\Logging;\nuse phpMyFAQ\\Pagination;\nuse phpMyFAQ\\Strings;\n\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    http_response_code(400);\n    exit();\n}\n\n$logging = new Logging($faqConfig);\n$csrfToken = Filter::filterInput(INPUT_GET, 'csrf', FILTER_UNSAFE_RAW);\n\nif (!isset($_SESSION['phpmyfaq_csrf_token']) || $_SESSION['phpmyfaq_csrf_token'] !== $csrfToken) {\n    $deleteLog = false;\n} else {\n    $deleteLog = true;\n}\n\nif ($user->perm->hasPermission($user->getUserId(), 'adminlog') && 'adminlog' === $action) {\n    $date = new Date($faqConfig);\n    $perpage = 15;\n    $pages = Filter::filterInput(INPUT_GET, 'pages', FILTER_VALIDATE_INT);\n    $page = Filter::filterInput(INPUT_GET, 'page', FILTER_VALIDATE_INT, 1);\n\n    if (is_null($pages)) {\n        $pages = round(($logging->getNumberOfEntries() + ($perpage / 3)) / $perpage, 0);\n    }\n\n    $start = ($page - 1) * $perpage;\n    $lastPage = $start + $perpage;\n\n    $baseUrl = sprintf(\n        '%sadmin/?action=adminlog&amp;page=%d',\n        $faqConfig->getDefaultUrl(),\n        $page\n    );\n\n    // Pagination options\n    $options = [\n        'baseUrl' => $baseUrl,\n        'total' => $logging->getNumberOfEntries(),\n        'perPage' => $perpage,\n        'pageParamName' => 'page',\n    ];\n    $pagination = new Pagination($faqConfig, $options);\n\n    $loggingData = $logging->getAll();\n    ?>\n    <header class=\"row\">\n        <div class=\"col-lg-12\">\n            <h2 class=\"page-header\">\n                <i aria-hidden=\"true\" class=\"fa fa-tasks\"></i> <?= $PMF_LANG['ad_menu_adminlog'] ?>\n                <div class=\"float-right\">\n                    <a class=\"btn btn-danger\"\n                       href=\"?action=deleteadminlog&csrf=<?= $user->getCsrfTokenFromSession() ?>\">\n                        <i aria-hidden=\"true\" class=\"fa fa-trash\"></i> <?= $PMF_LANG['ad_adminlog_del_older_30d'] ?>\n                    </a>\n                </div>\n            </h2>\n        </div>\n    </header>\n\n    <table class=\"table table-striped\">\n    <thead>\n        <tr>\n            <th><?= $PMF_LANG['ad_categ_id'] ?></th>\n            <th><?= $PMF_LANG['ad_adminlog_date'] ?></th>\n            <th><?= $PMF_LANG['ad_adminlog_user'] ?></th>\n            <th colspan=\"2\"><?= $PMF_LANG['ad_adminlog_ip'] ?></th>\n        </tr>\n    </thead>\n    <tfoot>\n        <tr>\n            <td colspan=\"5\"><?= $pagination->render() ?></td>\n        </tr>\n    </tfoot>\n    <tbody>\n    <?php\n    $counter = $displayedCounter = 0;\n\n    foreach ($loggingData as $loggingId => $loggingValue) {\n        if ($displayedCounter >= $perpage) {\n            ++$displayedCounter;\n            continue;\n        }\n\n        ++$counter;\n        if ($counter <= $start) {\n            continue;\n        }\n        ++$displayedCounter;\n\n        $user->getUserById($loggingValue['usr'], true);\n        ?>\n        <tr>\n            <td><?= $loggingId ?></td>\n            <td><?= $date->format(date('Y-m-d H:i', $loggingValue['time'])) ?></td>\n            <td><?= Strings::htmlentities($user->getLogin()) ?></td>\n            <td><?= $loggingValue['ip'] ?></td>\n            <td><small><?php\n            $text = Strings::htmlentities($loggingValue['text']);\n            $text = str_replace('Loginerror', $PMF_LANG['ad_log_lger'], $text);\n            $text = str_replace('Session expired', $PMF_LANG['ad_log_sess'], $text);\n            $text = str_replace('Useredit, ', $PMF_LANG['ad_log_edit'], $text);\n            $text = str_replace('admin-save-new-faq', $PMF_LANG['ad_log_crsa'], $text);\n            $text = str_replace('admin-add-faq', $PMF_LANG['ad_log_crea'], $text);\n            $text = str_replace('Usersave, ', $PMF_LANG['ad_log_ussa'], $text);\n            $text = str_replace('Userdel, ', $PMF_LANG['ad_log_usde'], $text);\n            $text = str_replace('admin-edit-faq, ', $PMF_LANG['ad_log_beed'], $text);\n            $text = str_replace('Beitragdel, ', $PMF_LANG['ad_log_bede'], $text);\n            echo $text;\n            ?></small>\n            </td>\n        </tr>\n        <?php\n    }\n    ?>\n    </tbody>\n    </table>\n\n    <?php\n} elseif ($user->perm->hasPermission($user->getUserId(), 'adminlog') && 'deleteadminlog' === $action && $deleteLog) {\n    if ($logging->delete()) {\n        printf('<p class=\"alert alert-success\">%s</p>', $PMF_LANG['ad_adminlog_delete_success']);\n    } else {\n        printf('<p class=\"alert alert-danger\">%s</p>', $PMF_LANG['ad_adminlog_delete_failure']);\n    }\n} else {\n    echo $PMF_LANG['err_NotAuth'];\n}\n"], "filenames": ["phpmyfaq/admin/stat.adminlog.php"], "buggy_code_start_loc": [38], "buggy_code_end_loc": [142], "fixing_code_start_loc": [38], "fixing_code_end_loc": [142], "type": "CWE-79", "message": "Cross-site Scripting (XSS) - Stored in GitHub repository thorsten/phpmyfaq prior to 3.1.12.", "other": {"cve": {"id": "CVE-2023-1878", "sourceIdentifier": "security@huntr.dev", "published": "2023-04-05T17:15:07.037", "lastModified": "2023-04-11T18:15:52.777", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Cross-site Scripting (XSS) - Stored in GitHub repository thorsten/phpmyfaq prior to 3.1.12."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:L", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "LOW", "baseScore": 8.3, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.5}]}, "weaknesses": [{"source": "security@huntr.dev", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:phpmyfaq:phpmyfaq:*:*:*:*:*:*:*:*", "versionEndExcluding": "3.1.12", "matchCriteriaId": "653EC167-06FC-4D30-AAF8-B75F596519AE"}]}]}], "references": [{"url": "https://github.com/thorsten/phpmyfaq/commit/e018823f8e3bca103c11e5a98b0dd469e41ed417", "source": "security@huntr.dev", "tags": ["Patch"]}, {"url": "https://huntr.dev/bounties/93f981a3-231d-460d-a239-bb960e8c2fdc", "source": "security@huntr.dev", "tags": ["Exploit", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/thorsten/phpmyfaq/commit/e018823f8e3bca103c11e5a98b0dd469e41ed417"}}