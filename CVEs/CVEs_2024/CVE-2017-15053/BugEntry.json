{"buggy_code": ["2.1.27\n 9/\n Fixed a possible XSS (credit to ADLab of Venustech)\n Improved security related to User Management\n \t> a manager could potentially act on users not related to him\n Improved security related to Items Management\n \t> a user could potentially act on Items he should not have access to\n Securized script.backup.php by adding a security key\n Fixed some other security failures (credit to \u200bsecurity at Amossys)\n Improved security regarding uploading files\n Fixed issue while restoring DB from administration page\n Improved / Fixed administration task for encrypting/decrypting files\n Improved security regarding item history display\n #1947 Dependency & array update in install checks\n #1945 Cannot delete items\n #1944 File upload results in error\n #1941 Visualisation problems\n\n 8/\n Delete install folders and files during installation process\n Custom Field value can be masked\n Database password is encrypted in settings.php file\n PHPMailer library updated to 5.2.23\n TwoFactorAuth library was updated\n Configuration variables are not set in SESSION anymore. Now read from tp.config.php file.\n Fix: issue on offline export\n Fix: error on deleting a folder at root\n #1939 Unable to change page (role management)\n #1937 Error while using script.backup.php in standalone\n #1935 Add folder results in Requested JSON parse failed\n #1933 Trying to move folder results in error message\n #1932 Keepass upload fails\n #1927 Changing language is not possible for users\n #1924 Moving items give error: Requested JSON parse failed\n #1923 Red wheel keeps turning, blocks display of new items\n #1919 Upgrade to release 2.1.27.8 converts encrypted database password back to clear-text\n #1915 Cannot Edit or Delete items in the Personal folder\n #1909 Roles Management - Problem with acess rights \"Edit\" \"Delete\"\n #1903 SSH Password Change does not work\n #1900 Forgot your password --> Page reload automatic\n #1891 Install error - Uncaught Defuse\\\\Crypto\\\\Exception\\\\BadFormatException: Encoded data is shorter than expected\n #1899 Active Directory authentication not working on fresh installed Cent OS 7\n #1890 access rights in manage roles\n #1888 Export to CVS --> empty file (0 kb)\n #1886 JSON Error when importing with an apostrophe (\u2018)\n #1885 Undefined index: SSL_SERVER_CERT\n #1884 Cannot delete custom fields - hangs indefinitely after confirm with spinning gear\n #1882 Can't see any entry on any folder, using any account\n #1881 Doesn't auto-delete install/ folder after installation completed\n #1880 Custom Fields, Not encrypted/decrypted when toggled in Custom-Field Settings Screen\n #1872 New Admin User login not working -JSON Parse file failure\n #1870 Logic issue in headers sending\n #1866 CSV import with empty url leads to value 0\n #1862 Import from Keepass.xml to Personalfolder no access to Item\n #1857 API: Folders created at level 0 instead of correct level\n #1856 Robustified tp.config.php creation in case of upgrade\n #1851 Fix ldap suffix\n #1850 Missing iconv in Docker\n #1840 Added the \"download\" attribute\n #1837 JSON error in Find page when user has no folders to browse\n #1834 Typo in sources/main.functions.php\n #1833 Opening a one time view page give a notice: A session had already been started...\n #1830 Salt key field has already a character filled in.\n #1829 Attachments is broken after upgrade from 2.1.27.0. Fix in progress\n #1828 No error message when duplicate item names at personal keys\n #1826 New dockerfile and docker-compose.yml\n #1820 group vertical scroll bar not work correctly\n #1819 Fix for QR sending from login page\n\n 6-7/\n Fix: upgrade process with encrypted attachments\n Fix for #1806\n\n 5/\n New: Custom Fields are only visible if defined\n Fix issue in tree if subfolder is visible while parent is not\n Fix issues regarding DUOSecurity\n Fix upgrade doesn't start in case that sk.php file has moved\n Fix for Custom Fields not displayed as defined by `order` field\n #1796 Can't add folder from API\n #1787 email notifications are not sent if there are any admins with empty email address\n #1776 Allow restricting items to users and roles - Wrong Item Owner\n #1775 Can not decrypt a created crypted Backup - Improved encryption with Defuse\n #1774 Announce this Item by email\n #1769 Installation issue - no admin account is created\n #1762 Share user rights works backwards\n #1761 Reset of my Personal Saltkey\n #1743 Enable anonymous LDAP queries\n #1690 Unable to set/save personal salt key with LDAP user\n\n 3-4/\n New: Multiselection in Roles vs Folders matrix\n New: LDAP configuration test mode (in progress)\n Fix: Prevent moving a folder to one of its child folder\n Fix: Global saltkey change\n Fix: Copy folder does'nt copy included items\n Fix: Encrypt/Decrypt attachments feature from admin page\n Fix: SQL injection corrected in users.queries.php (author: Pang@ADLab of Venustech)\n #1742 Fix for issue #1539 verifying LDAP groups properly\n #1740 Missing buttons on Users page\n #1737 Cannot import files\n #1735 Dockerfile - PHP extension \"curl\" is loaded Extension curl is not loaded\n #1733 Copy Item doesn't work if copy from public to public folders\n #1731 Cannot login in after fresh install\n #1729 Protection against bigger data than database field size\n #1727 Cannot edit or delete entry in the Personal folder\n\n 2/\n Secure fixes\n Session increase time feature is now increasing with the expected user session duration\n Default language cannot be changed fix\n Fix for \"hide not accessible folders\" option\n #1725 Some fixes\n #1723 Fix spin not removed while reseting user saltkey\n #1722 SELinux issue leads to upload impossible\n #1718 Moving a folder to itself\n #1717 After deleting a folder, items are still visible in search page\n #1713 Doubleclick on directory shows items twice\n #1710 Error on psk change\n #1709 Missing field in table on fresh install\n #1707 \"Restricted To\" not working correctly when creating new items\n #1706 User can edit & delete items without rights\n #1696 Fix for no log for OTV\n #1695 Manager can create folder at root from Items pas\n #1686 Fix for item History dialogbox\n #1685 Fix in Portuguese file\n #1684 Estonian language still missing\n #1679 Sort by don't work in Utilities/logs\n #1676 Pre-auth XSS in index.php\n #1674 name and lastname are changed on other user edit\n #1672 Anonymous settings not stored\n #1670 Incremental upgrade not active\n #1669 Logout - Errors\n #1668 File encryption is not correct in case of upgrade\n #1666 Can`t set avatar\n #1662 Can not delete folders\n #1659 Third level of sub folders in the Personal folder are not seen\n #1654 User management page - no \"next\" button\n\n 2/\n New   Defuse Encryption implemented in place of phpCrypt\n NEW   AGSES authentication implemented\n NEW   Custom Fields data can be encrytped or not in database\n NEW   Folder copy feature\n NEW   Mass move or delete operation on Items\n NEW   Item change proposal\n IMP   Implemented new session encryption library SecureHandler (getting rid of mcrypt extension)\n IMP   Language selection is now in User Profile (Default language is used on authentication page)\n IMP   User creation dialogbox improved with all user properties\n IMP   New user login availability is checked \"live\"\n IMP   Filtering counters in datatables\n IMP   Users Management dialogbox improved\n IMP   2FA authentication change to improve security (no call to external QR generator)\n UPD   AES library updated\n FIX   \"Find\" feature:\n       - copy from public to personal folder\n       - list of folders is refreshed when copying an Item\n #     Copy folders\n #1635 New folder inheritance of parent specific settings\n #1631 Error could be appear on upgrade when checking folders and files\n #1628 URL link to specific item does not work\n #1627 Improved label preview length\n #1625 Request to add/change password\n #1624 Error 500 while importing item with API (with PHP < 7)\n #1621 New option: OTV can be disabled\n #     New option: create Item without password\n #1620 Direct copy password from seach results and large folders\n #1616 Cannot show password with IE11\n #1614 Generate personal folders sets regular root folders also as personal\n #1608 All folders are deleted\n #1603 Attached files disappears\n #1601 Time zone can't be saved in My Profile\n #1593 Insert duplicate label with API\n #1592 Show Client IP in mail to admin about logged on users\n #1588 Fix for OTV links\n #1587 fix for e-mail to administrator on logon does not work\n #1581 Fix for new folder Custom Fields inheritance\n #1579 Fix for preventing a php fatal error\n #1575 Fix for tree not loaded when user has no access to a folder with children\n #1571 Drag and drop from PF to public folder makes item password corrupted\n #1571 Create an item inside another folder than the one selected\n #1561 Personal folder deletion deletes all\n #1559 API IP Whitelist check does not consider XFF\n #1556 Fix bug for upgrading old passwords\n #1553 LDAP support - Add LDAP port - Add support multi LDAP server\n #1551 Authentication through LDAP posix-search\n #1550 2 Factor enabled but can still log in without code\n #1549 Read Only users can use Personal Folders\n #1543 Wrong Saltkey message after setting\n #1533 The change of the main SALT Key doesn't work\n #1532 Added error message in install.js if db-pw contains double quotes\n #1531 Database otv table originator field should be int instead of tinyint\n #1514 User language selection is done in Profile dialogbox\n #1474 New option: create an item without password\n #1472 \"folder access\" and \"role\" settings when adding new user + propage rights from one user\n #1464 CSV files broken, html entities not decoded, newlines not stripped\n #1422 Folders deletion protocol has been securized to prevent unconsistencies in folders tree\n #1412 New option: Manager can move items they can view\n #1408 Display folders visible by a user\n #1299 Export to pdf or csv shows htmlencoded\n\n2.1.26\n #1537 Homepage not loading in French\n #1527 Error Field 'timestamp' doesn't have a default value\n #1526 New .htaccess file in ./includes/config\n #1525 Bad encoding in previous used passwords list\n #1515 Cannot add new users if similar user name exists\n #1512 Long folder names break UI\n #1511 Fix on LDAP due to library upgrade\n #1510 During upgrade, clean personal_folder field in DB\n #1504 Error while creating a new user with API\n #1494 csrfp.config.php not updated on URL change\n #1491 Added check against only numeric folder name\n #1489 JSON error on quick search if no folder access\n #1497 Nothing happens when clicking \"Remove orphan items from database\"\n #1375 Symbol < breaks password in One Time View page\n #1481 Query error\n #1476 Fix personal folder update script for\n #1463 PDF Export still broken\n #1454 API outputs deleted passwords\n #1453 API should have function \"userpw\"\n #1452 API should also output the url to each password\n #1457 New email address not used until logoff & logon\n #1450 Purge log feature - purges nothing\n #1449 Delete category hangs UI and crashes PHP\n #1448 admin delete removed password multiple select not working\n #1445 Password label doesn't preserve '\\' character\n #1439 Fix for large files upload\n #1438 Sanitize ampersand to URL encoding in csrfp.config\n #1426 Fixes for many critical issues with OTV\n #1421 Item will not be automatically deleted when accessed through otv option enabled\n #1415 Installation Issue and PDF export password field mask\n       Fixed problem for user to change self password\n       Fixed problem for deleting all directories\n #1414 Subfolders created into personal folders are presented in Folders and Roles management\n #1409 Updated PDF library to fit 7.x PHP\n #1407 Remove Save button in 2FA settings tab\n #1402 User can define his timezone\n #1395 Error with Chrome while upgrading\n #1394 Replace ascii characters in cpliboard copy\n #1392 Corrected sql error while restoring database\n #1389 Requested JSON parse failed when copying item\n #1386 JSON parse failed (history item view)\n #1384 SyntaxError: Invalid Character if Syslog enabled\n #1383 Export to PDF - Incorrect formatting\n #1381 LDAP user have unlimited access on first logon\n #1380 CSV or KeePass Import - Title as \"0\"\n #1378 JSON parse error when changing user password (with several roles)\n #1369 Cannot save some settings\n #1361 Duo prevents the ability to add/edit items\n #1353 Add ldap_start_tls if set\n #1346 On upgrade settings.php not found\n #1345 Admin, password change and logoff not working\n #1344 Wrap all non-GROUP BY columns in an aggregate function (MIN)\n #1342 Change my password screen loop\n #1340 Upgrade process last step\n #1335 This page doesn't exist\n #1328 Minimum password complexity for folders and items\n #1334 Fix \"installation related pages\" dead link\n #1333 Fix LDAP search base input\n #1332 API not allowing roles separation of pipe '|'\n #1326 Fixed LDAP functionality\n #1325 updated Dockerfile\n #1310 Addes Estonian language\n #1309 error while loading folders (if simplify tree option enabled)\n #1308 Teampass hangs when a folder is create with option \"New sub-folder inherits rights from parent folder\" enabled\n #1301 add ldap_search_base record for db init\n #1300 After 3 bad login attempts, user needs to wait 10s before new try\n #1299 Export to pdf or csv shows htmlencoded\n #1298 Backup-filename on 2.1.27 contains /\n #1292 SyntaxError: JSON.parse: unexpected character at line 1 column 1 of the JSON data\n #1284 fix for can_manage_all_users update during upgrade\n #1279 SyntaxError: Unexpected token \u00ee in JSON at position 0\n #1278 CSRFProtector protection while restoring a backup file\n #1276 MySQL 5.7 query error\n #1269 Typo error\n #1263 Error at line 75 in suggestion page\n #1251 Improving CSRFP configuration\n #1240 Security fixes on some missed queries and on non-protected text fields\n #1241 OTV visible more than one time\n #1238 Fix for upgrade.php where mysql_result() command were still not replaced\n #1235 Import from Keepass: missing items with the same title\n #1229 CSRFProtector message while DUO is enabled\n #1225 Unable to Access OTV Link\n #1224 Fixed errors in export_to_html_format\n #1211 No FA code sent from home page\n #1210 Fix for main.queries.php\n #1206 Fix for importing files\n #1203 Needed PHP extensions check during install & update process\n #1197 Awesome Font 4.5.0\n #1193 When I login with user admin \" loading ... \" and it does not finish\n #1192 Cannot save \"enable attachments encryption\"\n #1188 Implemented proposals for source code improvement\n #1186 open/highlight folder tree of displayed item\n #1183 Syntax Error on personal folders option\n #1181 403 Access Forbidden by CSRFProtector! at config save\n #1178 New user right added for managing all users (super Manager)\n #1174 Adding LDAP groups support to 'posix-search' LDAP auth\n #1172 Complete number of Items displayed in Tree\n #1158 Admin password cannot be changed\n #910  Backslashes in accounts are not copied to clipboard\n #268  Password recovery \"Forgot your password?\" don't do anything\n NEW: Server user password change through SSH connection\n NEW: Upgrade database handler improved for better upgrades management\n NEW: New user right added for managing all users (super Manager)\n FIX: If expiration engaged and password is changed, the warning is still present.\n FIX: New suggestion folder could remain empty in some specific cases.\n FIX: By creating a role, this new one is directly visible by creator.\n FIX: Security issue with downloadFile.php. Now protected by session and htaccess.\n FIX: QRCode is not visible in Users list\n FIX: Display inconsistancies in User log results\n Fix: Inconsistency in Delete & Restore process\n Fix: Errors in CSV import process\n Fix: Impossible to proceed with 'password lost' process\n Fix: OTV item not reachable\n Analyzed with RIPS (https://www.ripstech.com/) against security bugs\n\n2.1.25\n #1169 sending Google Authenticator code through index page\n #1160 hiding user password change option if DUOSecurity\n #1152 Error while saving settings\n #1149 log failed user authentication\n #1148 Answer from Server cannot be parsed!\n #1147 Mask/Display password not logged\n #1146 Roles on separate pages\n #1144 Login failure gives odd error\n #1143 import csv double quotes issue\n #1141 Syslog\n #1140 Security fix for Multiple vulnerabilities\n #1135 DataTables warning : table id=t_users - Invalid JSON Response\n #1128 Requested Json Parse Failed\n #1123 No Item to show in a folder after upgrading\n #1122 When deleting an item, confirmation modal doesn't show the name of the item to be deleted\n #1120 Not connect.n Verify Network\n #1114 Cannot Delete Favorites Due to \"undefined function prefix_table() \"\n #1108 Table teampass_keys missing!\n #1103 omplexity Matches new password but still claims otherwise\n #1102 Users cannot create folders\n #1096 One time link view problem\n #1095 Move Personal folder to Group Folder\n #1086 \"Error Encryption of the Password\" after update\n #1078 Send events to syslog\n Fix for changing SaltKey in admin page\n Fix for complete list of Roles in Admin Roles page\n Fix for Users and Items currently edited list that were not proposing \"next\" button\n Fix for label \u201cBy clicking the save button, you will delete \u2026.\u201d persistent\n Fix for list loaded twice if double click in Tree folder\n Fix for search result not displayed if previous folder was empty\n Fix for possible sql injection via LIMIT parameters\n Fix on profile dialogbox\n Implemented Deletion and Restoration events in item's History\n Implemented better handling of User role selection\n Implemented multi personal folders\n Implemented CSRFP library usage for security purpose\n Implemented new \"Yes/No\" button in settings page\n Implemented log view for failed authentication\n Implemented Tree sequentially load (via ajax)\n Add new item from API (for teampass-connect) (not yet tested)\n\n2.1.24\n #1090 - Fix for Export to PDF last folder not taken into consideration\n #1088 - #1085 - Password show problem\n #1087 - Managers can edit and delete Items they are allowed to see flag\n #1085 - Fix for copy to clipboard that sometime fails to work correctly\n #1073 - User can create folder on root without permission\n #1074 - Read only user can create folders + wipe out all items on remove folder\n #1069 - Knowledge Base can not change page\n #1068 - personal saltkey not saved\n #1067 - Suggestion feature not working\n #1064 - Record in db are not deleted when you delete in GUI\n #1058 - Fix API issue while adding an item\n #1063 - Fix for Forgot password not working\n #1062 - Warning for hex2bin function usage (PHP>5.4)\n #1061 - for for Can not import password from keepass xml\n #1055 - Personal item cannot be deleted\n #1048 - Encryption error flag is visible for no reason\n #1045 - Missing fields in table (pw_iv and data_iv)\n #1042 - Added pagination in Users page\n #1042 - Pagination on Users Page\n #1060 - Added new logging events (password copied, password shown)\n #1041 - \"Forgot your password?\" not working\n #1027 - User right more refined with \"No deletion\" possible right\n #953 - Make sure to rebuild the tree when creating an user with a personal folder\n #1035 - added php-xml install check\n #950 - #1005 - can not create Admin account\n #936 - #937 - Session file_exists not allowed while running through open_basedir restriction\n #970 - API special char fix\n #962 - Error message when using the Find-function\n #955 - Fix LDAP Settings UI\n Fix passwords are empty when importing from Keepass\n Fix empty URL column in off-line html\n A lot of small fixes\n New: implemented 2factor authentication DUOSecurity feature\n New: create User via API\n New: Vietnamese language added\n New: Tree structure is loaded dynamically\n New: Notification to Managers for awaiting suggestions\n\n 2.1.23\n #727 - #729 - Encoding problem\n #799 - Error: Field 'field_1' doesn't have a default value\n #830 - Fix documentation syntax\n #829 - Removing unecessary php closing tags\n #807 - Fix rights based on roles for new folders\n #808 - Add a SMTP security parameter to the email configuration\n #805 - Keepass Import improvements\n #790 - Install fixes\n #835 - Links in items description don't work\n #817 - Wrong number of users online\n #838 - Fix for mysqli encoding\n #839 - Keepass fixes\n #853 - New setting for default session expiration delay\n #851 - Multiple fixes for LDAP integration\n #814 - #857\n #880 - Fix for View logs error redeclared function getBits\n #881 - Fix for \"Forgot your password?\" not working\n #900 - Fix for New folder incorrect permissions (read-only)\n #890 - Fix for Personal Folder only read permission\n #910 - Fix for Backslashes in accounts are not copied to clipboard\n #913 - Fix for 'Announce this item by email' fails\n #915 - Export to PDF corrected\n #907 - Move folder feature\n #917 - Fix on API\n #941 - Fix for user_not_exists message (LDAP)\n #988 - Error on copy item\n #992 - Added to Log User Created By\n PR : #871 - #887\n API: add FIND feature\n Fix: copy not possible in RO folders\n Fix: If GA activated, Users can ask for a new code from the login page\n Fix: Off-line file url was not correct in download button\n Removal of Keys table\n Implementation of PhpCrypt library as encryption library (AES-128 with CBC mode)\n Implementation of Awesomefont in Items page\n Clean up of old comments\n Added \"long press\" to show password\n Fix of bug in Offline export\n List of Users is now loaded through Ajax to prevent timeout in case of long list of users\n Personal saltkey change is now performed through Ajax to prevent timeout in case of long list of passwords\n Fix for users with \"Allowed folders\" that can't write inside them.\n Removed extra files from Yubico folder\n Update process: suggestions passwords are reencrypted\n Suggestion migrated to new encryption\n\n2.1.22\n #700 - Errors related to \"includes/js/jstree/themes/default\"\n #718 - Two factor authentication: \"This user has no email set!\"\n #674 - API - User rights\n #697 - Default language setting, not being applied to automatically created ldap users.\n #698 - Default language setting, not being applied to newly created users.\n #707 - httpRequest is missing in upgrade process\n #725 - Disable button after item creation or edition\n #720 - cannot sign up to 2factor\n #690 - limit password export via PDF/CSV to user/group\n #745 - Enable again save_button after error on Add/Edit Item\n #739 - OTV correction\n #731 - Export password to file\n #653 - Passwords preprended during upgrade\n #767 - Backup restore feature fix\n #774 - Call to undefined method DB::queryInsert\n Other: #711 - #699 - #726 - #744 - #684 - #737\n New - Rights \"Read / Write / No Access\" added to folders for better rights management\n New - quick copy to clipboard for password and login\n New - New option : Prevent against duplicate items in same folder\n New - If folder is read-only for the User then it is striked-through\n Changed - list of restricted users refined by folder selected\n Fix - Not possible to see more than 8 Roles in Roles matrix\n\n2.1.21\n #597 - Rapid click on save button on \"Add a folder\"\n #599 - SQL:AUTO_INCREMENT id --> language\n #600 - preg_replace(): Unknown modifier '|'\n #598 - Extra fields in home page\n #602 - can't change user password by very heavy complexity\n #603 - password complexity check only in javascript\n #415 - Items are not show when in folder view. Can easy search and open.\n #578 - API generate new key\n #580 - Redirect to login page when accessing directly an item (if not logged)\n #576 - Mismatch email_body tags\n #607 - HMTL export erroneous download link\n #622 - Tooltip on left menu buttons\n #619 - CSV Import does not import passwords\n #617 - CSV Import doesn't handle passwords with quotes well\n #627 - Complete authentication bypass\n #626 - API vulnerable (improvement in progress)\n #633 - favicon correction\n #636 - MySQL on non-standard port\n #632 - Refactor order of index.php\n #629 - A password for admin account is required during installation\n #654 - Tab character breaks json format\n #652 - one-time view not working when interface is in French\n #658 - Rapid Click on Item Copy\n #657 - Rapid Click on Password Creation\n #656 - Can't Create Folder as User\n #643 - email charset in UTF-8\n #641 - Add and save item -> double click on that icon won't work\n #671 - When password is generated, it is added in confirm field too\n #672 - Changing password makes account inaccessible\n #637 - Multi Domain LDAP\n #673 - Changed strategy for quick icon clipboard copy\n #639 - Design fix in admin page\n #681 - Fix for Folder and Users creation as Administrator\n #680 - Set custom expiry for one time view link\n #682 - Fix SMTP authentication which were used regardless of the settings\n      - Fix a query used in the \"lost password\" management.\n      - Fix the mysql error message when the session_expired page is accesseded...\n - New option permitting to send or not an email to User when admin changes his password\n - Fix for image viewer when option files encryption is set\n - Fix for password complexity level update\n\n2.1.20\n #492 - Default admin password not working\n #509 - Password complexity\n #493 - Unable to purge logs\n #503 - manual insertions in Items History log not working\n #494 - Logs > Administration JSON error\n #491 - Applying email address to user\n #441 - Attachments encryption\n #459 - Turn off strict mode\n #477-#452 - Fix for upgrade\n #459 - Turn off strict mode\n #472 - Error on line 582 index.php\n #474 - Set default to checked for secure passwords\n #497 - Moved GA QR code creation to administration\n #487 - Off-line mode, link make the page scroll up\n #533 #521 #528 - Installation issue\n #525 - Settings.php should not be commited\n #527 - Potential security bug\n #485 - CVS Import on V 2.1.19 quotes problems\n #544 - DataTables warning: JSON data from server could not be parsed\n #547 - User search\n #520 - API access\n #549 #550 - Server Time in footer\n #539 - New feature: Simplify Items Tree\n #547 - Search in Users page\n #401 - Folder role inheretance on new folder\n #552 - added MBstring check\n #554 - Search-Page \"Jump to item\"-Button not working correctly\n Fork from slimm609 - Encrypted Sessions and CSRFGuard enabled\n Issues with folder creation in \"personal folder\"\n #536 - one time view page for anonymous user\n #517 - New feature: Suggest items system\n New feature: Sub-folder inherits of parent folder\n\n2.1.19\n #413 - fix for PHP Parse error: syntax error, unexpected '['\n #447 - fix for PHP Fatal error: Cannot redeclare getBits()\n #442 - problem edit folder\n #399 - Export encrypted passwords (off-line mode)\n #408 - Personal Salt Key changing doesn't work\n #419 - Password complexity not refreshed\n #418 - English translation improvement\n #407 - \"Restricted to\" feature improvement\n #402 - In item list, description is cut with <br />\n #393 - Password input and confirmation field location\n #388 - Unable to move items between folders\n #400 - Extra fields for Item\n #414 - Maintenance mode during upgrade can be disabled\n #389 - Language dropdown not working\n #392 - Check of absolute path for SK.PHP\n #385 - Email not sent ... check your configuration (to be checked)\n #379 - CSV importing not working (to be checked)\n #134 - Login After Session Expires\n #429 - Changed user.psk field to allow NULLs\n #428 : error: iconv(): Detected an illegal character in input string\n #426/#430 : New option to disable information loading in Admin page\n #142 - Google Authenticator implemented\n * Dialogbox not closed when changing folder name\n * Display Item details through Find page error\n\n2.1.18\n #315 - jstree style.css badly referenced\n #314 - Folder is not being deleted\n #320 - Enabling LDAP prevents local admin login\n #317 - server expected extensions are tested\n #318 - Upgrade process badly creates sk.php file\n #348 - Fix for undefined index \"isAdministratedByRole\"\n #350 - Fix for Lock and delete user actions don't refresh page\n #354 - Fix for removing folders\n #359 - Fix for initial user password change complexity check\n #371 - Fix for uploaded files corrupted\n #291 - Fix to support openLDAP / posix style LDAP\n #361 - Option to use login password as SALT key\n * Fix - no possibility to update a Role\n * Fix - editing users by clicking on the fields broken\n * Fix - parse error in database errors log\n * New - requested user password complexity shown when changing password\n * New - option for deactivate client-server encryption (usage of SSL)\n * New - in tree, new counters added (subfolders and items in subfolders numbers)\n * New language added - Catalan\n\n2.1.17\n * New exchange encryption protocol. No key is visible. The channel is\n encrypted at start of session.\n * HTTPS connection can be activated (be carefull, you need a certificate)\n * Change Users passwords encryption\n * Corrected - once clicked on not authorized Item, any Item selection was\n no more possible.\n #283 - Rights on a folder created at root are set.\n #285 - New settings: Anyone can modify option can be activated by default\n #287 - newly created personal folders ar propergated to the group\n #289 - Personal folder name badly constructed\n #270 - Restricted items visible in Find results\n #298 - Protection against bad actions on personal folders\n #299 - User can be explicetly administrated by Managers of specific Roles\n #300 - Personal SK is encrypted in COOKIE\n #301 - Corrected query call error\n #302 - Under \"Views\" users can see items that exist in personal folders\n that have been accessed\n #307 - fclose() statement badly placed\n\n2.1.16\n * #245 - #248 - #249 - #265 - #266 - #267 - #268 - #273\n * #277: Change personal saltkey error\n\n2.1.15\n * list of bugs corrected: #242 - #254 - #244 - #247 - #256 - #250 - #254 - #248\n   #243 - #252 - #232 - #240 - #260 - #259 - #262 - #251 - #236\n * MySQL hashing => todo\n * CSV importation\n\n2.1.14\n * list of bugs corrected: #238 - #235 - #239 - #203 - #201 - #233 - #226 - #236\n   #228 - #189 - #234 - #225 - #239 - #194 - #86\n * Corrected bug for sending emails\n * Different small corrections\n\n2.1.13\n * Code improvement for PSR compliance\n * jQueryUI updated to v1.9\n * Cleanup unused files\n * #207: Managers can only see the Roles they are allowed to.\n * #190, #192, #199, #202, #196, #204, #191, #214 corrected\n * Correction: taking into account user \"can create at root level\" setting\n * Added: saltkey is exported in a unique file that should be moved outside\n   \"www\" server scope.\n * Added: 2-factors authentication\n * Added: new check when Role creation\n * Added: new check for database query error\n * Added: Item in edition will lock any other edition\n * Added: New administrator View permitting to view \"Users actually connected\"\n   and \"Tokens taken for Items in edition\"\n * Added: User account contains now Name and Last Name fields\n\n2.1.12\n * #188\n * #185 Started adjusting codebase to follow PSR 1 and PSR 2 based on ecaron\n \t\twork (thank you)\n\n2.1.11\n * #184 - bug correction\n\n2.1.10\n * #161 - #100 - #175\n * #163 Personal saltkey duration based on cookie (under option)\n * share item -> manage error when email not sent\n * Improved/corrected export CSV and PDF\n * Correction: During upgrade, languages table is wrong\n * Personal Saltkey is stored in cookie (new admin setting)\n * Emails settings are moved to admin settings page (no more in settings.php)\n * Files folder is now a setting (to improve security)\n * Exported PDF is encrypted (contributor: Jay2k1)\n * #168 Add description field in PDF\n * #174 User creation and modification log\n\n2.1.9\n * #126-#132-#130-#131-#139-#129-#141-#146\n * Italian translation\n * Find page - focus in search box (contributor: Jay2k1)\n\n2.1.8\n * SF 206\n * #107-#95-#102-#103-#67-#32-#87-#71-#125-#120-#116-#111-#108-#104-#90-\n   #85-#78-#48-#34-#67-#75-#82-#84\n * bug correction cache table\n * view Item details from the Find page\n * CSV export  -> started\n * mail notification when selecting an item\n * share Item by mail\n * add email field in Item form\n * automatic deletion of Item after X opening or after limit date\n * Roles / Folders matrix: Roles passwords complexity shown\n\n2.1.7\n * SF 247 - 248 - 261 - 264 - 265 - 266 - 267\n * 67:\tprotect uploadify library => different file protection added\n * protect Downloadfile.php\n * SF228: reset personal saltkey (purge personal items)\n * SF262: copy of item is in log\n * old password in log was badly encoded\n * item copy from search page corrected\n * some rights checks added before action\n * email send to new created user\n\n2.1.6\n * #59: settings.php email setting errors\n * #67: Protected upload file\n * added email notification for user requiering an access to a restricted item.\n * 264:\tFeature Request: Password History\n\n2.1.5\n* #56: Temporary solution for keeping old ADMIN profile rights\n\n2.1.4\n* Corrections: SF237, SF240, SF243 , #29, #25,  #32 , #36 , #37 , #39 , #40\n\tSF257, SF259, SF239, #41, #40, #51\n* Improvements:\n\tSF232\n\tSF231:\tHow to Restrict Admin from Viewing items\n\t#31: new setting option for dynamic list\n\t#27: new subfolders only associated to the same roles as the parent folder\n\t#33: folder management in items page\n\tChanging SALT key from admin pages\n\n2.1.3\n* upgrade improvement in case of upgrading from 1.x version.\n\n2.1.2\n* improved upgrade connection errors and automatic credentials import\n* Corrections: #4, #7, 236\n\nv2.1.1\n* 2 bugs correction\n\nv2.1\n* Licence has changed to GNU AFFERO GPL 3.0\n* 203 - password complexity on Roles\n* 121 - Default language can be set + user language stored in DB\n* Encrypt old passwords in LOG_ITEMS table\n* started CRON activity for emails sending\n* new option: send email to Admins when users get connected\n* \"Restricted to\" field not viewable to everyone\n* add an icon for hide/show passwords in clear text (toggle button)\n", "body{\nwidth: 1000px;\nmargin-left: auto;\nmargin-right: auto;\n/*background: #F0F0F0 url(../images/stripe.png) repeat;*/\nbackground: #000000 url(../images/canevas/background_cell.jpg) repeat;\nfont-family: sans-serif;\nfont-size:11pt;\n}\n\n#top{\nwidth: 980px;\nheight: 35px;\nmargin-left: auto;\nmargin-right: auto;\npadding: 10px;\n/*background: #F0F0F0 url(../images/stripe_footer.png) repeat;*/\nfont-family: sans-serif;\nfont-size: 10px;\ndisplay:block;\nbackground-image: url(../images/canevas/menu_top_bckg.png);\n}\n\n#logo{\nfloat:left;\nmargin-right: 5px;\nmargin-top: -5px;\nmargin-left: -5px;\n}\n\n#menu_top{\nfloat:left;\n}\n\n#footer{\nwidth: 980px;\nheight: 20px;\nline-height: 16px;\nmargin: 10px auto 0 auto;\npadding: 10px;\nbackground-image: url(../images/canevas/menu_top_bckg.png);\nfont-family: sans-serif;\nfont-size: 10px;\ncolor: #F0F0F0;\n}\n\n#div_right_menu{\n  position:absolute;\n  margin:54px -32px 0 1000px;\n  background-image: url(../images/canevas/menu_top_bckg.png);\n  padding:5px;\n}\n\n#div_last_items{\n  background-color: #FFF0A4;\n  padding: 5px;\n  margin-top: 5px;\n  font-size: 12px;\n}\n\n#main{\npadding: 10px;\nmargin-top: 10px;\nmin-height: 250px;\nbackground:white url(../images/canevas/logo_home.png) 50% 50% no-repeat;\n}\n\n#main_simple{\nmargin-top: 10px;\n}\n\n#title {\n  font: bold 270%/100% \"Lucida Grande\";\n  color: #464646;\n  float:left;\n  margin-top:3px;\n}\n\ndiv#global {\nposition: relative;\n}\ndiv#header {\ncolor: #fff;\n}\ndiv#center {\npadding-bottom: 50px;\nbackground-color:white;\ndisplay: block;\n}\ndiv#content {\nfloat:left;\nwidth:660px;\nmargin-left:10px;\n\n}\n\n\nthead th{\nfont-size: 13px;\nfont-weight: bold;\nbackground: #344151;\npadding: 4px 10px 4px 10px;\nfont-family: arial;\ncolor: #FFFFFF;\n}\ntr.ligne0 td {\nbackground-color:#FFFFFF;\nborder-bottom:1px solid #CCCCCC;\nfont-family: arial;\nfont-size:11px;\n}\ntr.ligne1 td {\nbackground-color:#F0F0F0;\nborder-bottom:1px solid #CCCCCC;\nfont-family: arial;\nfont-size:11px;\n}\n\n#div_loading, .div_center {\n  position:absolute;\n  left: 50%;\n  top: 40%;\n}\n\na:link {text-decoration: none; color:#000000;}\na:visited {text-decoration: none; color:#000000;}\na:active {text-decoration: none; color:#000000;}\n/*a:hover {text-decoration: underline; color:#000000;}*/\na img {border:  none ;}\na img {border:  none ;}\n\n.input_text {\nmargin-bottom:10px;\nwidth:95%;\npadding: 4px;\n}\n\n.input_text_60 {\nmargin-bottom:10px;\nwidth:60%;\npadding: 4px;\n}\n\n.input_text_80 {\nmargin-bottom:10px;\nwidth:80%;\npadding: 4px;\n}\n\n.label_cpm{\ndisplay:block;\n}\n\n.form_label{\ndisplay:block;\nwidth:180px;\nfloat:left;\n}\n\n.form_label_100{\ndisplay:block;\nwidth:100px;\nfloat:left;\n}\n\n.td_title{\nfont-weight:bold;\nmin-width: 150px;\n}\n\nul{\nlist-style-type:none;\n}\n\n.button_menu { outline: 0; margin:0; padding: 1px; text-decoration:none; cursor:pointer; position: relative; text-align: center; }\n\n.title {\n  font: bold 160%/100% \"Lucida Grande\";\n  color: #464646;\n  margin: 3px 0px 10px 0px;\n  padding: 10px;\n}\n\n.readme{\n  font-family: sans-serif;\n  font-size: 9px;\n  line-height:15px;\n  margin-top: 20px;\n  height: 150px;\n  width:600px;\n  float:left;\n}\n\n.last_seen_item{\n  cursor:pointer;\n  font-family: sans-serif;\n  font-size: 11px;\n  margin-left: 8px;\n}\n\n.last_seen_item:hover{\n  color:red;\n}\n\n.pointer{\n  cursor:pointer;\n}\n\n.setting_flag{\n  margin-left:10px;\n}\n\n\n/*SIMPLEPASSMETER*/\n\n.simplePassMeter {\n  border: 1px solid #aaa;\n  background-color: #f3f3f3;\n  color: #666;\n  font-size: 0.8em;\n  padding: 1px 5px 0 5px;\n  margin: 0;\n  width: 19em;\n}\n\n.meterFail { border: 1px solid #daa; background-color: #fdd; }\n.meterWarn { border: 1px solid #fd6; background-color: #feb; }\n.meterGood { border: 1px solid #ada; background-color: #dfd; }\n.meterExcel { border: 1px solid #aad; background-color: #ddf; }\n\n.simplePassMeterBar { background-color: #ddd; }\n.meterFail .simplePassMeterProgress  { background-color: #f66; }\n.meterWarn .simplePassMeterProgress  { background-color: #fd6; }\n.meterGood .simplePassMeterProgress  { background-color: #ada; }\n.meterExcel .simplePassMeterProgress { background-color: #88f; }\n\n.simplePassMeter p { margin: 0; }\n.simplePassMeterIcon { height: 16px; width: 16px; float: left; }\n.meterFail .simplePassMeterIcon,\n.meterWarn .simplePassMeterIcon,\n.meterGood .simplePassMeterIcon,\n.meterExcel .simplePassMeterIcon {\n  background-image: url('../images/simplePassMeterSprite.png');\n  background-repeat: no-repeat;\n}\n.meterExcel .simplePassMeterIcon { background-position: 0 0; }\n.meterFail .simplePassMeterIcon { background-position: 0 -17px; }\n.meterGood .simplePassMeterIcon { background-position: 0 -34px; }\n.meterWarn .simplePassMeterIcon { background-position: 0 -51px; }\n\n.simplePassMeterText { margin-left: 2px; }\n\n#div_ga_url {\n  text-align:center;\n  margin:0 0 10px 0;\n  font-size:9pt;\n  display:none;\n  padding:5px;\n}\n\ninput.watermark {\n  color: #999;\n}\n\n/* Allow Font Awesome Icons in lieu of jQuery UI and only apply when using a FA icon */\n.ui-icon[class*=\" icon-\"] {\n  /* Remove the jQuery UI Icon */\n  background: none repeat scroll 0 0 transparent;\n  /* Remove the jQuery UI Text Indent */\n  text-indent: 0;\n  /* Bump it up - jQuery UI is -8px */\n  margin-top: -0.5em;\n}\n\n/* Allow use of icon-large to be properly aligned */\n.ui-icon.icon-large {\n  margin-top: -0.75em;\n}\n\n.ui-button-icon-only .ui-icon[class*=\" icon-\"] {\n  /* Bump it - jQuery UI is -8px */\n  margin-left: -7px;\n}\n\n.menu_150 {\n  width:150px;\n}\n\n.menu_200 {\n  width:200px;\n}\n\n.menu_250 {\n  width:250px;\n}\n\n.no-icon {\n  display:none !important;\n}\n\n.ui-menu li {\n  font-size:10pt !important;\n}\n\n\n.mi-green {\n  color: #388952;\n}\n.mi-yellow {\n  color: #FC9300;\n}\n.mi-red {\n  color: #CC0000;\n}\n.mi-black {\n  color: #222222;\n}\n.mi-grey-1 {\n  color: #9B9B9B;\n}\n\n.form_text {\n  padding:2px;\n  margin-bottom:5px;\n}\n\n.ui-button.redButton {\n  background-color: red;\n}\n.ui-button.greenButton {\n  background-color: green;\n}\n\ndiv.dataTables_processing { z-index: 1; }\n\n.ui-color {background:#F59829 !important;}\n\n.round-grey {\n  padding:2px 6px 2px 6px;\n  font-size:9pt;\n  border: 1px #f3f3f3;\n}\n\n#main_menu .btn-default {\n  width: 32px; height: 26px;\n  font-size: 10px;\n  padding: 2px 0 2px 0;\n  margin: 0px;\n  top: -5px;\n  background: rgba(240,240,240,1);\n  background: -webkit-gradient(left top, left bottom, color-stop(0%, rgba(240,240,240,1)), color-stop(60%, rgba(246,246,246,1)), color-stop(100%, rgba(199,199,199,1)));\n  background: -webkit-linear-gradient(top, rgba(240,240,240,1) 0%, rgba(246,246,246,1) 60%, rgba(199,199,199,1) 100%);\n  background: linear-gradient(to bottom, rgba(240,240,240,1) 0%, rgba(236,236,236,1) 60%, rgba(199,199,199,1) 100%);\n}\n\n#main_menu > div > ul > li > i {\n  font-size: 15px ! important;\n}\n\n#main_menu > div > ul  {\n  border-radius: 4px;\n  height: 26px;\n}\n\n.ui-button-text-only .ui-button-text {\n  padding: 4px;\n}\n.ui-menu-item > i {\n  font-size: 1.0em;\n  line-height: .70em;\n  vertical-align: -20%;\n  padding: 2px 0 0 0 ;\n}\n.title .ui-button-text > i {\n  width: 1.0em;\n}\n\n.quick_menu {\n  border-radius: 4px;\n}\n.ui-menu  .ui-menu-item  {\n  padding: 1px 3px 4px 3px ;\n}\n\n.fa-bars:before {\n  display:block;\n  content:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAANCAMAAABBwMRzAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRFAAAAAAAApWe5zwAAAAJ0Uk5T/wDltzBKAAAAGUlEQVR42mJgZEAGjAwE+agAkz+w5gEEGAAggABP5U/AbAAAAABJRU5ErkJggg==');\n  margin: 1px 1px 0px 1px;\n  width: 15px;\n  height: 15px;\n  }\n\n.hidden {\n  display: none;\n}", "<?php\n/**\n *\n * @file          index.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\n\nheader(\"X-XSS-Protection: 1; mode=block\");\nheader(\"X-Frame-Option: SameOrigin\");\n\n// **PREVENTING SESSION HIJACKING**\n// Prevents javascript XSS attacks aimed to steal the session ID\nini_set('session.cookie_httponly', 1);\n\n// **PREVENTING SESSION FIXATION**\n// Session ID cannot be passed through URLs\nini_set('session.use_only_cookies', 1);\n\n// Uses a secure connection (HTTPS) if possible\nini_set('session.cookie_secure', 0);\n\n// Before we start processing, we should abort no install is present\nif (!file_exists('includes/config/settings.php')) {\n    // This should never happen, but in case it does\n    // this means if headers are sent, redirect will fallback to JS\n    if (headers_sent()) {\n        echo '<script language=\"javascript\" type=\"text/javascript\">document.location.replace(\"install/install.php\");</script>';\n    } else {\n        header('Location: install/install.php');\n    }\n    // Now either way, we should stop processing further\n    exit();\n}\n\n// initialise CSRFGuard library\nrequire_once('./includes/libraries/csrfp/libs/csrf/csrfprotector.php');\ncsrfProtector::init();\n//session_destroy();\nsession_id();\n\n// Load config\nif (file_exists('../includes/config/tp.config.php')) {\n    require_once '../includes/config/tp.config.php';\n} elseif (file_exists('./includes/config/tp.config.php')) {\n    require_once './includes/config/tp.config.php';\n} else {\n    throw new Exception(\"Error file '/includes/config/tp.config.php' not exists\", 1);\n}\n\n// Include files\nrequire_once $SETTINGS['cpassman_dir'].'/includes/config/settings.php';\nrequire_once $SETTINGS['cpassman_dir'].'/includes/config/include.php';\nrequire_once $SETTINGS['cpassman_dir'].'/includes/libraries/protect/SuperGlobal/SuperGlobal.php';\n$superGlobal = new protect\\SuperGlobal\\SuperGlobal();\n\n\n// initialize session\n$_SESSION['CPM'] = 1;\nif (isset($SETTINGS['cpassman_dir']) === false || $SETTINGS['cpassman_dir'] === \"\") {\n    $SETTINGS['cpassman_dir'] = \".\";\n    $SETTINGS['cpassman_url'] = $superGlobal->get(\"REQUEST_URI\", \"SERVER\");\n}\n\n// Include files\nrequire_once $SETTINGS['cpassman_dir'].'/sources/SplClassLoader.php';\nrequire_once $SETTINGS['cpassman_dir'].'/sources/main.functions.php';\n\n\n// Open MYSQL database connection\nrequire_once './includes/libraries/Database/Meekrodb/db.class.php';\n$pass = defuse_return_decrypted($pass);\nDB::$host = $server;\nDB::$user = $user;\nDB::$password = $pass;\nDB::$dbName = $database;\nDB::$port = $port;\nDB::$encoding = $encoding;\nDB::$error_handler = true;\n$link = mysqli_connect($server, $user, $pass, $database, $port);\n$link->set_charset($encoding);\n\n\n// Load Core library\nrequire_once $SETTINGS['cpassman_dir'].'/sources/core.php';\n\n\n// Prepare POST variables\n$post_language =        filter_input(INPUT_POST, 'language', FILTER_SANITIZE_STRING);\n$post_sig_response =    filter_input(INPUT_POST, 'sig_response', FILTER_SANITIZE_STRING);\n$post_duo_login =       filter_input(INPUT_POST, 'duo_login', FILTER_SANITIZE_STRING);\n$post_duo_data =        filter_input(INPUT_POST, 'duo_data', FILTER_SANITIZE_STRING);\n\n// Prepare superGlobal variables\n$session_user_language =        $superGlobal->get(\"user_language\", \"SESSION\");\n$session_user_id =              $superGlobal->get(\"user_id\", \"SESSION\");\n$session_user_flag =            $superGlobal->get(\"user_language_flag\", \"SESSION\");\n$session_user_admin =           $superGlobal->get(\"user_admin\", \"SESSION\");\n$session_user_avatar_thumb =    $superGlobal->get(\"user_avatar_thumb\", \"SESSION\");\n$session_name =                 $superGlobal->get(\"name\", \"SESSION\");\n$session_lastname =             $superGlobal->get(\"lastname\", \"SESSION\");\n$session_user_manager =         $superGlobal->get(\"user_manager\", \"SESSION\");\n$session_user_read_only =       $superGlobal->get(\"user_read_only\", \"SESSION\");\n$session_is_admin =             $superGlobal->get(\"is_admin\", \"SESSION\");\n$session_login =                $superGlobal->get(\"login\", \"SESSION\");\n$session_validite_pw =          $superGlobal->get(\"validite_pw\", \"SESSION\");\n$session_nb_folders =           $superGlobal->get(\"nb_folders\", \"SESSION\");\n$session_nb_roles =             $superGlobal->get(\"nb_roles\", \"SESSION\");\n$session_autoriser =            $superGlobal->get(\"autoriser\", \"SESSION\");\n$session_hide_maintenance =     $superGlobal->get(\"hide_maintenance\", \"SESSION\");\n$session_initial_url =          $superGlobal->get(\"initial_url\", \"SESSION\");\n$server_request_uri =           $superGlobal->get(\"REQUEST_URI\", \"SERVER\");\n\n\n/* DEFINE WHAT LANGUAGE TO USE */\nif (isset($_GET['language']) === true) {\n    // case of user has change language in the login page\n    $dataLanguage = DB::queryFirstRow(\n        \"SELECT flag, name\n        FROM \".prefix_table(\"languages\").\"\n        WHERE name = %s\",\n        filter_var($_GET['language'], FILTER_SANITIZE_STRING)\n    );\n    $superGlobal->put(\"user_language\", $dataLanguage['name'], \"SESSION\");\n    $superGlobal->put(\"user_language_flag\", $dataLanguage['flag'], \"SESSION\");\n} elseif ($session_user_id === null && null === $post_language && $session_user_language === null) {\n    //get default language\n    $dataLanguage = DB::queryFirstRow(\n        \"SELECT m.valeur AS valeur, l.flag AS flag\n        FROM \".prefix_table(\"misc\").\" AS m\n        INNER JOIN \".prefix_table(\"languages\").\" AS l ON (m.valeur = l.name)\n        WHERE m.type=%s_type AND m.intitule=%s_intitule\",\n        array(\n            'type' => \"admin\",\n            'intitule' => \"default_language\"\n        )\n    );\n    if (empty($dataLanguage['valeur'])) {\n        $superGlobal->put(\"user_language\", \"english\", \"SESSION\");\n        $superGlobal->put(\"user_language_flag\", \"us.png\", \"SESSION\");\n        $session_user_language = \"english\";\n    } else {\n        $superGlobal->put(\"user_language\", $dataLanguage['valeur'], \"SESSION\");\n        $superGlobal->put(\"user_language_flag\", $dataLanguage['flag'], \"SESSION\");\n        $session_user_language = $dataLanguage['valeur'];\n    }\n} elseif (isset($SETTINGS['default_language']) === true && $session_user_language === null) {\n    $superGlobal->put(\"user_language\", $SETTINGS['default_language'], \"SESSION\");\n    $session_user_language = $SETTINGS['default_language'];\n} elseif (null !== $post_language) {\n    $superGlobal->put(\"user_language\", $post_language, \"SESSION\");\n    $session_user_language = $post_language;\n} elseif ($session_user_language === null || empty($session_user_language) === true) {\n    if (null !== $post_language) {\n        $superGlobal->put(\"user_language\", $post_language, \"SESSION\");\n        $session_user_language = $post_language;\n    } elseif ($session_user_language !== null) {\n        $superGlobal->put(\"user_language\", $SETTINGS['default_language'], \"SESSION\");\n        $session_user_language = $SETTINGS['default_language'];\n    }\n} elseif ($session_user_language === '0') {\n    $superGlobal->put(\"user_language\", $SETTINGS['default_language'], \"SESSION\");\n    $session_user_language = $SETTINGS['default_language'];\n}\n\nif (isset($SETTINGS['cpassman_dir']) === false || $SETTINGS['cpassman_dir'] === \"\") {\n    $SETTINGS['cpassman_dir'] = \".\";\n    $SETTINGS['cpassman_url'] = (string) $server_request_uri;\n}\n\n// Load user languages files\nif (in_array($session_user_language, $languagesList) === true) {\n    if (file_exists($SETTINGS['cpassman_dir'].'/includes/language/'.$session_user_language.'.php') === true) {\n        require_once $SETTINGS['cpassman_dir'].'/includes/language/'.$session_user_language.'.php';\n    }\n} else {\n    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n    include $SETTINGS['cpassman_dir'].'/error.php';\n}\n\n// load 2FA Google\nif (isset($SETTINGS['google_authentication']) === true && $SETTINGS['google_authentication'] === \"1\") {\n    include_once($SETTINGS['cpassman_dir'].\"/includes/libraries/Authentication/TwoFactorAuth/TwoFactorAuth.php\");\n}\n\n// Load links, css and javascripts\nif (isset($_SESSION['CPM']) === true && isset($SETTINGS['cpassman_dir']) === true) {\n    require_once $SETTINGS['cpassman_dir'].'/load.php';\n}\n\n?>\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html;charset=utf-8\" />\n<title>Teampass</title>\n<script type=\"text/javascript\">\n    //<![CDATA[\n    if (window.location.href.indexOf(\"page=\") == -1 && (window.location.href.indexOf(\"otv=\") == -1 && window.location.href.indexOf(\"action=\") == -1)) {\n        if (window.location.href.indexOf(\"session_over=true\") == -1) {\n            //location.replace(\"./index.php?page=items\");\n        } else {\n            location.replace(\"./logout.php\");\n        }\n    }\n    //]]>\n</script>\n<?php\n\n// load HEADERS\nif (isset($_SESSION['CPM'])) {\n    echo $htmlHeaders;\n}\n?>\n    </head>\n\n<body>\n    <?php\n\n/* HEADER */\n    echo '\n    <div id=\"top\">\n        <div id=\"logo\"><img src=\"includes/images/canevas/logo.png\" alt=\"\" /></div>';\n    // Display menu\n    if (empty($session_login) === false) {\n        // welcome message\n        echo '\n        <div style=\"float:right; margin:-10px 5px 0 0; color:#FFF;\">'\n            .$LANG['index_welcome'].'&nbsp;<b>'.$session_name.'&nbsp;'.$session_lastname\n            .'&nbsp;['.$session_login.']</b>&nbsp;-&nbsp;'\n            , $session_user_admin === '1' ? $LANG['god'] :\n                ($session_user_manager === '1' ? $LANG['gestionnaire'] :\n                    ($session_user_read_only === '1' ? $LANG['read_only_account'] : $LANG['user'])\n                ), '&nbsp;'.strtolower($LANG['index_login']).'</div>';\n\n        echo '\n        <div id=\"menu_top\">\n            <div style=\"margin-left:20px; margin-top:2px;width:710px;\" id=\"main_menu\">';\n        if ($session_user_admin === '0' || $SETTINGS_EXT['admin_full_right'] == 0) {\n            echo '\n                <a class=\"btn btn-default\" href=\"#\"',\n                ($session_nb_folders !== null && intval($session_nb_folders) === 0)\n                || ($session_nb_roles !== null && intval($session_nb_roles) === 0) ? '' : ' onclick=\"MenuAction(\\'items\\')\"',\n                '>\n                    <i class=\"fa fa-key fa-2x tip\" title=\"'.$LANG['pw'].'\"></i>\n                </a>\n\n                <a class=\"btn btn-default\" href=\"#\"',\n                ($session_nb_folders !== null && intval($session_nb_folders) === 0)\n                || ($session_nb_roles !== null && intval($session_nb_roles) === 0) ? '' : ' onclick=\"MenuAction(\\'find\\')\"',\n                '>\n                    <i class=\"fa fa-binoculars fa-2x tip\" title=\"'.$LANG['find'].'\"></i>\n                </a>';\n        }\n\n        // Favourites menu\n        if (isset($SETTINGS['enable_favourites'])\n            && $SETTINGS['enable_favourites'] == 1\n            &&\n            ($session_user_admin === '0' || ($session_user_admin === '1' && $SETTINGS_EXT['admin_full_right'] === false))\n        ) {\n            echo '\n                    <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'favourites\\')\">\n                        <i class=\"fa fa-star fa-2x tip\" title=\"'.$LANG['my_favourites'].'\"></i>\n                    </a>';\n        }\n        // KB menu\n        if (isset($SETTINGS['enable_kb']) && $SETTINGS['enable_kb'] == 1) {\n            echo '\n                    <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'kb\\')\">\n                        <i class=\"fa fa-map-signs fa-2x tip\" title=\"'.$LANG['kb_menu'].'\"></i>\n                    </a>';\n        }\n        echo '\n        <span id=\"menu_suggestion_position\">';\n        // SUGGESTION menu\n        if (isset($SETTINGS['enable_suggestion']) && $SETTINGS['enable_suggestion'] === '1'\n            && ($session_user_read_only === '1' || $session_user_admin === '1' || $session_user_manager === '1')\n        ) {\n            echo '\n                <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'suggestion\\')\">\n                    <i class=\"fa fa-lightbulb-o fa-2x tip\" id=\"menu_icon_suggestions\" title=\"'.$LANG['suggestion_menu'].'\"></i>\n                </a>';\n        }\n        echo '\n        </span>';\n        // Admin menu\n        if ($session_user_admin === '1') {\n            echo '\n                    &nbsp;\n                    <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'manage_main\\')\">\n                        <i class=\"fa fa-info fa-2x tip\" title=\"'.$LANG['admin_main'].'\"></i>\n                    </a>\n                    <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'manage_settings\\')\">\n                        <i class=\"fa fa-wrench fa-2x tip\" title=\"'.$LANG['admin_settings'].'\"></i>\n                    </a>';\n        }\n\n        if ($session_user_admin === '1' || $session_user_manager === '1') {\n            echo '\n                &nbsp;\n                <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'manage_folders\\')\">\n                    <i class=\"fa fa-folder-open fa-2x tip\" title=\"'.$LANG['admin_groups'].'\"></i>\n                </a>\n                <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'manage_roles\\')\">\n                    <i class=\"fa fa-graduation-cap fa-2x tip\" title=\"'.$LANG['admin_functions'].'\"></i>\n                </a>\n                <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'manage_users\\')\">\n                    <i class=\"fa fa-users fa-2x tip\" title=\"'.$LANG['admin_users'].'\"></i>\n                </a>\n                <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'manage_views\\')\">\n                    <i class=\"fa fa-cubes fa-2x tip\" title=\"'.$LANG['admin_views'].'\"></i>\n                </a>';\n        }\n\n        echo '\n                <div style=\"float:right;\">\n                    <ul class=\"menu\" style=\"\">\n                        <li class=\"\" style=\"padding:4px;width:40px; text-align:center;\"><i class=\"fa fa-dashboard fa-fw\"></i>&nbsp;\n                            <ul class=\"menu_200\" style=\"text-align:left;\">',\n                                ($session_user_admin === '1' && $SETTINGS_EXT['admin_full_right'] === true) ? '' : isset($SETTINGS['enable_pf_feature']) === true && $SETTINGS['enable_pf_feature'] == 1 ? '\n                                <li onclick=\"$(\\'#div_set_personal_saltkey\\').dialog(\\'open\\')\">\n                                    <i class=\"fa fa-key fa-fw\"></i> &nbsp;'.$LANG['home_personal_saltkey_button'].'\n                                </li>' : '', '\n                                <li onclick=\"$(\\'#div_increase_session_time\\').dialog(\\'open\\')\">\n                                    <i class=\"fa fa-clock-o fa-fw\"></i> &nbsp;'.$LANG['index_add_one_hour'].'\n                                </li>\n                                <li onclick=\"loadProfileDialog()\">\n                                    <i class=\"fa fa-user fa-fw\"></i> &nbsp;'.$LANG['my_profile'].'\n                                </li>\n                                <li onclick=\"MenuAction(\\'deconnexion\\', \\''.$session_user_id.'\\')\">\n                                    <i class=\"fa fa-sign-out fa-fw\"></i> &nbsp;'.$LANG['disconnect'].'\n                                </li>\n                            </ul>\n                        </li>\n                    </ul>\n                </div>';\n\n        if ($session_user_admin !== '1' || ($session_user_admin === '1' && $SETTINGS_EXT['admin_full_right'] === false)) {\n            echo '\n                <div style=\"float:right; margin-right:10px;\">\n                    <ul class=\"menu\" id=\"menu_last_seen_items\">\n                        <li class=\"\" style=\"padding:4px;width:40px; text-align:center;\"><i class=\"fa fa-map fa-fw\"></i>&nbsp;&nbsp;\n                            <ul class=\"menu_200\" id=\"last_seen_items_list\" style=\"text-align:left;\">\n                                <li>'.$LANG['please_wait'].'</li>\n                            </ul>\n                        </li>\n                    </ul>\n                </div>';\n        }\n\n        // show avatar\n        if ($session_user_avatar_thumb !== null && empty($session_user_avatar_thumb) === false) {\n            if (file_exists('includes/avatars/'.$session_user_avatar_thumb)) {\n                $avatar = $SETTINGS['cpassman_url'].'/includes/avatars/'.$session_user_avatar_thumb;\n            } else {\n                $avatar = $SETTINGS['cpassman_url'].'/includes/images/photo.jpg';\n            }\n        } else {\n            $avatar = $SETTINGS['cpassman_url'].'/includes/images/photo.jpg';\n        }\n        echo '\n                <div style=\"float:right; margin-right:10px;\">\n                    <img src=\"'.$avatar.'\" style=\"border-radius:10px; height:28px; cursor:pointer;\" onclick=\"loadProfileDialog()\" alt=\"photo\" id=\"user_avatar_thumb\" />\n                </div>';\n\n        echo '\n            </div>';\n\n        echo '\n        </div>';\n    }\n\n    echo '\n    </div>';\n\n    echo '\n<div id=\"main_info_box\" style=\"display:none; z-index:99999; position:absolute; width:400px; height:40px;\" class=\"ui-widget ui-state-active ui-color\">\n    <div id=\"main_info_box_text\" style=\"text-align:center;margin-top:10px;\"></div>\n</div>';\n\n/* MAIN PAGE */\n    echo '\n        <input type=\"hidden\" id=\"temps_restant\" value=\"', isset($_SESSION['fin_session']) ? $_SESSION['fin_session'] : '', '\" />\n        <input type=\"hidden\" name=\"language\" id=\"language\" value=\"\" />\n        <input type=\"hidden\" name=\"user_pw_complexity\" id=\"user_pw_complexity\" value=\"', isset($_SESSION['user_pw_complexity']) ? $_SESSION['user_pw_complexity'] : '', '\" />\n        <input type=\"hidden\" name=\"user_session\" id=\"user_session\" value=\"\"/>\n        <input type=\"hidden\" name=\"encryptClientServer\" id=\"encryptClientServer\" value=\"', isset($SETTINGS['encryptClientServer']) ? $SETTINGS['encryptClientServer'] : '1', '\" />\n        <input type=\"hidden\" name=\"please_login\" id=\"please_login\" value=\"\" />\n        <input type=\"hidden\" name=\"disabled_action_on_going\" id=\"disabled_action_on_going\" value=\"\" />\n        <input type=\"hidden\" id=\"duo_sig_response\" value=\"', null !== $post_sig_response ? intval($post_sig_response) : '', '\" />';\n\n// SENDING STATISTICS?\n    if (isset($SETTINGS['send_stats']) && $SETTINGS['send_stats'] === \"1\"\n        && (!isset($_SESSION['temporary']['send_stats_done']) || $_SESSION['temporary']['send_stats_done'] !== \"1\")\n    ) {\n        echo '\n            <input type=\"hidden\" name=\"send_statistics\" id=\"send_statistics\" value=\"1\" />';\n    } else {\n        echo '\n        <input type=\"hidden\" name=\"send_statistics\" id=\"send_statistics\" value=\"0\" />';\n    }\n\n    echo '\n    <div id=\"', (isset($_GET['page']) && filter_var($_GET['page'], FILTER_SANITIZE_STRING) === \"items\" && $session_user_id !== null) ? \"main_simple\" : \"main\", '\">';\n// MESSAGE BOX\n    echo '\n            <div style=\"\" class=\"div_center\">\n                <div id=\"message_box\" style=\"display:none;width:200px;padding:5px;text-align:center; z-index:999999;\" class=\"ui-widget-content ui-state-error ui-corner-all\"></div>\n            </div>';\n    // Main page\n    if ($session_autoriser !== null && $session_autoriser === true) {\n        // Show menu\n        echo '\n            <form method=\"post\" name=\"main_form\" action=\"\">\n                <input type=\"hidden\" name=\"menu_action\" id=\"menu_action\" value=\"\" />\n                <input type=\"hidden\" name=\"changer_pw\" id=\"changer_pw\" value=\"\" />\n                <input type=\"hidden\" name=\"form_user_id\" id=\"form_user_id\" value=\"', $session_user_id !== null ? $session_user_id : '', '\" />\n                <input type=\"hidden\" name=\"is_admin\" id=\"is_admin\" value=\"', $session_is_admin !== null ? $session_is_admin : '', '\" />\n                <input type=\"hidden\" name=\"personal_saltkey_set\" id=\"personal_saltkey_set\" value=\"', isset($_SESSION['user_settings']['clear_psk']) ? true : false, '\" />\n            </form>';\n    }\n// ---------\n// Display a help to admin\n    $errorAdmin = \"\";\n\n// error nb folders\n    if ($session_nb_folders !== null && intval($session_nb_folders) === 0) {\n        $errorAdmin = '<span class=\"ui-icon ui-icon-lightbulb\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>'.$LANG['error_no_folders'].'<br />';\n    }\n// error nb roles\n    if ($session_nb_roles !== null && intval($session_nb_roles) === 0) {\n        if (empty($errorAdmin)) {\n            $errorAdmin = '<span class=\"ui-icon ui-icon-lightbulb\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>'.$LANG['error_no_roles'];\n        } else {\n            $errorAdmin .= '<br /><span class=\"ui-icon ui-icon-lightbulb\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>'.$LANG['error_no_roles'];\n        }\n    }\n\n    if ($session_validite_pw !== null && empty($session_validite_pw) === false) {\n        // error cpassman dir\n        if (isset($SETTINGS['cpassman_dir']) && empty($SETTINGS['cpassman_dir']) || !isset($SETTINGS['cpassman_dir'])) {\n            if (empty($errorAdmin)) {\n                $errorAdmin = '<span class=\"ui-icon ui-icon-lightbulb\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>'.$LANG['error_cpassman_dir'];\n            } else {\n                $errorAdmin .= '<br /><span class=\"ui-icon ui-icon-lightbulb\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>'.$LANG['error_cpassman_dir'];\n            }\n        }\n        // error cpassman url\n        if ($session_validite_pw !== null && (isset($SETTINGS['cpassman_url']) && empty($SETTINGS['cpassman_url']) || !isset($SETTINGS['cpassman_url']))) {\n            if (empty($errorAdmin)) {\n                $errorAdmin = '<span class=\"ui-icon ui-icon-lightbulb\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>'.$LANG['error_cpassman_url'];\n            } else {\n                $errorAdmin .= '<br /><span class=\"ui-icon ui-icon-lightbulb\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>'.$LANG['error_cpassman_url'];\n            }\n        }\n    }\n// Display help\n    if (!empty($errorAdmin)) {\n        echo '\n                <div style=\"margin:10px;padding:10px;\" class=\"ui-state-error ui-corner-all\">\n                '.$errorAdmin.'\n                </div>';\n    }\n// -----------\n// Display Maintenance mode information\n    if (isset($SETTINGS['maintenance_mode']) === true && $SETTINGS['maintenance_mode'] === '1'\n            && $session_user_admin !== null && $session_user_admin === '1'\n        ) {\n        echo '\n            <div style=\"text-align:center;margin-bottom:5px;padding:10px;\" class=\"ui-state-highlight ui-corner-all\">\n                <b>'.$LANG['index_maintenance_mode_admin'].'</b>\n            </div>';\n    }\n// Display UPDATE NEEDED information\n    if (isset($SETTINGS['update_needed']) && $SETTINGS['update_needed'] === true\n            && $session_user_admin !== null && $session_user_admin === '1'\n            && (($session_hide_maintenance !== null && $session_hide_maintenance === '0')\n            || $session_hide_maintenance === null)\n        ) {\n        echo '\n            <div style=\"text-align:center;margin-bottom:5px;padding:10px;\"\n                class=\"ui-state-highlight ui-corner-all\" id=\"div_maintenance\">\n                <b>'.$LANG['update_needed_mode_admin'].'</b>\n                <span style=\"float:right;cursor:pointer;\">\n                    <span class=\"fa fa-close mi-red\" onclick=\"toggleDiv(\\'div_maintenance\\')\"></span>\n                </span>\n            </div>';\n    }\n\n// display an item in the context of OTV link\n    if (($session_validite_pw === null || empty($session_validite_pw) === true || empty($session_user_id) === true) &&\n        isset($_GET['otv']) && filter_var($_GET['otv'], FILTER_SANITIZE_STRING) === 'true'\n    ) {\n        // case where one-shot viewer\n        if (isset($_GET['code']) && !empty($_GET['code'])\n            && isset($_GET['stamp']) && !empty($_GET['stamp'])\n        ) {\n            include 'otv.php';\n        } else {\n            $_SESSION['error']['code'] = ERR_VALID_SESSION;\n            $superGlobal->put(\n                \"initial_url\",\n                filter_var(\n                    substr($server_request_uri, strpos($server_request_uri, \"index.php?\")),\n                    FILTER_SANITIZE_URL\n                ),\n                \"SESSION\"\n            );\n            include $SETTINGS['cpassman_dir'].'/error.php';\n        }\n    // Ask the user to change his password\n    } elseif (($session_validite_pw === null || $session_validite_pw === false)\n        && empty($session_user_id) === false\n    ) {\n        //Check if password is valid\n        echo '\n        <div style=\"margin:auto; padding:20px; width:500px;\" class=\"ui-state-focus ui-corner-all\">\n            <h3>'.$LANG['index_change_pw'].'</h3>\n            <div style=\"height:20px;text-align:center;margin:2px;display:none;\" id=\"change_pwd_error\" class=\"\"></div>\n            <div style=\"text-align:center;margin:5px;padding:3px;\" id=\"change_pwd_complexPw\" class=\"ui-widget ui-state-active ui-corner-all\">'.\n            $LANG['complex_asked'].' : '.$SETTINGS_EXT['pwComplexity'][$_SESSION['user_pw_complexity']][1].\n            '</div>\n            <div id=\"pw_strength\" style=\"margin:0 0 10px 140px;\"></div>\n            <table>\n                <tr>\n                    <td>'.$LANG['index_new_pw'].' :</td><td><input type=\"password\" size=\"15\" name=\"new_pw\" id=\"new_pw\"/></td>\n                </tr>\n                <tr><td>'.$LANG['index_change_pw_confirmation'].' :</td><td><input type=\"password\" size=\"15\" name=\"new_pw2\" id=\"new_pw2\" onkeypress=\"if (event.keyCode == 13) ChangeMyPass();\" /></td></tr>\n            </table>\n            <input type=\"hidden\" id=\"pw_strength_value\" />\n            <div style=\"width:420px; text-align:center; margin:15px 0 10px 0;\">\n                <input type=\"button\" onClick=\"ChangeMyPass()\" onkeypress=\"if (event.keyCode == 13) ChangeMyPass();\" class=\"ui-state-default ui-corner-all\" style=\"padding:4px;width:150px;margin:10px 0 0 80px;\" value=\"'.$LANG['index_change_pw_button'].'\" />\n            </div>\n        </div>\n        <script type=\"text/javascript\">\n            $(\"#new_pw\").focus();\n        </script>';\n    // Display pages\n    } elseif ($session_validite_pw !== null\n        && $session_validite_pw === true\n        && empty($_GET['page']) === false\n        && empty($session_user_id) === false\n    ) {\n        if (!extension_loaded('mcrypt')) {\n            $_SESSION['error']['code'] = ERR_NO_MCRYPT;\n            include $SETTINGS['cpassman_dir'].'/error.php';\n        } elseif ($session_initial_url !== null && empty($session_initial_url) === false) {\n            include $session_initial_url;\n        } elseif ($_GET['page'] == \"items\") {\n            // SHow page with Items\n            if (($session_user_admin !== '1')\n                ||\n                ($session_user_admin === '1' && $SETTINGS_EXT['admin_full_right'] === false)\n            ) {\n                include 'items.php';\n            } else {\n                $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n                include $SETTINGS['cpassman_dir'].'/error.php';\n            }\n        } elseif ($_GET['page'] == \"find\") {\n            // Show page for items findind\n            include 'find.php';\n        } elseif ($_GET['page'] == \"favourites\") {\n            // Show page for user favourites\n            include 'favorites.php';\n        } elseif ($_GET['page'] == \"kb\") {\n            // Show page KB\n            if (isset($SETTINGS['enable_kb']) && $SETTINGS['enable_kb'] == 1) {\n                include 'kb.php';\n            } else {\n                $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n                include $SETTINGS['cpassman_dir'].'/error.php';\n            }\n        } elseif ($_GET['page'] == \"suggestion\") {\n            // Show page KB\n            if (isset($SETTINGS['enable_suggestion']) && $SETTINGS['enable_suggestion'] == 1) {\n                include 'suggestion.php';\n            } else {\n                $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n                include $SETTINGS['cpassman_dir'].'/error.php';\n            }\n        } elseif (in_array($_GET['page'], array_keys($mngPages))) {\n            // Define if user is allowed to see management pages\n            if ($session_user_admin === '1') {\n                include($mngPages[$_GET['page']]);\n            } elseif ($session_user_manager === '1') {\n                if (($_GET['page'] != \"manage_main\" && $_GET['page'] != \"manage_settings\")) {\n                    include($mngPages[$_GET['page']]);\n                } else {\n                    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n                    include $SETTINGS['cpassman_dir'].'/error.php';\n                }\n            } else {\n                $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n                include $SETTINGS['cpassman_dir'].'/error.php';\n            }\n        } else {\n            $_SESSION['error']['code'] = ERR_NOT_EXIST; //page doesn't exist\n            include $SETTINGS['cpassman_dir'].'/error.php';\n        }\n    // Case of password recovery\n    } elseif (isset($_GET['action']) && $_GET['action'] === \"password_recovery\") {\n        // Case where user has asked new PW\n        echo '\n            <div style=\"width:400px;margin:50px auto 50px auto;padding:25px;\" class=\"ui-state-highlight ui-corner-all\">\n                <div style=\"text-align:center;font-weight:bold;margin-bottom:20px;\">\n                    '.$LANG['pw_recovery_asked'].'\n                </div>\n                <div id=\"generate_new_pw_error\" style=\"color:red;display:none;text-align:center;margin:5px;\"></div>\n                <div style=\"margin-bottom:3px;\">\n                    '.$LANG['pw_recovery_info'].'\n                </div>\n                <div style=\"margin:15px; text-align:center;\">\n                    <input type=\"button\" id=\"but_generate_new_password\" onclick=\"GenerateNewPassword(\\''.htmlspecialchars($_GET['key'], ENT_QUOTES).'\\',\\''.htmlspecialchars($_GET['login'], ENT_QUOTES).'\\')\" style=\"padding:3px;cursor:pointer;\" class=\"ui-state-default ui-corner-all\" value=\"'.$LANG['pw_recovery_button'].'\" />\n                    <br /><br />\n                    <div id=\"ajax_loader_send_mail\" style=\"display:none; margin: 20px;\"><span class=\"fa fa-cog fa-spin fa-2x\"></span></div>\n                </div>\n                <div style=\"margin-top:30px; text-align:center;\">\n                    <a href=\"index.php\" class=\"tip\" title=\"'.$LANG['home'].'\"><span class=\"fa fa-home fa-lg\"></span></a>\n                </div>\n            </div>';\n    } elseif (empty($session_user_id) === false && $session_user_id !== null) {\n        // Page doesn't exist\n        $_SESSION['error']['code'] = ERR_NOT_EXIST;\n        include $SETTINGS['cpassman_dir'].'/error.php';\n        // When user is not identified\n    } else {\n        // Automatic redirection\n        if (strpos($server_request_uri, \"?\") > 0) {\n            $nextUrl = filter_var(substr($server_request_uri, strpos($server_request_uri, \"?\")), FILTER_SANITIZE_URL);\n        } else {\n            $nextUrl = \"\";\n        }\n        // MAINTENANCE MODE\n        if (isset($SETTINGS['maintenance_mode']) === true && $SETTINGS['maintenance_mode'] === '1') {\n            echo '\n                <div style=\"text-align:center;margin-top:30px;margin-bottom:20px;padding:10px;\"\n                    class=\"ui-state-error ui-corner-all\">\n                    <b>'.addslashes($LANG['index_maintenance_mode']).'</b>\n                </div>';\n        } elseif (isset($_GET['session_over']) && $_GET['session_over'] === 'true') {\n            // SESSION FINISHED => RECONNECTION ASKED\n            echo '\n                    <div style=\"text-align:center;margin-top:30px;margin-bottom:20px;padding:10px;\"\n                        class=\"ui-state-error ui-corner-all\">\n                        <b>'.addslashes($LANG['index_session_expired']).'</b>\n                    </div>';\n        }\n\n        // case where user not logged and can't access a direct link\n        if (empty($_GET['page']) === false) {\n            $superGlobal->put(\n                \"initial_url\",\n                filter_var(\n                    substr($server_request_uri, strpos($server_request_uri, \"index.php?\")),\n                    FILTER_SANITIZE_URL\n                ),\n                \"SESSION\"\n            );\n            // REDIRECTION PAGE ERREUR\n            echo '\n            <script language=\"javascript\" type=\"text/javascript\">\n            <!--\n                sessionStorage.clear();\n                window.location.href = \"index.php\";\n            -->\n            </script>';\n            exit;\n        } else {\n            $superGlobal->put(\"initial_url\", '', \"SESSION\");\n        }\n\n        // CONNECTION FORM\n        echo '\n                <form method=\"post\" name=\"form_identify\" id=\"form_identify\" action=\"\">\n                    <div style=\"width:480px;margin:10px auto 10px auto;padding:25px;\" class=\"ui-state-highlight ui-corner-all\">\n                        <div style=\"text-align:center;font-weight:bold;margin-bottom:20px;\">',\n        isset($SETTINGS['custom_logo']) && !empty($SETTINGS['custom_logo']) ? '<img src=\"'.(string) $SETTINGS['custom_logo'].'\" alt=\"\" style=\"margin-bottom:40px;\" />' : '', '<br />\n                            '.$LANG['index_get_identified'].'\n                            <span id=\"ajax_loader_connexion\" style=\"display:none;margin-left:10px;\"><span class=\"fa fa-cog fa-spin fa-1x\"></span></span>\n                        </div>\n                        <div id=\"connection_error\" style=\"display:none;text-align:center;margin:5px; padding:3px;\" class=\"ui-state-error ui-corner-all\">&nbsp;<i class=\"fa fa-warning\"></i>&nbsp;'.$LANG['index_bas_pw'].'</div>';\n        echo '\n                        <div style=\"margin-bottom:3px;\">\n                            <label for=\"login\" class=\"form_label\">', isset($SETTINGS['custom_login_text']) && !empty($SETTINGS['custom_login_text']) ? (string) $SETTINGS['custom_login_text'] : $LANG['index_login'], '</label>\n                            <input type=\"text\" size=\"10\" id=\"login\" name=\"login\" class=\"input_text text ui-widget-content ui-corner-all\" />\n                            <span id=\"login_check_wait\" style=\"display:none; float:right;\"><i class=\"fa fa-cog fa-spin fa-1x\"></i></span>\n                        </div>';\n\n        // AGSES\n        if (isset($SETTINGS['agses_authentication_enabled']) && $SETTINGS['agses_authentication_enabled'] == 1) {\n            echo '\n                        <div id=\"agses_cardid_div\" style=\"text-align:center; display:none; padding:5px; width:454px; margin-bottom:5px;\" class=\"ui-state-active ui-corner-all\">\n                            '.$LANG['user_profile_agses_card_id'].': &nbsp;\n                            <input type=\"text\" size=\"12\" id=\"agses_cardid\">\n                        </div>\n                        <div id=\"agses_flickercode_div\" style=\"text-align:center; display:none;\">\n                            <canvas id=\"axs_canvas\"></canvas>\n                        </div>';\n        }\n\n                        echo '\n                        <div id=\"connect_pw\" style=\"margin-bottom:3px;\">\n                            <label for=\"pw\" class=\"form_label\" id=\"user_pwd\">'.$LANG['index_password'].'</label>\n                            <input type=\"password\" size=\"10\" id=\"pw\" name=\"pw\" onkeypress=\"if (event.keyCode == 13) launchIdentify(\\'', isset($SETTINGS['duo']) && $SETTINGS['duo'] === \"1\" ? 1 : '', '\\', \\''.$nextUrl.'\\', \\'', isset($SETTINGS['google_authentication']) && $SETTINGS['google_authentication'] === \"1\" ? 1 : '', '\\')\" class=\"input_text text ui-widget-content ui-corner-all\" />\n                        </div>';\n\n        // Personal salt key\n        if (isset($SETTINGS['psk_authentication']) && $SETTINGS['psk_authentication'] === \"1\") {\n            echo '\n                        <div id=\"connect_psk\" style=\"margin-bottom:3px;\">\n                            <label for=\"personal_psk\" class=\"form_label\">'.$LANG['home_personal_saltkey'].'</label>\n                            <input type=\"password\" size=\"10\" id=\"psk\" name=\"psk\" onkeypress=\"if (event.keyCode == 13) launchIdentify(\\'', isset($SETTINGS['duo']) && $SETTINGS['duo'] === \"1\" ? 1 : '', '\\', \\''.$nextUrl.'\\', \\'', isset($SETTINGS['psk_authentication']) && $SETTINGS['psk_authentication'] === \"1\" ? 1 : '', '\\')\" class=\"input_text text ui-widget-content ui-corner-all\" />\n                        </div>\n                        <div id=\"connect_psk_confirm\" style=\"margin-bottom:3px; display:none;\">\n                            <label for=\"psk_confirm\" class=\"form_label\">'.$LANG['home_personal_saltkey_confirm'].'</label>\n                            <input type=\"password\" size=\"10\" id=\"psk_confirm\" name=\"psk_confirm\" onkeypress=\"if (event.keyCode == 13) launchIdentify(\\'', isset($SETTINGS['duo']) && $SETTINGS['duo'] === \"1\" ? 1 : '', '\\', \\''.$nextUrl.'\\', \\'', isset($SETTINGS['psk_authentication']) && $SETTINGS['psk_authentication'] === \"1\" ? 1 : '', '\\')\" class=\"input_text text ui-widget-content ui-corner-all\" />\n                        </div>';\n        }\n\n        // Google Authenticator code\n        if (isset($SETTINGS['google_authentication']) && $SETTINGS['google_authentication'] === \"1\") {\n            echo '\n                        <div id=\"ga_code_div\" style=\"margin-bottom:10px;\">\n                            '.$LANG['ga_identification_code'].'\n                            <input type=\"text\" size=\"4\" id=\"ga_code\" name=\"ga_code\" style=\"margin:0px;\" class=\"input_text text ui-widget-content ui-corner-all numeric_only\" onkeypress=\"if (event.keyCode == 13) launchIdentify(\\'', isset($SETTINGS['duo']) && $SETTINGS['duo'] === \"1\" ? 1 : '', '\\', \\''.$nextUrl.'\\')\" />\n                        <div id=\"2fa_new_code_div\" style=\"text-align:center; display:none; margin-top:5px; padding:5px;\" class=\"ui-state-default ui-corner-all\"></div>\n                        <div style=\"margin-top:2px; font-size:10px; text-align:center; cursor:pointer;\" onclick=\"send_user_new_temporary_ga_code()\">'.$LANG['i_need_to_generate_new_ga_code'].'</div>\n                        </div>';\n        }\n        echo '\n                        <div style=\"margin-bottom:3px;\">\n                            <label for=\"duree_session\" class=\"\">'.$LANG['index_session_duration'].'&nbsp;('.$LANG['minutes'].') </label>\n                            <input type=\"text\" size=\"4\" id=\"duree_session\" name=\"duree_session\" value=\"', isset($SETTINGS['default_session_expiration_time']) ? $SETTINGS['default_session_expiration_time'] : \"60\", '\" onkeypress=\"if (event.keyCode == 13) launchIdentify(\\'', isset($SETTINGS['duo']) && $SETTINGS['duo'] === \"1\" ? 1 : '', '\\', \\''.$nextUrl.'\\')\" class=\"input_text text ui-widget-content ui-corner-all numeric_only\" />\n                        </div>\n\n                        <div style=\"text-align:center;margin-top:5px;font-size:10pt;\">\n                            <span onclick=\"OpenDialog(\\'div_forgot_pw\\')\" style=\"padding:3px;cursor:pointer;\">'.$LANG['forgot_my_pw'].'</span>\n                        </div>\n                        <div style=\"text-align:center;margin-top:15px;\">\n                            <input type=\"button\" id=\"but_identify_user\" onclick=\"launchIdentify(\\'', isset($SETTINGS['duo']) && $SETTINGS['duo'] === \"1\" ? 1 : '', '\\', \\''.$nextUrl.'\\', \\'', isset($SETTINGS['psk_authentication']) && $SETTINGS['psk_authentication'] === \"1\" ? 1 : '', '\\')\" style=\"padding:3px;cursor:pointer;\" class=\"ui-state-default ui-corner-all\" value=\"'.$LANG['index_identify_button'].'\" />\n                        </div>\n                    </div>\n                </form>\n                <script type=\"text/javascript\">\n                    $(\"#login\").focus();\n                </script>';\n        // DIV for forgotten password\n        echo '\n                <div id=\"div_forgot_pw\" style=\"display:none;\">\n                    <div style=\"margin:5px auto 5px auto;\" id=\"div_forgot_pw_alert\"></div>\n                    <div style=\"margin:5px auto 5px auto;\">'.$LANG['forgot_my_pw_text'].'</div>\n                    <label for=\"forgot_pw_email\">'.$LANG['email'].'</label>\n                    <input type=\"text\" size=\"40\" name=\"forgot_pw_email\" id=\"forgot_pw_email\" />\n                    <br />\n                    <label for=\"forgot_pw_login\">'.$LANG['login'].'</label>\n                    <input type=\"text\" size=\"20\" name=\"forgot_pw_login\" id=\"forgot_pw_login\" />\n                    <div id=\"div_forgot_pw_status\" style=\"text-align:center;margin-top:15px;display:none; padding:5px;\" class=\"ui-corner-all\">\n                        <i class=\"fa fa-cog fa-spin fa-2x\"></i>&nbsp;<b>'.$LANG['please_wait'].'</b>\n                    </div>\n                </div>';\n    }\n    echo '\n    </div>';\n// FOOTER\n/* DON'T MODIFY THE FOOTER ... MANY THANKS TO YOU */\n    echo '\n    <div id=\"footer\">\n        <div style=\"float:left;width:32%;\">\n            <a href=\"http://teampass.net\" target=\"_blank\" style=\"color:#F0F0F0;\">'.$SETTINGS_EXT['tool_name'].'&nbsp;'.$SETTINGS_EXT['version'].'&nbsp;<i class=\"fa fa-copyright\"></i>&nbsp;'.$SETTINGS_EXT['copyright'].'</a>\n            &nbsp;|&nbsp;\n            <a href=\"http://teampass.readthedocs.io/en/latest/\" target=\"_blank\" style=\"color:#F0F0F0;\" class=\"tip\" title=\"'.addslashes($LANG['documentation_canal']).' ReadTheDocs\"><i class=\"fa fa-book\"></i></a>\n            &nbsp;\n            <a href=\"https://www.reddit.com/r/TeamPass/\" target=\"_blank\" style=\"color:#F0F0F0;\" class=\"tip\" title=\"'.addslashes($LANG['admin_help']).'\"><i class=\"fa fa-reddit-alien\"></i></a>\n        </div>\n        <div style=\"float:left;width:32%;text-align:center;\">\n            ', ($session_user_id !== null && empty($session_user_id) === false) ? '<i class=\"fa fa-users\"></i>&nbsp;'.$_SESSION['nb_users_online'].'&nbsp;'.$LANG['users_online'].'&nbsp;|&nbsp;<i class=\"fa fa-hourglass-end\"></i>&nbsp;'.$LANG['index_expiration_in'].'&nbsp;<div style=\"display:inline;\" id=\"countdown\"></div>' : '', '\n        </div><div id=\"countdown2\"></div>\n        <div style=\"float:right;text-align:right;\">\n            <i class=\"fa fa-clock-o\"></i>&nbsp;'. $LANG['server_time'].\" : \".@date($SETTINGS['date_format'], (string) $_SERVER['REQUEST_TIME']).\" - \".@date($SETTINGS['time_format'], (string) $_SERVER['REQUEST_TIME']).'\n        </div>\n    </div>';\n// PAGE LOADING\n    echo '\n    <div id=\"div_loading\" class=\"hidden\">\n        <div style=\"padding:5px; z-index:9999999;\" class=\"ui-widget-content ui-state-focus ui-corner-all\">\n            <i class=\"fa fa-cog fa-spin fa-2x\"></i>\n        </div>\n    </div>';\n// Alert BOX\n    echo '\n    <div id=\"div_dialog_message\" style=\"display:none;\">\n        <div id=\"div_dialog_message_text\" style=\"text-align:center; padding:4px; font-size:12px; margin-top:10px;\"></div>\n    </div>';\n\n// WARNING FOR QUERY ERROR\n    echo '\n    <div id=\"div_mysql_error\" style=\"display:none;\">\n        <div style=\"padding:10px;text-align:center;\" id=\"mysql_error_warning\"></div>\n    </div>';\n\n\n//Personnal SALTKEY\n    if (isset($SETTINGS['enable_pf_feature']) && $SETTINGS['enable_pf_feature'] === \"1\") {\n        echo '\n        <div id=\"div_set_personal_saltkey\" style=\"display:none;padding:4px;\">\n            <i class=\"fa fa-key\"></i> <b>'.$LANG['home_personal_saltkey'].'</b>\n            <input type=\"password\" name=\"input_personal_saltkey\" id=\"input_personal_saltkey\" style=\"width:200px;padding:5px;margin-left:30px;\" class=\"text ui-widget-content ui-corner-all text_without_symbols tip\" value=\"', isset($_SESSION['user_settings']['clear_psk']) ? (string) $_SESSION['user_settings']['clear_psk'] : '', '\" title=\"<i class=\\'fa fa-bullhorn\\'></i>&nbsp;'.$LANG['text_without_symbols'].'\" />\n            <span id=\"set_personal_saltkey_last_letter\" style=\"font-weight:bold;font-size:20px;\"></span>\n            <div style=\"display:none;margin-top:5px;text-align:center;padding:4px;\" id=\"set_personal_saltkey_warning\" class=\"ui-widget-content ui-state-error ui-corner-all\"></div>\n        </div>';\n    }\n\n// user profile\n    echo '\n<div id=\"dialog_user_profil\" style=\"display:none;padding:4px;\">\n    <div id=\"div_user_profil\">\n        <i class=\"fa fa-cog fa-spin fa-2x\"></i>&nbsp;<b>'.$LANG['please_wait'].'</b>\n    </div>\n</div>';\n\n// DUO box\n    echo '\n<div id=\"dialog_duo\" style=\"display:none;padding:4px;\">\n    <div id=\"div_duo\"></div>\n    '.$LANG['duo_loading_iframe'].'\n    <form method=\"post\" id=\"duo_form\" action=\"#\">\n        <input type=\"hidden\" id=\"duo_login\" name=\"duo_login\" value=\"', null !== $post_duo_login ? $post_duo_login : '', '\" />\n        <input type=\"hidden\" id=\"duo_data\" name=\"duo_data\" value=\"', null !== $post_duo_data ? htmlentities(base64_decode($post_duo_data)) : '', '\" />\n    </form>\n</div>';\n\n// INCREASE session time\n    echo '\n<div id=\"div_increase_session_time\" style=\"display:none;padding:4px;\">\n    <b>'.$LANG['index_session_duration'].':</b>\n    <input type=\"text\" id=\"input_session_duration\" style=\"width:50px;padding:5px;margin:0 10px 0 10px;\" class=\"text ui-widget-content ui-corner-all\" value=\"', isset($_SESSION['user_settings']['session_duration']) ? (int) $_SESSION['user_settings']['session_duration'] / 60 : 60, '\" />\n    <b>'.$LANG['minutes'].'</b>\n    <div style=\"display:none;margin-top:5px;text-align:center;padding:4px;\" id=\"input_session_duration_warning\" class=\"ui-widget-content ui-state-error ui-corner-all\"></div>\n</div>';\n\n    closelog();\n\n?>\n<script type=\"text/javascript\">NProgress.start();</script>\n    </body>\n</html>", "<?php\n/**\n * @file          install.queries.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\nrequire_once('../sources/SecureHandler.php');\nsession_start();\nerror_reporting(E_ERROR | E_PARSE);\nheader(\"Content-type: text/html; charset=utf-8\");\n$session_db_encoding = \"utf8\";\n\nfunction chmodRecursive($dir, $dirPermissions, $filePermissions)\n{\n    $pointer_dir = opendir($dir);\n    $res = true;\n    while ($file = readdir($pointer_dir)) {\n        if (($file == \".\") || ($file == \"..\")) {\n            continue;\n        }\n\n        $fullPath = $dir.\"/\".$file;\n\n        if (is_dir($fullPath)) {\n            if ($res = @chmod($fullPath, $dirPermissions)) {\n                $res = @chmodRecursive($fullPath, $dirPermissions, $filePermissions);\n            }\n        } else {\n            $res = chmod($fullPath, $filePermissions);\n        }\n        if (!$res) {\n            closedir($pointer_dir);\n            return false;\n        }\n    }\n    closedir($pointer_dir);\n    if (is_dir($dir) && $res) {\n            $res = @chmod($dir, $dirPermissions);\n    }\n\n    return $res;\n}\n\n/**\n * genHash()\n *\n * Generate a hash for user login\n * @param string $password\n */\nfunction bCrypt($password, $cost)\n{\n    $salt = sprintf('$2y$%02d$', $cost);\n    if (function_exists('openssl_random_pseudo_bytes')) {\n        $salt .= bin2hex(openssl_random_pseudo_bytes(11));\n    } else {\n        $chars = './ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n        for ($i = 0; $i < 22; $i++) {\n            $salt .= $chars[mt_rand(0, 63)];\n        }\n    }\n    return crypt($password, $salt);\n}\n\n/**\n * Permits to encrypt a message using Defuse\n * @param  string $message   Message to encrypt\n * @param  string $ascii_key Key to hash\n * @return array             String + Error\n */\nfunction encryptFollowingDefuse($message, $ascii_key)\n{\n    // load PhpEncryption library\n    $path = '../includes/libraries/Encryption/Encryption/';\n    require_once $path.'Crypto.php';\n    require_once $path.'Encoding.php';\n    require_once $path.'DerivedKeys.php';\n    require_once $path.'Key.php';\n    require_once $path.'KeyOrPassword.php';\n    require_once $path.'File.php';\n    require_once $path.'RuntimeTests.php';\n    require_once $path.'KeyProtectedByPassword.php';\n    require_once $path.'Core.php';\n\n    // convert KEY\n    $key = \\Defuse\\Crypto\\Key::loadFromAsciiSafeString($ascii_key);\n\n    try {\n        $text = \\Defuse\\Crypto\\Crypto::encrypt($message, $key);\n    } catch (Defuse\\Crypto\\Exception\\WrongKeyOrModifiedCiphertextException $ex) {\n        $err = \"an attack! either the wrong key was loaded, or the ciphertext has changed since it was created either corrupted in the database or intentionally modified by someone trying to carry out an attack.\";\n    } catch (Defuse\\Crypto\\Exception\\BadFormatException $ex) {\n        $err = $ex;\n    } catch (Defuse\\Crypto\\Exception\\EnvironmentIsBrokenException $ex) {\n        $err = $ex;\n    } catch (Defuse\\Crypto\\Exception\\CryptoException $ex) {\n        $err = $ex;\n    } catch (Defuse\\Crypto\\Exception\\IOException $ex) {\n        $err = $ex;\n    }\n\n    return array(\n        'string' => isset($text) ? $text : \"\",\n        'error' => $err\n    );\n}\n\n\n// Prepare POST variables\n$post_type = filter_input(INPUT_POST, 'type', FILTER_SANITIZE_STRING);\n$post_data = filter_input(INPUT_POST, 'data', FILTER_SANITIZE_STRING);\n$post_activity = filter_input(INPUT_POST, 'activity', FILTER_SANITIZE_STRING);\n$post_task = filter_input(INPUT_POST, 'task', FILTER_SANITIZE_STRING);\n$post_index = filter_input(INPUT_POST, 'index', FILTER_SANITIZE_NUMBER_INT);\n$post_multiple = filter_input(INPUT_POST, 'multiple', FILTER_SANITIZE_STRING);\n$post_db = filter_input(INPUT_POST, 'db', FILTER_SANITIZE_STRING);\n\n// Load libraries\nrequire_once '../includes/libraries/protect/SuperGlobal/SuperGlobal.php';\n$superGlobal = new protect\\SuperGlobal\\SuperGlobal();\n\n// Prepare SESSION variables\n$session_url_path = $superGlobal->get(\"url_path\", \"SESSION\");\n$session_abspath = $superGlobal->get(\"abspath\", \"SESSION\");\n$session_db_encoding = $superGlobal->get(\"db_encoding\", \"SESSION\");\n\n$superGlobal->put(\"CPM\", 1, \"SESSION\");\n\nif (null !== $post_type) {\n    switch ($post_type) {\n        case \"step_2\":\n            //decrypt\n            require_once 'libs/aesctr.php'; // AES Counter Mode implementation\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_data, \"cpm\", 128);\n            $data = json_decode($json, true);\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_activity, \"cpm\", 128);\n            $data = array_merge($data, array(\"activity\" => $json));\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_task, \"cpm\", 128);\n            $data = array_merge($data, array(\"task\" => $json));\n\n            $abspath = str_replace('\\\\', '/', $data['root_path']);\n            if (substr($abspath, strlen($abspath) - 1) == \"/\") {\n                $abspath = substr($abspath, 0, strlen($abspath) - 1);\n            }\n            $session_abspath = $abspath;\n            $session_url_path = $data['url_path'];\n\n            if (isset($data['activity']) && $data['activity'] === \"folder\") {\n                if (is_writable($abspath.\"/\".$data['task'].\"/\") === true) {\n                    echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                } else {\n                    echo '[{\"error\" : \" Path '.$data['task'].' is not writable!\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                }\n                break;\n            }\n\n            if (isset($data['activity']) && $data['activity'] === \"extension\") {\n                if (extension_loaded($data['task'])) {\n                    echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                } else {\n                    echo '[{\"error\" : \" Extension '.$data['task'].' is not loaded!\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                }\n                break;\n            }\n\n            if (isset($data['activity']) && $data['activity'] === \"function\") {\n                if (function_exists($data['task'])) {\n                    echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                } else {\n                    echo '[{\"error\" : \" Function '.$data['task'].' is not available!\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                }\n                break;\n            }\n\n            if (isset($data['activity']) && $data['activity'] === \"version\") {\n                if (version_compare(phpversion(), '5.5.0', '>=')) {\n                    echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                } else {\n                    echo '[{\"error\" : \"PHP version '.phpversion().' is not OK (minimum is 5.5.0)\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                }\n                break;\n            }\n\n            if (isset($data['activity']) && $data['activity'] === \"ini\") {\n                if (ini_get($data['task']) >= 60) {\n                    echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\"}]';\n                } else {\n                    echo '[{\"error\" : \"PHP \\\"Maximum execution time\\\" is set to '.ini_get('max_execution_time').' seconds. Please try to set to 60s at least during installation.\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                }\n                break;\n            }\n            break;\n\n        case \"step_3\":\n            //decrypt\n            require_once 'libs/aesctr.php'; // AES Counter Mode implementation\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_data, \"cpm\", 128);\n            $data = json_decode($json, true);\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_db, \"cpm\", 128);\n            $db = json_decode($json, true);\n\n            // launch\n            if ($dbTmp = mysqli_connect($db['db_host'], $db['db_login'], $db['db_pw'], $db['db_bdd'], $db['db_port'])) {\n                // create temporary INSTALL mysqli table\n                $mysqli_result = mysqli_query(\n                    $dbTmp,\n                    \"CREATE TABLE IF NOT EXISTS `_install` (\n                    `key` varchar(100) NOT NULL,\n                    `value` varchar(500) NOT NULL\n                    ) CHARSET=utf8;\"\n                );\n                // store values\n                foreach ($data as $key => $value) {\n                    $superGlobal->put($key, $value, \"SESSION\");\n                    $tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `_install` WHERE `key` = '\".$key.\"'\"));\n                    if (intval($tmp) === 0) {\n                        mysqli_query($dbTmp, \"INSERT INTO `_install` (`key`, `value`) VALUES ('\".$key.\"', '\".$value.\"');\");\n                    } else {\n                        mysqli_query($dbTmp, \"UPDATE `_install` SET `value` = '\".$value.\"' WHERE `key` = '\".$key.\"';\");\n                    }\n                }\n                $tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `_install` WHERE `key` = 'url_path'\"));\n                if (intval($tmp) === 0) {\n                    mysqli_query($dbTmp, \"INSERT INTO `_install` (`key`, `value`) VALUES ('url_path', '\", empty($session_url_path) ? $db['url_path'] : $session_url_path, \"');\");\n                } else {\n                    mysqli_query($dbTmp, \"UPDATE `_install` SET `value` = '\", empty($session_url_path) ? $db['url_path'] : $session_url_path, \"' WHERE `key` = 'url_path';\");\n                }\n                $tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `_install` WHERE `key` = 'abspath'\"));\n                if (intval($tmp) === 0) {\n                    mysqli_query($dbTmp, \"INSERT INTO `_install` (`key`, `value`) VALUES ('abspath', '\", empty($session_abspath) ? $db['abspath'] : $session_abspath, \"');\");\n                } else {\n                    mysqli_query($dbTmp, \"UPDATE `_install` SET `value` = '\", empty($session_abspath) ? $db['abspath'] : $session_abspath, \"' WHERE `key` = 'abspath';\");\n                }\n\n                echo '[{\"error\" : \"\", \"result\" : \"Connection is successful\", \"multiple\" : \"\"}]';\n            } else {\n                echo '[{\"error\" : \"'.addslashes(str_replace(array(\"'\", \"\\n\", \"\\r\"), array('\"', '', ''), mysqli_connect_error())).'\", \"result\" : \"Failed\", \"multiple\" : \"\"}]';\n            }\n            mysqli_close($dbTmp);\n            break;\n\n        case \"step_4\":\n            //decrypt\n            require_once 'libs/aesctr.php'; // AES Counter Mode implementation\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_data, \"cpm\", 128);\n            $data = json_decode($json, true);\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_db, \"cpm\", 128);\n            $db = json_decode($json, true);\n\n            $dbTmp = mysqli_connect($db['db_host'], $db['db_login'], $db['db_pw'], $db['db_bdd'], $db['db_port']);\n\n            // prepare data\n            foreach ($data as $key => $value) {\n                $data[$key] = str_replace(array('&quot;', '&#92;'), array('\"\"', '\\\\\\\\'), $value);\n            }\n\n            // check skpath\n            if (empty($data['sk_path'])) {\n                $data['sk_path'] = $session_abspath.\"/includes\";\n            } else {\n                $data['sk_path'] = str_replace(\"&#92;\", \"/\", $data['sk_path']);\n            }\n            if (substr($data['sk_path'], strlen($data['sk_path']) - 1) == \"/\" || substr($data['sk_path'], strlen($data['sk_path']) - 1) == \"\\\"\") {\n                $data['sk_path'] = substr($data['sk_path'], 0, strlen($data['sk_path']) - 1);\n            }\n            if (is_dir($data['sk_path'])) {\n                if (is_writable($data['sk_path'])) {\n                    // store all variables in SESSION\n                    foreach ($data as $key => $value) {\n                        $superGlobal->put($key, $value, \"SESSION\");\n                        $tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `_install` WHERE `key` = '\".$key.\"'\"));\n                        if (intval($tmp) === 0) {\n                            mysqli_query($dbTmp, \"INSERT INTO `_install` (`key`, `value`) VALUES ('\".$key.\"', '\".$value.\"');\");\n                        } else {\n                            mysqli_query($dbTmp, \"UPDATE `_install` SET `value` = '\".$value.\"' WHERE `key` = '\".$key.\"';\");\n                        }\n                    }\n                    echo '[{\"error\" : \"\", \"result\" : \"Information stored\", \"multiple\" : \"\"}]';\n                } else {\n                    echo '[{\"error\" : \"The Directory must be writable!\", \"result\" : \"Information stored\", \"multiple\" : \"\"}]';\n                }\n            } else {\n                echo '[{\"error\" : \"'.$data['sk_path'].' is not a Directory!\", \"result\" : \"Information stored\", \"multiple\" : \"\"}]';\n            }\n            mysqli_close($dbTmp);\n            break;\n\n        case \"step_5\":\n            //decrypt\n            require_once 'libs/aesctr.php'; // AES Counter Mode implementation\n            $activity = Encryption\\Crypt\\aesctr::decrypt($post_activity, \"cpm\", 128);\n            $task = Encryption\\Crypt\\aesctr::decrypt($post_task, \"cpm\", 128);\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_db, \"cpm\", 128);\n            $db = json_decode($json, true);\n\n            // launch\n            $dbTmp = mysqli_connect($db['db_host'], $db['db_login'], $db['db_pw'], $db['db_bdd'], $db['db_port']);\n            $dbBdd = $db['db_bdd'];\n            if ($dbTmp) {\n                $mysqli_result = \"\";\n\n                // read install variables\n                $result = mysqli_query($dbTmp, \"SELECT * FROM `_install`\");\n                while ($row = $result->fetch_array()) {\n                    $var[$row[0]] = $row[1];\n                }\n\n                if ($activity === \"table\") {\n                    //FORCE UTF8 DATABASE\n                    mysqli_query($dbTmp, \"ALTER DATABASE `\".$dbBdd.\"` DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci\");\n                    if ($task === \"items\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"items` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `label` varchar(500) NOT NULL,\n                            `description` text DEFAULT NULL,\n                            `pw` text DEFAULT NULL,\n                            `pw_iv` text DEFAULT NULL,\n                            `pw_len` int(5) NOT NULL DEFAULT '0',\n                            `url` varchar(500) DEFAULT NULL,\n                            `id_tree` varchar(10) DEFAULT NULL,\n                            `perso` tinyint(1) NOT null DEFAULT '0',\n                            `login` varchar(200) DEFAULT NULL,\n                            `inactif` tinyint(1) NOT null DEFAULT '0',\n                            `restricted_to` varchar(200) DEFAULT NULL,\n                            `anyone_can_modify` tinyint(1) NOT null DEFAULT '0',\n                            `email` varchar(100) DEFAULT NULL,\n                            `notification` varchar(250) DEFAULT NULL,\n                            `viewed_no` int(12) NOT null DEFAULT '0',\n                            `complexity_level` varchar(3) NOT null DEFAULT '-1',\n                            `auto_update_pwd_frequency` tinyint(2) NOT null DEFAULT '0',\n                            `auto_update_pwd_next_date` varchar(100) NOT null DEFAULT '0',\n                            `encryption_type` VARCHAR(20) NOT NULL DEFAULT 'not_set',\n                            PRIMARY KEY (`id`),\n                            KEY    `restricted_inactif_idx` (`restricted_to`,`inactif`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"log_items\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"log_items` (\n                            `id_item` int(8) NOT NULL,\n                            `date` varchar(50) NOT NULL,\n                            `id_user` int(8) NOT NULL,\n                            `action` varchar(250) NULL,\n                            `raison` text NULL,\n                            `raison_iv` text NULL,\n                            `encryption_type` VARCHAR(20) NOT NULL DEFAULT 'not_set'\n                            ) CHARSET=utf8;\"\n                        );\n                        // create index\n                        mysqli_query(\n                            $dbTmp,\n                            \"CREATE INDEX teampass_log_items_id_item_IDX ON \".$var['tbl_prefix'].\"log_items (id_item,date);\"\n                        );\n                    } elseif ($task === \"misc\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"misc` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `type` varchar(50) NOT NULL,\n                            `intitule` varchar(100) NOT NULL,\n                            `valeur` varchar(500) NOT NULL,\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n\n                        // include constants\n                        require_once \"../includes/config/include.php\";\n\n                        // prepare config file\n                        $tp_config_file = \"../includes/config/tp.config.php\";\n                        if (file_exists($tp_config_file)) {\n                            if (!copy($tp_config_file, $tp_config_file.'.'.date(\"Y_m_d\", mktime(0, 0, 0, date('m'), date('d'), date('y'))))) {\n                                echo '[{\"error\" : \"includes/config/tp.config.php file already exists and cannot be renamed. Please do it by yourself and click on button Launch.\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                                break;\n                            } else {\n                                unlink($tp_config_file);\n                            }\n                        }\n                        $file_handler = fopen($tp_config_file, 'w');\n                        $config_text = \"<?php\nglobal \\$SETTINGS;\n\\$SETTINGS = array (\";\n\n                        // add by default settings\n                        $aMiscVal = array(\n                            array('admin', 'max_latest_items', '10'),\n                            array('admin', 'enable_favourites', '1'),\n                            array('admin', 'show_last_items', '1'),\n                            array('admin', 'enable_pf_feature', '0'),\n                            array('admin', 'log_connections', '0'),\n                            array('admin', 'log_accessed', '1'),\n                            array('admin', 'time_format', 'H:i:s'),\n                            array('admin', 'date_format', 'd/m/Y'),\n                            array('admin', 'duplicate_folder', '0'),\n                            array('admin', 'item_duplicate_in_same_folder', '0'),\n                            array('admin', 'duplicate_item', '0'),\n                            array('admin', 'number_of_used_pw', '3'),\n                            array('admin', 'manager_edit', '1'),\n                            array('admin', 'cpassman_dir', $var['abspath']),\n                            array('admin', 'cpassman_url', $var['url_path']),\n                            array('admin', 'favicon', $var['url_path'].'/favicon.ico'),\n                            array('admin', 'path_to_upload_folder', $var['abspath'].'/upload'),\n                            array('admin', 'url_to_upload_folder', $var['url_path'].'/upload'),\n                            array('admin', 'path_to_files_folder', $var['abspath'].'/files'),\n                            array('admin', 'url_to_files_folder', $var['url_path'].'/files'),\n                            array('admin', 'activate_expiration', '0'),\n                            array('admin', 'pw_life_duration', '0'),\n                            array('admin', 'maintenance_mode', '1'),\n                            array('admin', 'enable_sts', '0'),\n                            array('admin', 'encryptClientServer', '1'),\n                            array('admin', 'cpassman_version', $SETTINGS_EXT['version']),\n                            array('admin', 'ldap_mode', '0'),\n                            array('admin', 'ldap_type', '0'),\n                            array('admin', 'ldap_suffix', '0'),\n                            array('admin', 'ldap_domain_dn', '0'),\n                            array('admin', 'ldap_domain_controler', '0'),\n                            array('admin', 'ldap_user_attribute', '0'),\n                            array('admin', 'ldap_ssl', '0'),\n                            array('admin', 'ldap_tls', '0'),\n                            array('admin', 'ldap_elusers', '0'),\n                            array('admin', 'ldap_search_base', '0'),\n                            array('admin', 'richtext', '0'),\n                            array('admin', 'allow_print', '0'),\n                            array('admin', 'roles_allowed_to_print', '0'),\n                            array('admin', 'show_description', '1'),\n                            array('admin', 'anyone_can_modify', '0'),\n                            array('admin', 'anyone_can_modify_bydefault', '0'),\n                            array('admin', 'nb_bad_authentication', '0'),\n                            array('admin', 'utf8_enabled', '1'),\n                            array('admin', 'restricted_to', '0'),\n                            array('admin', 'restricted_to_roles', '0'),\n                            array('admin', 'enable_send_email_on_user_login', '0'),\n                            array('admin', 'enable_user_can_create_folders', '0'),\n                            array('admin', 'insert_manual_entry_item_history', '0'),\n                            array('admin', 'enable_kb', '0'),\n                            array('admin', 'enable_email_notification_on_item_shown', '0'),\n                            array('admin', 'enable_email_notification_on_user_pw_change', '0'),\n                            array('admin', 'custom_logo', ''),\n                            array('admin', 'custom_login_text', ''),\n                            array('admin', 'default_language', 'english'),\n                            array('admin', 'send_stats', '0'),\n                            array('admin', 'send_statistics_items', 'stat_country;stat_users;stat_items;stat_items_shared;stat_folders;stat_folders_shared;stat_admins;stat_managers;stat_ro;stat_mysqlversion;stat_phpversion;stat_teampassversion;stat_languages;stat_kb;stat_suggestion;stat_customfields;stat_api;stat_2fa;stat_agses;stat_duo;stat_ldap;stat_syslog;stat_stricthttps;stat_fav;stat_pf;'),\n                            array('admin', 'send_stats_time', time() - 2592000),\n                            array('admin', 'get_tp_info', '1'),\n                            array('admin', 'send_mail_on_user_login', '0'),\n                            array('cron', 'sending_emails', '0'),\n                            array('admin', 'nb_items_by_query', 'auto'),\n                            array('admin', 'enable_delete_after_consultation', '0'),\n                            array('admin', 'enable_personal_saltkey_cookie', '0'),\n                            array('admin', 'personal_saltkey_cookie_duration', '31'),\n                            array('admin', 'email_smtp_server', ''),\n                            array('admin', 'email_smtp_auth', ''),\n                            array('admin', 'email_auth_username', ''),\n                            array('admin', 'email_auth_pwd', ''),\n                            array('admin', 'email_port', ''),\n                            array('admin', 'email_security', ''),\n                            array('admin', 'email_server_url', ''),\n                            array('admin', 'email_from', ''),\n                            array('admin', 'email_from_name', ''),\n                            array('admin', 'pwd_maximum_length', '40'),\n                            array('admin', 'google_authentication', '0'),\n                            array('admin', 'delay_item_edition', '0'),\n                            array('admin', 'allow_import', '0'),\n                            array('admin', 'proxy_ip', ''),\n                            array('admin', 'proxy_port', ''),\n                            array('admin', 'upload_maxfilesize', '10mb'),\n                            array('admin', 'upload_docext', 'doc,docx,dotx,xls,xlsx,xltx,rtf,csv,txt,pdf,ppt,pptx,pot,dotx,xltx'),\n                            array('admin', 'upload_imagesext', 'jpg,jpeg,gif,png'),\n                            array('admin', 'upload_pkgext', '7z,rar,tar,zip'),\n                            array('admin', 'upload_otherext', 'sql,xml'),\n                            array('admin', 'upload_imageresize_options', '1'),\n                            array('admin', 'upload_imageresize_width', '800'),\n                            array('admin', 'upload_imageresize_height', '600'),\n                            array('admin', 'upload_imageresize_quality', '90'),\n                            array('admin', 'use_md5_password_as_salt', '0'),\n                            array('admin', 'ga_website_name', 'TeamPass for ChangeMe'),\n                            array('admin', 'api', '0'),\n                            array('admin', 'subfolder_rights_as_parent', '0'),\n                            array('admin', 'show_only_accessible_folders', '0'),\n                            array('admin', 'enable_suggestion', '0'),\n                            array('admin', 'otv_expiration_period', '7'),\n                            array('admin', 'default_session_expiration_time', '60'),\n                            array('admin', 'duo', '0'),\n                            array('admin', 'enable_server_password_change', '0'),\n                            array('admin', 'ldap_object_class', '0'),\n                            array('admin', 'bck_script_path', $var['abspath'].\"/backups\"),\n                            array('admin', 'bck_script_filename', 'bck_teampass'),\n                            array('admin', 'syslog_enable', '0'),\n                            array('admin', 'syslog_host', 'localhost'),\n                            array('admin', 'syslog_port', '514'),\n                            array('admin', 'manager_move_item', '0'),\n                            array('admin', 'create_item_without_password', '0'),\n                            array('admin', 'otv_is_enabled', '0'),\n                            array('admin', 'agses_authentication_enabled', '0'),\n                            array('admin', 'item_extra_fields', '0'),\n                            array('admin', 'saltkey_ante_2127', 'none'),\n                            array('admin', 'migration_to_2127', 'done'),\n                            array('admin', 'files_with_defuse', 'done'),\n                            array('admin', 'timezone', 'UTC')\n                        );\n                        foreach ($aMiscVal as $elem) {\n                            //Check if exists before inserting\n                            $tmp = mysqli_num_rows(\n                                mysqli_query(\n                                    $dbTmp,\n                                    \"SELECT * FROM `\".$var['tbl_prefix'].\"misc`\n                                    WHERE type='\".$elem[0].\"' AND intitule='\".$elem[1].\"'\"\n                                )\n                            );\n                            if (intval($tmp) === 0) {\n                                $queryRes = mysqli_query(\n                                    $dbTmp,\n                                    \"INSERT INTO `\".$var['tbl_prefix'].\"misc`\n                                    (`type`, `intitule`, `valeur`) VALUES\n                                    ('\".$elem[0].\"', '\".$elem[1].\"', '\".\n                                    str_replace(\"'\", \"\", $elem[2]).\"');\"\n                                ); // or die(mysqli_error($dbTmp))\n                            }\n\n                            // append new setting in config file\n                            $config_text .= \"\n    '\".$elem[1].\"' => '\".str_replace(\"'\", \"\", $elem[2]).\"',\";\n                        }\n\n                        // write to config file\n                        $result = fwrite(\n                            $file_handler,\n                            utf8_encode(\n                                substr_replace($config_text, \"\", -1).\"\n);\"\n                            )\n                        );\n                        fclose($file_handler);\n                    } elseif ($task === \"nested_tree\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"nested_tree` (\n                            `id` bigint(20) unsigned NOT null AUTO_INCREMENT,\n                            `parent_id` int(11) NOT NULL,\n                            `title` varchar(255) NOT NULL,\n                            `nleft` int(11) NOT NULL DEFAULT '0',\n                            `nright` int(11) NOT NULL DEFAULT '0',\n                            `nlevel` int(11) NOT NULL DEFAULT '0',\n                            `bloquer_creation` tinyint(1) NOT null DEFAULT '0',\n                            `bloquer_modification` tinyint(1) NOT null DEFAULT '0',\n                            `personal_folder` tinyint(1) NOT null DEFAULT '0',\n                            `renewal_period` TINYINT(4) NOT null DEFAULT '0',\n                            PRIMARY KEY (`id`),\n                            UNIQUE KEY `id` (`id`),\n                            KEY `nested_tree_parent_id` (`parent_id`),\n                            KEY `nested_tree_nleft` (`nleft`),\n                            KEY `nested_tree_nright` (`nright`),\n                            KEY `nested_tree_nlevel` (`nlevel`),\n                            KEY `personal_folder_idx` (`personal_folder`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"rights\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"rights` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `tree_id` int(12) NOT NULL,\n                            `fonction_id` int(12) NOT NULL,\n                            `authorized` tinyint(1) NOT null DEFAULT '0',\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"users\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"users` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `login` varchar(50) NOT NULL,\n                            `pw` varchar(400) NOT NULL,\n                            `groupes_visibles` varchar(250) NOT NULL,\n                            `derniers` text NULL,\n                            `key_tempo` varchar(100) NULL,\n                            `last_pw_change` varchar(30) NULL,\n                            `last_pw` text NULL,\n                            `admin` tinyint(1) NOT null DEFAULT '0',\n                            `fonction_id` varchar(255) NULL,\n                            `groupes_interdits` varchar(255) NULL,\n                            `last_connexion` varchar(30) NULL,\n                            `gestionnaire` int(11) NOT null DEFAULT '0',\n                            `email` varchar(300) NOT NULL DEFAULT 'none',\n                            `favourites` varchar(300) NULL,\n                            `latest_items` varchar(300) NULL,\n                            `personal_folder` int(1) NOT null DEFAULT '0',\n                            `disabled` tinyint(1) NOT null DEFAULT '0',\n                            `no_bad_attempts` tinyint(1) NOT null DEFAULT '0',\n                            `can_create_root_folder` tinyint(1) NOT null DEFAULT '0',\n                            `read_only` tinyint(1) NOT null DEFAULT '0',\n                            `timestamp` varchar(30) NOT null DEFAULT '0',\n                            `user_language` varchar(50) NOT null DEFAULT '0',\n                            `name` varchar(100) NULL,\n                            `lastname` varchar(100) NULL,\n                            `session_end` varchar(30) NULL,\n                            `isAdministratedByRole` tinyint(5) NOT null DEFAULT '0',\n                            `psk` varchar(400) NULL,\n                            `ga` varchar(50) NULL,\n                            `ga_temporary_code` VARCHAR(20) NOT NULL DEFAULT 'none',\n                            `avatar` varchar(255) NULL,\n                            `avatar_thumb` varchar(255) NULL,\n                            `upgrade_needed` BOOLEAN NOT NULL DEFAULT FALSE,\n                            `treeloadstrategy` varchar(30) NOT null DEFAULT 'full',\n                            `can_manage_all_users` tinyint(1) NOT NULL DEFAULT '0',\n                            `usertimezone` VARCHAR(50) NOT NULL DEFAULT 'not_defined',\n                            `agses-usercardid` VARCHAR(50) NOT NULL DEFAULT '0',\n                            `encrypted_psk` text NULL,\n                            `user_ip` varchar(60) NOT null DEFAULT 'none',\n                            PRIMARY KEY (`id`),\n                            UNIQUE KEY `login` (`login`)\n                            ) CHARSET=utf8;\"\n                        );\n\n                        require_once \"../includes/config/include.php\";\n                        // check that admin accounts doesn't exist\n                        $tmp = mysqli_num_rows(mysqli_query($dbTmp, \"SELECT * FROM `\".$var['tbl_prefix'].\"users` WHERE login = 'admin'\"));\n                        if ($tmp === 0) {\n                            $mysqli_result = mysqli_query(\n                                $dbTmp,\n                                \"INSERT INTO `\".$var['tbl_prefix'].\"users` (`id`, `login`, `pw`, `admin`, `gestionnaire`, `personal_folder`, `groupes_visibles`, `email`, `encrypted_psk`, `last_pw_change`) VALUES ('1', 'admin', '\".bCrypt($var['admin_pwd'], '13').\"', '1', '0', '0', '', '', '', '\".time().\"')\"\n                            );\n                        } else {\n                            $mysqli_result = mysqli_query($dbTmp, \"UPDATE `\".$var['tbl_prefix'].\"users` SET `pw` = '\".bCrypt($var['admin_pwd'], '13').\"' WHERE login = 'admin' AND id = '1'\");\n                        }\n\n                        // check that API doesn't exist\n                        $tmp = mysqli_num_rows(mysqli_query($dbTmp, \"SELECT * FROM `\".$var['tbl_prefix'].\"users` WHERE id = '\".API_USER_ID.\"'\"));\n                        if ($tmp === 0) {\n                            $mysqli_result = mysqli_query(\n                                $dbTmp,\n                                \"INSERT INTO `\".$var['tbl_prefix'].\"users` (`id`, `login`, `pw`, `groupes_visibles`, `derniers`, `key_tempo`, `last_pw_change`, `last_pw`, `admin`, `fonction_id`, `groupes_interdits`, `last_connexion`, `gestionnaire`, `email`, `favourites`, `latest_items`, `personal_folder`) VALUES ('\".API_USER_ID.\"', 'API', '', '', '', '', '', '', '1', '', '', '', '0', '', '', '', '0')\"\n                            );\n                        }\n\n                        // check that OTV doesn't exist\n                        $tmp = mysqli_num_rows(mysqli_query($dbTmp, \"SELECT * FROM `\".$var['tbl_prefix'].\"users` WHERE id = '\".OTV_USER_ID.\"'\"));\n                        if ($tmp === 0) {\n                            $mysqli_result = mysqli_query(\n                                $dbTmp,\n                                \"INSERT INTO `\".$var['tbl_prefix'].\"users` (`id`, `login`, `pw`, `groupes_visibles`, `derniers`, `key_tempo`, `last_pw_change`, `last_pw`, `admin`, `fonction_id`, `groupes_interdits`, `last_connexion`, `gestionnaire`, `email`, `favourites`, `latest_items`, `personal_folder`) VALUES ('\".OTV_USER_ID.\"', 'OTV', '', '', '', '', '', '', '1', '', '', '', '0', '', '', '', '0')\"\n                            );\n                        }\n                    } elseif ($task === \"tags\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"tags` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `tag` varchar(30) NOT NULL,\n                            `item_id` int(12) NOT NULL,\n                            PRIMARY KEY (`id`),\n                            UNIQUE KEY `id` (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"log_system\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"log_system` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `type` varchar(20) NOT NULL,\n                            `date` varchar(30) NOT NULL,\n                            `label` text NOT NULL,\n                            `qui` varchar(255) NOT NULL,\n                            `field_1` varchar(250) DEFAULT NULL,\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"files\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"files` (\n                            `id` int(11) NOT null AUTO_INCREMENT,\n                            `id_item` int(11) NOT NULL,\n                            `name` varchar(100) NOT NULL,\n                            `size` int(10) NOT NULL,\n                            `extension` varchar(10) NOT NULL,\n                            `type` varchar(255) NOT NULL,\n                            `file` varchar(50) NOT NULL,\n                            `status` varchar(50) NOT NULL DEFAULT '0',\n                            PRIMARY KEY (`id`)\n                           ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"cache\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"cache` (\n                            `id` int(12) NOT NULL,\n                            `label` varchar(500) NOT NULL,\n                            `description` text NOT NULL,\n                            `tags` text DEFAULT NULL,\n                            `id_tree` int(12) NOT NULL,\n                            `perso` tinyint(1) NOT NULL,\n                            `restricted_to` varchar(200) DEFAULT NULL,\n                            `login` varchar(200) DEFAULT NULL,\n                            `folder` varchar(300) NOT NULL,\n                            `author` varchar(50) NOT NULL,\n                            `renewal_period` tinyint(4) NOT NULL DEFAULT '0',\n                            `timestamp` varchar(50) DEFAULT NULL,\n                            `url` varchar(500) NOT NULL DEFAULT '0',\n                            `encryption_type` VARCHAR(50) DEFAULT NULL DEFAULT '0'\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"roles_title\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"roles_title` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `title` varchar(50) NOT NULL,\n                            `allow_pw_change` TINYINT(1) NOT null DEFAULT '0',\n                            `complexity` INT(5) NOT null DEFAULT '0',\n                            `creator_id` int(11) NOT null DEFAULT '0',\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"roles_values\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"roles_values` (\n                            `role_id` int(12) NOT NULL,\n                            `folder_id` int(12) NOT NULL,\n                            `type` varchar(5) NOT NULL DEFAULT 'R',\n                            KEY `role_id_idx` (`role_id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"kb\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"kb` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `category_id` int(12) NOT NULL,\n                            `label` varchar(200) NOT NULL,\n                            `description` text NOT NULL,\n                            `author_id` int(12) NOT NULL,\n                            `anyone_can_modify` tinyint(1) NOT null DEFAULT '0',\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"kb_categories\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"kb_categories` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `category` varchar(50) NOT NULL,\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"kb_items\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"kb_items` (\n                            `kb_id` int(12) NOT NULL,\n                            `item_id` int(12) NOT NULL\n                           ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task == \"restriction_to_roles\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"restriction_to_roles` (\n                            `role_id` int(12) NOT NULL,\n                            `item_id` int(12) NOT NULL,\n                            KEY `role_id_idx`  (`role_id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"languages\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"languages` (\n                            `id` INT(10) NOT null AUTO_INCREMENT PRIMARY KEY ,\n                            `name` VARCHAR(50) NOT null ,\n                            `label` VARCHAR(50) NOT null ,\n                            `code` VARCHAR(10) NOT null ,\n                            `flag` VARCHAR(30) NOT NULL\n                            ) CHARSET=utf8;\"\n                        );\n\n                        // add lanaguages\n                        $tmp = mysqli_num_rows(mysqli_query($dbTmp, \"SELECT * FROM `\".$var['tbl_prefix'].\"languages` WHERE name = 'french'\"));\n                        if ($tmp[0] == 0) {\n                            $mysql_result = mysqli_query(\n                                $dbTmp,\n                                \"INSERT INTO `\".$var['tbl_prefix'].\"languages` (`name`, `label`, `code`, `flag`) VALUES\n                                ('french', 'French' , 'fr', 'fr.png'),\n                                ('english', 'English' , 'us', 'us.png'),\n                                ('spanish', 'Spanish' , 'es', 'es.png'),\n                                ('german', 'German' , 'de', 'de.png'),\n                                ('czech', 'Czech' , 'cz', 'cz.png'),\n                                ('italian', 'Italian' , 'it', 'it.png'),\n                                ('russian', 'Russian' , 'ru', 'ru.png'),\n                                ('turkish', 'Turkish' , 'tr', 'tr.png'),\n                                ('norwegian', 'Norwegian' , 'no', 'no.png'),\n                                ('japanese', 'Japanese' , 'ja', 'ja.png'),\n                                ('portuguese', 'Portuguese' , 'pr', 'pr.png'),\n                                ('portuguese_br', 'Portuguese (Brazil)' , 'pr-bt', 'pr-bt.png'),\n                                ('chinese', 'Chinese' , 'cn', 'cn.png'),\n                                ('swedish', 'Swedish' , 'se', 'se.png'),\n                                ('dutch', 'Dutch' , 'nl', 'nl.png'),\n                                ('catalan', 'Catalan' , 'ct', 'ct.png'),\n                                ('vietnamese', 'Vietnamese' , 'vi', 'vi.png'),\n                                ('estonian', 'Estonian' , 'ee', 'ee.png');\"\n                            );\n                        }\n                    } elseif ($task === \"emails\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"emails` (\n                            `timestamp` INT(30) NOT null ,\n                            `subject` VARCHAR(255) NOT null ,\n                            `body` TEXT NOT null ,\n                            `receivers` VARCHAR(255) NOT null ,\n                            `status` VARCHAR(30) NOT NULL\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"automatic_del\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"automatic_del` (\n                            `item_id` int(11) NOT NULL,\n                            `del_enabled` tinyint(1) NOT NULL,\n                            `del_type` tinyint(1) NOT NULL,\n                            `del_value` varchar(35) NOT NULL\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"items_edition\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"items_edition` (\n                            `item_id` int(11) NOT NULL,\n                            `user_id` int(12) NOT NULL,\n                            `timestamp` varchar(50) NOT NULL\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"categories\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"categories` (\n                            `id` int(12) NOT NULL AUTO_INCREMENT,\n                            `parent_id` int(12) NOT NULL,\n                            `title` varchar(255) NOT NULL,\n                            `level` int(2) NOT NULL,\n                            `description` text NULL,\n                            `type` varchar(50) NULL default '',\n                            `order` int(12) NOT NULL default '0',\n                            `encrypted_data` tinyint(1) NOT NULL default '1',\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"categories_items\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"categories_items` (\n                            `id` int(12) NOT NULL AUTO_INCREMENT,\n                            `field_id` int(11) NOT NULL,\n                            `item_id` int(11) NOT NULL,\n                            `data` text NOT NULL,\n                            `data_iv` text NOT NULL,\n                            `encryption_type` VARCHAR(20) NOT NULL DEFAULT 'not_set',\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"categories_folders\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"categories_folders` (\n                            `id_category` int(12) NOT NULL,\n                            `id_folder` int(12) NOT NULL\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"api\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"api` (\n                            `id` int(20) NOT NULL AUTO_INCREMENT,\n                            `type` varchar(15) NOT NULL,\n                            `label` varchar(255) NOT NULL,\n                            `value` varchar(255) NOT NULL,\n                            `timestamp` varchar(50) NOT NULL,\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"otv\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"otv` (\n                            `id` int(10) NOT NULL AUTO_INCREMENT,\n                            `timestamp` text NOT NULL,\n                            `code` varchar(100) NOT NULL,\n                            `item_id` int(12) NOT NULL,\n                            `originator` int(12) NOT NULL,\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"suggestion\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"suggestion` (\n                            `id` tinyint(12) NOT NULL AUTO_INCREMENT,\n                            `label` varchar(255) NOT NULL,\n                            `pw` text NOT NULL,\n                            `pw_iv` text NOT NULL,\n                            `pw_len` int(5) NOT NULL,\n                            `description` text NOT NULL,\n                            `author_id` int(12) NOT NULL,\n                            `folder_id` int(12) NOT NULL,\n                            `comment` text NOT NULL,\n                            `suggestion_type` varchar(10) NOT NULL default 'new',\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"export` (\n                            `id` int(12) NOT NULL,\n                            `label` varchar(255) NOT NULL,\n                            `login` varchar(100) NOT NULL,\n                            `description` text NOT NULL,\n                            `pw` text NOT NULL,\n                            `path` varchar(500) NOT NULL,\n                            `email` varchar(500) NOT NULL default 'none',\n                            `url` varchar(500) NOT NULL default 'none',\n                            `kbs` varchar(500) NOT NULL default 'none',\n                            `tags` varchar(500) NOT NULL default 'none'\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"tokens\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"tokens` (\n                            `id` int(12) NOT NULL AUTO_INCREMENT,\n                            `user_id` int(12) NOT NULL,\n                            `token` varchar(255) NOT NULL,\n                            `reason` varchar(255) NOT NULL,\n                            `creation_timestamp` varchar(50) NOT NULL,\n                            `end_timestamp` varchar(50) NOT NULL,\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"items_change\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"items_change` (\n                            `id` int(12) NOT NULL AUTO_INCREMENT,\n                            `item_id` int(12) NOT NULL,\n                            `label` varchar(255) NOT NULL DEFAULT 'none',\n                            `pw` text NOT NULL,\n                            `login` varchar(255) NOT NULL DEFAULT 'none',\n                            `email` varchar(255) NOT NULL DEFAULT 'none',\n                            `url` varchar(255) NOT NULL DEFAULT 'none',\n                            `description` text NOT NULL,\n                            `comment` text NOT NULL,\n                            `folder_id` tinyint(12) NOT NULL,\n                            `user_id` int(12) NOT NULL,\n                            `timestamp` varchar(50) NOT NULL DEFAULT 'none',\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    }\n                }\n                // answer back\n                if ($mysqli_result) {\n                    echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\", \"task\" : \"'.$task.'\", \"activity\" : \"'.$activity.'\"}]';\n                } else {\n                    echo '[{\"error\" : \"'.addslashes(str_replace(array(\"'\", \"\\n\", \"\\r\"), array('\"', '', ''), mysqli_error())).'\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\", \"table\" : \"'.$task.'\"}]';\n                }\n            } else {\n                echo '[{\"error\" : \"'.addslashes(str_replace(array(\"'\", \"\\n\", \"\\r\"), array('\"', '', ''), mysqli_connect_error())).'\", \"result\" : \"Failed\", \"multiple\" : \"\"}]';\n            }\n\n            mysqli_close($dbTmp);\n            // Destroy session without writing to disk\n            define('NODESTROY_SESSION', 'true');\n            session_destroy();\n            break;\n\n        case \"step_6\":\n            //decrypt\n            require_once 'libs/aesctr.php'; // AES Counter Mode implementation\n            $activity = Encryption\\Crypt\\aesctr::decrypt($post_activity, \"cpm\", 128);\n            $data_sent = Encryption\\Crypt\\aesctr::decrypt($post_data, \"cpm\", 128);\n            $data_sent = json_decode($data_sent, true);\n            $task = Encryption\\Crypt\\aesctr::decrypt($post_task, \"cpm\", 128);\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_db, \"cpm\", 128);\n            $db = json_decode($json, true);\n\n            $dbTmp = mysqli_connect(\n                $db['db_host'],\n                $db['db_login'],\n                $db['db_pw'],\n                $db['db_bdd'],\n                $db['db_port']\n            );\n\n            // read install variables\n            $result = mysqli_query($dbTmp, \"SELECT * FROM `_install`\");\n            while ($row = $result->fetch_array()) {\n                $var[$row[0]] = $row[1];\n            }\n\n            // launch\n            if (empty($var['sk_path'])) {\n                $skFile = $var['abspath'].'/includes/sk.php';\n                $securePath = $var['abspath'];\n            } else {\n                //ensure $var['sk_path'] has no trailing slash\n                $var['sk_path'] = rtrim($var['sk_path'], '/\\\\');\n                $skFile = $var['sk_path'].'/sk.php';\n                $securePath = $var['sk_path'];\n            }\n\n            $events = \"\";\n\n            if ($activity === \"file\") {\n                if ($task === \"settings.php\") {\n                    // first is to create teampass-seckey.txt\n                    // 0- check if exists\n                    $filename_seckey = $securePath.\"/teampass-seckey.txt\";\n\n                    if (file_exists($filename_seckey)) {\n                        if (!copy($filename_seckey, $filename_seckey.'.'.date(\"Y_m_d\", mktime(0, 0, 0, date('m'), date('d'), date('y'))))) {\n                            echo '[{\"error\" : \"File `$filename_seckey` already exists and cannot be renamed. Please do it by yourself and click on button Launch.\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                            break;\n                        } else {\n                            unlink($filename);\n                        }\n                    }\n\n                    // 1- generate saltkey\n                    require_once '../includes/libraries/Encryption/Encryption/Crypto.php';\n                    require_once '../includes/libraries/Encryption/Encryption/Encoding.php';\n                    require_once '../includes/libraries/Encryption/Encryption/DerivedKeys.php';\n                    require_once '../includes/libraries/Encryption/Encryption/Key.php';\n                    require_once '../includes/libraries/Encryption/Encryption/KeyOrPassword.php';\n                    require_once '../includes/libraries/Encryption/Encryption/File.php';\n                    require_once '../includes/libraries/Encryption/Encryption/RuntimeTests.php';\n                    require_once '../includes/libraries/Encryption/Encryption/KeyProtectedByPassword.php';\n                    require_once '../includes/libraries/Encryption/Encryption/Core.php';\n\n                    $key = \\Defuse\\Crypto\\Key::createNewRandomKey();\n                    $new_salt = $key->saveToAsciiSafeString();\n\n                    // 2- store key in file\n                    file_put_contents(\n                        $filename_seckey,\n                        $new_salt\n                    );\n\n                    // Now create settings file\n                    $filename = \"../includes/config/settings.php\";\n\n                    if (file_exists($filename)) {\n                        if (!copy($filename, $filename.'.'.date(\"Y_m_d\", mktime(0, 0, 0, date('m'), date('d'), date('y'))))) {\n                            echo '[{\"error\" : \"Setting.php file already exists and cannot be renamed. Please do it by yourself and click on button Launch.\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                            break;\n                        } else {\n                            unlink($filename);\n                        }\n                    }\n\n                    // Encrypt the DB password\n                    $encrypted_text = encryptFollowingDefuse(\n                        $db['db_pw'],\n                        $new_salt\n                    )['string'];\n\n                    // Open and write Settings file\n                    $file_handler = fopen($filename, 'w');\n                    $result = fwrite(\n                        $file_handler,\n                        utf8_encode(\n                            \"<?php\nglobal \\$lang, \\$txt, \\$pathTeampas, \\$urlTeampass, \\$pwComplexity, \\$mngPages;\nglobal \\$server, \\$user, \\$pass, \\$database, \\$pre, \\$db, \\$port, \\$encoding;\n\n### DATABASE connexion parameters ###\n\\$server = \\\"\".$db['db_host'].\"\\\";\n\\$user = \\\"\".$db['db_login'].\"\\\";\n\\$pass = \\\"\".str_replace(\"$\", \"\\\\$\", $encrypted_text).\"\\\";\n\\$database = \\\"\".$db['db_bdd'].\"\\\";\n\\$pre = \\\"\".$var['tbl_prefix'].\"\\\";\n\\$port = \".$db['db_port'].\";\n\\$encoding = \\\"\".$session_db_encoding.\"\\\";\n\n@date_default_timezone_set(\\$_SESSION['settings']['timezone']);\n@define('SECUREPATH', '\".$securePath.\"');\nif (file_exists(\\\"\".str_replace('\\\\', '/', $skFile).\"\\\")) {\n    require_once \\\"\".str_replace('\\\\', '/', $skFile).\"\\\";\n}\n\"\n                        )\n                    );\n                    fclose($file_handler);\n                    if ($result === false) {\n                        echo '[{\"error\" : \"Setting.php file could not be created. Please check the path and the rights\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                    } else {\n                        echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                    }\n                } elseif ($task === \"sk.php\") {\n//Create sk.php file\n                    if (file_exists($skFile)) {\n                        if (!copy($skFile, $skFile.'.'.date(\"Y_m_d\", mktime(0, 0, 0, date('m'), date('d'), date('y'))))) {\n                            echo '[{\"error\" : \"sk.php file already exists and cannot be renamed. Please do it by yourself and click on button Launch.\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                            break;\n                        } else {\n                            unlink($skFile);\n                        }\n                    }\n                    $file_handler = fopen($skFile, 'w');\n\n                    $result = fwrite(\n                        $file_handler,\n                        utf8_encode(\n                            \"<?php\n@define('COST', '13'); // Don't change this.\n@define('AKEY', '');\n@define('IKEY', '');\n@define('SKEY', '');\n@define('HOST', '');\n?>\"\n                        )\n                    );\n                    fclose($file_handler);\n\n                    // finalize\n                    if ($result === false) {\n                        echo '[{\"error\" : \"sk.php file could not be created. Please check the path and the rights.\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                    } else {\n                        echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                    }\n                } elseif ($task === \"security\") {\n                    # Sort out the file permissions\n\n                    // is server Windows or Linux?\n                    if (strtoupper(substr(PHP_OS, 0, 3)) != 'WIN') {\n                        // Change directory permissions\n                        $result = chmodRecursive($session_abspath, 0770, 0740);\n                        if ($result) {\n                            $result = chmodRecursive($session_abspath.'/files', 0770, 0770);\n                        }\n                        if ($result) {\n                            $result = chmodRecursive($session_abspath.'/upload', 0770, 0770);\n                        }\n                    }\n\n                    if ($result === false) {\n                        echo '[{\"error\" : \"Cannot change directory permissions - please fix manually\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                    } else {\n                        echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                    }\n                } elseif ($task === \"csrfp-token\") {\n                    // update CSRFP TOKEN\n                    $csrfp_file_sample = \"../includes/libraries/csrfp/libs/csrfp.config.sample.php\";\n                    $csrfp_file = \"../includes/libraries/csrfp/libs/csrfp.config.php\";\n                    if (file_exists($csrfp_file)) {\n                        if (!copy($csrfp_file, $csrfp_file.'.'.date(\"Y_m_d\", mktime(0, 0, 0, date('m'), date('d'), date('y'))))) {\n                            echo '[{\"error\" : \"csrfp.config.php file already exists and cannot be renamed. Please do it by yourself and click on button Launch.\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                            break;\n                        } else {\n                            $events .= \"The file $csrfp_file already exist. A copy has been created.<br />\";\n                        }\n                    }\n                    unlink($csrfp_file); // delete existing csrfp.config file\n                    copy($csrfp_file_sample, $csrfp_file); // make a copy of csrfp.config.sample file\n                    $data = file_get_contents($csrfp_file);\n                    $newdata = str_replace('\"CSRFP_TOKEN\" => \"\"', '\"CSRFP_TOKEN\" => \"'.bin2hex(openssl_random_pseudo_bytes(25)).'\"', $data);\n                    $jsUrl = $data_sent['url_path'].'/includes/libraries/csrfp/js/csrfprotector.js';\n                    $newdata = str_replace('\"jsUrl\" => \"\"', '\"jsUrl\" => \"'.$jsUrl.'\"', $newdata);\n                    file_put_contents(\"../includes/libraries/csrfp/libs/csrfp.config.php\", $newdata);\n\n                    echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                }\n            } elseif ($activity === \"install\") {\n                if ($task === \"cleanup\") {\n                    // Mark a tag to force Install stuff (folders, files and table) to be cleanup while first login\n                    mysqli_query($dbTmp, \"INSERT INTO `\".$var['tbl_prefix'].\"misc` (`type`, `intitule`, `valeur`) VALUES ('install', 'clear_install_folder', 'true')\");\n\n                    echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                }\n            }\n\n            mysqli_close($dbTmp);\n            // Destroy session without writing to disk\n            define('NODESTROY_SESSION', 'true');\n            session_destroy();\n            break;\n    }\n}\n", "<?php\n/**\n * @file          upgrade.ajax.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\n\n/*\n** Upgrade script for release 2.1.27\n*/\nrequire_once('../sources/SecureHandler.php');\nsession_start();\nerror_reporting(E_ERROR | E_PARSE);\n$_SESSION['db_encoding'] = \"utf8\";\n$_SESSION['CPM'] = 1;\n\n\n//include librairies\nrequire_once '../includes/language/english.php';\nrequire_once '../includes/config/include.php';\nrequire_once '../includes/config/settings.php';\nrequire_once '../sources/main.functions.php';\nrequire_once '../includes/libraries/Tree/NestedTree/NestedTree.php';\n\n$_SESSION['settings']['loaded'] = \"\";\n//define pbkdf2 iteration count\n@define('ITCOUNT', '2072');\n$return_error = \"\";\n$res = \"\";\n\n\n//Build tree\n$tree = new Tree\\NestedTree\\NestedTree(\n    $pre.'nested_tree',\n    'id',\n    'parent_id',\n    'title'\n);\n\n\n// Prepare POST variables\n$post_no_maintenance_mode = filter_input(INPUT_POST, 'no_maintenance_mode', FILTER_SANITIZE_NUMBER_INT);\n$post_index = filter_input(INPUT_POST, 'index', FILTER_SANITIZE_NUMBER_INT);\n$post_multiple = filter_input(INPUT_POST, 'multiple', FILTER_SANITIZE_STRING);\n\n// DataBase\n// Test DB connexion\n$pass = defuse_return_decrypted($pass);\nif (mysqli_connect(\n    $server,\n    $user,\n    $pass,\n    $database,\n    $port\n)\n) {\n    $db_link = mysqli_connect(\n        $server,\n        $user,\n        $pass,\n        $database,\n        $port\n    );\n} else {\n    $res = \"Impossible to get connected to server. Error is: \".addslashes(mysqli_connect_error());\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"Impossible to get connected to server. Error is: '.addslashes(mysqli_connect_error()).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n// Load libraries\nrequire_once '../includes/libraries/protect/SuperGlobal/SuperGlobal.php';\n$superGlobal = new protect\\SuperGlobal\\SuperGlobal();\n\n// Set Session\n$superGlobal->put(\"db_encoding\", \"utf8\", \"SESSION\");\n$_SESSION['settings']['loaded'] = \"\";\n$superGlobal->put(\"fullurl\", $post_fullurl, \"SESSION\");\n$superGlobal->put(\"abspath\", $abspath, \"SESSION\");\n\n// Get Sessions\n$session_tp_defuse_installed = $superGlobal->get(\"tp_defuse_installed\", \"SESSION\");\n\n/**\n * Function permits to get the value from a line\n * @param  string $val [description]\n * @return string      [description]\n */\nfunction getSettingValue($val)\n{\n    $val = trim(strstr($val, \"=\"));\n    return trim(str_replace('\"', '', substr($val, 1, strpos($val, \";\") - 1)));\n}\n\n/**\n * Function permits to check if a column exists, and if not to add it\n * @param string $dbname     [description]\n * @param string $column     [description]\n * @param string $columnAttr [description]\n */\nfunction addColumnIfNotExist($dbname, $column, $columnAttr = \"VARCHAR(255) NULL\")\n{\n    global $db_link;\n    $exists = false;\n    $columns = mysqli_query($db_link, \"show columns from $dbname\");\n    while ($col = mysqli_fetch_assoc($columns)) {\n        if ($col['Field'] == $column) {\n            $exists = true;\n            return true;\n        }\n    }\n    if (!$exists) {\n        return mysqli_query($db_link, \"ALTER TABLE `$dbname` ADD `$column`  $columnAttr\");\n    }\n\n    return false;\n}\n\n/**\n * [cleanFields description]\n * @param  [type] $txt [description]\n * @return [type]      [description]\n */\nfunction cleanFields($txt)\n{\n    $tmp = str_replace(\",\", \";\", trim($txt));\n    if (empty($tmp)) {\n        return $tmp;\n    }\n    if ($tmp === \";\") {\n        return \"\";\n    }\n    if (strpos($tmp, ';') === 0) {\n        $tmp = substr($tmp, 1);\n    }\n    if (substr($tmp, -1) !== \";\") {\n        $tmp = $tmp.\";\";\n    }\n    return $tmp;\n}\n\n// 2.1.27 introduce new encryption protocol with DEFUSE library.\n// Now evaluate if current instance has already this version\n$tmp = mysqli_fetch_row(mysqli_query($db_link, \"SELECT valeur FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'teampass_version'\"));\nif (count($tmp[0]) === 0 || empty($tmp[0])) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'teampass_version', '\".$SETTINGS_EXT['version'].\"')\"\n    );\n} else {\n    mysqli_query(\n        $db_link,\n        \"UPDATE `\".$pre.\"misc`\n        SET `valeur` = '\".$SETTINGS_EXT['version'].\"'\n        WHERE intitule = 'teampass_version' AND type = 'admin'\"\n    );\n}\n\n// add new admin setting \"migration_to_2127\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'migration_to_2127'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'migration_to_2127', '0')\"\n    );\n}\n\n\n// check if library defuse already on-going here\n// if yes, then don't execute re-encryption\nif (isset($session_tp_defuse_installed) !== true) {\n    $superGlobal->put(\"tp_defuse_installed\", false, \"SESSION\");\n    $columns = mysqli_query($db_link, \"show columns from \".$pre.\"items\");\n    while ($c = mysqli_fetch_assoc($columns)) {\n        if ($c['Field'] === \"encryption_type\") {\n            $superGlobal->put(\"tp_defuse_installed\", true, \"SESSION\");\n        }\n    }\n}\n\n// alter table Items\nmysqli_query($db_link, \"ALTER TABLE `\".$pre.\"items` MODIFY pw_len INT(5) NOT NULL DEFAULT '0'\");\n\n// alter table misc to add an index\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"misc` ADD `id` INT(12) NOT NULL AUTO_INCREMENT FIRST, ADD PRIMARY KEY (`id`)\"\n);\n\n// alter table misc to add an index\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"log_items` ADD `increment_id` INT(12) NOT NULL AUTO_INCREMENT FIRST, ADD PRIMARY KEY (`increment_id`)\"\n);\n\n// add field agses-usercardid to Users table\n$res = addColumnIfNotExist(\n    $pre.\"users\",\n    \"agses-usercardid\",\n    \"VARCHAR(12) NOT NULL DEFAULT '0'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field agses-usercardid to table Users! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n\n// add field encrypted_data to Categories table\n$res = addColumnIfNotExist(\n    $pre.\"categories\",\n    \"encrypted_data\",\n    \"TINYINT(1) NOT NULL DEFAULT '1'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field encrypted_data to table categories! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n\n// alter table USERS - user_language\nmysqli_query($db_link, \"ALTER TABLE `\".$pre.\"users` MODIFY user_language VARCHAR(50) NOT NULL DEFAULT '0'\");\n\n// alter table USERS - just ensure correct naming of IsAdministratedByRole\nmysqli_query($db_link, \"ALTER TABLE `\".$pre.\"users` CHANGE IsAdministratedByRole isAdministratedByRole tinyint(5) NOT NULL DEFAULT '0'\");\n\n// alter table OTV\nmysqli_query($db_link, \"ALTER TABLE `\".$pre.\"otv` CHANGE originator originator int(12) NOT NULL DEFAULT '0'\");\n\n// do clean of users table\n$fieldsToUpdate = ['groupes_visibles', 'fonction_id', 'groupes_interdits'];\n$result = mysqli_query($db_link, \"SELECT id, groupes_visibles, fonction_id, groupes_interdits FROM `\".$pre.\"users`\");\nwhile ($row = mysqli_fetch_assoc($result)) {\n    // check if field contains , instead of ;\n    foreach ($fieldsToUpdate as $field) {\n        $tmp = cleanFields($row[$field]);\n        if ($tmp !== $row[$field]) {\n            mysqli_query(\n                $db_link,\n                \"UPDATE `\".$pre.\"users`\n                SET `\".$field.\"` = '\".$tmp.\"'\n                WHERE id = '\".$row['id'].\"'\"\n            );\n        }\n    }\n}\nmysqli_free_result($result);\n\n\n// alter table KB_ITEMS\nmysqli_query($db_link, \"ALTER TABLE `\".$pre.\"kb_items` CHANGE `kb_id` `kb_id` INT(12) NOT NULL\");\nmysqli_query($db_link, \"ALTER TABLE `\".$pre.\"kb_items` CHANGE `item_id` `item_id` INT(12) NOT NULL\");\n\n\n// add field encrypted_data to CATEGORIES table\n$res = addColumnIfNotExist(\n    $pre.\"categories\",\n    \"encrypted_data\",\n    \"TINYINT(1) NOT NULL DEFAULT '1'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field encrypted_data to table CATEGORIES! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\nmysqli_query(\n    $db_link,\n    \"UPDATE `\".$pre.\"misc`\n    SET `valeur` = 'maintenance_mode'\n    WHERE type = 'admin' AND intitule = '\".$post_no_maintenance_mode.\"'\"\n);\n\n\n// add field encryption_type to ITEMS table\n$res = addColumnIfNotExist(\n    $pre.\"items\",\n    \"encryption_type\",\n    \"VARCHAR(20) NOT NULL DEFAULT 'not_set'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field encryption_type to table ITEMS! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n\n// add field encryption_type to categories_items table\n$res = addColumnIfNotExist(\n    $pre.\"categories_items\",\n    \"encryption_type\",\n    \"VARCHAR(20) NOT NULL DEFAULT 'not_set'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field encryption_type to table categories_items! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n\n// add field encryption_type to LOG_ITEMS table\n$res = addColumnIfNotExist(\n    $pre.\"log_items\",\n    \"encryption_type\",\n    \"VARCHAR(20) NOT NULL DEFAULT 'not_set'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field encryption_type to table LOG_ITEMS! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n\n// add field URL to CACHE table\n$res = addColumnIfNotExist(\n    $pre.\"cache\",\n    \"encryption_type\",\n    \"VARCHAR(500) NOT NULL DEFAULT '0'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field URL to table CACHE! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n\n// add field timestamp to CACHE table\n$res = addColumnIfNotExist(\n    $pre.\"cache\",\n    \"timestamp\",\n    \"VARCHAR(50) DEFAULT NULL DEFAULT '0'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field url to table CACHE! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n\n// add field url to CACHE table\n$res = addColumnIfNotExist(\n    $pre.\"cache\",\n    \"url\",\n    \"VARCHAR(500) DEFAULT NULL\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field timestamp to table CACHE! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n//-- generate new DEFUSE key\nif (!isset($session_tp_defuse_installed) || $session_tp_defuse_installed === false) {\n    $filename = \"../includes/config/settings.php\";\n    $settingsFile = file($filename);\n    while (list($key, $val) = each($settingsFile)) {\n        if (substr_count($val, 'require_once \"') > 0 && substr_count($val, 'sk.php') > 0) {\n            $superGlobal->put(\"sk_file\", substr($val, 14, strpos($val, '\";') - 14), \"SESSION\");\n            $session_sk_file = $superGlobal->get(\"sk_file\", \"SESSION\");\n        }\n    }\n\n    copy(\n        SECUREPATH.\"/teampass-seckey.txt\",\n        SECUREPATH.\"/teampass-seckey.txt\".'.'.date(\"Y_m_d\", mktime(0, 0, 0, date('m'), date('d'), date('y'))).\".\".time()\n    );\n    $superGlobal->put(\"tp_defuse_new_key\", true, \"SESSION\");\n    $new_salt = defuse_generate_key();\n    file_put_contents(\n        SECUREPATH.\"/teampass-seckey.txt\",\n        $new_salt\n    );\n    $superGlobal->put(\"new_salt\", $new_salt, \"SESSION\");\n\n    // update sk.php file\n    copy(\n        $session_sk_file,\n        $session_sk_file.'.'.date(\"Y_m_d\", mktime(0, 0, 0, date('m'), date('d'), date('y'))).\".\".time()\n    );\n    $data = file($session_sk_file); // reads an array of lines\n    function replace_a_line($data)\n    {\n        if (stristr($data, \"@define('SALT'\")) {\n            return \"\";\n        }\n        return $data;\n    }\n    $data = array_map('replace_a_line', $data);\n    file_put_contents($session_sk_file, implode('', $data));\n\n    //\n    //\n    //-- users need to perform re-encryption of their personal pwds\n    $result = mysqli_query(\n        $db_link,\n        \"SELECT valeur FROM `\".$pre.\"misc` WHERE type='admin' AND intitule='encryption_type'\"\n    );\n    $row = mysqli_fetch_assoc($result);\n    if ($row['valeur'] !== \"defuse\") {\n        $result = mysqli_query(\n            $db_link,\n            \"SELECT id FROM `\".$pre.\"users`\"\n        );\n        while ($row_user = mysqli_fetch_assoc($result)) {\n            $result_items = mysqli_query(\n                $db_link,\n                \"SELECT i.id AS item_id\n                FROM `\".$pre.\"nested_tree` AS n\n                INNER JOIN `\".$pre.\"items` AS i ON (i.id_tree = n.id)\n                WHERE n.title = \".$row_user['id']\n            );\n            if (mysqli_num_rows($result_items) > 0) {\n                mysqli_query(\n                    $db_link,\n                    \"UPDATE `\".$pre.\"users`\n                    SET `upgrade_needed` = '1'\n                    WHERE id = \".$row_user['id']\n                );\n            } else {\n                mysqli_query(\n                    $db_link,\n                    \"UPDATE `\".$pre.\"users`\n                    SET `upgrade_needed` = '0'\n                    WHERE id = \".$row_user['id']\n                );\n            }\n        }\n\n        mysqli_query(\n            $db_link,\n            \"UPDATE `\".$pre.\"misc`\n            SET `valeur` = 'defuse'\n            WHERE `type`='admin' AND `initule`='encryption_type'\"\n        );\n    }\n} else {\n    $_SESSION['tp_defuse_new_key'] = false;\n}\n//--\n\n\n// add field encrypted_psk to Users table\n$res = addColumnIfNotExist(\n    $pre.\"users\",\n    \"encrypted_psk\",\n    \"TEXT NOT NULL\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field encrypted_psk to table Users! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n\n// add new admin setting \"manager_move_item\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'manager_move_item'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'manager_move_item', '0')\"\n    );\n}\n\n// add new admin setting \"create_item_without_password\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'create_item_without_password'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'create_item_without_password', '0')\"\n    );\n}\n\n// add new admin setting \"send_statistics_items\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'send_statistics_items'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'send_statistics_items', 'stat_country;stat_users;stat_items;stat_items_shared;stat_folders;stat_folders_shared;stat_admins;stat_managers;stat_ro;stat_mysqlversion;stat_phpversion;stat_teampassversion;stat_languages;stat_kb;stat_suggestion;stat_customfields;stat_api;stat_2fa;stat_agses;stat_duo;stat_ldap;stat_syslog;stat_stricthttps;stat_fav;stat_pf;')\"\n    );\n}\n\n// add new admin setting \"send_stats_time\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'send_stats_time'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'send_stats_time', '\".(time() - 2592000).\"')\"\n    );\n}\n\n// add new admin setting \"agses_authentication_enabled\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'agses_authentication_enabled'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'agses_authentication_enabled', '0')\"\n    );\n}\n\n// add new admin setting \"timezone\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'timezone'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'timezone', 'UTC')\"\n    );\n}\n\n// add new language \"portuges_br\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"languages` WHERE name = 'portuguese_br'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"languages` (`name`, `label`, `code`, `flag`) VALUES ('portuguese_br', 'Portuguese_br', 'pr-bt', 'pr-bt.png')\"\n    );\n}\n\n\n// alter table USERS to add a new field \"ga_temporary_code\"\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"users` ADD `ga_temporary_code` VARCHAR(20) NOT NULL DEFAULT 'none' AFTER `ga`;\"\n);\n// alter table USERS to add a new field \"user_ip\"\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"users` ADD `user_ip` VARCHAR(60) NOT NULL DEFAULT 'none';\"\n);\n// alter table USERS to allow NULL on field \"email\"\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"users` CHANGE `email` `email` VARCHAR(300) NOT NULL DEFAULT 'none';\"\n);\n\n\n// alter table EXPORT to add a new fields\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"export` ADD `email` VARCHAR(500) NOT NULL DEFAULT 'none';\"\n);\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"export` ADD `url` VARCHAR(500) NOT NULL DEFAULT 'none';\"\n);\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"export` ADD `kbs` VARCHAR(500) NOT NULL DEFAULT 'none';\"\n);\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"export` ADD `tags` VARCHAR(500) NOT NULL DEFAULT 'none';\"\n);\n\n// alter table MISC\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"misc` ADD `id` INT(12) NOT NULL AUTO_INCREMENT FIRST, ADD PRIMARY KEY (`id`);\"\n);\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"misc` CHANGE valeur valeur VARCHAR(500) NOT NULL DEFAULT 'none'\"\n);\n\n// alter table ITEMS_CHANGE\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"items_change` CHANGE user_id user_id INT(12) NOT NULL;\"\n);\n\n// alter table ITEMS\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"items` CHANGE auto_update_pwd_next_date auto_update_pwd_next_date VARCHAR(100) NOT NULL DEFAULT '0';\"\n);\n\n\n// add new admin setting \"otv_is_enabled\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'otv_is_enabled'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'otv_is_enabled', '0')\"\n    );\n}\n\n\n// add new field for items_change\nmysqli_query(\n    $db_link,\n    \"CREATE TABLE IF NOT EXISTS `\".$pre.\"items_change` (\n    `id` int(12) NOT NULL AUTO_INCREMENT,\n    `item_id` int(12) NOT NULL,\n    `label` varchar(255) NOT NULL DEFAULT 'none',\n    `pw` text NOT NULL,\n    `login` varchar(255) NOT NULL DEFAULT 'none',\n    `email` varchar(255) NOT NULL DEFAULT 'none',\n    `url` varchar(255) NOT NULL DEFAULT 'none',\n    `description` text NOT NULL,\n    `comment` text NOT NULL,\n    `folder_id` tinyint(12) NOT NULL,\n    `user_id` tinyint(12) NOT NULL,\n    `timestamp` varchar(50) NOT NULL DEFAULT 'none',\n    PRIMARY KEY (`id`)\n    ) CHARSET=utf8;\"\n);\n\n\n\n// File encryption\n// add field status to FILE table\n$res = addColumnIfNotExist(\n    $pre.\"files\",\n    \"status\",\n    \"VARCHAR(50) NOT NULL DEFAULT '0'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field agses-usercardid to table Users! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n// fill in this new field with the current \"encryption-file\" status\n$tmp = mysqli_fetch_row(mysqli_query($db_link, \"SELECT valeur FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'enable_attachment_encryption'\"));\nif (!empty($tmp[0])) {\n    if ($tmp[0] === \"1\") {\n        $status = \"encrypted\";\n    } else {\n        $status = \"clear\";\n    }\n    mysqli_query($db_link, \"update `\".$pre.\"files` set status = '\".$status.\"' where 1 = 1\");\n}\n\n\n// add 2 generic users\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"users` WHERE id = '9999991' AND login = 'OTV'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"users` (`id`, `login`, `pw`, `groupes_visibles`, `derniers`, `key_tempo`, `last_pw_change`, `last_pw`, `admin`, `fonction_id`, `groupes_interdits`, `last_connexion`, `gestionnaire`, `email`, `favourites`, `latest_items`, `personal_folder`) VALUES ('9999991', 'OTV', '', '', '', '', '', '', '1', '', '', '', '0', '', '', '', '0')\"\n    );\n}\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"users` WHERE id = '9999991' AND login = 'OTV'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"users` (`id`, `login`, `pw`, `groupes_visibles`, `derniers`, `key_tempo`, `last_pw_change`, `last_pw`, `admin`, `fonction_id`, `groupes_interdits`, `last_connexion`, `gestionnaire`, `email`, `favourites`, `latest_items`, `personal_folder`) VALUES ('9999999', 'API', '', '', '', '', '', '', '1', '', '', '', '0', '', '', '', '0')\"\n    );\n}\n\n\n// Update favico to favicon\n$result = mysqli_query($db_link, \"SELECT valeur FROM `\".$pre.\"misc` WHERE intitule = 'cpassman_url' AND type = 'admin'\");\n$rows = mysqli_fetch_assoc($result);\nmysqli_free_result($result);\nmysqli_query(\n    $db_link,\n    \"UPDATE `\".$pre.\"misc`\n    SET `valeur` = '\".$rows['valeur'].\"/favicon.ico'\n    WHERE intitule = 'favicon' AND type = 'admin'\"\n);\n\n\n\n/*\n* Introduce new CONFIG file\n*/\n$tp_config_file = \"../includes/config/tp.config.php\";\nif (file_exists($tp_config_file)) {\n    if (!copy($tp_config_file, $tp_config_file.'.'.date(\"Y_m_d\", mktime(0, 0, 0, date('m'), date('d'), date('y'))))) {\n        echo '[{\"error\" : \"includes/config/tp.config.php file already exists and cannot be renamed. Please do it by yourself and click on button Launch.\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n        return false;\n    } else {\n        unlink($tp_config_file);\n    }\n}\n$file_handler = fopen($tp_config_file, 'w');\n$config_text = \"\";\n$any_settings = false;\n\n$result = mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin'\");\nwhile ($row = mysqli_fetch_assoc($result)) {\n    // append new setting in config file\n    $config_text .= \"\n    '\".$row['intitule'].\"' => '\".$row['valeur'].\"',\";\n    if ($any_settings === false) {\n        $any_settings = true;\n    }\n}\nmysqli_free_result($result);\n\n// write to config file\nif ($any_settings === true) {\n    $result = fwrite(\n        $file_handler,\n        utf8_encode(\n            \"<?php\nglobal \\$SETTINGS;\n\\$SETTINGS = array (\" . $config_text . \"            \n    );\"\n        )\n    );\n}\nfclose($file_handler);\n\n\n\n// Finished\necho '[{\"finish\":\"1\" , \"next\":\"\", \"error\":\"\"}]';\n", "<?php\n/**\n * @file          items.load.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\n\nif (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n    die('Hacking attempt...');\n}\n\n// Load config\nif (file_exists('../includes/config/tp.config.php')) {\n    require_once '../includes/config/tp.config.php';\n} elseif (file_exists('./includes/config/tp.config.php')) {\n    require_once './includes/config/tp.config.php';\n} else {\n    throw new Exception(\"Error file '/includes/config/tp.config.php' not exists\", 1);\n}\n\n$var['hidden_asterisk'] = '<i class=\"fa fa-eye fa-border fa-sm tip\" title=\"'.$LANG['show_password'].'\"></i>&nbsp;&nbsp;<i class=\"fa fa-asterisk\"></i>&nbsp;<i class=\"fa fa-asterisk\"></i>&nbsp;<i class=\"fa fa-asterisk\"></i>&nbsp;<i class=\"fa fa-asterisk\"></i>&nbsp;<i class=\"fa fa-asterisk\"></i>';\n\n// load csrfprotector\n$csrfp_config = include $SETTINGS['cpassman_dir'].'/includes/libraries/csrfp/libs/csrfp.config.php';\n?>\n\n<script type=\"text/javascript\">\n//<![CDATA[\n    var query_in_progress = 0;\n\n    $(document).on('focusin', function(e) {e.stopImmediatePropagation();});\n\n//  Part of Safari 6 OS X fix\n    //  clean up HTML for sending via JSON to PHP code\n    function clean_up_html_safari(input)\n    {\n        //  applies to Safari 6 on OS X only, so check for that\n        user_agent = navigator.userAgent;\n        if (/Mac OS X.+6\\.\\d\\.\\d\\sSafari/.test(user_agent))\n        {\n            // remove strange divs\n            input = input.replace(/<\\/*div.+>\\n/g, '');\n            /**/\n            //  remove other strange tags\n            allowed_tags = '<strong><em><strike><ol><li><ul><a><br>';\n            input = strip_tags(input, allowed_tags);\n\n            //  replace special characters\n            input = input.replace(/(\\r\\n|\\n|\\r)/gm, '<br>')\n                                                .replace(/\\t/g, '')\n                                                .replace(/\\f/g, '')\n                                                .replace(/\\v/g, '')\n                                                .replace(/\\r/g, '');\n        }\n        return input;\n    }/* */\n\n    function AddNewNode()\n    {\n        //Select first child node in tree\n        $('#2').click();\n        //Add new node to selected node\n        simpleTreeCollection.get(0).addNode(1,'A New Node')\n    }\n\n    function EditNode()\n    {\n        //Select first child node in tree\n        $('#2').click();\n        //Add new node to selected node\n        simpleTreeCollection.get(0).addNode(1,'A New Node')\n    }\n\n    function DeleteNode()\n    {\n        //Select first child node in tree\n        $('#2').click();\n        //Add new node to selected node\n        simpleTreeCollection.get(0).delNode()\n    }\n\n    //FUNCTION mask/unmask passwords characters\n    function ShowPassword(pw)\n    {\n        if ($(\"#selected_items\").val() == \"\") return;\n\n        if ($('#id_pw').html().indexOf(\"fa-asterisk\") != -1) {\n            itemLog(\"item_password_shown\");\n            $('#id_pw').text($('#hid_pw').val());\n        } else {\n            $('#id_pw').html('<?php echo $var[\"hidden_asterisk\"]; ?>');\n        }\n    }\n\n    $(\"#tabs-02\").on(\n        \"change\",\n        \"#pw1\",\n        function() {\n            $('#visible_pw').val($('#pw1').val());\n        }\n    );\n\n    function ShowPasswords_EditForm()\n    {\n        if ($('#edit_visible_pw').is(\":visible\")) {\n            $('#edit_visible_pw').addClass(\"hidden\");\n        } else {\n            $('#edit_visible_pw').show();\n        }\n    }\n\n    $(\"#edit_pw1\").keyup(function() {\n        $(\"#edit_visible_pw\").text( this.value );\n    });\n\n    $(\"#pw1\").keyup(function() {\n        $(\"#visible_pw\").text( this.value );\n    });\n\n\n\n    /**\n     * Open a dialogbox\n     * @access public\n     * @return void\n     **/\n    function OpenDialog(id, modal)\n    {\n        if ($(\"#selected_items\").val() == \"\") return;\n\n        if (modal == \"false\") {\n            $(\"#\"+id).dialog(\"option\", \"modal\", false);\n        } else {\n            $(\"#\"+id).dialog(\"option\", \"modal\", true);\n        }\n        $(\"#\"+id).dialog(\"open\");\n    }\n\n/*\n*\n*/\nfunction LoadTreeNode(node_id)\n{\n\n}\n\n//###########\n//## FUNCTION : Launch the listing of all items of one category\n//###########\nvar requestRunning = false;\nfunction ListerItems(groupe_id, restricted, start, stop_listing_current_folder)\n{\n    var me = $(this);\n    stop_listing_current_folder = stop_listing_current_folder || \"0\";\n\n    // case where we should stop listing the items\n    if ($(\"#items_listing_should_stop\").val() === \"1\") {\n        requestRunning = false;\n        $(\"#items_listing_should_stop\").val(\"0\");\n        return false;\n    }\n\n    if (stop_listing_current_folder === 1) {\n        me.data('requestRunning', false);\n        $(\"#new_listing_characteristics\").val(groupe_id+\",\"+restricted+\",\"+start+\",0\");\n    } else {\n        $(\"#new_listing_characteristics\").val(\"\");\n    }\n\n\n    // prevent launch of similar query in case of doubleclick\n    if (requestRunning === true) {\n        return false;\n    }\n    requestRunning = true;\n\n    $(\"#request_lastItem, #selected_items\").val(\"\");\n\n    if (groupe_id != undefined) {\n        //refreshTree(groupe_id);\n        if (query_in_progress != 0 && query_in_progress != groupe_id) {\n            request.abort();    //kill previous query if needed\n        }\n        query_in_progress = groupe_id;\n        //LoadingPage();\n        $(\"#items_list_loader\").removeClass(\"hidden\");\n        if (start == 0) {\n            //clean form\n            $('#id_label, #id_pw, #id_email, #id_url, #id_desc, #id_login, #id_info, #id_restricted_to, #id_files, #id_tags, #id_kbs, #item_extra_info, #item_viewed_x_times').html(\"\");\n            $(\"#items_list\").html(\"<ul class='liste_items 'id='full_items_list'></ul>\");\n        }\n        $(\"#items_list\").css(\"display\", \"\");\n\n        $(\"#hid_cat\").val(groupe_id);\n        if ($(\".tr_fields\") != undefined) $(\".tr_fields, .newItemCat, .editItemCat\").addClass(\"hidden\");\n\n        //Disable menu buttons\n        $(\"#button_quick_login_copy, #button_quick_pw_copy\").addClass(\"hidden\");\n\n        $(\"#items_path_var\").html('<i class=\"fa fa-folder-open-o\"></i>&nbsp;<?php echo addslashes($LANG[\"opening_folder\"]); ?>');\n\n        //ajax query\n        request = $.post(\"sources/items.queries.php\",\n            {\n                type        : \"lister_items_groupe\",\n                id          : groupe_id,\n                restricted  : restricted,\n                start       : start,\n                uniqueLoadData : $(\"#uniqueLoadData\").val(),\n                key         : \"<?php echo $_SESSION['key']; ?>\",\n                nb_items_to_display_once : $(\"#nb_items_to_display_once\").val()\n            },\n            function(data) {\n                if (data == \"Hacking attempt...\") {\n                    alert(\"Hacking attempt...\");\n                    return false;\n                }\n                //get data\n                data = prepareExchangedData(data, \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n\n                // reset doubleclick prevention\n                requestRunning = false;\n\n                // manage not allowed\n                if (data.error == \"not_allowed\") {\n                   $(\"#div_dialog_message_text\").html(data.error_text);\n                   $(\"#div_dialog_message\").dialog(\"open\");\n                   $(\"#items_path_var\").html('<i class=\"fa fa-folder-open-o\"></i>&nbsp;Error');\n                   $(\"#items_list_loader\").addClass(\"hidden\");\n                   return false;\n                }\n\n                // to be done only in 1st list load\n                if (data.list_to_be_continued === \"end\") {\n                    $(\"#pf_selected\").val(data.IsPersonalFolder);\n\n                    // display path of folders\n                    if (data.arborescence != undefined) {\n                        var path_maxlength = 420;\n                        if ($(\"#path_fontsize\").val() != \"\") $(\"#items_path_var\").css('font-size', $(\"#path_fontsize\").val());\n                        if (data.IsPersonalFolder === 0) {\n                            $(\"#items_path_var\").html('<i class=\"fa fa-folder-open-o\"></i>&nbsp;' + data.arborescence);\n                        } else {\n                            $(\"#items_path_var\").html('<i class=\"fa fa-folder-open-o\"></i>&nbsp;<?php echo addslashes($LANG['personal_folder']); ?>&nbsp;:&nbsp;' + data.arborescence);\n                        }\n                        var path_levels = data.arborescence.split('&nbsp;<i class=\"fa fa-caret-right\"></i>&nbsp;').length;\n                        if ($(\"#items_path_var\").width() > path_maxlength) {\n                            $(\"#path_fontsize\").val($(\"#items_path_var\").css('font-size'));\n                            // start reducing size of font\n                            $(\"#items_path_var\").css('font-size', parseInt($(\"#items_path_var\").css('font-size'))-1);\n                            if ($(\"#items_path_var\").width() > path_maxlength && path_levels < 2) {\n                                while ($(\"#items_path_var\").width() > path_maxlength) {\n                                    $(\"#items_path_var\").css('font-size', parseInt($(\"#items_path_var\").css('font-size')) - 1);\n                                }\n                            }\n\n                            if ($(\"#items_path_var\").width() > path_maxlength && path_levels >= 2) {\n                                // only take first and last\n                                var nb = 1;\n                                var totalPathLength = occupedWidth = 0;\n                                $(\".path_element\").each(function () {\n                                    totalPathLength += $(this).width();\n                                    if (nb != 1 && nb != (path_levels-1) && nb != path_levels) {\n                                        $(this).html(\"<span class='tip' title='\"+$(this).html()+\"'>...</span>\");\n                                    } else if (nb == path_levels) {\n                                        // next condition occurs if lasst folder name is too long\n                                        if (totalPathLength > path_maxlength) {\n                                            var lastTxt = $(this).html();\n                                            while ($(this).width() > (path_maxlength - occupedWidth)) {\n                                                lastTxt = lastTxt.slice(0, -1);\n                                                $(this).html(lastTxt);\n                                            }\n                                            $(this).html(lastTxt+\"...\");\n                                        }\n                                    }\n                                    occupedWidth += $(this).width()+15; // 15 pixels corresponds to the small right triangle\n                                    nb++;\n                                });\n                            }\n                        }\n                    } else {\n                        $(\"#items_path_var\").html('');\n                    }\n\n                    // store the categories to be displayed\n                    if (data.displayCategories !== undefined) {\n                        $(\"#display_categories\").val(data.displayCategories);\n                    }\n\n                    // store type of access on folder\n                    $(\"#access_level\").val(data.access_level);\n\n                    // warn about a required change of personal SK\n                    if ($(\"#personal_upgrade_needed\").val() == \"1\" && data.recherche_group_pf === 1) {\n                        $(\"#dialog_upgrade_personal_passwords\").dialog(\"open\");\n                    }\n\n                    $(\"#items_loading_progress\").remove();\n\n                    // show correct fodler in Tree\n                    $(\"#jstree\").jstree(\"deselect_all\");\n                    $('#jstree').jstree(\"select_node\", \"#li_\"+groupe_id);\n                } else {\n                    $(\"#uniqueLoadData\").val(data.uniqueLoadData);\n                    if ($(\"#items_loading_progress\").length == 0) {\n                        $(\"#items_list_loader\").after('<span id=\"items_loading_progress\">' + Math.round(data.next_start*100/data.counter_full, 0) + '%</span>');\n                    } else {\n                        $(\"#items_loading_progress\").html(Math.round(data.next_start*100/data.counter_full, 0) + '%');\n                    }\n                }\n\n\n                if (data.array_items == \"\" && data.items_count == \"0\") {\n                    $(\"#items_list\").html('<div style=\"text-align:center;margin-top:30px;\"><b><i class=\"fa fa-info-circle\"></i>&nbsp;<?php echo addslashes($LANG['no_item_to_display']); ?></b></div>');\n                }\n\n                if (data.error == \"is_pf_but_no_saltkey\") {\n                    //warn user about his saltkey\n                    $(\"#item_details_no_personal_saltkey\").show();\n                    $(\"#item_details_ok, #item_details_nok\").addClass(\"hidden\");\n\n                    $('#menu_button_add_item').prop('disabled', 'true');\n                    $(\"#items_list_loader, #div_loading\").addClass(\"hidden\");\n                } else if (data.error == \"not_authorized\" || data.access_level === \"\") {\n                    //warn user\n                    $(\"#hid_cat\").val(\"\");\n                    //$(\"#menu_button_copy_item, #menu_button_add_group, #menu_button_edit_group, #menu_button_del_group, #menu_button_add_item, #menu_button_edit_item, #menu_button_del_item, #menu_button_history, #menu_button_share, #menu_button_otv\").prop('disabled', 'true');\n                    $(\"#item_details_nok\").removeClass(\"hidden\");\n                    $(\"#item_details_ok, #item_details_no_personal_saltkey\").addClass(\"hidden\");\n                    $(\"#items_list_loader\").addClass(\"hidden\");\n                } else if (($(\"#user_is_read_only\").val() == 1 && data.recherche_group_pf == 0) || data.access_level == 1) {\n                    //readonly user\n                    $(\"#recherche_group_pf\").val(data.saltkey_is_required);\n                    $(\"#item_details_no_personal_saltkey, #item_details_nok\").addClass(\"hidden\");\n                    $(\"#item_details_ok, #items_list\").removeClass(\"hidden\");\n\n                    $(\"#more_items\").remove();\n\n                    // show items\n                    $(\"#full_items_list\").append(data.items_html);\n                    if (data.list_to_be_continued === \"yes\") {\n                        //set next start for query\n                        $(\"#query_next_start\").val(data.next_start);\n                    } else {\n                        $(\"#query_next_start\").val(data.list_to_be_continued);\n\n                        // display Categories if needed\n                        if ($(\".tr_fields\") !== undefined && data.displayCategories !== undefined && data.displayCategories !== \"\") {\n                            var liste = data.displayCategories.split(';');\n                            for (var i=0; i<liste.length; i++) {\n                                $(\".itemCatName_\"+liste[i]+\", #newItemCatName_\"+liste[i]+\", #editItemCatName_\"+liste[i]).show();\n                            }\n                        }\n                        if (data.saltkey_is_required == 1) {\n                            if ($(\".tr_fields\") != undefined) $(\".tr_fields\").addClass(\"hidden\");\n                        }\n                    }\n\n                    proceed_list_update(stop_listing_current_folder);\n                } else {\n                    $(\"#recherche_group_pf\").val(data.saltkey_is_required);\n                    //Display items\n                    $(\"#item_details_no_personal_saltkey, #item_details_nok\").addClass(\"hidden\");\n                    $(\"#item_details_ok, #items_list\").removeClass(\"hidden\");\n\n                    $('#complexite_groupe').val(data.folder_complexity);\n                    $('#bloquer_creation_complexite').val(data.bloquer_creation_complexite);\n                    $('#bloquer_modification_complexite').val(data.bloquer_modification_complexite);\n\n                    // show items\n                    $(\"#full_items_list\").append(data.items_html);\n\n                    if (data.list_to_be_continued === \"yes\") {\n                        //set next start for query\n                        $(\"#query_next_start\").val(data.next_start);\n                    } else {\n                        $(\"#query_next_start\").val(data.list_to_be_continued);\n\n                        // display Categories if needed\n                        if ($(\".tr_fields\") != undefined && data.displayCategories !== undefined && data.displayCategories != \"\") {\n                            var liste = data.displayCategories.split(';');\n                            for (var i=0; i<liste.length; i++) {\n                                $(\".itemCatName_\"+liste[i]+\", #newItemCatName_\"+liste[i]+\", #editItemCatName_\"+liste[i]).show();\n                            }\n                        }\n                        if (data.saltkey_is_required == 1) {\n                            if ($(\".tr_fields\") != undefined) $(\".tr_fields\").addClass(\"hidden\");\n                        }\n                    }\n\n                    //If no data then empty\n                    if (data.array_items != null) {\n                        $(\".item_draggable\").draggable({\n                            handle: '.grippy',\n                            cursor: \"move\",\n                            opacity: 0.4,\n                            appendTo: 'body',\n                            stop: function(event, ui) {\n                                $(this).removeClass(\"ui-state-highlight\");\n                            },\n                            start: function(event, ui) {\n                                $(this).addClass(\"ui-state-highlight\");\n                            },\n                            helper: function(event) {\n                                return $(\"<div class='ui-widget-header' id='drop_helper'>\"+\"<?php echo addslashes($LANG['drag_drop_helper']); ?>\"+\"</div>\");\n                            }\n                        });\n                        $(\".folder\").droppable({\n                            hoverClass: \"ui-state-error\",\n                            tolerance: 'pointer',\n                            drop: function(event, ui) {\n                                ui.draggable.addClass(\"hidden\");\n                                LoadingPage();\n                                //move item\n                                $.post(\n                                    \"sources/items.queries.php\",\n                                    {\n                                        type      : \"move_item\",\n                                        item_id   : ui.draggable.attr(\"id\"),\n                                        folder_id : $(this).attr(\"id\").substring(4),\n                                        key       : \"<?php echo $_SESSION['key']; ?>\"\n                                    },\n                                    function(data) {\n                                        //increment / decrement number of items in folders\n                                        $(\"#itcount_\"+data[0].from_folder).text(Math.floor($(\"#itcount_\"+data[0].from_folder).text())-1);\n                                        $(\"#itcount_\"+data[0].to_folder).text(Math.floor($(\"#itcount_\"+data[0].to_folder).text())+1);\n                                        $(\"#id_label, #item_viewed_x_times, #id_desc, #id_pw, #id_login, #id_email, #id_url, #id_files, #id_restricted_to, #id_tags, #id_kbs\").html(\"\");\n                                        LoadingPage();\n                                        displayMessage(\"<?php echo addslashes($LANG['alert_message_done']); ?>\");\n                                    },\n                                    \"json\"\n                               );\n                            }\n                        });\n                    }\n\n                    proceed_list_update(stop_listing_current_folder);\n                }\n            }\n        );\n    }\n}\n\nfunction pwGenerate(elem)\n{\n    if (elem != \"\") elem = elem+\"_\";\n    $(\"#\"+elem+\"pw1\").show().focus();\n\n    //show ajax image\n    $(\"#\"+elem+\"pw_wait\").removeClass(\"hidden\");\n\n    $.post(\n        \"sources/main.queries.php\",\n        {\n            type    : \"generate_a_password\",\n            size      : $(\"#\"+elem + 'pw_size').val(),\n            numerals      : $(\"#\"+elem + 'pw_numerics').prop(\"checked\"),\n            capitalize      : $(\"#\"+elem + 'pw_maj').prop(\"checked\"),\n            symbols      : $(\"#\"+elem + 'pw_symbols').prop(\"checked\"),\n            secure  : $(\"#\"+elem + 'pw_secure').prop(\"checked\"),\n            elem      : elem,\n            force      : \"false\"\n        },\n        function(data) {\n            data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n               if (data.error == \"true\") {\n                   $(\"#div_dialog_message_text\").html(data.error_msg);\n                   $(\"#div_dialog_message\").dialog(\"open\");\n               } else {\n                $(\"#\"+elem+\"visible_pw\").text(data.key);\n                   $(\"#\"+elem+\"pw1, #\"+elem+\"pw2\").val(data.key);\n                $(\"#\"+elem+\"pw1\").focus();\n               }\n            //$(\"#\"+elem+\"pw1\").show().blur();\n            $(\"#\"+elem+\"pw_wait\").addClass(\"hidden\");\n        }\n   );\n}\n\nfunction pwCopy(elem)\n{\n    if (elem != \"\") elem = elem+\"_\";\n    $(\"#\"+elem + 'pw2').val($(\"#\"+elem + 'pw1').val());\n}\n\nfunction catSelected(val)\n{\n    $(\"#hid_cat\").val(val);\n}\n\n/**\n* Get Item complexity\n*/\nfunction RecupComplexite(val, edit, context)\n{\n    context = context || \"\";    // make context optional\n\n    var funcReturned = null;\n    $.ajaxSetup({async: false});\n    $.post(\n        \"sources/items.queries.php\",\n        {\n            type    : \"get_complixity_level\",\n            groupe  : val,\n            context : context,\n            item_id : $(\"#selected_items\").val()\n        },\n        function(data) {\n            data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n            funcReturned = 1;\n            if (data.error == undefined || data.error == 0) {\n                $(\"#complexite_groupe\").val(data.val);\n                $(\"#selected_folder_is_personal\").val(data.personal);\n                if (edit == 1) {\n                    $(\"#edit_complex_attendue\").html(\"<b>\"+data.complexity+\"</b>\");\n                    $(\"#edit_afficher_visibilite\").html(\"<span class='fa fa-users'></span>&nbsp;<b>\"+data.visibility+\"</b>\");\n                } else {\n                    $(\"#complex_attendue\").html(\"<b>\"+data.complexity+\"</b>\");\n                    $(\"#afficher_visibilite\").html(\"<span class='fa fa-users'></span>&nbsp;<b>\"+data.visibility+\"</b>\");\n                }\n            } else if (data.error == \"no_edition_possible\") {\n                $(\"#div_dialog_message_text\").html(data.error_msg);\n                $(\"#div_dialog_message\").dialog(\"open\");\n                funcReturned = 0;\n            } else if (data.error == \"user_is_readonly\") {\n                displayMessage(data.message);\n                funcReturned = 0;\n            } else if (data.error == \"no_folder_creation_possible\" || data.error == \"no_folder_edition_possible\"  || data.error == \"delete_folder\") {\n                displayMessage('<i class=\"fa fa-warning\"></i>&nbsp;' + data.error_msg);\n                $(\"#div_loading\").addClass(\"hidden\");\n                funcReturned = 0;\n            } else {\n                $(\"#div_formulaire_edition_item\").dialog(\"close\");\n                $(\"#div_dialog_message_text\").html(data.error_msg);\n                $(\"#div_dialog_message\").dialog(\"open\");\n            }\n            $(\"#div_loading\").addClass(\"hidden\");\n        }\n   );\n    $.ajaxSetup({async: true});\n    return funcReturned;\n}\n\n/**\n* Check if Item has been changed since loaded\n*/\nfunction CheckIfItemChanged()\n{\n    var funcReturned = null;\n    $.ajaxSetup({async: false});\n    $.post(\n        \"sources/items.queries.php\",\n        {\n            type        : \"is_item_changed\",\n            timestamp   : $(\"#timestamp_item_displayed\").val(),\n            item_id     : $(\"#selected_items\").val()\n        },\n        function(data) {\n            data = $.parseJSON(data);\n            if (data.modified == 1) {\n                funcReturned = 1;\n            } else {\n                funcReturned = 0;\n            }\n        }\n   );\n    $.ajaxSetup({async: true});\n    return funcReturned;\n}\n\nfunction AjouterItem()\n{\n    $(\"#div_formulaire_saisi_info\").show().html(\"<?php echo \"<i class='fa fa-cog fa-spin fa-lg'></i>&nbsp;\".addslashes($LANG['please_wait']).\"...\"; ?>\");\n    LoadingPage();\n    $(\"#error_detected\").val('');   //Refresh error foolowup\n    var erreur = \"\";\n    var  reg=new RegExp(\"[.|;|:|!|=|+|-|*|/|#|\\\"|'|&|]\");\n\n    //Complete url format\n    var url = $(\"#url\").val();\n    if (url.substring(0,7) != \"http://\" && url!=\"\" && url.substring(0,8) != \"https://\" && url.substring(0,6) != \"ftp://\" && url.substring(0,6) != \"ssh://\") {\n        url = \"http://\"+url;\n    }\n\n    // do checks\n    if ($(\"#label\").val() == \"\") erreur = \"<?php echo addslashes($LANG['error_label']); ?>\";\n    else if ($(\"#pw1\").val() === \"\" && $(\"#create_item_without_password\").val() !== \"1\") erreur = \"<?php echo addslashes($LANG['error_pw']); ?>\";\n    else if ($(\"#categorie\").val() == \"na\") erreur = \"<?php echo addslashes($LANG['error_group']); ?>\";\n    else if ($(\"#pw1\").val() != $(\"#pw2\").val()) erreur = \"<?php echo addslashes($LANG['error_confirm']); ?>\";\n    else if ($(\"#enable_delete_after_consultation\").is(':checked') && (($(\"#times_before_deletion\").val() < 1 && $(\"#deletion_after_date\").val() == \"\") || ($(\"#times_before_deletion\").val() == \"\" && $(\"#deletion_after_date\").val() == \"\"))) erreur = \"<?php echo addslashes($LANG['error_times_before_deletion']); ?>\";\n    else if ($(\"#item_tags\").val() != \"\" && reg.test($(\"#item_tags\").val())) erreur = \"<?php echo addslashes($LANG['error_tags']); ?>\";\n    else if (($('#recherche_group_pf').val() === \"1\" || $('#selected_folder_is_personal').val() === \"1\") && $('#personal_sk_set').val() === \"0\") {\n        erreur = \"<?php echo addslashes($LANG['alert_message_personal_sk_missing']); ?>\";\n    } else{\n        //Check pw complexity level\n        if (\n            ($(\"#bloquer_creation_complexite\").val() == 0 && parseInt($(\"#mypassword_complex\").val()) >= parseInt($(\"#complexite_groupe\").val()))\n            ||\n            ($(\"#bloquer_creation_complexite\").val() == 1)\n            ||\n            ($('#recherche_group_pf').val() == 1 && $('#personal_sk_set').val() == 1)\n            ||\n            $(\"#create_item_without_password\").val() === \"1\"\n      ) {\n            //Manage restrictions\n            var restriction = restriction_role = \"\";\n            $(\"#restricted_to_list option:selected\").each(function () {\n                //check if it's a role\n                if ($(this).val().indexOf('role_') != -1) {\n                    restriction_role += $(this).val().substring(5) + \";\";\n                } else {\n                    restriction += $(this).val() + \";\";\n                }\n            });\n            if (restriction != \"\" && restriction.indexOf($('#form_user_id').val()) == \"-1\")\n                restriction = $('#form_user_id').val()+\";\"+restriction\n            if (restriction == \";\") restriction = \"\";\n\n            //Manage diffusion list\n            var diffusion = \"\";\n            $(\"#annonce_liste_destinataires option:selected\").each(function () {\n                diffusion += $(this).val() + \";\";\n            });\n            if (diffusion == \";\") diffusion = \"\";\n\n            //Manage description\n            if (CKEDITOR.instances && CKEDITOR.instances[\"edit_desc\"]) {\n                CKEDITOR.instances[\"edit_desc\"].destroy();\n            }\n            if (CKEDITOR.instances && CKEDITOR.instances[\"desc\"]) {\n                var description = sanitizeString(CKEDITOR.instances[\"desc\"].getData()).replace(/\\n/g, '<br />').replace(/\\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');\n            } else {\n                var description = sanitizeString($(\"#desc\").val()).replace(/\\n/g, '<br />').replace(/\\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');\n            }\n\n            // Sanitize description with Safari\n            description = clean_up_html_safari(description);\n\n            //Is PF\n            if ($('#selected_folder_is_personal').val() == 1 && $('#personal_sk_set').val() == 1) {\n                var is_pf = 1;\n            } else {\n                var is_pf = 0;\n            }\n\n            //To be deleted\n            if ($(\"#enable_delete_after_consultation\").is(':checked') && ($(\"#times_before_deletion\").val() >= 1 || $(\"#deletion_after_date\").val() != \"\")) {\n                if ($(\"#times_before_deletion\").val() >= 1) {\n                    var to_be_deleted = $(\"#times_before_deletion\").val();\n                } else if ($(\"#deletion_after_date\").val() != \"\") {\n                    var to_be_deleted = $(\"#deletion_after_date\").val();\n                }\n            } else {\n                var to_be_deleted = \"\";\n            }\n\n            // get item field values\n            var fields = \"\";\n            $('.item_field').each(function(i){\n                id = $(this).attr('id').split('_');\n                if (fields == \"\") fields = id[1] + '~~' + $(this).val() + '~~' + id[2];\n                else fields += '_|_' + id[1] + '~~' + $(this).val() + '~~' + id[2];\n            });\n\n            // check if a folder is selected\n            var selected_folder;\n            if ($('#categorie').val() === \"\" || $('#categorie').val() === null) {\n                selected_folder = $('#hid_cat').val();\n            } else {\n                selected_folder = $('#categorie').val();\n            }\n\n            //prepare data\n            var data = {\"pw\": sanitizeString($('#pw1').val()) , \"label\": sanitizeString($('#label').val()) ,\n                \"login\": sanitizeString($('#item_login').val()) , \"is_pf\": is_pf.toString() ,\n                \"description\": (description) , \"email\": $('#email').val() , \"url\": url , \"categorie\": selected_folder ,\n                \"restricted_to\": restriction , \"restricted_to_roles\": restriction_role ,\n                \"salt_key_set\": $('#personal_sk_set').val() , \"diffusion\": diffusion , \"id\": $('#id_item').val() ,\n                \"anyone_can_modify\": $('#anyone_can_modify:checked').val() , \"tags\": sanitizeString($('#item_tags').val()) ,\n                \"random_id_from_files\": $('#random_id').val() , \"to_be_deleted\": to_be_deleted ,\n                \"fields\": sanitizeString(fields) , \"complexity_level\": parseInt($(\"#mypassword_complex\").val())};\n\n            //Send query\n            $.post(\n                \"sources/items.queries.php\",\n                {\n                    type    : \"new_item\",\n                    data     : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key        : \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data) {\n                    //decrypt data\n                    try {\n                        data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                    } catch (e) {\n                        // error\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#request_ongoing\").val(\"\");\n                        $(\"#div_dialog_message_text\").html(\"An error appears. Answer from Server cannot be parsed!<br />Returned data:<br />\"+data);\n                        $(\"#div_dialog_message\").dialog(\"open\");\n\n                        return;\n                    }\n\n                    //Check errors\n                    if (data.error === \"item_exists\") {\n                        $(\"#div_formulaire_saisi\").dialog(\"open\");\n                        $(\"#new_show_error\").html('<?php echo addslashes($LANG['error_item_exists']); ?>');\n                        $(\"#new_show_error\").show();\n                        LoadingPage();\n                    } else if (data.error == \"ERR_KEY_NOT_CORRECT\") {\n                        $(\"#div_formulaire_saisi\").dialog(\"open\");\n                        $(\"#new_show_error\").html('Key verification for Query is not correct!');\n                        $(\"#new_show_error\").show();\n                        LoadingPage();\n                    } else if (data.error == \"ERR_FOLDER_NOT_ALLOWED\") {\n                        $(\"#div_formulaire_saisi\").dialog(\"open\");\n                        $(\"#new_show_error\").html('User not allowed to access this folder!');\n                        $(\"#new_show_error\").show();\n                        LoadingPage();\n                    } else if (data.error == \"ERR_PWD_TOO_LONG\") {\n                        $(\"#div_formulaire_saisi\").dialog(\"open\");\n                        $(\"#new_show_error\").html('<?php echo addslashes($LANG['error_pw_too_long']); ?>');\n                        $(\"#new_show_error\").show();\n                        LoadingPage();\n                    } else if (data.error == \"ERR_ENCRYPTION_NOT_CORRECT\") {\n                        $(\"#div_formulaire_saisi\").dialog(\"open\");\n                        $(\"#new_show_error\").html('Item password could not be correctly encrypted!');\n                        $(\"#new_show_error\").show();\n                        LoadingPage();\n                    } else if (data.error == \"ERR_PWD_EMPTY\") {\n                        $(\"#div_formulaire_saisi\").dialog(\"open\");\n                        $(\"#new_show_error\").html('Item password is empty!');\n                        $(\"#new_show_error\").show();\n                        LoadingPage();\n                    } else if (data.error == \"ERR_ENCRYPTION\") {\n                        $(\"#div_formulaire_saisi\").dialog(\"open\");\n                        $(\"#new_show_error\").html(data.msg);\n                        $(\"#new_show_error\").show();\n                        LoadingPage();\n                    } else if (data.new_id != \"\") {\n                        $(\"#new_show_error\").addClass(\"hidden\");\n\n                        //add new line directly in list of items\n                        $(\"#full_items_list\").append(data.new_entry);\n\n                        //Increment counter\n                        $(\"#itcount_\"+$(\"#hid_cat\").val()).text(Math.floor($(\"#itcount_\"+$(\"#hid_cat\").val()).text())+1);\n\n                        // prepare the display of the new item\n                        AfficherDetailsItem(data.new_id);\n\n                        // refresh list of items\n                        ListerItems($('#categorie').val(), \"\", 0)\n\n                        refreshTree($('#categorie').val());\n\n                        //empty form\n                        $(\"#label, #item_login, #email, #url, #pw1, #visible_pw, #pw2, #item_tags, #deletion_after_date, #times_before_deletion, #mypassword_complex\").val(\"\");\n                        CKEDITOR.instances[\"desc\"].setData(\"\");\n\n                        $(\"#item_tabs\").tabs({selected: 0});\n                        $('ul#full_items_list>li').tsort(\"\",{order:\"asc\",attr:\"name\"});\n                        $(\".fields, .item_field, #categorie, #random_id\").val(\"\");\n                        $(\".fields_div, #item_file_queue, #display_title, #visible_pw\").html(\"\");\n\n                        $(\"#div_formulaire_saisi\").dialog('close');\n                        $(\"#div_formulaire_saisi ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                    }\n                    $(\"#div_formulaire_saisi_info\").addClass(\"hidden\").html(\"\");\n                    $(\"#div_loading\").addClass(\"hidden\");\n                }\n           );\n        } else {\n            $('#new_show_error').html(\"<?php echo addslashes($LANG['error_complex_not_enought']); ?>\").show();\n            $(\"#div_formulaire_saisi ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n            $(\"#div_formulaire_saisi_info\").addClass(\"hidden\").html(\"\");\n        }\n    }\n    if (erreur != \"\") {\n        $('#new_show_error').html(erreur).show();\n        $(\"#div_formulaire_saisi_info\").addClass(\"hidden\").html(\"\");\n    }\n}\n\nfunction EditerItem()\n{\n    $(\"#div_formulaire_edition_item_info\").html(\"<?php echo \"<i class='fa fa-cog fa-spin fa-lg'></i>&nbsp;\".addslashes($LANG['please_wait']).\"...\"; ?>\").show();\n    $(\"#item_detail_zone_loader\").addClass(\"hidden\");\n    var erreur = \"\";\n    var  reg=new RegExp(\"[.|,|;|:|!|=|+|-|*|/|#|\\\"|'|&]\");\n\n    //Complete url format\n    var url = $(\"#edit_url\").val();\n    if (url.substring(0,7) != \"http://\" && url!=\"\" && url.substring(0,8) != \"https://\" && url.substring(0,6) != \"ftp://\" && url.substring(0,6) != \"ssh://\") {\n        url = \"http://\"+url;\n    }\n\n    // do checks\n    if ($('#edit_label').val() == \"\") erreur = \"<?php echo addslashes($LANG['error_label']); ?>\";\n    else if ($(\"#edit_pw1\").val() === \"\" && $(\"#create_item_without_password\").val() !== \"1\") erreur = \"<?php echo addslashes($LANG['error_pw']); ?>\";\n    else if ($(\"#edit_pw1\").val() != $(\"#edit_pw2\").val()) erreur = \"<?php echo addslashes($LANG['error_confirm']); ?>\";\n    else if ($(\"#edit_tags\").val() != \"\" && reg.test($(\"#edit_tags\").val())) erreur = \"<?php echo addslashes($LANG['error_tags']); ?>\";\n    else if ($(\"#edit_categorie option:selected\").val() == \"\" || typeof  $(\"#edit_categorie option:selected\").val() === \"undefined\")  erreur = \"<?php echo addslashes($LANG['error_no_selected_folder']); ?>\";\n    else{\n        //Check pw complexity level\n        if ((\n                $(\"#bloquer_modification_complexite\").val() == 0 &&\n                parseInt($(\"#edit_mypassword_complex\").val()) >= parseInt($(\"#complexite_groupe\").val())\n           )\n            ||\n            ($(\"#bloquer_modification_complexite\").val() == 1)\n            ||\n            ($('#recherche_group_pf').val() == 1 && $('#personal_sk_set').val() == 1)\n            ||\n            $(\"#create_item_without_password\").val() === \"1\"\n      ) {\n            LoadingPage();  //afficher image de chargement\n            var annonce = 0;\n            if ($('#edit_annonce').attr('checked')) annonce = 1;\n            $(\"#item_detail_zone_loader\").show();\n\n\n            //Manage restriction\n            var restriction = restriction_role = \"\";\n            $(\"#edit_restricted_to_list option:selected\").each(function () {\n                if ($(this).val().indexOf('role_') != -1) {\n                    restriction_role += $(this).val() + \";\";\n                } else {\n                    restriction += $(this).val() + \";\";\n                }\n            });\n            if (restriction != \"\" && restriction.indexOf($('#form_user_id').val()) == \"-1\")\n                restriction = $('#form_user_id').val()+\";\"+restriction\n            if (restriction == \";\") restriction = \"\";\n\n\n            //Manage diffusion list\n            var myselect = document.getElementById('edit_annonce_liste_destinataires');\n            var diffusion = \"\";\n            for (var loop=0; loop < myselect.options.length; loop++) {\n                if (myselect.options[loop].selected === true) diffusion = diffusion + myselect.options[loop].value + \";\";\n            }\n            if (diffusion == \";\") {\n                diffusion = \"\";\n            }\n\n            //Manage description\n            if (CKEDITOR.instances[\"edit_desc\"]) {\n                var description = sanitizeString(CKEDITOR.instances[\"edit_desc\"].getData()).replace(/\\n/g, '<br />').replace(/\\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');\n            } else {\n                var description = sanitizeString($(\"#edit_desc\").val()).replace(/\\n/g, '<br />').replace(/\\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');\n            }\n\n            // Sanitize description with Safari\n            description = clean_up_html_safari(description);\n\n            //Is PF\n            if ($('#recherche_group_pf').val() == 1 && $('#personal_sk_set').val() == 1) {\n                var is_pf = 1;\n            } else {\n                var is_pf = 0;\n            }\n\n          //To be deleted\n            if ($(\"#edit_enable_delete_after_consultation\").is(':checked')\n                && ($(\"#edit_times_before_deletion\").val() >= 1 || $(\"#edit_deletion_after_date\").val() != \"\")\n            ) {\n                if ($(\"#edit_times_before_deletion\").val() >= 1) {\n                    var to_be_deleted = $(\"#edit_times_before_deletion\").val();\n                    //var to_be_deleted_after_date = \"\";\n                } else if ($(\"#edit_deletion_after_date\").val() != \"\") {\n                    //var to_be_deleted = \"0\";\n                    var to_be_deleted = $(\"#edit_deletion_after_date\").val();\n                }\n            } else {\n                var to_be_deleted = \"\";\n                //var to_be_deleted_after_date = \"\";\n            }\n\n            // get item field values\n            var fields = \"\";\n            $('.edit_item_field').each(function(i){\n                id = $(this).attr('id').split('_');\n                if (fields == \"\") fields = id[2] + '~~' + $(this).val();\n                else fields += '_|_' + id[2] + '~~' + $(this).val();\n            });\n\n              //prepare data\n            var data = {\"pw\": sanitizeString($('#edit_pw1').val()) , \"label\": sanitizeString($('#edit_label').val()) ,\n                \"login\": sanitizeString($('#edit_item_login').val()) , \"is_pf\": is_pf ,\n                \"description\": description , \"email\": $('#edit_email').val() , \"url\": url ,\n                \"categorie\": $(\"#edit_categorie option:selected\").val() , \"restricted_to\": restriction ,\n                \"restricted_to_roles\": restriction_role , \"salt_key_set\": $('#personal_sk_set').val() ,\n                \"is_pf\": $('#recherche_group_pf').val() , \"annonce\": annonce , \"diffusion\": diffusion ,\n                \"id\": $('#id_item').val() , \"anyone_can_modify\": $('#edit_anyone_can_modify:checked').val() ,\n                \"tags\": sanitizeString($('#edit_tags').val()) , \"to_be_deleted\": to_be_deleted ,\n                \"fields\": sanitizeString(fields) , \"complexity_level\": parseInt($(\"#edit_mypassword_complex\").val())};\n\n            //send query\n            $.post(\n                \"sources/items.queries.php\",\n                {\n                    type    : \"update_item\",\n                    data      : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key        : \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data) {\n                    //decrypt data\n                    try {\n                        data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                    } catch (e) {\n                        // error\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#request_ongoing\").val(\"\");\n                        $(\"#div_dialog_message_text\")\n                            .html(\"An error appears. Answer from Server cannot be parsed!<br />Returned data:<br />\"+\n                            data);\n                        $(\"#div_dialog_message\").dialog(\"open\");\n                        return;\n                    }\n\n                    //check if format error\n                    if (data.error === \"ERR_JSON_FORMAT\") {\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#edit_show_error\")\n                            .html(data.error + ' ERROR (JSON is broken)!!!!!')\n                            .show();\n                    } else if (data.error === \"ERR_KEY_NOT_CORRECT\") {\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#edit_show_error\")\n                            .html('Key verification for Query is not correct!')\n                            .show();\n                        LoadingPage();\n                    }else if (data.error === \"ERR_ENCRYPTION_NOT_CORRECT\") {\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#edit_show_error\")\n                            .html('Item password could not be correctly encrypted!')\n                            .show();\n                        LoadingPage();\n                    } else if (data.error === \"ERR_PWD_TOO_LONG\") {\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#edit_show_error\")\n                            .html('<?php echo addslashes($LANG['error_pw_too_long']); ?>')\n                            .show();\n                        LoadingPage();\n                    } else if (data.error === \"ERR_NOT_ALLOWED_TO_EDIT\") {\n                        $(\"#div_formulaire_saisi\").dialog(\"open\");\n                        $(\"#new_show_error\")\n                            .html('User not allowed to edit this Item!')\n                            .show();\n                        LoadingPage();\n                    } else if (data.error !== \"\") {\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#edit_show_error\")\n                            .html('<?php echo addslashes($LANG['error_not_allowed_to']); ?>')\n                            .show();\n                        LoadingPage();\n                    } else {\n                        //refresh item in list\n                        $(\"#fileclass\"+data.id).text($('#edit_label').val());\n\n                        //Refresh form\n                        $(\"#id_label\").text($('#edit_label').val());\n                        //$(\"#id_pw\").text($('#edit_pw1').val());\n                        $(\"#id_email\").html($('#edit_email').val());\n                        $(\"#id_url\").html($('#edit_url').val().escapeHTML());\n                        $(\"#id_desc\").html(description);\n                        $(\"#id_login\").html($('#edit_item_login').val());\n                        $(\"#id_restricted_to\").html(data.list_of_restricted);\n                        $(\"#id_tags\").html(data.tags);\n                        $(\"#id_files\").html(unsanitizeString(data.files));\n                        $(\"#item_edit_list_files\").html(data.files_edit);\n                        $(\"#id_info\").html(unsanitizeString(data.history));\n                        $('#id_pw').html('<?php echo $var['hidden_asterisk']; ?>');\n\n                        //Refresh hidden data\n                        $(\"#hid_label\").val($('#edit_label').val());\n                        $(\"#hid_pw\").val($('#edit_pw1').val());\n                        $(\"#hid_email\").val($('#edit_email').val());\n                        $(\"#hid_url\").val($('#edit_url').val().escapeHTML());\n                        $(\"#hid_desc\").val(description);\n                        $(\"#hid_login\").val($('#edit_item_login').val());\n                        $(\"#hid_restricted_to\").val(restriction);\n                        $(\"#hid_restricted_to_roles\").val(restriction_role);\n                        $(\"#hid_tags\").val($('#edit_tags').val());\n                        $(\"#hid_files\").val(data.files);\n                        /*$(\"#id_categorie\").html(data.id_tree);\n                        $(\"#id_item\").html(data.id);*/\n\n                        // refresh fields\n                        if ($('.edit_item_field').val() != undefined) {\n                            $('.tr_fields').addClass(\"hidden\");\n                            $('.edit_item_field').each(function(i){\n                                id = $(this).attr('id').split('_');\n                                if ($(this).val() !== \"\") {\n                                    // copy data from form to Item Div\n                                    $('#id_field_' + id[2]).html($(this).val());\n                                    $('#hid_field_' + id[2] + '_' + id[3]).val($(this).val());\n                                    $('#cf_tr_' + id[2] + ', .editItemCatName_' + id[3] + ', #tr_catfield_' + id[3]).show()\n                                } else {\n                                    $('#hid_field_' + id[2] + '_' + id[3]).val('');\n                                }\n                                // clear form\n                                $(this).val(\"\");\n                            });\n                        }\n                        $(\"#edit_display_title, #edit_visible_pw\").html(\"\");\n\n                        //calling image lightbox when clicking on link\n                        $(\"a.image_dialog\").click(function(event) {\n                            event.preventDefault();\n                            PreviewImage($(this).attr(\"href\"),$(this).attr(\"title\"));\n                        });\n\n                        //Change title in \"last items list\"\n                        $(\"#last_items_\"+data.id).text($('#edit_label').val());\n\n                        //Clear upload queue\n                        $('#item_edit_file_queue').html('');\n                        //Select 1st tab\n                        $(\"#item_edit_tabs\").tabs({ selected: 0 });\n\n                        //if reload page is needed\n                        if (data.reload_page == \"1\") {\n                            //reload list\n                            ListerItems($('#hid_cat').val(), \"\", 0)\n                            //increment / decrement number of items in folders\n                            $(\"#itcount_\"+$('#hid_cat').val()).text(Math.floor($(\"#itcount_\"+$('#hid_cat').val()).text())-1);\n                            $(\"#itcount_\"+$('#edit_categorie').val()).text(Math.floor($(\"#itcount_\"+$('#edit_categorie').val()).text())+1);\n                        }\n\n                        // tags\n                        $(\".round-grey\").addClass(\"ui-state-highlight ui-corner-all\");\n\n                        //Prepare clipboard copies\n                        if ($('#edit_pw1').val() != \"\") {\n                            new Clipboard(\"#menu_button_copy_pw, #button_quick_pw_copy\", {\n                                text: function() {\n                                    return unsanitizeString($('#edit_pw1').val());\n                                }\n                            });\n\n                            $(\"#button_quick_pw_copy\").show();\n                        } else {\n                            $(\"#button_quick_pw_copy\").addClass(\"hidden\");\n                        }\n                        if ($('#edit_item_login').val() != \"\") {\n                            var clipboard_elogin = new Clipboard(\"#menu_button_copy_login, #button_quick_login_copy\", {\n                                text: function() {\n                                    return unsanitizeString($('#edit_item_login').val());\n                                }\n                            });\n                            $(\"#button_quick_login_copy\").show();\n                        } else {\n                            $(\"#button_quick_login_copy\").addClass(\"hidden\");\n                        }\n\n\n                        $(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                        //Close dialogbox\n                        $(\"#div_formulaire_edition_item\").dialog('close');\n                        $(\"#div_formulaire_edition_item ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                        //hide loader\n                        $(\"#div_loading\").addClass(\"hidden\");\n                    }\n                }\n           );\n\n           // statistic\n           /*$.post(\n                \"sources/main.queries.php\",\n                {\n                    type                : 'item_stat',\n                    id                  : $('#id_item').val(),\n                    stat_action                : \"item\"\n                },\n                function(data) {\n\n                }\n            );*/\n\n        } else {\n            $('#edit_show_error').html(\"<?php echo addslashes($LANG['error_complex_not_enought']); ?>\").show();\n            $(\"#div_formulaire_edition_item ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n            $(\"#div_formulaire_edition_item_info\").addClass(\"hidden\").html(\"\");\n        }\n    }\n\n    if (erreur != \"\") {\n        $('#edit_show_error').html(erreur).show();\n        $(\"#div_formulaire_edition_item_info\").addClass(\"hidden\").html(\"\");\n        $(\"#div_formulaire_edition_item ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n    }\n}\n\nfunction AddNewFolder()\n{\n    if ($(\"#new_rep_titre\").val() == \"\") {\n        $(\"#new_rep_show_error\").html(\"<?php echo addslashes($LANG['error_group_label']); ?>\").removeClass(\"hidden\");\n    } else if ($(\"#new_rep_groupe\").val() === \"\") {\n        $(\"#new_rep_show_error\").html(\"<?php echo addslashes($LANG['error_group_noparent']); ?>\").removeClass(\"hidden\");\n    } else if ($(\"#new_rep_complexite\").val() == \"\") {\n        $(\"#new_rep_show_error\").html(\"<?php echo addslashes($LANG['error_group_complex']); ?>\").removeClass(\"hidden\");\n    } else if (/^\\d+$/.test($(\"#new_rep_titre\").val())) {\n        // check if folder title contains only numbers\n        $(\"#new_rep_show_error\").html(\"<?php echo addslashes($LANG['error_only_numbers_in_folder_name']); ?>\").removeClass(\"hidden\");\n    } else if ($(\"#user_ongoing_action\").val() == \"\") {\n        $(\"#add_folder_loader\").removeClass(\"hidden\");\n        $(\"#user_ongoing_action\").val(\"true\");\n        $(\"#new_rep_show_error\").addClass(\"hidden\");\n        if ($(\"#new_rep_role\").val() == undefined) {\n            role_id = \"<?php echo $_SESSION['fonction_id']; ?>\";\n        } else {\n            role_id = $(\"#new_rep_role\").val();\n        }\n\n        //prepare data\n        var data = {\"title\": sanitizeString($('#new_rep_titre').val()),\n            \"complexity\": sanitizeString($('#new_rep_complexite').val()), \"is_pf\": $('#pf_selected').val(),\n            \"parent_id\": $(\"#new_rep_groupe option:selected\").val(), \"renewal_period\":\"0\"};\n\n        //send query\n        $.post(\n            \"sources/folders.queries.php\",\n            {\n                type   : \"add_folder\",\n                data   : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                key    : \"<?php echo $_SESSION['key']; ?>\"\n            },\n            function(data) {\n                $(\"#user_ongoing_action\").val(\"\");\n                //Check errors\n                if (data[0].error == \"error_group_exist\") {\n                    $(\"#new_rep_show_error\").html(\"<?php echo addslashes($LANG['error_group_exist']); ?>\").removeClass(\"hidden\");\n                } else if (data[0].error == \"error_html_codes\") {\n                    $(\"#new_rep_show_error\").html(\"<?php echo addslashes($LANG['error_html_codes']); ?>\").removeClass(\"hidden\");\n                } else if (data[0].error == \"error_title_only_with_numbers\") {\n                    $(\"#new_rep_show_error\").html(\"<?php echo addslashes($LANG['error_only_numbers_in_folder_name']); ?>\").removeClass(\"hidden\");\n                } else if (data[0].error != \"\") {\n                    $(\"#new_rep_show_error\").html(data[0].error).removeClass(\"hidden\");\n                } else {\n                    $(\"#new_rep_titre\").val(\"\");\n                    refreshTree(data[0].newid);\n                    $(\"#div_ajout_rep\").dialog(\"close\");\n                }\n                $(\"#add_folder_loader\").addClass(\"hidden\");\n            },\n            \"json\"\n           );\n    }\n}\n\n\nfunction SupprimerFolder()\n{\n    if ($(\"#delete_rep_groupe_validate\").is(':checked') === false) {\n        $(\"#del_rep_show_error\").html(\"<?php echo '<span class=\\\"fa fa-warning fa-lg\\\"></span>&nbsp;<\\span>'.addslashes($LANG['please_confirm']); ?>\").show(1).delay(2000).fadeOut(1000);\n    } else if ($(\"#delete_rep_groupe\").val() === \"0\") {\n        $(\"#del_rep_show_error\").html(\"<?php echo '<span class=\\\"fa fa-warning fa-lg\\\"></span>&nbsp;<\\span>'.addslashes($LANG['error_group']); ?>\").show(1).delay(2000).fadeOut(1000);\n    } else if ($(\"#delete_rep_groupe option:selected\").text() === \"<?php echo $_SESSION['login']; ?>\") {\n        $(\"#del_rep_show_error\").html(\"<?php echo '<span class=\\\"fa fa-warning fa-lg\\\"></span>&nbsp;<\\span>'.addslashes($LANG['error_not_allowed_to']); ?>\").show(1).delay(2000).fadeOut(1000);\n    } else {\n        $(\"#del_folder_loader\").show();\n        $.post(\n            \"sources/folders.queries.php\",\n            {\n                type    : \"delete_folder\",\n                id      : $(\"#delete_rep_groupe\").val(),\n                key        : \"<?php echo $_SESSION['key']; ?>\"\n            },\n            function(data) {\n                $(\"#del_folder_loader\").addClass(\"hidden\");\n\n                //decrypt data\n                try {\n                    data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                } catch (e) {\n                    // error\n                    $(\"#div_loading\").addClass(\"hidden\");\n                    $(\"#div_dialog_message_text\")\n                        .html(\"An error appears. Answer from Server cannot be parsed!<br />Returned data:<br />\"+\n                        data);\n                    $(\"#div_dialog_message\").dialog(\"open\");\n                    return;\n                }\n\n                if (data.error !== \"\") {\n                    if (data.error === \"ERR_SUB_FOLDERS_EXIST\") {\n                        $(\"#del_rep_show_error\").html(\"<?php echo '<span class=\\\"fa fa-warning fa-lg\\\"></span>&nbsp;<\\span>'.addslashes($LANG['error_cannot_delete_subfolders_exist']); ?>\").show(1).delay(3000).fadeOut(1000);\n\n                    } else if (data.error === \"ERR_FOLDER_NOT_ALLOWED\") {\n                        $(\"#del_rep_show_error\").html(\"<?php echo '<span class=\\\"fa fa-warning fa-lg\\\"></span>&nbsp;<\\span>'.addslashes($LANG['error_not_allowed_to']); ?>\").show(1).delay(3000).fadeOut(1000);\n                    }\n                } else {\n                    refreshTree(data.parent_id);\n                    ListerItems(data.parent_id,'', 0);\n                    $(\"#div_supprimer_rep\").dialog(\"close\");\n                }\n            }\n       );\n    }\n}\n\nfunction AfficherDetailsItem(id, salt_key_required, expired_item, restricted, display, open_edit, reload, id_tree)\n{\n    // If a request is already launched, then kill new.\n    if ($(\"#request_ongoing\").val() !== \"\") {\n        request.abort();\n        return;\n    }\n    id_tree = id_tree || \"\";\n    salt_key_required = salt_key_required || 0;\n    id_tree = id_tree || \"\";\n    id_tree = id_tree || \"\";\n\n    // Store status query running\n    $(\"#request_ongoing\").val(\"1\");\n\n    // If opening new item, reinit hidden fields\n    if ($(\"#request_lastItem\").val() != id) {\n        $(\"#request_lastItem\").val(\"\");\n        $(\"#item_editable\").val(\"\");\n    }\n\n    // Don't show details\n    if (display === \"no_display\") {\n        $(\"#item_details_nok\").removeClass(\"hidden\");\n        $(\"#item_details_ok\").addClass(\"hidden\");\n        $(\"#item_details_expired\").addClass(\"hidden\");\n        $(\"#item_details_expired_full\").addClass(\"hidden\");\n        $(\"#menu_button_edit_item, #menu_button_del_item, #menu_button_copy_item, #menu_button_add_fav, #menu_button_del_fav, #menu_button_show_pw, #menu_button_copy_pw, #menu_button_copy_login, #menu_button_copy_url, #menu_button_copy_link\").attr(\"disabled\",\"disabled\");\n        $(\"#request_ongoing\").val(\"\");\n        return false;\n    }\n    $(\"#div_loading\").removeClass(\"hidden\");\n    if ($(\"#is_admin\").val() == \"1\") {\n        $('#menu_button_edit_item,#menu_button_del_item,#menu_button_copy_item').attr('disabled', 'disabled');\n    }\n\n    if ($(\"#edit_restricted_to\") != undefined) {\n        $(\"#edit_restricted_to\").val(\"\");\n    }\n\n    // Check if personal SK is needed and set\n    if (($('#recherche_group_pf').val() === \"1\" && $('#personal_sk_set').val() === \"0\") && salt_key_required === \"1\") {\n        $(\"#set_personal_saltkey_warning\").html(\"<div style='font-size:16px;'><span class='fa fa-warning fa-lg'></span>&nbsp;</span><?php echo addslashes($LANG['alert_message_personal_sk_missing']); ?></div>\").show(1).delay(2500).fadeOut(1000);\n        $('#div_set_personal_saltkey').dialog('open');\n\n        //$(\"#div_dialog_message_text\").html(\"<div style='font-size:16px;'><span class='fa fa-warning fa-lg mi-red'></span>&nbsp;<\\/span><?php echo addslashes($LANG['alert_message_personal_sk_missing']); ?><\\/div>\");\n        $(\"#div_loading\").addClass(\"hidden\");\n        //$(\"#div_dialog_message\").dialog(\"open\");\n        $(\"#request_ongoing\").val(\"\");\n        return false;\n    } else if ($('#recherche_group_pf').val() === \"0\" || ($('#recherche_group_pf').val() === \"1\" && $('#personal_sk_set').val() === \"1\")) {\n        // Double click\n        if (open_edit == 1 && $(\"#item_editable\").val() == 1 && reload != 1) {\n            $(\"#request_ongoing\").val(\"\");\n            open_edit_item_div(\n                <?php if (isset($SETTINGS['restricted_to_roles']) && $SETTINGS['restricted_to_roles'] === \"1\") {\n    echo 1;\n} else {\n    echo 0;\n}?>\n            );\n        } else if ($(\"#request_lastItem\").val() == id && reload != 1) {\n            $(\"#request_ongoing\").val(\"\");\n            LoadingPage();\n            return;\n        } else {\n            $(\"#timestamp_item_displayed\").val(\"\");\n            var data = {\n                \"id\" : id,\n                \"folder_id\" : $('#hid_cat').val(),\n                \"salt_key_required\" : $('#recherche_group_pf').val(),\n                \"salt_key_set\" : $('#personal_sk_set').val(),\n                \"expired_item\" : expired_item === undefined ? \"\" : expired_item,\n                \"restricted\" : expired_item === undefined ? \"\" : expired_item,\n                \"page\" : \"items\"\n            };\n\n            //Send query\n            $.post(\n                \"sources/items.queries.php\",\n                {\n                    type : 'show_details_item',\n                    data : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key  : \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data_raw) {\n                    //decrypt data\n                    try {\n                        data = prepareExchangedData(data_raw , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                    } catch (e) {\n                        // error\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#request_ongoing\").val(\"\");\n                        $(\"#div_dialog_message_text\").html(\"An error appears. Answer from Server cannot be parsed!<br /><br />Returned data:<br />\"+data_raw);\n                        $(\"#div_dialog_message\").show();\n                        return;\n                    }\n\n                    if (data.error != \"\") {\n                        $(\"#div_dialog_message_text\").html(\"An error appears. Answer from Server cannot be parsed!<br /><br />Returned data:<br />\"+data.error);\n                        $(\"#div_dialog_message\").show();\n                    }\n\n                    // reset password shown info\n                    $(\"#pw_shown\").val(\"0\");\n\n                    // show some info on top\n                    if (data.auto_update_pwd_frequency != \"0\") var auto_update_pwd = \"<i class='fa fa-shield tip' title='<?php echo addslashes($LANG['server_auto_update_password_enabled_tip']); ?>'></i>&nbsp;<b>\"+data.auto_update_pwd_frequency+\"</b>&nbsp;|&nbsp;\";\n                    else var auto_update_pwd = \"\";\n                    $(\"#item_viewed_x_times\").html(auto_update_pwd+\"&nbsp;<i class='fa fa-sticky-note-o tip' title='Number of times item was displayed'></i>&nbsp;<b>\"+data.viewed_no+\"</b>\");\n\n                    // Show timestamp\n                    $(\"#timestamp_item_displayed\").val(data.timestamp);\n\n                    //Change the class of this selected item\n                    if ($(\"#selected_items\").val() != \"\") {\n                        $(\"#fileclass\"+$(\"#selected_items\").val()).removeClass(\"fileselected\");\n                    }\n                    $(\"#selected_items\").val(data.id);\n\n                    //Show saltkey\n                    if (data.edit_item_salt_key == \"1\") {\n                        $(\"#edit_item_salt_key\").show();\n                    } else {\n                        $(\"#edit_item_salt_key\").addClass(\"hidden\");\n                    }\n\n                    // clean some not used fields\n                    //$(\"#item_history_log, #edit_past_pwds, #hid_files, #item_edit_list_files\").html(\"\");\n\n                    //Show detail item\n                    if (data.show_detail_option == \"0\") {\n                        $(\"#item_details_ok\").removeClass(\"hidden\");\n                        $(\"#item_details_expired, #item_details_expired_full\").addClass(\"hidden\");\n                    }if (data.show_detail_option == \"1\") {\n                        $(\"#item_details_ok, #item_details_expired\").removeClass(\"hidden\");\n                        $(\"#item_details_expired_full\").addClass(\"hidden\");\n                    } else if (data.show_detail_option == \"2\") {\n                        $(\"#item_details_ok, #item_details_expired, #item_details_expired_full\").addClass(\"hidden\");\n                    }\n                    $(\"#item_details_nok\").addClass(\"hidden\");\n                    $(\"#fileclass\"+data.id).addClass(\"fileselected\");\n                    $(\"item_editable\").val(0);\n\n                    if (data.show_details == \"1\" && data.show_detail_option != \"2\") {\n                        //unprotect data\n                        data.login = unsanitizeString(data.login);\n\n                        $(\"#id_files\").html(\"\");\n\n                        //Display details\n                        $(\"#id_label\").html(data.label);\n                        $(\"#hid_label\").val(unsanitizeString(data.label));\n                        if (data.pw === \"\") {\n                            $(\"#id_pw\").html(\"\");\n                        } else {\n                            $(\"#id_pw\").html('<?php echo $var['hidden_asterisk']; ?>');\n                        }\n                        $(\"#hid_pw\").val(unsanitizeString(data.pw));\n                        if (data.url != \"\") {\n                            $(\"#id_url\").html(data.url+data.link);\n                            $(\"#hid_url\").val(data.url);\n                        } else {\n                            $(\"#id_url\").html(\"\");\n                            $(\"#hid_url\").val(\"\");\n                        }\n                        $(\"#id_desc\").html(data.description);\n                        $(\"#hid_desc\").val(data.description);\n                        $(\"#id_login\").html(data.login);\n                        $(\"#hid_login\").val(data.login);\n                        $(\"#id_email\").html(data.email);\n                        $(\"#hid_email\").val(data.email);\n                        //prepare nice list of users / groups\n                        var tmp_arr = data.id_restricted_to.split(\";\");\n                        var html_users = \"\";\n                        for (var i=0; i<tmp_arr.length; i++) {\n                            if (tmp_arr[i] !== \"\") html_users += \"<span class='round-grey'><i style='margin-right:2px;' class='fa fa-user fa-sm'></i>\"+tmp_arr[i]+\"</span>\";\n                        }\n                        var tmp_arr = data.id_restricted_to_roles.split(\";\");\n                        var html_groups = \"\";\n                        for (var i=0; i<tmp_arr.length; i++) {\n                            if (tmp_arr[i] !== \"\") html_groups += \"<span class='round-grey'><i style='margin-right:2px;' class='fa fa-group fa-sm'></i>\"+tmp_arr[i]+\"</span>\";\n                        }\n                        $(\"#id_restricted_to\").html(\n                            html_users+\n                            html_groups\n                        );\n                        $(\"#hid_restricted_to\").val(data.id_restricted_to);\n                        $(\"#hid_restricted_to_roles\").val(data.id_restricted_to_roles);\n                        $(\"#id_tags\").html(data.tags);\n                        // extract real tags list\n                        var item_tag = \"\";\n                        $(\"span.item_tag\").each(function(){\n                            if (item_tag == \"\") item_tag = $(this).text();\n                            else item_tag += \" \"+$(this).text();\n                        });\n                        $(\"#hid_tags\").val(item_tag);\n                        $(\"#hid_anyone_can_modify\").val(data.anyone_can_modify);\n                        $(\"#id_categorie\").val(data.folder);\n                        $(\"#id_item\").val(data.id);\n                        $(\"#id_kbs\").html(data.links_to_kbs);\n                        $(\".tip\").tooltipster({\n                            maxWidth: 400,\n                            contentAsHTML: true,\n                            multiple: true\n                        });\n\n                        // ---\n                        // Show Field values\n                        $(\".fields\").val(\"\");\n                        $(\".fields_div\").html(\"\");\n                        // If no CF then hide\n                        if (data.fields === \"\") {\n                            $(\".tr_fields\").addClass(\"hidden\");\n                        } else {\n                            $(\".tr_cf, .tr_fields\").removeClass(\"hidden\");\n                            var liste = data.fields.split('_|_');\n                            for (var i=0; i<liste.length; i++) {\n                                var field = liste[i].split('~~');\n                                $(\"#cf_tr_\" + field[0] + \", #tr_catfield_\" + field[2]).show();\n                                $('#hid_field_' + field[0] + '_' + field[2]).val(field[1]);\n                                if (field[3] === \"masked\") {\n                                    $('#id_field_' + field[0] + '_' + field[2])\n                                        .html('<?php echo $var['hidden_asterisk']; ?>');\n                                } else {\n                                    $('#id_field_' + field[0] + '_' + field[2])\n                                        .html(field[1]);\n                                }\n                            }\n                        }\n\n                        //Anyone can modify button\n                        if (data.anyone_can_modify == \"1\") {\n                            $(\"#edit_anyone_can_modify\").attr('checked', true);\n                            $(\"#new_history_entry_form\").show();\n                        } else {\n                            $(\"#edit_anyone_can_modify\").attr('checked', false);\n                            $(\"#new_history_entry_form\").addClass(\"hidden\");\n                        }\n\n                        //Show to be deleted in case activated\n                        if (data.to_be_deleted == \"not_enabled\") {\n                            $(\"#edit_to_be_deleted\").addClass(\"hidden\");\n                        } else {\n                            $(\"#edit_to_be_deleted\").show();\n                            if (data.to_be_deleted != \"\") {\n                                $(\"#edit_enable_delete_after_consultation\").attr(\"checked\",true);\n                                if (data.to_be_deleted_type == 2) {\n                                    $(\"#edit_times_before_deletion\").val(\"\");\n                                    $(\"#edit_deletion_after_date\").val(data.to_be_deleted);\n                                } else {\n                                    $(\"#edit_times_before_deletion\").val(data.to_be_deleted);\n                                    $(\"#edit_deletion_after_date\").val(\"\");\n                                }\n                            } else {\n                                $(\"#edit_enable_delete_after_consultation\").attr(\"checked\",false);\n                                $(\"#edit_times_before_deletion, #edit_deletion_after_date\").val(\"\");\n                            }\n                        }\n\n                        //manage buttons\n                        if ($(\"#user_is_read_only\").val() == 1) {\n                            $('#menu_button_add_item, #menu_button_edit_item, #menu_button_del_item, #menu_button_copy_item').attr('disabled', 'disabled');\n                        } else if (data.user_can_modify == 0) {\n                            $('#menu_button_edit_item, #menu_button_del_item, #menu_button_copy_item').attr('disabled', 'disabled');\n                        } else if (data.restricted == \"1\" || data.user_can_modify == \"1\") {\n                            //$(\"#menu_button_edit_item, #menu_button_del_item, #menu_button_copy_item\").prop(\"disabled\", false);\n                            var param = \"#menu_button_edit_item, #menu_button_del_item, #menu_button_copy_item\";\n                            $(\"#new_history_entry_form\").show();\n                        } else {\n                            //$(\"#menu_button_add_item, #menu_button_copy_item\").prop(\"disabled\", false);\n                            var param = \"#menu_button_del_item, #menu_button_copy_item\";\n                            $(\"#new_history_entry_form\").show();\n                        }\n                        //$(\"#menu_button_show_pw, #menu_button_copy_pw, #menu_button_copy_login, #menu_button_copy_link, #menu_button_history\").prop(\"disabled\", false);\n\n                        // disable share button for personal folder\n                        if ($(\"#recherche_group_pf\").val() == 1) {\n                            $(\"#menu_button_share, #menu_button_otv\").attr('disabled', 'disabled');\n                        } else {\n                            $(\"#menu_button_share, #menu_button_otv\").prop(\"disabled\", false);\n                        }\n\n                        //Manage to deleted information\n                        if (data.to_be_deleted != 0 && data.to_be_deleted != null && data.to_be_deleted != \"not_enabled\") {\n                            $('#item_extra_info')\n                                .html(\"<b><i class='fa fa-bell-o mi-red'></i></b>&nbsp;\")\n                                .attr(\"title\", \"<?php echo addslashes($LANG['automatic_deletion_activated']); ?>\");\n                            $('#item_extra_info').tooltipster({multiple: true});\n                        } else {\n                            $('#item_extra_info').html(\"\");\n                        }\n\n                        if (data.notification_status == 0 && data.id_user == <?php echo $_SESSION['user_id']; ?>) {\n                            $('#menu_button_notify')\n                                .prop(\"disabled\", false)\n                                .attr('title','<?php echo addslashes($LANG['enable_notify']); ?>')\n                                .attr('onclick','notify_click(\\'true\\')');\n                            $('#div_notify').attr('class', '<i class=\"fa fa-bell mi-green\"></i>&nbsp;');\n                        } else if (data.notification_status == 1 && data.id_user == <?php echo $_SESSION['user_id']; ?>) {\n                            $('#menu_button_notify')\n                                .prop(\"disabled\", false)\n                                .attr('title','<?php echo addslashes($LANG['disable_notify']); ?>')\n                                .attr('onclick','notify_click(\\'false\\')');\n                            $('#div_notify').attr('class', '<i class=\"fa fa-bell-slash mi-red\"></i>&nbsp;');\n                            $('#item_extra_info').html(\"<i><i class=\\'fa fa-bell mi-green\\'></i>&nbsp;<?php echo addslashes($LANG['notify_activated']); ?></i>\");\n                        } else {\n                            $('#menu_button_notify').attr('disabled', 'disabled');\n                            $('#div_notify').attr('class', '<i class=\"fa fa-bell mi-green\"></i>&nbsp;');\n                        }\n\n                        //Prepare clipboard copies\n                        if (data.pw != \"\") {\n                            var clipboard_pw = new Clipboard(\"#menu_button_copy_pw, #button_quick_pw_copy\", {\n                                text: function() {\n                                    return (unsanitizeString(data.pw));\n                                }\n                            });\n                            clipboard_pw.on('success', function(e) {\n                                $(\"#message_box\").html(\"<?php echo addslashes($LANG['pw_copied_clipboard']); ?>\").show().fadeOut(1000);\n                                itemLog(\"item_password_copied\");\n\n                                e.clearSelection();\n                            });\n\n                            $(\"#button_quick_pw_copy\").show();\n                        } else {\n                            $(\"#button_quick_pw_copy\").addClass(\"hidden\");\n                        }\n                        if (data.login != \"\") {\n                            var clipboard_login = new Clipboard(\"#menu_button_copy_login, #button_quick_login_copy\", {\n                                text: function() {\n                                    return (data.login);\n                                }\n                            });\n                            clipboard_login.on('success', function(e) {\n                                $(\"#message_box\").html(\"<?php echo addslashes($LANG['login_copied_clipboard']); ?>\").show().fadeOut(1000);\n\n                                e.clearSelection();\n                            });\n                            $(\"#button_quick_login_copy\").show();\n                        } else {\n                            $(\"#button_quick_login_copy\").addClass(\"hidden\");\n                        }\n                        // #525\n                        if (data.url != \"\") {\n                            var clipboard_url = new Clipboard(\"#menu_button_copy_url\", {\n                                text: function() {\n                                    return unsanitizeString(data.url);\n                                }\n                            });\n                            clipboard_url.on('success', function(e) {\n                                $(\"#message_box\").html(\"<?php echo addslashes($LANG['url_copied_clipboard']); ?>\").show().fadeOut(1000);\n\n                                e.clearSelection();\n                            });\n                        }\n\n                        //prepare link to clipboard\n                        var clipboard_link = new Clipboard(\"#menu_button_copy_link\", {\n                            text: function() {\n                                return \"<?php echo $SETTINGS['cpassman_url']; ?>\"+\"/index.php?page=items&group=\"+data.folder+\"&id=\"+data.id;\n                            }\n                        });\n                        clipboard_link.on('success', function(e) {\n                            $(\"#message_box\").html(\"<?php echo addslashes($LANG['url_copied']); ?>\").show().fadeOut(1000);\n\n                            e.clearSelection();\n                        });\n\n\n                        //set if user can edit\n                        if (data.restricted == \"1\" || data.user_can_modify == \"1\") {\n                            $(\"#item_editable\").val(1);\n                        }\n\n                        //Manage double click\n                        if (open_edit === true && (data.restricted == \"1\" || data.user_can_modify == \"1\")) {\n                            open_edit_item_div(\n                            <?php if (isset($SETTINGS['restricted_to_roles']) && $SETTINGS['restricted_to_roles'] == 1) {\n    echo 1;\n} else {\n    echo 0;\n}?>);\n                        }\n\n                        // tags\n                        $(\".round-grey\").addClass(\"ui-state-highlight ui-corner-all\");\n\n                        // continue loading data\n                        showDetailsStep2(id, param);\n\n                    } else if (data.show_details === \"1\" && data.show_detail_option === \"2\") {\n                        $(\"#item_details_nok\").addClass(\"hidden\");\n                        $(\"#item_details_ok\").addClass(\"hidden\");\n                        $(\"#item_details_expired_full\").show();\n                        $(\"#menu_button_edit_item, #menu_button_del_item, #menu_button_copy_item, #menu_button_add_fav, #menu_button_del_fav, #menu_button_show_pw, #menu_button_copy_pw, #menu_button_copy_login, #menu_button_copy_link\").attr(\"disabled\",\"disabled\");\n                        $(\"#div_loading\").addClass(\"hidden\");\n                    } else {\n                        //Dont show details\n                        $(\"#item_details_nok\").removeClass(\"hidden\");\n                        $(\"#item_details_nok_restriction_list\").html('<div style=\"margin:10px 0 0 20px;\"><b><?php echo addslashes($LANG['author']); ?>: </b>' + data.author + '<br /><b><?php echo addslashes($LANG['restricted_to']); ?>: </b>' + data.restricted_to + '<br /><br /><u><a href=\"#\" onclick=\"SendMail(\\'request_access_to_author\\',\\'' + data.id + ',' + data.id_user + '\\',\\'<?php echo $_SESSION['key']; ?>\\',\\'<?php echo addslashes($LANG['forgot_my_pw_email_sent']); ?>\\')\"><?php echo addslashes($LANG['request_access_ot_item']); ?></a></u></div>');\n                        $(\"#item_details_ok\").addClass(\"hidden\");\n                        $(\"#item_details_expired\").addClass(\"hidden\");\n                        $(\"#item_details_expired_full\").addClass(\"hidden\");\n                        $(\"#menu_button_edit_item, #menu_button_del_item, #menu_button_copy_item, #menu_button_add_fav, #menu_button_del_fav, #menu_button_show_pw, #menu_button_copy_pw, #menu_button_copy_login, #menu_button_copy_link\").attr(\"disabled\",\"disabled\");\n                        $(\"#div_loading\").addClass(\"hidden\");\n                    }\n                    $(\"#request_ongoing\").val(\"\");\n                }\n           );\n\n            if (id_tree != \"\" && id_tree != $(\"#hid_cat\").val()) {\n                refreshTree(id_tree, \"0\");\n            }\n\n           // statistic\n           /*$.post(\n                \"sources/main.queries.php\",\n                {\n                    type                : 'item_stat',\n                    id                  : id,\n                    scope                : \"item\"\n                },\n                function(data) {\n\n                }\n            );*/\n       }\n    //Store Item id shown\n    $(\"#request_lastItem\").val(id);\n    }\n}\n\n\n/*\n* Loading Item details step 2\n*/\nfunction showDetailsStep2(id, param)\n{\n    $(\"#div_loading\").removeClass(\"hidden\");\n    $.post(\n        \"sources/items.queries.php\",\n        {\n        type    : \"showDetailsStep2\",\n        id      : id\n        },\n        function(data) {\n            //decrypt data\n            try {\n                data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n            } catch (e) {\n                // error\n                $(\"#div_loading\").addClass(\"hidden\");\n                $(\"#request_ongoing\").val(\"\");\n                $(\"#div_dialog_message_text\").html(\"An error appears. Answer from Server cannot be parsed!<br />Returned data:<br />\"+data);\n                $(\"#div_dialog_message\").dialog(\"open\");\n\n                return;\n            }\n\n            if (data.error !== \"\") {\n                $(\"#div_dialog_message_text\").html(data.error_text);\n                $(\"#div_dialog_message\").show();\n                return false;\n            }\n\n            $(\"#item_history_log\").html(htmlspecialchars_decode(data.history));\n            $(\"#edit_past_pwds\").attr('title', htmlspecialchars_decode(data.history_of_pwds));\n            $(\"#edit_past_pwds_div\").html(htmlspecialchars_decode(data.history_of_pwds));\n\n            $(\"#id_files\").html(data.files_id);\n            $(\"#hid_files\").val(data.files_id);\n            $(\"#item_edit_list_files\").html(data.files_edit);\n\n            //$(\"#div_last_items\").html(htmlspecialchars_decode(data.div_last_items));\n\n            // function calling image lightbox when clicking on link\n            $(\"a.image_dialog\").click(function(event) {\n                event.preventDefault();\n                PreviewImage($(this).attr(\"href\"),$(this).attr(\"title\"));\n            });\n\n            //Set favourites icon\n            if (data.favourite == \"1\") {\n                $(\"#menu_button_add_fav\").attr(\"disabled\",\"disabled\");\n                $(\"#menu_button_del_fav\").prop(\"disabled\", false);\n            } else {\n                $(\"#menu_button_add_fav\").prop(\"disabled\", false);\n                $(\"#menu_button_del_fav\").attr(\"disabled\",\"disabled\");\n            }\n\n            // set indicator if item has change proposal\n            if (parseInt(data.has_change_proposal) > 0) {\n                $(\"#item_extra_info\").prepend('<i class=\"fa fa-lightbulb-o fa-sm mi-yellow tip\" title=\"<?php echo addslashes($LANG['item_has_change_proposal']); ?>\" onclick=\"\"></i>&nbsp;');\n            }\n\n            $(param).prop(\"disabled\", false);\n            $(\"#menu_button_show_pw, #menu_button_copy_pw, #menu_button_copy_login, #menu_button_copy_link, #menu_button_history\").prop(\"disabled\", false);\n            $(\"#div_loading\").addClass(\"hidden\");\n\n            $(\".tip\").tooltipster({multiple: true});\n\n            // refresh\n            if ($(\"#hid_cat\").val() !== \"\") {\n                refreshListLastSeenItems();\n            }\n         }\n     );\n};\n\n/*\n   * FUNCTION\n   * Launch an action when clicking on a quick icon\n   * $action = 0 => Make not favorite\n   * $action = 1 => Make favorite\n*/\nfunction ActionOnQuickIcon(id, action)\n{\n    //change quick icon\n    if (action == 1) {\n        $(\"#quick_icon_fav_\"+id).html(\"<i class='fa fa-sm fa-star mi-yellow' onclick='ActionOnQuickIcon(\"+id+\",0)'></i>\");\n    } else if (action == 0) {\n        $(\"#quick_icon_fav_\"+id).html(\"<i class='fa fa-sm fa-star-o' onclick='ActionOnQuickIcon(\"+id+\",1)'></i>\");\n    }\n\n    //Send query\n    LoadingPage();\n    $.post(\"sources/items.queries.php\",\n        {\n            type    : 'action_on_quick_icon',\n            id      : id,\n            action  : action\n        },\n        function(data) {\n            LoadingPage();\n            displayMessage(\"<?php echo addslashes($LANG['alert_message_done']); ?>\");\n        }\n   );\n}\n\n//###########\n//## FUNCTION : prepare new folder dialogbox\n//###########\nfunction open_add_group_div()\n{\n    if ($(\"#user_is_read_only\").length && $(\"#user_is_read_only\").val() == 1) {\n        displayMessage(\"<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n        return false;\n    }\n\n    $(\"#div_loading\").removeClass(\"hidden\");\n\n    // check if read only or forbidden\n    if (RecupComplexite($('#hid_cat').val(), 0, \"create_folder\") == 0) {\n        return false;\n    }\n\n    //Select the actual folder in the dialogbox\n    $('#new_rep_groupe option[value=' + $('#hid_cat').val() + ']').prop('selected', true);\n    $('#div_ajout_rep').dialog('open');\n    $(\"#div_loading\").addClass(\"hidden\");\n}\n\n//###########\n//## FUNCTION : prepare editing folder dialogbox\n//###########\nfunction open_edit_group_div()\n{\n    if ($(\"#user_is_read_only\").length && $(\"#user_is_read_only\").val() == 1) {\n        displayMessage(\"<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n        return false;\n    }\n\n    $(\"#div_loading\").removeClass(\"hidden\");\n\n    // check if read only or forbidden\n    if (RecupComplexite($('#hid_cat').val(), 0, \"edit_folder\") == 0) {\n        return false;\n    }\n\n    //Select the actual forlder in the dialogbox\n    $('#edit_folder_folder option[value=' + $('#hid_cat').val() + ']').prop('selected', true);\n    $('#edit_folder_title').val($.trim($('#edit_folder_folder :selected').text()));\n    $('#edit_folder_complexity').val($('#complexite_groupe').val());\n    $('#div_editer_rep').dialog('open');\n    $(\"#div_loading\").addClass(\"hidden\");\n}\n\n//###########\n//## FUNCTION : prepare moving folder dialogbox\n//###########\nfunction open_move_group_div()\n{\n    if ($.inArray($(\"#hid_cat\").val(), $(\"#personal_visible_groups_list\").val().split(',')) != -1 && $(\"#personal_sk_set\").val() === \"0\") {\n        displayMessage(\"<i class='fa fa-warning'></i>&nbsp;<?php echo addslashes($LANG['error_personal_sk_expected']); ?>\");\n        return false;\n    }\n\n    if ($(\"#hid_cat\").val() == \"<?php if (isset($_SESSION['personal_folders'][0])) {\n    echo $_SESSION['personal_folders'][0];\n} else {\n    echo \"\";\n}\n?>\") {\n        displayMessage(\"<i class='fa fa-warning'></i>&nbsp;<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n        return false;\n    }\n    if ($(\"#user_is_read_only\").length && $(\"#user_is_read_only\").val() == 1) {\n        displayMessage(\"<i class='fa fa-warning'></i>&nbsp;<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n        return false;\n    }\n    $(\"#div_loading\").removeClass(\"hidden\");\n\n    // check if read only or forbidden\n    if (RecupComplexite($('#hid_cat').val(), 0) == 0) return false;\n\n    //Select the actual folder in the dialogbox\n    //$('#move_folder_id option[value=' + $('#hid_cat').val() + ']').prop('selected', true);\n    $('#move_folder_title').html($.trim($('#move_folder_id :selected').text())+\" [id\"+$('#hid_cat').val()+\"]\");\n    $('#move_folder_id').val(0);\n    $('#div_move_folder').dialog('open');\n    $(\"#div_loading\").addClass(\"hidden\");\n}\n\n//###########\n//## FUNCTION : prepare delete folder dialogbox\n//###########\nfunction open_del_group_div()\n{\n    if ($(\"#user_is_read_only\").length && $(\"#user_is_read_only\").val() == 1) {\n        displayMessage(\"<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n        return false;\n    }\n    $(\"#div_loading\").removeClass(\"hidden\");\n\n\n    // check if read only or forbidden\n    if (RecupComplexite($('#hid_cat').val(), 0, \"delete_folder\") == 0) {\n        return false;\n    } else {\n        $('#div_supprimer_rep').dialog('open');\n        $('#delete_rep_groupe option[value=' + $('#hid_cat').val() + ']').prop('selected', true);\n        $(\"#div_loading\").addClass(\"hidden\");\n    }\n}\n\n//###########\n//## FUNCTION : prepare new item dialogbox\n//###########\nfunction open_add_item_div()\n{\n    LoadingPage();\n\n    //Check if personal SK is needed and set\n    if ($('#recherche_group_pf').val() == 1 && $('#personal_sk_set').val() == 0) {\n        $(\"#div_dialog_message_text\").html(\"<div style='font-size:16px;'><span class='ui-icon ui-icon-alert' style='float: left; margin-right: .3em;'><\\/span><?php echo addslashes($LANG['alert_message_personal_sk_missing']); ?><\\/div>\");\n        LoadingPage();\n        $(\"#div_dialog_message\").dialog(\"open\");\n    } else if ($(\"#hid_cat\").val() == \"\") {\n        LoadingPage();\n        $(\"#div_dialog_message_text\").html(\"<div style='font-size:16px;'><span class='ui-icon ui-icon-alert' style='float: left; margin-right: .3em;'><\\/span><?php echo addslashes($LANG['error_no_selected_folder']); ?><\\/div>\").dialog(\"open\");\n    } else if ($('#recherche_group_pf').val() == 0 || ($('#recherche_group_pf').val() == 1 && $('#personal_sk_set').val() == 1)) {\n        // is user read only and it is not a personal folder\n        if ($('#recherche_group_pf').val() == 0 && $(\"#user_is_read_only\").length && $(\"#user_is_read_only\").val() == \"1\") {\n            displayMessage(\"<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n            LoadingPage();\n            return false;\n        }\n\n        //Select the actual forlder in the dialogbox\n        $('#categorie').val($('#hid_cat').val());\n\n        //Get the associated complexity level\n        var compReturn = RecupComplexite($('#hid_cat').val(), 0);\n\n        // exclude because user is read only\n        if (compReturn == 0) {\n            $(\"#div_loading\").addClass(\"hidden\");\n            return false;\n        }\n\n        //Show WYGIWYS editor\n        CKEDITOR.replace(\n            \"desc\",\n            {\n                toolbar :[[\"Bold\", \"Italic\", \"Strike\", \"-\", \"NumberedList\", \"BulletedList\", \"-\", \"Link\",\"Unlink\",\"-\",\"RemoveFormat\"]],\n                height: 100,\n                language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n            }\n        );\n\n        // prepare select2 for users\n        $(\"#annonce_liste_destinataires\").select2({\n            language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n        });\n\n        if ($(\"#recherche_group_pf\").val() == 1) {\n            $(\"#div_editRestricted\").addClass(\"hidden\");\n        } else {\n            $(\"#div_editRestricted\").show();\n        }\n\n        //open dialog\n        $(\"#div_formulaire_saisi_info\").addClass(\"hidden\").html(\"\");\n        $(\"#div_formulaire_saisi\").dialog(\"open\");\n    }\n}\n\n//###########\n//## FUNCTION : prepare editing item dialogbox\n//###########\nfunction open_edit_item_div(restricted_to_roles)\n{\n    // is user read only and it is not a personal folder\n    if (\n        ($('#recherche_group_pf').val() === \"0\" && $(\"#user_is_read_only\").length && $(\"#user_is_read_only\").val() === \"1\")\n        || (\n            ($(\"#access_level\").val() === \"1\" || $(\"#access_level\").val() === \"3\")\n            && $('#recherche_group_pf').val() === \"0\"\n        )\n    ) {\n        // Exclude the case where the user is in his PF with PSK set\n        if ($('#recherche_group_pf').val() === \"1\" && $(\"#personal_sk_set\").val() === \"1\") {\n            // do nothing\n        } else {\n            displayMessage(\"<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n            return false;\n        }\n    }\n\n    // If no Item selected, no edition possible\n    if ($(\"#selected_items\").val() == \"\") {\n        displayMessage(\"<?php echo addslashes($LANG['none_selected_text']); ?>\");\n        return false;\n    }\n    $(\"#div_loading\").removeClass(\"hidden\");\n\n    // Get complexity level for this folder\n    // and stop edition if Item edited by another user\n    var compReturn = RecupComplexite($('#hid_cat').val(), 1);\n\n    if (compReturn == 0) {\n        if (CKEDITOR.instances[\"edit_desc\"]) {\n            CKEDITOR.instances[\"edit_desc\"].destroy();\n        }\n        if (CKEDITOR.instances[\"desc\"]) {\n            CKEDITOR.instances[\"desc\"].destroy();\n        }\n        $(\"#div_loading\").addClass(\"hidden\");\n        return;\n    }\n\n    // Check if Item has changed since loaded\n    if (CheckIfItemChanged() == 1) {\n        var tmp = $(\"#\"+$(\"#selected_items\").val()).attr(\"ondblclick\");\n        tmp = tmp.substring(20,tmp.indexOf(\")\"));\n        tmp = tmp.replace(/'/g, \"\").split(',');\n        AfficherDetailsItem(tmp[0], tmp[1], tmp[2], tmp[3], tmp[4], 1, 1);\n        $(\"#div_loading\").addClass(\"hidden\");\n        return;\n    }\n\n    // Show WYGIWYG editor\n    CKEDITOR.replace(\n        \"edit_desc\",\n        {\n            toolbar :[[\"Bold\", \"Italic\", \"Strike\", \"-\", \"NumberedList\", \"BulletedList\", \"-\", \"Link\",\"Unlink\",\"-\",\"RemoveFormat\"]],\n            height: 100,\n            language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n        }\n   );\n    CKEDITOR.instances[\"edit_desc\"].setData($('#hid_desc').val());\n\n    $('#edit_display_title').html($('#hid_label').val());\n    $('#edit_label').val($('#hid_label').val());\n    $('#edit_desc').html($('#hid_desc').val());\n    $('#edit_pw1, #edit_pw2').val($('#hid_pw').val());\n    $(\"#edit_visible_pw\").text($('#hid_pw').val());\n    $('#edit_item_login').val($('#hid_login').val());\n    $('#edit_email').val($('#hid_email').val());\n    $('#edit_url').val($('#hid_url').val());\n    $('#edit_categorie').val($('#id_categorie').val());\n    if ($('#edit_restricted_to').val() != undefined) {\n        $('#edit_restricted_to').val($('#hid_restricted_to').val());\n    }\n    if ($('#edit_restricted_to_roles').val() != undefined) {\n        $('#edit_restricted_to_roles').val($('#hid_restricted_to_roles').val());\n    }\n    $('#edit_tags').val($('#hid_tags').val());\n    if ($('#hid_anyone_can_modify').val() == \"1\") {\n        $('#edit_anyone_can_modify').attr(\"checked\",\"checked\");\n        $('#edit_anyone_can_modify').button(\"refresh\");\n    } else {\n        $('#edit_anyone_can_modify').attr(\"checked\",false);\n        $('#edit_anyone_can_modify').button(\"refresh\");\n    }\n    // fields display\n    if ($('.fields').val() != undefined && $(\"#display_categories\").val() != \"\") {\n        $('.fields').each(function(i){\n            id = $(this).attr('id').split('_');\n            $('#edit_field_' + id[2] + '_' + id[3]).val(htmlspecialchars_decode($('#hid_field_' + id[2] + '_' + id[3]).val()));\n        });\n    }\n\n    //Get list of people in restriction list\n    if ($(\"#recherche_group_pf\").val() == 1) {\n        $(\"#div_editRestricted\").addClass(\"hidden\");\n    } else {\n        $(\"#div_editRestricted\").show();\n        // tick selected users / roles\n        if ($('#edit_restricted_to').val() != undefined) {\n            var list = $('#hid_restricted_to').val().split(';');\n            for (var i=0; i<list.length; i++) {\n                var elem = list[i];\n                if (elem != \"\") {\n                    $(\".folder_rights_user_edit\").each(function() {\n                        if ($(this).attr(\"id\") == elem) {\n                            $(this).prop(\"checked\", true);\n                            exit;\n                        }\n                    });\n                }\n            }\n        }\n\n        if ($('#edit_restricted_to').val() != undefined) {\n            $('#edit_restricted_to_list').empty();\n            if (restricted_to_roles == 1) {\n                //add optgroup\n                var optgroup = $('<optgroup>');\n                optgroup.attr('label', \"<?php echo addslashes($LANG['users']); ?>\");\n                $(\"#edit_restricted_to_list option:last\").wrapAll(optgroup);\n            }\n            /*var liste = $('#input_liste_utilisateurs').val().split(';');\n            for (var i=0; i<liste.length; i++) {\n                var elem = liste[i].split('#');\n                if (elem[0] != \"\") {\n                    $(\"#edit_restricted_to_list\").append(\"<option value='\"+elem[0]+\"'>\"+elem[1]+\"</option>\");\n                    var index = $('#edit_restricted_to').val().lastIndexOf(elem[1]+\";\");\n                    if (index != -1) {\n                        $(\"#edit_restricted_to_list option[value=\"+elem[0]+\"]\").attr('selected', true);\n                    }\n                }\n            }*/\n        }\n\n        //Add list of roles if option is set\n        if (restricted_to_roles == 1 && $('#edit_restricted_to').val() != undefined) {\n            var j = i;\n            //add optgroup\n            var optgroup = $('<optgroup>');\n            optgroup.attr('label', \"<?php echo addslashes($LANG['roles']); ?>\");\n\n            var liste = $('#input_list_roles').val().split(';');\n            for (var i=0; i<liste.length; i++) {\n                var elem = liste[i].split('#');\n                if (elem[0] != \"\") {\n                    $(\"#edit_restricted_to_list\").append(\"<option value='role_\"+elem[0]+\"'>\"+elem[1]+\"</option>\");\n                    var index = $('#edit_restricted_to_roles').val().lastIndexOf(elem[1]+\";\");\n                    if (index != -1) {\n                        $(\"#edit_restricted_to_list option[value='role_\"+elem[0]+\"']\").attr('selected', true);\n                    }\n                    if (i==0) $(\"#edit_restricted_to_list option:last\").wrapAll(optgroup);\n                }\n                j++;\n            }\n        }\n    }\n\n    // prepare select2 for users\n    $(\"#edit_annonce_liste_destinataires\").select2({\n        language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n    });\n\n    // disable folder selection if PF\n    if ($('#recherche_group_pf').val() == \"1\") {\n        $(\"#edit_categorie\").prop(\"disabled\", true);\n    } else {\n        $(\"#edit_categorie\").prop(\"disabled\", false);\n    }\n\n    //open dialog\n    $(\"#div_formulaire_edition_item_info\").addClass(\"hidden\").html(\"\");\n    $(\"#div_formulaire_edition_item\").dialog(\"open\");\n}\n\n//###########\n//## FUNCTION : prepare new item dialogbox\n//###########\nfunction open_del_item_div()\n{\n    // is user read only\n    if (\n        ($('#recherche_group_pf').val() === \"0\" && $(\"#user_is_read_only\").length && $(\"#user_is_read_only\").val() === \"1\")\n        || (\n            ($(\"#access_level\").val() === \"1\" || $(\"#access_level\").val() === \"2\" || $(\"#access_level\").val() === \"3\")\n            && $('#recherche_group_pf').val() === \"0\"\n        )\n    ) {\n        displayMessage(\"<i class='fa fa-warning'></i>&nbsp;<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n        return false;\n    }\n\n    if ($(\"#selected_items\").val() != \"\") {\n        $(\"#div_loading\").removeClass(\"hidden\");\n        //Get the associated complexity level\n        var compReturn = RecupComplexite($('#hid_cat').val(), 0);\n\n        // exclude because user is read only\n        if (compReturn == 0) {\n            return false;\n        }\n\n        $(\"#div_loading\").addClass(\"hidden\");\n        $('#div_del_item').dialog('open');\n    } else {\n        displayMessage(\"<i class='fa fa-warning'></i>&nbsp;<?php echo addslashes($LANG['none_selected_text']); ?>\");\n    }\n}\n\n//###########\n//## FUNCTION : prepare copy item dialogbox\n//###########\nfunction open_copy_item_to_folder_div()\n{\n    // is user read only\n    if ($('#recherche_group_pf').val() == 0 && $(\"#user_is_read_only\").length && $(\"#user_is_read_only\").val() == \"1\") {\n        displayMessage(\"<i class='fa fa-warning'></i>&nbsp;<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n        return false;\n    }\n\n    if ($(\"#selected_items\").val() != \"\") {\n        $('#copy_in_folder').val($(\"#hid_cat\").val());\n        $('#div_copy_item_to_folder').dialog('open');\n    } else {\n        displayMessage(\"<i class='fa fa-warning'></i>&nbsp;<?php echo addslashes($LANG['none_selected_text']); ?>\");\n    }\n}\n\n\n//###########\n//## FUNCTION : Clear HTML tags from a string\n//###########\nfunction clear_html_tags()\n{\n    $.post(\n        \"sources/items.queries.php\",\n        {\n            type    : \"clear_html_tags\",\n            id_item  : $(\"#id_item\").val()\n        },\n        function(data) {\n            data = $.parseJSON(data);\n            $(\"#edit_desc\").val(data.description);\n        }\n   );\n}\n\n//###########\n//## FUNCTION : Permits to delete an attached file\n//###########\nfunction delete_attached_file(file_id)\n{\n    $.post(\n        \"sources/items.queries.php\",\n        {\n            type    : \"delete_attached_file\",\n            file_id : file_id,\n            key     : \"<?php echo $_SESSION['key']; ?>\"\n        },\n        function(data) {\n            $(\"#span_edit_file_\"+file_id).css(\"textDecoration\", \"line-through\");\n        }\n   );\n}\n\n//###########\n//## FUNCTION : Permits to preview an attached image\n//###########\nPreviewImage = function(uri,title) {\n    $(\"#div_loading\").removeClass(\"hidden\");\n    $.post(\n        \"sources/items.queries.php\",\n        {\n            type    : \"image_preview_preparation\",\n            uri     : uri,\n            title   : title,\n            key     : \"<?php echo $_SESSION['key']; ?>\"\n        },\n        function(data) {\n            data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n\n            $(\"#dialog_files\").html('<img id=\"image_files\" src=\"\" />');\n            //Get the HTML Elements\n            imageDialog = $(\"#dialog_files\");\n            imageTag = $('#image_files');\n\n            //Set the image src\n            imageTag.attr(\"src\", data.new_file);\n\n            //When the image has loaded, display the dialog\n            imageTag\n            .error(function() {\n                $(\"#div_loading\").addClass(\"hidden\");\n                displayMessage(\"<?php echo \"<i class='fa fa-exclamation-triangle fa-2x'></i>  \".addslashes($LANG['error_file_is_missing']); ?>\");\n            })\n            .load(function() {\n                $(\"#div_loading\").addClass(\"hidden\");\n                imageDialog.dialog({\n                    modal: true,\n                    resizable: false,\n                    draggable: false,\n                    width: 'auto',\n                    title: title,\n                    open: function( event, ui ) {\n                        // nothing to do\n                    },\n                    close: function (event, ui) {\n                        // delete file\n                        $.post(\n                            \"sources/main.queries.php\",\n                            {\n                                type    : \"file_deletion\",\n                                filename: data.file_path,\n                                key     : \"<?php echo $_SESSION['key']; ?>\"\n                            }\n                        );\n                    }\n                });\n            });\n        }\n    );\n}\n\nfunction notify_click(status)\n{\n    $.post(\"sources/items.queries.php\",\n    {\n        type     : \"notify_a_user\",\n        user_id : <?php echo $_SESSION['user_id']; ?>,\n        status    : status,\n        notify_type : 'on_show',\n        notify_role : '',\n        item_id : $('#id_item').val(),\n        key        : \"<?php echo $_SESSION['key']; ?>\"\n    },\n    function(data) {\n        if (data[0].error == \"something_wrong\") {\n            $(\"#new_show_error\").html('ERROR!!');\n            $(\"#new_show_error\").show();\n        } else {\n            $(\"#new_show_error\").addClass(\"hidden\");\n            if (data[0].new_status == \"true\") {\n                $('#menu_button_notify')\n                    .attr('title','<?php echo addslashes($LANG['disable_notify']); ?>')\n                    .attr('onclick','notify_click(\\'false\\')');\n                $('#div_notify').attr('class', '<i class=\"fa fa-bell-slash mi-green\"></i>&nbsp;');\n                $('#item_extra_info').html(\"<?php echo addslashes($LANG['notify_activated']); ?>\");\n            } else if (data[0].new_status == \"false\") {\n                $('#menu_button_notify')\n                    .attr('title','<?php echo addslashes($LANG['enable_notify']); ?>')\n                    .attr('onclick','notify_click(\\'true\\')');\n                $('#div_notify').attr('class', '<i class=\"fa fa-bell mi-green\"></i>&nbsp;');\n                $('#item_extra_info').html(\"\");\n            }\n        }\n    },\n    \"json\"\n    );\n}\n\n/*\n** Checks if current item title is a duplicate in current folder\n*/\nfunction checkTitleDuplicate(itemTitle, checkInCurrentFolder, checkInAllFolders, textFieldId)\n{\n    $(\"#new_show_error\").html(\"\").addClass(\"hidden\");\n    $(\"#div_formulaire_saisi ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").button(\"enable\");\n    if (itemTitle != \"\") {\n        if (checkInCurrentFolder == \"1\" || checkInAllFolders == \"1\") {\n            //prepare data\n            var data = {\"label\": itemTitle.replace(/\"/g,'&quot;') , \"idFolder\": $('#hid_cat').val()};\n\n            if (checkInCurrentFolder == \"1\") {\n                var typeOfCheck = \"same_folder\";\n            } else {\n                var typeOfCheck = \"all_folders\";\n            }\n\n            // disable Save button\n            $(\"#div_formulaire_saisi ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").button(\"disable\");\n\n            // send query\n            $.post(\n                \"sources/items.queries.php\",\n                {\n                    type    : \"check_for_title_duplicate\",\n                    option  : typeOfCheck,\n                    data    : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key     : \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data) {\n                    if (data[0].duplicate != \"1\") {\n                        $(\"#div_formulaire_saisi ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").button(\"enable\");\n                        // display title\n                        $(\"#\"+textFieldId).html(itemTitle.escapeHTML());\n                    } else {\n                        $(\"#label\").focus();\n                        $(\"#new_show_error\").html(\"<?php echo addslashes($LANG['duplicate_title_in_same_folder']); ?>\").show();\n                    }\n                }\n            );\n        } else {\n            // display title\n            $(\"#\"+textFieldId).html(itemTitle.escapeHTML());\n        }\n    }\n}\n\n/*\n* builds the folders tree\n*/\nfunction refreshTree(node_to_select, do_refresh, refresh_visible_folders)\n{\n    do_refresh = do_refresh || \"\"\n    node_to_select = node_to_select || \"\";\n    refresh_visible_folders = refresh_visible_folders || 1;\n\n    if (refresh_visible_folders !== 1) {\n        $(\"#jstree\").jstree(\"deselect_all\");\n        $('#jstree').jstree(\"select_node\", \"#li_\"+groupe_id);\n        return false;\n    }\n\n    if (do_refresh !== \"0\") {\n        $('#jstree').jstree(true).refresh();\n    }\n\n    if (node_to_select !== \"\") {\n        $(\"#hid_cat\").val(node_to_select);\n        $(\"#jstree\").jstree(\"deselect_all\");\n\n        $('#jstree')\n        .one(\"refresh.jstree\", function (e, data) {\n            data.instance.select_node(\"#li_\"+node_to_select);\n        });\n        //.jstree(\"select_node\", \"#li_\"+node_to_select);\n\n    }\n\n    if (refresh_visible_folders === 1) {\n        refreshVisibleFolders();\n    }\n}\n\n/*\n* refreshes the various lists of folders used in dialogboxes\n*/\nfunction refreshVisibleFolders()\n{\n    $.post(\n        \"sources/items.queries.php\",\n        {\n            type    : \"refresh_visible_folders\",\n            key        : \"<?php echo $_SESSION['key']; ?>\"\n        },\n        function(data) {\n            data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n            //check if format error\n            if (data.error == \"\") {\n                // append new list\n                $(\"#categorie, #edit_categorie, #new_rep_groupe, #edit_folder_folder, #delete_rep_groupe\").find('option').remove().end().append(data.selectVisibleFoldersOptions);\n                $(\"#move_folder_id\").find('option').remove().end().append(data.selectFullVisibleFoldersOptions);\n                $(\"#copy_in_folder\").find('option').remove().end().append(data.selectVisibleActiveFoldersOptions);\n\n                // remove ROOT option if exists\n                $('#edit_folder_folder option[value=\"0\"]').remove();\n                $('#delete_rep_groupe option[value=\"0\"]').remove();\n            }\n        }\n   );\n}\n\n\n//###########\n//## EXECUTE WHEN PAGE IS LOADED\n//###########\n$(function() {\n\n    var clear_tp_clipboard = new Clipboard(\"#but_empty_clipboard\", {\n        text: function() {\n            return \"cleared\";\n        }\n    });\n    clear_tp_clipboard.on('success', function(e) {\n        $(\"#message_box\").html(\"super\").show().fadeOut(1000);\n\n        e.clearSelection();\n    });\n\n    $.ajaxSetup({\n        error: function(jqXHR, exception) {\n            if (jqXHR.status === 0) {\n                console.log('Not connect.\\nVerify Network.');\n            } else if (jqXHR.status == 404) {\n                alert('Requested page not found. [404]');\n            } else if (jqXHR.status == 500) {\n                alert('Internal Server Error [500].');\n            } else if (exception === 'parsererror') {\n                alert('Requested JSON parse failed.');\n            } else if (exception === 'timeout') {\n                alert('Time out error.');\n            } else if (exception === 'abort') {\n                alert('Ajax request aborted.');\n            } else {\n                alert('Uncaught Error.n' + jqXHR.responseText);\n            }\n        }\n    });\n\n    // manage item div resize\n    $( \"#item_details_scroll\" ).resizable({handles: {'s': '#handle'}});\n    $(\"#handle\").dblclick(function() {\n        var inner = $(\"#item_details_scroll\").find('table');\n        var current_height = $(\"#item_details_scroll\").height();\n        $(\"#item_details_scroll\").animate({top:'+='+(current_height-inner.height())}, 0);\n        $(\"#item_details_scroll\").height(inner.outerHeight(true));\n    });\n\n    $('#toppathwrap').addClass(\"hidden\");\n    if ($(\".tr_fields\") != undefined) $(\".tr_fields\").addClass(\"hidden\");\n    //Expend/Collapse jstree\n    $(\"#jstree_close\").click(function() {\n        $(\"#jstree\").jstree(\"close_all\");\n    });\n    $(\"#jstree_open\").click(function() {\n        $(\"#jstree\").jstree(\"open_all\");\n    });\n    $(\"#jstree_search\").keypress(function(e) {\n        if (e.keyCode == 13) {\n            $(\"#jstree\").jstree(\"search\",$(\"#jstree_search\").val());\n        }\n    });\n\n    $(\".quick_menu\").menu({\n        icons: { submenu: \"no-icon\" }\n    });\n    $(\".quick_menu_left\").menu({\n        position: {\n            my : \"right top\",\n            at : \"left top\"\n        }\n    });\n\n    $('.menu_200, .menu_150').on('blur', function () {\n        $(this).addClass(\"hidden\");\n    });\n\n    $(\"#pw_size, #edit_pw_size\").spinner({\n        min:   3,\n        step:  1,\n        numberFormat: \"n\"\n    });\n\n    //Disable menu buttons\n    $('#menu_button_edit_item,#menu_button_del_item,#menu_button_add_fav,#menu_button_del_fav').attr('disabled', 'disabled');\n\n    //DIsable more buttons if read only user\n    if ($(\"#user_is_read_only\").val() == 1) {\n        $('#menu_button_add_item, #menu_button_add_group, #menu_button_edit_group, #menu_button_del_group').attr('disabled', 'disabled');\n    }\n\n    // Autoresize Textareas\n    $(\".items_tree, #items_content\").addClass(\"ui-corner-all\");\n\n    //automatic height\n    var window_height = $(window).height();\n    $(\"#div_items, #content\").height(window_height-170);\n    $(\"#items_center\").height(window_height-390);\n    $(\"#items_list\").height(window_height-440);\n    $(\".items_tree\").height(window_height-160);\n    $(\"#jstree\").height(window_height-185);\n\n    //warning if screen height too short\n    if (parseInt(window_height-440) <= 30) {\n        $(\"#div_dialog_message_text\").html(\"<?php echo addslashes($LANG['warning_screen_height']); ?>\");\n        $(\"#div_dialog_message\").dialog('open');\n    }\n\n    //Evaluate number of items to display - depends on screen height\n    if (parseInt($(\"#nb_items_to_display_once\").val()) || $(\"#nb_items_to_display_once\").val() == \"max\") {\n        //do nothing ... good value\n    } else {\n        //adapt to the screen height\n        $(\"#nb_items_to_display_once\").val(Math.max(Math.round((window_height-450)/23),2));\n    }\n\n    // Build buttons\n    $(\"#custom_pw, #edit_custom_pw\").buttonset();\n    $(\".cpm_button, #anyone_can_modify, #annonce, #edit_anyone_can_modify, #edit_annonce, .button\").button();\n\n    //Build multiselect box\n\n    //Build tree\n    $('#jstree').jstree({\n        \"core\" : {\n            \"animation\" : 0,\n            \"check_callback\" : true,\n            'data' : {\n                'url' : \"./sources/tree.php\",\n                \"dataType\" : \"json\",\n                \"async\" : true,\n                'data' : function (node) {\n                    return { 'id' : node.id.split('_')[1] };\n                }\n            },\n            \"strings\" : {\n                \"Loading ...\" : \"<?php echo addslashes($LANG['loading']); ?>...\"\n            },\n            \"error\" : {\n\n            }\n        },\n        \"plugins\" : [\n            \"state\", \"search\"\n        ]\n    })\n    //search in tree\n    .bind(\"search.jstree\", function (e, data) {\n        if (data.nodes.length == 1) {\n            //open the folder\n            ListerItems($(\"#jstree li>a.jstree-search\").attr('id').split('_')[1], '', 0);\n        }\n    });\n\n    // load list of visible folders for current user\n    refreshVisibleFolders();\n\n    $(\"#add_folder\").click(function() {\n        var posit = $('#item_selected').val();\n        //alert($(\"ul\").text());\n    });\n\n    $(\"#for_searchtext\").addClass(\"hidden\");\n    $(\"#copy_pw_done\").addClass(\"hidden\");\n    $(\"#copy_login_done\").addClass(\"hidden\");\n\n    //PREPARE DIALOGBOXES\n    //=> ADD A NEW GROUP\n    $(\"#div_ajout_rep\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 500,\n        height: 280,\n        title: \"<?php echo addslashes($LANG['item_menu_add_rep']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['save_button']); ?>\": function() {\n                AddNewFolder();\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                $(\"#new_rep_show_error\").html(\"\").addClass(\"hidden\");\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\"#new_rep_show_error\").addClass(\"hidden\");\n            $(\"#new_rep_show_error\").html(\"\");\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n        }\n    });\n    //<=\n    //=> EDIT A GROUP\n    $(\"#div_editer_rep\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 490,\n        height: 280,\n        title: \"<?php echo addslashes($LANG['item_menu_edi_rep']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['save_button']); ?>\": function() {\n                //Do some checks\n                $(\"#edit_rep_show_error\").addClass(\"hidden\");\n                if ($(\"#edit_folder_title\").val() == \"\") {\n                    $(\"#edit_rep_show_error\").html(\"<?php echo addslashes($LANG['error_group_label']); ?>\");\n                    $(\"#edit_rep_show_error\").show();\n                } else if ($(\"#edit_folder_folder\").val() == \"0\") {\n                    $(\"#edit_rep_show_error\").html(\"<?php echo addslashes($LANG['error_group']); ?>\");\n                    $(\"#edit_rep_show_error\").show();\n                } else if ($(\"#edit_folder_complexity\").val() == \"\") {\n                    $(\"#edit_rep_show_error\").html(\"<?php echo addslashes($LANG['error_group_complex']); ?>\");\n                    $(\"#edit_rep_show_error\").show();\n                } else if (/^\\d+$/.test($(\"#edit_folder_title\").val())) {\n                    $(\"#edit_rep_show_error\").html(\"<?php echo addslashes($LANG['error_only_numbers_in_folder_name']); ?>\");\n                    $(\"#edit_rep_show_error\").show();\n                } else {\n                    $(\"#edit_folder_loader\").show();\n                    $(\"#div_editer_rep ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", true);\n\n                    //prepare data\n                    var data = {\"title\": $('#edit_folder_title').val().replace(/\"/g,'&quot;'),\n                        \"complexity\": $('#edit_folder_complexity').val(),\n                        \"folder\": $('#edit_folder_folder').val()};\n\n                    //Send query\n                    $.post(\n                        \"sources/items.queries.php\",\n                        {\n                            type    : \"update_folder\",\n                            data      : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                            key        : \"<?php echo $_SESSION['key']; ?>\"\n                        },\n                        function(data) {\n                            //check if format error\n                            if (data[0].error == \"\") {\n                                refreshTree($('#edit_folder_folder').val());\n                                $(\"#folder_name_\"+$('#edit_folder_folder').val()).text($('#edit_folder_title').val());\n                                $(\"#path_elem_\"+$('#edit_folder_folder').val()).text($('#edit_folder_title').val());\n                                $(\"#fld_\"+$('#edit_folder_folder').val()).html($('#edit_folder_title').val());\n                                $(\"#edit_folder_title\").val($('#edit_folder_title').val());\n                                $(\"#div_editer_rep\").dialog(\"close\");\n                            } else {\n                                if (data[0].error === \"ERR_TITLE_ONLY_WITH_NUMBERS\") {\n                                    $(\"#edit_rep_show_error\").html('<?php echo addslashes($LANG['error_only_numbers_in_folder_name']); ?>').show();\n                                } else {\n                                    $(\"#edit_rep_show_error\").html(data[0].error).show();\n                                }\n\n                            }\n                            $(\"#edit_folder_loader\").addClass(\"hidden\");\n                            $(\"#div_editer_rep ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                        },\n                        \"json\"\n                   );\n                }\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                $(\"#edit_folder_loader\").addClass(\"hidden\");\n                $(\"#edit_rep_show_error\").html(\"\").addClass(\"hidden\");\n                $(\"#div_editer_rep ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n        }\n    });\n    //<=\n\n    // =>\n    $(\"#div_copy_item_to_folder\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 400,\n        height: 250,\n        title: \"<?php echo addslashes($LANG['item_menu_copy_elem']); ?>\",\n        open: function( event, ui ) {\n            $(\"#copy_in_folder\").select2({\n                language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n            });\n            $(\":button:contains('<?php echo addslashes($LANG['ok']); ?>')\").prop(\"disabled\", false);\n            $(\"#copy_item_info\").addClass(\"ui-state-highlight ui-corner-all\").addClass(\"hidden\");\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n            $(\"#div_copy_item_to_folder_item\").html(\"<center>\"+$(\"#id_label\").html()+\"</center>\");\n        },\n        buttons: {\n            \"<?php echo addslashes($LANG['ok']); ?>\": function() {\n                $(\"#copy_item_info\").addClass(\"ui-state-highlight ui-corner-all\").show().html(\"<span><?php echo addslashes($LANG['please_wait']).\" <i class=\\'fa fa-cog fa-spin'></i>\"; ?></span>\");\n                $(\":button:contains('<?php echo addslashes($LANG['ok']); ?>')\").prop(\"disabled\", true);\n                //Send query\n                $.post(\n                    \"sources/items.queries.php\",\n                    {\n                        type        : \"copy_item\",\n                        item_id     : $('#id_item').val(),\n                        source_id   : $('#hid_cat').val(),\n                        dest_id     : $('#copy_in_folder').val(),\n                        key         : \"<?php echo $_SESSION['key']; ?>\"\n                    },\n                    function(data) {\n                        //check if format error\n                        if (data[0].error !== \"\") {\n                            $(\"#copy_item_to_folder_show_error\").html(data[1].error_text).show(1).delay(2000).fadeOut(1000);\n                        }\n                        //if OK\n                        if (data[0].status == \"ok\") {\n                            //window.location.href = \"index.php?page=items&group=\"+$('#copy_in_folder').val()+\"&id=\"+data[1].new_id;\n                            ListerItems($('#copy_in_folder').val(),'', 0);\n                            AfficherDetailsItem(data[1].new_id);\n                            refreshTree($('#copy_in_folder').val());\n                            $(\"#copy_in_folder\").val(\"\");\n                            $(\"#div_copy_item_to_folder\").dialog('close');\n                        }\n                        $(\"#copy_item_info\").addClass(\"hidden\");\n                    },\n                    \"json\"\n               );\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                $(\"#copy_item_to_folder_show_error\").html(\"\").addClass(\"hidden\");\n                $(\"#div_copy_item_to_folder\").dialog('close');\n            }\n        }\n    });\n    // <=\n\n    //=> MOVE A GROUP\n    $(\"#div_move_folder\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 350,\n        height: 250,\n        title: \"<?php echo addslashes($LANG['item_menu_mov_rep']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['save_button']); ?>\": function() {\n                //Do some checks\n                $(\"#move_rep_show_error\").addClass(\"hidden\");\n                if ($(\"#move_folder_id\").val() == \"0\") {\n                    $(\"#move_rep_show_error\").html(\"<?php echo addslashes($LANG['error_group']); ?>\");\n                    $(\"#move_rep_show_error\").show();\n                } else if($('#hid_cat').val() === $('#move_folder_id').val()) {\n                    // do not move to itself\n                    $(\"#move_rep_show_error\").html(\"<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n                    $(\"#move_rep_show_error\").show();\n                } else {\n                    $(\"#move_folder_loader\").show();\n                    $(\"#div_editer_rep ~ .ui-dialog-buttonpane\")\n                        .find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\")\n                        .prop(\"disabled\", true);\n\n                    //prepare data\n                    var data = {\"source_folder_id\": $('#hid_cat').val(),\n                        \"target_folder_id\": $('#move_folder_id').val()};\n\n                    //Send query\n                    $.post(\n                        \"sources/items.queries.php\",\n                        {\n                            type    : \"move_folder\",\n                            data    : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                            key     : \"<?php echo $_SESSION['key']; ?>\"\n                        },\n                        function(data) {\n                            //check if format error\n                            if (data[0].error == \"\") {\n                                $(\"#div_move_folder ~ .ui-dialog-buttonpane\")\n                                    .find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                                ListerItems($('#hid_cat').val(), \"\", 0);\n                                $(\"#move_folder_loader\").addClass(\"hidden\");\n                                refreshTree();\n                                $(\"#div_move_folder\").dialog(\"close\");\n                            } else {\n                                $(\"#move_rep_show_error\").html(data[0].error).show();\n                            }\n                            $(\"#move_folder_loader\").addClass(\"hidden\");\n                        },\n                        \"json\"\n                   );\n                }\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                $(\"#edit_rep_show_error\").html(\"\").addClass(\"hidden\");\n                $(\"#div_editer_rep ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                $(\"#move_rep_show_error\").html(\"\").addClass(\"hidden\");\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n        }\n    });\n    //<=\n\n\n    //=> COPY OF FOLDER\n    $(\"#div_copy_folder\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 500,\n        height: 290,\n        title: \"<?php echo addslashes($LANG['copy_folder']); ?>\",\n        close: function () {\n            $(\"#copy_folder_source_id, #copy_folder_destination_id\").children('option').remove();\n            $(\"#div_copy_folder_msg\")\n                .html('')\n                .removeClass(\"ui-state-highlight\")\n                .addClass(\"hidden\");\n        },\n        open: function(event,ui) {\n            $(\"#div_copy_folder ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n\n            // get list of folders\n                $.post(\n                    \"sources/folders.queries.php\",\n                    {\n                        type    : \"get_list_of_folders\",\n                        key     : \"<?php echo $_SESSION['key']; ?>\"\n                    },\n                    function(data) {\n                        $(\"#div_loading\").addClass(\"hidden\");\n\n                        //display to user\n                        $(\"#copy_folder_source_id, #copy_folder_destination_id\").append(data[0].list_folders);\n\n                        $(\"#copy_folder_source_id\").val($(\"#hid_cat\").val());\n                    },\n                    \"json\"\n                );\n        },\n        buttons: {\n            \"<?php echo addslashes($LANG['save_button']); ?>\": function() {\n                //Do some checks\n                if ($(\"#copy_folder_source_id\").val() === \"\" || $(\"#copy_folder_destination_id\").val() === \"\") {\n                    $(\"#div_copy_folder_msg\")\n                        .html('<i class=\"fa fa-warning\"></i>&nbsp;<?php echo addslashes($LANG['error_must_enter_all_fields']); ?>')\n                        .addClass(\"ui-state-error\")\n                        .show().delay(2000).fadeOut(1000);\n                        return false;\n                }\n\n                if ($(\"#copy_folder_source_id\").val() === $(\"#copy_folder_destination_id\").val()) {\n                    $(\"#div_copy_folder_msg\")\n                        .html('<i class=\"fa fa-warning\"></i>&nbsp;<?php echo addslashes($LANG['error_source_and_destination_are_equal']); ?>')\n                        .addClass(\"ui-state-error\")\n                        .show().delay(2000).fadeOut(1000);\n                        return false;\n                }\n\n\n                $(\"#div_copy_folder_msg\")\n                    .html('<i class=\"fa fa-cog fa-spin\"></i>&nbsp;<?php echo addslashes($LANG['please_wait']); ?>')\n                    .addClass(\"ui-state-highlight\")\n                    .show();\n\n                //prepare data\n                var data = {\"source_folder_id\": $('#copy_folder_source_id').val(),\n                    \"target_folder_id\": $('#copy_folder_destination_id').val()};\n\n                //Send query\n                $.post(\n                    \"sources/folders.queries.php\",\n                    {\n                        type    : \"copy_folder\",\n                        data    : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                        key     : \"<?php echo $_SESSION['key']; ?>\"\n                    },\n                    function(data) {\n                        //check if format error\n                        if (data[0].error == \"\") {\n                            $(\"#div_copy_folder ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                            refreshTree();\n                            $(\"#div_copy_folder\").dialog(\"close\");\n                        } else {\n                            $(\"#div_copy_folder_msg\").html(data[0].error).show().delay(2000).fadeOut(1000);\n                        }\n                    },\n                    \"json\"\n                );\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                $(\"#div_copy_folder_msg\").html(\"\").addClass(\"hidden\");\n                $(\"#div_copy_folder ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                $(this).dialog('close');\n            }\n        }\n    });\n    //<=\n\n    //=> DELETE A GROUP\n    $(\"#div_supprimer_rep\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 600,\n        height: 230,\n        title: \"<?php echo addslashes($LANG['item_menu_del_rep']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['delete']); ?>\": function() {\n                SupprimerFolder();\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n        },\n        close: function() {\n            $(\"#delete_rep_groupe_validate\").prop(\"checked\", false);\n            $(\"#del_rep_show_error\").html(\"\").addClass(\"hidden\");\n        }\n    });\n    //<=\n    //=> ADD A NEW ITEM\n    $(\"#div_formulaire_saisi\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 505,\n        height: 680,\n        title: \"<?php echo addslashes($LANG['item_menu_add_elem']); ?>\",\n        open: function( event, ui ) {\n            $(\".ui-dialog-buttonpane button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").button(\"disabled\");\n        },\n        buttons: {\n            \"<?php echo addslashes($LANG['save_button']); ?>\": function() {\n                $(\"#div_loading\").removeClass(\"hidden\");\n                $(\".ui-dialog-buttonpane button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").button(\"enable\");\n                AjouterItem();\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                //Clear upload queue\n                $('#item_file_queue').html('');\n                //Select 1st tab\n                $(\"#item_tabs\").tabs({ selected: 0 });\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\"#label\").focus();\n            $(\"#visible_pw\").html(\"\");\n            $(\"#item_tabs\").tabs(\"option\", \"active\", 0);\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n\n            // show tab fields ? Not if PersonalFolder\n            if ($(\"#recherche_group_pf\").val() == 1) {\n                if ($(\"#form_tab_fields\") != undefined)\n                    $(\"#item_tabs\").tabs(\"option\", \"hidden\", 3);\n            } else {\n                if ($(\"#form_tab_fields\") != undefined && $(\"#display_categories\").val() != 1)\n                    $(\"#item_tabs\").tabs(\"option\", \"show\", 3);\n            }\n\n            // hide complexity if PF\n            if ($(\"#pf_selected\").val() == 1) {\n                $(\"#expected_complexity\").addClass(\"hidden\");\n            } else {\n                $(\"#expected_complexity\").show();\n            }\n\n            $(\"#categorie\").select2({\n                language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n            });\n        },\n        close: function(event,ui) {\n            if (CKEDITOR.instances[\"desc\"]) {\n                CKEDITOR.instances[\"desc\"].destroy();\n            }\n            $(\"#item_upload_list\").html(\"\");\n            $(\".item_field\").val(\"\");  // clean values in Fields\n            $(\"#pw1\").focus();\n            $(\"#new_show_error\").html(\"\").addClass(\"hidden\");\n            $(\".ui-dialog-buttonpane button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").button(\"enable\");\n            $(\"#div_loading\").addClass(\"hidden\");\n        }\n    });\n    //<=\n    //=> EDITER UN ELEMENT\n    $(\"#div_formulaire_edition_item\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 505,\n        height: 680,\n        title: \"<?php echo addslashes($LANG['item_menu_edi_elem']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['save_button']); ?>\": function() {\n                $(\"#div_formulaire_edition_item ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", true);\n                EditerItem();\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                //Clear upload queue\n                $('#item_edit_file_queue').html('');\n                //Select 1st tab\n                $(\"#item_edit_tabs\").tabs({ selected: 0 });\n                $(\"#div_loading\").addClass(\"hidden\");\n                //Close dialog box\n                $(this).dialog('close');\n            }\n        },\n        close: function(event,ui) {\n            if (CKEDITOR.instances[\"edit_desc\"]) {\n                CKEDITOR.instances[\"edit_desc\"].destroy();\n            }\n            if (CKEDITOR.instances[\"desc\"]) {\n                CKEDITOR.instances[\"desc\"].destroy();\n            }\n            $(\"#div_loading, #edit_show_error\").addClass(\"hidden\");\n            $(\"#item_edit_upload_list\").html(\"\");\n            $(\".edit_item_field\").val(\"\");  // clean values in Fields\n            //Unlock the Item\n            $.post(\n                \"sources/items.queries.php\",\n                {\n                    type    : \"free_item_for_edition\",\n                    id      : $(\"#id_item\").val(),\n                    key        : \"<?php echo $_SESSION['key']; ?>\"\n                }\n            );\n            $(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n        },\n        open: function(event,ui) {\n            //refresh pw complexity\n            $(\"#item_edit_tabs\").tabs( \"option\", \"active\",1  );\n            $(\"#edit_pw1\").first().focus();\n            $(\"#item_edit_tabs\").tabs( \"option\", \"active\",0  );\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n\n            // show tab fields ? Not if PersonalFolder\n            if ($(\"#recherche_group_pf\").val() == 1) {\n                if ($(\"#edit_item_more\") != undefined) $(\"#edit_item_more\").addClass(\"hidden\");\n            } else {\n                if ($(\"#edit_item_more\") != undefined && $(\"#display_categories\").val() != 1)\n                    $(\"#edit_item_more\").show();\n            }\n            $(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n\n            // hide complexity if PF\n            if ($(\"#pf_selected\").val() == 1) {\n                $(\"#edit_expected_complexity\").addClass(\"hidden\");\n            } else {\n                $(\"#edit_expected_complexity\").show();\n            }\n\n            $(\"#edit_categorie\").select2({\n                language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n            });\n\n            // get list of Users\n            $.post(\n                \"sources/items.queries.php\",\n                {\n                    type    : \"build_list_of_users\",\n                    key     : \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data) {\n                    //decrypt data\n                    try {\n                        data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                    } catch (e) {\n                        // error\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#div_dialog_message_text\").html(\"An error appears. Answer from Server cannot be parsed!<br /><br />Returned data:<br />\"+data);\n                        $(\"#div_dialog_message\").show();\n                        return;\n                    }\n\n                    if (data.error === \"\") {\n                        var list = data.list.split(';');\n                        for (var i=0; i<list.length; i++) {\n                            var elem = list[i].split('#');\n                            if (elem[0] != \"\") {\n                                $(\"#edit_restricted_to_list\").append(\"<option value='\"+elem[0]+\"'>\"+elem[1]+\"</option>\");\n                                var index = $('#edit_restricted_to').val().lastIndexOf(elem[1]+\";\");\n                                if (index != -1) {\n                                    $(\"#edit_restricted_to_list option[value=\"+elem[0]+\"]\").attr('selected', true);\n                                }\n                            }\n                        }\n                    }\n                }\n           );\n        }\n    });\n    //<=\n    //=> SUPPRIMER UN ELEMENT\n    $(\"#div_del_item\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 400,\n        height: 220,\n        title: \"<?php echo addslashes($LANG['item_menu_del_elem']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['del_button']); ?>\": function() {\n                $.post(\n                    \"sources/items.queries.php\",\n                    {\n                        type        : \"del_item\",\n                        id          : $(\"#id_item\").val(),\n                        categorie   : $('#hid_cat').val(),\n                        label       : $(\"#hid_label\").val(),\n                        key         : \"<?php echo $_SESSION['key']; ?>\"\n                    },\n                    function(data) {\n                        $(\"#div_loading\").removeClass(\"hidden\");\n\n                        // refresh list of items\n                        $(\"#full_items_list\").html(\"\");\n                        ListerItems($('#hid_cat').val(), \"\", 0)\n\n                        // reload tree\n                        refreshTree($('#hid_cat').val());\n\n                        // clean fields\n                        $(\"#id_label, #id_desc, #id_pw, #id_login, #id_email, #id_url, #id_files, #id_restricted_to ,#id_tags, #id_kbs\").html(\"\");\n                        $(\"#button_quick_login_copy, #button_quick_pw_copy\").addClass(\"hidden\");\n                        $(\"#selected_items\").val(\"\");\n\n                        $(\"#div_loading\").addClass(\"hidden\");\n                    }\n               );\n                $(this).dialog('close');\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n            $(\"#div_del_item_selection\").html(\"<center>\"+$(\"#id_label\").html()+\"</center>\");\n        }\n    });\n    //<=\n    //=> SHOW LINK COPIED DIALOG\n    $(\"#div_item_copied\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 500,\n        height: 200,\n        title: \"<?php echo addslashes($LANG['admin_main']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['close']); ?>\": function() {\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n        }\n    });\n    //<=\n    //=> SHOW HISTORY DIALOG\n    $(\"#div_item_history\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 650,\n        height: 400,\n        title: \"<?php echo addslashes($LANG['history']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['close']); ?>\": function() {\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n\n            // load content\n            const data = {\"id\":$(\"#id_item\").val()};\n            $.post(\n                \"sources/items.queries.php\",\n                {\n                    type    : \"load_item_history\",\n                    data    : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key     : \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data) {\n                    //decrypt data\n                    try {\n                        data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                    } catch (e) {\n                        // error\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#div_dialog_message_text\").html(\"An error appears. Answer from Server cannot be parsed!<br /><br />Returned data:<br />\"+data);\n                        $(\"#div_dialog_message\").show();\n                        return;\n                    }\n\n                    if (data.error === \"\") {\n                        $(\"#item_history_log\").html(data.new_html);\n                    }\n                }\n           );\n        }\n    });\n    //<=\n    //=> SHOW SHARE DIALOG\n    $(\"#div_item_share\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 500,\n        height: 200,\n        title: \"<?php echo addslashes($LANG['share']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['send']); ?>\": function() {\n                $(\"#div_item_share_error\").addClass(\"hidden\");\n                if (IsValidEmail($(\"#item_share_email\").val())) {    //check if email format is ok\n                    $(\"#div_item_share_status\").show();\n                    $.post(\n                        \"sources/items.queries.php\",\n                        {\n                            type    : \"send_email\",\n                            id      : $(\"#id_item\").val(),\n                            receipt    : $(\"#item_share_email\").val(),\n                            cat      : \"share_this_item\",\n                            key        : \"<?php echo $_SESSION['key']; ?>\"\n                        },\n                        function(data) {\n                            $(\"#div_item_share_status\").html(\"\").addClass(\"hidden\");\n                            if (data[0].error == \"\") {\n                                $(\"#div_item_share_error\").html(\"<?php echo addslashes($LANG['share_sent_ok']); ?>\").show();\n                            } else {\n                                $(\"#div_item_share_error\").html(data[0].message).show();\n                            }\n                        },\n                        \"json\"\n                   );\n                } else {\n                    $(\"#div_item_share_error\").html(\"<?php echo addslashes($LANG['bad_email_format']); ?>\").show();\n                }\n            },\n            \"<?php echo addslashes($LANG['close']); ?>\": function() {\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n        }\n    });\n    //<=\n    //=> SHOW ITEM UPDATED DIALOG\n    $(\"#div_item_updated\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 300,\n        height: 100,\n        title: \"<?php echo addslashes($LANG['share']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['ok']); ?>\": function() {\n\n            }\n        },\n        open: function(event,ui) {\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n        }\n    });\n    //<=\n    //=> SHOW SHARE DIALOG\n    $(\"#div_suggest_change\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 750,\n        height: 450,\n        title: \"<?php echo addslashes($LANG['suggest_password_change']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['ok']); ?>\": function() {\n                $(\"#div_suggest_change_wait\").html('<i class=\"fa fa-cog fa-spin fa-2x\"></i>').show().removeClass(\"ui-state-error\");\n\n                // do checks\n                if (!IsValidEmail($(\"#email_change\").val()) && $(\"#email_change\").val() !== \"\") {\n                    $(\"#div_suggest_change_wait\").html('<i class=\"fa fa-warning fa-lg\"></i>&nbsp;<?php echo addslashes($LANG['email_format_is_not_correct']); ?>').show(1).delay(2000).fadeOut(1000).addClass(\"ui-state-error\");\n                    return false;\n                }\n                if (!validateURL($(\"#url_change\").val()) && $(\"#url_change\").val() !== \"\") {\n                    $(\"#div_suggest_change_wait\").html('<i class=\"fa fa-warning fa-lg\"></i>&nbsp;<?php echo addslashes($LANG['url_format_is_not_correct']); ?>').show(1).delay(2000).fadeOut(1000).addClass(\"ui-state-error\");\n                    return false;\n                }\n\n                // prepare changes\n                var data = {\"label\": $(\"#label_change\").val(), \"pwd\": $(\"#pwd_change\").val(),\n                    \"url\": $(\"#url_change\").val(), \"login\": $(\"#login_change\").val(),\n                    \"email\": $(\"#email_change\").val(), \"folder\": $(\"#hid_cat\").val(),\n                    \"comment\": $(\"#comment_change\").val(), \"item_id\": $(\"#id_item\").val()};\n\n                $.post(\n                    \"sources/items.queries.php\",\n                    {\n                        type    : \"suggest_item_change\",\n                        data    : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                        id      : $(\"#id_item\").val(),\n                        key     : \"<?php echo $_SESSION['key']; ?>\"\n                    },\n                    function(data) {\n                        if (data[0].error === \"\") {\n                            $(\"#div_suggest_change_wait\").html(\"<?php echo addslashes($LANG['suggestion_done']); ?>\").show(1).delay(1500).fadeOut(1000);\n                            setTimeout(\n                                function() {\n                                    $(\"#div_suggest_change\").dialog(\"close\");\n                                },\n                                500\n                            );\n                        }\n                    },\n                    \"json\"\n               );\n            },\n            \"<?php echo addslashes($LANG['close']); ?>\": function() {\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\"#div_suggest_change_html\")\n            .html(\n                '<label class=\"form_label_100\" style=\"padding:4px;\"><?php echo addslashes($LANG['label']); ?></label><input type=\"text\" id=\"label_change\" value=\"'+$(\"#hid_label\").val()+'\" class=\"input_text_80 ui-widget-content ui-corner-all\">' +\n                '<label class=\"form_label_100\" style=\"padding:4px;\"><?php echo addslashes($LANG['pw']); ?></label><input type=\"text\" id=\"pwd_change\" value=\"\" class=\"input_text_80 ui-widget-content ui-corner-all\">' +\n                '&nbsp;<i class=\"fa fa-info-circle fa-lg tip\" title=\"<?php echo addslashes($LANG['suggest_change_password_blank']); ?>\"></i>' +\n                //'<label class=\"form_label_100\" style=\"padding:4px;\"><?php echo addslashes($LANG['description']); ?></label><textarea id=\"description_change_change\" class=\"input_text_80 ui-widget-content ui-corner-all\">'+$(\"#hid_desc\").val()+'</textarea>' +\n                '<label class=\"form_label_100\" style=\"padding:4px;\"><?php echo addslashes($LANG['index_login']); ?></label><input type=\"text\" id=\"login_change\" value=\"'+$(\"#hid_login\").val()+'\" class=\"input_text_80 ui-widget-content ui-corner-all\">' +\n                '<label class=\"form_label_100\" style=\"padding:4px;\"><?php echo addslashes($LANG['email']); ?></label><input type=\"text\" id=\"email_change\" value=\"'+$(\"#hid_email\").val()+'\" class=\"input_text_80 ui-widget-content ui-corner-all\">' +\n                '<label class=\"form_label_100\" style=\"padding:4px;\"><?php echo addslashes($LANG['url']); ?></label><input type=\"text\" id=\"url_change\" value=\"'+$(\"#hid_url\").val()+'\" class=\"input_text_80 ui-widget-content ui-corner-all\">' +\n                '<label class=\"form_label_100\" style=\"padding:4px;\"><?php echo addslashes($LANG['comment']); ?></label><input type=\"text\" id=\"comment_change\" value=\"\" class=\"input_text_80 ui-widget-content ui-corner-all\">'\n            )\n            .show();\n            $(\".tip\").tooltipster({multiple: true});\n        }\n    });\n    //<=\n\n    // => ATTACHMENTS INIT\n    var uploader_attachments = new plupload.Uploader({\n        runtimes : \"html5,flash,silverlight,html4\",\n        browse_button : \"item_attach_pickfiles\",\n        container : \"item_upload\",\n        max_file_size : \"<?php\nif (strrpos($SETTINGS['upload_maxfilesize'], \"mb\") === false) {\n    echo $SETTINGS['upload_maxfilesize'].\"mb\";\n} else {\n    echo $SETTINGS['upload_maxfilesize'];\n}\n?>\",\n        chunk_size : \"1mb\",\n        dragdrop : true,\n        url : \"sources/upload/upload.attachments.php\",\n        flash_swf_url : \"includes/libraries/Plupload/Moxie.swf\",\n        silverlight_xap_url : \"includes/libraries/Plupload/Moxie.xap\",\n        filters : [\n            {title : \"Image files\", extensions : \"<?php echo $SETTINGS['upload_imagesext']; ?>\"},\n            {title : \"Package files\", extensions : \"<?php echo $SETTINGS['upload_pkgext']; ?>\"},\n            {title : \"Documents files\", extensions : \"<?php echo $SETTINGS['upload_docext']; ?>\"},\n            {title : \"Other files\", extensions : \"<?php echo $SETTINGS['upload_otherext']; ?>\"}\n        ],<?php\nif ($SETTINGS['upload_imageresize_options'] == 1) {\n?>\n        resize : {\n            width : <?php echo $SETTINGS['upload_imageresize_width']; ?>,\n            height : <?php echo $SETTINGS['upload_imageresize_height']; ?>,\n            quality : <?php echo $SETTINGS['upload_imageresize_quality']; ?>\n        },\n<?php\n}\n?>\n        init: {\n            BeforeUpload: function (up, file) {\n                $(\"#item_upload_wait\").removeClass(\"hidden\");\n\n                if ($(\"#random_id\").val() == \"\") {\n                    var post_id = CreateRandomString(9,\"num_no_0\");\n                    $(\"#random_id\").val(post_id);\n                }\n\n                up.setOption('multipart_params', {\n                    PHPSESSID : \"<?php echo $_SESSION['user_id']; ?>\",\n                    itemId : $(\"#random_id\").val(),\n                    type_upload : \"item_attachments\",\n                    edit_item : false,\n                    user_token: $(\"#item_user_token\").val(),\n                    files_number: $(\"#files_number\").val()\n                });\n            },\n            UploadComplete: function(up, files) {\n                $(\"#item_upload_wait\").addClass(\"hidden\");\n                $(\"#files_number\").val(0);\n            }\n        }\n    });\n\n    // Uploader options\n    uploader_attachments.bind(\"UploadProgress\", function(up, file) {\n        $(\"#\" + file.id + \" b\").html(file.percent + \"%\");\n        $(\"#remove_\" + file.id).remove();\n    });\n    uploader_attachments.bind(\"Error\", function(up, err) {\n        $(\"#item_upload_list\").html(\n            \"<div class=\\'ui-state-error ui-corner-all\\' style=\\'padding:2px;\\'>Error: \" + err.code +\n            \", Message: \" + err.message +\n            (err.file ? \", File: \" + err.file.name : \"\") +\n            \"</div>\"\n        );\n        up.refresh(); // Reposition Flash/Silverlight\n    });\n    uploader_attachments.bind(\"+\", function(up, file) {\n        $(\"#\" + file.id + \" b\").html(\"100%\");\n    });\n\n    // Load edit uploaded click\n    $(\"#item_attach_uploadfiles\").click(function(e) {\n        // generate and save token\n        $.post(\n            \"sources/main.queries.php\",\n            {\n                type : \"save_token\",\n                size : 25,\n                capital: true,\n                numeric: true,\n                ambiguous: true,\n                reason: \"item_attachments\",\n                duration: 10\n            },\n            function(data) {\n                $(\"#item_user_token\").val(data[0].token);\n                uploader_attachments.start();\n            },\n            \"json\"\n        );\n        e.preventDefault();\n    });\n    uploader_attachments.init();\n    uploader_attachments.bind('FilesAdded', function(up, files) {\n        $.each(files, function(i, file) {\n            $('#item_upload_list').append(\n                '<div id= file.id><span id=\"remove_' + file.id + '>[<a href=\\'#\\' onclick=\\'$(\\\"#' + file.id + '\\\").remove();\\'>-</a>]</span> ' +\n                file.name + ' (' + plupload.formatSize(file.size) + ')' +\n            '</div>');\n            $(\"#files_number\").val(parseInt($(\"#files_number\").val())+1);\n        });\n        up.refresh(); // Reposition Flash/Silverlight\n    });\n\n    // Prepare uplupload object for attachments upload\n    var edit_uploader_attachments = new plupload.Uploader({\n        runtimes : \"html5,flash,silverlight,html4\",\n        browse_button : \"item_edit_attach_pickfiles\",\n        container : \"item_edit_upload\",\n        max_file_size : \"<?php\nif (strrpos($SETTINGS['upload_maxfilesize'], \"mb\") === false) {\n    echo $SETTINGS['upload_maxfilesize'].\"mb\";\n} else {\n    echo $SETTINGS['upload_maxfilesize'];\n}\n?>\",\n        chunk_size : \"1mb\",\n        dragdrop : true,\n        url : \"sources/upload/upload.attachments.php\",\n        flash_swf_url : \"includes/libraries/Plupload/Moxie.swf\",\n        silverlight_xap_url : \"includes/libraries/Plupload/Moxie.xap\",\n        filters : [\n            {title : \"Image files\", extensions : \"<?php echo $SETTINGS['upload_imagesext']; ?>\"},\n            {title : \"Package files\", extensions : \"<?php echo $SETTINGS['upload_pkgext']; ?>\"},\n            {title : \"Documents files\", extensions : \"<?php echo $SETTINGS['upload_docext']; ?>\"},\n            {title : \"Other files\", extensions : \"<?php echo $SETTINGS['upload_otherext']; ?>\"}\n        ],<?php\nif ($SETTINGS['upload_imageresize_options'] == 1) {\n        ?>\n        resize : {\n            width : <?php echo $SETTINGS['upload_imageresize_width']; ?>,\n            height : <?php echo $SETTINGS['upload_imageresize_height']; ?>,\n            quality : <?php echo $SETTINGS['upload_imageresize_quality']; ?>\n        },<?php\n}\n?>\n        init: {\n            BeforeUpload: function (up, file) {\n                $(\"#item_edit_upload_wait\").removeClass(\"hidden\");\n\n                up.setOption('multipart_params', {\n                    PHPSESSID : \"<?php echo $_SESSION['user_id']; ?>\",\n                    itemId : $('#selected_items').val(),\n                    type_upload : \"item_attachments\",\n                    edit_item : true,\n                    user_token: $(\"#item_user_token\").val(),\n                    files_number: $(\"#edit_files_number\").val()\n                });\n            },\n            UploadComplete: function(up, files) {\n                $(\"#item_edit_upload_wait\").addClass(\"hidden\");\n                $(\"#edit_files_number\").val(0);\n            }\n        }\n    });\n\n    // Uploader options\n    edit_uploader_attachments.bind(\"UploadProgress\", function(up, file) {\n        $(\"#\" + file.id + \" b\").html(file.percent + \"%\");\n        $(\"#edit_remove_\" + file.id).remove();\n    });\n    edit_uploader_attachments.bind(\"Error\", function(up, err) {\n        $(\"#item_edit_upload_list\").html(\n            \"<div class=\\'ui-state-error ui-corner-all\\' style=\\'padding:2px;\\'>Error: \" + err.code +\n            \", Message: \" + err.message +\n            (err.file ? \", File: \" + err.file.name : \"\") +\n            \"</div>\"\n        );\n        up.refresh(); // Reposition Flash/Silverlight\n    });\n    edit_uploader_attachments.bind(\"+\", function(up, file) {\n        $(\"#\" + file.id + \" b\").html(\"100%\");\n        $(\"#edit_remove_\" + file.id).remove();\n    });\n\n    // Load edit uploaded click\n    $(\"#item_edit_attach_uploadfiles\").click(function(e) {\n        // generate and save token\n        $.post(\n            \"sources/main.queries.php\",\n            {\n                type : \"save_token\",\n                size : 25,\n                capital: true,\n                numeric: true,\n                ambiguous: true,\n                reason: \"item_attachments\",\n                duration: 30\n            },\n            function(data) {\n                $(\"#item_user_token\").val(data[0].token);\n                edit_uploader_attachments.start();\n            },\n            \"json\"\n        );\n\n        e.preventDefault();\n    });\n    edit_uploader_attachments.init();\n    edit_uploader_attachments.bind('FilesAdded', function(up, files) {\n        $.each(files, function(i, file) {\n            $('#item_edit_upload_list').append(\n                '<div id= file.id><span id=\"edit_remove_' + file.id + '>[<a href=\\'#\\' onclick=\\'$(\\\"#' + file.id + '\\\").remove();\\'>-</a>]</span> ' +\n                file.name + ' (' + plupload.formatSize(file.size) + ')' +\n            '</div>');\n            $(\"#edit_files_number\").val(parseInt($(\"#edit_files_number\").val())+1);\n        });\n        up.refresh(); // Reposition Flash/Silverlight\n    });\n\n    //Launch items loading\n    if ($(\"#jstree_group_selected\").val() == \"\") {\n        var first_group = 1;\n    } else {\n        var first_group = $(\"#jstree_group_selected\").val();\n    }\n\n    if ($(\"#hid_cat\").val() != \"\") {\n        first_group = $(\"#hid_cat\").val();\n    }\n\n    //load items\n    if (parseInt($(\"#query_next_start\").val()) > 0) start = parseInt($(\"#query_next_start\").val());\n    else start = 0;\n\n    // load list of items\n    if (first_group !== \"\") {\n        ListerItems(first_group,'', start);\n    }\n\n    //Load item if needed and display items list\n    if ($(\"#open_id\").val() !== \"\") {\n        AfficherDetailsItem($(\"#open_id\").val());\n        //refreshTree($(\"#hid_cat\").val(), \"0\");\n        $(\"#open_item_by_get\").val(\"\");\n    }\n\n    //Password meter for item creation\n    $(\"#pw1\").simplePassMeter({\n        \"requirements\": {},\n        \"container\": \"#pw_strength\",\n        \"defaultText\" : \"<?php echo addslashes($LANG['index_pw_level_txt']); ?>\",\n        \"ratings\": [\n            {\"minScore\": 0,\n                \"className\": \"meterFail\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level0']); ?>\"\n            },\n            {\"minScore\": 25,\n                \"className\": \"meterWarn\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level1']); ?>\"\n            },\n            {\"minScore\": 50,\n                \"className\": \"meterWarn\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level2']); ?>\"\n            },\n            {\"minScore\": 60,\n                \"className\": \"meterGood\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level3']); ?>\"\n            },\n            {\"minScore\": 70,\n                \"className\": \"meterGood\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level4']); ?>\"\n            },\n            {\"minScore\": 80,\n                \"className\": \"meterExcel\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level5']); ?>\"\n            },\n            {\"minScore\": 90,\n                \"className\": \"meterExcel\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level6']); ?>\"\n            }\n        ]\n    });\n    $('#pw1').bind({\n        \"score.simplePassMeter\" : function(jQEvent, score) {\n            $(\"#mypassword_complex\").val(score);\n        }\n    }).change({\n        \"score.simplePassMeter\" : function(jQEvent, score) {\n            $(\"#mypassword_complex\").val(score);\n        }\n    });\n\n    $(\"#tabs-02\").on(\n        \"score.simplePassMeter\",\n        \"#pw1\",\n        function(jQEvent, score) {\n            $(\"#mypassword_complex\").val(score);\n        }\n    );\n\n\n    //Password meter for item update\n    $(\"#edit_pw1\").simplePassMeter({\n        \"requirements\": {},\n        \"container\": \"#edit_pw_strength\",\n        \"defaultText\" : \"<?php echo addslashes($LANG['index_pw_level_txt']); ?>\",\n        \"ratings\": [\n            {\"minScore\": 0,\n                \"className\": \"meterFail\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level0']); ?>\"\n            },\n            {\"minScore\": 25,\n                \"className\": \"meterWarn\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level1']); ?>\"\n            },\n            {\"minScore\": 50,\n                \"className\": \"meterWarn\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level2']); ?>\"\n            },\n            {\"minScore\": 60,\n                \"className\": \"meterGood\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level3']); ?>\"\n            },\n            {\"minScore\": 70,\n                \"className\": \"meterGood\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level4']); ?>\"\n            },\n            {\"minScore\": 80,\n                \"className\": \"meterExcel\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level5']); ?>\"\n            },\n            {\"minScore\": 90,\n                \"className\": \"meterExcel\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level6']); ?>\"\n            }\n        ]\n    });\n    $('#edit_pw1').on(\n        \"score.simplePassMeter\", function(jQEvent, score) {\n            $(\"#edit_mypassword_complex\").val(score);\n        }\n    );\n\n    //Text search watermark\n    var tbval = $('#jstree_search').val();\n    $('#jstree_search').focus(function() { $(this).val('');});\n    $('#jstree_search').blur(function() { $(this).val(tbval);});\n    $('#search_item').focus(function() { $(this).val('');});\n    $('#search_item').blur(function() { $(this).val(tbval);});\n\n    //add date selector\n    $(\".datepicker\").datepicker({\n        dateFormat:\"<?php echo str_replace(array(\"Y\", \"M\"), array(\"yy\", \"mm\"), $SETTINGS['date_format']); ?>\",\n        changeMonth: true,\n        changeYear: true\n    });\n\n    //autocomplete for TAGS\n    $(\"#item_tags, #edit_tags\")\n        .focus()\n        .bind( \"keydown\", function( event ) {\n            if ( event.keyCode === $.ui.keyCode.TAB &&\n                    $( this ).data( \"autocomplete\" ).menu.active ) {\n                event.preventDefault();\n            }\n        })\n        .autocomplete({\n            //source: 'sources/items.queries.php?type=autocomplete_tags',\n            source: function( request, response ) {\n                $.getJSON( \"sources/items.queries.php?type=autocomplete_tags&t=1\", {\n                    term: extractLast( request.term )\n                }, response );\n            },\n            focus: function() {\n                // prevent value inserted on focus\n                return false;\n            },\n            search: function() {\n                var term = extractLast( this.value );\n            },\n            select: function( event, ui ) {\n                var terms = split( this.value );\n                // remove the current input\n                terms.pop();\n                // add the selected item\n                terms.push( ui.item.value );\n                // add placeholder to get the comma-and-space at the end\n                terms.push( \"\" );\n                this.value = terms.join( \" \" );\n\n                return false;\n            }\n        }\n    );\n\n    //DIALOG FOR OFFLINE MODE\n    $(\"#dialog_offline_mode\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 500,\n        height: 350,\n        title: \"<?php echo addslashes($LANG['offline_menu_title']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['button_offline_generate']); ?>\": function() {\n                generateOfflineFile();\n            },\n            \"<?php echo addslashes($LANG['close']); ?>\": function() {\n                $(this).dialog(\"close\");\n            }\n        },\n        close: function() {\n            $(\"#div_offline_mode\").html(\"<i class=\\\"fa fa-cog fa-spin fa-2x\\\"></i>\");\n        }\n    });\n\n    //DIALOG FOR EXPORT FILE\n    $(\"#dialog_export_file\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 500,\n        height: 350,\n        title: \"<?php echo addslashes($LANG['print_out_menu_title']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['button_export_file']); ?>\": function() {\n                exportItemsToFile();\n            },\n            \"<?php echo addslashes($LANG['close']); ?>\": function() {\n                $(this).dialog(\"close\");\n            }\n        },\n        close: function() {\n            $(\"#div_export_file\").html(\"<i class=\\\"fa fa-cog fa-spin fa-2x\\\"></i>\");\n        }\n    });\n\n    //DIALOG FOR IMPORT FILE\n    $(\"#dialog_import_file\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 600,\n        height: 500,\n        title: \"<?php echo addslashes($LANG['import_csv_menu_title']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['close']); ?>\": function() {\n                $(this).dialog(\"close\");\n            }\n        },\n        close: function() {\n            $(\"#div_import_file\").html(\"<i class=\\\"fa fa-cog fa-spin fa-2x\\\"></i>\");\n        }\n    });\n\n\n    // DIALOG BOX FOR PERSONAL PASSWORDS UPGRADE\n    $(\"#dialog_upgrade_personal_passwords\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 500,\n        height: 300,\n        title: \"<?php echo addslashes($LANG['upgrade_needed']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['admin_action_db_backup_start_tip']); ?>\": function() {\n                $(\"#dialog_upgrade_personal_passwords_status\").html('<i class=\"fa fa-cog fa-spin\"></i>&nbsp;<?php echo addslashes($LANG['please_wait']); ?>&nbsp;...&nbsp;<span id=\"reencryption_progress\">0%</span>').attr(\"class\",\"\").show();\n                $.post(\n                    \"sources/utils.queries.php\",\n                    {\n                        type    : \"reencrypt_personal_pwd_start\",\n                        user_id : \"<?php echo $_SESSION['user_id']; ?>\",\n                        key     : \"<?php echo $_SESSION['key']; ?>\"\n                    },\n                    function(data) {\n                        if (data[0].error != \"\") {\n                            $(\"#dialog_upgrade_personal_passwords_status\").html(data[0].error).addClass(\"ui-state-error\").show();\n                        } else {\n                            reEncryptPersonalPwds(data[0].pws_list, data[0].currentId, data[0].nb);\n                        }\n                    },\n                    \"json\"\n                );\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                $(this).dialog(\"close\");\n            }\n        }\n    });\n\n    //DIALOG FOR SSH\n    $(\"#dialog_ssh\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 620,\n        height: 500,\n        title: \"<?php echo addslashes($LANG['update_server_password']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['close']); ?>\": function() {\n                $(this).dialog(\"close\");\n            }\n        },\n        close: function() {\n            $(\"#div_ssh\").html(\"<i class=\\'fa fa-cog fa-spin fa-2x\\'></i>&nbsp;<b><?php echo addslashes($LANG['please_wait']); ?></b>\");\n        }\n    });\n\n    //Simulate a CRON activity (only 8 secs after page loading)\n    setTimeout(\n        function() {\n            // send email\n            $.post(\n                \"sources/main.queries.php\",\n                {\n                    type : \"send_waiting_emails\",\n                    key     : \"<?php echo $_SESSION['key']; ?>\"\n                }\n            );\n\n            // send statistics\n            $.post(\n                \"sources/main.queries.php\",\n                {\n                    type : \"sending_statistics\",\n                    key     : \"<?php echo $_SESSION['key']; ?>\"\n                }\n            );\n        },\n        8000\n    );\n\n    NProgress.done();\n});\n\n// show password during longpress\nvar mouseStillDown = false;\n$('#item_details_ok').on('mousedown', '.unhide_masked_data', function(event) {\n    mouseStillDown = true;\n     showPwdContinuous($(this).attr('id'));\n}).on('mouseup', '.unhide_masked_data', function(event) {\n     mouseStillDown = false;\n}).on('mouseleave', '.unhide_masked_data', function(event) {\n     mouseStillDown = false;\n});\nvar showPwdContinuous = function(elem_id){\n    if(mouseStillDown){\n        $('#'+elem_id).text($('#h'+elem_id).val());\n        setTimeout(\"showPwdContinuous('\"+elem_id+\"')\", 50);\n        // log password is shown\n        if (elem_id === \"id_pw\" && $(\"#pw_shown\").val() == \"0\") {\n            itemLog(\"item_password_shown\");\n            $(\"#pw_shown\").val(\"1\");\n        }\n    } else {\n        $('#'+elem_id).html('<?php echo $var['hidden_asterisk']; ?>');\n        $('.tip').tooltipster({multiple: true});\n    }\n}\n\nvar showPwd = function(){\n    $(\"#visible_pw, #edit_visible_pw\").toggle();\n}\n\n/*\n* permits to save\n*/\nfunction itemLog(log_case)\n{\n    $.post(\n        \"sources/items.logs.php\",\n        {\n            type        : log_case,\n            id_item     : $('#id_item').val(),\n            folder_id   : $('#hid_cat').val(),\n        hid_label   : $('#hid_label').val(),\n            key         : \"<?php echo $_SESSION['key']; ?>\"\n        }\n    );\n}\n\nfunction htmlspecialchars_decode (string, quote_style)\n{\n    if (string != null && string != \"\") {\n        // Convert special HTML entities back to characters\n        var optTemp = 0, i = 0, noquotes= false;\n        if (typeof quote_style === 'undefined') {        quote_style = 2;\n        }\n        string = string.toString().replace(/&lt;/g, '<').replace(/&gt;/g, '>');\n        var OPTS = {\n            'ENT_NOQUOTES': 0,\n            'ENT_HTML_QUOTE_SINGLE' : 1,\n            'ENT_HTML_QUOTE_DOUBLE' : 2,\n            'ENT_COMPAT': 2,\n            'ENT_QUOTES': 3,\n            'ENT_IGNORE' : 4\n        };\n        if (quote_style === 0) {\n            noquotes = true;\n        }\n        if (typeof quote_style !== 'number') { // Allow for a single string or an array of string flags\n            quote_style = [].concat(quote_style);\n            for (i=0; i < quote_style.length; i++) {\n                // Resolve string input to bitwise e.g. 'PATHINFO_EXTENSION' becomes 4\n                if (OPTS[quote_style[i]] === 0) {\n                    noquotes = true;\n                } else if (OPTS[quote_style[i]]) {\n                    optTemp = optTemp | OPTS[quote_style[i]];\n                }\n            }\n            quote_style = optTemp;\n        }\n        if (quote_style & OPTS.ENT_HTML_QUOTE_SINGLE) {\n            string = string.replace(/&#0*39;/g, \"'\"); // PHP doesn't currently escape if more than one 0, but it should\n            // string = string.replace(/&apos;|&#x0*27;/g, \"'\"); // This would also be useful here, but not a part of PHP\n        }\n        if (!noquotes) {\n            string = string.replace(/&quot;/g, '\"');\n        }\n\n        string = string.replace(/&nbsp;/g, ' ');\n\n        // Put this in last place to avoid escape being double-decoded    string = string.replace(/&amp;/g, '&');\n    }\n    return string;\n}\n\n/**\n * Permit to load dynamically the list of Items\n */\nfunction proceed_list_update(stop_proceeding)\n{\n    stop_proceeding = stop_proceeding || \"\";\n\n    if (stop_proceeding === \"1\" || ($(\"#new_listing_characteristics\").val() !== \"\" && $(\"#query_next_start\").val() !== \"end\")) {\n        var tmp = $(\"#new_listing_characteristics\").val().split(',');\n        $(\"#new_listing_characteristics\").val(\"\");\n        ListerItems(tmp[0], tmp[1], tmp[2], tmp[3]);\n        return false;\n    }\n\n    if ($(\"#query_next_start\").val() !== \"end\") {\n        //Check if nb of items do display > to 0\n        if ($(\"#nb_items_to_display_once\").val() > 0) {\n            ListerItems($(\"#hid_cat\").val(),'', parseInt($(\"#query_next_start\").val()));\n        }\n    } else {\n        $('ul#full_items_list>li').tsort(\"\",{order:\"asc\",attr:\"name\"});\n        $(\"#items_list_loader\").addClass(\"hidden\");\n\n        // prepare clipboard items\n        var clipboard = new Clipboard('.mini_login');\n        clipboard.on('success', function(e) {\n            $(\"#message_box\").html(\"<?php echo addslashes($LANG['login_copied_clipboard']); ?>\").show().fadeOut(1000);\n            e.clearSelection();\n        });\n\n        var clipboard = new Clipboard('.mini_pw');\n        clipboard.on('success', function(e) {\n            $(\"#message_box\").html(\"<?php echo addslashes($LANG['pw_copied_clipboard']); ?>\").show().fadeOut(1000);\n            itemLog(\"item_password_copied\");\n            e.clearSelection();\n        });\n\n        $(\".tip\").tooltipster({multiple: true});\n        $(\".mini_login, .mini_pw\").css(\"cursor\", \"pointer\");\n\n        var restricted_to_roles = <?php if (isset($SETTINGS['restricted_to_roles']) && $SETTINGS['restricted_to_roles'] == 1) {\n    echo 1;\n} else {\n    echo 0;\n}\n?>;\n\n        // refine users list to the related roles\n        $.post(\n            \"sources/items.queries.php\",\n            {\n                type        : \"get_refined_list_of_users\",\n                iFolderId   : $('#hid_cat').val(),\n                key         : \"<?php echo $_SESSION['key']; ?>\"\n            },\n            function(data) {\n                data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                // *** restricted_to_list ***\n                $(\"#restricted_to_list\").empty();\n                // add list of users\n                if ($('#restricted_to').val() != undefined) {\n                    $(\"#restricted_to_list\").append(data.selOptionsUsers);\n                    if (restricted_to_roles == 1) {\n                        //add optgroup\n                        var optgroup = $('<optgroup>');\n                        optgroup.attr('label', \"<?php echo addslashes($LANG['users']); ?>\");\n                        $(\".folder_rights_user\").wrapAll(optgroup);\n                    }\n                }\n                //Add list of roles if option is set\n                if (restricted_to_roles == 1 && $('#restricted_to').val() != undefined) {\n                    //add optgroup\n                    var optgroup = $('<optgroup>');\n                    optgroup.attr('label', \"<?php echo addslashes($LANG['roles']); ?>\");\n                    $(\"#restricted_to_list\").append(data.selOptionsRoles);\n                    $(\".folder_rights_role\").wrapAll(optgroup);\n                }\n                //Prepare multiselect widget\n                $(\"#restricted_to_list\").select2({\n                    language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n                });\n\n                // *** edit_restricted_to_list ***\n                $(\"#edit_restricted_to_list\").empty();\n                if ($('#edit_restricted_to').val() != undefined) {\n                    $(\"#edit_restricted_to_list\").append(data.selEOptionsUsers);\n                    if (restricted_to_roles == 1) {\n                        //add optgroup\n                        var optgroup = $('<optgroup>');\n                        optgroup.attr('label', \"<?php echo addslashes($LANG['users']); ?>\");\n                        $(\".folder_rights_user_edit\").wrapAll(optgroup);\n                    }\n                }\n                //Add list of roles if option is set\n                if (restricted_to_roles == 1 && $('#edit_restricted_to').val() != undefined) {\n                    //add optgroup\n                    var optgroup = $('<optgroup>');\n                    optgroup.attr('label', \"<?php echo addslashes($LANG['roles']); ?>\");\n                    $(\"#edit_restricted_to_list\").append(data.selEOptionsRoles);\n                    $(\".folder_rights_role_edit\").wrapAll(optgroup);\n                }\n                //Prepare multiselect widget\n                $(\"#edit_restricted_to_list\").select2({\n                    language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n                });\n            }\n       );\n    }\n}\n\n/**\n *\n * @access public\n * @return void\n **/\nfunction items_list_filter(id)\n{\n    $(\"#full_items_list\").find(\"li\").show();\n    if (id) {\n        $(\"#full_items_list\").find(\"a:not(:contains(\" + id + \"))\").parent().addClass(\"hidden\");\n        $(\"#full_items_list\").find(\"a:contains(\" + id + \")\").parent().show();\n    }\n}\n\n\nfunction manage_history_entry(type, id)\n{\n    var data = {\"item_id\": $(\"#id_item\").val(), \"label\": sanitizeString($('#add_history_entry_label').val())};\n\n    //Send query\n    $.post(\n        \"sources/items.queries.php\",\n        {\n            type      : \"history_entry_add\",\n            folder_id : $('#hid_cat').val(),\n            data      : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n            key       : \"<?php echo $_SESSION['key']; ?>\"\n        },\n        function(data) {\n            //check if format error\n            data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n            if (data.error == \"\") {\n                $(\"#item_history_log_error\").html(\"\").addClass(\"hidden\");\n                $(\"#add_history_entry_label\").val(\"\");\n                $(\"#item_history_log\").append(htmlspecialchars_decode(data.new_line));\n            } else {\n                $(\"#item_history_log_error\").html(data.error).show();\n            }\n            $(\"#div_item_history\").dialog(\"open\");\n        }\n   );\n}\n\n\n/*\n* Launch the redirection to OTV page\n*/\nfunction prepareOneTimeView()\n{\n    if ($(\"#selected_items\").val() == \"\") return;\n    $(\"#div_loading\").removeClass(\"hidden\");\n\n    //Send query\n    $.post(\n        \"sources/items.queries.php\",\n        {\n            type    : \"generate_OTV_url\",\n            id      : $(\"#id_item\").val(),\n            key     : \"<?php echo $_SESSION['key']; ?>\"\n        },\n        function(data) {\n            //check if format error\n            if (data.error == \"\") {\n                $(\"#div_dialog_message\").dialog({height:300,minWidth:750});\n                $(\"#div_dialog_message\").dialog('open');\n                $(\"#div_dialog_message_text\").html(data.url+\n                    '<div style=\"margin-top:30px;font-size:13px;text-align:center;\"><span id=\"show_otv_copied\" class=\"ui-state-focus ui-corner-all\" style=\"padding:10px;display:none;\"></span></div>'\n                );\n\n                // prepare clipboard\n                var clipboard = new Clipboard(\"#button_copy_otv_link\", {\n                    text: function() {\n                        return unsanitizeString($('#otv_link').text());\n                    }\n                });\n                clipboard.on('success', function(e) {\n                    $(\"#show_otv_copied\").html(\"<?php echo addslashes($LANG['link_is_copied']); ?>\").show().fadeOut(2000);\n\n                    e.clearSelection();\n                });\n\n                $(\".tip\").tooltipster({multiple: true});\n            } else {\n                $(\"#item_history_log_error\").html(data.error).show();\n            }\n            $(\"#div_loading\").addClass(\"hidden\");\n        },\n        \"json\"\n   );\n}\n\nfunction globalItemsSearch()\n{\n    if ($(\"#search_item\").val() != \"\") {\n        // stop items loading (if on-going)\n        $(\"#items_listing_should_stop\").val(\"1\");\n\n        // wait\n        $(\"#items_list_loader\").removeClass(\"hidden\");\n        $(\"#items_path_var\").html('<i class=\"fa fa-filter\"></i>&nbsp;<?php echo addslashes($LANG['searching']); ?>');\n\n        // clean\n        $(\"#id_label, #id_desc, #id_pw, #id_login, #id_email, #id_url, #id_files, #id_restricted_to ,#id_tags, #id_kbs, .fields_div, #item_extra_info\").html(\"\");\n        $(\"#button_quick_login_copy, #button_quick_pw_copy\").addClass(\"hidden\");\n        $(\"#full_items_list\").html(\"\");\n        $(\"#selected_items\").val(\"\");\n\n        // send query\n        $.get(\n            \"sources/find.queries.php\",\n            {\n                type        : \"search_for_items\",\n                sSearch     : $(\"#search_item\").val(),\n                key         : \"<?php echo $_SESSION['key']; ?>\"\n            },\n            function(data) {\n                data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                displayMessage(data.message);\n                $(\"#items_path_var\").html('<i class=\"fa fa-filter\"></i>&nbsp;<?php echo addslashes($LANG['search_results']); ?>');\n                $(\"#items_list\").html(\"<ul class='liste_items 'id='full_items_list'></ul>\");\n                $(\"#full_items_list\").html(data.items_html);\n                $(\"#items_list_loader\").addClass(\"hidden\");\n            }\n        );\n    }\n}\n\n/*\n*\n*/\nfunction searchItemsWithTags(tag)\n{\n    //console.log(\">\"+tag);\n    if (tag == \"\") return false\n\n    // wait\n    $(\"#items_list_loader\").removeClass(\"hidden\");\n    $(\"#items_path_var\").html('<i class=\"fa fa-filter\"></i>&nbsp;<?php echo addslashes($LANG['searching_tag']); ?>&nbsp;<b>' + tag + '</b> ...');\n\n    // clean\n    $(\"#id_label, #id_desc, #id_pw, #id_login, #id_email, #id_url, #id_files, #id_restricted_to ,#id_tags, #id_kbs\").html(\"\");\n    $(\"#button_quick_login_copy, #button_quick_pw_copy\").addClass(\"hidden\");\n    $(\"#full_items_list\").html(\"\");\n    $(\"#selected_items\").val(\"\");\n\n    // send query\n    $.get(\n        \"sources/find.queries.php\",\n        {\n            type        : \"search_for_items_with_tags\",\n            tagSearch   : tag,\n            key         : \"<?php echo $_SESSION['key']; ?>\"\n        },\n        function(data) {\n            data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n            displayMessage(data.message);\n            $(\"#items_path_var\").html('<i class=\"fa fa-filter\"></i>&nbsp;<?php echo addslashes($LANG['search_results']); ?>&nbsp;<b>' + tag + '</b>');\n            $(\"#full_items_list\").html(data.items_html);\n            $(\"#items_list_loader\").addClass(\"hidden\");\n        }\n    );\n}\n\nfunction loadOfflineDialog()\n{\n    $(\"#dialog_offline_mode\").dialog({\n        open: function(event, ui) {\n            $(\"#div_offline_mode\").load(\n                \"<?php echo $SETTINGS['cpassman_url']; ?>/items.offline.php?key=<?php echo $_SESSION['key']; ?>\", function(){}\n            );\n        }\n    }).dialog(\"open\");\n}\n\nfunction loadExportDialog()\n{\n    $(\"#dialog_export_file\").dialog({\n        open: function(event, ui) {\n            $(\"#div_export_file\").load(\n                \"<?php echo $SETTINGS['cpassman_url']; ?>/items.export.php?key=<?php echo $_SESSION['key']; ?>\", function(){}\n            );\n        }\n    }).dialog(\"open\");\n}\n\nfunction loadImportDialog()\n{\n    $(\"#dialog_import_file\").dialog({\n        open: function(event, ui) {\n            $(\"#div_import_file\").load(\n                \"<?php echo $SETTINGS['cpassman_url']; ?>/items.import.php?key=<?php echo $_SESSION['key']; ?>&folder_id=\"+$(\"#hid_cat\").val(), function(){}\n            );\n        }\n    }).dialog(\"open\");\n}\n\nfunction reEncryptPersonalPwds(remainingIds, currentId, nb)\n{\n    //console.log(remainingIds+\";\"+currentId+\";\"+nb);\n    $(\"#dialog_upgrade_personal_passwords_status\").html('<i class=\"fa fa-cog fa-spin\"></i>&nbsp;<?php echo addslashes($LANG['please_wait']); ?>&nbsp;...&nbsp;<span id=\"reencryption_progress\">0%</span>').attr(\"class\",\"\").show();\n\n    $.ajax({\n        url: \"sources/utils.queries.php\",\n        type : 'POST',\n        dataType : \"json\",\n        data : {\n            type        : \"reencrypt_personal_pwd\",\n            currentId   : currentId,\n            user_id     : \"<?php echo $_SESSION['user_id']; ?>\",\n            key         : \"<?php echo $_SESSION['key']; ?>\"\n        },\n        complete : function(data, statut){\n            var aIds = remainingIds.split(\",\");\n            var currentID = aIds[0];\n            aIds.shift();\n            var nb2 = aIds.length;\n            aIds = aIds.toString();\n            if (nb == 0)\n                $(\"#reencryption_progress\").html(\"100%\");\n            else\n                $(\"#reencryption_progress\").html(Math.floor(((nb-nb2) / nb) * 100)+\"%\");\n\n            if (nb2 != \"0\" || (nb2 == \"\" && currentID != \"\")) {\n                reEncryptPersonalPwds(aIds, currentID, nb);\n            } else {\n                $(\"#dialog_upgrade_personal_passwords\").html('<i class=\"fa fa-info\"></i>&nbsp;<?php echo addslashes($LANG['operation_encryption_done']); ?>');\n\n                // ensure that no upgrade popup is shown\n                $(\"#personal_upgrade_needed\").val(\"\");\n            }\n        }\n    });\n}\n\n function serverAutoChangePwd()\n {\n    //console.log(\"opening\");\n    $(\"#dialog_ssh\").dialog({\n        open: function(event, ui) {\n            $(\"#div_ssh\").load(\n                \"<?php echo $SETTINGS['cpassman_url'].'/ssh.php?key='.$_SESSION['key']; ?>&id=\"+$(\"#selected_items\").val(), function(){}\n            );\n        }\n    }).dialog(\"open\");\n}\n\n/*\n**\n*/\nfunction showPasswordsHistory() {\n    if ($('#edit_past_pwds_div').text() !== \"\") {\n        $('#edit_past_pwds_div').toggle();\n    }\n}\n\n$.fn.simulateClick = function() {\n    return this.each(function() {\n        if('createEvent' in document) {\n            var doc = this.ownerDocument,\n                evt = doc.createEvent('MouseEvents');\n            evt.initMouseEvent('click', true, true, doc.defaultView, 1, 0, 0, 0, 0, false, false, false, false, 0, null);\n            this.dispatchEvent(evt);\n        } else {\n            this.click(); // IE Boss!\n        }\n    });\n}\n\n\n// escape HTML characters\nString.prototype.escapeHTML = function() {\n    return this.replace(/&/g, \"&amp;\")\n        .replace(/</g, \"&lt;\")\n        .replace(/>/g, \"&gt;\")\n        .replace(/\"/g, \"&quot;\")\n        .replace(/'/g, \"&#039;\");\n}\n//]]>\n</script>\n", "<?php\n/**\n *\n * @file          items.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\n\nif (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 ||\n    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) ||\n    !isset($_SESSION['key']) || empty($_SESSION['key'])\n) {\n    die('Hacking attempt...');\n}\n\n// Load config\nif (file_exists('../includes/config/tp.config.php')) {\n    require_once '../includes/config/tp.config.php';\n} elseif (file_exists('./includes/config/tp.config.php')) {\n    require_once './includes/config/tp.config.php';\n} else {\n    throw new Exception(\"Error file '/includes/config/tp.config.php' not exists\", 1);\n}\n\n/* do checks */\nrequire_once $SETTINGS['cpassman_dir'].'/sources/checks.php';\nif (!checkUser($_SESSION['user_id'], $_SESSION['key'], curPage())) {\n    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n    include $SETTINGS['cpassman_dir'].'/error.php';\n    exit();\n}\n\nrequire_once $SETTINGS['cpassman_dir'].'/sources/SplClassLoader.php';\nrequire_once $SETTINGS['cpassman_dir'].'/sources/main.functions.php';\nrequire_once $SETTINGS['cpassman_dir'].'/includes/libraries/protect/SuperGlobal/SuperGlobal.php';\n$superGlobal = new protect\\SuperGlobal\\SuperGlobal();\n\n// Prepare GET variables\n$get_group = $superGlobal->get(\"group\", \"GET\");\n$get_id = $superGlobal->get(\"id\", \"GET\");\n\n// Prepare SESSION variables\n$session_user_admin = $superGlobal->get(\"user_admin\", \"SESSION\");\n\n\nif ($session_user_admin === '1' && (isset($SETTINGS_EXT['admin_full_right'])\n    && $SETTINGS_EXT['admin_full_right'] === true) || !isset($SETTINGS_EXT['admin_full_right'])) {\n    $_SESSION['groupes_visibles'] = $_SESSION['personal_visible_groups'];\n    $_SESSION['groupes_visibles_list'] = implode(',', $_SESSION['groupes_visibles']);\n}\n\n// Get list of users\n$usersList = array();\n$rows = DB::query(\"SELECT id,login,email FROM \".$pre.\"users ORDER BY login ASC\");\nforeach ($rows as $record) {\n    $usersList[$record['login']] = array(\n        \"id\" => $record['id'],\n        \"login\" => $record['login'],\n        \"email\" => $record['email'],\n        );\n}\n// Get list of roles\n$arrRoles = array();\n$listRoles = \"\";\n$rows = DB::query(\"SELECT id,title FROM \".$pre.\"roles_title ORDER BY title ASC\");\nforeach ($rows as $reccord) {\n    $arrRoles[$reccord['title']] = array(\n        'id' => $reccord['id'],\n        'title' => $reccord['title']\n        );\n    if (empty($listRoles)) {\n        $listRoles = $reccord['id'].'#'.$reccord['title'];\n    } else {\n        $listRoles .= ';'.$reccord['id'].'#'.$reccord['title'];\n    }\n}\n\n// Hidden things\necho '\n<input type=\"hidden\" name=\"hid_cat\" id=\"hid_cat\" value=\"', $get_group !== null ? $get_group : \"\", '\" />\n<input type=\"hidden\" id=\"complexite_groupe\" value=\"\" />\n<input type=\"hidden\" name=\"selected_items\" id=\"selected_items\" value=\"\" />\n<input type=\"hidden\" id=\"bloquer_creation_complexite\" value=\"\" />\n<input type=\"hidden\" id=\"bloquer_modification_complexite\" value=\"\" />\n<input type=\"hidden\" id=\"error_detected\" value=\"\" />\n<input type=\"hidden\" name=\"random_id\" id=\"random_id\" value=\"\" />\n<input type=\"hidden\" id=\"edit_wysiwyg_displayed\" value=\"\" />\n<input type=\"hidden\" id=\"richtext_on\" value=\"1\" />\n<input type=\"hidden\" id=\"query_next_start\" value=\"0\" />\n<input type=\"hidden\" id=\"display_categories\" value=\"0\" />\n<input type=\"hidden\" id=\"nb_items_to_display_once\" value=\"', isset($SETTINGS['nb_items_by_query']) ? htmlspecialchars($SETTINGS['nb_items_by_query']) : 'auto', '\" />\n<input type=\"hidden\" id=\"user_is_read_only\" value=\"', isset($_SESSION['user_read_only']) && $_SESSION['user_read_only'] == 1 ? '1' : '', '\" />\n<input type=\"hidden\" id=\"request_ongoing\" value=\"\" />\n<input type=\"hidden\" id=\"request_lastItem\" value=\"\" />\n<input type=\"hidden\" id=\"item_editable\" value=\"\" />\n<input type=\"hidden\" id=\"timestamp_item_displayed\" value=\"\" />\n<input type=\"hidden\" id=\"pf_selected\" value=\"\" />\n<input type=\"hidden\" id=\"user_ongoing_action\" value=\"\" />\n<input type=\"hidden\" id=\"input_list_roles\" value=\"'.htmlentities($listRoles).'\" />\n<input type=\"hidden\" id=\"path_fontsize\" value=\"\" />\n<input type=\"hidden\" id=\"access_level\" value=\"\" />\n<input type=\"hidden\" id=\"empty_clipboard\" value=\"\" />\n<input type=\"hidden\" id=\"selected_folder_is_personal\" value=\"\" />\n<input type=\"hidden\" id=\"personal_visible_groups_list\" value=\"', isset($_SESSION['personal_visible_groups_list']) ? $_SESSION['personal_visible_groups_list'] : \"\", '\" />\n<input type=\"hidden\" id=\"create_item_without_password\" value=\"', isset($SETTINGS['create_item_without_password']) ? $SETTINGS['create_item_without_password'] : \"0\", '\" />';\n// Hidden objects for Item search\nif ($get_group !== null && $get_id !== null) {\n    echo '\n    <input type=\"hidden\" name=\"open_folder\" id=\"open_folder\" value=\"'.$get_group.'\" />\n    <input type=\"hidden\" name=\"open_id\" id=\"open_id\" value=\"'.$get_id.'\" />\n    <input type=\"hidden\" name=\"recherche_group_pf\" id=\"recherche_group_pf\" value=\"', in_array($get_group, $_SESSION['personal_visible_groups']) ? '1' : '0', '\" />\n    <input type=\"hidden\" name=\"open_item_by_get\" id=\"open_item_by_get\" value=\"true\" />';\n} elseif ($get_group !== null && $get_id === null) {\n    echo '<input type=\"hidden\" name=\"open_folder\" id=\"open_folder\" value=\"'.$get_group.'\" />';\n    echo '<input type=\"hidden\" name=\"open_id\" id=\"open_id\" value=\"\" />';\n    echo '<input type=\"hidden\" name=\"recherche_group_pf\" id=\"recherche_group_pf\" value=\"', in_array($get_group, $_SESSION['personal_visible_groups']) ? '1' : '0', '\" />';\n    echo '<input type=\"hidden\" name=\"open_item_by_get\" id=\"open_item_by_get\" value=\"\" />';\n} else {\n    echo '<input type=\"hidden\" name=\"open_folder\" id=\"open_folder\" value=\"\" />';\n    echo '<input type=\"hidden\" name=\"open_id\" id=\"open_id\" value=\"\" />';\n    echo '<input type=\"hidden\" name=\"recherche_group_pf\" id=\"recherche_group_pf\" value=\"\" />';\n    echo '<input type=\"hidden\" name=\"open_item_by_get\" id=\"open_item_by_get\" value=\"\" />';\n}\n// Is personal SK available\necho '\n<input type=\"hidden\" name=\"personal_sk_set\" id=\"personal_sk_set\" value=\"', isset($_SESSION['user_settings']['session_psk']) && !empty($_SESSION['user_settings']['session_psk']) ? '1' : '0', '\" />\n<input type=\"hidden\" id=\"personal_upgrade_needed\" value=\"', isset($SETTINGS['enable_pf_feature']) && $SETTINGS['enable_pf_feature'] == 1 && $session_user_admin !== '1' && isset($_SESSION['user_upgrade_needed']) && $_SESSION['user_upgrade_needed'] == 1 ? '1' : '0', '\" />';\n// define what group todisplay in Tree\nif (isset($_COOKIE['jstree_select']) && !empty($_COOKIE['jstree_select'])) {\n    $firstGroup = str_replace(\"#li_\", \"\", $_COOKIE['jstree_select']);\n} else {\n    $firstGroup = \"\";\n}\n\necho '\n<input type=\"hidden\" name=\"jstree_group_selected\" id=\"jstree_group_selected\" value=\"'.htmlspecialchars($firstGroup).'\" />\n<input type=\"hidden\" id=\"item_user_token\" value=\"\" />\n<input type=\"hidden\" id=\"items_listing_should_stop\" value=\"\" />\n<input type=\"hidden\" id=\"new_listing_characteristics\" value=\"\" />\n<input type=\"hidden\" id=\"uniqueLoadData\" value=\"\" />';\n\necho '\n<div id=\"div_items\">';\n// MAIN ITEMS TREE\necho '\n    <div class=\"items_tree\">\n        <div id=\"quick_menu\" style=\"float:left; margin-right: 5px;\">\n            <ul class=\"quick_menu\">\n                <li><i class=\"fa fa-bars\"></i>\n                    <ul class=\"menu_250\">\n                        <li id=\"jstree_open\"><i class=\"fa fa-expand fa-fw\"></i>&nbsp; '.$LANG['expand'].'</li>\n                        <li id=\"jstree_close\"><i class=\"fa fa-compress fa-fw\"></i>&nbsp; '.$LANG['collapse'].'</li>\n                        <li onclick=\"refreshTree()\"><i class=\"fa fa-refresh fa-fw\"></i>&nbsp; '.$LANG['refresh'].'</li>\n                        <li onclick=\"open_add_group_div()\"><i class=\"fa fa-plus fa-fw\"></i>&nbsp; '.$LANG['item_menu_add_rep'].'</li>\n                        <li onclick=\"open_edit_group_div()\"><i class=\"fa fa-pencil fa-fw\"></i>&nbsp; '.$LANG['item_menu_edi_rep'].'</li>\n                        <li onclick=\"open_move_group_div()\"><i class=\"fa fa-arrows fa-fw\"></i>&nbsp; '.$LANG['item_menu_mov_rep'].'</li>\n                        <li onclick=\"open_del_group_div()\"><i class=\"fa fa-eraser fa-fw\"></i>&nbsp; '.$LANG['item_menu_del_rep'].'</li>\n                        <li onclick=\"$(\\'#div_copy_folder\\').dialog(\\'open\\');\"><i class=\"fa fa-copy fa-fw\"></i>&nbsp; '.$LANG['copy_folder'].'</li>\n                        ', isset($SETTINGS['allow_import']) && $SETTINGS['allow_import'] == 1 && $session_user_admin !== '1' ? '<li onclick=\"loadImportDialog()\"><i class=\"fa fa-cloud-upload fa-fw\"></i>&nbsp; '.$LANG['import_csv_menu_title'].'</li>' : '',\n                        (isset($SETTINGS['allow_print']) && $SETTINGS['allow_print'] == 1 && $session_user_admin !== '1' && $_SESSION['temporary']['user_can_printout'] === true) ? '<li onclick=\"loadExportDialog()\"><i class=\"fa fa-cloud-download fa-fw\"></i>&nbsp; '.$LANG['print_out_menu_title'].'</li>' : '',\n                        (isset($SETTINGS['settings_offline_mode']) && $SETTINGS['settings_offline_mode'] == 1 && $session_user_admin !== '1') ? '<li onclick=\"loadOfflineDialog()\"><i class=\"fa fa-laptop fa-fw\"></i>&nbsp; '.$LANG['offline_menu_title'].'</li>' : '', '\n                    </ul>\n                </li>\n            </ul>\n        </div>\n        <div style=\"margin:3px 0px 10px 18px;font-weight:bold;\">\n            '.$LANG['items_browser_title'].'\n            <input type=\"text\" name=\"jstree_search\" id=\"jstree_search\" class=\"text ui-widget-content ui-corner-all search_tree\" value=\"'.htmlentities(strip_tags($LANG['item_menu_find']), ENT_QUOTES).'\" />\n        </div>\n        <div id=\"sidebar\" class=\"sidebar\">\n            <div id=\"jstree\" style=\"overflow:auto;\"></div>\n        </div>\n    </div>';\n// Zone top right - items list\necho '\n    <div id=\"items_content\">\n        <div id=\"items_center\">\n            <div id=\"items_path\" class=\"ui-corner-all\">\n                <div class=\"quick_menu1\" style=\"float:left; margin-right: 5px;\">\n                    <ul class=\"quick_menu\">\n                        <li><i class=\"fa fa-bars\"></i>\n                            <ul class=\"menu_250\">\n                                <li id=\"menu_button_add_item\" onclick=\"open_add_item_div()\"><i class=\"fa fa-plus fa-fw\"></i>&nbsp; '.$LANG['item_menu_add_elem'].'</li>\n                                <li id=\"menu_button_edit_item\" onclick=\"open_edit_item_div(', isset($SETTINGS['restricted_to_roles']) && $SETTINGS['restricted_to_roles'] == 1 ? 1 : 0, ')\"><i class=\"fa fa-pencil fa-fw\"></i>&nbsp; '.$LANG['item_menu_edi_elem'].'</li>\n                                <li id=\"menu_button_del_item\" onclick=\"open_del_item_div()\"><i class=\"fa fa-eraser fa-fw\"></i>&nbsp; '.$LANG['item_menu_del_elem'].'</li>\n                                <li id=\"menu_button_copy_item\" onclick=\"open_copy_item_to_folder_div()\"><i class=\"fa fa-copy fa-fw\"></i>&nbsp; '.$LANG['item_menu_copy_elem'].'</li>\n                            </ul>\n                        </li>\n                    </ul>\n                </div>\n\n                <div style=\"margin-top: 3px;\">\n                    <div id=\"txt1\"  style=\"float:left;\">\n                        <span id=\"items_path_var\"></span>\n                    </div>\n\n                    <div class=\"input-group margin-bottom-sm\" style=\"float:right; margin-top:-1px;\">\n                        <span class=\"input-group-addon\"><i class=\"fa fa-binoculars fa-fw\"></i></span>\n                        <input class=\"form-control text ui-widget-content\" type=\"text\" onkeypress=\"javascript:if (event.keyCode == 13) globalItemsSearch();\" id=\"search_item\" />\n                    </div>\n\n                    <i id=\"items_list_loader\" style=\"float:right;margin-right:5px;\" class=\"fa fa-cog fa-spin mi-red hidden\"></i>&nbsp;\n                </div>\n            </div>\n            <div id=\"items_list\"></div>\n        </div>';\n// Zone ITEM DETAIL\necho '\n        <div id=\"item_details_ok\">\n            <input type=\"hidden\" id=\"id_categorie\" value=\"\" />\n            <input type=\"hidden\" id=\"id_item\" value=\"\" />\n            <input type=\"hidden\" id=\"hid_anyone_can_modify\" value=\"\" />\n            <div style=\"height:220px;overflow-y:auto;\" id=\"item_details_scroll\">\n                <div id=\"handle\" class=\"ui-resizable-handle ui-resizable-n\"></div>';\n\necho'\n                <div id=\"item_details_expired\" style=\"display:none;background-color:white; margin:5px;\">\n                    <div class=\"ui-state-error ui-corner-all\" style=\"padding:2px;\">\n                        <i class=\"fa fa-warning\"></i>&nbsp;<b>'.$LANG['pw_is_expired_-_update_it'].'</b>\n                    </div>\n                </div>\n                <table width=\"100%\" id=\"item_details_table\">';\n// Line for LABEL\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\" colspan=\"2\">\n                        <div class=\"quick_menu2\" style=\"float:left; margin-right: 5px;\">\n                            <ul class=\"quick_menu ui-menu\">\n                                <li><i class=\"fa fa-bars\"></i>\n                                    <ul class=\"menu_250\">\n                                        <li id=\"menu_button_copy_pw\" class=\"copy_clipboard\"><i class=\"fa fa-lock fa-fw\"></i>&nbsp; '.$LANG['pw_copy_clipboard'].'</li>\n                                        <li id=\"menu_button_copy_login\" class=\"copy_clipboard\"><i class=\"fa fa-user fa-fw\"></i>&nbsp; '.$LANG['login_copy'].'</li>\n                                        <li id=\"menu_button_show_pw\" onclick=\"ShowPassword()\"><i class=\"fa fa-eye fa-fw\"></i>&nbsp; '.$LANG['mask_pw'].'</li>\n                                        <li id=\"menu_button_copy_link\" class=\"copy_clipboard\"><i class=\"fa fa-link fa-fw\"></i>&nbsp; '.$LANG['url_copy'].'</li>\n                                        <li id=\"menu_button_history\" onclick=\"OpenDialog(\\'div_item_history\\', \\'false\\')\"><i class=\"fa fa-history fa-fw\"></i>&nbsp; '.$LANG['history'].'</li>\n                                        <li id=\"menu_button_share\" onclick=\"OpenDialog(\\'div_item_share\\', \\'false\\')\"><i class=\"fa fa-share fa-fw\"></i>&nbsp; '.$LANG['share'].'</li>',\n                                        (isset($SETTINGS['otv_is_enabled']) && $SETTINGS['otv_is_enabled'] == 1) ? '<li id=\"menu_button_otv\" onclick=\"prepareOneTimeView()\"><i class=\"fa fa-users fa-fw\"></i>&nbsp; '.$LANG['one_time_item_view'].'</li>' : '', '\n                                        ', isset($SETTINGS['enable_email_notification_on_item_shown']) && $SETTINGS['enable_email_notification_on_item_shown'] == 1 ? '\n                                        <li id=\"menu_button_notify\"><i class=\"fa fa-volume-up fa-fw\"></i>&nbsp; '.$LANG['notify_me_on_change'].'</li>' : '', '\n                                        ', isset($SETTINGS['enable_server_password_change']) && $SETTINGS['enable_server_password_change'] == 1 && isset($_SESSION['user_read_only']) && $_SESSION['user_read_only'] !== \"1\" ? '\n                                        <li onclick=\"serverAutoChangePwd()\"><i class=\"fa fa-server fa-fw\"></i>&nbsp; '.$LANG['update_server_password'].'</li>' : '', '\n                                        ', isset($SETTINGS['enable_suggestion']) && $SETTINGS['enable_suggestion'] == 1 ? '\n                                        <li onclick=\"OpenDialog(\\'div_suggest_change\\', \\'false\\')\"><i class=\"fa fa-random fa-fw\"></i>&nbsp; '.$LANG['suggest_password_change'].'</li>' : '', '\n                                    </ul>\n                                </li>\n                            </ul>\n                        </div>\n                        <div id=\"id_label\" style=\"display:inline; margin:4px 0px 0px 120px; \"></div>\n                        <input type=\"hidden\" id=\"hid_label\" value=\"', isset($dataItem) ? htmlspecialchars($dataItem['label']) : '', '\" />\n                        <div style=\"float:right; font-family:arial; margin-right:5px;\" id=\"item_viewed_x_times\"></div>\n\n                        <!-- INFO -->\n                        <div class=\"\" style=\"float:right;margin-right:5px;\" id=\"item_extra_info\" title=\"\"></div>\n                        <!-- INFO END -->\n\n                    </td>\n                </tr>';\n// Line for DESCRIPTION\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\" width=\"180px\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['description'].' :</td>\n                    <td>\n                        <div id=\"id_desc\" style=\"font-style:italic;display:inline;\"></div><input type=\"hidden\" id=\"hid_desc\" value=\"', isset($dataItem) ? htmlspecialchars($dataItem['description']) : '', '\" />\n                    </td>\n                </tr>';\n// Line for PW\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['pw'].' :<span id=\"button_quick_pw_copy\" class=\"fa fa-paste fa-border fa-sm tip\" style=\"cursor:pointer;display:none;float:right;margin-right:2px;\" title=\"'.$LANG['item_menu_copy_pw'].'\"></i></td>\n                    <td>\n                        &nbsp;\n                        <div id=\"id_pw\" class=\"unhide_masked_data\" style=\"float:left; cursor:pointer; width:300px;\"></div>\n                        <input type=\"hidden\" id=\"hid_pw\" value=\"\" />\n                        <input type=\"hidden\" id=\"pw_shown\" value=\"0\" />\n                    </td>\n                </tr>';\n// Line for LOGIN\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['index_login'].' :<span id=\"button_quick_login_copy\" class=\"fa fa-paste fa-border fa-sm tip\" style=\"cursor:pointer;display:none;float:right;margin-right:2px;\" title=\"'.$LANG['item_menu_copy_login'].'\"></span></td>\n                    <td>\n                        <div id=\"id_login\" style=\"float:left;\"></div>\n                        <input type=\"hidden\" id=\"hid_login\" value=\"\" />\n                    </td>\n                </tr>';\n// Line for EMAIL\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['email'].' :</td>\n                    <td>\n                        <div id=\"id_email\" style=\"display:inline;\"></div><input type=\"hidden\" id=\"hid_email\" value=\"\" />\n                    </td>\n                </tr>';\n// Line for URL\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['url'].' :</td>\n                    <td>\n                        <div id=\"id_url\" style=\"display:inline;\"></div><input type=\"hidden\" id=\"hid_url\" value=\"\" />\n                    </td>\n                </tr>';\n// Line for FILES\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['files_&_images'].' :</td>\n                    <td>\n                        <div id=\"id_files\" style=\"display:inline;font-size:11px;\"></div><input type=\"hidden\" id=\"hid_files\" />\n                        <div id=\"dialog_files\" style=\"display: none;\">\n\n                        </div>\n                    </td>\n                </tr>';\n// Line for RESTRICTED TO\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['restricted_to'].' :</td>\n                    <td>\n                        <div id=\"id_restricted_to\" style=\"display:inline;\"></div><input type=\"hidden\" id=\"hid_restricted_to\" /><input type=\"hidden\" id=\"hid_restricted_to_roles\" />\n                    </td>\n                </tr>';\n// Line for TAGS\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['tags'].' :</td>\n                    <td>\n                        <div id=\"id_tags\" style=\"display:inline;\"></div><input type=\"hidden\" id=\"hid_tags\" />\n                    </td>\n                </tr>';\n// Line for KBs\nif (isset($SETTINGS['enable_kb']) && $SETTINGS['enable_kb'] == 1) {\n    echo '\n                    <tr>\n                        <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['kbs'].' :</td>\n                        <td>\n                            <div id=\"id_kbs\" style=\"display:inline;\"></div><input type=\"hidden\" id=\"hid_kbs\" />\n                        </td>\n                    </tr>';\n}\n// lines for FIELDS\nif (isset($SETTINGS['item_extra_fields']) && $SETTINGS['item_extra_fields'] == 1) {\n    foreach ($_SESSION['item_fields'] as $elem) {\n        $itemCatName = $elem[0];\n        echo '\n                    <tr class=\"tr_fields hidden\" id=\"tr_catfield_'.$elem[0].'\">\n                        <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$elem[1].' :</td>\n                        <td></td>\n                    </tr>';\n        foreach ($elem[2] as $field) {\n            echo '\n                    <tr class=\"tr_cf tr_fields hidden\" id=\"cf_tr_'.$field[0].'\">\n                        <td valign=\"top\" class=\"td_title\">&nbsp;&nbsp;<i class=\"fa fa-caret-right\"></i>&nbsp;<i>'.$field[1].'</i> :</td>\n                        <td>';\n            if ($field[3] === \"masked\") {\n                echo '\n                            <div id=\"id_field_'.htmlspecialchars($field[0]).'_'.$elem[0].'\" style=\"float:left; cursor:pointer; width:300px;\" class=\"fields_div unhide_masked_data pointer\"></div><input type=\"hidden\" id=\"hid_field_'.htmlspecialchars($field[0]).'_'.$elem[0].'\" class=\"fields\" />';\n            } else {\n                echo '\n                            <div id=\"id_field_'.htmlspecialchars($field[0]).'_'.$elem[0].'\" style=\"display:inline;\" class=\"fields_div\"></div><input type=\"hidden\" id=\"hid_field_'.htmlspecialchars($field[0]).'_'.$elem[0].'\" class=\"fields\" />';\n            }\n            echo '\n                        </td>\n                    </tr>';\n        }\n    }\n}\necho '\n                </table>\n            </div>\n        </div>';\n// # NOT ALLOWED\necho '\n        <div id=\"item_details_nok\" class=\"hidden\" style=\"width:400px; margin:20px auto 20px auto;\">\n            <div class=\"ui-state-highlight ui-corner-all\" style=\"padding:10px;\">\n                <i class=\"fa fa-warning fa-2x mi-red\"></i>&nbsp;<b>'.$LANG['not_allowed_to_see_pw'].'</b>\n                <span id=\"item_details_nok_restriction_list\"></span>\n            </div>\n        </div>';\n// DATA EXPIRED\necho '\n        <div id=\"item_details_expired_full\" style=\"display:none; width:400px; margin:20px auto 20px auto;\">\n            <div class=\"ui-state-error ui-corner-all\" style=\"padding:10px;\">\n                <i class=\"fa fa-warning fa-2x mi-red\"></i>&nbsp;<b>'.$LANG['pw_is_expired_-_update_it'].'</b>\n            </div>\n        </div>';\n// # NOT ALLOWED\necho '\n        <div id=\"item_details_no_personal_saltkey\" style=\"display:none; width:400px; margin:20px auto 20px auto; height:180px;\">\n            <div class=\"ui-state-highlight ui-corner-all\" style=\"padding:10px;\">\n                <i class=\"fa fa-warning fa-2x mi-red\"></i>&nbsp;<b>'.$LANG['home_personal_saltkey_info'].'</b>\n            </div>\n        </div>';\n\necho '\n    </div>';\n\necho '\n</div>';\n\n\n/********************************\n* NEW Item Form\n*/\necho '\n<div id=\"div_formulaire_saisi\" style=\"display:none;\">\n    <form method=\"post\" name=\"new_item\" action=\"\">\n        <div id=\"afficher_visibilite\" style=\"text-align:center;margin-bottom:6px;height:20px;\"></div>\n        <div id=\"display_title\" style=\"text-align:center;margin-bottom:6px;font-size:17px;font-weight:bold;height:25px;\"></div>\n        <div id=\"new_show_error\" style=\"text-align:center;margin:2px;display:none;\" class=\"ui-state-error ui-corner-all\"></div>\n\n        <div id=\"item_tabs\">\n        <ul>\n            <li><a href=\"#tabs-01\">'.$LANG['definition'].'</a></li>\n            <li><a href=\"#tabs-02\">'.$LANG['index_password'].' &amp; '.$LANG['visibility'].'</a></li>\n            <li><a href=\"#tabs-03\">'.$LANG['files_&_images'].'</a></li>\n            ', isset($SETTINGS['item_extra_fields']) && $SETTINGS['item_extra_fields'] == 1 ?\n            '<li id=\"form_tab_fields\"><a href=\"#tabs-04\">'.$LANG['more'].'</a></li>' : '', '\n        </ul>\n        <div id=\"tabs-01\">';\n// Line for LABEL\necho '\n            <label for=\"\" class=\"label_cpm\">'.$LANG['label'].' : </label>\n            <input type=\"text\" name=\"label\" id=\"label\" onchange=\"checkTitleDuplicate(this.value, \\'', isset($SETTINGS['item_duplicate_in_same_folder']) && $SETTINGS['item_duplicate_in_same_folder'] == 1 ? 0 : 1, '\\', \\'', isset($SETTINGS['duplicate_item']) && $SETTINGS['duplicate_item'] == 1 ? 0 : 1, '\\', \\'display_title\\')\" class=\"input_text text ui-widget-content ui-corner-all\" />';\n// Line for DESCRIPTION\necho '\n            <label for=\"\" class=\"label_cpm\">'.$LANG['description'].' : </label>\n            <span id=\"desc_span\">\n                <textarea rows=\"5\" cols=\"60\" name=\"desc\" id=\"desc\" class=\"input_text\"></textarea>\n            </span>\n            <br />';\n// Line for FOLDERS\necho '\n            <label for=\"\" class=\"\">'.$LANG['group'].' : </label>\n            <select name=\"categorie\" id=\"categorie\" onchange=\"RecupComplexite(this.value,0)\" style=\"width:250px; padding:3px;\" class=\"ui-widget-content\"><option style=\"display: none;\"></option></select>';\n// Line for LOGIN\necho '\n            <label for=\"\" class=\"label_cpm\" style=\"margin-top:10px;\">'.$LANG['login'].' : </label>\n            <input type=\"text\" name=\"item_login\" id=\"item_login\" class=\"input_text text ui-widget-content ui-corner-all\" />';\n// Line for EMAIL\necho '\n            <label for=\"\" class=\"label_cpm\">'.$LANG['email'].' : </label>\n            <input type=\"text\" name=\"email\" id=\"email\" class=\"input_text text ui-widget-content ui-corner-all\" />';\n// Line for URL\necho '\n            <label for=\"\" class=\"label_cpm\">'.$LANG['url'].' : </label>\n            <input type=\"text\" name=\"url\" id=\"url\" class=\"input_text text ui-widget-content ui-corner-all\" />\n        </div>';\n// Tabs Items N?2\necho '\n        <div id=\"tabs-02\">';\n// Line for folder complexity\necho'\n            <div style=\"margin-bottom:10px;\" id=\"expected_complexity\">\n                <label for=\"\" class=\"form_label_180\">'.$LANG['complex_asked'].'</label>\n                <span id=\"complex_attendue\" style=\"color:#D04806; margin-left:40px;\"></span>\n            </div>';\n// Line for PW\necho '\n            <label class=\"label_cpm\">'.$LANG['used_pw'].' :<span id=\"prout\"></span>\n                <span id=\"visible_pw\" style=\"display:none;margin-left:10px;font-weight:bold;\"></span>\n                <span id=\"pw_wait\" style=\"display:none;margin-left:10px;\"><span class=\"fa fa-cog fa-spin fa-1x\"></span></span>\n            </label>\n            <input type=\"password\" id=\"pw1\" class=\"input_text text ui-widget-content ui-corner-all\" />\n            <input type=\"hidden\" id=\"mypassword_complex\" />\n            <label for=\"\" class=\"label_cpm\">'.$LANG['index_change_pw_confirmation'].' :</label>\n            <input type=\"password\" name=\"pw2\" id=\"pw2\" class=\"input_text text ui-widget-content ui-corner-all\" />\n\n            <div style=\"font-size:9px; text-align:center; width:100%;\">\n                <span id=\"custom_pw\">\n                    <input type=\"checkbox\" id=\"pw_numerics\" /><label for=\"pw_numerics\">123</label>\n                    <input type=\"checkbox\" id=\"pw_maj\" /><label for=\"pw_maj\">ABC</label>\n                    <input type=\"checkbox\" id=\"pw_symbols\" /><label for=\"pw_symbols\">@#&amp;</label>\n                    <input type=\"checkbox\" id=\"pw_secure\" checked=\"checked\" /><label for=\"pw_secure\">'.$LANG['secure'].'</label>\n                    &nbsp;<label for=\"pw_size\">'.$LANG['size'].' : </label>\n                    &nbsp;<input type=\"text\" size=\"2\" id=\"pw_size\" value=\"8\" style=\"font-size:10px;\" />\n                </span>\n\n                <span class=\"fa-stack fa-lg tip\" title=\"'.$LANG['pw_generate'].'\" onclick=\"pwGenerate(\\'\\')\" style=\"cursor:pointer;\">\n                    <i class=\"fa fa-square fa-stack-2x\"></i>\n                    <i class=\"fa fa-cogs fa-stack-1x fa-inverse\"></i>\n                </span>&nbsp;\n                <span class=\"fa-stack fa-lg tip\" title=\"'.$LANG['copy'].'\" onclick=\"pwCopy(\\'\\')\" style=\"cursor:pointer;\">\n                    <i class=\"fa fa-square fa-stack-2x\"></i>\n                    <i class=\"fa fa-copy fa-stack-1x fa-inverse\"></i>\n                </span>&nbsp;\n                <span class=\"fa-stack fa-lg tip\" title=\"'.$LANG['mask_pw'].'\" onclick=\"showPwd()\" style=\"cursor:pointer;\">\n                    <i class=\"fa fa-square fa-stack-2x\"></i>\n                    <i class=\"fa fa-eye fa-stack-1x fa-inverse\"></i>\n                </span>\n            </div>\n            <div style=\"width:100%;\">\n                <div id=\"pw_strength\" style=\"margin:5px 0 5px 120px;\"></div>\n            </div>';\n\n// Line for RESTRICTED TO\nif (isset($SETTINGS['restricted_to']) && $SETTINGS['restricted_to'] == 1) {\n    echo '\n            <label for=\"\" class=\"label_cpm\">'.$LANG['restricted_to'].' : </label>\n            <select name=\"restricted_to_list\" id=\"restricted_to_list\" multiple=\"multiple\" style=\"width:100%;\" class=\"ui-widget-content\"></select>\n            <input type=\"hidden\" name=\"restricted_to\" id=\"restricted_to\" />\n            <input type=\"hidden\" size=\"50\" name=\"restricted_to_roles\" id=\"restricted_to_roles\" />\n            <div style=\"line-height:10px;\">&nbsp;</div>';\n}\n// Line for TAGS\necho '\n            <label for=\"\" class=\"label_cpm\">'.$LANG['tags'].' : </label>\n            <input type=\"text\" name=\"item_tags\" id=\"item_tags\" class=\"input_text text ui-widget-content ui-corner-all\" />';\n// Line for Item modification\necho '\n            <div style=\"width:100%;margin:0px 0px 6px 0px;', isset($SETTINGS['anyone_can_modify']) && $SETTINGS['anyone_can_modify'] == 1 ? '' : 'display:none;', '\">\n                <input type=\"checkbox\" name=\"anyone_can_modify\" id=\"anyone_can_modify\"',\n                    isset($SETTINGS['anyone_can_modify_bydefault'])\n                    && $SETTINGS['anyone_can_modify_bydefault'] == 1 ?\n                    ' checked=\"checked\"' : '', ' />\n                <label for=\"anyone_can_modify\">'.$LANG['anyone_can_modify'].'</label>\n            </div>';\n// Line for Item automatically deleted\necho '\n            <div style=\"width:100%;margin:0px 0px 6px 0px;', isset($SETTINGS['enable_delete_after_consultation']) && $SETTINGS['enable_delete_after_consultation'] == 1 ? '' : 'display:none;', '\">\n                <input type=\"checkbox\" name=\"enable_delete_after_consultation\" id=\"enable_delete_after_consultation\" />\n                <label for=\"enable_delete_after_consultation\">'.$LANG['enable_delete_after_consultation'].'</label>\n                <input type=\"text\" value=\"1\" size=\"1\" id=\"times_before_deletion\" />&nbsp;'.$LANG['times'].'&nbsp;\n                '.$LANG['automatic_del_after_date_text'].'&nbsp;<input type=\"text\" value=\"\" class=\"datepicker\" readonly=\"readonly\" size=\"10\" id=\"deletion_after_date\" onchange=\"$(\\'#times_before_deletion\\').val(\\'\\')\" />\n            </div>';\n// Line for EMAIL\necho '\n            <div>\n                <div style=\"line-height:10px;\">&nbsp;</div>\n                <label for=\"\" class=\"label_cpm\">'.$LANG['email_announce'].' : </label>\n                <select id=\"annonce_liste_destinataires\" multiple=\"multiple\" style=\"width:100%\">';\nforeach ($usersList as $user) {\n                    echo '<option value=\"'.$user['email'].'\">'.$user['login'].'</option>';\n}\n                echo '\n                </select>\n            </div>';\n\necho '\n\n        </div>';\n// Tabs EDIT N?3\necho '\n        <div id=\"tabs-03\">\n            <div id=\"item_upload\">\n                <div id=\"item_upload_list\"></div><br />\n                <div id=\"item_upload_wait\" class=\"ui-state-focus ui-corner-all hidden\" style=\"padding:2px;margin:5px 0 5px 0;\">'.$LANG['please_wait'].'...</div>\n                <a id=\"item_attach_pickfiles\" href=\"#\" class=\"button\">'.$LANG['select'].'</a>\n                <a id=\"item_attach_uploadfiles\" href=\"#\" class=\"button\">'.$LANG['start_upload'].'</a>\n                <input type=\"hidden\" id=\"files_number\" value=\"0\" />\n            </div>\n        </div>';\n// Tabs N\u00b04\nif (isset($SETTINGS['item_extra_fields']) && $SETTINGS['item_extra_fields'] == 1) {\n    echo '\n        <div id=\"tabs-04\">\n            <div id=\"item_more\">';\n    // load all categories and fields\n    foreach ($_SESSION['item_fields'] as $elem) {\n        $itemCatName = $elem[0];\n        echo '\n                <div id=\"newItemCatName_'.$itemCatName.'\" class=\"newItemCat\">\n                    <div style=\"font-weight:bold;font-size:12px;\">\n                        <span class=\"fa fa-folder-open mi-grey-1\">&nbsp;</span>'.$elem[1].'\n                    </div>';\n        foreach ($elem[2] as $field) {\n                echo '\n                    <div style=\"margin:2px 0 2px 15px;\">\n                        <span class=\"fa fa-tag mi-grey-1\">&nbsp;</span>\n                        <label class=\"cpm_label\">'.$field[1].'</span>\n                        <input type=\"text\" id=\"field_'.$field[0].'_'.$field[2].'\" class=\"item_field input_text text ui-widget-content ui-corner-all\" size=\"40\">\n                    </div>';\n        }\n        echo '\n                </div>';\n    }\n    echo '\n            </div>\n        </div>';\n}\necho '\n    </div>';\necho '\n    </form>\n    <div style=\"display:none; padding:5px; margin-top:5px; text-align:center;\" id=\"div_formulaire_saisi_info\" class=\"ui-state-default ui-corner-all\"></div>\n</div>';\n\n/***************************\n* Edit Item Form\n*/\necho '\n<div id=\"div_formulaire_edition_item\" style=\"display:none;\">\n    <form method=\"post\" name=\"form_edit\" action=\"\">\n    <div id=\"edit_afficher_visibilite\" style=\"text-align:center;margin-bottom:6px;height:25px;\"></div>\n    <div id=\"edit_display_title\" style=\"text-align:center;margin-bottom:6px;font-size:17px;font-weight:bold;height:25px;\"></div>\n    <div id=\"edit_show_error\" style=\"text-align:center;margin:2px;display:none;\" class=\"ui-state-error ui-corner-all\"></div>';\n// Prepare TABS\necho '\n    <div id=\"item_edit_tabs\">\n        <ul>\n            <li><a href=\"#tabs-1\">'.$LANG['definition'].'</a></li>\n            <li><a href=\"#tabs-2\">'.$LANG['index_password'].' &amp; '.$LANG['visibility'].'</a></li>\n            <li><a href=\"#tabs-3\">'.$LANG['files_&_images'].'</a></li>\n            ', isset($SETTINGS['item_extra_fields']) && $SETTINGS['item_extra_fields'] == 1 ?\n            '<li id=\"form_edit_tab_fields\"><a href=\"#tabs-4\">'.$LANG['more'].'</a></li>' : '', '\n        </ul>\n        <div id=\"tabs-1\">\n            <label for=\"\" class=\"cpm_label\">'.$LANG['label'].' : </label>\n            <input type=\"text\" size=\"60\" id=\"edit_label\" onchange=\"checkTitleDuplicate(this.value, \\'', isset($SETTINGS['item_duplicate_in_same_folder']) && $SETTINGS['item_duplicate_in_same_folder'] == 1 ? 0 : 1, '\\', \\'', isset($SETTINGS['duplicate_item']) && $SETTINGS['duplicate_item'] == 1 ? 0 : 1, '\\', \\'edit_display_title\\')\" class=\"input_text text ui-widget-content ui-corner-all\" />\n\n            <label for=\"\" class=\"cpm_label\">'.$LANG['description'].'&nbsp;<span class=\"fa fa-eraser\" style=\"cursor:pointer;\" onclick=\"clear_html_tags()\"></span>&nbsp;</label>\n            <span id=\"edit_desc_span\">\n                <textarea rows=\"5\" cols=\"70\" id=\"edit_desc\" name=\"edit_desc\" class=\"input_text\"></textarea>\n            </span>';\n// Line for FOLDER\necho '\n            <div style=\"margin:10px 0px 10px 0px;\">\n            <label for=\"\" class=\"\">'.$LANG['group'].' : </label>\n            <select id=\"edit_categorie\" onchange=\"RecupComplexite(this.value,1)\" style=\"width:100%;\"><option style=\"display: none;\"></option></select>\n            </div>';\n// Line for LOGIN\necho '\n            <label for=\"\" class=\"cpm_label\">'.$LANG['login'].' : </label>\n            <input type=\"text\" id=\"edit_item_login\" class=\"input_text text ui-widget-content ui-corner-all\" />\n\n            <label for=\"\" class=\"cpm_label\">'.$LANG['email'].' : </label>\n            <input type=\"text\" id=\"edit_email\" class=\"input_text text ui-widget-content ui-corner-all\" />\n\n            <label for=\"\" class=\"cpm_label\">'.$LANG['url'].' : </label>\n            <input type=\"text\" id=\"edit_url\" class=\"input_text text ui-widget-content ui-corner-all\" />\n        </div>';\n// TABS edit n?2\necho '\n        <div id=\"tabs-2\">';\n// Line for folder complexity\necho'\n            <div style=\"margin-bottom:10px;\" id=\"edit_expected_complexity\">\n                <label for=\"\" class=\"cpm_label\">'.$LANG['complex_asked'].'</label>\n                <span id=\"edit_complex_attendue\" style=\"color:#D04806;\"></span>\n            </div>';\n\necho '\n            <div style=\"line-height:20px;\">\n                <label for=\"\" class=\"label_cpm\">'.$LANG['used_pw'].' :\n                    <span id=\"edit_visible_pw\" style=\"display:none;margin-left:10px;font-weight:bold; padding:2px;\" class=\"ui-corner-all ui-state-default\"></span>\n                    <span id=\"edit_pw_wait\" style=\"margin-left:10px;\" class=\"hidden\"><span class=\"fa fa-cog fa-spin fa-1x\"></span></span>\n                </label>\n                <input type=\"password\" id=\"edit_pw1\" class=\"input_text text ui-widget-content ui-corner-all\" style=\"width:390px;\" />\n                <span class=\"fa fa-history tip\" style=\"cursor:pointer;\" id=\"edit_past_pwds\" onclick=\"showPasswordsHistory()\"></span>\n                <div style=\"display:none; padding:3px; width:390px; font-weight:normal; font-size:11px; font-family:italic;\" id=\"edit_past_pwds_div\" class=\"ui-corner-all ui-state-default\"></div>\n                <input type=\"hidden\" id=\"edit_mypassword_complex\" />\n\n                <label for=\"\" class=\"cpm_label\">'.$LANG['confirm'].' : </label>\n                <input type=\"password\" id=\"edit_pw2\" class=\"input_text text ui-widget-content ui-corner-all\" style=\"width:390px;\" />\n            </div>\n            <div style=\"font-size:9px; text-align:center; width:100%;\">\n                <span id=\"edit_custom_pw\">\n                    <input type=\"checkbox\" id=\"edit_pw_numerics\" /><label for=\"edit_pw_numerics\">123</label>\n                    <input type=\"checkbox\" id=\"edit_pw_maj\" /><label for=\"edit_pw_maj\">ABC</label>\n                    <input type=\"checkbox\" id=\"edit_pw_symbols\" /><label for=\"edit_pw_symbols\">@#&amp;</label>\n                    <input type=\"checkbox\" id=\"edit_pw_secure\" checked=\"checked\" /><label for=\"edit_pw_secure\">'.$LANG['secure'].'</label>\n                    &nbsp;<label for=\"edit_pw_size\">'.$LANG['size'].' : </label>\n                    &nbsp;<input type=\"text\" size=\"2\" id=\"edit_pw_size\" value=\"8\" style=\"font-size:10px;\" />\n                </span>\n\n                <span class=\"fa-stack fa-lg tip\" title=\"'.$LANG['pw_generate'].'\" onclick=\"pwGenerate(\\'edit\\')\" style=\"cursor:pointer;\">\n                    <i class=\"fa fa-square fa-stack-2x\"></i>\n                    <i class=\"fa fa-cogs fa-stack-1x fa-inverse\"></i>\n                </span>&nbsp;\n                <span class=\"fa-stack fa-lg tip\" title=\"'.$LANG['copy'].'\" onclick=\"pwCopy(\\'edit\\')\" style=\"cursor:pointer;\">\n                    <i class=\"fa fa-square fa-stack-2x\"></i>\n                    <i class=\"fa fa-copy fa-stack-1x fa-inverse\"></i>\n                </span>&nbsp;\n                <span class=\"fa-stack fa-lg tip\" title=\"'.$LANG['mask_pw'].'\" onclick=\"ShowPasswords_EditForm()\" style=\"cursor:pointer;\">\n                    <i class=\"fa fa-square fa-stack-2x\"></i>\n                    <i class=\"fa fa-eye fa-stack-1x fa-inverse\"></i>\n                </span>\n            </div>\n            <div style=\"width:100%;\">\n                <div id=\"edit_pw_strength\" style=\"margin:5px 0 5px 120px;\"></div>\n            </div>';\n\nif (isset($SETTINGS['restricted_to']) && $SETTINGS['restricted_to'] == 1) {\n    echo '\n            <div id=\"div_editRestricted\">\n                <label for=\"\" class=\"label_cpm\">'.$LANG['restricted_to'].' : </label>\n                <select name=\"edit_restricted_to_list\" id=\"edit_restricted_to_list\" multiple=\"multiple\" style=\"width:100%\"></select>\n                <input type=\"hidden\" size=\"50\" name=\"edit_restricted_to\" id=\"edit_restricted_to\" />\n                <input type=\"hidden\" size=\"50\" name=\"edit_restricted_to_roles\" id=\"edit_restricted_to_roles\" />\n                <div style=\"line-height:10px;\">&nbsp;</div>\n            </div>';\n}\n\necho '\n            <label for=\"\" class=\"cpm_label\">'.$LANG['tags'].' : </label>\n            <input type=\"text\" size=\"50\" name=\"edit_tags\" id=\"edit_tags\" class=\"input_text text ui-widget-content ui-corner-all\" />';\n// Line for Item modification\necho '\n            <div style=\"width:100%;margin:0px 0px 6px 0px;', isset($SETTINGS['anyone_can_modify']) && $SETTINGS['anyone_can_modify'] == 1 ? '' : 'display:none;', '\">\n                <input type=\"checkbox\" name=\"edit_anyone_can_modify\" id=\"edit_anyone_can_modify\"',\n                    isset($SETTINGS['anyone_can_modify_bydefault'])\n                    && $SETTINGS['anyone_can_modify_bydefault'] == 1 ?\n                    ' checked=\"checked\"' : '', ' />\n                <label for=\"edit_anyone_can_modify\">'.$LANG['anyone_can_modify'].'</label>\n            </div>';\n// Line for Item automatically deleted\necho '\n            <div id=\"edit_to_be_deleted\" style=\"width:100%;margin:0px 0px 6px 0px;', isset($SETTINGS['enable_delete_after_consultation']) && $SETTINGS['enable_delete_after_consultation'] == 1 ? '' : 'display:none;', '\">\n                <input type=\"checkbox\" name=\"edit_enable_delete_after_consultation\" id=\"edit_enable_delete_after_consultation\" />\n                <label for=\"edit_enable_delete_after_consultation\">'.$LANG['enable_delete_after_consultation'].'</label>\n                <input type=\"text\" value=\"\" size=\"1\" id=\"edit_times_before_deletion\" onchange=\"$(\\'#edit_deletion_after_date\\').val(\\'\\')\" />&nbsp;'.$LANG['times'].'&nbsp;\n                '.$LANG['automatic_del_after_date_text'].'&nbsp;<input type=\"text\" value=\"\" class=\"datepicker\" readonly=\"readonly\" size=\"10\" id=\"edit_deletion_after_date\" onchange=\"$(\\'#edit_times_before_deletion\\').val(\\'\\')\" />\n            </div>';\n\necho '\n            <div id=\"div_anounce_change_by_email\">\n                <div style=\"line-height:10px;\">&nbsp;</div>\n                <label for=\"\" class=\"label_cpm\">'.$LANG['email_announce'].' : </label>\n                <select id=\"edit_annonce_liste_destinataires\" multiple=\"multiple\" style=\"width:100%\">';\nforeach ($usersList as $user) {\n    echo '<option value=\"'.$user['email'].'\">'.$user['login'].'</option>';\n}\necho '\n                </select>\n            </div>';\n\necho '\n        </div>';\n// Tab EDIT N\u00b03\necho '\n        <div id=\"tabs-3\">\n            <div style=\"font-weight:bold;font-size:12px;\">\n                <span class=\"fa fa-folder-open mi-grey-1\">&nbsp;</span>'.$LANG['uploaded_files'].'\n            </div>\n            <div id=\"item_edit_list_files\" style=\"margin-left:5px;\"></div>\n            <div style=\"margin-top:10px;font-weight:bold;font-size:12px;\">\n                <span class=\"fa fa-folder-open mi-grey-1\">&nbsp;</span>'.$LANG['upload_files'].'\n            </div>\n            <div id=\"item_edit_upload\">\n                <div id=\"item_edit_upload_list\"></div><br />\n                <div id=\"item_edit_upload_wait\" class=\"ui-state-focus ui-corner-all hidden\" style=\"padding:2px;margin:5px 0 5px 0;\">'.$LANG['please_wait'].'...</div>\n                <a id=\"item_edit_attach_pickfiles\" href=\"#\" class=\"button\">'.$LANG['select'].'</a>\n                <a id=\"item_edit_attach_uploadfiles\" href=\"#sd\" class=\"button\">'.$LANG['start_upload'].'</a>\n                <input type=\"hidden\" id=\"edit_files_number\" value=\"0\" />\n            </div>\n        </div>';\n// Tabs EDIT N\u00b04 -> Categories\nif (isset($SETTINGS['item_extra_fields']) && $SETTINGS['item_extra_fields'] == 1) {\n    echo '\n        <div id=\"tabs-4\">\n            <div id=\"edit_item_more\">';\n    // load all categories and fields\n    foreach ($_SESSION['item_fields'] as $elem) {\n        echo '\n                <div class=\"editItemCat\" id=\"editItemCatName_'.$elem[0].'\">\n                    <div style=\"font-weight:bold;font-size:12px;\">\n                        <span class=\"fa fa-folder-open mi-grey-1\">&nbsp;</span>'.$elem[1].'\n                    </div>';\n        foreach ($elem[2] as $field) {\n            echo '\n                    <div style=\"margin:2px 0 2px 15px;\">\n                        <span class=\"fa fa-tag mi-grey-1\">&nbsp;</span>\n                        <label class=\"cpm_label\">'.$field[1].'</label>\n                        <input type=\"text\" id=\"edit_field_'.$field[0].'_'.$elem[0].'\" class=\"edit_item_field input_text text ui-widget-content ui-corner-all\" size=\"40\">\n                    </div>';\n        }\n        echo '\n                </div>';\n    }\n    echo '\n            </div>\n        </div>\n    </div>';\n}\necho '\n    <div style=\"display:none; padding:5px;\" id=\"div_formulaire_edition_item_info\" class=\"ui-state-default ui-corner-all\"></div>\n    </div>\n    </form>\n</div>';\n\n/*\n* ADD NEW FOLDER form\n*/\necho '\n<div id=\"div_ajout_rep\" style=\"display:none;\">\n    <div id=\"new_rep_show_error\" style=\"text-align:center;margin:2px;\" class=\"ui-state-error ui-corner-all\"></div>\n    <table>\n        <tr>\n            <td>'.$LANG['label'].' : </td>\n            <td><input type=\"text\" id=\"new_rep_titre\" style=\"width:242px; padding:3px;\" class=\"ui-widget-content\" /></td>\n        </tr>\n        <tr>\n            <td>'.$LANG['sub_group_of'].' : </td>\n            <td><select id=\"new_rep_groupe\" style=\"width:250px; padding:3px;\" class=\"ui-widget-content\">\n                ', (isset($SETTINGS['can_create_root_folder']) && $SETTINGS['can_create_root_folder'] == 1 || $_SESSION['user_manager'] === \"1\") ? '<option value=\"0\">'.$LANG['root'].'</option>' : '', '\n            </select></td>\n        </tr>\n        <tr>\n            <td>'.$LANG['complex_asked'].' : </td>\n            <td><select id=\"new_rep_complexite\" style=\"width:250px; padding:3px;\" class=\"ui-widget-content\">';\nforeach ($SETTINGS_EXT['pwComplexity'] as $complex) {\n    echo '<option value=\"'.$complex[0].'\">'.$complex[1].'</option>';\n}\necho '\n            </select>\n            </td>\n        </tr>';\necho '\n    </table>\n    <div id=\"add_folder_loader\" style=\"display:none;text-align:center;margin-top:20px;\">\n        <i class=\"fa fa-cog fa-spin\"></i>&nbsp;'.$LANG['please_wait'].'...\n    </div>\n</div>';\n// Formulaire EDITER REPERTORIE\necho '\n<div id=\"div_editer_rep\" style=\"display:none;\">\n    <div id=\"edit_rep_show_error\" style=\"text-align:center;margin:2px;display:none;\" class=\"ui-state-error ui-corner-all\"></div>\n    <table>\n        <tr>\n            <td>'.$LANG['new_label'].' : </td>\n            <td><input type=\"text\" id=\"edit_folder_title\" style=\"width:242px; padding:3px;\" class=\"ui-widget-content\" /></td>\n        </tr>\n        <tr>\n            <td>'.$LANG['group_select'].' : </td>\n            <td><select id=\"edit_folder_folder\" style=\"width:250px; padding:3px;\" class=\"ui-widget-content\"></select></td>\n        </tr>\n        <tr>\n            <td>'.$LANG['complex_asked'].' : </td>\n            <td><select id=\"edit_folder_complexity\" style=\"width:250px; padding:3px;\" class=\"ui-widget-content\">\n                <option value=\"\">---</option>';\nforeach ($SETTINGS_EXT['pwComplexity'] as $complex) {\n    echo '<option value=\"'.$complex[0].'\">'.$complex[1].'</option>';\n}\necho '\n            </select>\n            </td>\n        </tr>\n    </table>\n    <div id=\"edit_folder_loader\" style=\"display:none;text-align:center;margin-top:20px;\">\n        <i class=\"fa fa-cog fa-spin\"></i>&nbsp;'.$LANG['please_wait'].'...\n    </div>\n</div>';\n// Formulaire MOVE FOLDER\necho '\n<div id=\"div_move_folder\" style=\"display:none;\">\n    <div id=\"move_rep_show_error\" style=\"text-align:center;margin:2px;display:none;\" class=\"ui-state-error ui-corner-all\"></div>\n    <div style=\"text-align:center;margin-top:20px;\">\n        <p>'.$LANG['folder_will_be_moved_below'].'</p>\n        <div>\n        <select id=\"move_folder_id\" style=\"width:250px; padding:3px;\" class=\"ui-widget-content\">\n        </select>\n        </div>\n    </div>\n    <div id=\"move_folder_loader\" style=\"display:none;text-align:center;margin-top:20px;\">\n        <i class=\"fa fa-cog fa-spin\"></i>&nbsp;'.$LANG['please_wait'].'...\n    </div>\n</div>';\n// Formulaire COPY FOLDER\necho '\n<div id=\"div_copy_folder\" style=\"display:none;\">\n    <div id=\"div_copy_folder_info\" class=\"ui-widget-content ui-state-highlight ui-corner-all\" style=\"padding:5px;\"><span class=\"fa fa-info-circle fa-2x\"></span>&nbsp;'.$LANG['copy_folder_info'].'</div>\n\n    <div style=\"margin:10px 0 0 0;\">\n        <label style=\"float:left; width:150px;\">'.$LANG['copy_folder_source'].'</label>\n        <select id=\"copy_folder_source_id\" style=\"width:300px; padding:3px;\" class=\"ui-widget-content\"></select>\n    </div>\n    <div style=\"margin:10px 0 0 0;\">\n        <label style=\"float:left; width:150px;\">'.$LANG['copy_folder_destination'].'</label>\n        <select id=\"copy_folder_destination_id\" style=\"width:300px; padding:3px;\" class=\"ui-widget-content\"></select>\n    </div>\n\n    <div id=\"div_copy_folder_msg\" style=\"text-align:center;padding:5px;display:none; margin-top:10px; font-size:14px;\" class=\"ui-corner-all\"></div>\n</div>';\n// Formulaire SUPPRIMER REPERTORIE\necho '\n<div id=\"div_supprimer_rep\" style=\"display:none;\">\n    <table>\n        <tr>\n            <td>'.$LANG['group_select'].' : </td>\n            <td><select id=\"delete_rep_groupe\" style=\"width:250px; padding:3px;\" class=\"ui-widget-content\">\n            </select></td>\n        </tr>\n        <tr>\n        <td colspan=\"2\">\n            <div id=\"delete_rep_groupe_validate_div\" class=\"ui-state-default ui-corner-all\" style=\"padding:5px; margin-top:10px;\">\n                <input type=\"checkbox\" id=\"delete_rep_groupe_validate\"><label for=\"delete_rep_groupe_validate\">'.$LANG['confirm_delete_group'].'</label>\n            </div>\n        </td>\n        </tr>\n    </table>\n    <div id=\"del_rep_show_error\" style=\"text-align:center;padding:5px;display:none;margin-top:10px;\" class=\"ui-state-error ui-corner-all\"></div>\n\n    <div id=\"del_folder_loader\" style=\"display:none;text-align:center;margin-top:15px;\">\n        <i class=\"fa fa-cog fa-spin\"></i>&nbsp;'.$LANG['please_wait'].'...\n    </div>\n</div>';\n// SUPPRIMER UN ELEMENT\necho '\n<div id=\"div_del_item\" style=\"display:none;\">\n        <h2 id=\"div_del_item_selection\"></h2>\n        <div style=\"text-align:center;padding:8px;\" class=\"ui-state-error ui-corner-all\">\n            <span class=\"fa fa-warning fa-2x\"></span>&nbsp;'.$LANG['confirm_deletion'].'\n        </div>\n</div>';\n// DIALOG INFORM USER THAT LINK IS COPIED\necho '\n<div id=\"div_item_copied\" style=\"display:none;\">\n    <div style=\"text-align:center;padding:8px;\" class=\"ui-state-focus ui-corner-all\">\n        <span class=\"fa fa-info fa-2x\"></span>&nbsp;'.$LANG['link_is_copied'].'\n    </div>\n    <div id=\"div_display_link\"></div>\n</div>';\n// DIALOG TO WHAT FOLDER COPYING ITEM\necho '\n<div id=\"div_copy_item_to_folder\" style=\"display:none;\">\n    <h2 id=\"div_copy_item_to_folder_item\"></h2>\n    <div style=\"text-align:center;\">\n        <div>'.$LANG['item_copy_to_folder'].'</div>\n        <div style=\"margin:10px;\">\n            <select id=\"copy_in_folder\" style=\"width:300px;\">\n                ', (isset($_SESSION['can_create_root_folder']) && $_SESSION['can_create_root_folder'] == 1) ? '<option value=\"0\">'.$LANG['root'].'</option>' : '', ''.\n            '</select>\n        </div>\n    </div>\n    <div id=\"copy_item_to_folder_show_error\" style=\"text-align:center;margin:2px;display:none; padding:3px;\" class=\"ui-state-error ui-corner-all\"></div>\n    <div style=\"height:20px;text-align:center;margin:2px;\" id=\"copy_item_info\" class=\"\"></div>\n</div>';\n// DIALOG FOR HISTORY OF ITEM\necho '\n<div id=\"div_item_history\" style=\"display:none;\">\n    <div id=\"item_history_log\"></div>\n    ', (isset($SETTINGS['insert_manual_entry_item_history']) && $SETTINGS['insert_manual_entry_item_history'] == 1) ?\n'<div id=\"new_history_entry_form\" style=\"display:none; margin-top:10px;\"><hr>\n        <div id=\"div_add_history_entry\">\n            <div id=\"item_history_log_error\"></div>\n            '.$LANG['label'].'&nbsp;<input type=\"text\" id=\"add_history_entry_label\" size=\"40\" />&nbsp;\n            <span class=\"button\" style=\"margin-top:6px;\" onclick=\"manage_history_entry(\\'add_entry\\',\\'\\')\">'.$LANG['add_history_entry'].'</div>\n        </div>\n    </div>'\n:'', '\n</div>';\n// DIALOG FOR ITEM SHARE\necho '\n<div id=\"div_item_share\" style=\"display:none;\">\n    <div id=\"div_item_share_error\" style=\"text-align:center;margin:2px;display:none;\" class=\"ui-state-error ui-corner-all\"></div>\n    <div style=\"\">'.$LANG['item_share_text'].'</div>\n    <input type=\"text\" id=\"item_share_email\" class=\"ui-corner-all\" style=\"width:100%;\" />\n    <div id=\"div_item_share_status\" style=\"text-align:center;margin-top:15px;display:none; padding:5px;\" class=\"ui-corner-all\">\n        <i class=\"fa fa-cog fa-spin fa-2x\"></i>&nbsp;<b>'.$LANG['please_wait'].'</b>\n    </div>\n</div>';\n// DIALOG FOR ITEM IS UPDATED\necho '\n<div id=\"div_item_updated\" style=\"display:none;\">\n    <div style=\"\">'.$LANG['item_updated_text'].'</div>\n</div><br />';\n\n// DIALOG FOR SUGGESTING PWD CHANGE\necho '\n<div id=\"div_suggest_change\" style=\"display:none;\">\n    <div style=\"padding:5px; text-align:center;\" class=\"ui-corner-all ui-state-default\"><i class=\"fa fa-info-circle fa-lg\"></i>&nbsp;'.$LANG['suggest_password_change_intro'].'</div>\n    <div style=\" margin-top:10px;\" id=\"div_suggest_change_html\"></div>\n    <div id=\"div_suggest_change_wait\" style=\"margin-top:10; padding:5px; display:none;\" class=\"ui-state-focus ui-corner-all\"></div>\n</div><br />';\n\n// Off line mode\nif (isset($SETTINGS['settings_offline_mode']) && $SETTINGS['settings_offline_mode'] == 1) {\n    echo '\n    <div id=\"dialog_offline_mode\" style=\"display:none;\">\n        <div id=\"div_offline_mode\">\n            <i class=\"fa fa-cog fa-spin fa-2x\"></i>\n        </div>\n    </div>';\n}\n\n// Export items to file\nif (isset($SETTINGS['allow_print']) && $SETTINGS['allow_print'] == 1 && $_SESSION['temporary']['user_can_printout'] === true) {\n    echo '\n    <div id=\"dialog_export_file\" style=\"display:none;\">\n        <div id=\"div_export_file\">\n            <i class=\"fa fa-cog fa-spin fa-2x\"></i>\n        </div>\n    </div>';\n}\n\n// Import items\nif (isset($SETTINGS['allow_import']) && $SETTINGS['allow_import'] == 1 && $session_user_admin !== '1') {\n    echo '\n    <div id=\"dialog_import_file\" style=\"display:none;\">\n        <div id=\"div_import_file\">\n            <i class=\"fa fa-cog fa-spin fa-2x\"></i>\n        </div>\n    </div>';\n}\n\n// USERS passwords upgrade\nif (isset($SETTINGS['enable_pf_feature']) && $SETTINGS['enable_pf_feature'] == 1\n    && $session_user_admin !== '1' && isset($_SESSION['user_upgrade_needed']) && $_SESSION['user_upgrade_needed'] == 1\n) {\n    echo '\n    <div id=\"dialog_upgrade_personal_passwords\" style=\"display:none;\">\n        <div style=\"text-align:center;\">\n            <div>'.$LANG['pf_change_encryption'].'</div>\n            <div id=\"dialog_upgrade_personal_passwords_status\" style=\"margin:15px 0 15px 0; font-weight:bold;\">', isset($_SESSION['user_settings']['session_psk']) ? $LANG['pf_sk_set'] : $LANG['pf_sk_not_set'], '</div>\n        </div>\n    </div>';\n}\n\n// SSH dialogbox\necho '\n<div id=\"dialog_ssh\" style=\"display:none;padding:4px;\">\n    <div id=\"div_ssh\">\n        <i class=\"fa fa-cog fa-spin fa-2x\"></i>&nbsp;<b>'.$LANG['please_wait'].'</b>\n    </div>\n</div>';\n\nrequire_once 'items.load.php';\n", "<?php\n/**\n * @file          roles.load.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\n\nif (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n    die('Hacking attempt...');\n}\n?>\n<script type=\"text/javascript\">\n//<![CDATA[\n$(function() {\n    // manage delete\n    $(\"input[name=right_types_radio]\").click(function(event) {\n        if ($(\"input[name=right_types_radio]:checked\").attr(\"id\").substring(6) == \"write\") {\n            $(\"#div_delete_option\").show();\n        } else {\n            $(\"#div_delete_option\").hide();\n        }\n    });\n\n\n    $(\"#add_new_role\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 400,\n        height: 280,\n        title: \"<?php echo $LANG[\"give_function_title\"]; ?>\",\n        buttons: {\n            \"<?php echo $LANG[\"save_button\"]; ?>\": function() {\n                $(\"#new_role_error\").hide().html(\"\");\n                if ($(\"#new_role_complexity\").val() != \"\") {\n                    $(\"#add_role_loader\").show();\n                    $.post(\n                        \"sources/roles.queries.php\",\n                        {\n                            type    : \"add_new_role\",\n                            name    : $(\"#new_function\").val(),\n                            complexity    : $(\"#new_role_complexity\").val()\n                        },\n                        function(data) {\n                            if (data[0].error == \"no\") {\n                                $(\"#new_function\").val(\"\");\n                                $(\"#add_new_role\").dialog(\"close\");\n                                refresh_roles_matrix(\"reload\");\n                            } else {\n                                $(\"#new_role_error\").show().html(data[0].message);\n                            }\n                            $(\"#add_role_loader\").hide();\n                        },\n                        \"json\"\n                   );\n                } else {\n                    $(\"#new_role_error\").show().html(\"<?php echo addslashes($LANG['error_role_complex_not_set']); ?>\");\n                }\n            },\n            \"<?php echo $LANG[\"cancel_button\"]; ?>\": function() {\n                $(this).dialog(\"close\");\n            }\n        }\n    });\n\n    $(\"#delete_role\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 400,\n        height: 190,\n        title: \"<?php echo $LANG[\"admin_action\"]; ?>\",\n        buttons: {\n            \"<?php echo $LANG[\"ok\"]; ?>\": function() {\n                $(\"#delete_role_loader\").show();\n                $.post(\n                    \"sources/roles.queries.php\",\n                    {\n                        type    : \"delete_role\",\n                        id        : $(\"#delete_role_id\").val()\n                    },\n                    function(data) {\n                        if (data[0].error == \"no\") {\n                            $(\"#delete_role\").dialog(\"close\");\n                            refresh_roles_matrix(\"reload\");\n                        }\n                        $(\"#delete_role_loader\").hide();\n                    },\n                    \"json\"\n               );\n            },\n            \"<?php echo $LANG[\"cancel_button\"]; ?>\": function() {\n                $(this).dialog(\"close\");\n            }\n        }\n    });\n\n    $(\"#edit_role\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 400,\n        height: 300,\n        title: \"<?php echo $LANG[\"admin_action\"]; ?>\",\n        buttons: {\n            \"<?php echo $LANG[\"ok\"]; ?>\": function() {\n                $(\"#edit_role_error\").hide().html(\"\");\n                $(\"#edit_role_loader\").show();\n                $.post(\n                    \"sources/roles.queries.php\",\n                    {\n                        type    : \"edit_role\",\n                        id      : $(\"#edit_role_id\").val(),\n                        start    : $('#role_start').val(),\n                        title      : $(\"#edit_role_title\").val(),\n                        complexity    : $(\"#edit_role_complexity\").val()\n                    },\n                    function(data) {\n                        if (data[0].error == \"yes\") {\n                            $(\"#edit_role_error\").show().html(data[0].message);\n                        } else {\n                            $(\"#edit_role_title\").val(\"\");\n                            $(\"#edit_role\").dialog(\"close\");\n                            $(\"#div_loading\").show();\n                            refresh_roles_matrix(\"reload\");\n                        }\n                        $(\"#edit_role_loader\").hide();\n                    },\n                    \"json\"\n               );\n            },\n            \"<?php echo $LANG[\"cancel_button\"]; ?>\": function() {\n                $(\"#edit_role_error\").html(\"\").hide();\n                $(this).dialog(\"close\");\n            }\n        }\n    });\n\n    $(\"#type_of_rights\").dialog({\n        bgiframe: false,\n        modal: false,\n        autoOpen: false,\n        width: 300,\n        height: 270,\n        title: \"<?php echo $LANG[\"change_right_access\"]; ?>\",\n        buttons: {\n            \"<?php echo $LANG[\"save_button\"]; ?>\": function() {\n                $(\"#edit_role_error\").hide().html(\"\");\n                $(\"#role_rights_loader\").show();\n\n                // get write option\n                var accessoption = \"\";\n                if ($(\"input[name=right_types_radio]:checked\").attr(\"id\").substring(6) == \"write\") {\n                    if ($(\"#right_nodelete\").prop(\"checked\") === true && $(\"#right_noedit\").prop(\"checked\") === true) {\n                        accessoption = \"nodelete_noedit\";\n                    } else if ($(\"#right_nodelete\").prop(\"checked\") === true) {\n                        accessoption = \"nodelete\";\n                    } else if ($(\"#right_noedit\").prop(\"checked\") === true) {\n                        accessoption = \"noedit\";\n                    }\n                }\n\n                // is several folders selected?\n                var multiselection = '',\n                    tmp;\n                $(\".multi_folders:checkbox:checked\").each(function(){\n                    tmp = $(this).attr('id').substring(9).split('_');\n                    multiselection += tmp[0] + \"-\" + tmp[1] + \",\";   //folder_id-role_id\n                });\n                multiselection += $(\"#change_folder\").val() + \"-\" + $('#change_role').val();\n\n                $.post(\n                    \"sources/roles.queries.php\",\n                    {\n                        type    : \"change_role_via_tm\",\n                        access  : $(\"input[name=right_types_radio]:checked\").attr(\"id\").substring(6),\n                        accessoption : accessoption,\n                        //folder  : $(\"#change_folder\").val(),\n                        //role    : $('#change_role').val(),\n                        line    : $(\"#change_line\").val(),\n                        multiselection: multiselection\n                    },\n                    function(data) {\n                        $(\"#div_loading\").show();\n                        refresh_roles_matrix(\"reload\");\n                        $(\"#type_of_rights\").dialog(\"close\");\n                        $(\"#role_rights_loader\").hide();\n                    },\n                    \"json\"\n               );\n            },\n            \"<?php echo $LANG[\"close\"]; ?>\": function() {\n                $(this).dialog(\"close\");\n            }\n        },\n        open: function() {\n            $(\"#accordion\").accordion({ autoHeight: false, navigation: true, collapsible: true, active: false });\n        }\n    });\n\n\n\n    refresh_roles_matrix();\n});\n\n//###########\n//## FUNCTION : Change the actual right of the role other the select folder\n//###########\nfunction tm_change_role(role,folder,cell_id,allowed)\n{\n    $(\"#div_loading\").show();\n    $.post(\n        \"sources/roles.queries.php\",\n        {\n            type    : \"change_role_via_tm\",\n            role    : role,\n            folder    : folder,\n            cell_id    : cell_id,\n            allowed    : allowed\n        },\n        function(data) {\n            refresh_roles_matrix(\"reload\");\n            $(\"#div_loading\").hide();\n        }\n   );\n}\n\nfunction delete_this_role(id,name)\n{\n    $(\"#delete_role_id\").val(id);\n    $(\"#delete_role_show\").html(name);\n    $(\"#delete_role\").dialog(\"open\");\n}\n\nfunction edit_this_role(id,name,complexity)\n{\n    $(\"#edit_role_id\").val(id);\n    $(\"#edit_role_show\").html(name);\n    $(\"#edit_role_title\").val(name);\n    $(\"#edit_role_complexity\").val(complexity);\n    $(\"#edit_role\").dialog(\"open\");\n}\n\nfunction allow_pw_change_for_role(id, value)\n{\n    $(\"#div_loading\").show();\n    //Send query\n    $.post(\n        \"sources/roles.queries.php\",\n        {\n            type    : \"allow_pw_change_for_role\",\n            id      : id,\n            value      : value\n        },\n        function(data) {\n            if (value == 0)\n                $(\"#img_apcfr_\"+id).attr(\"class\",\"fa mi-red fa-2x fa-magic tip\");\n            else\n                $(\"#img_apcfr_\"+id).attr(\"class\",\"fa mi-green fa-2x fa-magic tip\");\n            $(\"#div_loading\").hide();\n            refresh_roles_matrix(\"reload\");\n        }\n   );\n}\n\n/**\n *\n * @access public\n * @return void\n **/\nfunction refresh_roles_matrix(order)\n{\n    $(\"#div_loading\").show();\n\n    //clean up\n    $(\"#roles_next, #roles_previous\").hide();\n\n    //manage start query\n    if (order == \"next\") {\n        var start = $('#next_role').val();\n    } else if (order == \"previous\") {\n        var start = $('#previous_role').val();\n    } else if (order == \"reload\") {\n        var start = $('#role_start').val();\n    } else {\n        var start = 0;\n    }\n    $('#role_start').val(start);\n\n    //send query\n    $.post(\n        \"sources/roles.queries.php\",\n        {\n            type    : \"refresh_roles_matrix\",\n            start    : start\n        },\n        function(data) {\n            //decrypt data\n            data = $.parseJSON(data);\n            $(\"#matrice_droits\").html(\"\");\n            if (data.new_table != \"\") {\n                $(\"#matrice_droits\").html(data.new_table);\n                if (data.next < data.all) {\n                    $(\"#roles_next\").show();\n                }\n                if (data.next >= 9 && data.previous >= 0) {\n                    $(\"#roles_previous\").show();\n                }\n                //manage next & previous arrows\n                $('#next_role').val(data.next);\n                $('#previous_role').val(data.previous);\n            } else {\n                $(\"#matrice_droits\").html(data.error);\n            }\n            $(\"#div_loading\").hide();\n        }\n   );\n}\n\nfunction openRightsDialog(role, folder, line, right)\n{\n    if (right == \"W\") {\n        $(\"#right_write\").prop(\"checked\", true);\n        $(\"#right_nodelete, #right_noedit\").prop(\"checked\", false);\n        $(\"#div_delete_option\").show();\n    } else if (right == \"ND\") {\n        $(\"#right_write\").prop(\"checked\", true);\n        $(\"#right_nodelete\").prop(\"checked\", true);\n        $(\"#right_noedit\").prop(\"checked\", false);\n        $(\"#div_delete_option\").show();\n    } else if (right == \"NE\") {\n        $(\"#right_write\").prop(\"checked\", true);\n        $(\"#right_nodelete\").prop(\"checked\", false);\n        $(\"#right_noedit\").prop(\"checked\", true);\n        $(\"#div_delete_option\").show();\n    } else if (right == \"NDNE\") {\n        $(\"#right_write\").prop(\"checked\", true);\n        $(\"#right_noedit, #right_nodelete\").prop(\"checked\", true);\n        $(\"#div_delete_option\").show();\n    } else if (right == \"R\") {\n        $(\"#right_read\").prop(\"checked\", true);\n        $(\"#div_delete_option\").hide();\n    } else {\n        $(\"#right_noaccess\").prop(\"checked\", true);\n        $(\"#div_delete_option\").hide();\n    }\n    $(\"#change_role\").val(role);\n    $(\"#change_folder\").val(folder);\n    $(\"#change_line\").val(line);\n    $(\"#type_of_rights\").dialog(\"open\");\n}\n//]]>\n</script>\n", "<?php\n/**\n * @file          roles.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\n\nif (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 ||\n    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) ||\n    !isset($_SESSION['key']) || empty($_SESSION['key'])\n) {\n    die('Hacking attempt...');\n}\n\n// Load config\nif (file_exists('../includes/config/tp.config.php')) {\n    require_once '../includes/config/tp.config.php';\n} elseif (file_exists('./includes/config/tp.config.php')) {\n    require_once './includes/config/tp.config.php';\n} else {\n    throw new Exception(\"Error file '/includes/config/tp.config.php' not exists\", 1);\n}\n\n/* do checks */\nrequire_once $SETTINGS['cpassman_dir'].'/sources/checks.php';\nif (!checkUser($_SESSION['user_id'], $_SESSION['key'], curPage())) {\n    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n    include $SETTINGS['cpassman_dir'].'/error.php';\n    exit();\n}\n\nrequire_once $SETTINGS['cpassman_dir'].'/sources/main.functions.php';\n\n//Get full list of groups\n$arr_groups = array();\n$rows = DB::query(\"SELECT id,title FROM \".prefix_table(\"nested_tree\"));\nforeach ($rows as $reccord) {\n    $arr_groups[$reccord['id']] = $reccord['title'];\n}\n\n//display\necho '\n<div class=\"title ui-widget-content ui-corner-all\">\n    '.$LANG['admin_functions'].'&nbsp;&nbsp;\n    <button title=\"'.htmlentities(strip_tags($LANG['add_role_tip']), ENT_QUOTES).'\" onclick=\"OpenDialog(\\'add_new_role\\')\" class=\"button\" style=\"font-size:16px;\">\n        <i class=\"fa fa-plus\"></i>\n    </button>\n    <button title=\"'.htmlentities(strip_tags($LANG['refresh_matrix']), ENT_QUOTES).'\" onclick=\"refresh_roles_matrix()\" class=\"button\" style=\"font-size:16px;\">\n        <i class=\"fa fa-refresh\"></i>\n    </button>\n</div>\n<div style=\"line-height:20px;\" align=\"center\">\n    <div id=\"matrice_droits\"></div>\n    <div style=\"\">\n        <span class=\"fa fa-arrow-left\" style=\"display:none;cursor:pointer\" id=\"roles_previous\" onclick=\"refresh_roles_matrix(\\'previous\\')\"></span>&nbsp;\n        <span class=\"fa fa-arrow-right\" style=\"display:none;cursor:pointer\" id=\"roles_next\" onclick=\"refresh_roles_matrix(\\'next\\')\"></span>\n    </div>\n</div>\n<input type=\"hidden\" id=\"selected_function\" />\n<input type=\"hidden\" id=\"next_role\" value=\"0\" />\n<input type=\"hidden\" id=\"previous_role\" value=\"0\" />\n<input type=\"hidden\" id=\"role_start\" value=\"0\" />\n<input type=\"hidden\" id=\"change_role\" value=\"0\" />\n<input type=\"hidden\" id=\"change_folder\" value=\"0\" />\n<input type=\"hidden\" id=\"change_line\" value=\"0\" />';\n\n// DIV FOR ADDING A ROLE\necho '\n<div id=\"add_new_role\" style=\"\">\n    <div style=\"text-align:center;padding:2px;display:none;\" class=\"ui-state-error ui-corner-all\" id=\"new_role_error\"></div>\n    <p>\n    <label for=\"new_function\" class=\"form_label_100\">'.$LANG['name'].'</label><input type=\"text\" id=\"new_function\" size=\"40\" />\n    </p>\n    <p>\n    <label for=\"new_role_complexity\" class=\"form_label\">'.$LANG['complex_asked'].' :</label>\n    <select id=\"new_role_complexity\" class=\"input_text text ui-widget-content ui-corner-all\">\n        <option value=\"\">---</option>';\nforeach ($SETTINGS_EXT['pwComplexity'] as $complex) {\n    echo '<option value=\"'.$complex[0].'\">'.$complex[1].'</option>';\n}\necho '\n    </select>\n    </p>\n    <div id=\"add_role_loader\" style=\"display:none;text-align:center;margin-top:20px;\">\n        <i class=\"fa fa-cog fa-spin\"></i>&nbsp;'.$LANG['please_wait'].'...\n    </div>\n</div>';\n\n// DIV FOR DELETING A ROLE\necho '\n<div id=\"delete_role\" style=\"display:none;\">\n    <div>'.$LANG['confirm_del_role'].'</div>\n    <div style=\"font-weight:bold;text-align:center;color:#FF8000;text-align:center;font-size:13pt;\" id=\"delete_role_show\"></div>\n    <input type=\"hidden\" id=\"delete_role_id\" />\n    <div id=\"delete_role_loader\" style=\"display:none;text-align:center;margin-top:20px;\">\n        <i class=\"fa fa-cog fa-spin\"></i>&nbsp;'.$LANG['please_wait'].'...\n    </div>\n</div>';\n\n// DIV FOR EDITING A ROLE\necho '\n<div id=\"edit_role\" style=\"display:none;\">\n    <div style=\"text-align:center;padding:2px;display:none;\" class=\"ui-state-error ui-corner-all\" id=\"edit_role_error\"></div>\n    <div>'.$LANG['confirm_edit_role'].'</div>\n    <div style=\"font-weight:bold;text-align:center;color:#FF8000;text-align:center;font-size:13pt;\" id=\"edit_role_show\"></div>\n    <input type=\"hidden\" id=\"edit_role_id\" />\n    <label for=\"edit_role_title\" class=\"form_label\">'.$LANG['new_role_title'].'</label><input type=\"text\" id=\"edit_role_title\" size=\"40\" />\n    <p>\n    <label for=\"edit_role_complexity\" class=\"form_label\">'.$LANG['complex_asked'].' :</label>\n    <select id=\"edit_role_complexity\" class=\"input_text text ui-widget-content ui-corner-all\">\n        <option value=\"\">---</option>';\nforeach ($SETTINGS_EXT['pwComplexity'] as $complex) {\n    echo '<option value=\"'.$complex[0].'\">'.$complex[1].'</option>';\n}\necho '\n    </select>\n    </p>\n    <div id=\"edit_role_loader\" style=\"display:none;text-align:center;margin-top:20px;\">\n        <i class=\"fa fa-cog fa-spin\"></i>&nbsp;'.$LANG['please_wait'].'...\n    </div>\n</div>';\n\n// DIV FOR TYPE OF RIGHTS\necho '\n<div id=\"type_of_rights\">\n    <div>'.$LANG['right_types_label'].'</div>\n    <div style=\"margin-top:10px; text-align:center;\">\n        <input type=\"radio\" name=\"right_types_radio\" id=\"right_write\" /><label for=\"right_write\">'.$LANG['write'].'</label>&nbsp;\n        <input type=\"radio\" name=\"right_types_radio\" id=\"right_read\" /><label for=\"right_read\">'.$LANG['read'].'</label>&nbsp;\n        <input type=\"radio\" name=\"right_types_radio\" id=\"right_noaccess\" /><label for=\"right_noaccess\">'.$LANG['no_access'].'</label>\n    </div>\n    <div style=\"margin:10px 0 0 30px; display:none;\" id=\"div_delete_option\">\n        <input type=\"checkbox\" id=\"right_nodelete\" />&nbsp;'.$LANG['role_cannot_delete_item'].'<br />\n        <input type=\"checkbox\" id=\"right_noedit\" />&nbsp;'.$LANG['role_cannot_edit_item'].'\n    </div>\n    <div id=\"role_rights_loader\" style=\"display:none;text-align:center;margin-top:20px;\">\n        <i class=\"fa fa-cog fa-spin\"></i>&nbsp;'.$LANG['please_wait'].'...\n    </div>\n</div>';\n\n//call to roles.load.php\nrequire_once 'roles.load.php';\n", "<?php\n/**\n * @file          import.queries.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\nuse Goodby\\CSV\\Import\\Standard\\Lexer;\nuse Goodby\\CSV\\Import\\Standard\\Interpreter;\nuse Goodby\\CSV\\Import\\Standard\\LexerConfig;\n\nrequire_once 'SecureHandler.php';\nsession_start();\nif (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || !isset($_SESSION['key']) || empty($_SESSION['key'])) {\n    die('Hacking attempt...');\n}\n\n// Load config\nif (file_exists('../includes/config/tp.config.php')) {\n    require_once '../includes/config/tp.config.php';\n} elseif (file_exists('./includes/config/tp.config.php')) {\n    require_once './includes/config/tp.config.php';\n} else {\n    throw new Exception(\"Error file '/includes/config/tp.config.php' not exists\", 1);\n}\n\n// No time limit\nset_time_limit(0);\n\n// Set some constants for program readability\ndefine('KP_PATH', 0);\ndefine('KP_GROUP', 1);\ndefine('KP_TITLE', 2);\ndefine('KP_PASSWORD', 3);\ndefine('KP_USERNAME', 4);\ndefine('KP_URL', 5);\ndefine('KP_UUID', 6);\ndefine('KP_NOTES', 7);\n\n/*\n * sanitiseString\n *\n * Used to format the string ready for insertion in to the database\n */\n/**\n * @param string $crLFReplacement\n */\nfunction sanitiseString($str, $crLFReplacement)\n{\n    $str = preg_replace('#[\\r\\n]#', $crLFReplacement, $str);\n    $str = str_replace('\\\\', '&#92;', $str);\n    $str = str_replace('\"', \"&quot;\", $str);\n    if (!empty($str)) {\n        addslashes($str);\n    }\n    return $str;\n}\n\nglobal $k, $settings;\nheader(\"Content-type: text/html; charset=utf-8\");\nerror_reporting(E_ERROR);\ninclude $SETTINGS['cpassman_dir'].'/includes/config/settings.php';\n\n//Class loader\nrequire_once $SETTINGS['cpassman_dir'].'/sources/SplClassLoader.php';\n\n// call needed functions\nrequire_once $SETTINGS['cpassman_dir'].'/sources/main.functions.php';\n\n// connect to the server\nrequire_once $SETTINGS['cpassman_dir'].'/includes/libraries/Database/Meekrodb/db.class.php';\n$pass = defuse_return_decrypted($pass);\nDB::$host = $server;\nDB::$user = $user;\nDB::$password = $pass;\nDB::$dbName = $database;\nDB::$port = $port;\nDB::$encoding = $encoding;\nDB::$error_handler = true;\n$link = mysqli_connect($server, $user, $pass, $database, $port);\n$link->set_charset($encoding);\n\n//Load Tree\n$tree = new SplClassLoader('Tree\\NestedTree', '../includes/libraries');\n$tree->register();\n$tree = new Tree\\NestedTree\\NestedTree($pre.'nested_tree', 'id', 'parent_id', 'title');\n\n//Load AES\n$aes = new SplClassLoader('Encryption\\Crypt', '../includes/libraries');\n$aes->register();\n\n//User's language loading\nrequire_once $SETTINGS['cpassman_dir'].'/includes/language/'.$_SESSION['user_language'].'.php';\n\n// Build query\nswitch (filter_input(INPUT_POST, 'type', FILTER_SANITIZE_STRING)) {\n    //Check if import CSV file format is what expected\n    case \"import_file_format_csv\":\n        //load full tree\n        $tree->rebuild();\n        $tree = $tree->getDescendants();\n       // Init post variable\n        $post_operation_id = filter_input(INPUT_POST, 'file', FILTER_SANITIZE_NUMBER_INT);\n\n        // Get filename from database\n        $data = DB::queryFirstRow(\n            \"SELECT valeur\n            FROM \".$pre.\"misc\n            WHERE increment_id = %i\",\n            $post_operation_id\n        );\n\n        // Delete operation id\n        DB::delete(\n            prefix_table('misc'),\n            \"increment_id = %i\",\n            $post_operation_id\n        );\n\n        // do some initializations\n        $file = $SETTINGS['path_to_files_folder'].\"/\".$data['valeur'];\n        $size = 4096;\n        $separator = \",\";\n        $enclosure = '\"';\n        $fields_expected = array(\"Label\", \"Login\", \"Password\", \"URL\", \"Comments\"); //requiered fields from CSV\n        $importation_possible = true;\n        $display = \"<table>\";\n        $line_number = $prev_level = 0;\n        $account = $text = \"\";\n        $continue_on_next_line = false;\n\n        // Open file\n        if ($fp = fopen($file, \"r\")) {\n            // data from CSV\n            $valuesToImport = array();\n            // load libraries\n            require_once $SETTINGS['cpassman_dir'].'/includes/libraries/Goodby/CSV/Import/Standard/Lexer.php';\n            require_once $SETTINGS['cpassman_dir'].'/includes/libraries/Goodby/CSV/Import/Standard/Interpreter.php';\n            require_once $SETTINGS['cpassman_dir'].'/includes/libraries/Goodby/CSV/Import/Standard/LexerConfig.php';\n\n            // Lexer configuration\n            $config = new LexerConfig();\n            $lexer = new Lexer($config);\n            $config->setIgnoreHeaderLine(\"true\");\n            // extract data from CSV file\n            $interpreter = new Interpreter();\n            $interpreter->addObserver(function (array $row) use (&$valuesToImport) {\n                $valuesToImport[] = array(\n                    'Label'     => $row[0],\n                    'Login'     => $row[1],\n                    'Password'  => $row[2],\n                    'url'       => $row[3],\n                    'Comments'  => $row[4],\n                );\n            });\n            $lexer->parse($file, $interpreter);\n\n            // extract one line\n            foreach ($valuesToImport as $key => $row) {\n                //Check number of fields. MUST be 5. if not stop importation\n                if (count($row) != 5) {\n                    $importation_possible = false;\n                    //Stop if file has not expected structure\n                    if ($importation_possible === false) {\n                        echo '[{\"error\":\"bad_structure\"}]';\n                        break;\n                    }\n                }\n\n                //If any comment is on several lines, then replace 'lf' character\n                $row['Comments'] = str_replace(array(\"\\r\\n\", \"\\n\", \"\\r\"), \"<br />\", $row['Comments']);\n\n                // Check if current line contains a \"<br />\" character in order to identify an ITEM on several CSV lines\n                if (substr_count('<br />', $row['Comments']) > 0 || substr_count('<br />', $row['Label']) > 0) {\n                    $continue_on_next_line = true;\n                    $comment .= addslashes($row['Label']);\n                } else {\n                    // Store in variable values from previous line\n                    if (!empty($account)) {\n                        if ($continue_on_next_line === false) {\n                            // Prepare listing that will be shown to user\n                            $display .= '<tr><td><input type=\\\"checkbox\\\" class=\\\"item_checkbox\\\" id=\\\"item_to_import-'.$line_number.'\\\" /></td><td><span id=\\\"item_text-'.$line_number.'\\\">'.$account.'</span><input type=\\\"hidden\\\" value=\\\"'.$account.'@|@'.$login.'@|@'.$pwd.'@|@'.$url.'@|@'.$comment.'@|@'.$line_number.'\\\" id=\\\"item_to_import_values-'.$line_number.'\\\" /></td></tr>';\n\n                            // Initialize this variable in order to restart from scratch\n                            $account = \"\";\n                        }\n                    }\n                }\n\n                // Get values of current line\n                if ($account == \"\" && $continue_on_next_line === false) {\n                    $account = htmlspecialchars($row['Label'], ENT_QUOTES, 'UTF-8');\n                    $login = htmlspecialchars($row['Login'], ENT_QUOTES, 'UTF-8');\n                    $pwd = str_replace('\"', \"&quot;\", $row['Password']);\n                    $url = addslashes($row['url']);\n                    $to_find = array(\"\\\"\", \"'\");\n                    $to_ins = array(\"&quot\", \"&#39;\");\n                    $comment = htmlentities(addslashes(str_replace($to_find, $to_ins, $row['Comments'])), ENT_QUOTES, 'UTF-8');\n\n                    $continue_on_next_line = false;\n                }\n\n                //increment number of lines found\n                $line_number++;\n            }\n            // close file\n            fclose($fp);\n        } else {\n            echo '[{\"error\":\"cannot_open\"}]';\n            break;\n        }\n\n        if ($line_number > 0) {\n            //add last line\n            $display .= '<tr><td><input type=\\\"checkbox\\\" class=\\\"item_checkbox\\\" id=\\\"item_to_import-'.$line_number.'\\\" /></td><td><span id=\\\"item_text-'.$line_number.'\\\">'.$account.'</span><input type=\\\"hidden\\\" value=\\\"'.$account.'@|@'.$login.'@|@'.str_replace('\"', \"&quote;\", $pwd).'@|@'.$url.'@|@'.$comment.'@|@'.$line_number.'\\\" id=\\\"item_to_import_values-'.$line_number.'\\\" /></td></tr>';\n\n            // Add a checkbox for select/unselect all others\n            $display .= '<tr><td colspan=\\\"2\\\"><br><input type=\\\"checkbox\\\" id=\\\"item_all_selection\\\" />&nbsp;'.$LANG['all'].'</td></tr>';\n\n            // Prepare a list of all folders that the user can choose\n            $display .= '</table><div style=\\\"margin:10px 0 10px 0;\\\"><label><b>'.$LANG['import_to_folder'].'</b></label>&nbsp;<select id=\\\"import_items_to\\\" style=\\\"width:87%;\\\">';\n            foreach ($tree as $t) {\n                if (in_array($t->id, $_SESSION['groupes_visibles'])) {\n                    $ident = \"\";\n                    for ($x = 1; $x < $t->nlevel; $x++) {\n                        $ident .= \"&nbsp;&nbsp;\";\n                    }\n                    if (null !== filter_input(INPUT_POST, 'folder_id', FILTER_SANITIZE_NUMBER_INT) && filter_input(INPUT_POST, 'folder_id', FILTER_SANITIZE_NUMBER_INT) === $t->id) {\n                        $selected = \" selected\";\n                    } else {\n                        $selected = \"\";\n                    }\n                    if ($prev_level != null && $prev_level < $t->nlevel) {\n                        $display .= '<option value=\\\"'.$t->id.'\\\"'.$selected.'>'.$ident.str_replace(array(\"&\", '\"'), array(\"&amp;\", \"&quot;\"), $t->title).'</option>';\n                    } elseif ($prev_level != null && $prev_level == $t->nlevel) {\n                        $display .= '<option value=\\\"'.$t->id.'\\\"'.$selected.'>'.$ident.str_replace(array(\"&\", '\"'), array(\"&amp;\", \"&quot;\"), $t->title).'</option>';\n                    } else {\n                        $display .= '<option value=\\\"'.$t->id.'\\\"'.$selected.'>'.$ident.str_replace(array(\"&\", '\"'), array(\"&amp;\", \"&quot;\"), $t->title).'</option>';\n                    }\n                    $prev_level = $t->nlevel;\n                }\n            }\n            $display .= '</select></div>';\n\n            // Show results to user.\n            echo '[{\"error\":\"no\" , \"output\" : \"'.$display.'\"}]';\n        }\n        \n        //delete file\n        unlink($file);\n\n        break;\n\n    //Insert into DB the items the user has selected\n    case \"import_items\":\n        //decrypt and retreive data in JSON format\n        $dataReceived = (Encryption\\Crypt\\aesctr::decrypt(\n            filter_input(INPUT_POST, 'data', FILTER_SANITIZE_STRING),\n            $_SESSION['key'],\n            256\n        ));\n\n        //Get some info about personal folder\n        if (filter_input(INPUT_POST, 'folder', FILTER_SANITIZE_NUMBER_INT) === $_SESSION['user_id']) {\n            $personalFolder = 1;\n        } else {\n            $personalFolder = 0;\n        }\n        $data_fld = DB::queryFirstRow(\n            \"SELECT title\n            FROM \".prefix_table(\"nested_tree\").\"\n            WHERE id = %i\",\n            filter_input(INPUT_POST, 'folder', FILTER_SANITIZE_NUMBER_INT)\n        );\n\n        //Prepare variables\n        $listItems = htmlspecialchars_decode($dataReceived);\n        $list = \"\";\n\n        foreach (explode('@_#sep#_@', stripslashes($listItems)) as $item) {\n            //For each item, insert into DB\n            $item = explode('@|@', $item); //explode item to get all fields\n\n            //Encryption key\n            if ($personalFolder == 1) {\n                $encrypt = cryption(\n                    $item[2],\n                    $_SESSION['user_settings']['session_psk'],\n                    \"encrypt\"\n                );\n            } else {\n                $encrypt = cryption(\n                    $item[2],\n                    \"\",\n                    \"encrypt\"\n                );\n            }\n\n            // Insert new item in table ITEMS\n            DB::insert(\n                prefix_table(\"items\"),\n                array(\n                    'label' => substr($item[0], 0, 500),\n                    'description' => empty($item[4]) ? '' : $item[4],\n                    'pw' => $encrypt['string'],\n                    'pw_iv' => $encrypt['iv'],\n                    'url' => empty($item[3]) ? '' : substr($item[3], 0, 500),\n                    'id_tree' => filter_input(INPUT_POST, 'folder', FILTER_SANITIZE_NUMBER_INT),\n                    'login' => empty($item[1]) ? '' : substr($item[1], 0, 200),\n                    'anyone_can_modify' => filter_input(INPUT_POST, 'import_csv_anyone_can_modify', FILTER_SANITIZE_STRING) === \"true\" ? 1 : 0\n                )\n            );\n            $newId = DB::insertId();\n\n            //if asked, anyone in role can modify\n            if (null !== filter_input(INPUT_POST, 'import_csv_anyone_can_modify_in_role', FILTER_SANITIZE_STRING)\n                && filter_input(INPUT_POST, 'import_csv_anyone_can_modify_in_role', FILTER_SANITIZE_STRING) === \"true\"\n            ) {\n                foreach ($_SESSION['arr_roles'] as $role) {\n                    DB::insert(\n                        prefix_table(\"restriction_to_roles\"),\n                        array(\n                            'role_id' => $role['id'],\n                            'item_id' => $newId\n                        )\n                    );\n                }\n            }\n\n            // Insert new item in table LOGS_ITEMS\n            DB::insert(\n                prefix_table(\"log_items\"),\n                array(\n                    'id_item' => $newId,\n                    'date' => time(),\n                    'id_user' => $_SESSION['user_id'],\n                    'action' => 'at_creation'\n                )\n            );\n\n            if (empty($list)) {\n                $list = $item[5];\n            } else {\n                $list .= \";\".$item[5];\n            }\n\n            //Add entry to cache table\n            DB::insert(\n                prefix_table(\"cache\"),\n                array(\n                    'id' => $newId,\n                    'label' => substr($item[0], 0, 500),\n                    'description' => empty($item[4]) ? '' : $item[4],\n                    'id_tree' => filter_input(INPUT_POST, 'folder', FILTER_SANITIZE_NUMBER_INT),\n                    'url' => \"0\",\n                    'perso' => $personalFolder == 0 ? 0 : 1,\n                    'login' => empty($item[1]) ? '' : substr($item[1], 0, 500),\n                    'folder' => $data_fld['title'],\n                    'author' => $_SESSION['user_id'],\n                    'timestamp' => time(),\n                    'tags' => '',\n                    'restricted_to' => '0',\n                    'renewal_period' => \"0\",\n                    'timestamp' => time()\n                )\n            );\n        }\n        echo '[{\"items\":\"'.$list.'\"}]';\n        break;\n\n    //Check if import KEEPASS file format is what expected\n    case \"import_file_format_keepass\":\n        //Initialization\n        $root = $meta = $group = $entry = $key = $title = $notes = $pwd = $username = $url = $notKeepassFile = $newItem = $history = $generatorFound = false;\n        $name = $levelInProgress = $previousLevel = $fullPath = $historyLevel = $path = $display = $keepassVersion = \"\";\n        $numGroups = $numItems = 0;\n        $temparray = $arrFolders = array();\n        $levelMin = 2;\n        $foldersSeparator = '@&##&@';\n        $itemsSeparator = '<=|#|=>';\n        $lineEndSeparator = '@*1|#9*|@';\n\n        //prepare CACHE files\n        $cacheFileName = $SETTINGS['path_to_files_folder'].\"/cpassman_cache_\".md5(time().mt_rand());\n        $cacheFileNameFolder = $cacheFileName.\"_folders\";\n        $cacheFile = fopen($cacheFileName, \"w\");\n        $cacheFileF = fopen($cacheFileNameFolder, \"w\");\n        $logFileName = \"/keepassImport_\".date('YmdHis').\".log\";\n        $cacheLogFile = fopen($SETTINGS['path_to_files_folder'].$logFileName, 'w');\n\n        // Init post variable\n        $post_operation_id = filter_input(INPUT_POST, 'file', FILTER_SANITIZE_STRING);\n\n        // Get filename from database\n        $data = DB::queryFirstRow(\n            \"SELECT valeur\n            FROM \".$pre.\"misc\n            WHERE increment_id = %i\",\n            $post_operation_id\n        );\n\n        // Delete operation id\n        DB::delete(\n            prefix_table('misc'),\n            \"increment_id = %i\",\n            $post_operation_id\n        );\n\n        // do some initializations\n        $file = $data['valeur'];\n\n        //read xml file\n        if (file_exists($SETTINGS['path_to_files_folder'].\"/\".$file)) {\n            $xml = simplexml_load_file(\n                $SETTINGS['path_to_files_folder'].\"/\".$file\n            );\n        }\n\n        /**\n        Recursive function that will permit to read each level of XML nodes\n         */\n        function recursiveKeepassXML($xmlRoot, $xmlLevel = 0)\n        {\n            global $meta, $root, $group, $name, $entry, $levelMin, $title, $notes, $pwd, $username, $url,\n                $newItem, $temparray, $history, $levelInProgress, $historyLevel,\n                $path, $previousLevel, $generatorFound, $cacheFile, $cacheFileF, $numGroups,\n                $numItems, $foldersSeparator, $itemsSeparator, $keepassVersion, $arrFolders;\n\n            $groupsArray = array();\n\n            // For each node, get the name and SimpleXML balise\n            foreach ($xmlRoot as $nom => $elem) {\n                /*\n                * check if file is generated by keepass 1\n                * key \"pwentry\" is only used in KP1.xx XML files\n                */\n                if ($nom == \"pwentry\") {\n                    if (empty($keepassVersion)) {\n                        $keepassVersion = 1;\n                        $generatorFound = true;\n                        $entry = true;\n                    } else {\n                        $entry = true;\n                    }\n\n                    //get children\n                    $xmlChildren = $elem->children();\n\n                    //recursive call\n                    recursiveKeepassXML($xmlChildren, $xmlLevel + 1);\n                }\n                //IMPORTING KEEPASS 1 XML FILE\n                if ($keepassVersion == 1) {\n                    if ($entry === true && $nom == \"expiretime\") {\n                        //save previous keepass entry\n                        $tree = preg_replace('/\\\\\\\\/', $foldersSeparator, $temparray['tree']);\n                        fputs(\n                            $cacheFile,\n                            $tree.$itemsSeparator.$temparray[KP_GROUP].$itemsSeparator.$temparray[KP_TITLE].\n                            $itemsSeparator.$temparray[KP_PW].$itemsSeparator.$temparray[KP_USERNAME].\n                            $itemsSeparator.$temparray[KP_URL].$itemsSeparator.$temparray[KP_UUID].$itemsSeparator.$temparray[KP_NOTES].\"\\n\"\n                        );\n\n                        if (!in_array($temparray['tree'], $arrFolders)) {\n                            fwrite($cacheFileF, $tree.\"\\n\");\n                            array_push($arrFolders, $temparray['tree']);\n                        }\n\n                        $temparray = array();\n                        $newItem++;\n                    }\n\n                    if ($entry === true && $nom == \"group\") {\n                        $temparray[KP_GROUP] = addslashes(preg_replace('#[\\r\\n]#', '', $elem));\n                        foreach ($elem->attributes() as $attributeskey0 => $attributesvalue1) {\n                            if ($attributeskey0 == \"tree\") {\n                                $path = explode('\\\\', $attributesvalue1);\n                                if (count($path) > 1) {\n                                    unset($path[0]);\n                                    $temparray['tree'] = implode('\\\\', $path).'\\\\'.$temparray[KP_GROUP];\n                                } else {\n                                    $temparray['tree'] = $temparray[KP_GROUP];\n                                }\n                            }\n                        }\n                        $numGroups++;\n                    } elseif ($entry === true && $nom == \"title\") {\n                        $temparray[KP_TITLE] = sanitiseString($elem, '');\n                    } elseif ($entry === true && $nom == \"username\") {\n                        $temparray[KP_USERNAME] = sanitiseString($elem, '');\n                    } elseif ($entry === true && $nom == \"url\") {\n                        $temparray[KP_URL] = sanitiseString($elem, '');\n                    } elseif ($entry === true && $nom == \"uuid\") {\n                        $temparray[KP_UUID] = addslashes(preg_replace('#[\\r\\n]#', '', $elem));\n                    } elseif ($entry === true && $nom == \"password\") {\n                        $temparray[KP_PW] = sanitiseString($elem, '');\n                    } elseif ($entry === true && $nom == \"notes\") {\n                        $temparray[KP_NOTES] = sanitiseString($elem, '');\n                    }\n                }\n\n                /*\n                   * check if file is generated by keepass 2\n                */\n                if (trim($elem) == \"\" && $keepassVersion != 1) {\n                    //check if file is generated by keepass 2\n                    if ($nom == \"Meta\") {\n                        $meta = true;\n                    }\n                    if ($nom == \"Root\") {\n                        $root = true;\n                    }\n\n                    if ($nom == \"Group\") {\n                        $group = true;\n                        $entry = false;\n                        $name = \"\";\n\n                        // recap previous info\n                        if (!empty($temparray[KP_TITLE])) {\n                            //store data\n                            fputs(\n                                $cacheFile,\n                                $temparray[KP_PATH].$itemsSeparator.$temparray[KP_GROUP].\n                                $itemsSeparator.$temparray[KP_TITLE].$itemsSeparator.$temparray[KP_PW].\n                                $itemsSeparator.$temparray[KP_USERNAME].$itemsSeparator.\n                                $temparray[KP_URL].$itemsSeparator.$temparray[KP_UUID].$itemsSeparator.$temparray[KP_NOTES].\"\\n\"\n                            );\n\n                            //Clean temp array\n                            $temparray[KP_TITLE] = $temparray[KP_NOTES] = $temparray[KP_PW] = $temparray[KP_USERNAME] = $temparray[KP_URL] = \"\";\n\n                            //increment number\n                            $numItems++;\n                        }\n                        $historyLevel = 0;\n                    }\n\n                    //History node needs to be managed in order to not polluate final list\n                    if ($nom == \"History\") {\n                        $history = true;\n                        $entry = false;\n                        $historyLevel = $xmlLevel;\n                    }\n\n                    if ($nom == \"Entry\" && ($xmlLevel < $historyLevel || empty($historyLevel))) {\n                        $entry = true;\n                        $group = false;\n\n                        // recap previous info\n                        if (!empty($temparray[KP_TITLE])) {\n                            //store data\n                            fputs($cacheFile, $temparray[KP_PATH].$itemsSeparator.$temparray[KP_GROUP].$itemsSeparator.$temparray[KP_TITLE].$itemsSeparator.$temparray[KP_PW].$itemsSeparator.$temparray[KP_USERNAME].$itemsSeparator.$temparray[KP_URL].$itemsSeparator.$temparray[KP_UUID].$itemsSeparator.$temparray[KP_NOTES].\"\\n\");\n\n                            //Clean temp array\n                            $temparray[KP_TITLE] = $temparray[KP_NOTES] = $temparray[KP_PW] = $temparray[KP_USERNAME] = $temparray[KP_URL] = $temparray[KP_UUID] = \"\";\n\n                            //increment number\n                            $numItems++;\n                        }\n                        $historyLevel = 0;\n                    }\n\n                    //get children\n                    $xmlChildren = $elem->children();\n\n                    //recursive call\n                    recursiveKeepassXML($xmlChildren, $xmlLevel + 1);\n\n                    //IMPORTING KEEPASS 2 XML FILE\n                } elseif ($keepassVersion != 1) {\n                    // exit if XML file not generated by KeePass\n                    if ($meta === true && $nom == \"Generator\" && $elem == \"KeePass\") {\n                        $generatorFound = true;\n                        $keepassVersion = 2;\n                        break;\n                    } elseif ($root === true && $xmlLevel > $levelMin) {\n                        //Check each node name and get data from some of them\n                        if ($entry === true && $nom == \"Key\" && $elem == \"Title\") {\n                            $title = true;\n                            $notes = $pwd = $url = $username = false;\n                        } elseif ($entry === true && $nom == \"Key\" && $elem == \"Notes\") {\n                            $notes = true;\n                            $title = $pwd = $url = $username = false;\n                        } elseif ($entry === true && $nom == \"UUID\") {\n                            $temparray[KP_UUID] = $elem;\n                        } elseif ($entry === true && $nom == \"Key\" && $elem == \"Password\") {\n                            $pwd = true;\n                            $notes = $title = $url = $username = false;\n                        } elseif ($entry === true && $nom == \"Key\" && $elem == \"URL\") {\n                            $url = true;\n                            $notes = $pwd = $title = $username = false;\n                        } elseif ($entry === true && $nom == \"Key\" && $elem == \"UserName\") {\n                            $username = true;\n                            $notes = $pwd = $url = $title = false;\n                        } elseif ($group === true && $nom == \"Name\") {\n                            $temparray[KP_GROUP] = addslashes(preg_replace('#[\\r\\n]#', '', $elem));\n                            $temparray['level'] = $xmlLevel;\n                            //build current path\n                            if ($xmlLevel > $levelInProgress) {\n                                if (!empty($temparray[KP_PATH])) {\n                                    $temparray[KP_PATH] .= $foldersSeparator.$temparray[KP_GROUP];\n                                } else {\n                                    $temparray[KP_PATH] = $temparray[KP_GROUP];\n                                }\n                            } elseif ($xmlLevel == $levelInProgress) {\n                                if ($levelInProgress == 3) {\n                                    $temparray[KP_PATH] = $temparray[KP_GROUP];\n                                } else {\n                                    $temparray[KP_PATH] = substr($temparray[KP_PATH], 0, strrpos($temparray[KP_PATH], $foldersSeparator) + strlen($foldersSeparator)).$temparray[KP_GROUP];\n                                }\n                            } else {\n                                $diff = abs($xmlLevel - $levelInProgress) + 1;\n                                $tmp = explode($foldersSeparator, $temparray[KP_PATH]);\n                                $temparray[KP_PATH] = \"\";\n                                for ($x = 0; $x < (count($tmp) - $diff); $x++) {\n                                    if (!empty($temparray[KP_PATH])) {\n                                        $temparray[KP_PATH] = $temparray[KP_PATH].$foldersSeparator.$tmp[$x];\n                                    } else {\n                                        $temparray[KP_PATH] = $tmp[$x];\n                                    }\n                                }\n                                if (!empty($temparray[KP_PATH])) {\n                                    $temparray[KP_PATH] .= $foldersSeparator.$temparray[KP_GROUP];\n                                } else {\n                                    $temparray[KP_PATH] = $temparray[KP_GROUP];\n                                }\n                            }\n\n                            //store folders\n                            if (!in_array($temparray[KP_PATH], $groupsArray)) {\n                                fwrite($cacheFileF, $temparray[KP_PATH].\"\\n\");\n                                array_push($groupsArray, $temparray[KP_PATH]);\n                                //increment number\n                                $numGroups++;\n                            }\n\n                            //Store actual level\n                            $levelInProgress = $xmlLevel;\n                            $previousLevel = $temparray[KP_GROUP];\n                        } elseif ($title === true && $nom == \"Value\") {\n                            $title = false;\n                            $temparray[KP_TITLE] = sanitiseString($elem, '');\n                        } elseif ($notes === true && $nom == \"Value\") {\n                            $notes = false;\n                            $temparray[KP_NOTES] = sanitiseString($elem, '');\n                        } elseif ($pwd === true && $nom == \"Value\") {\n                            $pwd = false;\n                            $temparray[KP_PW] = sanitiseString($elem, '');\n                        } elseif ($url === true && $nom == \"Value\") {\n                            $url = false;\n                            $temparray[KP_URL] = sanitiseString($elem, '');\n                        } elseif ($username === true && $nom == \"Value\") {\n                            $username = false;\n                            $temparray[KP_USERNAME] = sanitiseString($elem, '');\n                        }\n                    }\n                }\n            }\n        }\n\n        fputs($cacheLogFile, date('H:i:s ').\"Writing XML File \".filter_input(INPUT_POST, 'file', FILTER_SANITIZE_STRING).\"\\n\");\n\n        // Go through each node of XML file\n        recursiveKeepassXML($xml);\n\n        //Stop if not a keepass file\n        if ($generatorFound === false) {\n            //Close file & delete it\n            fclose($cacheFileF);\n            fclose($cacheFile);\n            unlink($cacheFileName);\n            unlink($cacheFileNameFolder);\n            unlink($SETTINGS['url_to_files_folder'].\"/\".filter_input(INPUT_POST, 'file', FILTER_SANITIZE_STRING));\n\n            fputs($cacheLogFile, date('H:i').$LANG['import_error_no_read_possible_kp'].\"\\n\");\n\n            echo '[{\"error\":\"not_kp_file\" , \"message\":\"'.$LANG['import_error_no_read_possible_kp'].'\"}]';\n            break;\n        }\n\n        //save last item\n        if (!empty($temparray[KP_TITLE])) {\n            //store data\n            fputs(\n                $cacheFile,\n                $temparray[KP_PATH].$itemsSeparator.$temparray[KP_GROUP].$itemsSeparator.\n                $temparray[KP_TITLE].$itemsSeparator.$temparray[KP_PW].$itemsSeparator.$temparray[KP_USERNAME].\n                $itemsSeparator.$temparray[KP_URL].$itemsSeparator.$temparray[KP_UUID].$itemsSeparator.$temparray[KP_NOTES].\"\\n\"\n            );\n\n            //increment number\n            $numItems++;\n        }\n\n        ##################\n        ## STARTING IMPORTING IF NO ERRORS OR NOT EMPTY\n        ##################\n        if ($numItems > 0 || $numGroups > 0) {\n            // Write in file\n            fputs($cacheLogFile, date('H:i:s ').$LANG['nb_folders'].' '.$numGroups.\"\\n\");\n            fputs($cacheLogFile, date('H:i:s ').$LANG['nb_items'].' '.$numItems.\"\\n\");\n\n            $import_perso = false;\n            $itemsArray = array();\n            $text = '<span class=\"fa fa-folder-open\"></span>&nbsp;'.$LANG['nb_folders'].': '.\n                $numGroups.'<br /><span class=\"fa fa-tag\"></span>>&nbsp;'.$LANG['nb_items'].': '.\n                $numItems.'<br /><br />';\n            $post_destination = filter_input(INPUT_POST, 'destination', FILTER_SANITIZE_STRING);\n\n            // If personal folder, then remove the suffix in ID\n            if (substr_count($post_destination, '-perso') > 0) {\n                $post_destination = str_replace('-perso', '', $post_destination);\n            }\n\n            // If destination is not ROOT then get the complexity level\n            if (strpos($post_destination, \"perso\") !== 0) {\n                $levelPwComplexity = 50;\n                $startPathLevel = 1;\n                $import_perso = true;\n            } elseif ($post_destination > 0) {\n                $data = DB::queryFirstRow(\n                    \"SELECT m.valeur as value, t.nlevel as nlevel\n                    FROM \".prefix_table(\"misc\").\" as m\n                    INNER JOIN \".prefix_table(\"nested_tree\").\" as t ON (m.intitule = t.id)\n                    WHERE m.type = %s AND m.intitule = %s\",\n                    \"complex\",\n                    mysqli_escape_string($link, $post_destination)\n                );\n                $levelPwComplexity = $data['value'];\n                $startPathLevel = $data['nlevel'];\n            } else {\n                $levelPwComplexity = 50;\n                $startPathLevel = 0;\n            }\n\n            //Get all folders from file\n            fclose($cacheFileF);\n            $cacheFileF = fopen($cacheFileNameFolder, \"r\");\n\n            //Create folders\n            $i = 1;\n            $level = 0;\n            $foldersArray = array();\n            $nbFoldersImported = 0;\n\n            fputs($cacheLogFile, date('H:i:s ').\"Creating Folders\\n\");\n            $results = \"Folders\\n\\n\";\n\n            while (!feof($cacheFileF)) {\n                $folder = fgets($cacheFileF, 4096);\n                if (!empty($folder)) {\n                    $folder = str_replace(array(\"\\r\\n\", \"\\n\", \"\\r\"), '', $folder);\n                    //get number of levels in path\n                    $path = explode($foldersSeparator, $folder);\n                    $folderLevel = count($path);\n\n                    //get folder name\n                    if (strrpos($folder, $foldersSeparator) > 0) {\n                        $fold = substr($folder, strrpos($folder, $foldersSeparator) + strlen($foldersSeparator));\n                        $parent = implode($foldersSeparator, array_slice($path, 0, -1));\n                        $parent_id = $foldersArray[$parent]['id'];\n                    } else {\n                        $fold = $folder;\n                        $parent_id = $post_destination; //permits to select the folder destination\n                    }\n\n                    $fold = stripslashes($fold);\n                    //create folder - if not exists at the same level\n                    DB::query(\n                        \"SELECT * FROM \".prefix_table(\"nested_tree\").\"\n                        WHERE nlevel = %i AND title = %s AND parent_id = %i LIMIT 1\",\n                        intval($folderLevel + $startPathLevel),\n                        $fold,\n                        $parent_id\n                    );\n                    $results .= str_replace($foldersSeparator, '\\\\', $folder);\n                    $counter = DB::count();\n                    if ($counter == 0) {\n                        $results .= \" - Inserting\\n\";\n                        //do query\n                        DB::insert(\n                            prefix_table(\"nested_tree\"),\n                            array(\n                                'parent_id' => $parent_id,\n                                'title' => stripslashes($fold),\n                                'nlevel' => $folderLevel\n                            )\n                        );\n                        $id = DB::insertId();\n                        //Add complexity level => level is set to \"medium\" by default.\n                        DB::insert(\n                            prefix_table(\"misc\"),\n                            array(\n                                'type' => 'complex',\n                                'intitule' => $id,\n                                'valeur' => $levelPwComplexity\n                            )\n                        );\n\n                        //For each role to which the user depends on, add the folder just created.\n                        foreach ($_SESSION['arr_roles'] as $role) {\n                            DB::insert(\n                                prefix_table(\"roles_values\"),\n                                array(\n                                    'role_id' => $role['id'],\n                                    'folder_id' => $id,\n                                    'type' => \"W\"\n                                )\n                            );\n                        }\n\n                        //Add this new folder to the list of visible folders for the user.\n                        array_push($_SESSION['groupes_visibles'], $id);\n\n                        //increment number of imported folders\n                        $nbFoldersImported++;\n                    } else {\n                        $results .= \" - Skipped\\n\";\n                        //get folder actual ID\n                        $data = DB::queryFirstRow(\n                            \"SELECT id FROM \".prefix_table(\"nested_tree\").\"\n                            WHERE nlevel = %i AND title = %s AND parent_id = %i\",\n                            intval($folderLevel + $startPathLevel),\n                            $fold,\n                            $parent_id\n                        );\n                        $id = $data['id'];\n                    }\n\n                    //store in array\n                    $foldersArray[$folder] = array(\n                        'folder' => $fold,\n                        'nlevel' => $folderLevel,\n                        'id' => $id\n                    );\n\n                    $_SESSION['nb_folders']++;\n                    $i++;\n                }\n            }\n\n            $results .= \"\\n\\nItems\\n\\n\";\n            //if no new folders them inform\n            if ($nbFoldersImported > 0) {\n                fputs($cacheLogFile, date('H:i:s ').\"Setting User Rights\\n\");\n                //Refresh the rights of actual user\n                identifyUserRights(\n                    implode(';', $_SESSION['groupes_visibles']).';'.$newId,\n                    $_SESSION['groupes_interdits'],\n                    $_SESSION['is_admin'],\n                    $_SESSION['fonction_id']\n                );\n\n                fputs($cacheLogFile, date('H:i:s ').\"Rebuilding Tree\\n\");\n                //rebuild full tree\n                $tree->rebuild();\n            }\n\n            fputs($cacheLogFile, date('H:i:s ').\"Importing Items\\n\");\n\n            // Now import ITEMS\n            $nbItemsImported = 0;\n            $count = 0;\n\n            //Get some info about personal folder\n            if ($post_destination == $_SESSION['user_id']) {\n                $personalFolder = 1;\n            } else {\n                $personalFolder = 0;\n            }\n\n            //prepare file to be read\n            fclose($cacheFile);\n            $cacheFile = fopen($cacheFileName, \"r\");\n\n            while (!feof($cacheFile)) {\n                //prepare an array with item to import\n                $full_item = fgets($cacheFile, 8192);\n                $full_item = str_replace(array(\"\\r\\n\", \"\\n\", \"\\r\"), '', $full_item);\n                $item = explode($itemsSeparator, $full_item);\n\n                $count++;\n                if (!($count % 10)) {\n                    fputs($cacheLogFile, date('H:i:s ').\"  Imported $count items (\".number_format(($count / $numItems) * 100, 1).\")\\n\");\n                }\n\n                if (!empty($item[KP_TITLE])) {\n                    //$count++;\n                    //check if not exists\n                    $results .= str_replace($foldersSeparator, \"\\\\\", $item[KP_PATH]).'\\\\'.$item[KP_TITLE];\n\n                    $pwd = $item[KP_PASSWORD];\n\n                    //Get folder label\n                    if (count($foldersArray) == 0 || empty($item[KP_PATH])) {\n                        $folderId = $post_destination;\n                    } else {\n                        $folderId = $foldersArray[$item[KP_PATH]]['id'];\n                    }\n                    $data = DB::queryFirstRow(\n                        \"SELECT title FROM \".prefix_table(\"nested_tree\").\" WHERE id = %i\",\n                        intval($folderId)\n                    );\n\n                    // escape if folderId is empty\n                    if (!empty($folderId)) {\n                        $results .= \" - Inserting\\n\";\n\n                        // prepare PW\n                        if ($import_perso === true) {\n                            $encrypt = cryption(\n                                $pwd,\n                                $_SESSION['user_settings']['session_psk'],\n                                \"encrypt\"\n                            );\n                        } else {\n                            $encrypt = cryption(\n                                $pwd,\n                                \"\",\n                                \"encrypt\"\n                            );\n                        }\n\n                        //ADD item\n                        DB::insert(\n                            prefix_table(\"items\"),\n                            array(\n                                'label' => substr(stripslashes($item[KP_TITLE]), 0, 500),\n                                'description' => stripslashes(str_replace($lineEndSeparator, '<br />', $item[KP_NOTES])),\n                                'pw' => $encrypt['string'],\n                                'pw_iv' => $encrypt['iv'],\n                                'url' => substr(stripslashes($item[KP_URL]), 0, 500),\n                                'id_tree' => $folderId,\n                                'login' => substr(stripslashes($item[KP_USERNAME]), 0, 500),\n                                'anyone_can_modify' => filter_input(INPUT_POST, 'import_kps_anyone_can_modify', FILTER_SANITIZE_STRING) === \"true\" ? 1 : 0\n                            )\n                        );\n                        $newId = DB::insertId();\n\n                        //if asked, anyone in role can modify\n                        if (null !== filter_input(INPUT_POST, 'import_kps_anyone_can_modify_in_role', FILTER_SANITIZE_STRING) && filter_input(INPUT_POST, 'import_kps_anyone_can_modify_in_role', FILTER_SANITIZE_STRING) === \"true\") {\n                            foreach ($_SESSION['arr_roles'] as $role) {\n                                DB::insert(\n                                    prefix_table(\"restriction_to_roles\"),\n                                    array(\n                                        'role_id' => $role['id'],\n                                        'item_id' => $newId\n                                    )\n                                );\n                            }\n                        }\n\n                        //Add log\n                        DB::insert(\n                            prefix_table(\"log_items\"),\n                            array(\n                                'id_item' => $newId,\n                                'date' => time(),\n                                'id_user' => $_SESSION['user_id'],\n                                'action' => 'at_creation',\n                                'raison' => 'at_import'\n                            )\n                        );\n\n                        //Add entry to cache table\n                        DB::insert(\n                            prefix_table(\"cache\"),\n                            array(\n                                'id' => $newId,\n                                'label' => substr(stripslashes($item[KP_TITLE]), 0, 500),\n                                'description' => stripslashes(str_replace($lineEndSeparator, '<br />', $item[KP_NOTES])),\n                                'url' => (isset($item[KP_NOTES]) && !empty($item[KP_NOTES])) ? $item[KP_NOTES] : \"0\",\n                                'tags' => \"\",\n                                'id_tree' => $folderId,\n                                'perso' => $personalFolder == 0 ? 0 : 1,\n                                'login' => substr(stripslashes($item[KP_USERNAME]), 0, 500),\n                                'restricted_to' => \"0\",\n                                'folder' => $data['title'],\n                                'author' => $_SESSION['user_id'],\n                                'renewal_period' => \"0\",\n                                'timestamp' => time()\n                            )\n                        );\n\n                        //increment number of imported items\n                        $nbItemsImported++;\n                    } else {\n                        $results .= \" - \".$item[KP_TITLE].\" was not imported\\n\";\n                    }\n                    fputs($cacheLogFile, date('H:i:s ').\" \".$results.\"\\n\");\n                }\n            }\n\n            //SHow finished\n            $text .= \"Folders imported: $nbFoldersImported<br />\";\n            $text .= \"Items imported: $nbItemsImported<br />\";\n            $text .= '</div><br /><br /><b>'.$LANG['import_kp_finished'].'</b>';\n            $text .= '<a href=\\''.$SETTINGS['url_to_files_folder'].'/'.$logFileName.'\\' target=\\'_blank\\'>'.$LANG['pdf_download'].'</a>';\n\n            fputs($cacheLogFile, date('H:i:s ').\"Import finished\\n\");\n            fputs($cacheLogFile, date('H:i:s ').\"Statistics\\n\");\n            fputs($cacheLogFile, date('H:i:s ').\"Folders imported: $nbFoldersImported\\n\");\n            fputs($cacheLogFile, date('H:i:s ').\"Items imported: $nbItemsImported\\n\\n\".$results);\n\n            //Delete cache file\n            fclose($cacheFileF);\n            fclose($cacheFile);\n            fclose($cacheLogFile);\n            unlink($cacheFileName);\n            unlink($cacheFileNameFolder);\n            unlink($SETTINGS['path_to_files_folder'].\"/\".$file);\n\n            //Display all messages to user\n            echo '[{\"error\":\"no\" , \"message\":\"'.str_replace('\"', \"&quote;\", strip_tags($text, '<br /><a><div><b><br>')).'\"}]';\n        } else {\n            echo '[{\"error\":\"yes\" , \"message\":\"\"}]';\n        }\n        break;\n}\n\nspl_autoload_register(function ($class) {\n    $prefix = 'League\\\\Csv\\\\';\n    $base_dir = __DIR__.'/src/';\n    $len = strlen($prefix);\n    if (strncmp($prefix, $class, $len) !== 0) {\n        // no, move to the next registered autoloader\n        return;\n    }\n    $relative_class = substr($class, $len);\n    $file = $base_dir.str_replace('\\\\', '/', $relative_class).'.php';\n    if (file_exists($file)) {\n        require $file;\n    }\n});\n", "<?php\n/**\n * @file          roles.queries.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\n\nrequire_once 'SecureHandler.php';\nsession_start();\nif (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 ||\n    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) ||\n    !isset($_SESSION['key']) || empty($_SESSION['key'])\n) {\n    die('Hacking attempt...');\n}\n\n// Load config\nif (file_exists('../includes/config/tp.config.php')) {\n    require_once '../includes/config/tp.config.php';\n} elseif (file_exists('./includes/config/tp.config.php')) {\n    require_once './includes/config/tp.config.php';\n} else {\n    throw new Exception(\"Error file '/includes/config/tp.config.php' not exists\", 1);\n}\n/* do checks */\nrequire_once $SETTINGS['cpassman_dir'].'/includes/config/include.php';\nrequire_once $SETTINGS['cpassman_dir'].'/sources/checks.php';\nif (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"manage_roles\")) {\n    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n    include $SETTINGS['cpassman_dir'].'/error.php';\n    exit();\n}\n\ninclude $SETTINGS['cpassman_dir'].'/includes/language/'.$_SESSION['user_language'].'.php';\ninclude $SETTINGS['cpassman_dir'].'/includes/config/settings.php';\nheader(\"Content-type: text/html; charset=utf-8\");\nrequire_once 'main.functions.php';\n\nrequire_once $SETTINGS['cpassman_dir'].'/sources/SplClassLoader.php';\n\n//Connect to DB\nrequire_once $SETTINGS['cpassman_dir'].'/includes/libraries/Database/Meekrodb/db.class.php';\n$pass = defuse_return_decrypted($pass);\nDB::$host = $server;\nDB::$user = $user;\nDB::$password = $pass;\nDB::$dbName = $database;\nDB::$port = $port;\nDB::$encoding = $encoding;\nDB::$error_handler = true;\n$link = mysqli_connect($server, $user, $pass, $database, $port);\n$link->set_charset($encoding);\n\n//Build tree\n$tree = new SplClassLoader('Tree\\NestedTree', $SETTINGS['cpassman_dir'].'/includes/libraries');\n$tree->register();\n$tree = new Tree\\NestedTree\\NestedTree($pre.'nested_tree', 'id', 'parent_id', 'title');\n\nif (null !== filter_input(INPUT_POST, 'type', FILTER_SANITIZE_STRING)) {\n    switch (filter_input(INPUT_POST, 'type', FILTER_SANITIZE_STRING)) {\n        #CASE adding a new role\n        case \"add_new_role\":\n            // Prepare POST variables\n            $post_name = filter_input(INPUT_POST, 'name', FILTER_SANITIZE_STRING);\n\n            //Check if role already exist : No similar roles\n            $tmp = DB::query(\n                \"SELECT * FROM \".prefix_table(\"roles_title\").\" WHERE title = %s\",\n                stripslashes($post_name)\n            );\n            $counter = DB::count();\n            if ($counter == 0) {\n                db::debugmode(false);\n                DB::insert(\n                    prefix_table(\"roles_title\"),\n                    array(\n                        'title' => noHTML($post_name),\n                        'complexity' => filter_input(INPUT_POST, 'complexity', FILTER_SANITIZE_NUMBER_INT),\n                        'creator_id' => $_SESSION['user_id']\n                    )\n                );\n                $role_id = DB::insertId();\n\n                if ($role_id != 0) {\n                    //Actualize the variable\n                    $_SESSION['nb_roles']++;\n\n                    // get some data\n                    $data_tmp = DB::queryfirstrow(\n                        \"SELECT fonction_id FROM \".prefix_table(\"users\").\" WHERE id = %s\",\n                        $_SESSION['user_id']\n                    );\n\n                    // add new role to user\n                    $tmp = str_replace(\";;\", \";\", $data_tmp['fonction_id']);\n                    if (substr($tmp, -1) == \";\") {\n                        $_SESSION['fonction_id'] = str_replace(\";;\", \";\", $data_tmp['fonction_id'].$role_id);\n                    } else {\n                        $_SESSION['fonction_id'] = str_replace(\";;\", \";\", $data_tmp['fonction_id'].\";\".$role_id);\n                    }\n                    // store in DB\n                    DB::update(\n                        prefix_table(\"users\"),\n                        array(\n                            'fonction_id' => $_SESSION['fonction_id']\n                            ),\n                        \"id = %i\",\n                        $_SESSION['user_id']\n                    );\n                    $_SESSION['user_roles'] = explode(\";\", $_SESSION['fonction_id']);\n\n\n                    echo '[ { \"error\" : \"no\" } ]';\n                } else {\n                    echo '[ { \"error\" : \"yes\" , \"message\" : \"Database error. Contact your administrator!\" } ]';\n                }\n            } else {\n                echo '[ { \"error\" : \"yes\" , \"message\" : \"'.$LANG['error_role_exist'].'\" } ]';\n            }\n            break;\n\n        //-------------------------------------------\n        #CASE delete a role\n        case \"delete_role\":\n            // Prepare POST variables\n            $post_id = filter_input(INPUT_POST, 'id', FILTER_SANITIZE_NUMBER_INT);\n\n            // Delete roles\n            DB::delete(prefix_table(\"roles_title\"), \"id = %i\", $post_id);\n            DB::delete(prefix_table(\"roles_values\"), \"role_id = %i\", $post_id);\n\n            //Actualize the variable\n            $_SESSION['nb_roles']--;\n\n            // parse all users to remove this role\n            $rows = DB::query(\n                \"SELECT id, fonction_id FROM \".prefix_table(\"users\").\"\n                ORDER BY id ASC\"\n            );\n            foreach ($rows as $record) {\n                $tab = explode(\";\", $record['fonction_id']);\n                if (($key = array_search($post_id, $tab)) !== false) {\n                    // remove the deleted role id\n                    unset($tab[$key]);\n\n                    // store new list of functions\n                    DB::update(\n                        prefix_table(\"users\"),\n                        array(\n                            'fonction_id' => rtrim(implode(\";\", $tab), \";\")\n                            ),\n                        \"id = %i\",\n                        $record['id']\n                    );\n                }\n            }\n\n            echo '[ { \"error\" : \"no\" } ]';\n            break;\n\n        //-------------------------------------------\n        #CASE editing a role\n        case \"edit_role\":\n            // Prepare POST variables\n            $post_id = filter_input(INPUT_POST, 'id', FILTER_SANITIZE_NUMBER_INT);\n            $post_title = filter_input(INPUT_POST, 'title', FILTER_SANITIZE_STRING);\n\n            //Check if role already exist : No similar roles\n            DB::query(\n                \"SELECT * FROM \".prefix_table(\"roles_title\").\" WHERE title = %s AND id != %i\",\n                $post_title,\n                $post_id\n            );\n            $counter = DB::count();\n            if ($counter == 0) {\n                DB::update(\n                    prefix_table(\"roles_title\"),\n                    array(\n                        'title' => noHTML(filter_input(INPUT_POST, 'title', FILTER_SANITIZE_STRING)),\n                        'complexity' => filter_input(INPUT_POST, 'complexity', FILTER_SANITIZE_NUMBER_INT),\n                    ),\n                    'id = %i',\n                    filter_input(INPUT_POST, 'id', FILTER_SANITIZE_NUMBER_INT)\n                );\n                echo '[ { \"error\" : \"no\" } ]';\n            } else {\n                echo '[ { \"error\" : \"yes\" , \"message\" : \"'.$LANG['error_role_exist'].'\" } ]';\n            }\n            break;\n\n        /******************************************\n        *CASE editing a role\n        */\n        case \"allow_pw_change_for_role\":\n            DB::update(\n                prefix_table(\"roles_title\"),\n                array(\n                    'allow_pw_change' => filter_input(INPUT_POST, 'value', FILTER_SANITIZE_STRING)\n                ),\n                'id = %i',\n                filter_input(INPUT_POST, 'id', FILTER_SANITIZE_NUMBER_INT)\n            );\n            break;\n\n        //-------------------------------------------\n        #CASE change right for a role on a folder via the TM\n        case \"change_role_via_tm\":\n            // Prepare POST variables\n            $post_access = filter_input(INPUT_POST, 'access', FILTER_SANITIZE_STRING);\n            $post_accessoption = filter_input(INPUT_POST, 'accessoption', FILTER_SANITIZE_STRING);\n\n            // Loop on selection\n            $arr = explode(\",\", filter_input(INPUT_POST, 'multiselection', FILTER_SANITIZE_STRING));\n            foreach ($arr as $elem) {\n                $tmp = explode('-', $elem);\n                $folder_id = $tmp[0];\n                $role_id = $tmp[1];\n\n                //get full tree dependencies\n                $tree_list = $tree->getDescendants($folder_id, true);\n\n                if ($post_access === \"read\" || $post_access === \"write\" || $post_access === \"nodelete\") {\n                    // define code to use\n                    if ($post_access == \"read\") {\n                        $access = \"R\";\n                    } elseif ($post_access == \"write\") {\n                        if (empty($post_accessoption) === true) {\n                            $access = \"W\";\n                        } elseif ($post_accessoption === \"nodelete\") {\n                            $access = \"ND\";\n                        } elseif ($post_accessoption === \"noedit\") {\n                            $access = \"NE\";\n                        } elseif ($post_accessoption === \"nodelete_noedit\") {\n                            $access = \"NDNE\";\n                        }\n                    } else {\n                        $access = \"\";\n                    }\n\n                    // loop\n                    foreach ($tree_list as $node) {\n                        // delete\n                        DB::delete(prefix_table(\"roles_values\"), \"folder_id = %i AND role_id = %i\", $node->id, $role_id);\n\n                        //Store in DB\n                        DB::insert(\n                            prefix_table(\"roles_values\"),\n                            array(\n                                'folder_id' => $node->id,\n                                'role_id' => $role_id,\n                                'type' => $access\n                            )\n                        );\n                    }\n                } else {\n                    foreach ($tree_list as $node) {\n                        // delete\n                        DB::delete(prefix_table(\"roles_values\"), \"folder_id = %i AND role_id = %i\", $node->id, $role_id);\n                    }\n                }\n            }\n\n            echo '[ { \"error\" : \"no\" } ]';\n            break;\n\n        //-------------------------------------------\n        #CASE refresh the matrix\n        case \"refresh_roles_matrix\":\n            // Ensure Complexity levels are translated\n            if (isset($SETTINGS_EXT['pwComplexity']) === false) {\n                $SETTINGS_EXT['pwComplexity'] = array(\n                    0=>array(0, $LANG['complex_level0']),\n                    25=>array(25, $LANG['complex_level1']),\n                    50=>array(50, $LANG['complex_level2']),\n                    60=>array(60, $LANG['complex_level3']),\n                    70=>array(70, $LANG['complex_level4']),\n                    80=>array(80, $LANG['complex_level5']),\n                    90=>array(90, $LANG['complex_level6'])\n                );\n            }\n\n            // Prepare POST variables\n            $post_start = filter_input(INPUT_POST, 'start', FILTER_SANITIZE_NUMBER_INT);\n\n            $tree = $tree->getDescendants();\n            $texte = '<table><thead><tr><th>'.$LANG['groups'].'</th>';\n            $gpes_ok = array();\n            $gpes_nok = array();\n            $tab_fonctions = array();\n            $arrRoles = array();\n            $display_nb = 8;\n            $sql_limit = \"\";\n            $next = 1;\n            $previous = 1;\n\n            //count nb of roles\n            $arrUserRoles = array_filter($_SESSION['user_roles']);\n            if (count($arrUserRoles) == 0 || $_SESSION['is_admin'] == 1) {\n                $where = \"\";\n            } else {\n                $where = \" WHERE id IN (\".implode(',', $arrUserRoles).\")\";\n            }\n            DB::query(\"SELECT * FROM \".prefix_table(\"roles_title\").$where);\n            $roles_count = DB::count();\n            if ($roles_count > $display_nb) {\n                if (null === $post_start || $post_start === 0) {\n                    $start = 0;\n                    $previous = 0;\n                } else {\n                    $start = $post_start;\n                    $previous = $start - $display_nb;\n                }\n                $sql_limit = \" LIMIT \".mysqli_real_escape_string($link, filter_var($start, FILTER_SANITIZE_NUMBER_INT)).\", \".mysqli_real_escape_string($link, filter_var($display_nb, FILTER_SANITIZE_NUMBER_INT));\n                $next = $start + $display_nb;\n            }\n\n            // array of roles for actual user\n            $my_functions = $arrUserRoles;\n\n            //Display table header\n            $rows = DB::query(\n                \"SELECT * FROM \".prefix_table(\"roles_title\").\n                $where.\"\n                ORDER BY title ASC\".$sql_limit\n            );\n            foreach ($rows as $record) {\n                if ($_SESSION['is_admin'] == 1 || ($_SESSION['user_manager'] == 1 && (in_array($record['id'], $my_functions) || $record['creator_id'] == $_SESSION['user_id']))) {\n                    if ($record['allow_pw_change'] == 1) {\n                        $allow_pw_change = '&nbsp;<span class=\\'fa mi-red fa-2x fa-magic tip\\' id=\\'img_apcfr_'.$record['id'].'\\' onclick=\\'allow_pw_change_for_role('.$record['id'].', 0)\\' style=\\'cursor:pointer;\\' title=\\''.$LANG['role_cannot_modify_all_seen_items'].'\\'></span>';\n                    } else {\n                        $allow_pw_change = '&nbsp;<span class=\\'fa fa-magic fa-2x mi-green tip\\'  id=\\'img_apcfr_'.$record['id'].'\\' onclick=\\'allow_pw_change_for_role('.$record['id'].', 1)\\' style=\\'cursor:pointer;\\' title=\\''.$LANG['role_can_modify_all_seen_items'].'\\'></span>';\n                    }\n                    $title = mysqli_real_escape_string($link, filter_var($record['title'], FILTER_SANITIZE_STRING));\n\n                    $texte .= '<th style=\\'font-size:10px;min-width:60px;\\' class=\\'edit_role\\'>'.\n                        $title.\n                        '<br>'.\n                        '<span class=\\'fa fa-pencil fa-2x mi-grey-1\\' onclick=\\'edit_this_role('.$record['id'].',\"'.htmlentities($record['title'], ENT_QUOTES, \"UTF-8\").'\",'.$record['complexity'].')\\' style=\\'cursor:pointer;\\'></span>&nbsp;'.\n                        '<span class=\\'fa fa-trash fa-2x mi-grey-1\\' style=\\'cursor:pointer;\\' onclick=\\'delete_this_role('.$record['id'].',\"'.htmlentities($record['title'], ENT_QUOTES, \"UTF-8\").'\")\\'></span>'.\n                        $allow_pw_change.\n                        '<div style=\\'margin-top:-8px;\\'>[&nbsp;'.$SETTINGS_EXT['pwComplexity'][$record['complexity']][1].'&nbsp;]</div></th>';\n\n                    array_push($arrRoles, $record['id']);\n                }\n            }\n            $texte .= '</tr></thead><tbody>';\n\n            //Display each folder with associated rights by role\n            $i = 0;\n            foreach ($tree as $node) {\n                if (in_array($node->id, $_SESSION['groupes_visibles']) && !in_array($node->id, $_SESSION['personal_visible_groups'])) {\n                    $ident = \"\";\n                    for ($a = 1; $a < $node->nlevel; $a++) {\n                        $ident .= '<i class=\\'fa fa-sm fa-caret-right mi-grey-1\\'></i>&nbsp;';\n                    }\n\n                    //display 1st cell of the line\n                    $texte .= '<tr><td style=\\'font-size:10px; font-family:arial;\\' title=\\'ID='.$node->id.'\\'>'.$ident.\" \".$node->title.'</td>';\n\n                    foreach ($arrRoles as $role) {\n                        //check if this role has access or not\n                        // if not then color is red; if yes then color is green\n                        $role_detail = DB::queryfirstrow(\"SELECT * FROM \".prefix_table(\"roles_values\").\" WHERE folder_id = %i AND role_id = %i\", $node->id, $role);\n                        if (DB::count() > 0) {\n                            if ($role_detail['type'] == \"W\") {\n                                $color = '#008000';\n                                $allowed = \"W\";\n                                $title = $LANG['write'];\n                                $label = '<i class=\"fa fa-indent\"></i>&nbsp;<i class=\"fa fa-edit\"></i>&nbsp;<i class=\"fa fa-eraser\"></i>';\n                            } elseif ($role_detail['type'] == \"ND\") {\n                                $color = '#4E45F7';\n                                $allowed = \"ND\";\n                                $title = $LANG['no_delete'];\n                                $label = '<i class=\"fa fa-indent\"></i>&nbsp;<i class=\"fa fa-edit\"></i>';\n                            } elseif ($role_detail['type'] == \"NE\") {\n                                $color = '#4E45F7';\n                                $allowed = \"NE\";\n                                $title = $LANG['no_edit'];\n                                $label = '<i class=\"fa fa-indent\"></i>&nbsp;<i class=\"fa fa-eraser\"></i>';\n                            } elseif ($role_detail['type'] == \"NDNE\") {\n                                $color = '#4E45F7';\n                                $allowed = \"NDNE\";\n                                $title = $LANG['no_edit_no_delete'];\n                                $label = '<i class=\"fa fa-indent\"></i>';\n                            } else {\n                                $color = '#FEBC11';\n                                $allowed = \"R\";\n                                $title = $LANG['read'];\n                                $label = '<i class=\"fa fa-eye\"></i>';\n                            }\n                        } else {\n                            $color = '#FF0000';\n                            $allowed = false;\n                            $title = $LANG['no_access'];\n                            $label = '<i class=\"fa fa-hand-stop-o\"></i>';\n                        }\n                        if (in_array($node->id, $_SESSION['read_only_folders']) || !in_array($node->id, $_SESSION['groupes_visibles'])) {\n                            $texte .= '<td align=\\'center\\' style=\\'text-align:center;background-color:'.$color.'\\' id=\\'tm_cell_'.$i.'\\' title=\\''.$title.'\\'>'.$label.'</td>';\n                        } else {\n                            $texte .= '<td align=\\'center\\' style=\\'text-align:center;background-color:'.$color.'\\' id=\\'tm_cell_'.$i.'\\' title=\\''.$title.'\\'><span onclick=\\'openRightsDialog('.$role.','.$node->id.','.$i.',\"'.$allowed.'\")\\'>'.$label.'</span><span style=\\'float:right;\\'><input type=\\'checkbox\\' title=\\'\\' class=\\'multi_folders\\' id=\\'multisel_'.$node->id.'_'.$role.'\\'></span></td>';\n                        }\n\n\n                        $i++;\n                    }\n                    $texte .= '</tr>';\n                }\n            }\n            $texte .= '</tbody></table>';\n\n            $return_values = array(\n                \"new_table\" => $texte,\n                \"all\" => $roles_count,\n                \"next\" => $next,\n                \"previous\" => $previous\n            );\n\n            $return_values = json_encode($return_values, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP);\n\n            //return data\n            echo $return_values;\n\n            break;\n    }\n}\n"], "fixing_code": ["2.1.27\n 9/\n Fixed a possible XSS (credit to ADLab of Venustech)\n Improved security related to User Management\n \t> a manager could potentially act on users not related to him\n Improved security related to Items Management\n \t> a user could potentially act on Items he should not have access to\n Securized script.backup.php by adding a security key\n Fixed some other security failures (credit to \u200bsecurity at Amossys)\n Improved security regarding uploading files\n Fixed issue while restoring DB from administration page\n Improved / Fixed administration task for encrypting/decrypting files\n Improved security regarding item history display\n Added filter in Roles\n #1947 Dependency & array update in install checks\n #1945 Cannot delete items\n #1944 File upload results in error\n #1941 Visualisation problems\n\n 8/\n Delete install folders and files during installation process\n Custom Field value can be masked\n Database password is encrypted in settings.php file\n PHPMailer library updated to 5.2.23\n TwoFactorAuth library was updated\n Configuration variables are not set in SESSION anymore. Now read from tp.config.php file.\n Fix: issue on offline export\n Fix: error on deleting a folder at root\n #1939 Unable to change page (role management)\n #1937 Error while using script.backup.php in standalone\n #1935 Add folder results in Requested JSON parse failed\n #1933 Trying to move folder results in error message\n #1932 Keepass upload fails\n #1927 Changing language is not possible for users\n #1924 Moving items give error: Requested JSON parse failed\n #1923 Red wheel keeps turning, blocks display of new items\n #1919 Upgrade to release 2.1.27.8 converts encrypted database password back to clear-text\n #1915 Cannot Edit or Delete items in the Personal folder\n #1909 Roles Management - Problem with acess rights \"Edit\" \"Delete\"\n #1903 SSH Password Change does not work\n #1900 Forgot your password --> Page reload automatic\n #1891 Install error - Uncaught Defuse\\\\Crypto\\\\Exception\\\\BadFormatException: Encoded data is shorter than expected\n #1899 Active Directory authentication not working on fresh installed Cent OS 7\n #1890 access rights in manage roles\n #1888 Export to CVS --> empty file (0 kb)\n #1886 JSON Error when importing with an apostrophe (\u2018)\n #1885 Undefined index: SSL_SERVER_CERT\n #1884 Cannot delete custom fields - hangs indefinitely after confirm with spinning gear\n #1882 Can't see any entry on any folder, using any account\n #1881 Doesn't auto-delete install/ folder after installation completed\n #1880 Custom Fields, Not encrypted/decrypted when toggled in Custom-Field Settings Screen\n #1872 New Admin User login not working -JSON Parse file failure\n #1870 Logic issue in headers sending\n #1866 CSV import with empty url leads to value 0\n #1862 Import from Keepass.xml to Personalfolder no access to Item\n #1857 API: Folders created at level 0 instead of correct level\n #1856 Robustified tp.config.php creation in case of upgrade\n #1851 Fix ldap suffix\n #1850 Missing iconv in Docker\n #1840 Added the \"download\" attribute\n #1837 JSON error in Find page when user has no folders to browse\n #1834 Typo in sources/main.functions.php\n #1833 Opening a one time view page give a notice: A session had already been started...\n #1830 Salt key field has already a character filled in.\n #1829 Attachments is broken after upgrade from 2.1.27.0. Fix in progress\n #1828 No error message when duplicate item names at personal keys\n #1826 New dockerfile and docker-compose.yml\n #1820 group vertical scroll bar not work correctly\n #1819 Fix for QR sending from login page\n\n 6-7/\n Fix: upgrade process with encrypted attachments\n Fix for #1806\n\n 5/\n New: Custom Fields are only visible if defined\n Fix issue in tree if subfolder is visible while parent is not\n Fix issues regarding DUOSecurity\n Fix upgrade doesn't start in case that sk.php file has moved\n Fix for Custom Fields not displayed as defined by `order` field\n #1796 Can't add folder from API\n #1787 email notifications are not sent if there are any admins with empty email address\n #1776 Allow restricting items to users and roles - Wrong Item Owner\n #1775 Can not decrypt a created crypted Backup - Improved encryption with Defuse\n #1774 Announce this Item by email\n #1769 Installation issue - no admin account is created\n #1762 Share user rights works backwards\n #1761 Reset of my Personal Saltkey\n #1743 Enable anonymous LDAP queries\n #1690 Unable to set/save personal salt key with LDAP user\n\n 3-4/\n New: Multiselection in Roles vs Folders matrix\n New: LDAP configuration test mode (in progress)\n Fix: Prevent moving a folder to one of its child folder\n Fix: Global saltkey change\n Fix: Copy folder does'nt copy included items\n Fix: Encrypt/Decrypt attachments feature from admin page\n Fix: SQL injection corrected in users.queries.php (author: Pang@ADLab of Venustech)\n #1742 Fix for issue #1539 verifying LDAP groups properly\n #1740 Missing buttons on Users page\n #1737 Cannot import files\n #1735 Dockerfile - PHP extension \"curl\" is loaded Extension curl is not loaded\n #1733 Copy Item doesn't work if copy from public to public folders\n #1731 Cannot login in after fresh install\n #1729 Protection against bigger data than database field size\n #1727 Cannot edit or delete entry in the Personal folder\n\n 2/\n Secure fixes\n Session increase time feature is now increasing with the expected user session duration\n Default language cannot be changed fix\n Fix for \"hide not accessible folders\" option\n #1725 Some fixes\n #1723 Fix spin not removed while reseting user saltkey\n #1722 SELinux issue leads to upload impossible\n #1718 Moving a folder to itself\n #1717 After deleting a folder, items are still visible in search page\n #1713 Doubleclick on directory shows items twice\n #1710 Error on psk change\n #1709 Missing field in table on fresh install\n #1707 \"Restricted To\" not working correctly when creating new items\n #1706 User can edit & delete items without rights\n #1696 Fix for no log for OTV\n #1695 Manager can create folder at root from Items pas\n #1686 Fix for item History dialogbox\n #1685 Fix in Portuguese file\n #1684 Estonian language still missing\n #1679 Sort by don't work in Utilities/logs\n #1676 Pre-auth XSS in index.php\n #1674 name and lastname are changed on other user edit\n #1672 Anonymous settings not stored\n #1670 Incremental upgrade not active\n #1669 Logout - Errors\n #1668 File encryption is not correct in case of upgrade\n #1666 Can`t set avatar\n #1662 Can not delete folders\n #1659 Third level of sub folders in the Personal folder are not seen\n #1654 User management page - no \"next\" button\n\n 2/\n New   Defuse Encryption implemented in place of phpCrypt\n NEW   AGSES authentication implemented\n NEW   Custom Fields data can be encrytped or not in database\n NEW   Folder copy feature\n NEW   Mass move or delete operation on Items\n NEW   Item change proposal\n IMP   Implemented new session encryption library SecureHandler (getting rid of mcrypt extension)\n IMP   Language selection is now in User Profile (Default language is used on authentication page)\n IMP   User creation dialogbox improved with all user properties\n IMP   New user login availability is checked \"live\"\n IMP   Filtering counters in datatables\n IMP   Users Management dialogbox improved\n IMP   2FA authentication change to improve security (no call to external QR generator)\n UPD   AES library updated\n FIX   \"Find\" feature:\n       - copy from public to personal folder\n       - list of folders is refreshed when copying an Item\n #     Copy folders\n #1635 New folder inheritance of parent specific settings\n #1631 Error could be appear on upgrade when checking folders and files\n #1628 URL link to specific item does not work\n #1627 Improved label preview length\n #1625 Request to add/change password\n #1624 Error 500 while importing item with API (with PHP < 7)\n #1621 New option: OTV can be disabled\n #     New option: create Item without password\n #1620 Direct copy password from seach results and large folders\n #1616 Cannot show password with IE11\n #1614 Generate personal folders sets regular root folders also as personal\n #1608 All folders are deleted\n #1603 Attached files disappears\n #1601 Time zone can't be saved in My Profile\n #1593 Insert duplicate label with API\n #1592 Show Client IP in mail to admin about logged on users\n #1588 Fix for OTV links\n #1587 fix for e-mail to administrator on logon does not work\n #1581 Fix for new folder Custom Fields inheritance\n #1579 Fix for preventing a php fatal error\n #1575 Fix for tree not loaded when user has no access to a folder with children\n #1571 Drag and drop from PF to public folder makes item password corrupted\n #1571 Create an item inside another folder than the one selected\n #1561 Personal folder deletion deletes all\n #1559 API IP Whitelist check does not consider XFF\n #1556 Fix bug for upgrading old passwords\n #1553 LDAP support - Add LDAP port - Add support multi LDAP server\n #1551 Authentication through LDAP posix-search\n #1550 2 Factor enabled but can still log in without code\n #1549 Read Only users can use Personal Folders\n #1543 Wrong Saltkey message after setting\n #1533 The change of the main SALT Key doesn't work\n #1532 Added error message in install.js if db-pw contains double quotes\n #1531 Database otv table originator field should be int instead of tinyint\n #1514 User language selection is done in Profile dialogbox\n #1474 New option: create an item without password\n #1472 \"folder access\" and \"role\" settings when adding new user + propage rights from one user\n #1464 CSV files broken, html entities not decoded, newlines not stripped\n #1422 Folders deletion protocol has been securized to prevent unconsistencies in folders tree\n #1412 New option: Manager can move items they can view\n #1408 Display folders visible by a user\n #1299 Export to pdf or csv shows htmlencoded\n\n2.1.26\n #1537 Homepage not loading in French\n #1527 Error Field 'timestamp' doesn't have a default value\n #1526 New .htaccess file in ./includes/config\n #1525 Bad encoding in previous used passwords list\n #1515 Cannot add new users if similar user name exists\n #1512 Long folder names break UI\n #1511 Fix on LDAP due to library upgrade\n #1510 During upgrade, clean personal_folder field in DB\n #1504 Error while creating a new user with API\n #1494 csrfp.config.php not updated on URL change\n #1491 Added check against only numeric folder name\n #1489 JSON error on quick search if no folder access\n #1497 Nothing happens when clicking \"Remove orphan items from database\"\n #1375 Symbol < breaks password in One Time View page\n #1481 Query error\n #1476 Fix personal folder update script for\n #1463 PDF Export still broken\n #1454 API outputs deleted passwords\n #1453 API should have function \"userpw\"\n #1452 API should also output the url to each password\n #1457 New email address not used until logoff & logon\n #1450 Purge log feature - purges nothing\n #1449 Delete category hangs UI and crashes PHP\n #1448 admin delete removed password multiple select not working\n #1445 Password label doesn't preserve '\\' character\n #1439 Fix for large files upload\n #1438 Sanitize ampersand to URL encoding in csrfp.config\n #1426 Fixes for many critical issues with OTV\n #1421 Item will not be automatically deleted when accessed through otv option enabled\n #1415 Installation Issue and PDF export password field mask\n       Fixed problem for user to change self password\n       Fixed problem for deleting all directories\n #1414 Subfolders created into personal folders are presented in Folders and Roles management\n #1409 Updated PDF library to fit 7.x PHP\n #1407 Remove Save button in 2FA settings tab\n #1402 User can define his timezone\n #1395 Error with Chrome while upgrading\n #1394 Replace ascii characters in cpliboard copy\n #1392 Corrected sql error while restoring database\n #1389 Requested JSON parse failed when copying item\n #1386 JSON parse failed (history item view)\n #1384 SyntaxError: Invalid Character if Syslog enabled\n #1383 Export to PDF - Incorrect formatting\n #1381 LDAP user have unlimited access on first logon\n #1380 CSV or KeePass Import - Title as \"0\"\n #1378 JSON parse error when changing user password (with several roles)\n #1369 Cannot save some settings\n #1361 Duo prevents the ability to add/edit items\n #1353 Add ldap_start_tls if set\n #1346 On upgrade settings.php not found\n #1345 Admin, password change and logoff not working\n #1344 Wrap all non-GROUP BY columns in an aggregate function (MIN)\n #1342 Change my password screen loop\n #1340 Upgrade process last step\n #1335 This page doesn't exist\n #1328 Minimum password complexity for folders and items\n #1334 Fix \"installation related pages\" dead link\n #1333 Fix LDAP search base input\n #1332 API not allowing roles separation of pipe '|'\n #1326 Fixed LDAP functionality\n #1325 updated Dockerfile\n #1310 Addes Estonian language\n #1309 error while loading folders (if simplify tree option enabled)\n #1308 Teampass hangs when a folder is create with option \"New sub-folder inherits rights from parent folder\" enabled\n #1301 add ldap_search_base record for db init\n #1300 After 3 bad login attempts, user needs to wait 10s before new try\n #1299 Export to pdf or csv shows htmlencoded\n #1298 Backup-filename on 2.1.27 contains /\n #1292 SyntaxError: JSON.parse: unexpected character at line 1 column 1 of the JSON data\n #1284 fix for can_manage_all_users update during upgrade\n #1279 SyntaxError: Unexpected token \u00ee in JSON at position 0\n #1278 CSRFProtector protection while restoring a backup file\n #1276 MySQL 5.7 query error\n #1269 Typo error\n #1263 Error at line 75 in suggestion page\n #1251 Improving CSRFP configuration\n #1240 Security fixes on some missed queries and on non-protected text fields\n #1241 OTV visible more than one time\n #1238 Fix for upgrade.php where mysql_result() command were still not replaced\n #1235 Import from Keepass: missing items with the same title\n #1229 CSRFProtector message while DUO is enabled\n #1225 Unable to Access OTV Link\n #1224 Fixed errors in export_to_html_format\n #1211 No FA code sent from home page\n #1210 Fix for main.queries.php\n #1206 Fix for importing files\n #1203 Needed PHP extensions check during install & update process\n #1197 Awesome Font 4.5.0\n #1193 When I login with user admin \" loading ... \" and it does not finish\n #1192 Cannot save \"enable attachments encryption\"\n #1188 Implemented proposals for source code improvement\n #1186 open/highlight folder tree of displayed item\n #1183 Syntax Error on personal folders option\n #1181 403 Access Forbidden by CSRFProtector! at config save\n #1178 New user right added for managing all users (super Manager)\n #1174 Adding LDAP groups support to 'posix-search' LDAP auth\n #1172 Complete number of Items displayed in Tree\n #1158 Admin password cannot be changed\n #910  Backslashes in accounts are not copied to clipboard\n #268  Password recovery \"Forgot your password?\" don't do anything\n NEW: Server user password change through SSH connection\n NEW: Upgrade database handler improved for better upgrades management\n NEW: New user right added for managing all users (super Manager)\n FIX: If expiration engaged and password is changed, the warning is still present.\n FIX: New suggestion folder could remain empty in some specific cases.\n FIX: By creating a role, this new one is directly visible by creator.\n FIX: Security issue with downloadFile.php. Now protected by session and htaccess.\n FIX: QRCode is not visible in Users list\n FIX: Display inconsistancies in User log results\n Fix: Inconsistency in Delete & Restore process\n Fix: Errors in CSV import process\n Fix: Impossible to proceed with 'password lost' process\n Fix: OTV item not reachable\n Analyzed with RIPS (https://www.ripstech.com/) against security bugs\n\n2.1.25\n #1169 sending Google Authenticator code through index page\n #1160 hiding user password change option if DUOSecurity\n #1152 Error while saving settings\n #1149 log failed user authentication\n #1148 Answer from Server cannot be parsed!\n #1147 Mask/Display password not logged\n #1146 Roles on separate pages\n #1144 Login failure gives odd error\n #1143 import csv double quotes issue\n #1141 Syslog\n #1140 Security fix for Multiple vulnerabilities\n #1135 DataTables warning : table id=t_users - Invalid JSON Response\n #1128 Requested Json Parse Failed\n #1123 No Item to show in a folder after upgrading\n #1122 When deleting an item, confirmation modal doesn't show the name of the item to be deleted\n #1120 Not connect.n Verify Network\n #1114 Cannot Delete Favorites Due to \"undefined function prefix_table() \"\n #1108 Table teampass_keys missing!\n #1103 omplexity Matches new password but still claims otherwise\n #1102 Users cannot create folders\n #1096 One time link view problem\n #1095 Move Personal folder to Group Folder\n #1086 \"Error Encryption of the Password\" after update\n #1078 Send events to syslog\n Fix for changing SaltKey in admin page\n Fix for complete list of Roles in Admin Roles page\n Fix for Users and Items currently edited list that were not proposing \"next\" button\n Fix for label \u201cBy clicking the save button, you will delete \u2026.\u201d persistent\n Fix for list loaded twice if double click in Tree folder\n Fix for search result not displayed if previous folder was empty\n Fix for possible sql injection via LIMIT parameters\n Fix on profile dialogbox\n Implemented Deletion and Restoration events in item's History\n Implemented better handling of User role selection\n Implemented multi personal folders\n Implemented CSRFP library usage for security purpose\n Implemented new \"Yes/No\" button in settings page\n Implemented log view for failed authentication\n Implemented Tree sequentially load (via ajax)\n Add new item from API (for teampass-connect) (not yet tested)\n\n2.1.24\n #1090 - Fix for Export to PDF last folder not taken into consideration\n #1088 - #1085 - Password show problem\n #1087 - Managers can edit and delete Items they are allowed to see flag\n #1085 - Fix for copy to clipboard that sometime fails to work correctly\n #1073 - User can create folder on root without permission\n #1074 - Read only user can create folders + wipe out all items on remove folder\n #1069 - Knowledge Base can not change page\n #1068 - personal saltkey not saved\n #1067 - Suggestion feature not working\n #1064 - Record in db are not deleted when you delete in GUI\n #1058 - Fix API issue while adding an item\n #1063 - Fix for Forgot password not working\n #1062 - Warning for hex2bin function usage (PHP>5.4)\n #1061 - for for Can not import password from keepass xml\n #1055 - Personal item cannot be deleted\n #1048 - Encryption error flag is visible for no reason\n #1045 - Missing fields in table (pw_iv and data_iv)\n #1042 - Added pagination in Users page\n #1042 - Pagination on Users Page\n #1060 - Added new logging events (password copied, password shown)\n #1041 - \"Forgot your password?\" not working\n #1027 - User right more refined with \"No deletion\" possible right\n #953 - Make sure to rebuild the tree when creating an user with a personal folder\n #1035 - added php-xml install check\n #950 - #1005 - can not create Admin account\n #936 - #937 - Session file_exists not allowed while running through open_basedir restriction\n #970 - API special char fix\n #962 - Error message when using the Find-function\n #955 - Fix LDAP Settings UI\n Fix passwords are empty when importing from Keepass\n Fix empty URL column in off-line html\n A lot of small fixes\n New: implemented 2factor authentication DUOSecurity feature\n New: create User via API\n New: Vietnamese language added\n New: Tree structure is loaded dynamically\n New: Notification to Managers for awaiting suggestions\n\n 2.1.23\n #727 - #729 - Encoding problem\n #799 - Error: Field 'field_1' doesn't have a default value\n #830 - Fix documentation syntax\n #829 - Removing unecessary php closing tags\n #807 - Fix rights based on roles for new folders\n #808 - Add a SMTP security parameter to the email configuration\n #805 - Keepass Import improvements\n #790 - Install fixes\n #835 - Links in items description don't work\n #817 - Wrong number of users online\n #838 - Fix for mysqli encoding\n #839 - Keepass fixes\n #853 - New setting for default session expiration delay\n #851 - Multiple fixes for LDAP integration\n #814 - #857\n #880 - Fix for View logs error redeclared function getBits\n #881 - Fix for \"Forgot your password?\" not working\n #900 - Fix for New folder incorrect permissions (read-only)\n #890 - Fix for Personal Folder only read permission\n #910 - Fix for Backslashes in accounts are not copied to clipboard\n #913 - Fix for 'Announce this item by email' fails\n #915 - Export to PDF corrected\n #907 - Move folder feature\n #917 - Fix on API\n #941 - Fix for user_not_exists message (LDAP)\n #988 - Error on copy item\n #992 - Added to Log User Created By\n PR : #871 - #887\n API: add FIND feature\n Fix: copy not possible in RO folders\n Fix: If GA activated, Users can ask for a new code from the login page\n Fix: Off-line file url was not correct in download button\n Removal of Keys table\n Implementation of PhpCrypt library as encryption library (AES-128 with CBC mode)\n Implementation of Awesomefont in Items page\n Clean up of old comments\n Added \"long press\" to show password\n Fix of bug in Offline export\n List of Users is now loaded through Ajax to prevent timeout in case of long list of users\n Personal saltkey change is now performed through Ajax to prevent timeout in case of long list of passwords\n Fix for users with \"Allowed folders\" that can't write inside them.\n Removed extra files from Yubico folder\n Update process: suggestions passwords are reencrypted\n Suggestion migrated to new encryption\n\n2.1.22\n #700 - Errors related to \"includes/js/jstree/themes/default\"\n #718 - Two factor authentication: \"This user has no email set!\"\n #674 - API - User rights\n #697 - Default language setting, not being applied to automatically created ldap users.\n #698 - Default language setting, not being applied to newly created users.\n #707 - httpRequest is missing in upgrade process\n #725 - Disable button after item creation or edition\n #720 - cannot sign up to 2factor\n #690 - limit password export via PDF/CSV to user/group\n #745 - Enable again save_button after error on Add/Edit Item\n #739 - OTV correction\n #731 - Export password to file\n #653 - Passwords preprended during upgrade\n #767 - Backup restore feature fix\n #774 - Call to undefined method DB::queryInsert\n Other: #711 - #699 - #726 - #744 - #684 - #737\n New - Rights \"Read / Write / No Access\" added to folders for better rights management\n New - quick copy to clipboard for password and login\n New - New option : Prevent against duplicate items in same folder\n New - If folder is read-only for the User then it is striked-through\n Changed - list of restricted users refined by folder selected\n Fix - Not possible to see more than 8 Roles in Roles matrix\n\n2.1.21\n #597 - Rapid click on save button on \"Add a folder\"\n #599 - SQL:AUTO_INCREMENT id --> language\n #600 - preg_replace(): Unknown modifier '|'\n #598 - Extra fields in home page\n #602 - can't change user password by very heavy complexity\n #603 - password complexity check only in javascript\n #415 - Items are not show when in folder view. Can easy search and open.\n #578 - API generate new key\n #580 - Redirect to login page when accessing directly an item (if not logged)\n #576 - Mismatch email_body tags\n #607 - HMTL export erroneous download link\n #622 - Tooltip on left menu buttons\n #619 - CSV Import does not import passwords\n #617 - CSV Import doesn't handle passwords with quotes well\n #627 - Complete authentication bypass\n #626 - API vulnerable (improvement in progress)\n #633 - favicon correction\n #636 - MySQL on non-standard port\n #632 - Refactor order of index.php\n #629 - A password for admin account is required during installation\n #654 - Tab character breaks json format\n #652 - one-time view not working when interface is in French\n #658 - Rapid Click on Item Copy\n #657 - Rapid Click on Password Creation\n #656 - Can't Create Folder as User\n #643 - email charset in UTF-8\n #641 - Add and save item -> double click on that icon won't work\n #671 - When password is generated, it is added in confirm field too\n #672 - Changing password makes account inaccessible\n #637 - Multi Domain LDAP\n #673 - Changed strategy for quick icon clipboard copy\n #639 - Design fix in admin page\n #681 - Fix for Folder and Users creation as Administrator\n #680 - Set custom expiry for one time view link\n #682 - Fix SMTP authentication which were used regardless of the settings\n      - Fix a query used in the \"lost password\" management.\n      - Fix the mysql error message when the session_expired page is accesseded...\n - New option permitting to send or not an email to User when admin changes his password\n - Fix for image viewer when option files encryption is set\n - Fix for password complexity level update\n\n2.1.20\n #492 - Default admin password not working\n #509 - Password complexity\n #493 - Unable to purge logs\n #503 - manual insertions in Items History log not working\n #494 - Logs > Administration JSON error\n #491 - Applying email address to user\n #441 - Attachments encryption\n #459 - Turn off strict mode\n #477-#452 - Fix for upgrade\n #459 - Turn off strict mode\n #472 - Error on line 582 index.php\n #474 - Set default to checked for secure passwords\n #497 - Moved GA QR code creation to administration\n #487 - Off-line mode, link make the page scroll up\n #533 #521 #528 - Installation issue\n #525 - Settings.php should not be commited\n #527 - Potential security bug\n #485 - CVS Import on V 2.1.19 quotes problems\n #544 - DataTables warning: JSON data from server could not be parsed\n #547 - User search\n #520 - API access\n #549 #550 - Server Time in footer\n #539 - New feature: Simplify Items Tree\n #547 - Search in Users page\n #401 - Folder role inheretance on new folder\n #552 - added MBstring check\n #554 - Search-Page \"Jump to item\"-Button not working correctly\n Fork from slimm609 - Encrypted Sessions and CSRFGuard enabled\n Issues with folder creation in \"personal folder\"\n #536 - one time view page for anonymous user\n #517 - New feature: Suggest items system\n New feature: Sub-folder inherits of parent folder\n\n2.1.19\n #413 - fix for PHP Parse error: syntax error, unexpected '['\n #447 - fix for PHP Fatal error: Cannot redeclare getBits()\n #442 - problem edit folder\n #399 - Export encrypted passwords (off-line mode)\n #408 - Personal Salt Key changing doesn't work\n #419 - Password complexity not refreshed\n #418 - English translation improvement\n #407 - \"Restricted to\" feature improvement\n #402 - In item list, description is cut with <br />\n #393 - Password input and confirmation field location\n #388 - Unable to move items between folders\n #400 - Extra fields for Item\n #414 - Maintenance mode during upgrade can be disabled\n #389 - Language dropdown not working\n #392 - Check of absolute path for SK.PHP\n #385 - Email not sent ... check your configuration (to be checked)\n #379 - CSV importing not working (to be checked)\n #134 - Login After Session Expires\n #429 - Changed user.psk field to allow NULLs\n #428 : error: iconv(): Detected an illegal character in input string\n #426/#430 : New option to disable information loading in Admin page\n #142 - Google Authenticator implemented\n * Dialogbox not closed when changing folder name\n * Display Item details through Find page error\n\n2.1.18\n #315 - jstree style.css badly referenced\n #314 - Folder is not being deleted\n #320 - Enabling LDAP prevents local admin login\n #317 - server expected extensions are tested\n #318 - Upgrade process badly creates sk.php file\n #348 - Fix for undefined index \"isAdministratedByRole\"\n #350 - Fix for Lock and delete user actions don't refresh page\n #354 - Fix for removing folders\n #359 - Fix for initial user password change complexity check\n #371 - Fix for uploaded files corrupted\n #291 - Fix to support openLDAP / posix style LDAP\n #361 - Option to use login password as SALT key\n * Fix - no possibility to update a Role\n * Fix - editing users by clicking on the fields broken\n * Fix - parse error in database errors log\n * New - requested user password complexity shown when changing password\n * New - option for deactivate client-server encryption (usage of SSL)\n * New - in tree, new counters added (subfolders and items in subfolders numbers)\n * New language added - Catalan\n\n2.1.17\n * New exchange encryption protocol. No key is visible. The channel is\n encrypted at start of session.\n * HTTPS connection can be activated (be carefull, you need a certificate)\n * Change Users passwords encryption\n * Corrected - once clicked on not authorized Item, any Item selection was\n no more possible.\n #283 - Rights on a folder created at root are set.\n #285 - New settings: Anyone can modify option can be activated by default\n #287 - newly created personal folders ar propergated to the group\n #289 - Personal folder name badly constructed\n #270 - Restricted items visible in Find results\n #298 - Protection against bad actions on personal folders\n #299 - User can be explicetly administrated by Managers of specific Roles\n #300 - Personal SK is encrypted in COOKIE\n #301 - Corrected query call error\n #302 - Under \"Views\" users can see items that exist in personal folders\n that have been accessed\n #307 - fclose() statement badly placed\n\n2.1.16\n * #245 - #248 - #249 - #265 - #266 - #267 - #268 - #273\n * #277: Change personal saltkey error\n\n2.1.15\n * list of bugs corrected: #242 - #254 - #244 - #247 - #256 - #250 - #254 - #248\n   #243 - #252 - #232 - #240 - #260 - #259 - #262 - #251 - #236\n * MySQL hashing => todo\n * CSV importation\n\n2.1.14\n * list of bugs corrected: #238 - #235 - #239 - #203 - #201 - #233 - #226 - #236\n   #228 - #189 - #234 - #225 - #239 - #194 - #86\n * Corrected bug for sending emails\n * Different small corrections\n\n2.1.13\n * Code improvement for PSR compliance\n * jQueryUI updated to v1.9\n * Cleanup unused files\n * #207: Managers can only see the Roles they are allowed to.\n * #190, #192, #199, #202, #196, #204, #191, #214 corrected\n * Correction: taking into account user \"can create at root level\" setting\n * Added: saltkey is exported in a unique file that should be moved outside\n   \"www\" server scope.\n * Added: 2-factors authentication\n * Added: new check when Role creation\n * Added: new check for database query error\n * Added: Item in edition will lock any other edition\n * Added: New administrator View permitting to view \"Users actually connected\"\n   and \"Tokens taken for Items in edition\"\n * Added: User account contains now Name and Last Name fields\n\n2.1.12\n * #188\n * #185 Started adjusting codebase to follow PSR 1 and PSR 2 based on ecaron\n \t\twork (thank you)\n\n2.1.11\n * #184 - bug correction\n\n2.1.10\n * #161 - #100 - #175\n * #163 Personal saltkey duration based on cookie (under option)\n * share item -> manage error when email not sent\n * Improved/corrected export CSV and PDF\n * Correction: During upgrade, languages table is wrong\n * Personal Saltkey is stored in cookie (new admin setting)\n * Emails settings are moved to admin settings page (no more in settings.php)\n * Files folder is now a setting (to improve security)\n * Exported PDF is encrypted (contributor: Jay2k1)\n * #168 Add description field in PDF\n * #174 User creation and modification log\n\n2.1.9\n * #126-#132-#130-#131-#139-#129-#141-#146\n * Italian translation\n * Find page - focus in search box (contributor: Jay2k1)\n\n2.1.8\n * SF 206\n * #107-#95-#102-#103-#67-#32-#87-#71-#125-#120-#116-#111-#108-#104-#90-\n   #85-#78-#48-#34-#67-#75-#82-#84\n * bug correction cache table\n * view Item details from the Find page\n * CSV export  -> started\n * mail notification when selecting an item\n * share Item by mail\n * add email field in Item form\n * automatic deletion of Item after X opening or after limit date\n * Roles / Folders matrix: Roles passwords complexity shown\n\n2.1.7\n * SF 247 - 248 - 261 - 264 - 265 - 266 - 267\n * 67:\tprotect uploadify library => different file protection added\n * protect Downloadfile.php\n * SF228: reset personal saltkey (purge personal items)\n * SF262: copy of item is in log\n * old password in log was badly encoded\n * item copy from search page corrected\n * some rights checks added before action\n * email send to new created user\n\n2.1.6\n * #59: settings.php email setting errors\n * #67: Protected upload file\n * added email notification for user requiering an access to a restricted item.\n * 264:\tFeature Request: Password History\n\n2.1.5\n* #56: Temporary solution for keeping old ADMIN profile rights\n\n2.1.4\n* Corrections: SF237, SF240, SF243 , #29, #25,  #32 , #36 , #37 , #39 , #40\n\tSF257, SF259, SF239, #41, #40, #51\n* Improvements:\n\tSF232\n\tSF231:\tHow to Restrict Admin from Viewing items\n\t#31: new setting option for dynamic list\n\t#27: new subfolders only associated to the same roles as the parent folder\n\t#33: folder management in items page\n\tChanging SALT key from admin pages\n\n2.1.3\n* upgrade improvement in case of upgrading from 1.x version.\n\n2.1.2\n* improved upgrade connection errors and automatic credentials import\n* Corrections: #4, #7, 236\n\nv2.1.1\n* 2 bugs correction\n\nv2.1\n* Licence has changed to GNU AFFERO GPL 3.0\n* 203 - password complexity on Roles\n* 121 - Default language can be set + user language stored in DB\n* Encrypt old passwords in LOG_ITEMS table\n* started CRON activity for emails sending\n* new option: send email to Admins when users get connected\n* \"Restricted to\" field not viewable to everyone\n* add an icon for hide/show passwords in clear text (toggle button)\n", "body{\nwidth: 1000px;\nmargin-left: auto;\nmargin-right: auto;\n/*background: #F0F0F0 url(../images/stripe.png) repeat;*/\nbackground: #000000 url(../images/canevas/background_cell.jpg) repeat;\nfont-family: sans-serif;\nfont-size:11pt;\n}\n\n#top{\nwidth: 980px;\nheight: 35px;\nmargin-left: auto;\nmargin-right: auto;\npadding: 10px;\n/*background: #F0F0F0 url(../images/stripe_footer.png) repeat;*/\nfont-family: sans-serif;\nfont-size: 10px;\ndisplay:block;\nbackground-image: url(../images/canevas/menu_top_bckg.png);\n}\n\n#logo{\nfloat:left;\nmargin-right: 5px;\nmargin-top: -5px;\nmargin-left: -5px;\n}\n\n#menu_top{\nfloat:left;\n}\n\n#footer{\nwidth: 980px;\nheight: 20px;\nline-height: 16px;\nmargin: 10px auto 0 auto;\npadding: 10px;\nbackground-image: url(../images/canevas/menu_top_bckg.png);\nfont-family: sans-serif;\nfont-size: 10px;\ncolor: #F0F0F0;\n}\n\n#div_right_menu{\n  position:absolute;\n  margin:54px -32px 0 1000px;\n  background-image: url(../images/canevas/menu_top_bckg.png);\n  padding:5px;\n}\n\n#div_last_items{\n  background-color: #FFF0A4;\n  padding: 5px;\n  margin-top: 5px;\n  font-size: 12px;\n}\n\n#main{\npadding: 10px;\nmargin-top: 10px;\nmin-height: 250px;\nbackground:white url(../images/canevas/logo_home.png) 50% 50% no-repeat;\n}\n\n#main_simple{\nmargin-top: 10px;\n}\n\n#title {\n  font: bold 270%/100% \"Lucida Grande\";\n  color: #464646;\n  float:left;\n  margin-top:3px;\n}\n\ndiv#global {\nposition: relative;\n}\ndiv#header {\ncolor: #fff;\n}\ndiv#center {\npadding-bottom: 50px;\nbackground-color:white;\ndisplay: block;\n}\ndiv#content {\nfloat:left;\nwidth:660px;\nmargin-left:10px;\n\n}\n\n\nthead th{\nfont-size: 13px;\nfont-weight: bold;\nbackground: #344151;\npadding: 4px 10px 4px 10px;\nfont-family: arial;\ncolor: #FFFFFF;\n}\ntr.ligne0 td {\nbackground-color:#FFFFFF;\nborder-bottom:1px solid #CCCCCC;\nfont-family: arial;\nfont-size:11px;\n}\ntr.ligne1 td {\nbackground-color:#F0F0F0;\nborder-bottom:1px solid #CCCCCC;\nfont-family: arial;\nfont-size:11px;\n}\n\n#div_loading, .div_center {\n  position:absolute;\n  left: 50%;\n  top: 40%;\n}\n\na:link {text-decoration: none; color:#000000;}\na:visited {text-decoration: none; color:#000000;}\na:active {text-decoration: none; color:#000000;}\n/*a:hover {text-decoration: underline; color:#000000;}*/\na img {border:  none ;}\na img {border:  none ;}\n\n.input_text {\nmargin-bottom:10px;\nwidth:95%;\npadding: 4px;\n}\n\n.input_text_60 {\nmargin-bottom:10px;\nwidth:60%;\npadding: 4px;\n}\n\n.input_text_80 {\nmargin-bottom:10px;\nwidth:80%;\npadding: 4px;\n}\n\n.label_cpm{\ndisplay:block;\n}\n\n.form_label{\ndisplay:block;\nwidth:180px;\nfloat:left;\n}\n\n.form_label_100{\ndisplay:block;\nwidth:100px;\nfloat:left;\n}\n\n.td_title{\nfont-weight:bold;\nmin-width: 120px;\n}\n\nul{\nlist-style-type:none;\n}\n\n.button_menu { outline: 0; margin:0; padding: 1px; text-decoration:none; cursor:pointer; position: relative; text-align: center; }\n\n.title {\n  font: bold 160%/100% \"Lucida Grande\";\n  color: #464646;\n  margin: 3px 0px 10px 0px;\n  padding: 10px;\n}\n\n.normal {\n  font: normal; \"Lucida Grande\";\n  color: #464646;\n}\n\n.readme{\n  font-family: sans-serif;\n  font-size: 9px;\n  line-height:15px;\n  margin-top: 20px;\n  height: 150px;\n  width:600px;\n  float:left;\n}\n\n.last_seen_item{\n  cursor:pointer;\n  font-family: sans-serif;\n  font-size: 11px;\n  margin-left: 8px;\n}\n\n.last_seen_item:hover{\n  color:red;\n}\n\n.pointer{\n  cursor:pointer;\n}\n\n.setting_flag{\n  margin-left:10px;\n}\n\n\n/*SIMPLEPASSMETER*/\n\n.simplePassMeter {\n  border: 1px solid #aaa;\n  background-color: #f3f3f3;\n  color: #666;\n  font-size: 0.8em;\n  padding: 1px 5px 0 5px;\n  margin: 0;\n  width: 19em;\n}\n\n.meterFail { border: 1px solid #daa; background-color: #fdd; }\n.meterWarn { border: 1px solid #fd6; background-color: #feb; }\n.meterGood { border: 1px solid #ada; background-color: #dfd; }\n.meterExcel { border: 1px solid #aad; background-color: #ddf; }\n\n.simplePassMeterBar { background-color: #ddd; }\n.meterFail .simplePassMeterProgress  { background-color: #f66; }\n.meterWarn .simplePassMeterProgress  { background-color: #fd6; }\n.meterGood .simplePassMeterProgress  { background-color: #ada; }\n.meterExcel .simplePassMeterProgress { background-color: #88f; }\n\n.simplePassMeter p { margin: 0; }\n.simplePassMeterIcon { height: 16px; width: 16px; float: left; }\n.meterFail .simplePassMeterIcon,\n.meterWarn .simplePassMeterIcon,\n.meterGood .simplePassMeterIcon,\n.meterExcel .simplePassMeterIcon {\n  background-image: url('../images/simplePassMeterSprite.png');\n  background-repeat: no-repeat;\n}\n.meterExcel .simplePassMeterIcon { background-position: 0 0; }\n.meterFail .simplePassMeterIcon { background-position: 0 -17px; }\n.meterGood .simplePassMeterIcon { background-position: 0 -34px; }\n.meterWarn .simplePassMeterIcon { background-position: 0 -51px; }\n\n.simplePassMeterText { margin-left: 2px; }\n\n#div_ga_url {\n  text-align:center;\n  margin:0 0 10px 0;\n  font-size:9pt;\n  display:none;\n  padding:5px;\n}\n\ninput.watermark {\n  color: #999;\n}\n\n/* Allow Font Awesome Icons in lieu of jQuery UI and only apply when using a FA icon */\n.ui-icon[class*=\" icon-\"] {\n  /* Remove the jQuery UI Icon */\n  background: none repeat scroll 0 0 transparent;\n  /* Remove the jQuery UI Text Indent */\n  text-indent: 0;\n  /* Bump it up - jQuery UI is -8px */\n  margin-top: -0.5em;\n}\n\n/* Allow use of icon-large to be properly aligned */\n.ui-icon.icon-large {\n  margin-top: -0.75em;\n}\n\n.ui-button-icon-only .ui-icon[class*=\" icon-\"] {\n  /* Bump it - jQuery UI is -8px */\n  margin-left: -7px;\n}\n\n.menu_150 {\n  width:150px;\n}\n\n.menu_200 {\n  width:200px;\n}\n\n.menu_250 {\n  width:250px;\n}\n\n.no-icon {\n  display:none !important;\n}\n\n.ui-menu li {\n  font-size:10pt !important;\n}\n\n\n.mi-green {\n  color: #388952;\n}\n.mi-yellow {\n  color: #FC9300;\n}\n.mi-red {\n  color: #CC0000;\n}\n.mi-black {\n  color: #222222;\n}\n.mi-grey-1 {\n  color: #9B9B9B;\n}\n\n.form_text {\n  padding:2px;\n  margin-bottom:5px;\n}\n\n.ui-button.redButton {\n  background-color: red;\n}\n.ui-button.greenButton {\n  background-color: green;\n}\n\ndiv.dataTables_processing { z-index: 1; }\n\n.ui-color {background:#F59829 !important;}\n\n.round-grey {\n  padding:2px 6px 2px 6px;\n  font-size:9pt;\n  border: 1px #f3f3f3;\n}\n\n#main_menu .btn-default {\n  width: 32px; height: 26px;\n  font-size: 10px;\n  padding: 2px 0 2px 0;\n  margin: 0px;\n  top: -5px;\n  background: rgba(240,240,240,1);\n  background: -webkit-gradient(left top, left bottom, color-stop(0%, rgba(240,240,240,1)), color-stop(60%, rgba(246,246,246,1)), color-stop(100%, rgba(199,199,199,1)));\n  background: -webkit-linear-gradient(top, rgba(240,240,240,1) 0%, rgba(246,246,246,1) 60%, rgba(199,199,199,1) 100%);\n  background: linear-gradient(to bottom, rgba(240,240,240,1) 0%, rgba(236,236,236,1) 60%, rgba(199,199,199,1) 100%);\n}\n\n#main_menu > div > ul > li > i {\n  font-size: 15px ! important;\n}\n\n#main_menu > div > ul  {\n  border-radius: 4px;\n  height: 26px;\n}\n\n.ui-button-text-only .ui-button-text {\n  padding: 4px;\n}\n.ui-menu-item > i {\n  font-size: 1.0em;\n  line-height: .70em;\n  vertical-align: -20%;\n  padding: 2px 0 0 0 ;\n}\n.title .ui-button-text > i {\n  width: 1.0em;\n}\n\n.quick_menu {\n  border-radius: 4px;\n}\n.ui-menu  .ui-menu-item  {\n  padding: 1px 3px 4px 3px ;\n}\n\n.fa-bars:before {\n  display:block;\n  content:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAANCAMAAABBwMRzAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRFAAAAAAAApWe5zwAAAAJ0Uk5T/wDltzBKAAAAGUlEQVR42mJgZEAGjAwE+agAkz+w5gEEGAAggABP5U/AbAAAAABJRU5ErkJggg==');\n  margin: 1px 1px 0px 1px;\n  width: 15px;\n  height: 15px;\n  }\n\n.hidden {\n  display: none;\n}\n\n.no-border {\n  border: none;\n  border-collapse: collapse;\n}", "<?php\n/**\n *\n * @file          index.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\n\nheader(\"X-XSS-Protection: 1; mode=block\");\nheader(\"X-Frame-Option: SameOrigin\");\n\n// **PREVENTING SESSION HIJACKING**\n// Prevents javascript XSS attacks aimed to steal the session ID\nini_set('session.cookie_httponly', 1);\n\n// **PREVENTING SESSION FIXATION**\n// Session ID cannot be passed through URLs\nini_set('session.use_only_cookies', 1);\n\n// Uses a secure connection (HTTPS) if possible\nini_set('session.cookie_secure', 0);\n\n// Before we start processing, we should abort no install is present\nif (!file_exists('includes/config/settings.php')) {\n    // This should never happen, but in case it does\n    // this means if headers are sent, redirect will fallback to JS\n    if (headers_sent()) {\n        echo '<script language=\"javascript\" type=\"text/javascript\">document.location.replace(\"install/install.php\");</script>';\n    } else {\n        header('Location: install/install.php');\n    }\n    // Now either way, we should stop processing further\n    exit();\n}\n\n// initialise CSRFGuard library\nrequire_once('./includes/libraries/csrfp/libs/csrf/csrfprotector.php');\ncsrfProtector::init();\n//session_destroy();\nsession_id();\n\n// Load config\nif (file_exists('../includes/config/tp.config.php')) {\n    require_once '../includes/config/tp.config.php';\n} elseif (file_exists('./includes/config/tp.config.php')) {\n    require_once './includes/config/tp.config.php';\n} else {\n    throw new Exception(\"Error file '/includes/config/tp.config.php' not exists\", 1);\n}\n\n// Include files\nrequire_once $SETTINGS['cpassman_dir'].'/includes/config/settings.php';\nrequire_once $SETTINGS['cpassman_dir'].'/includes/config/include.php';\nrequire_once $SETTINGS['cpassman_dir'].'/includes/libraries/protect/SuperGlobal/SuperGlobal.php';\n$superGlobal = new protect\\SuperGlobal\\SuperGlobal();\n\n\n// initialize session\n$_SESSION['CPM'] = 1;\nif (isset($SETTINGS['cpassman_dir']) === false || $SETTINGS['cpassman_dir'] === \"\") {\n    $SETTINGS['cpassman_dir'] = \".\";\n    $SETTINGS['cpassman_url'] = $superGlobal->get(\"REQUEST_URI\", \"SERVER\");\n}\n\n// Include files\nrequire_once $SETTINGS['cpassman_dir'].'/sources/SplClassLoader.php';\nrequire_once $SETTINGS['cpassman_dir'].'/sources/main.functions.php';\n\n\n// Open MYSQL database connection\nrequire_once './includes/libraries/Database/Meekrodb/db.class.php';\n$pass = defuse_return_decrypted($pass);\nDB::$host = $server;\nDB::$user = $user;\nDB::$password = $pass;\nDB::$dbName = $database;\nDB::$port = $port;\nDB::$encoding = $encoding;\nDB::$error_handler = true;\n$link = mysqli_connect($server, $user, $pass, $database, $port);\n$link->set_charset($encoding);\n\n\n// Load Core library\nrequire_once $SETTINGS['cpassman_dir'].'/sources/core.php';\n\n\n// Prepare POST variables\n$post_language =        filter_input(INPUT_POST, 'language', FILTER_SANITIZE_STRING);\n$post_sig_response =    filter_input(INPUT_POST, 'sig_response', FILTER_SANITIZE_STRING);\n$post_duo_login =       filter_input(INPUT_POST, 'duo_login', FILTER_SANITIZE_STRING);\n$post_duo_data =        filter_input(INPUT_POST, 'duo_data', FILTER_SANITIZE_STRING);\n\n// Prepare superGlobal variables\n$session_user_language =        $superGlobal->get(\"user_language\", \"SESSION\");\n$session_user_id =              $superGlobal->get(\"user_id\", \"SESSION\");\n$session_user_flag =            $superGlobal->get(\"user_language_flag\", \"SESSION\");\n$session_user_admin =           $superGlobal->get(\"user_admin\", \"SESSION\");\n$session_user_avatar_thumb =    $superGlobal->get(\"user_avatar_thumb\", \"SESSION\");\n$session_name =                 $superGlobal->get(\"name\", \"SESSION\");\n$session_lastname =             $superGlobal->get(\"lastname\", \"SESSION\");\n$session_user_manager =         $superGlobal->get(\"user_manager\", \"SESSION\");\n$session_user_read_only =       $superGlobal->get(\"user_read_only\", \"SESSION\");\n$session_is_admin =             $superGlobal->get(\"is_admin\", \"SESSION\");\n$session_login =                $superGlobal->get(\"login\", \"SESSION\");\n$session_validite_pw =          $superGlobal->get(\"validite_pw\", \"SESSION\");\n$session_nb_folders =           $superGlobal->get(\"nb_folders\", \"SESSION\");\n$session_nb_roles =             $superGlobal->get(\"nb_roles\", \"SESSION\");\n$session_autoriser =            $superGlobal->get(\"autoriser\", \"SESSION\");\n$session_hide_maintenance =     $superGlobal->get(\"hide_maintenance\", \"SESSION\");\n$session_initial_url =          $superGlobal->get(\"initial_url\", \"SESSION\");\n$server_request_uri =           $superGlobal->get(\"REQUEST_URI\", \"SERVER\");\n$session_nb_users_online =        $superGlobal->get(\"nb_users_online\", \"SESSION\");\n\n\n/* DEFINE WHAT LANGUAGE TO USE */\nif (isset($_GET['language']) === true) {\n    // case of user has change language in the login page\n    $dataLanguage = DB::queryFirstRow(\n        \"SELECT flag, name\n        FROM \".prefix_table(\"languages\").\"\n        WHERE name = %s\",\n        filter_var($_GET['language'], FILTER_SANITIZE_STRING)\n    );\n    $superGlobal->put(\"user_language\", $dataLanguage['name'], \"SESSION\");\n    $superGlobal->put(\"user_language_flag\", $dataLanguage['flag'], \"SESSION\");\n} elseif ($session_user_id === null && null === $post_language && $session_user_language === null) {\n    //get default language\n    $dataLanguage = DB::queryFirstRow(\n        \"SELECT m.valeur AS valeur, l.flag AS flag\n        FROM \".prefix_table(\"misc\").\" AS m\n        INNER JOIN \".prefix_table(\"languages\").\" AS l ON (m.valeur = l.name)\n        WHERE m.type=%s_type AND m.intitule=%s_intitule\",\n        array(\n            'type' => \"admin\",\n            'intitule' => \"default_language\"\n        )\n    );\n    if (empty($dataLanguage['valeur'])) {\n        $superGlobal->put(\"user_language\", \"english\", \"SESSION\");\n        $superGlobal->put(\"user_language_flag\", \"us.png\", \"SESSION\");\n        $session_user_language = \"english\";\n    } else {\n        $superGlobal->put(\"user_language\", $dataLanguage['valeur'], \"SESSION\");\n        $superGlobal->put(\"user_language_flag\", $dataLanguage['flag'], \"SESSION\");\n        $session_user_language = $dataLanguage['valeur'];\n    }\n} elseif (isset($SETTINGS['default_language']) === true && $session_user_language === null) {\n    $superGlobal->put(\"user_language\", $SETTINGS['default_language'], \"SESSION\");\n    $session_user_language = $SETTINGS['default_language'];\n} elseif (null !== $post_language) {\n    $superGlobal->put(\"user_language\", $post_language, \"SESSION\");\n    $session_user_language = $post_language;\n} elseif ($session_user_language === null || empty($session_user_language) === true) {\n    if (null !== $post_language) {\n        $superGlobal->put(\"user_language\", $post_language, \"SESSION\");\n        $session_user_language = $post_language;\n    } elseif ($session_user_language !== null) {\n        $superGlobal->put(\"user_language\", $SETTINGS['default_language'], \"SESSION\");\n        $session_user_language = $SETTINGS['default_language'];\n    }\n} elseif ($session_user_language === '0') {\n    $superGlobal->put(\"user_language\", $SETTINGS['default_language'], \"SESSION\");\n    $session_user_language = $SETTINGS['default_language'];\n}\n\nif (isset($SETTINGS['cpassman_dir']) === false || $SETTINGS['cpassman_dir'] === \"\") {\n    $SETTINGS['cpassman_dir'] = \".\";\n    $SETTINGS['cpassman_url'] = (string) $server_request_uri;\n}\n\n// Load user languages files\nif (in_array($session_user_language, $languagesList) === true) {\n    if (file_exists($SETTINGS['cpassman_dir'].'/includes/language/'.$session_user_language.'.php') === true) {\n        require_once $SETTINGS['cpassman_dir'].'/includes/language/'.$session_user_language.'.php';\n    }\n} else {\n    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n    include $SETTINGS['cpassman_dir'].'/error.php';\n}\n\n// load 2FA Google\nif (isset($SETTINGS['google_authentication']) === true && $SETTINGS['google_authentication'] === \"1\") {\n    include_once($SETTINGS['cpassman_dir'].\"/includes/libraries/Authentication/TwoFactorAuth/TwoFactorAuth.php\");\n}\n\n// Load links, css and javascripts\nif (isset($_SESSION['CPM']) === true && isset($SETTINGS['cpassman_dir']) === true) {\n    require_once $SETTINGS['cpassman_dir'].'/load.php';\n}\n\n?>\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html;charset=utf-8\" />\n<title>Teampass</title>\n<script type=\"text/javascript\">\n    //<![CDATA[\n    if (window.location.href.indexOf(\"page=\") == -1 && (window.location.href.indexOf(\"otv=\") == -1 && window.location.href.indexOf(\"action=\") == -1)) {\n        if (window.location.href.indexOf(\"session_over=true\") == -1) {\n            //location.replace(\"./index.php?page=items\");\n        } else {\n            location.replace(\"./logout.php\");\n        }\n    }\n    //]]>\n</script>\n<?php\n\n// load HEADERS\nif (isset($_SESSION['CPM'])) {\n    echo $htmlHeaders;\n}\n?>\n    </head>\n\n<body>\n    <?php\n\n/* HEADER */\n    echo '\n    <div id=\"top\">\n        <div id=\"logo\"><img src=\"includes/images/canevas/logo.png\" alt=\"\" /></div>';\n    // Display menu\n    if (empty($session_login) === false) {\n        // welcome message\n        echo '\n        <div style=\"float:right; margin:-10px 5px 0 0; color:#FFF;\">'\n            .$LANG['index_welcome'].'&nbsp;<b>'.$session_name.'&nbsp;'.$session_lastname\n            .'&nbsp;['.$session_login.']</b>&nbsp;-&nbsp;'\n            , $session_user_admin === '1' ? $LANG['god'] :\n                ($session_user_manager === '1' ? $LANG['gestionnaire'] :\n                    ($session_user_read_only === '1' ? $LANG['read_only_account'] : $LANG['user'])\n                ), '&nbsp;'.strtolower($LANG['index_login']).'</div>';\n\n        echo '\n        <div id=\"menu_top\">\n            <div style=\"margin-left:20px; margin-top:2px;width:710px;\" id=\"main_menu\">';\n        if ($session_user_admin === '0' || $SETTINGS_EXT['admin_full_right'] == 0) {\n            echo '\n                <a class=\"btn btn-default\" href=\"#\"',\n                ($session_nb_folders !== null && intval($session_nb_folders) === 0)\n                || ($session_nb_roles !== null && intval($session_nb_roles) === 0) ? '' : ' onclick=\"MenuAction(\\'items\\')\"',\n                '>\n                    <i class=\"fa fa-key fa-2x tip\" title=\"'.$LANG['pw'].'\"></i>\n                </a>\n\n                <a class=\"btn btn-default\" href=\"#\"',\n                ($session_nb_folders !== null && intval($session_nb_folders) === 0)\n                || ($session_nb_roles !== null && intval($session_nb_roles) === 0) ? '' : ' onclick=\"MenuAction(\\'find\\')\"',\n                '>\n                    <i class=\"fa fa-binoculars fa-2x tip\" title=\"'.$LANG['find'].'\"></i>\n                </a>';\n        }\n\n        // Favourites menu\n        if (isset($SETTINGS['enable_favourites'])\n            && $SETTINGS['enable_favourites'] == 1\n            &&\n            ($session_user_admin === '0' || ($session_user_admin === '1' && $SETTINGS_EXT['admin_full_right'] === false))\n        ) {\n            echo '\n                    <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'favourites\\')\">\n                        <i class=\"fa fa-star fa-2x tip\" title=\"'.$LANG['my_favourites'].'\"></i>\n                    </a>';\n        }\n        // KB menu\n        if (isset($SETTINGS['enable_kb']) && $SETTINGS['enable_kb'] == 1) {\n            echo '\n                    <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'kb\\')\">\n                        <i class=\"fa fa-map-signs fa-2x tip\" title=\"'.$LANG['kb_menu'].'\"></i>\n                    </a>';\n        }\n        echo '\n        <span id=\"menu_suggestion_position\">';\n        // SUGGESTION menu\n        if (isset($SETTINGS['enable_suggestion']) && $SETTINGS['enable_suggestion'] === '1'\n            && ($session_user_read_only === '1' || $session_user_admin === '1' || $session_user_manager === '1')\n        ) {\n            echo '\n                <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'suggestion\\')\">\n                    <i class=\"fa fa-lightbulb-o fa-2x tip\" id=\"menu_icon_suggestions\" title=\"'.$LANG['suggestion_menu'].'\"></i>\n                </a>';\n        }\n        echo '\n        </span>';\n        // Admin menu\n        if ($session_user_admin === '1') {\n            echo '\n                    &nbsp;\n                    <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'manage_main\\')\">\n                        <i class=\"fa fa-info fa-2x tip\" title=\"'.$LANG['admin_main'].'\"></i>\n                    </a>\n                    <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'manage_settings\\')\">\n                        <i class=\"fa fa-wrench fa-2x tip\" title=\"'.$LANG['admin_settings'].'\"></i>\n                    </a>';\n        }\n\n        if ($session_user_admin === '1' || $session_user_manager === '1') {\n            echo '\n                &nbsp;\n                <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'manage_folders\\')\">\n                    <i class=\"fa fa-folder-open fa-2x tip\" title=\"'.$LANG['admin_groups'].'\"></i>\n                </a>\n                <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'manage_roles\\')\">\n                    <i class=\"fa fa-graduation-cap fa-2x tip\" title=\"'.$LANG['admin_functions'].'\"></i>\n                </a>\n                <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'manage_users\\')\">\n                    <i class=\"fa fa-users fa-2x tip\" title=\"'.$LANG['admin_users'].'\"></i>\n                </a>\n                <a class=\"btn btn-default\" href=\"#\" onclick=\"MenuAction(\\'manage_views\\')\">\n                    <i class=\"fa fa-cubes fa-2x tip\" title=\"'.$LANG['admin_views'].'\"></i>\n                </a>';\n        }\n\n        echo '\n                <div style=\"float:right;\">\n                    <ul class=\"menu\" style=\"\">\n                        <li class=\"\" style=\"padding:4px;width:40px; text-align:center;\"><i class=\"fa fa-dashboard fa-fw\"></i>&nbsp;\n                            <ul class=\"menu_200\" style=\"text-align:left;\">',\n                                ($session_user_admin === '1' && $SETTINGS_EXT['admin_full_right'] === true) ? '' : isset($SETTINGS['enable_pf_feature']) === true && $SETTINGS['enable_pf_feature'] == 1 ? '\n                                <li onclick=\"$(\\'#div_set_personal_saltkey\\').dialog(\\'open\\')\">\n                                    <i class=\"fa fa-key fa-fw\"></i> &nbsp;'.$LANG['home_personal_saltkey_button'].'\n                                </li>' : '', '\n                                <li onclick=\"$(\\'#div_increase_session_time\\').dialog(\\'open\\')\">\n                                    <i class=\"fa fa-clock-o fa-fw\"></i> &nbsp;'.$LANG['index_add_one_hour'].'\n                                </li>\n                                <li onclick=\"loadProfileDialog()\">\n                                    <i class=\"fa fa-user fa-fw\"></i> &nbsp;'.$LANG['my_profile'].'\n                                </li>\n                                <li onclick=\"MenuAction(\\'deconnexion\\', \\''.$session_user_id.'\\')\">\n                                    <i class=\"fa fa-sign-out fa-fw\"></i> &nbsp;'.$LANG['disconnect'].'\n                                </li>\n                            </ul>\n                        </li>\n                    </ul>\n                </div>';\n\n        if ($session_user_admin !== '1' || ($session_user_admin === '1' && $SETTINGS_EXT['admin_full_right'] === false)) {\n            echo '\n                <div style=\"float:right; margin-right:10px;\">\n                    <ul class=\"menu\" id=\"menu_last_seen_items\">\n                        <li class=\"\" style=\"padding:4px;width:40px; text-align:center;\"><i class=\"fa fa-map fa-fw\"></i>&nbsp;&nbsp;\n                            <ul class=\"menu_200\" id=\"last_seen_items_list\" style=\"text-align:left;\">\n                                <li>'.$LANG['please_wait'].'</li>\n                            </ul>\n                        </li>\n                    </ul>\n                </div>';\n        }\n\n        // show avatar\n        if ($session_user_avatar_thumb !== null && empty($session_user_avatar_thumb) === false) {\n            if (file_exists('includes/avatars/'.$session_user_avatar_thumb)) {\n                $avatar = $SETTINGS['cpassman_url'].'/includes/avatars/'.$session_user_avatar_thumb;\n            } else {\n                $avatar = $SETTINGS['cpassman_url'].'/includes/images/photo.jpg';\n            }\n        } else {\n            $avatar = $SETTINGS['cpassman_url'].'/includes/images/photo.jpg';\n        }\n        echo '\n                <div style=\"float:right; margin-right:10px;\">\n                    <img src=\"'.$avatar.'\" style=\"border-radius:10px; height:28px; cursor:pointer;\" onclick=\"loadProfileDialog()\" alt=\"photo\" id=\"user_avatar_thumb\" />\n                </div>';\n\n        echo '\n            </div>';\n\n        echo '\n        </div>';\n    }\n\n    echo '\n    </div>';\n\n    echo '\n<div id=\"main_info_box\" style=\"display:none; z-index:99999; position:absolute; width:400px; height:40px;\" class=\"ui-widget ui-state-active ui-color\">\n    <div id=\"main_info_box_text\" style=\"text-align:center;margin-top:10px;\"></div>\n</div>';\n\n/* MAIN PAGE */\n    echo '\n        <input type=\"hidden\" id=\"temps_restant\" value=\"', isset($_SESSION['fin_session']) ? $_SESSION['fin_session'] : '', '\" />\n        <input type=\"hidden\" name=\"language\" id=\"language\" value=\"\" />\n        <input type=\"hidden\" name=\"user_pw_complexity\" id=\"user_pw_complexity\" value=\"', isset($_SESSION['user_pw_complexity']) ? $_SESSION['user_pw_complexity'] : '', '\" />\n        <input type=\"hidden\" name=\"user_session\" id=\"user_session\" value=\"\"/>\n        <input type=\"hidden\" name=\"encryptClientServer\" id=\"encryptClientServer\" value=\"', isset($SETTINGS['encryptClientServer']) ? $SETTINGS['encryptClientServer'] : '1', '\" />\n        <input type=\"hidden\" name=\"please_login\" id=\"please_login\" value=\"\" />\n        <input type=\"hidden\" name=\"disabled_action_on_going\" id=\"disabled_action_on_going\" value=\"\" />\n        <input type=\"hidden\" id=\"duo_sig_response\" value=\"', null !== $post_sig_response ? intval($post_sig_response) : '', '\" />';\n\n// SENDING STATISTICS?\n    if (isset($SETTINGS['send_stats']) && $SETTINGS['send_stats'] === \"1\"\n        && (!isset($_SESSION['temporary']['send_stats_done']) || $_SESSION['temporary']['send_stats_done'] !== \"1\")\n    ) {\n        echo '\n            <input type=\"hidden\" name=\"send_statistics\" id=\"send_statistics\" value=\"1\" />';\n    } else {\n        echo '\n        <input type=\"hidden\" name=\"send_statistics\" id=\"send_statistics\" value=\"0\" />';\n    }\n\n    echo '\n    <div id=\"', (isset($_GET['page']) && filter_var($_GET['page'], FILTER_SANITIZE_STRING) === \"items\" && $session_user_id !== null) ? \"main_simple\" : \"main\", '\">';\n// MESSAGE BOX\n    echo '\n            <div style=\"\" class=\"div_center\">\n                <div id=\"message_box\" style=\"display:none;width:200px;padding:5px;text-align:center; z-index:999999;\" class=\"ui-widget-content ui-state-error ui-corner-all\"></div>\n            </div>';\n    // Main page\n    if ($session_autoriser !== null && $session_autoriser === true) {\n        // Show menu\n        echo '\n            <form method=\"post\" name=\"main_form\" action=\"\">\n                <input type=\"hidden\" name=\"menu_action\" id=\"menu_action\" value=\"\" />\n                <input type=\"hidden\" name=\"changer_pw\" id=\"changer_pw\" value=\"\" />\n                <input type=\"hidden\" name=\"form_user_id\" id=\"form_user_id\" value=\"', $session_user_id !== null ? $session_user_id : '', '\" />\n                <input type=\"hidden\" name=\"is_admin\" id=\"is_admin\" value=\"', $session_is_admin !== null ? $session_is_admin : '', '\" />\n                <input type=\"hidden\" name=\"personal_saltkey_set\" id=\"personal_saltkey_set\" value=\"', isset($_SESSION['user_settings']['clear_psk']) ? true : false, '\" />\n            </form>';\n    }\n// ---------\n// Display a help to admin\n    $errorAdmin = \"\";\n\n// error nb folders\n    if ($session_nb_folders !== null && intval($session_nb_folders) === 0) {\n        $errorAdmin = '<span class=\"ui-icon ui-icon-lightbulb\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>'.$LANG['error_no_folders'].'<br />';\n    }\n// error nb roles\n    if ($session_nb_roles !== null && intval($session_nb_roles) === 0) {\n        if (empty($errorAdmin)) {\n            $errorAdmin = '<span class=\"ui-icon ui-icon-lightbulb\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>'.$LANG['error_no_roles'];\n        } else {\n            $errorAdmin .= '<br /><span class=\"ui-icon ui-icon-lightbulb\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>'.$LANG['error_no_roles'];\n        }\n    }\n\n    if ($session_validite_pw !== null && empty($session_validite_pw) === false) {\n        // error cpassman dir\n        if (isset($SETTINGS['cpassman_dir']) && empty($SETTINGS['cpassman_dir']) || !isset($SETTINGS['cpassman_dir'])) {\n            if (empty($errorAdmin)) {\n                $errorAdmin = '<span class=\"ui-icon ui-icon-lightbulb\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>'.$LANG['error_cpassman_dir'];\n            } else {\n                $errorAdmin .= '<br /><span class=\"ui-icon ui-icon-lightbulb\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>'.$LANG['error_cpassman_dir'];\n            }\n        }\n        // error cpassman url\n        if ($session_validite_pw !== null && (isset($SETTINGS['cpassman_url']) && empty($SETTINGS['cpassman_url']) || !isset($SETTINGS['cpassman_url']))) {\n            if (empty($errorAdmin)) {\n                $errorAdmin = '<span class=\"ui-icon ui-icon-lightbulb\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>'.$LANG['error_cpassman_url'];\n            } else {\n                $errorAdmin .= '<br /><span class=\"ui-icon ui-icon-lightbulb\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>'.$LANG['error_cpassman_url'];\n            }\n        }\n    }\n// Display help\n    if (!empty($errorAdmin)) {\n        echo '\n                <div style=\"margin:10px;padding:10px;\" class=\"ui-state-error ui-corner-all\">\n                '.$errorAdmin.'\n                </div>';\n    }\n// -----------\n// Display Maintenance mode information\n    if (isset($SETTINGS['maintenance_mode']) === true && $SETTINGS['maintenance_mode'] === '1'\n            && $session_user_admin !== null && $session_user_admin === '1'\n        ) {\n        echo '\n            <div style=\"text-align:center;margin-bottom:5px;padding:10px;\" class=\"ui-state-highlight ui-corner-all\">\n                <b>'.$LANG['index_maintenance_mode_admin'].'</b>\n            </div>';\n    }\n// Display UPDATE NEEDED information\n    if (isset($SETTINGS['update_needed']) && $SETTINGS['update_needed'] === true\n            && $session_user_admin !== null && $session_user_admin === '1'\n            && (($session_hide_maintenance !== null && $session_hide_maintenance === '0')\n            || $session_hide_maintenance === null)\n        ) {\n        echo '\n            <div style=\"text-align:center;margin-bottom:5px;padding:10px;\"\n                class=\"ui-state-highlight ui-corner-all\" id=\"div_maintenance\">\n                <b>'.$LANG['update_needed_mode_admin'].'</b>\n                <span style=\"float:right;cursor:pointer;\">\n                    <span class=\"fa fa-close mi-red\" onclick=\"toggleDiv(\\'div_maintenance\\')\"></span>\n                </span>\n            </div>';\n    }\n\n// display an item in the context of OTV link\n    if (($session_validite_pw === null || empty($session_validite_pw) === true || empty($session_user_id) === true) &&\n        isset($_GET['otv']) && filter_var($_GET['otv'], FILTER_SANITIZE_STRING) === 'true'\n    ) {\n        // case where one-shot viewer\n        if (isset($_GET['code']) && !empty($_GET['code'])\n            && isset($_GET['stamp']) && !empty($_GET['stamp'])\n        ) {\n            include 'otv.php';\n        } else {\n            $_SESSION['error']['code'] = ERR_VALID_SESSION;\n            $superGlobal->put(\n                \"initial_url\",\n                filter_var(\n                    substr($server_request_uri, strpos($server_request_uri, \"index.php?\")),\n                    FILTER_SANITIZE_URL\n                ),\n                \"SESSION\"\n            );\n            include $SETTINGS['cpassman_dir'].'/error.php';\n        }\n    // Ask the user to change his password\n    } elseif (($session_validite_pw === null || $session_validite_pw === false)\n        && empty($session_user_id) === false\n    ) {\n        //Check if password is valid\n        echo '\n        <div style=\"margin:auto; padding:20px; width:500px;\" class=\"ui-state-focus ui-corner-all\">\n            <h3>'.$LANG['index_change_pw'].'</h3>\n            <div style=\"height:20px;text-align:center;margin:2px;display:none;\" id=\"change_pwd_error\" class=\"\"></div>\n            <div style=\"text-align:center;margin:5px;padding:3px;\" id=\"change_pwd_complexPw\" class=\"ui-widget ui-state-active ui-corner-all\">'.\n            $LANG['complex_asked'].' : '.$SETTINGS_EXT['pwComplexity'][$_SESSION['user_pw_complexity']][1].\n            '</div>\n            <div id=\"pw_strength\" style=\"margin:0 0 10px 140px;\"></div>\n            <table>\n                <tr>\n                    <td>'.$LANG['index_new_pw'].' :</td><td><input type=\"password\" size=\"15\" name=\"new_pw\" id=\"new_pw\"/></td>\n                </tr>\n                <tr><td>'.$LANG['index_change_pw_confirmation'].' :</td><td><input type=\"password\" size=\"15\" name=\"new_pw2\" id=\"new_pw2\" onkeypress=\"if (event.keyCode == 13) ChangeMyPass();\" /></td></tr>\n            </table>\n            <input type=\"hidden\" id=\"pw_strength_value\" />\n            <div style=\"width:420px; text-align:center; margin:15px 0 10px 0;\">\n                <input type=\"button\" onClick=\"ChangeMyPass()\" onkeypress=\"if (event.keyCode == 13) ChangeMyPass();\" class=\"ui-state-default ui-corner-all\" style=\"padding:4px;width:150px;margin:10px 0 0 80px;\" value=\"'.$LANG['index_change_pw_button'].'\" />\n            </div>\n        </div>\n        <script type=\"text/javascript\">\n            $(\"#new_pw\").focus();\n        </script>';\n    // Display pages\n    } elseif ($session_validite_pw !== null\n        && $session_validite_pw === true\n        && empty($_GET['page']) === false\n        && empty($session_user_id) === false\n    ) {\n        if (!extension_loaded('mcrypt')) {\n            $_SESSION['error']['code'] = ERR_NO_MCRYPT;\n            include $SETTINGS['cpassman_dir'].'/error.php';\n        } elseif ($session_initial_url !== null && empty($session_initial_url) === false) {\n            include $session_initial_url;\n        } elseif ($_GET['page'] == \"items\") {\n            // SHow page with Items\n            if (($session_user_admin !== '1')\n                ||\n                ($session_user_admin === '1' && $SETTINGS_EXT['admin_full_right'] === false)\n            ) {\n                include 'items.php';\n            } else {\n                $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n                include $SETTINGS['cpassman_dir'].'/error.php';\n            }\n        } elseif ($_GET['page'] == \"find\") {\n            // Show page for items findind\n            include 'find.php';\n        } elseif ($_GET['page'] == \"favourites\") {\n            // Show page for user favourites\n            include 'favorites.php';\n        } elseif ($_GET['page'] == \"kb\") {\n            // Show page KB\n            if (isset($SETTINGS['enable_kb']) && $SETTINGS['enable_kb'] == 1) {\n                include 'kb.php';\n            } else {\n                $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n                include $SETTINGS['cpassman_dir'].'/error.php';\n            }\n        } elseif ($_GET['page'] == \"suggestion\") {\n            // Show page KB\n            if (isset($SETTINGS['enable_suggestion']) && $SETTINGS['enable_suggestion'] == 1) {\n                include 'suggestion.php';\n            } else {\n                $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n                include $SETTINGS['cpassman_dir'].'/error.php';\n            }\n        } elseif (in_array($_GET['page'], array_keys($mngPages))) {\n            // Define if user is allowed to see management pages\n            if ($session_user_admin === '1') {\n                include($mngPages[$_GET['page']]);\n            } elseif ($session_user_manager === '1') {\n                if (($_GET['page'] != \"manage_main\" && $_GET['page'] != \"manage_settings\")) {\n                    include($mngPages[$_GET['page']]);\n                } else {\n                    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n                    include $SETTINGS['cpassman_dir'].'/error.php';\n                }\n            } else {\n                $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n                include $SETTINGS['cpassman_dir'].'/error.php';\n            }\n        } else {\n            $_SESSION['error']['code'] = ERR_NOT_EXIST; //page doesn't exist\n            include $SETTINGS['cpassman_dir'].'/error.php';\n        }\n    // Case of password recovery\n    } elseif (isset($_GET['action']) && $_GET['action'] === \"password_recovery\") {\n        // Case where user has asked new PW\n        echo '\n            <div style=\"width:400px;margin:50px auto 50px auto;padding:25px;\" class=\"ui-state-highlight ui-corner-all\">\n                <div style=\"text-align:center;font-weight:bold;margin-bottom:20px;\">\n                    '.$LANG['pw_recovery_asked'].'\n                </div>\n                <div id=\"generate_new_pw_error\" style=\"color:red;display:none;text-align:center;margin:5px;\"></div>\n                <div style=\"margin-bottom:3px;\">\n                    '.$LANG['pw_recovery_info'].'\n                </div>\n                <div style=\"margin:15px; text-align:center;\">\n                    <input type=\"button\" id=\"but_generate_new_password\" onclick=\"GenerateNewPassword(\\''.htmlspecialchars($_GET['key'], ENT_QUOTES).'\\',\\''.htmlspecialchars($_GET['login'], ENT_QUOTES).'\\')\" style=\"padding:3px;cursor:pointer;\" class=\"ui-state-default ui-corner-all\" value=\"'.$LANG['pw_recovery_button'].'\" />\n                    <br /><br />\n                    <div id=\"ajax_loader_send_mail\" style=\"display:none; margin: 20px;\"><span class=\"fa fa-cog fa-spin fa-2x\"></span></div>\n                </div>\n                <div style=\"margin-top:30px; text-align:center;\">\n                    <a href=\"index.php\" class=\"tip\" title=\"'.$LANG['home'].'\"><span class=\"fa fa-home fa-lg\"></span></a>\n                </div>\n            </div>';\n    } elseif (empty($session_user_id) === false && $session_user_id !== null) {\n        // Page doesn't exist\n        $_SESSION['error']['code'] = ERR_NOT_EXIST;\n        include $SETTINGS['cpassman_dir'].'/error.php';\n        // When user is not identified\n    } else {\n        // Automatic redirection\n        if (strpos($server_request_uri, \"?\") > 0) {\n            $nextUrl = filter_var(substr($server_request_uri, strpos($server_request_uri, \"?\")), FILTER_SANITIZE_URL);\n        } else {\n            $nextUrl = \"\";\n        }\n        // MAINTENANCE MODE\n        if (isset($SETTINGS['maintenance_mode']) === true && $SETTINGS['maintenance_mode'] === '1') {\n            echo '\n                <div style=\"text-align:center;margin-top:30px;margin-bottom:20px;padding:10px;\"\n                    class=\"ui-state-error ui-corner-all\">\n                    <b>'.addslashes($LANG['index_maintenance_mode']).'</b>\n                </div>';\n        } elseif (isset($_GET['session_over']) && $_GET['session_over'] === 'true') {\n            // SESSION FINISHED => RECONNECTION ASKED\n            echo '\n                    <div style=\"text-align:center;margin-top:30px;margin-bottom:20px;padding:10px;\"\n                        class=\"ui-state-error ui-corner-all\">\n                        <b>'.addslashes($LANG['index_session_expired']).'</b>\n                    </div>';\n        }\n\n        // case where user not logged and can't access a direct link\n        if (empty($_GET['page']) === false) {\n            $superGlobal->put(\n                \"initial_url\",\n                filter_var(\n                    substr($server_request_uri, strpos($server_request_uri, \"index.php?\")),\n                    FILTER_SANITIZE_URL\n                ),\n                \"SESSION\"\n            );\n            // REDIRECTION PAGE ERREUR\n            echo '\n            <script language=\"javascript\" type=\"text/javascript\">\n            <!--\n                sessionStorage.clear();\n                window.location.href = \"index.php\";\n            -->\n            </script>';\n            exit;\n        } else {\n            $superGlobal->put(\"initial_url\", '', \"SESSION\");\n        }\n\n        // CONNECTION FORM\n        echo '\n                <form method=\"post\" name=\"form_identify\" id=\"form_identify\" action=\"\">\n                    <div style=\"width:480px;margin:10px auto 10px auto;padding:25px;\" class=\"ui-state-highlight ui-corner-all\">\n                        <div style=\"text-align:center;font-weight:bold;margin-bottom:20px;\">',\n        isset($SETTINGS['custom_logo']) && !empty($SETTINGS['custom_logo']) ? '<img src=\"'.(string) $SETTINGS['custom_logo'].'\" alt=\"\" style=\"margin-bottom:40px;\" />' : '', '<br />\n                            '.$LANG['index_get_identified'].'\n                            <span id=\"ajax_loader_connexion\" style=\"display:none;margin-left:10px;\"><span class=\"fa fa-cog fa-spin fa-1x\"></span></span>\n                        </div>\n                        <div id=\"connection_error\" style=\"display:none;text-align:center;margin:5px; padding:3px;\" class=\"ui-state-error ui-corner-all\">&nbsp;<i class=\"fa fa-warning\"></i>&nbsp;'.$LANG['index_bas_pw'].'</div>';\n        echo '\n                        <div style=\"margin-bottom:3px;\">\n                            <label for=\"login\" class=\"form_label\">', isset($SETTINGS['custom_login_text']) && !empty($SETTINGS['custom_login_text']) ? (string) $SETTINGS['custom_login_text'] : $LANG['index_login'], '</label>\n                            <input type=\"text\" size=\"10\" id=\"login\" name=\"login\" class=\"input_text text ui-widget-content ui-corner-all\" />\n                            <span id=\"login_check_wait\" style=\"display:none; float:right;\"><i class=\"fa fa-cog fa-spin fa-1x\"></i></span>\n                        </div>';\n\n        // AGSES\n        if (isset($SETTINGS['agses_authentication_enabled']) && $SETTINGS['agses_authentication_enabled'] == 1) {\n            echo '\n                        <div id=\"agses_cardid_div\" style=\"text-align:center; display:none; padding:5px; width:454px; margin-bottom:5px;\" class=\"ui-state-active ui-corner-all\">\n                            '.$LANG['user_profile_agses_card_id'].': &nbsp;\n                            <input type=\"text\" size=\"12\" id=\"agses_cardid\">\n                        </div>\n                        <div id=\"agses_flickercode_div\" style=\"text-align:center; display:none;\">\n                            <canvas id=\"axs_canvas\"></canvas>\n                        </div>';\n        }\n\n                        echo '\n                        <div id=\"connect_pw\" style=\"margin-bottom:3px;\">\n                            <label for=\"pw\" class=\"form_label\" id=\"user_pwd\">'.$LANG['index_password'].'</label>\n                            <input type=\"password\" size=\"10\" id=\"pw\" name=\"pw\" onkeypress=\"if (event.keyCode == 13) launchIdentify(\\'', isset($SETTINGS['duo']) && $SETTINGS['duo'] === \"1\" ? 1 : '', '\\', \\''.$nextUrl.'\\', \\'', isset($SETTINGS['google_authentication']) && $SETTINGS['google_authentication'] === \"1\" ? 1 : '', '\\')\" class=\"input_text text ui-widget-content ui-corner-all\" />\n                        </div>';\n\n        // Personal salt key\n        if (isset($SETTINGS['psk_authentication']) && $SETTINGS['psk_authentication'] === \"1\") {\n            echo '\n                        <div id=\"connect_psk\" style=\"margin-bottom:3px;\">\n                            <label for=\"personal_psk\" class=\"form_label\">'.$LANG['home_personal_saltkey'].'</label>\n                            <input type=\"password\" size=\"10\" id=\"psk\" name=\"psk\" onkeypress=\"if (event.keyCode == 13) launchIdentify(\\'', isset($SETTINGS['duo']) && $SETTINGS['duo'] === \"1\" ? 1 : '', '\\', \\''.$nextUrl.'\\', \\'', isset($SETTINGS['psk_authentication']) && $SETTINGS['psk_authentication'] === \"1\" ? 1 : '', '\\')\" class=\"input_text text ui-widget-content ui-corner-all\" />\n                        </div>\n                        <div id=\"connect_psk_confirm\" style=\"margin-bottom:3px; display:none;\">\n                            <label for=\"psk_confirm\" class=\"form_label\">'.$LANG['home_personal_saltkey_confirm'].'</label>\n                            <input type=\"password\" size=\"10\" id=\"psk_confirm\" name=\"psk_confirm\" onkeypress=\"if (event.keyCode == 13) launchIdentify(\\'', isset($SETTINGS['duo']) && $SETTINGS['duo'] === \"1\" ? 1 : '', '\\', \\''.$nextUrl.'\\', \\'', isset($SETTINGS['psk_authentication']) && $SETTINGS['psk_authentication'] === \"1\" ? 1 : '', '\\')\" class=\"input_text text ui-widget-content ui-corner-all\" />\n                        </div>';\n        }\n\n        // Google Authenticator code\n        if (isset($SETTINGS['google_authentication']) && $SETTINGS['google_authentication'] === \"1\") {\n            echo '\n                        <div id=\"ga_code_div\" style=\"margin-bottom:10px;\">\n                            '.$LANG['ga_identification_code'].'\n                            <input type=\"text\" size=\"4\" id=\"ga_code\" name=\"ga_code\" style=\"margin:0px;\" class=\"input_text text ui-widget-content ui-corner-all numeric_only\" onkeypress=\"if (event.keyCode == 13) launchIdentify(\\'', isset($SETTINGS['duo']) && $SETTINGS['duo'] === \"1\" ? 1 : '', '\\', \\''.$nextUrl.'\\')\" />\n                        <div id=\"2fa_new_code_div\" style=\"text-align:center; display:none; margin-top:5px; padding:5px;\" class=\"ui-state-default ui-corner-all\"></div>\n                        <div style=\"margin-top:2px; font-size:10px; text-align:center; cursor:pointer;\" onclick=\"send_user_new_temporary_ga_code()\">'.$LANG['i_need_to_generate_new_ga_code'].'</div>\n                        </div>';\n        }\n        echo '\n                        <div style=\"margin-bottom:3px;\">\n                            <label for=\"duree_session\" class=\"\">'.$LANG['index_session_duration'].'&nbsp;('.$LANG['minutes'].') </label>\n                            <input type=\"text\" size=\"4\" id=\"duree_session\" name=\"duree_session\" value=\"', isset($SETTINGS['default_session_expiration_time']) ? $SETTINGS['default_session_expiration_time'] : \"60\", '\" onkeypress=\"if (event.keyCode == 13) launchIdentify(\\'', isset($SETTINGS['duo']) && $SETTINGS['duo'] === \"1\" ? 1 : '', '\\', \\''.$nextUrl.'\\')\" class=\"input_text text ui-widget-content ui-corner-all numeric_only\" />\n                        </div>\n\n                        <div style=\"text-align:center;margin-top:5px;font-size:10pt;\">\n                            <span onclick=\"OpenDialog(\\'div_forgot_pw\\')\" style=\"padding:3px;cursor:pointer;\">'.$LANG['forgot_my_pw'].'</span>\n                        </div>\n                        <div style=\"text-align:center;margin-top:15px;\">\n                            <input type=\"button\" id=\"but_identify_user\" onclick=\"launchIdentify(\\'', isset($SETTINGS['duo']) && $SETTINGS['duo'] === \"1\" ? 1 : '', '\\', \\''.$nextUrl.'\\', \\'', isset($SETTINGS['psk_authentication']) && $SETTINGS['psk_authentication'] === \"1\" ? 1 : '', '\\')\" style=\"padding:3px;cursor:pointer;\" class=\"ui-state-default ui-corner-all\" value=\"'.$LANG['index_identify_button'].'\" />\n                        </div>\n                    </div>\n                </form>\n                <script type=\"text/javascript\">\n                    $(\"#login\").focus();\n                </script>';\n        // DIV for forgotten password\n        echo '\n                <div id=\"div_forgot_pw\" style=\"display:none;\">\n                    <div style=\"margin:5px auto 5px auto;\" id=\"div_forgot_pw_alert\"></div>\n                    <div style=\"margin:5px auto 5px auto;\">'.$LANG['forgot_my_pw_text'].'</div>\n                    <label for=\"forgot_pw_email\">'.$LANG['email'].'</label>\n                    <input type=\"text\" size=\"40\" name=\"forgot_pw_email\" id=\"forgot_pw_email\" />\n                    <br />\n                    <label for=\"forgot_pw_login\">'.$LANG['login'].'</label>\n                    <input type=\"text\" size=\"20\" name=\"forgot_pw_login\" id=\"forgot_pw_login\" />\n                    <div id=\"div_forgot_pw_status\" style=\"text-align:center;margin-top:15px;display:none; padding:5px;\" class=\"ui-corner-all\">\n                        <i class=\"fa fa-cog fa-spin fa-2x\"></i>&nbsp;<b>'.$LANG['please_wait'].'</b>\n                    </div>\n                </div>';\n    }\n    echo '\n    </div>';\n// FOOTER\n/* DON'T MODIFY THE FOOTER ... MANY THANKS TO YOU */\n    echo '\n    <div id=\"footer\">\n        <div style=\"float:left;width:32%;\">\n            <a href=\"http://teampass.net\" target=\"_blank\" style=\"color:#F0F0F0;\">'.$SETTINGS_EXT['tool_name'].'&nbsp;'.$SETTINGS_EXT['version'].'&nbsp;<i class=\"fa fa-copyright\"></i>&nbsp;'.$SETTINGS_EXT['copyright'].'</a>\n            &nbsp;|&nbsp;\n            <a href=\"http://teampass.readthedocs.io/en/latest/\" target=\"_blank\" style=\"color:#F0F0F0;\" class=\"tip\" title=\"'.addslashes($LANG['documentation_canal']).' ReadTheDocs\"><i class=\"fa fa-book\"></i></a>\n            &nbsp;\n            <a href=\"https://www.reddit.com/r/TeamPass/\" target=\"_blank\" style=\"color:#F0F0F0;\" class=\"tip\" title=\"'.addslashes($LANG['admin_help']).'\"><i class=\"fa fa-reddit-alien\"></i></a>\n        </div>\n        <div style=\"float:left;width:32%;text-align:center;\">\n            ', ($session_user_id !== null && empty($session_user_id) === false) ? '<i class=\"fa fa-users\"></i>&nbsp;'.$session_nb_users_online.'&nbsp;'.$LANG['users_online'].'&nbsp;|&nbsp;<i class=\"fa fa-hourglass-end\"></i>&nbsp;'.$LANG['index_expiration_in'].'&nbsp;<div style=\"display:inline;\" id=\"countdown\"></div>' : '', '\n        </div><div id=\"countdown2\"></div>\n        <div style=\"float:right;text-align:right;\">\n            <i class=\"fa fa-clock-o\"></i>&nbsp;'. $LANG['server_time'].\" : \".@date($SETTINGS['date_format'], (string) $_SERVER['REQUEST_TIME']).\" - \".@date($SETTINGS['time_format'], (string) $_SERVER['REQUEST_TIME']).'\n        </div>\n    </div>';\n// PAGE LOADING\n    echo '\n    <div id=\"div_loading\" class=\"hidden\">\n        <div style=\"padding:5px; z-index:9999999;\" class=\"ui-widget-content ui-state-focus ui-corner-all\">\n            <i class=\"fa fa-cog fa-spin fa-2x\"></i>\n        </div>\n    </div>';\n// Alert BOX\n    echo '\n    <div id=\"div_dialog_message\" style=\"display:none;\">\n        <div id=\"div_dialog_message_text\" style=\"text-align:center; padding:4px; font-size:12px; margin-top:10px;\"></div>\n    </div>';\n\n// WARNING FOR QUERY ERROR\n    echo '\n    <div id=\"div_mysql_error\" style=\"display:none;\">\n        <div style=\"padding:10px;text-align:center;\" id=\"mysql_error_warning\"></div>\n    </div>';\n\n\n//Personnal SALTKEY\n    if (isset($SETTINGS['enable_pf_feature']) && $SETTINGS['enable_pf_feature'] === \"1\") {\n        echo '\n        <div id=\"div_set_personal_saltkey\" style=\"display:none;padding:4px;\">\n            <i class=\"fa fa-key\"></i> <b>'.$LANG['home_personal_saltkey'].'</b>\n            <input type=\"password\" name=\"input_personal_saltkey\" id=\"input_personal_saltkey\" style=\"width:200px;padding:5px;margin-left:30px;\" class=\"text ui-widget-content ui-corner-all text_without_symbols tip\" value=\"', isset($_SESSION['user_settings']['clear_psk']) ? (string) $_SESSION['user_settings']['clear_psk'] : '', '\" title=\"<i class=\\'fa fa-bullhorn\\'></i>&nbsp;'.$LANG['text_without_symbols'].'\" />\n            <span id=\"set_personal_saltkey_last_letter\" style=\"font-weight:bold;font-size:20px;\"></span>\n            <div style=\"display:none;margin-top:5px;text-align:center;padding:4px;\" id=\"set_personal_saltkey_warning\" class=\"ui-widget-content ui-state-error ui-corner-all\"></div>\n        </div>';\n    }\n\n// user profile\n    echo '\n<div id=\"dialog_user_profil\" style=\"display:none;padding:4px;\">\n    <div id=\"div_user_profil\">\n        <i class=\"fa fa-cog fa-spin fa-2x\"></i>&nbsp;<b>'.$LANG['please_wait'].'</b>\n    </div>\n</div>';\n\n// DUO box\n    echo '\n<div id=\"dialog_duo\" style=\"display:none;padding:4px;\">\n    <div id=\"div_duo\"></div>\n    '.$LANG['duo_loading_iframe'].'\n    <form method=\"post\" id=\"duo_form\" action=\"#\">\n        <input type=\"hidden\" id=\"duo_login\" name=\"duo_login\" value=\"', null !== $post_duo_login ? $post_duo_login : '', '\" />\n        <input type=\"hidden\" id=\"duo_data\" name=\"duo_data\" value=\"', null !== $post_duo_data ? htmlentities(base64_decode($post_duo_data)) : '', '\" />\n    </form>\n</div>';\n\n// INCREASE session time\n    echo '\n<div id=\"div_increase_session_time\" style=\"display:none;padding:4px;\">\n    <b>'.$LANG['index_session_duration'].':</b>\n    <input type=\"text\" id=\"input_session_duration\" style=\"width:50px;padding:5px;margin:0 10px 0 10px;\" class=\"text ui-widget-content ui-corner-all\" value=\"', isset($_SESSION['user_settings']['session_duration']) ? (int) $_SESSION['user_settings']['session_duration'] / 60 : 60, '\" />\n    <b>'.$LANG['minutes'].'</b>\n    <div style=\"display:none;margin-top:5px;text-align:center;padding:4px;\" id=\"input_session_duration_warning\" class=\"ui-widget-content ui-state-error ui-corner-all\"></div>\n</div>';\n\n    closelog();\n\n?>\n<script type=\"text/javascript\">NProgress.start();</script>\n    </body>\n</html>", "<?php\n/**\n * @file          install.queries.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\nrequire_once('../sources/SecureHandler.php');\nsession_start();\nerror_reporting(E_ERROR | E_PARSE);\nheader(\"Content-type: text/html; charset=utf-8\");\n$session_db_encoding = \"utf8\";\n\nfunction chmodRecursive($dir, $dirPermissions, $filePermissions)\n{\n    $pointer_dir = opendir($dir);\n    $res = true;\n    while ($file = readdir($pointer_dir)) {\n        if (($file == \".\") || ($file == \"..\")) {\n            continue;\n        }\n\n        $fullPath = $dir.\"/\".$file;\n\n        if (is_dir($fullPath)) {\n            if ($res = @chmod($fullPath, $dirPermissions)) {\n                $res = @chmodRecursive($fullPath, $dirPermissions, $filePermissions);\n            }\n        } else {\n            $res = chmod($fullPath, $filePermissions);\n        }\n        if (!$res) {\n            closedir($pointer_dir);\n            return false;\n        }\n    }\n    closedir($pointer_dir);\n    if (is_dir($dir) && $res) {\n            $res = @chmod($dir, $dirPermissions);\n    }\n\n    return $res;\n}\n\n/**\n * genHash()\n *\n * Generate a hash for user login\n * @param string $password\n */\nfunction bCrypt($password, $cost)\n{\n    $salt = sprintf('$2y$%02d$', $cost);\n    if (function_exists('openssl_random_pseudo_bytes')) {\n        $salt .= bin2hex(openssl_random_pseudo_bytes(11));\n    } else {\n        $chars = './ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n        for ($i = 0; $i < 22; $i++) {\n            $salt .= $chars[mt_rand(0, 63)];\n        }\n    }\n    return crypt($password, $salt);\n}\n\n/**\n * Permits to encrypt a message using Defuse\n * @param  string $message   Message to encrypt\n * @param  string $ascii_key Key to hash\n * @return array             String + Error\n */\nfunction encryptFollowingDefuse($message, $ascii_key)\n{\n    // load PhpEncryption library\n    $path = '../includes/libraries/Encryption/Encryption/';\n    require_once $path.'Crypto.php';\n    require_once $path.'Encoding.php';\n    require_once $path.'DerivedKeys.php';\n    require_once $path.'Key.php';\n    require_once $path.'KeyOrPassword.php';\n    require_once $path.'File.php';\n    require_once $path.'RuntimeTests.php';\n    require_once $path.'KeyProtectedByPassword.php';\n    require_once $path.'Core.php';\n\n    // convert KEY\n    $key = \\Defuse\\Crypto\\Key::loadFromAsciiSafeString($ascii_key);\n\n    try {\n        $text = \\Defuse\\Crypto\\Crypto::encrypt($message, $key);\n    } catch (Defuse\\Crypto\\Exception\\WrongKeyOrModifiedCiphertextException $ex) {\n        $err = \"an attack! either the wrong key was loaded, or the ciphertext has changed since it was created either corrupted in the database or intentionally modified by someone trying to carry out an attack.\";\n    } catch (Defuse\\Crypto\\Exception\\BadFormatException $ex) {\n        $err = $ex;\n    } catch (Defuse\\Crypto\\Exception\\EnvironmentIsBrokenException $ex) {\n        $err = $ex;\n    } catch (Defuse\\Crypto\\Exception\\CryptoException $ex) {\n        $err = $ex;\n    } catch (Defuse\\Crypto\\Exception\\IOException $ex) {\n        $err = $ex;\n    }\n\n    return array(\n        'string' => isset($text) ? $text : \"\",\n        'error' => $err\n    );\n}\n\n\n// Prepare POST variables\n$post_type = filter_input(INPUT_POST, 'type', FILTER_SANITIZE_STRING);\n$post_data = filter_input(INPUT_POST, 'data', FILTER_SANITIZE_STRING);\n$post_activity = filter_input(INPUT_POST, 'activity', FILTER_SANITIZE_STRING);\n$post_task = filter_input(INPUT_POST, 'task', FILTER_SANITIZE_STRING);\n$post_index = filter_input(INPUT_POST, 'index', FILTER_SANITIZE_NUMBER_INT);\n$post_multiple = filter_input(INPUT_POST, 'multiple', FILTER_SANITIZE_STRING);\n$post_db = filter_input(INPUT_POST, 'db', FILTER_SANITIZE_STRING);\n\n// Load libraries\nrequire_once '../includes/libraries/protect/SuperGlobal/SuperGlobal.php';\n$superGlobal = new protect\\SuperGlobal\\SuperGlobal();\n\n// Prepare SESSION variables\n$session_url_path = $superGlobal->get(\"url_path\", \"SESSION\");\n$session_abspath = $superGlobal->get(\"abspath\", \"SESSION\");\n$session_db_encoding = $superGlobal->get(\"db_encoding\", \"SESSION\");\n\n$superGlobal->put(\"CPM\", 1, \"SESSION\");\n\nif (null !== $post_type) {\n    switch ($post_type) {\n        case \"step_2\":\n            //decrypt\n            require_once 'libs/aesctr.php'; // AES Counter Mode implementation\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_data, \"cpm\", 128);\n            $data = json_decode($json, true);\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_activity, \"cpm\", 128);\n            $data = array_merge($data, array(\"activity\" => $json));\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_task, \"cpm\", 128);\n            $data = array_merge($data, array(\"task\" => $json));\n\n            $abspath = str_replace('\\\\', '/', $data['root_path']);\n            if (substr($abspath, strlen($abspath) - 1) == \"/\") {\n                $abspath = substr($abspath, 0, strlen($abspath) - 1);\n            }\n            $session_abspath = $abspath;\n            $session_url_path = $data['url_path'];\n\n            if (isset($data['activity']) && $data['activity'] === \"folder\") {\n                if (is_writable($abspath.\"/\".$data['task'].\"/\") === true) {\n                    echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                } else {\n                    echo '[{\"error\" : \" Path '.$data['task'].' is not writable!\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                }\n                break;\n            }\n\n            if (isset($data['activity']) && $data['activity'] === \"extension\") {\n                if (extension_loaded($data['task'])) {\n                    echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                } else {\n                    echo '[{\"error\" : \" Extension '.$data['task'].' is not loaded!\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                }\n                break;\n            }\n\n            if (isset($data['activity']) && $data['activity'] === \"function\") {\n                if (function_exists($data['task'])) {\n                    echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                } else {\n                    echo '[{\"error\" : \" Function '.$data['task'].' is not available!\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                }\n                break;\n            }\n\n            if (isset($data['activity']) && $data['activity'] === \"version\") {\n                if (version_compare(phpversion(), '5.5.0', '>=')) {\n                    echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                } else {\n                    echo '[{\"error\" : \"PHP version '.phpversion().' is not OK (minimum is 5.5.0)\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                }\n                break;\n            }\n\n            if (isset($data['activity']) && $data['activity'] === \"ini\") {\n                if (ini_get($data['task']) >= 60) {\n                    echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\"}]';\n                } else {\n                    echo '[{\"error\" : \"PHP \\\"Maximum execution time\\\" is set to '.ini_get('max_execution_time').' seconds. Please try to set to 60s at least during installation.\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                }\n                break;\n            }\n            break;\n\n        case \"step_3\":\n            //decrypt\n            require_once 'libs/aesctr.php'; // AES Counter Mode implementation\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_data, \"cpm\", 128);\n            $data = json_decode($json, true);\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_db, \"cpm\", 128);\n            $db = json_decode($json, true);\n\n            // launch\n            if ($dbTmp = mysqli_connect($db['db_host'], $db['db_login'], $db['db_pw'], $db['db_bdd'], $db['db_port'])) {\n                // create temporary INSTALL mysqli table\n                $mysqli_result = mysqli_query(\n                    $dbTmp,\n                    \"CREATE TABLE IF NOT EXISTS `_install` (\n                    `key` varchar(100) NOT NULL,\n                    `value` varchar(500) NOT NULL\n                    ) CHARSET=utf8;\"\n                );\n                // store values\n                foreach ($data as $key => $value) {\n                    $superGlobal->put($key, $value, \"SESSION\");\n                    $tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `_install` WHERE `key` = '\".$key.\"'\"));\n                    if (intval($tmp) === 0) {\n                        mysqli_query($dbTmp, \"INSERT INTO `_install` (`key`, `value`) VALUES ('\".$key.\"', '\".$value.\"');\");\n                    } else {\n                        mysqli_query($dbTmp, \"UPDATE `_install` SET `value` = '\".$value.\"' WHERE `key` = '\".$key.\"';\");\n                    }\n                }\n                $tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `_install` WHERE `key` = 'url_path'\"));\n                if (intval($tmp) === 0) {\n                    mysqli_query($dbTmp, \"INSERT INTO `_install` (`key`, `value`) VALUES ('url_path', '\", empty($session_url_path) ? $db['url_path'] : $session_url_path, \"');\");\n                } else {\n                    mysqli_query($dbTmp, \"UPDATE `_install` SET `value` = '\", empty($session_url_path) ? $db['url_path'] : $session_url_path, \"' WHERE `key` = 'url_path';\");\n                }\n                $tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `_install` WHERE `key` = 'abspath'\"));\n                if (intval($tmp) === 0) {\n                    mysqli_query($dbTmp, \"INSERT INTO `_install` (`key`, `value`) VALUES ('abspath', '\", empty($session_abspath) ? $db['abspath'] : $session_abspath, \"');\");\n                } else {\n                    mysqli_query($dbTmp, \"UPDATE `_install` SET `value` = '\", empty($session_abspath) ? $db['abspath'] : $session_abspath, \"' WHERE `key` = 'abspath';\");\n                }\n\n                echo '[{\"error\" : \"\", \"result\" : \"Connection is successful\", \"multiple\" : \"\"}]';\n            } else {\n                echo '[{\"error\" : \"'.addslashes(str_replace(array(\"'\", \"\\n\", \"\\r\"), array('\"', '', ''), mysqli_connect_error())).'\", \"result\" : \"Failed\", \"multiple\" : \"\"}]';\n            }\n            mysqli_close($dbTmp);\n            break;\n\n        case \"step_4\":\n            //decrypt\n            require_once 'libs/aesctr.php'; // AES Counter Mode implementation\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_data, \"cpm\", 128);\n            $data = json_decode($json, true);\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_db, \"cpm\", 128);\n            $db = json_decode($json, true);\n\n            $dbTmp = mysqli_connect($db['db_host'], $db['db_login'], $db['db_pw'], $db['db_bdd'], $db['db_port']);\n\n            // prepare data\n            foreach ($data as $key => $value) {\n                $data[$key] = str_replace(array('&quot;', '&#92;'), array('\"\"', '\\\\\\\\'), $value);\n            }\n\n            // check skpath\n            if (empty($data['sk_path'])) {\n                $data['sk_path'] = $session_abspath.\"/includes\";\n            } else {\n                $data['sk_path'] = str_replace(\"&#92;\", \"/\", $data['sk_path']);\n            }\n            if (substr($data['sk_path'], strlen($data['sk_path']) - 1) == \"/\" || substr($data['sk_path'], strlen($data['sk_path']) - 1) == \"\\\"\") {\n                $data['sk_path'] = substr($data['sk_path'], 0, strlen($data['sk_path']) - 1);\n            }\n            if (is_dir($data['sk_path'])) {\n                if (is_writable($data['sk_path'])) {\n                    // store all variables in SESSION\n                    foreach ($data as $key => $value) {\n                        $superGlobal->put($key, $value, \"SESSION\");\n                        $tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `_install` WHERE `key` = '\".$key.\"'\"));\n                        if (intval($tmp) === 0) {\n                            mysqli_query($dbTmp, \"INSERT INTO `_install` (`key`, `value`) VALUES ('\".$key.\"', '\".$value.\"');\");\n                        } else {\n                            mysqli_query($dbTmp, \"UPDATE `_install` SET `value` = '\".$value.\"' WHERE `key` = '\".$key.\"';\");\n                        }\n                    }\n                    echo '[{\"error\" : \"\", \"result\" : \"Information stored\", \"multiple\" : \"\"}]';\n                } else {\n                    echo '[{\"error\" : \"The Directory must be writable!\", \"result\" : \"Information stored\", \"multiple\" : \"\"}]';\n                }\n            } else {\n                echo '[{\"error\" : \"'.$data['sk_path'].' is not a Directory!\", \"result\" : \"Information stored\", \"multiple\" : \"\"}]';\n            }\n            mysqli_close($dbTmp);\n            break;\n\n        case \"step_5\":\n            //decrypt\n            require_once 'libs/aesctr.php'; // AES Counter Mode implementation\n            $activity = Encryption\\Crypt\\aesctr::decrypt($post_activity, \"cpm\", 128);\n            $task = Encryption\\Crypt\\aesctr::decrypt($post_task, \"cpm\", 128);\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_db, \"cpm\", 128);\n            $db = json_decode($json, true);\n\n            // launch\n            $dbTmp = mysqli_connect($db['db_host'], $db['db_login'], $db['db_pw'], $db['db_bdd'], $db['db_port']);\n            $dbBdd = $db['db_bdd'];\n            if ($dbTmp) {\n                $mysqli_result = \"\";\n\n                // read install variables\n                $result = mysqli_query($dbTmp, \"SELECT * FROM `_install`\");\n                while ($row = $result->fetch_array()) {\n                    $var[$row[0]] = $row[1];\n                }\n\n                if ($activity === \"table\") {\n                    //FORCE UTF8 DATABASE\n                    mysqli_query($dbTmp, \"ALTER DATABASE `\".$dbBdd.\"` DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci\");\n                    if ($task === \"items\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"items` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `label` varchar(500) NOT NULL,\n                            `description` text DEFAULT NULL,\n                            `pw` text DEFAULT NULL,\n                            `pw_iv` text DEFAULT NULL,\n                            `pw_len` int(5) NOT NULL DEFAULT '0',\n                            `url` varchar(500) DEFAULT NULL,\n                            `id_tree` varchar(10) DEFAULT NULL,\n                            `perso` tinyint(1) NOT null DEFAULT '0',\n                            `login` varchar(200) DEFAULT NULL,\n                            `inactif` tinyint(1) NOT null DEFAULT '0',\n                            `restricted_to` varchar(200) DEFAULT NULL,\n                            `anyone_can_modify` tinyint(1) NOT null DEFAULT '0',\n                            `email` varchar(100) DEFAULT NULL,\n                            `notification` varchar(250) DEFAULT NULL,\n                            `viewed_no` int(12) NOT null DEFAULT '0',\n                            `complexity_level` varchar(3) NOT null DEFAULT '-1',\n                            `auto_update_pwd_frequency` tinyint(2) NOT null DEFAULT '0',\n                            `auto_update_pwd_next_date` varchar(100) NOT null DEFAULT '0',\n                            `encryption_type` VARCHAR(20) NOT NULL DEFAULT 'not_set',\n                            PRIMARY KEY (`id`),\n                            KEY    `restricted_inactif_idx` (`restricted_to`,`inactif`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"log_items\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"log_items` (\n                            `id_item` int(8) NOT NULL,\n                            `date` varchar(50) NOT NULL,\n                            `id_user` int(8) NOT NULL,\n                            `action` varchar(250) NULL,\n                            `raison` text NULL,\n                            `raison_iv` text NULL,\n                            `encryption_type` VARCHAR(20) NOT NULL DEFAULT 'not_set'\n                            ) CHARSET=utf8;\"\n                        );\n                        // create index\n                        mysqli_query(\n                            $dbTmp,\n                            \"CREATE INDEX teampass_log_items_id_item_IDX ON \".$var['tbl_prefix'].\"log_items (id_item,date);\"\n                        );\n                    } elseif ($task === \"misc\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"misc` (\n                            `increment_id` int(12) NOT null AUTO_INCREMENT,\n                            `type` varchar(50) NOT NULL,\n                            `intitule` varchar(100) NOT NULL,\n                            `valeur` varchar(500) NOT NULL,\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n\n                        // include constants\n                        require_once \"../includes/config/include.php\";\n\n                        // prepare config file\n                        $tp_config_file = \"../includes/config/tp.config.php\";\n                        if (file_exists($tp_config_file)) {\n                            if (!copy($tp_config_file, $tp_config_file.'.'.date(\"Y_m_d\", mktime(0, 0, 0, date('m'), date('d'), date('y'))))) {\n                                echo '[{\"error\" : \"includes/config/tp.config.php file already exists and cannot be renamed. Please do it by yourself and click on button Launch.\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                                break;\n                            } else {\n                                unlink($tp_config_file);\n                            }\n                        }\n                        $file_handler = fopen($tp_config_file, 'w');\n                        $config_text = \"<?php\nglobal \\$SETTINGS;\n\\$SETTINGS = array (\";\n\n                        // add by default settings\n                        $aMiscVal = array(\n                            array('admin', 'max_latest_items', '10'),\n                            array('admin', 'enable_favourites', '1'),\n                            array('admin', 'show_last_items', '1'),\n                            array('admin', 'enable_pf_feature', '0'),\n                            array('admin', 'log_connections', '0'),\n                            array('admin', 'log_accessed', '1'),\n                            array('admin', 'time_format', 'H:i:s'),\n                            array('admin', 'date_format', 'd/m/Y'),\n                            array('admin', 'duplicate_folder', '0'),\n                            array('admin', 'item_duplicate_in_same_folder', '0'),\n                            array('admin', 'duplicate_item', '0'),\n                            array('admin', 'number_of_used_pw', '3'),\n                            array('admin', 'manager_edit', '1'),\n                            array('admin', 'cpassman_dir', $var['abspath']),\n                            array('admin', 'cpassman_url', $var['url_path']),\n                            array('admin', 'favicon', $var['url_path'].'/favicon.ico'),\n                            array('admin', 'path_to_upload_folder', $var['abspath'].'/upload'),\n                            array('admin', 'url_to_upload_folder', $var['url_path'].'/upload'),\n                            array('admin', 'path_to_files_folder', $var['abspath'].'/files'),\n                            array('admin', 'url_to_files_folder', $var['url_path'].'/files'),\n                            array('admin', 'activate_expiration', '0'),\n                            array('admin', 'pw_life_duration', '0'),\n                            array('admin', 'maintenance_mode', '1'),\n                            array('admin', 'enable_sts', '0'),\n                            array('admin', 'encryptClientServer', '1'),\n                            array('admin', 'cpassman_version', $SETTINGS_EXT['version']),\n                            array('admin', 'ldap_mode', '0'),\n                            array('admin', 'ldap_type', '0'),\n                            array('admin', 'ldap_suffix', '0'),\n                            array('admin', 'ldap_domain_dn', '0'),\n                            array('admin', 'ldap_domain_controler', '0'),\n                            array('admin', 'ldap_user_attribute', '0'),\n                            array('admin', 'ldap_ssl', '0'),\n                            array('admin', 'ldap_tls', '0'),\n                            array('admin', 'ldap_elusers', '0'),\n                            array('admin', 'ldap_search_base', '0'),\n                            array('admin', 'richtext', '0'),\n                            array('admin', 'allow_print', '0'),\n                            array('admin', 'roles_allowed_to_print', '0'),\n                            array('admin', 'show_description', '1'),\n                            array('admin', 'anyone_can_modify', '0'),\n                            array('admin', 'anyone_can_modify_bydefault', '0'),\n                            array('admin', 'nb_bad_authentication', '0'),\n                            array('admin', 'utf8_enabled', '1'),\n                            array('admin', 'restricted_to', '0'),\n                            array('admin', 'restricted_to_roles', '0'),\n                            array('admin', 'enable_send_email_on_user_login', '0'),\n                            array('admin', 'enable_user_can_create_folders', '0'),\n                            array('admin', 'insert_manual_entry_item_history', '0'),\n                            array('admin', 'enable_kb', '0'),\n                            array('admin', 'enable_email_notification_on_item_shown', '0'),\n                            array('admin', 'enable_email_notification_on_user_pw_change', '0'),\n                            array('admin', 'custom_logo', ''),\n                            array('admin', 'custom_login_text', ''),\n                            array('admin', 'default_language', 'english'),\n                            array('admin', 'send_stats', '0'),\n                            array('admin', 'send_statistics_items', 'stat_country;stat_users;stat_items;stat_items_shared;stat_folders;stat_folders_shared;stat_admins;stat_managers;stat_ro;stat_mysqlversion;stat_phpversion;stat_teampassversion;stat_languages;stat_kb;stat_suggestion;stat_customfields;stat_api;stat_2fa;stat_agses;stat_duo;stat_ldap;stat_syslog;stat_stricthttps;stat_fav;stat_pf;'),\n                            array('admin', 'send_stats_time', time() - 2592000),\n                            array('admin', 'get_tp_info', '1'),\n                            array('admin', 'send_mail_on_user_login', '0'),\n                            array('cron', 'sending_emails', '0'),\n                            array('admin', 'nb_items_by_query', 'auto'),\n                            array('admin', 'enable_delete_after_consultation', '0'),\n                            array('admin', 'enable_personal_saltkey_cookie', '0'),\n                            array('admin', 'personal_saltkey_cookie_duration', '31'),\n                            array('admin', 'email_smtp_server', ''),\n                            array('admin', 'email_smtp_auth', ''),\n                            array('admin', 'email_auth_username', ''),\n                            array('admin', 'email_auth_pwd', ''),\n                            array('admin', 'email_port', ''),\n                            array('admin', 'email_security', ''),\n                            array('admin', 'email_server_url', ''),\n                            array('admin', 'email_from', ''),\n                            array('admin', 'email_from_name', ''),\n                            array('admin', 'pwd_maximum_length', '40'),\n                            array('admin', 'google_authentication', '0'),\n                            array('admin', 'delay_item_edition', '0'),\n                            array('admin', 'allow_import', '0'),\n                            array('admin', 'proxy_ip', ''),\n                            array('admin', 'proxy_port', ''),\n                            array('admin', 'upload_maxfilesize', '10mb'),\n                            array('admin', 'upload_docext', 'doc,docx,dotx,xls,xlsx,xltx,rtf,csv,txt,pdf,ppt,pptx,pot,dotx,xltx'),\n                            array('admin', 'upload_imagesext', 'jpg,jpeg,gif,png'),\n                            array('admin', 'upload_pkgext', '7z,rar,tar,zip'),\n                            array('admin', 'upload_otherext', 'sql,xml'),\n                            array('admin', 'upload_imageresize_options', '1'),\n                            array('admin', 'upload_imageresize_width', '800'),\n                            array('admin', 'upload_imageresize_height', '600'),\n                            array('admin', 'upload_imageresize_quality', '90'),\n                            array('admin', 'use_md5_password_as_salt', '0'),\n                            array('admin', 'ga_website_name', 'TeamPass for ChangeMe'),\n                            array('admin', 'api', '0'),\n                            array('admin', 'subfolder_rights_as_parent', '0'),\n                            array('admin', 'show_only_accessible_folders', '0'),\n                            array('admin', 'enable_suggestion', '0'),\n                            array('admin', 'otv_expiration_period', '7'),\n                            array('admin', 'default_session_expiration_time', '60'),\n                            array('admin', 'duo', '0'),\n                            array('admin', 'enable_server_password_change', '0'),\n                            array('admin', 'ldap_object_class', '0'),\n                            array('admin', 'bck_script_path', $var['abspath'].\"/backups\"),\n                            array('admin', 'bck_script_filename', 'bck_teampass'),\n                            array('admin', 'syslog_enable', '0'),\n                            array('admin', 'syslog_host', 'localhost'),\n                            array('admin', 'syslog_port', '514'),\n                            array('admin', 'manager_move_item', '0'),\n                            array('admin', 'create_item_without_password', '0'),\n                            array('admin', 'otv_is_enabled', '0'),\n                            array('admin', 'agses_authentication_enabled', '0'),\n                            array('admin', 'item_extra_fields', '0'),\n                            array('admin', 'saltkey_ante_2127', 'none'),\n                            array('admin', 'migration_to_2127', 'done'),\n                            array('admin', 'files_with_defuse', 'done'),\n                            array('admin', 'timezone', 'UTC')\n                        );\n                        foreach ($aMiscVal as $elem) {\n                            //Check if exists before inserting\n                            $tmp = mysqli_num_rows(\n                                mysqli_query(\n                                    $dbTmp,\n                                    \"SELECT * FROM `\".$var['tbl_prefix'].\"misc`\n                                    WHERE type='\".$elem[0].\"' AND intitule='\".$elem[1].\"'\"\n                                )\n                            );\n                            if (intval($tmp) === 0) {\n                                $queryRes = mysqli_query(\n                                    $dbTmp,\n                                    \"INSERT INTO `\".$var['tbl_prefix'].\"misc`\n                                    (`type`, `intitule`, `valeur`) VALUES\n                                    ('\".$elem[0].\"', '\".$elem[1].\"', '\".\n                                    str_replace(\"'\", \"\", $elem[2]).\"');\"\n                                ); // or die(mysqli_error($dbTmp))\n                            }\n\n                            // append new setting in config file\n                            $config_text .= \"\n    '\".$elem[1].\"' => '\".str_replace(\"'\", \"\", $elem[2]).\"',\";\n                        }\n\n                        // write to config file\n                        $result = fwrite(\n                            $file_handler,\n                            utf8_encode(\n                                substr_replace($config_text, \"\", -1).\"\n);\"\n                            )\n                        );\n                        fclose($file_handler);\n                    } elseif ($task === \"nested_tree\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"nested_tree` (\n                            `id` bigint(20) unsigned NOT null AUTO_INCREMENT,\n                            `parent_id` int(11) NOT NULL,\n                            `title` varchar(255) NOT NULL,\n                            `nleft` int(11) NOT NULL DEFAULT '0',\n                            `nright` int(11) NOT NULL DEFAULT '0',\n                            `nlevel` int(11) NOT NULL DEFAULT '0',\n                            `bloquer_creation` tinyint(1) NOT null DEFAULT '0',\n                            `bloquer_modification` tinyint(1) NOT null DEFAULT '0',\n                            `personal_folder` tinyint(1) NOT null DEFAULT '0',\n                            `renewal_period` TINYINT(4) NOT null DEFAULT '0',\n                            PRIMARY KEY (`id`),\n                            UNIQUE KEY `id` (`id`),\n                            KEY `nested_tree_parent_id` (`parent_id`),\n                            KEY `nested_tree_nleft` (`nleft`),\n                            KEY `nested_tree_nright` (`nright`),\n                            KEY `nested_tree_nlevel` (`nlevel`),\n                            KEY `personal_folder_idx` (`personal_folder`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"rights\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"rights` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `tree_id` int(12) NOT NULL,\n                            `fonction_id` int(12) NOT NULL,\n                            `authorized` tinyint(1) NOT null DEFAULT '0',\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"users\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"users` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `login` varchar(50) NOT NULL,\n                            `pw` varchar(400) NOT NULL,\n                            `groupes_visibles` varchar(250) NOT NULL,\n                            `derniers` text NULL,\n                            `key_tempo` varchar(100) NULL,\n                            `last_pw_change` varchar(30) NULL,\n                            `last_pw` text NULL,\n                            `admin` tinyint(1) NOT null DEFAULT '0',\n                            `fonction_id` varchar(255) NULL,\n                            `groupes_interdits` varchar(255) NULL,\n                            `last_connexion` varchar(30) NULL,\n                            `gestionnaire` int(11) NOT null DEFAULT '0',\n                            `email` varchar(300) NOT NULL DEFAULT 'none',\n                            `favourites` varchar(300) NULL,\n                            `latest_items` varchar(300) NULL,\n                            `personal_folder` int(1) NOT null DEFAULT '0',\n                            `disabled` tinyint(1) NOT null DEFAULT '0',\n                            `no_bad_attempts` tinyint(1) NOT null DEFAULT '0',\n                            `can_create_root_folder` tinyint(1) NOT null DEFAULT '0',\n                            `read_only` tinyint(1) NOT null DEFAULT '0',\n                            `timestamp` varchar(30) NOT null DEFAULT '0',\n                            `user_language` varchar(50) NOT null DEFAULT '0',\n                            `name` varchar(100) NULL,\n                            `lastname` varchar(100) NULL,\n                            `session_end` varchar(30) NULL,\n                            `isAdministratedByRole` tinyint(5) NOT null DEFAULT '0',\n                            `psk` varchar(400) NULL,\n                            `ga` varchar(50) NULL,\n                            `ga_temporary_code` VARCHAR(20) NOT NULL DEFAULT 'none',\n                            `avatar` varchar(255) NULL,\n                            `avatar_thumb` varchar(255) NULL,\n                            `upgrade_needed` BOOLEAN NOT NULL DEFAULT FALSE,\n                            `treeloadstrategy` varchar(30) NOT null DEFAULT 'full',\n                            `can_manage_all_users` tinyint(1) NOT NULL DEFAULT '0',\n                            `usertimezone` VARCHAR(50) NOT NULL DEFAULT 'not_defined',\n                            `agses-usercardid` VARCHAR(50) NOT NULL DEFAULT '0',\n                            `encrypted_psk` text NULL,\n                            `user_ip` varchar(60) NOT null DEFAULT 'none',\n                            PRIMARY KEY (`id`),\n                            UNIQUE KEY `login` (`login`)\n                            ) CHARSET=utf8;\"\n                        );\n\n                        require_once \"../includes/config/include.php\";\n                        // check that admin accounts doesn't exist\n                        $tmp = mysqli_num_rows(mysqli_query($dbTmp, \"SELECT * FROM `\".$var['tbl_prefix'].\"users` WHERE login = 'admin'\"));\n                        if ($tmp === 0) {\n                            $mysqli_result = mysqli_query(\n                                $dbTmp,\n                                \"INSERT INTO `\".$var['tbl_prefix'].\"users` (`id`, `login`, `pw`, `admin`, `gestionnaire`, `personal_folder`, `groupes_visibles`, `email`, `encrypted_psk`, `last_pw_change`) VALUES ('1', 'admin', '\".bCrypt($var['admin_pwd'], '13').\"', '1', '0', '0', '', '', '', '\".time().\"')\"\n                            );\n                        } else {\n                            $mysqli_result = mysqli_query($dbTmp, \"UPDATE `\".$var['tbl_prefix'].\"users` SET `pw` = '\".bCrypt($var['admin_pwd'], '13').\"' WHERE login = 'admin' AND id = '1'\");\n                        }\n\n                        // check that API doesn't exist\n                        $tmp = mysqli_num_rows(mysqli_query($dbTmp, \"SELECT * FROM `\".$var['tbl_prefix'].\"users` WHERE id = '\".API_USER_ID.\"'\"));\n                        if ($tmp === 0) {\n                            $mysqli_result = mysqli_query(\n                                $dbTmp,\n                                \"INSERT INTO `\".$var['tbl_prefix'].\"users` (`id`, `login`, `pw`, `groupes_visibles`, `derniers`, `key_tempo`, `last_pw_change`, `last_pw`, `admin`, `fonction_id`, `groupes_interdits`, `last_connexion`, `gestionnaire`, `email`, `favourites`, `latest_items`, `personal_folder`) VALUES ('\".API_USER_ID.\"', 'API', '', '', '', '', '', '', '1', '', '', '', '0', '', '', '', '0')\"\n                            );\n                        }\n\n                        // check that OTV doesn't exist\n                        $tmp = mysqli_num_rows(mysqli_query($dbTmp, \"SELECT * FROM `\".$var['tbl_prefix'].\"users` WHERE id = '\".OTV_USER_ID.\"'\"));\n                        if ($tmp === 0) {\n                            $mysqli_result = mysqli_query(\n                                $dbTmp,\n                                \"INSERT INTO `\".$var['tbl_prefix'].\"users` (`id`, `login`, `pw`, `groupes_visibles`, `derniers`, `key_tempo`, `last_pw_change`, `last_pw`, `admin`, `fonction_id`, `groupes_interdits`, `last_connexion`, `gestionnaire`, `email`, `favourites`, `latest_items`, `personal_folder`) VALUES ('\".OTV_USER_ID.\"', 'OTV', '', '', '', '', '', '', '1', '', '', '', '0', '', '', '', '0')\"\n                            );\n                        }\n                    } elseif ($task === \"tags\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"tags` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `tag` varchar(30) NOT NULL,\n                            `item_id` int(12) NOT NULL,\n                            PRIMARY KEY (`id`),\n                            UNIQUE KEY `id` (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"log_system\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"log_system` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `type` varchar(20) NOT NULL,\n                            `date` varchar(30) NOT NULL,\n                            `label` text NOT NULL,\n                            `qui` varchar(255) NOT NULL,\n                            `field_1` varchar(250) DEFAULT NULL,\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"files\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"files` (\n                            `id` int(11) NOT null AUTO_INCREMENT,\n                            `id_item` int(11) NOT NULL,\n                            `name` varchar(100) NOT NULL,\n                            `size` int(10) NOT NULL,\n                            `extension` varchar(10) NOT NULL,\n                            `type` varchar(255) NOT NULL,\n                            `file` varchar(50) NOT NULL,\n                            `status` varchar(50) NOT NULL DEFAULT '0',\n                            PRIMARY KEY (`id`)\n                           ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"cache\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"cache` (\n                            `id` int(12) NOT NULL,\n                            `label` varchar(500) NOT NULL,\n                            `description` text NOT NULL,\n                            `tags` text DEFAULT NULL,\n                            `id_tree` int(12) NOT NULL,\n                            `perso` tinyint(1) NOT NULL,\n                            `restricted_to` varchar(200) DEFAULT NULL,\n                            `login` varchar(200) DEFAULT NULL,\n                            `folder` varchar(300) NOT NULL,\n                            `author` varchar(50) NOT NULL,\n                            `renewal_period` tinyint(4) NOT NULL DEFAULT '0',\n                            `timestamp` varchar(50) DEFAULT NULL,\n                            `url` varchar(500) NOT NULL DEFAULT '0',\n                            `encryption_type` VARCHAR(50) DEFAULT NULL DEFAULT '0'\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"roles_title\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"roles_title` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `title` varchar(50) NOT NULL,\n                            `allow_pw_change` TINYINT(1) NOT null DEFAULT '0',\n                            `complexity` INT(5) NOT null DEFAULT '0',\n                            `creator_id` int(11) NOT null DEFAULT '0',\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"roles_values\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"roles_values` (\n                            `role_id` int(12) NOT NULL,\n                            `folder_id` int(12) NOT NULL,\n                            `type` varchar(5) NOT NULL DEFAULT 'R',\n                            KEY `role_id_idx` (`role_id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"kb\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"kb` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `category_id` int(12) NOT NULL,\n                            `label` varchar(200) NOT NULL,\n                            `description` text NOT NULL,\n                            `author_id` int(12) NOT NULL,\n                            `anyone_can_modify` tinyint(1) NOT null DEFAULT '0',\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"kb_categories\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"kb_categories` (\n                            `id` int(12) NOT null AUTO_INCREMENT,\n                            `category` varchar(50) NOT NULL,\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"kb_items\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"kb_items` (\n                            `kb_id` int(12) NOT NULL,\n                            `item_id` int(12) NOT NULL\n                           ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task == \"restriction_to_roles\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"restriction_to_roles` (\n                            `role_id` int(12) NOT NULL,\n                            `item_id` int(12) NOT NULL,\n                            KEY `role_id_idx`  (`role_id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"languages\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"languages` (\n                            `id` INT(10) NOT null AUTO_INCREMENT PRIMARY KEY ,\n                            `name` VARCHAR(50) NOT null ,\n                            `label` VARCHAR(50) NOT null ,\n                            `code` VARCHAR(10) NOT null ,\n                            `flag` VARCHAR(30) NOT NULL\n                            ) CHARSET=utf8;\"\n                        );\n\n                        // add lanaguages\n                        $tmp = mysqli_num_rows(mysqli_query($dbTmp, \"SELECT * FROM `\".$var['tbl_prefix'].\"languages` WHERE name = 'french'\"));\n                        if ($tmp[0] == 0) {\n                            $mysql_result = mysqli_query(\n                                $dbTmp,\n                                \"INSERT INTO `\".$var['tbl_prefix'].\"languages` (`name`, `label`, `code`, `flag`) VALUES\n                                ('french', 'French' , 'fr', 'fr.png'),\n                                ('english', 'English' , 'us', 'us.png'),\n                                ('spanish', 'Spanish' , 'es', 'es.png'),\n                                ('german', 'German' , 'de', 'de.png'),\n                                ('czech', 'Czech' , 'cz', 'cz.png'),\n                                ('italian', 'Italian' , 'it', 'it.png'),\n                                ('russian', 'Russian' , 'ru', 'ru.png'),\n                                ('turkish', 'Turkish' , 'tr', 'tr.png'),\n                                ('norwegian', 'Norwegian' , 'no', 'no.png'),\n                                ('japanese', 'Japanese' , 'ja', 'ja.png'),\n                                ('portuguese', 'Portuguese' , 'pr', 'pr.png'),\n                                ('portuguese_br', 'Portuguese (Brazil)' , 'pr-bt', 'pr-bt.png'),\n                                ('chinese', 'Chinese' , 'cn', 'cn.png'),\n                                ('swedish', 'Swedish' , 'se', 'se.png'),\n                                ('dutch', 'Dutch' , 'nl', 'nl.png'),\n                                ('catalan', 'Catalan' , 'ct', 'ct.png'),\n                                ('vietnamese', 'Vietnamese' , 'vi', 'vi.png'),\n                                ('estonian', 'Estonian' , 'ee', 'ee.png');\"\n                            );\n                        }\n                    } elseif ($task === \"emails\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"emails` (\n                            `timestamp` INT(30) NOT null ,\n                            `subject` VARCHAR(255) NOT null ,\n                            `body` TEXT NOT null ,\n                            `receivers` VARCHAR(255) NOT null ,\n                            `status` VARCHAR(30) NOT NULL\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"automatic_del\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"automatic_del` (\n                            `item_id` int(11) NOT NULL,\n                            `del_enabled` tinyint(1) NOT NULL,\n                            `del_type` tinyint(1) NOT NULL,\n                            `del_value` varchar(35) NOT NULL\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"items_edition\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"items_edition` (\n                            `item_id` int(11) NOT NULL,\n                            `user_id` int(12) NOT NULL,\n                            `timestamp` varchar(50) NOT NULL\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"categories\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"categories` (\n                            `id` int(12) NOT NULL AUTO_INCREMENT,\n                            `parent_id` int(12) NOT NULL,\n                            `title` varchar(255) NOT NULL,\n                            `level` int(2) NOT NULL,\n                            `description` text NULL,\n                            `type` varchar(50) NULL default '',\n                            `order` int(12) NOT NULL default '0',\n                            `encrypted_data` tinyint(1) NOT NULL default '1',\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"categories_items\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"categories_items` (\n                            `id` int(12) NOT NULL AUTO_INCREMENT,\n                            `field_id` int(11) NOT NULL,\n                            `item_id` int(11) NOT NULL,\n                            `data` text NOT NULL,\n                            `data_iv` text NOT NULL,\n                            `encryption_type` VARCHAR(20) NOT NULL DEFAULT 'not_set',\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"categories_folders\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"categories_folders` (\n                            `id_category` int(12) NOT NULL,\n                            `id_folder` int(12) NOT NULL\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"api\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"api` (\n                            `id` int(20) NOT NULL AUTO_INCREMENT,\n                            `type` varchar(15) NOT NULL,\n                            `label` varchar(255) NOT NULL,\n                            `value` varchar(255) NOT NULL,\n                            `timestamp` varchar(50) NOT NULL,\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"otv\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"otv` (\n                            `id` int(10) NOT NULL AUTO_INCREMENT,\n                            `timestamp` text NOT NULL,\n                            `code` varchar(100) NOT NULL,\n                            `item_id` int(12) NOT NULL,\n                            `originator` int(12) NOT NULL,\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"suggestion\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"suggestion` (\n                            `id` tinyint(12) NOT NULL AUTO_INCREMENT,\n                            `label` varchar(255) NOT NULL,\n                            `pw` text NOT NULL,\n                            `pw_iv` text NOT NULL,\n                            `pw_len` int(5) NOT NULL,\n                            `description` text NOT NULL,\n                            `author_id` int(12) NOT NULL,\n                            `folder_id` int(12) NOT NULL,\n                            `comment` text NOT NULL,\n                            `suggestion_type` varchar(10) NOT NULL default 'new',\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"export` (\n                            `id` int(12) NOT NULL,\n                            `label` varchar(255) NOT NULL,\n                            `login` varchar(100) NOT NULL,\n                            `description` text NOT NULL,\n                            `pw` text NOT NULL,\n                            `path` varchar(500) NOT NULL,\n                            `email` varchar(500) NOT NULL default 'none',\n                            `url` varchar(500) NOT NULL default 'none',\n                            `kbs` varchar(500) NOT NULL default 'none',\n                            `tags` varchar(500) NOT NULL default 'none'\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"tokens\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"tokens` (\n                            `id` int(12) NOT NULL AUTO_INCREMENT,\n                            `user_id` int(12) NOT NULL,\n                            `token` varchar(255) NOT NULL,\n                            `reason` varchar(255) NOT NULL,\n                            `creation_timestamp` varchar(50) NOT NULL,\n                            `end_timestamp` varchar(50) NOT NULL,\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    } elseif ($task === \"items_change\") {\n                        $mysqli_result = mysqli_query(\n                            $dbTmp,\n                            \"CREATE TABLE IF NOT EXISTS `\".$var['tbl_prefix'].\"items_change` (\n                            `id` int(12) NOT NULL AUTO_INCREMENT,\n                            `item_id` int(12) NOT NULL,\n                            `label` varchar(255) NOT NULL DEFAULT 'none',\n                            `pw` text NOT NULL,\n                            `login` varchar(255) NOT NULL DEFAULT 'none',\n                            `email` varchar(255) NOT NULL DEFAULT 'none',\n                            `url` varchar(255) NOT NULL DEFAULT 'none',\n                            `description` text NOT NULL,\n                            `comment` text NOT NULL,\n                            `folder_id` tinyint(12) NOT NULL,\n                            `user_id` int(12) NOT NULL,\n                            `timestamp` varchar(50) NOT NULL DEFAULT 'none',\n                            PRIMARY KEY (`id`)\n                            ) CHARSET=utf8;\"\n                        );\n                    }\n                }\n                // answer back\n                if ($mysqli_result) {\n                    echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\", \"task\" : \"'.$task.'\", \"activity\" : \"'.$activity.'\"}]';\n                } else {\n                    echo '[{\"error\" : \"'.addslashes(str_replace(array(\"'\", \"\\n\", \"\\r\"), array('\"', '', ''), mysqli_error())).'\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\", \"table\" : \"'.$task.'\"}]';\n                }\n            } else {\n                echo '[{\"error\" : \"'.addslashes(str_replace(array(\"'\", \"\\n\", \"\\r\"), array('\"', '', ''), mysqli_connect_error())).'\", \"result\" : \"Failed\", \"multiple\" : \"\"}]';\n            }\n\n            mysqli_close($dbTmp);\n            // Destroy session without writing to disk\n            define('NODESTROY_SESSION', 'true');\n            session_destroy();\n            break;\n\n        case \"step_6\":\n            //decrypt\n            require_once 'libs/aesctr.php'; // AES Counter Mode implementation\n            $activity = Encryption\\Crypt\\aesctr::decrypt($post_activity, \"cpm\", 128);\n            $data_sent = Encryption\\Crypt\\aesctr::decrypt($post_data, \"cpm\", 128);\n            $data_sent = json_decode($data_sent, true);\n            $task = Encryption\\Crypt\\aesctr::decrypt($post_task, \"cpm\", 128);\n            $json = Encryption\\Crypt\\aesctr::decrypt($post_db, \"cpm\", 128);\n            $db = json_decode($json, true);\n\n            $dbTmp = mysqli_connect(\n                $db['db_host'],\n                $db['db_login'],\n                $db['db_pw'],\n                $db['db_bdd'],\n                $db['db_port']\n            );\n\n            // read install variables\n            $result = mysqli_query($dbTmp, \"SELECT * FROM `_install`\");\n            while ($row = $result->fetch_array()) {\n                $var[$row[0]] = $row[1];\n            }\n\n            // launch\n            if (empty($var['sk_path'])) {\n                $skFile = $var['abspath'].'/includes/sk.php';\n                $securePath = $var['abspath'];\n            } else {\n                //ensure $var['sk_path'] has no trailing slash\n                $var['sk_path'] = rtrim($var['sk_path'], '/\\\\');\n                $skFile = $var['sk_path'].'/sk.php';\n                $securePath = $var['sk_path'];\n            }\n\n            $events = \"\";\n\n            if ($activity === \"file\") {\n                if ($task === \"settings.php\") {\n                    // first is to create teampass-seckey.txt\n                    // 0- check if exists\n                    $filename_seckey = $securePath.\"/teampass-seckey.txt\";\n\n                    if (file_exists($filename_seckey)) {\n                        if (!copy($filename_seckey, $filename_seckey.'.'.date(\"Y_m_d\", mktime(0, 0, 0, date('m'), date('d'), date('y'))))) {\n                            echo '[{\"error\" : \"File `$filename_seckey` already exists and cannot be renamed. Please do it by yourself and click on button Launch.\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                            break;\n                        } else {\n                            unlink($filename);\n                        }\n                    }\n\n                    // 1- generate saltkey\n                    require_once '../includes/libraries/Encryption/Encryption/Crypto.php';\n                    require_once '../includes/libraries/Encryption/Encryption/Encoding.php';\n                    require_once '../includes/libraries/Encryption/Encryption/DerivedKeys.php';\n                    require_once '../includes/libraries/Encryption/Encryption/Key.php';\n                    require_once '../includes/libraries/Encryption/Encryption/KeyOrPassword.php';\n                    require_once '../includes/libraries/Encryption/Encryption/File.php';\n                    require_once '../includes/libraries/Encryption/Encryption/RuntimeTests.php';\n                    require_once '../includes/libraries/Encryption/Encryption/KeyProtectedByPassword.php';\n                    require_once '../includes/libraries/Encryption/Encryption/Core.php';\n\n                    $key = \\Defuse\\Crypto\\Key::createNewRandomKey();\n                    $new_salt = $key->saveToAsciiSafeString();\n\n                    // 2- store key in file\n                    file_put_contents(\n                        $filename_seckey,\n                        $new_salt\n                    );\n\n                    // Now create settings file\n                    $filename = \"../includes/config/settings.php\";\n\n                    if (file_exists($filename)) {\n                        if (!copy($filename, $filename.'.'.date(\"Y_m_d\", mktime(0, 0, 0, date('m'), date('d'), date('y'))))) {\n                            echo '[{\"error\" : \"Setting.php file already exists and cannot be renamed. Please do it by yourself and click on button Launch.\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                            break;\n                        } else {\n                            unlink($filename);\n                        }\n                    }\n\n                    // Encrypt the DB password\n                    $encrypted_text = encryptFollowingDefuse(\n                        $db['db_pw'],\n                        $new_salt\n                    )['string'];\n\n                    // Open and write Settings file\n                    $file_handler = fopen($filename, 'w');\n                    $result = fwrite(\n                        $file_handler,\n                        utf8_encode(\n                            \"<?php\nglobal \\$lang, \\$txt, \\$pathTeampas, \\$urlTeampass, \\$pwComplexity, \\$mngPages;\nglobal \\$server, \\$user, \\$pass, \\$database, \\$pre, \\$db, \\$port, \\$encoding;\n\n### DATABASE connexion parameters ###\n\\$server = \\\"\".$db['db_host'].\"\\\";\n\\$user = \\\"\".$db['db_login'].\"\\\";\n\\$pass = \\\"\".str_replace(\"$\", \"\\\\$\", $encrypted_text).\"\\\";\n\\$database = \\\"\".$db['db_bdd'].\"\\\";\n\\$pre = \\\"\".$var['tbl_prefix'].\"\\\";\n\\$port = \".$db['db_port'].\";\n\\$encoding = \\\"\".$session_db_encoding.\"\\\";\n\n@date_default_timezone_set(\\$_SESSION['settings']['timezone']);\n@define('SECUREPATH', '\".$securePath.\"');\nif (file_exists(\\\"\".str_replace('\\\\', '/', $skFile).\"\\\")) {\n    require_once \\\"\".str_replace('\\\\', '/', $skFile).\"\\\";\n}\n\"\n                        )\n                    );\n                    fclose($file_handler);\n                    if ($result === false) {\n                        echo '[{\"error\" : \"Setting.php file could not be created. Please check the path and the rights\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                    } else {\n                        echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                    }\n                } elseif ($task === \"sk.php\") {\n//Create sk.php file\n                    if (file_exists($skFile)) {\n                        if (!copy($skFile, $skFile.'.'.date(\"Y_m_d\", mktime(0, 0, 0, date('m'), date('d'), date('y'))))) {\n                            echo '[{\"error\" : \"sk.php file already exists and cannot be renamed. Please do it by yourself and click on button Launch.\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                            break;\n                        } else {\n                            unlink($skFile);\n                        }\n                    }\n                    $file_handler = fopen($skFile, 'w');\n\n                    $result = fwrite(\n                        $file_handler,\n                        utf8_encode(\n                            \"<?php\n@define('COST', '13'); // Don't change this.\n@define('AKEY', '');\n@define('IKEY', '');\n@define('SKEY', '');\n@define('HOST', '');\n?>\"\n                        )\n                    );\n                    fclose($file_handler);\n\n                    // finalize\n                    if ($result === false) {\n                        echo '[{\"error\" : \"sk.php file could not be created. Please check the path and the rights.\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                    } else {\n                        echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                    }\n                } elseif ($task === \"security\") {\n                    # Sort out the file permissions\n\n                    // is server Windows or Linux?\n                    if (strtoupper(substr(PHP_OS, 0, 3)) != 'WIN') {\n                        // Change directory permissions\n                        $result = chmodRecursive($session_abspath, 0770, 0740);\n                        if ($result) {\n                            $result = chmodRecursive($session_abspath.'/files', 0770, 0770);\n                        }\n                        if ($result) {\n                            $result = chmodRecursive($session_abspath.'/upload', 0770, 0770);\n                        }\n                    }\n\n                    if ($result === false) {\n                        echo '[{\"error\" : \"Cannot change directory permissions - please fix manually\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                    } else {\n                        echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                    }\n                } elseif ($task === \"csrfp-token\") {\n                    // update CSRFP TOKEN\n                    $csrfp_file_sample = \"../includes/libraries/csrfp/libs/csrfp.config.sample.php\";\n                    $csrfp_file = \"../includes/libraries/csrfp/libs/csrfp.config.php\";\n                    if (file_exists($csrfp_file)) {\n                        if (!copy($csrfp_file, $csrfp_file.'.'.date(\"Y_m_d\", mktime(0, 0, 0, date('m'), date('d'), date('y'))))) {\n                            echo '[{\"error\" : \"csrfp.config.php file already exists and cannot be renamed. Please do it by yourself and click on button Launch.\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                            break;\n                        } else {\n                            $events .= \"The file $csrfp_file already exist. A copy has been created.<br />\";\n                        }\n                    }\n                    unlink($csrfp_file); // delete existing csrfp.config file\n                    copy($csrfp_file_sample, $csrfp_file); // make a copy of csrfp.config.sample file\n                    $data = file_get_contents($csrfp_file);\n                    $newdata = str_replace('\"CSRFP_TOKEN\" => \"\"', '\"CSRFP_TOKEN\" => \"'.bin2hex(openssl_random_pseudo_bytes(25)).'\"', $data);\n                    $jsUrl = $data_sent['url_path'].'/includes/libraries/csrfp/js/csrfprotector.js';\n                    $newdata = str_replace('\"jsUrl\" => \"\"', '\"jsUrl\" => \"'.$jsUrl.'\"', $newdata);\n                    file_put_contents(\"../includes/libraries/csrfp/libs/csrfp.config.php\", $newdata);\n\n                    echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                }\n            } elseif ($activity === \"install\") {\n                if ($task === \"cleanup\") {\n                    // Mark a tag to force Install stuff (folders, files and table) to be cleanup while first login\n                    mysqli_query($dbTmp, \"INSERT INTO `\".$var['tbl_prefix'].\"misc` (`type`, `intitule`, `valeur`) VALUES ('install', 'clear_install_folder', 'true')\");\n\n                    echo '[{\"error\" : \"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n                }\n            }\n\n            mysqli_close($dbTmp);\n            // Destroy session without writing to disk\n            define('NODESTROY_SESSION', 'true');\n            session_destroy();\n            break;\n    }\n}\n", "<?php\n/**\n * @file          upgrade.ajax.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\n\n/*\n** Upgrade script for release 2.1.27\n*/\nrequire_once('../sources/SecureHandler.php');\nsession_start();\nerror_reporting(E_ERROR | E_PARSE);\n$_SESSION['db_encoding'] = \"utf8\";\n$_SESSION['CPM'] = 1;\n\n\n//include librairies\nrequire_once '../includes/language/english.php';\nrequire_once '../includes/config/include.php';\nrequire_once '../includes/config/settings.php';\nrequire_once '../sources/main.functions.php';\nrequire_once '../includes/libraries/Tree/NestedTree/NestedTree.php';\n\n$_SESSION['settings']['loaded'] = \"\";\n//define pbkdf2 iteration count\n@define('ITCOUNT', '2072');\n$return_error = \"\";\n$res = \"\";\n\n\n//Build tree\n$tree = new Tree\\NestedTree\\NestedTree(\n    $pre.'nested_tree',\n    'id',\n    'parent_id',\n    'title'\n);\n\n\n// Prepare POST variables\n$post_no_maintenance_mode = filter_input(INPUT_POST, 'no_maintenance_mode', FILTER_SANITIZE_NUMBER_INT);\n$post_index = filter_input(INPUT_POST, 'index', FILTER_SANITIZE_NUMBER_INT);\n$post_multiple = filter_input(INPUT_POST, 'multiple', FILTER_SANITIZE_STRING);\n\n// DataBase\n// Test DB connexion\n$pass = defuse_return_decrypted($pass);\nif (mysqli_connect(\n    $server,\n    $user,\n    $pass,\n    $database,\n    $port\n)\n) {\n    $db_link = mysqli_connect(\n        $server,\n        $user,\n        $pass,\n        $database,\n        $port\n    );\n} else {\n    $res = \"Impossible to get connected to server. Error is: \".addslashes(mysqli_connect_error());\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"Impossible to get connected to server. Error is: '.addslashes(mysqli_connect_error()).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n// Load libraries\nrequire_once '../includes/libraries/protect/SuperGlobal/SuperGlobal.php';\n$superGlobal = new protect\\SuperGlobal\\SuperGlobal();\n\n// Set Session\n$superGlobal->put(\"db_encoding\", \"utf8\", \"SESSION\");\n$_SESSION['settings']['loaded'] = \"\";\n$superGlobal->put(\"fullurl\", $post_fullurl, \"SESSION\");\n$superGlobal->put(\"abspath\", $abspath, \"SESSION\");\n\n// Get Sessions\n$session_tp_defuse_installed = $superGlobal->get(\"tp_defuse_installed\", \"SESSION\");\n\n/**\n * Function permits to get the value from a line\n * @param  string $val [description]\n * @return string      [description]\n */\nfunction getSettingValue($val)\n{\n    $val = trim(strstr($val, \"=\"));\n    return trim(str_replace('\"', '', substr($val, 1, strpos($val, \";\") - 1)));\n}\n\n/**\n * Function permits to check if a column exists, and if not to add it\n * @param string $dbname     [description]\n * @param string $column     [description]\n * @param string $columnAttr [description]\n */\nfunction addColumnIfNotExist($dbname, $column, $columnAttr = \"VARCHAR(255) NULL\")\n{\n    global $db_link;\n    $exists = false;\n    $columns = mysqli_query($db_link, \"show columns from $dbname\");\n    while ($col = mysqli_fetch_assoc($columns)) {\n        if ($col['Field'] == $column) {\n            $exists = true;\n            return true;\n        }\n    }\n    if (!$exists) {\n        return mysqli_query($db_link, \"ALTER TABLE `$dbname` ADD `$column`  $columnAttr\");\n    }\n\n    return false;\n}\n\n/**\n * [cleanFields description]\n * @param  [type] $txt [description]\n * @return [type]      [description]\n */\nfunction cleanFields($txt)\n{\n    $tmp = str_replace(\",\", \";\", trim($txt));\n    if (empty($tmp)) {\n        return $tmp;\n    }\n    if ($tmp === \";\") {\n        return \"\";\n    }\n    if (strpos($tmp, ';') === 0) {\n        $tmp = substr($tmp, 1);\n    }\n    if (substr($tmp, -1) !== \";\") {\n        $tmp = $tmp.\";\";\n    }\n    return $tmp;\n}\n\n// 2.1.27 introduce new encryption protocol with DEFUSE library.\n// Now evaluate if current instance has already this version\n$tmp = mysqli_fetch_row(mysqli_query($db_link, \"SELECT valeur FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'teampass_version'\"));\nif (count($tmp[0]) === 0 || empty($tmp[0])) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'teampass_version', '\".$SETTINGS_EXT['version'].\"')\"\n    );\n} else {\n    mysqli_query(\n        $db_link,\n        \"UPDATE `\".$pre.\"misc`\n        SET `valeur` = '\".$SETTINGS_EXT['version'].\"'\n        WHERE intitule = 'teampass_version' AND type = 'admin'\"\n    );\n}\n\n// add new admin setting \"migration_to_2127\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'migration_to_2127'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'migration_to_2127', '0')\"\n    );\n}\n\n\n// check if library defuse already on-going here\n// if yes, then don't execute re-encryption\nif (isset($session_tp_defuse_installed) !== true) {\n    $superGlobal->put(\"tp_defuse_installed\", false, \"SESSION\");\n    $columns = mysqli_query($db_link, \"show columns from \".$pre.\"items\");\n    while ($c = mysqli_fetch_assoc($columns)) {\n        if ($c['Field'] === \"encryption_type\") {\n            $superGlobal->put(\"tp_defuse_installed\", true, \"SESSION\");\n        }\n    }\n}\n\n// alter table Items\nmysqli_query($db_link, \"ALTER TABLE `\".$pre.\"items` MODIFY pw_len INT(5) NOT NULL DEFAULT '0'\");\n\n// alter table MISC - rename ID is exists\n$result = mysqli_query(\"SHOW COLUMNS FROM `misc` LIKE 'id'\");\nif (mysqli_num_rows($result) !== 0) {\n    // Change name of field\n    mysqli_query($db_link, \"ALTER TABLE `\".$pre.\"misc` CHANGE `id` `increment_id` INT(12) NOT NULL\");\n} else {\n    // alter table misc to add an index\n    $res = addColumnIfNotExist(\n        $pre.\"misc\",\n        \"increment_id\",\n        \"INT(12) NOT NULL AUTO_INCREMENT FIRST, ADD PRIMARY KEY (`id`)\"\n    );\n}\n\n// alter table misc to add an index\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"log_items` ADD `increment_id` INT(12) NOT NULL AUTO_INCREMENT FIRST, ADD PRIMARY KEY (`increment_id`)\"\n);\n\n// add field agses-usercardid to Users table\n$res = addColumnIfNotExist(\n    $pre.\"users\",\n    \"agses-usercardid\",\n    \"VARCHAR(12) NOT NULL DEFAULT '0'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field agses-usercardid to table Users! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n\n// add field encrypted_data to Categories table\n$res = addColumnIfNotExist(\n    $pre.\"categories\",\n    \"encrypted_data\",\n    \"TINYINT(1) NOT NULL DEFAULT '1'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field encrypted_data to table categories! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n\n// alter table USERS - user_language\nmysqli_query($db_link, \"ALTER TABLE `\".$pre.\"users` MODIFY user_language VARCHAR(50) NOT NULL DEFAULT '0'\");\n\n// alter table USERS - just ensure correct naming of IsAdministratedByRole\nmysqli_query($db_link, \"ALTER TABLE `\".$pre.\"users` CHANGE IsAdministratedByRole isAdministratedByRole tinyint(5) NOT NULL DEFAULT '0'\");\n\n// alter table OTV\nmysqli_query($db_link, \"ALTER TABLE `\".$pre.\"otv` CHANGE originator originator int(12) NOT NULL DEFAULT '0'\");\n\n// do clean of users table\n$fieldsToUpdate = ['groupes_visibles', 'fonction_id', 'groupes_interdits'];\n$result = mysqli_query($db_link, \"SELECT id, groupes_visibles, fonction_id, groupes_interdits FROM `\".$pre.\"users`\");\nwhile ($row = mysqli_fetch_assoc($result)) {\n    // check if field contains , instead of ;\n    foreach ($fieldsToUpdate as $field) {\n        $tmp = cleanFields($row[$field]);\n        if ($tmp !== $row[$field]) {\n            mysqli_query(\n                $db_link,\n                \"UPDATE `\".$pre.\"users`\n                SET `\".$field.\"` = '\".$tmp.\"'\n                WHERE id = '\".$row['id'].\"'\"\n            );\n        }\n    }\n}\nmysqli_free_result($result);\n\n\n// alter table KB_ITEMS\nmysqli_query($db_link, \"ALTER TABLE `\".$pre.\"kb_items` CHANGE `kb_id` `kb_id` INT(12) NOT NULL\");\nmysqli_query($db_link, \"ALTER TABLE `\".$pre.\"kb_items` CHANGE `item_id` `item_id` INT(12) NOT NULL\");\n\n\n// add field encrypted_data to CATEGORIES table\n$res = addColumnIfNotExist(\n    $pre.\"categories\",\n    \"encrypted_data\",\n    \"TINYINT(1) NOT NULL DEFAULT '1'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field encrypted_data to table CATEGORIES! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\nmysqli_query(\n    $db_link,\n    \"UPDATE `\".$pre.\"misc`\n    SET `valeur` = 'maintenance_mode'\n    WHERE type = 'admin' AND intitule = '\".$post_no_maintenance_mode.\"'\"\n);\n\n\n// add field encryption_type to ITEMS table\n$res = addColumnIfNotExist(\n    $pre.\"items\",\n    \"encryption_type\",\n    \"VARCHAR(20) NOT NULL DEFAULT 'not_set'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field encryption_type to table ITEMS! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n\n// add field encryption_type to categories_items table\n$res = addColumnIfNotExist(\n    $pre.\"categories_items\",\n    \"encryption_type\",\n    \"VARCHAR(20) NOT NULL DEFAULT 'not_set'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field encryption_type to table categories_items! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n\n// add field encryption_type to LOG_ITEMS table\n$res = addColumnIfNotExist(\n    $pre.\"log_items\",\n    \"encryption_type\",\n    \"VARCHAR(20) NOT NULL DEFAULT 'not_set'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field encryption_type to table LOG_ITEMS! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n\n// add field URL to CACHE table\n$res = addColumnIfNotExist(\n    $pre.\"cache\",\n    \"encryption_type\",\n    \"VARCHAR(500) NOT NULL DEFAULT '0'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field URL to table CACHE! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n\n// add field timestamp to CACHE table\n$res = addColumnIfNotExist(\n    $pre.\"cache\",\n    \"timestamp\",\n    \"VARCHAR(50) DEFAULT NULL DEFAULT '0'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field url to table CACHE! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n\n// add field url to CACHE table\n$res = addColumnIfNotExist(\n    $pre.\"cache\",\n    \"url\",\n    \"VARCHAR(500) DEFAULT NULL\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field timestamp to table CACHE! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n//-- generate new DEFUSE key\nif (!isset($session_tp_defuse_installed) || $session_tp_defuse_installed === false) {\n    $filename = \"../includes/config/settings.php\";\n    $settingsFile = file($filename);\n    while (list($key, $val) = each($settingsFile)) {\n        if (substr_count($val, 'require_once \"') > 0 && substr_count($val, 'sk.php') > 0) {\n            $superGlobal->put(\"sk_file\", substr($val, 14, strpos($val, '\";') - 14), \"SESSION\");\n            $session_sk_file = $superGlobal->get(\"sk_file\", \"SESSION\");\n        }\n    }\n\n    copy(\n        SECUREPATH.\"/teampass-seckey.txt\",\n        SECUREPATH.\"/teampass-seckey.txt\".'.'.date(\"Y_m_d\", mktime(0, 0, 0, date('m'), date('d'), date('y'))).\".\".time()\n    );\n    $superGlobal->put(\"tp_defuse_new_key\", true, \"SESSION\");\n    $new_salt = defuse_generate_key();\n    file_put_contents(\n        SECUREPATH.\"/teampass-seckey.txt\",\n        $new_salt\n    );\n    $superGlobal->put(\"new_salt\", $new_salt, \"SESSION\");\n\n    // update sk.php file\n    copy(\n        $session_sk_file,\n        $session_sk_file.'.'.date(\"Y_m_d\", mktime(0, 0, 0, date('m'), date('d'), date('y'))).\".\".time()\n    );\n    $data = file($session_sk_file); // reads an array of lines\n    function replace_a_line($data)\n    {\n        if (stristr($data, \"@define('SALT'\")) {\n            return \"\";\n        }\n        return $data;\n    }\n    $data = array_map('replace_a_line', $data);\n    file_put_contents($session_sk_file, implode('', $data));\n\n    //\n    //\n    //-- users need to perform re-encryption of their personal pwds\n    $result = mysqli_query(\n        $db_link,\n        \"SELECT valeur FROM `\".$pre.\"misc` WHERE type='admin' AND intitule='encryption_type'\"\n    );\n    $row = mysqli_fetch_assoc($result);\n    if ($row['valeur'] !== \"defuse\") {\n        $result = mysqli_query(\n            $db_link,\n            \"SELECT id FROM `\".$pre.\"users`\"\n        );\n        while ($row_user = mysqli_fetch_assoc($result)) {\n            $result_items = mysqli_query(\n                $db_link,\n                \"SELECT i.id AS item_id\n                FROM `\".$pre.\"nested_tree` AS n\n                INNER JOIN `\".$pre.\"items` AS i ON (i.id_tree = n.id)\n                WHERE n.title = \".$row_user['id']\n            );\n            if (mysqli_num_rows($result_items) > 0) {\n                mysqli_query(\n                    $db_link,\n                    \"UPDATE `\".$pre.\"users`\n                    SET `upgrade_needed` = '1'\n                    WHERE id = \".$row_user['id']\n                );\n            } else {\n                mysqli_query(\n                    $db_link,\n                    \"UPDATE `\".$pre.\"users`\n                    SET `upgrade_needed` = '0'\n                    WHERE id = \".$row_user['id']\n                );\n            }\n        }\n\n        mysqli_query(\n            $db_link,\n            \"UPDATE `\".$pre.\"misc`\n            SET `valeur` = 'defuse'\n            WHERE `type`='admin' AND `initule`='encryption_type'\"\n        );\n    }\n} else {\n    $_SESSION['tp_defuse_new_key'] = false;\n}\n//--\n\n\n// add field encrypted_psk to Users table\n$res = addColumnIfNotExist(\n    $pre.\"users\",\n    \"encrypted_psk\",\n    \"TEXT NOT NULL\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field encrypted_psk to table Users! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n\n// add new admin setting \"manager_move_item\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'manager_move_item'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'manager_move_item', '0')\"\n    );\n}\n\n// add new admin setting \"create_item_without_password\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'create_item_without_password'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'create_item_without_password', '0')\"\n    );\n}\n\n// add new admin setting \"send_statistics_items\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'send_statistics_items'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'send_statistics_items', 'stat_country;stat_users;stat_items;stat_items_shared;stat_folders;stat_folders_shared;stat_admins;stat_managers;stat_ro;stat_mysqlversion;stat_phpversion;stat_teampassversion;stat_languages;stat_kb;stat_suggestion;stat_customfields;stat_api;stat_2fa;stat_agses;stat_duo;stat_ldap;stat_syslog;stat_stricthttps;stat_fav;stat_pf;')\"\n    );\n}\n\n// add new admin setting \"send_stats_time\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'send_stats_time'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'send_stats_time', '\".(time() - 2592000).\"')\"\n    );\n}\n\n// add new admin setting \"agses_authentication_enabled\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'agses_authentication_enabled'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'agses_authentication_enabled', '0')\"\n    );\n}\n\n// add new admin setting \"timezone\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'timezone'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'timezone', 'UTC')\"\n    );\n}\n\n// add new language \"portuges_br\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"languages` WHERE name = 'portuguese_br'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"languages` (`name`, `label`, `code`, `flag`) VALUES ('portuguese_br', 'Portuguese_br', 'pr-bt', 'pr-bt.png')\"\n    );\n}\n\n\n// alter table USERS to add a new field \"ga_temporary_code\"\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"users` ADD `ga_temporary_code` VARCHAR(20) NOT NULL DEFAULT 'none' AFTER `ga`;\"\n);\n// alter table USERS to add a new field \"user_ip\"\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"users` ADD `user_ip` VARCHAR(60) NOT NULL DEFAULT 'none';\"\n);\n// alter table USERS to allow NULL on field \"email\"\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"users` CHANGE `email` `email` VARCHAR(300) NOT NULL DEFAULT 'none';\"\n);\n\n\n// alter table EXPORT to add a new fields\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"export` ADD `email` VARCHAR(500) NOT NULL DEFAULT 'none';\"\n);\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"export` ADD `url` VARCHAR(500) NOT NULL DEFAULT 'none';\"\n);\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"export` ADD `kbs` VARCHAR(500) NOT NULL DEFAULT 'none';\"\n);\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"export` ADD `tags` VARCHAR(500) NOT NULL DEFAULT 'none';\"\n);\n\n// alter table MISC\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"misc` ADD `id` INT(12) NOT NULL AUTO_INCREMENT FIRST, ADD PRIMARY KEY (`id`);\"\n);\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"misc` CHANGE valeur valeur VARCHAR(500) NOT NULL DEFAULT 'none'\"\n);\n\n// alter table ITEMS_CHANGE\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"items_change` CHANGE user_id user_id INT(12) NOT NULL;\"\n);\n\n// alter table ITEMS\nmysqli_query(\n    $db_link,\n    \"ALTER TABLE `\".$pre.\"items` CHANGE auto_update_pwd_next_date auto_update_pwd_next_date VARCHAR(100) NOT NULL DEFAULT '0';\"\n);\n\n\n// add new admin setting \"otv_is_enabled\"\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'otv_is_enabled'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'otv_is_enabled', '0')\"\n    );\n}\n\n\n// add new field for items_change\nmysqli_query(\n    $db_link,\n    \"CREATE TABLE IF NOT EXISTS `\".$pre.\"items_change` (\n    `id` int(12) NOT NULL AUTO_INCREMENT,\n    `item_id` int(12) NOT NULL,\n    `label` varchar(255) NOT NULL DEFAULT 'none',\n    `pw` text NOT NULL,\n    `login` varchar(255) NOT NULL DEFAULT 'none',\n    `email` varchar(255) NOT NULL DEFAULT 'none',\n    `url` varchar(255) NOT NULL DEFAULT 'none',\n    `description` text NOT NULL,\n    `comment` text NOT NULL,\n    `folder_id` tinyint(12) NOT NULL,\n    `user_id` tinyint(12) NOT NULL,\n    `timestamp` varchar(50) NOT NULL DEFAULT 'none',\n    PRIMARY KEY (`id`)\n    ) CHARSET=utf8;\"\n);\n\n\n\n// File encryption\n// add field status to FILE table\n$res = addColumnIfNotExist(\n    $pre.\"files\",\n    \"status\",\n    \"VARCHAR(50) NOT NULL DEFAULT '0'\"\n);\nif ($res === false) {\n    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field agses-usercardid to table Users! '.mysqli_error($db_link).'!\"}]';\n    mysqli_close($db_link);\n    exit();\n}\n\n// fill in this new field with the current \"encryption-file\" status\n$tmp = mysqli_fetch_row(mysqli_query($db_link, \"SELECT valeur FROM `\".$pre.\"misc` WHERE type = 'admin' AND intitule = 'enable_attachment_encryption'\"));\nif (!empty($tmp[0])) {\n    if ($tmp[0] === \"1\") {\n        $status = \"encrypted\";\n    } else {\n        $status = \"clear\";\n    }\n    mysqli_query($db_link, \"update `\".$pre.\"files` set status = '\".$status.\"' where 1 = 1\");\n}\n\n\n// add 2 generic users\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"users` WHERE id = '9999991' AND login = 'OTV'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"users` (`id`, `login`, `pw`, `groupes_visibles`, `derniers`, `key_tempo`, `last_pw_change`, `last_pw`, `admin`, `fonction_id`, `groupes_interdits`, `last_connexion`, `gestionnaire`, `email`, `favourites`, `latest_items`, `personal_folder`) VALUES ('9999991', 'OTV', '', '', '', '', '', '', '1', '', '', '', '0', '', '', '', '0')\"\n    );\n}\n$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"users` WHERE id = '9999991' AND login = 'OTV'\"));\nif (intval($tmp) === 0) {\n    mysqli_query(\n        $db_link,\n        \"INSERT INTO `\".$pre.\"users` (`id`, `login`, `pw`, `groupes_visibles`, `derniers`, `key_tempo`, `last_pw_change`, `last_pw`, `admin`, `fonction_id`, `groupes_interdits`, `last_connexion`, `gestionnaire`, `email`, `favourites`, `latest_items`, `personal_folder`) VALUES ('9999999', 'API', '', '', '', '', '', '', '1', '', '', '', '0', '', '', '', '0')\"\n    );\n}\n\n\n// Update favico to favicon\n$result = mysqli_query($db_link, \"SELECT valeur FROM `\".$pre.\"misc` WHERE intitule = 'cpassman_url' AND type = 'admin'\");\n$rows = mysqli_fetch_assoc($result);\nmysqli_free_result($result);\nmysqli_query(\n    $db_link,\n    \"UPDATE `\".$pre.\"misc`\n    SET `valeur` = '\".$rows['valeur'].\"/favicon.ico'\n    WHERE intitule = 'favicon' AND type = 'admin'\"\n);\n\n\n\n/*\n* Introduce new CONFIG file\n*/\n$tp_config_file = \"../includes/config/tp.config.php\";\nif (file_exists($tp_config_file)) {\n    if (!copy($tp_config_file, $tp_config_file.'.'.date(\"Y_m_d\", mktime(0, 0, 0, date('m'), date('d'), date('y'))))) {\n        echo '[{\"error\" : \"includes/config/tp.config.php file already exists and cannot be renamed. Please do it by yourself and click on button Launch.\", \"result\":\"\", \"index\" : \"'.$post_index.'\", \"multiple\" : \"'.$post_multiple.'\"}]';\n        return false;\n    } else {\n        unlink($tp_config_file);\n    }\n}\n$file_handler = fopen($tp_config_file, 'w');\n$config_text = \"\";\n$any_settings = false;\n\n$result = mysqli_query($db_link, \"SELECT * FROM `\".$pre.\"misc` WHERE type = 'admin'\");\nwhile ($row = mysqli_fetch_assoc($result)) {\n    // append new setting in config file\n    $config_text .= \"\n    '\".$row['intitule'].\"' => '\".$row['valeur'].\"',\";\n    if ($any_settings === false) {\n        $any_settings = true;\n    }\n}\nmysqli_free_result($result);\n\n// write to config file\nif ($any_settings === true) {\n    $result = fwrite(\n        $file_handler,\n        utf8_encode(\n            \"<?php\nglobal \\$SETTINGS;\n\\$SETTINGS = array (\" . $config_text . \"\n    );\"\n        )\n    );\n}\nfclose($file_handler);\n\n\n\n// Finished\necho '[{\"finish\":\"1\" , \"next\":\"\", \"error\":\"\"}]';\n", "<?php\n/**\n * @file          items.load.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\n\nif (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n    die('Hacking attempt...');\n}\n\n// Load config\nif (file_exists('../includes/config/tp.config.php')) {\n    require_once '../includes/config/tp.config.php';\n} elseif (file_exists('./includes/config/tp.config.php')) {\n    require_once './includes/config/tp.config.php';\n} else {\n    throw new Exception(\"Error file '/includes/config/tp.config.php' not exists\", 1);\n}\n\n$var['hidden_asterisk'] = '<i class=\"fa fa-eye fa-border fa-sm tip\" title=\"'.$LANG['show_password'].'\"></i>&nbsp;&nbsp;<i class=\"fa fa-asterisk\"></i>&nbsp;<i class=\"fa fa-asterisk\"></i>&nbsp;<i class=\"fa fa-asterisk\"></i>&nbsp;<i class=\"fa fa-asterisk\"></i>&nbsp;<i class=\"fa fa-asterisk\"></i>';\n\n// load csrfprotector\n$csrfp_config = include $SETTINGS['cpassman_dir'].'/includes/libraries/csrfp/libs/csrfp.config.php';\n?>\n\n<script type=\"text/javascript\">\n//<![CDATA[\n    var query_in_progress = 0;\n\n    $(document).on('focusin', function(e) {e.stopImmediatePropagation();});\n\n//  Part of Safari 6 OS X fix\n    //  clean up HTML for sending via JSON to PHP code\n    function clean_up_html_safari(input)\n    {\n        //  applies to Safari 6 on OS X only, so check for that\n        user_agent = navigator.userAgent;\n        if (/Mac OS X.+6\\.\\d\\.\\d\\sSafari/.test(user_agent))\n        {\n            // remove strange divs\n            input = input.replace(/<\\/*div.+>\\n/g, '');\n            /**/\n            //  remove other strange tags\n            allowed_tags = '<strong><em><strike><ol><li><ul><a><br>';\n            input = strip_tags(input, allowed_tags);\n\n            //  replace special characters\n            input = input.replace(/(\\r\\n|\\n|\\r)/gm, '<br>')\n                                                .replace(/\\t/g, '')\n                                                .replace(/\\f/g, '')\n                                                .replace(/\\v/g, '')\n                                                .replace(/\\r/g, '');\n        }\n        return input;\n    }/* */\n\n    function AddNewNode()\n    {\n        //Select first child node in tree\n        $('#2').click();\n        //Add new node to selected node\n        simpleTreeCollection.get(0).addNode(1,'A New Node')\n    }\n\n    function EditNode()\n    {\n        //Select first child node in tree\n        $('#2').click();\n        //Add new node to selected node\n        simpleTreeCollection.get(0).addNode(1,'A New Node')\n    }\n\n    function DeleteNode()\n    {\n        //Select first child node in tree\n        $('#2').click();\n        //Add new node to selected node\n        simpleTreeCollection.get(0).delNode()\n    }\n\n    //FUNCTION mask/unmask passwords characters\n    function ShowPassword(pw)\n    {\n        if ($(\"#selected_items\").val() == \"\") return;\n\n        if ($('#id_pw').html().indexOf(\"fa-asterisk\") != -1) {\n            itemLog(\"item_password_shown\");\n            $('#id_pw').text($('#hid_pw').val());\n        } else {\n            $('#id_pw').html('<?php echo $var[\"hidden_asterisk\"]; ?>');\n        }\n    }\n\n    $(\"#tabs-02\").on(\n        \"change\",\n        \"#pw1\",\n        function() {\n            $('#visible_pw').val($('#pw1').val());\n        }\n    );\n\n    function ShowPasswords_EditForm()\n    {\n        if ($('#edit_visible_pw').is(\":visible\")) {\n            $('#edit_visible_pw').addClass(\"hidden\");\n        } else {\n            $('#edit_visible_pw').show();\n        }\n    }\n\n    $(\"#edit_pw1\").keyup(function() {\n        $(\"#edit_visible_pw\").text( this.value );\n    });\n\n    $(\"#pw1\").keyup(function() {\n        $(\"#visible_pw\").text( this.value );\n    });\n\n\n\n    /**\n     * Open a dialogbox\n     * @access public\n     * @return void\n     **/\n    function OpenDialog(id, modal)\n    {\n        if ($(\"#selected_items\").val() == \"\") return;\n\n        if (modal == \"false\") {\n            $(\"#\"+id).dialog(\"option\", \"modal\", false);\n        } else {\n            $(\"#\"+id).dialog(\"option\", \"modal\", true);\n        }\n        $(\"#\"+id).dialog(\"open\");\n    }\n\n/*\n*\n*/\nfunction LoadTreeNode(node_id)\n{\n\n}\n\n//###########\n//## FUNCTION : Launch the listing of all items of one category\n//###########\nvar requestRunning = false;\nfunction ListerItems(groupe_id, restricted, start, stop_listing_current_folder)\n{\n    var me = $(this);\n    stop_listing_current_folder = stop_listing_current_folder || \"0\";\n\n    // case where we should stop listing the items\n    if ($(\"#items_listing_should_stop\").val() === \"1\") {\n        requestRunning = false;\n        $(\"#items_listing_should_stop\").val(\"0\");\n        return false;\n    }\n\n    if (stop_listing_current_folder === 1) {\n        me.data('requestRunning', false);\n        $(\"#new_listing_characteristics\").val(groupe_id+\",\"+restricted+\",\"+start+\",0\");\n    } else {\n        $(\"#new_listing_characteristics\").val(\"\");\n    }\n\n\n    // prevent launch of similar query in case of doubleclick\n    if (requestRunning === true) {\n        return false;\n    }\n    requestRunning = true;\n\n    $(\"#request_lastItem, #selected_items\").val(\"\");\n\n    if (groupe_id != undefined) {\n        //refreshTree(groupe_id);\n        if (query_in_progress != 0 && query_in_progress != groupe_id) {\n            request.abort();    //kill previous query if needed\n        }\n        query_in_progress = groupe_id;\n        //LoadingPage();\n        $(\"#items_list_loader\").removeClass(\"hidden\");\n        if (start == 0) {\n            //clean form\n            $('#id_label, #id_pw, #id_email, #id_url, #id_desc, #id_login, #id_info, #id_restricted_to, #id_files, #id_tags, #id_kbs, #item_extra_info, #item_viewed_x_times').html(\"\");\n            $(\"#items_list\").html(\"<ul class='liste_items 'id='full_items_list'></ul>\");\n        }\n        $(\"#items_list\").css(\"display\", \"\");\n\n        $(\"#hid_cat\").val(groupe_id);\n        if ($(\".tr_fields\") != undefined) $(\".tr_fields, .newItemCat, .editItemCat\").addClass(\"hidden\");\n\n        //Disable menu buttons\n        $(\"#button_quick_login_copy, #button_quick_pw_copy\").addClass(\"hidden\");\n\n        $(\"#items_path_var\").html('<i class=\"fa fa-folder-open-o\"></i>&nbsp;<?php echo addslashes($LANG[\"opening_folder\"]); ?>');\n\n        //ajax query\n        request = $.post(\"sources/items.queries.php\",\n            {\n                type        : \"lister_items_groupe\",\n                id          : groupe_id,\n                restricted  : restricted,\n                start       : start,\n                uniqueLoadData : $(\"#uniqueLoadData\").val(),\n                key         : \"<?php echo $_SESSION['key']; ?>\",\n                nb_items_to_display_once : $(\"#nb_items_to_display_once\").val()\n            },\n            function(data) {\n                if (data == \"Hacking attempt...\") {\n                    alert(\"Hacking attempt...\");\n                    return false;\n                }\n                //get data\n                data = prepareExchangedData(data, \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n\n                // reset doubleclick prevention\n                requestRunning = false;\n\n                // manage not allowed\n                if (data.error == \"not_allowed\") {\n                   $(\"#div_dialog_message_text\").html(data.error_text);\n                   $(\"#div_dialog_message\").dialog(\"open\");\n                   $(\"#items_path_var\").html('<i class=\"fa fa-folder-open-o\"></i>&nbsp;Error');\n                   $(\"#items_list_loader\").addClass(\"hidden\");\n                   return false;\n                }\n\n                // to be done only in 1st list load\n                if (data.list_to_be_continued === \"end\") {\n                    $(\"#pf_selected\").val(data.IsPersonalFolder);\n\n                    // display path of folders\n                    if (data.arborescence != undefined) {\n                        var path_maxlength = 420;\n                        if ($(\"#path_fontsize\").val() != \"\") $(\"#items_path_var\").css('font-size', $(\"#path_fontsize\").val());\n                        if (data.IsPersonalFolder === 0) {\n                            $(\"#items_path_var\").html('<i class=\"fa fa-folder-open-o\"></i>&nbsp;' + data.arborescence);\n                        } else {\n                            $(\"#items_path_var\").html('<i class=\"fa fa-folder-open-o\"></i>&nbsp;<?php echo addslashes($LANG['personal_folder']); ?>&nbsp;:&nbsp;' + data.arborescence);\n                        }\n                        var path_levels = data.arborescence.split('&nbsp;<i class=\"fa fa-caret-right\"></i>&nbsp;').length;\n                        if ($(\"#items_path_var\").width() > path_maxlength) {\n                            $(\"#path_fontsize\").val($(\"#items_path_var\").css('font-size'));\n                            // start reducing size of font\n                            $(\"#items_path_var\").css('font-size', parseInt($(\"#items_path_var\").css('font-size'))-1);\n                            if ($(\"#items_path_var\").width() > path_maxlength && path_levels < 2) {\n                                while ($(\"#items_path_var\").width() > path_maxlength) {\n                                    $(\"#items_path_var\").css('font-size', parseInt($(\"#items_path_var\").css('font-size')) - 1);\n                                }\n                            }\n\n                            if ($(\"#items_path_var\").width() > path_maxlength && path_levels >= 2) {\n                                // only take first and last\n                                var nb = 1;\n                                var totalPathLength = occupedWidth = 0;\n                                $(\".path_element\").each(function () {\n                                    totalPathLength += $(this).width();\n                                    if (nb != 1 && nb != (path_levels-1) && nb != path_levels) {\n                                        $(this).html(\"<span class='tip' title='\"+$(this).html()+\"'>...</span>\");\n                                    } else if (nb == path_levels) {\n                                        // next condition occurs if lasst folder name is too long\n                                        if (totalPathLength > path_maxlength) {\n                                            var lastTxt = $(this).html();\n                                            while ($(this).width() > (path_maxlength - occupedWidth)) {\n                                                lastTxt = lastTxt.slice(0, -1);\n                                                $(this).html(lastTxt);\n                                            }\n                                            $(this).html(lastTxt+\"...\");\n                                        }\n                                    }\n                                    occupedWidth += $(this).width()+15; // 15 pixels corresponds to the small right triangle\n                                    nb++;\n                                });\n                            }\n                        }\n                    } else {\n                        $(\"#items_path_var\").html('');\n                    }\n\n                    // store the categories to be displayed\n                    if (data.displayCategories !== undefined) {\n                        $(\"#display_categories\").val(data.displayCategories);\n                    }\n\n                    // store type of access on folder\n                    $(\"#access_level\").val(data.access_level);\n\n                    // warn about a required change of personal SK\n                    if ($(\"#personal_upgrade_needed\").val() == \"1\" && data.recherche_group_pf === 1) {\n                        $(\"#dialog_upgrade_personal_passwords\").dialog(\"open\");\n                    }\n\n                    $(\"#items_loading_progress\").remove();\n\n                    // show correct fodler in Tree\n                    $(\"#jstree\").jstree(\"deselect_all\");\n                    $('#jstree').jstree(\"select_node\", \"#li_\"+groupe_id);\n                } else {\n                    $(\"#uniqueLoadData\").val(data.uniqueLoadData);\n                    if ($(\"#items_loading_progress\").length == 0) {\n                        $(\"#items_list_loader\").after('<span id=\"items_loading_progress\">' + Math.round(data.next_start*100/data.counter_full, 0) + '%</span>');\n                    } else {\n                        $(\"#items_loading_progress\").html(Math.round(data.next_start*100/data.counter_full, 0) + '%');\n                    }\n                }\n\n\n                if (data.array_items == \"\" && data.items_count == \"0\") {\n                    $(\"#items_list\").html('<div style=\"text-align:center;margin-top:30px;\"><b><i class=\"fa fa-info-circle\"></i>&nbsp;<?php echo addslashes($LANG['no_item_to_display']); ?></b></div>');\n                }\n\n                if (data.error == \"is_pf_but_no_saltkey\") {\n                    //warn user about his saltkey\n                    $(\"#item_details_no_personal_saltkey\").show();\n                    $(\"#item_details_ok, #item_details_nok\").addClass(\"hidden\");\n\n                    $('#menu_button_add_item').prop('disabled', 'true');\n                    $(\"#items_list_loader, #div_loading\").addClass(\"hidden\");\n                } else if (data.error == \"not_authorized\" || data.access_level === \"\") {\n                    //warn user\n                    $(\"#hid_cat\").val(\"\");\n                    //$(\"#menu_button_copy_item, #menu_button_add_group, #menu_button_edit_group, #menu_button_del_group, #menu_button_add_item, #menu_button_edit_item, #menu_button_del_item, #menu_button_history, #menu_button_share, #menu_button_otv\").prop('disabled', 'true');\n                    $(\"#item_details_nok\").removeClass(\"hidden\");\n                    $(\"#item_details_ok, #item_details_no_personal_saltkey\").addClass(\"hidden\");\n                    $(\"#items_list_loader\").addClass(\"hidden\");\n                } else if (($(\"#user_is_read_only\").val() == 1 && data.recherche_group_pf == 0) || data.access_level == 1) {\n                    //readonly user\n                    $(\"#recherche_group_pf\").val(data.saltkey_is_required);\n                    $(\"#item_details_no_personal_saltkey, #item_details_nok\").addClass(\"hidden\");\n                    $(\"#item_details_ok, #items_list\").removeClass(\"hidden\");\n\n                    $(\"#more_items\").remove();\n\n                    // show items\n                    $(\"#full_items_list\").append(data.items_html);\n                    if (data.list_to_be_continued === \"yes\") {\n                        //set next start for query\n                        $(\"#query_next_start\").val(data.next_start);\n                    } else {\n                        $(\"#query_next_start\").val(data.list_to_be_continued);\n\n                        // display Categories if needed\n                        if ($(\".tr_fields\") !== undefined && data.displayCategories !== undefined && data.displayCategories !== \"\") {\n                            var liste = data.displayCategories.split(';');\n                            for (var i=0; i<liste.length; i++) {\n                                $(\".itemCatName_\"+liste[i]+\", #newItemCatName_\"+liste[i]+\", #editItemCatName_\"+liste[i]).show();\n                            }\n                        }\n                        if (data.saltkey_is_required == 1) {\n                            if ($(\".tr_fields\") != undefined) $(\".tr_fields\").addClass(\"hidden\");\n                        }\n                    }\n\n                    proceed_list_update(stop_listing_current_folder);\n                } else {\n                    $(\"#recherche_group_pf\").val(data.saltkey_is_required);\n                    //Display items\n                    $(\"#item_details_no_personal_saltkey, #item_details_nok\").addClass(\"hidden\");\n                    $(\"#item_details_ok, #items_list\").removeClass(\"hidden\");\n\n                    $('#complexite_groupe').val(data.folder_complexity);\n                    $('#bloquer_creation_complexite').val(data.bloquer_creation_complexite);\n                    $('#bloquer_modification_complexite').val(data.bloquer_modification_complexite);\n\n                    // show items\n                    $(\"#full_items_list\").append(data.items_html);\n\n                    if (data.list_to_be_continued === \"yes\") {\n                        //set next start for query\n                        $(\"#query_next_start\").val(data.next_start);\n                    } else {\n                        $(\"#query_next_start\").val(data.list_to_be_continued);\n\n                        // display Categories if needed\n                        if ($(\".tr_fields\") != undefined && data.displayCategories !== undefined && data.displayCategories != \"\") {\n                            var liste = data.displayCategories.split(';');\n                            for (var i=0; i<liste.length; i++) {\n                                $(\".itemCatName_\"+liste[i]+\", #newItemCatName_\"+liste[i]+\", #editItemCatName_\"+liste[i]).show();\n                            }\n                        }\n                        if (data.saltkey_is_required == 1) {\n                            if ($(\".tr_fields\") != undefined) $(\".tr_fields\").addClass(\"hidden\");\n                        }\n                    }\n\n                    //If no data then empty\n                    if (data.array_items != null) {\n                        $(\".item_draggable\").draggable({\n                            handle: '.grippy',\n                            cursor: \"move\",\n                            opacity: 0.4,\n                            appendTo: 'body',\n                            stop: function(event, ui) {\n                                $(this).removeClass(\"ui-state-highlight\");\n                            },\n                            start: function(event, ui) {\n                                $(this).addClass(\"ui-state-highlight\");\n                            },\n                            helper: function(event) {\n                                return $(\"<div class='ui-widget-header' id='drop_helper'>\"+\"<?php echo addslashes($LANG['drag_drop_helper']); ?>\"+\"</div>\");\n                            }\n                        });\n                        $(\".folder\").droppable({\n                            hoverClass: \"ui-state-error\",\n                            tolerance: 'pointer',\n                            drop: function(event, ui) {\n                                ui.draggable.addClass(\"hidden\");\n                                LoadingPage();\n                                //move item\n                                $.post(\n                                    \"sources/items.queries.php\",\n                                    {\n                                        type      : \"move_item\",\n                                        item_id   : ui.draggable.attr(\"id\"),\n                                        folder_id : $(this).attr(\"id\").substring(4),\n                                        key       : \"<?php echo $_SESSION['key']; ?>\"\n                                    },\n                                    function(data) {\n                                        //increment / decrement number of items in folders\n                                        $(\"#itcount_\"+data[0].from_folder).text(Math.floor($(\"#itcount_\"+data[0].from_folder).text())-1);\n                                        $(\"#itcount_\"+data[0].to_folder).text(Math.floor($(\"#itcount_\"+data[0].to_folder).text())+1);\n                                        $(\"#id_label, #item_viewed_x_times, #id_desc, #id_pw, #id_login, #id_email, #id_url, #id_files, #id_restricted_to, #id_tags, #id_kbs\").html(\"\");\n                                        LoadingPage();\n                                        displayMessage(\"<?php echo addslashes($LANG['alert_message_done']); ?>\");\n                                    },\n                                    \"json\"\n                               );\n                            }\n                        });\n                    }\n\n                    proceed_list_update(stop_listing_current_folder);\n                }\n            }\n        );\n    }\n}\n\nfunction pwGenerate(elem)\n{\n    if (elem != \"\") elem = elem+\"_\";\n    $(\"#\"+elem+\"pw1\").show().focus();\n\n    //show ajax image\n    $(\"#\"+elem+\"pw_wait\").removeClass(\"hidden\");\n\n    $.post(\n        \"sources/main.queries.php\",\n        {\n            type    : \"generate_a_password\",\n            size      : $(\"#\"+elem + 'pw_size').val(),\n            numerals      : $(\"#\"+elem + 'pw_numerics').prop(\"checked\"),\n            capitalize      : $(\"#\"+elem + 'pw_maj').prop(\"checked\"),\n            symbols      : $(\"#\"+elem + 'pw_symbols').prop(\"checked\"),\n            secure  : $(\"#\"+elem + 'pw_secure').prop(\"checked\"),\n            elem      : elem,\n            force      : \"false\"\n        },\n        function(data) {\n            data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n               if (data.error == \"true\") {\n                   $(\"#div_dialog_message_text\").html(data.error_msg);\n                   $(\"#div_dialog_message\").dialog(\"open\");\n               } else {\n                $(\"#\"+elem+\"visible_pw\").text(data.key);\n                   $(\"#\"+elem+\"pw1, #\"+elem+\"pw2\").val(data.key);\n                $(\"#\"+elem+\"pw1\").focus();\n               }\n            //$(\"#\"+elem+\"pw1\").show().blur();\n            $(\"#\"+elem+\"pw_wait\").addClass(\"hidden\");\n        }\n   );\n}\n\nfunction pwCopy(elem)\n{\n    if (elem != \"\") elem = elem+\"_\";\n    $(\"#\"+elem + 'pw2').val($(\"#\"+elem + 'pw1').val());\n}\n\nfunction catSelected(val)\n{\n    $(\"#hid_cat\").val(val);\n}\n\n/**\n* Get Item complexity\n*/\nfunction RecupComplexite(val, edit, context)\n{\n    context = context || \"\";    // make context optional\n\n    var funcReturned = null;\n    $.ajaxSetup({async: false});\n    $.post(\n        \"sources/items.queries.php\",\n        {\n            type    : \"get_complixity_level\",\n            groupe  : val,\n            context : context,\n            item_id : $(\"#selected_items\").val()\n        },\n        function(data) {\n            data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n            funcReturned = 1;\n            if (data.error == undefined || data.error == 0) {\n                $(\"#complexite_groupe\").val(data.val);\n                $(\"#selected_folder_is_personal\").val(data.personal);\n                if (edit == 1) {\n                    $(\"#edit_complex_attendue\").html(\"<b>\"+data.complexity+\"</b>\");\n                    $(\"#edit_afficher_visibilite\").html(\"<span class='fa fa-users'></span>&nbsp;<b>\"+data.visibility+\"</b>\");\n                } else {\n                    $(\"#complex_attendue\").html(\"<b>\"+data.complexity+\"</b>\");\n                    $(\"#afficher_visibilite\").html(\"<span class='fa fa-users'></span>&nbsp;<b>\"+data.visibility+\"</b>\");\n                }\n            } else if (data.error == \"no_edition_possible\") {\n                $(\"#div_dialog_message_text\").html(data.error_msg);\n                $(\"#div_dialog_message\").dialog(\"open\");\n                funcReturned = 0;\n            } else if (data.error == \"user_is_readonly\") {\n                displayMessage(data.message);\n                funcReturned = 0;\n            } else if (data.error == \"no_folder_creation_possible\" || data.error == \"no_folder_edition_possible\"  || data.error == \"delete_folder\") {\n                displayMessage('<i class=\"fa fa-warning\"></i>&nbsp;' + data.error_msg);\n                $(\"#div_loading\").addClass(\"hidden\");\n                funcReturned = 0;\n            } else {\n                $(\"#div_formulaire_edition_item\").dialog(\"close\");\n                $(\"#div_dialog_message_text\").html(data.error_msg);\n                $(\"#div_dialog_message\").dialog(\"open\");\n            }\n            $(\"#div_loading\").addClass(\"hidden\");\n        }\n   );\n    $.ajaxSetup({async: true});\n    return funcReturned;\n}\n\n/**\n* Check if Item has been changed since loaded\n*/\nfunction CheckIfItemChanged()\n{\n    var funcReturned = null;\n    $.ajaxSetup({async: false});\n    $.post(\n        \"sources/items.queries.php\",\n        {\n            type        : \"is_item_changed\",\n            timestamp   : $(\"#timestamp_item_displayed\").val(),\n            item_id     : $(\"#selected_items\").val()\n        },\n        function(data) {\n            data = $.parseJSON(data);\n            if (data.modified == 1) {\n                funcReturned = 1;\n            } else {\n                funcReturned = 0;\n            }\n        }\n   );\n    $.ajaxSetup({async: true});\n    return funcReturned;\n}\n\nfunction AjouterItem()\n{\n    $(\"#div_formulaire_saisi_info\").show().html(\"<?php echo \"<i class='fa fa-cog fa-spin fa-lg'></i>&nbsp;\".addslashes($LANG['please_wait']).\"...\"; ?>\");\n    LoadingPage();\n    $(\"#error_detected\").val('');   //Refresh error foolowup\n    var erreur = \"\";\n    var  reg=new RegExp(\"[.|;|:|!|=|+|-|*|/|#|\\\"|'|&|]\");\n\n    //Complete url format\n    var url = $(\"#url\").val();\n    if (url.substring(0,7) != \"http://\" && url!=\"\" && url.substring(0,8) != \"https://\" && url.substring(0,6) != \"ftp://\" && url.substring(0,6) != \"ssh://\") {\n        url = \"http://\"+url;\n    }\n\n    // do checks\n    if ($(\"#label\").val() == \"\") erreur = \"<?php echo addslashes($LANG['error_label']); ?>\";\n    else if ($(\"#pw1\").val() === \"\" && $(\"#create_item_without_password\").val() !== \"1\") erreur = \"<?php echo addslashes($LANG['error_pw']); ?>\";\n    else if ($(\"#categorie\").val() == \"na\") erreur = \"<?php echo addslashes($LANG['error_group']); ?>\";\n    else if ($(\"#pw1\").val() != $(\"#pw2\").val()) erreur = \"<?php echo addslashes($LANG['error_confirm']); ?>\";\n    else if ($(\"#enable_delete_after_consultation\").is(':checked') && (($(\"#times_before_deletion\").val() < 1 && $(\"#deletion_after_date\").val() == \"\") || ($(\"#times_before_deletion\").val() == \"\" && $(\"#deletion_after_date\").val() == \"\"))) erreur = \"<?php echo addslashes($LANG['error_times_before_deletion']); ?>\";\n    else if ($(\"#item_tags\").val() != \"\" && reg.test($(\"#item_tags\").val())) erreur = \"<?php echo addslashes($LANG['error_tags']); ?>\";\n    else if (($('#recherche_group_pf').val() === \"1\" || $('#selected_folder_is_personal').val() === \"1\") && $('#personal_sk_set').val() === \"0\") {\n        erreur = \"<?php echo addslashes($LANG['alert_message_personal_sk_missing']); ?>\";\n    } else{\n        //Check pw complexity level\n        if (\n            ($(\"#bloquer_creation_complexite\").val() == 0 && parseInt($(\"#mypassword_complex\").val()) >= parseInt($(\"#complexite_groupe\").val()))\n            ||\n            ($(\"#bloquer_creation_complexite\").val() == 1)\n            ||\n            ($('#recherche_group_pf').val() == 1 && $('#personal_sk_set').val() == 1)\n            ||\n            $(\"#create_item_without_password\").val() === \"1\"\n      ) {\n            //Manage restrictions\n            var restriction = restriction_role = \"\";\n            $(\"#restricted_to_list option:selected\").each(function () {\n                //check if it's a role\n                if ($(this).val().indexOf('role_') != -1) {\n                    restriction_role += $(this).val().substring(5) + \";\";\n                } else {\n                    restriction += $(this).val() + \";\";\n                }\n            });\n            if (restriction != \"\" && restriction.indexOf($('#form_user_id').val()) == \"-1\")\n                restriction = $('#form_user_id').val()+\";\"+restriction\n            if (restriction == \";\") restriction = \"\";\n\n            //Manage diffusion list\n            var diffusion = \"\";\n            $(\"#annonce_liste_destinataires option:selected\").each(function () {\n                diffusion += $(this).val() + \";\";\n            });\n            if (diffusion == \";\") diffusion = \"\";\n\n            //Manage description\n            if (CKEDITOR.instances && CKEDITOR.instances[\"edit_desc\"]) {\n                CKEDITOR.instances[\"edit_desc\"].destroy();\n            }\n            if (CKEDITOR.instances && CKEDITOR.instances[\"desc\"]) {\n                var description = sanitizeString(CKEDITOR.instances[\"desc\"].getData()).replace(/\\n/g, '<br />').replace(/\\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');\n            } else {\n                var description = sanitizeString($(\"#desc\").val()).replace(/\\n/g, '<br />').replace(/\\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');\n            }\n\n            // Sanitize description with Safari\n            description = clean_up_html_safari(description);\n\n            //Is PF\n            if ($('#selected_folder_is_personal').val() == 1 && $('#personal_sk_set').val() == 1) {\n                var is_pf = 1;\n            } else {\n                var is_pf = 0;\n            }\n\n            //To be deleted\n            if ($(\"#enable_delete_after_consultation\").is(':checked') && ($(\"#times_before_deletion\").val() >= 1 || $(\"#deletion_after_date\").val() != \"\")) {\n                if ($(\"#times_before_deletion\").val() >= 1) {\n                    var to_be_deleted = $(\"#times_before_deletion\").val();\n                } else if ($(\"#deletion_after_date\").val() != \"\") {\n                    var to_be_deleted = $(\"#deletion_after_date\").val();\n                }\n            } else {\n                var to_be_deleted = \"\";\n            }\n\n            // get item field values\n            var fields = \"\";\n            $('.item_field').each(function(i){\n                id = $(this).attr('id').split('_');\n                if (fields == \"\") fields = id[1] + '~~' + $(this).val() + '~~' + id[2];\n                else fields += '_|_' + id[1] + '~~' + $(this).val() + '~~' + id[2];\n            });\n\n            // check if a folder is selected\n            var selected_folder;\n            if ($('#categorie').val() === \"\" || $('#categorie').val() === null) {\n                selected_folder = $('#hid_cat').val();\n            } else {\n                selected_folder = $('#categorie').val();\n            }\n\n            //prepare data\n            var data = {\"pw\": sanitizeString($('#pw1').val()) , \"label\": sanitizeString($('#label').val()) ,\n                \"login\": sanitizeString($('#item_login').val()) , \"is_pf\": is_pf.toString() ,\n                \"description\": (description) , \"email\": $('#email').val() , \"url\": url , \"categorie\": selected_folder ,\n                \"restricted_to\": restriction , \"restricted_to_roles\": restriction_role ,\n                \"salt_key_set\": $('#personal_sk_set').val() , \"diffusion\": diffusion , \"id\": $('#id_item').val() ,\n                \"anyone_can_modify\": $('#anyone_can_modify:checked').val() , \"tags\": sanitizeString($('#item_tags').val()) ,\n                \"random_id_from_files\": $('#random_id').val() , \"to_be_deleted\": to_be_deleted ,\n                \"fields\": sanitizeString(fields) , \"complexity_level\": parseInt($(\"#mypassword_complex\").val())};\n\n            //Send query\n            $.post(\n                \"sources/items.queries.php\",\n                {\n                    type    : \"new_item\",\n                    data     : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key        : \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data) {\n                    //decrypt data\n                    try {\n                        data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                    } catch (e) {\n                        // error\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#request_ongoing\").val(\"\");\n                        $(\"#div_dialog_message_text\").html(\"An error appears. Answer from Server cannot be parsed!<br />Returned data:<br />\"+data);\n                        $(\"#div_dialog_message\").dialog(\"open\");\n\n                        return;\n                    }\n\n                    //Check errors\n                    if (data.error === \"item_exists\") {\n                        $(\"#div_formulaire_saisi\").dialog(\"open\");\n                        $(\"#new_show_error\").html('<?php echo addslashes($LANG['error_item_exists']); ?>');\n                        $(\"#new_show_error\").show();\n                        LoadingPage();\n                    } else if (data.error == \"ERR_KEY_NOT_CORRECT\") {\n                        $(\"#div_formulaire_saisi\").dialog(\"open\");\n                        $(\"#new_show_error\").html('Key verification for Query is not correct!');\n                        $(\"#new_show_error\").show();\n                        LoadingPage();\n                    } else if (data.error == \"ERR_FOLDER_NOT_ALLOWED\") {\n                        $(\"#div_formulaire_saisi\").dialog(\"open\");\n                        $(\"#new_show_error\").html('User not allowed to access this folder!');\n                        $(\"#new_show_error\").show();\n                        LoadingPage();\n                    } else if (data.error == \"ERR_PWD_TOO_LONG\") {\n                        $(\"#div_formulaire_saisi\").dialog(\"open\");\n                        $(\"#new_show_error\").html('<?php echo addslashes($LANG['error_pw_too_long']); ?>');\n                        $(\"#new_show_error\").show();\n                        LoadingPage();\n                    } else if (data.error == \"ERR_ENCRYPTION_NOT_CORRECT\") {\n                        $(\"#div_formulaire_saisi\").dialog(\"open\");\n                        $(\"#new_show_error\").html('Item password could not be correctly encrypted!');\n                        $(\"#new_show_error\").show();\n                        LoadingPage();\n                    } else if (data.error == \"ERR_PWD_EMPTY\") {\n                        $(\"#div_formulaire_saisi\").dialog(\"open\");\n                        $(\"#new_show_error\").html('Item password is empty!');\n                        $(\"#new_show_error\").show();\n                        LoadingPage();\n                    } else if (data.error == \"ERR_ENCRYPTION\") {\n                        $(\"#div_formulaire_saisi\").dialog(\"open\");\n                        $(\"#new_show_error\").html(data.msg);\n                        $(\"#new_show_error\").show();\n                        LoadingPage();\n                    } else if (data.new_id != \"\") {\n                        $(\"#new_show_error\").addClass(\"hidden\");\n\n                        //add new line directly in list of items\n                        $(\"#full_items_list\").append(data.new_entry);\n\n                        //Increment counter\n                        $(\"#itcount_\"+$(\"#hid_cat\").val()).text(Math.floor($(\"#itcount_\"+$(\"#hid_cat\").val()).text())+1);\n\n                        // prepare the display of the new item\n                        AfficherDetailsItem(data.new_id);\n\n                        // refresh list of items\n                        ListerItems($('#categorie').val(), \"\", 0)\n\n                        refreshTree($('#categorie').val());\n\n                        //empty form\n                        $(\"#label, #item_login, #email, #url, #pw1, #visible_pw, #pw2, #item_tags, #deletion_after_date, #times_before_deletion, #mypassword_complex\").val(\"\");\n                        CKEDITOR.instances[\"desc\"].setData(\"\");\n\n                        $(\"#item_tabs\").tabs({selected: 0});\n                        $('ul#full_items_list>li').tsort(\"\",{order:\"asc\",attr:\"name\"});\n                        $(\".fields, .item_field, #categorie, #random_id\").val(\"\");\n                        $(\".fields_div, #item_file_queue, #display_title, #visible_pw\").html(\"\");\n\n                        $(\"#div_formulaire_saisi\").dialog('close');\n                        $(\"#div_formulaire_saisi ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                    }\n                    $(\"#div_formulaire_saisi_info\").addClass(\"hidden\").html(\"\");\n                    $(\"#div_loading\").addClass(\"hidden\");\n                }\n           );\n        } else {\n            $('#new_show_error').html(\"<?php echo addslashes($LANG['error_complex_not_enought']); ?>\").show();\n            $(\"#div_formulaire_saisi ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n            $(\"#div_formulaire_saisi_info\").addClass(\"hidden\").html(\"\");\n        }\n    }\n    if (erreur != \"\") {\n        $('#new_show_error').html(erreur).show();\n        $(\"#div_formulaire_saisi_info\").addClass(\"hidden\").html(\"\");\n    }\n}\n\nfunction EditerItem()\n{\n    $(\"#div_formulaire_edition_item_info\")\n        .html(\"<?php echo \"<i class='fa fa-cog fa-spin fa-lg'></i>&nbsp;\".addslashes($LANG['please_wait']).\"...\"; ?>\")\n        .removeClass(\"hidden\");\n    $(\"#item_detail_zone_loader\").addClass(\"hidden\");\n    var erreur = \"\";\n    var  reg=new RegExp(\"[.|,|;|:|!|=|+|-|*|/|#|\\\"|'|&]\");\n\n    //Complete url format\n    var url = $(\"#edit_url\").val();\n    if (url.substring(0,7) != \"http://\" && url!=\"\" && url.substring(0,8) != \"https://\" && url.substring(0,6) != \"ftp://\" && url.substring(0,6) != \"ssh://\") {\n        url = \"http://\"+url;\n    }\n\n    // do checks\n    if ($('#edit_label').val() == \"\") erreur = \"<?php echo addslashes($LANG['error_label']); ?>\";\n    else if ($(\"#edit_pw1\").val() === \"\" && $(\"#create_item_without_password\").val() !== \"1\") erreur = \"<?php echo addslashes($LANG['error_pw']); ?>\";\n    else if ($(\"#edit_pw1\").val() != $(\"#edit_pw2\").val()) erreur = \"<?php echo addslashes($LANG['error_confirm']); ?>\";\n    else if ($(\"#edit_tags\").val() != \"\" && reg.test($(\"#edit_tags\").val())) erreur = \"<?php echo addslashes($LANG['error_tags']); ?>\";\n    else if ($(\"#edit_categorie option:selected\").val() == \"\" || typeof  $(\"#edit_categorie option:selected\").val() === \"undefined\")  erreur = \"<?php echo addslashes($LANG['error_no_selected_folder']); ?>\";\n    else{\n        //Check pw complexity level\n        if ((\n                $(\"#bloquer_modification_complexite\").val() == 0 &&\n                parseInt($(\"#edit_mypassword_complex\").val()) >= parseInt($(\"#complexite_groupe\").val())\n           )\n            ||\n            ($(\"#bloquer_modification_complexite\").val() == 1)\n            ||\n            ($('#recherche_group_pf').val() == 1 && $('#personal_sk_set').val() == 1)\n            ||\n            $(\"#create_item_without_password\").val() === \"1\"\n      ) {\n            LoadingPage();  //afficher image de chargement\n            var annonce = 0;\n            if ($('#edit_annonce').attr('checked')) annonce = 1;\n            $(\"#item_detail_zone_loader\").show();\n\n\n            //Manage restriction\n            var restriction = restriction_role = \"\";\n            $(\"#edit_restricted_to_list option:selected\").each(function () {\n                if ($(this).val().indexOf('role_') != -1) {\n                    restriction_role += $(this).val() + \";\";\n                } else {\n                    restriction += $(this).val() + \";\";\n                }\n            });\n            if (restriction != \"\" && restriction.indexOf($('#form_user_id').val()) == \"-1\")\n                restriction = $('#form_user_id').val()+\";\"+restriction\n            if (restriction == \";\") restriction = \"\";\n\n\n            //Manage diffusion list\n            var myselect = document.getElementById('edit_annonce_liste_destinataires');\n            var diffusion = \"\";\n            for (var loop=0; loop < myselect.options.length; loop++) {\n                if (myselect.options[loop].selected === true) diffusion = diffusion + myselect.options[loop].value + \";\";\n            }\n            if (diffusion == \";\") {\n                diffusion = \"\";\n            }\n\n            //Manage description\n            if (CKEDITOR.instances[\"edit_desc\"]) {\n                var description = sanitizeString(CKEDITOR.instances[\"edit_desc\"].getData()).replace(/\\n/g, '<br />').replace(/\\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');\n            } else {\n                var description = sanitizeString($(\"#edit_desc\").val()).replace(/\\n/g, '<br />').replace(/\\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');\n            }\n\n            // Sanitize description with Safari\n            description = clean_up_html_safari(description);\n\n            //Is PF\n            if ($('#recherche_group_pf').val() == 1 && $('#personal_sk_set').val() == 1) {\n                var is_pf = 1;\n            } else {\n                var is_pf = 0;\n            }\n\n          //To be deleted\n            if ($(\"#edit_enable_delete_after_consultation\").is(':checked')\n                && ($(\"#edit_times_before_deletion\").val() >= 1 || $(\"#edit_deletion_after_date\").val() != \"\")\n            ) {\n                if ($(\"#edit_times_before_deletion\").val() >= 1) {\n                    var to_be_deleted = $(\"#edit_times_before_deletion\").val();\n                    //var to_be_deleted_after_date = \"\";\n                } else if ($(\"#edit_deletion_after_date\").val() != \"\") {\n                    //var to_be_deleted = \"0\";\n                    var to_be_deleted = $(\"#edit_deletion_after_date\").val();\n                }\n            } else {\n                var to_be_deleted = \"\";\n                //var to_be_deleted_after_date = \"\";\n            }\n\n            // get item field values\n            var fields = \"\";\n            $('.edit_item_field').each(function(i){\n                id = $(this).attr('id').split('_');\n                if (fields == \"\") fields = id[2] + '~~' + $(this).val();\n                else fields += '_|_' + id[2] + '~~' + $(this).val();\n            });\n\n              //prepare data\n            var data = {\"pw\": sanitizeString($('#edit_pw1').val()) , \"label\": sanitizeString($('#edit_label').val()) ,\n                \"login\": sanitizeString($('#edit_item_login').val()) , \"is_pf\": is_pf ,\n                \"description\": description , \"email\": $('#edit_email').val() , \"url\": url ,\n                \"categorie\": $(\"#edit_categorie option:selected\").val() , \"restricted_to\": restriction ,\n                \"restricted_to_roles\": restriction_role , \"salt_key_set\": $('#personal_sk_set').val() ,\n                \"is_pf\": $('#recherche_group_pf').val() , \"annonce\": annonce , \"diffusion\": diffusion ,\n                \"id\": $('#id_item').val() , \"anyone_can_modify\": $('#edit_anyone_can_modify:checked').val() ,\n                \"tags\": sanitizeString($('#edit_tags').val()) , \"to_be_deleted\": to_be_deleted ,\n                \"fields\": sanitizeString(fields) , \"complexity_level\": parseInt($(\"#edit_mypassword_complex\").val())};\n\n            //send query\n            $.post(\n                \"sources/items.queries.php\",\n                {\n                    type    : \"update_item\",\n                    data      : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key        : \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data) {\n                    //decrypt data\n                    try {\n                        data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                    } catch (e) {\n                        // error\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#request_ongoing\").val(\"\");\n                        $(\"#div_dialog_message_text\")\n                            .html(\"An error appears. Answer from Server cannot be parsed!<br />Returned data:<br />\"+\n                            data);\n                        $(\"#div_dialog_message\").dialog(\"open\");\n                        return;\n                    }\n\n                    //check if format error\n                    if (data.error === \"ERR_JSON_FORMAT\") {\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#edit_show_error\")\n                            .html(data.error + ' ERROR (JSON is broken)!!!!!')\n                            .show();\n                    } else if (data.error === \"ERR_KEY_NOT_CORRECT\") {\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#edit_show_error\")\n                            .html('Key verification for Query is not correct!')\n                            .show();\n                        LoadingPage();\n                    }else if (data.error === \"ERR_ENCRYPTION_NOT_CORRECT\") {\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#edit_show_error\")\n                            .html('Item password could not be correctly encrypted!')\n                            .show();\n                        LoadingPage();\n                    } else if (data.error === \"ERR_PWD_TOO_LONG\") {\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#edit_show_error\")\n                            .html('<?php echo addslashes($LANG['error_pw_too_long']); ?>')\n                            .show();\n                        LoadingPage();\n                    } else if (data.error === \"ERR_NOT_ALLOWED_TO_EDIT\") {\n                        $(\"#div_formulaire_saisi\").dialog(\"open\");\n                        $(\"#new_show_error\")\n                            .html('User not allowed to edit this Item!')\n                            .show();\n                        LoadingPage();\n                    } else if (data.error !== \"\") {\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#edit_show_error\")\n                            .html('<?php echo addslashes($LANG['error_not_allowed_to']); ?>')\n                            .show();\n                        LoadingPage();\n                    } else {\n                        //refresh item in list\n                        $(\"#fileclass\"+data.id).html('<div class=\"truncate\">' + $('#edit_label').val() + '</div>');\n\n                        //Refresh form\n                        $(\"#id_label\").text($('#edit_label').val());\n                        //$(\"#id_pw\").text($('#edit_pw1').val());\n                        $(\"#id_email\").html($('#edit_email').val());\n                        $(\"#id_url\").html($('#edit_url').val().escapeHTML());\n                        $(\"#id_desc\").html(description);\n                        $(\"#id_login\").html($('#edit_item_login').val());\n                        $(\"#id_restricted_to\").html(data.list_of_restricted);\n                        $(\"#id_tags\").html(data.tags);\n                        $(\"#id_files\").html(unsanitizeString(data.files));\n                        $(\"#item_edit_list_files\").html(data.files_edit);\n                        $(\"#id_info\").html(unsanitizeString(data.history));\n                        $('#id_pw').html('<?php echo $var['hidden_asterisk']; ?>');\n\n                        //Refresh hidden data\n                        $(\"#hid_label\").val($('#edit_label').val());\n                        $(\"#hid_pw\").val($('#edit_pw1').val());\n                        $(\"#hid_email\").val($('#edit_email').val());\n                        $(\"#hid_url\").val($('#edit_url').val().escapeHTML());\n                        $(\"#hid_desc\").val(description);\n                        $(\"#hid_login\").val($('#edit_item_login').val());\n                        $(\"#hid_restricted_to\").val(restriction);\n                        $(\"#hid_restricted_to_roles\").val(restriction_role);\n                        $(\"#hid_tags\").val($('#edit_tags').val());\n                        $(\"#hid_files\").val(data.files);\n                        /*$(\"#id_categorie\").html(data.id_tree);\n                        $(\"#id_item\").html(data.id);*/\n\n                        // refresh fields\n                        if ($('.edit_item_field').val() != undefined) {\n                            $('.tr_fields').addClass(\"hidden\");\n                            $('.edit_item_field').each(function(i){\n                                id = $(this).attr('id').split('_');\n                                if ($(this).val() !== \"\") {\n                                    // copy data from form to Item Div\n                                    $('#id_field_' + id[2]).html($(this).val());\n                                    $('#hid_field_' + id[2] + '_' + id[3]).val($(this).val());\n                                    $('#cf_tr_' + id[2] + ', .editItemCatName_' + id[3] + ', #tr_catfield_' + id[3]).show()\n                                } else {\n                                    $('#hid_field_' + id[2] + '_' + id[3]).val('');\n                                }\n                                // clear form\n                                $(this).val(\"\");\n                            });\n                        }\n                        $(\"#edit_display_title, #edit_visible_pw\").html(\"\");\n\n                        //calling image lightbox when clicking on link\n                        $(\"a.image_dialog\").click(function(event) {\n                            event.preventDefault();\n                            PreviewImage($(this).attr(\"href\"),$(this).attr(\"title\"));\n                        });\n\n                        //Change title in \"last items list\"\n                        $(\"#last_items_\"+data.id).text($('#edit_label').val());\n\n                        //Clear upload queue\n                        $('#item_edit_file_queue').html('');\n                        //Select 1st tab\n                        $(\"#item_edit_tabs\").tabs({ selected: 0 });\n\n                        //if reload page is needed\n                        if (data.reload_page == \"1\") {\n                            //reload list\n                            ListerItems($('#hid_cat').val(), \"\", 0)\n                            //increment / decrement number of items in folders\n                            $(\"#itcount_\"+$('#hid_cat').val()).text(Math.floor($(\"#itcount_\"+$('#hid_cat').val()).text())-1);\n                            $(\"#itcount_\"+$('#edit_categorie').val()).text(Math.floor($(\"#itcount_\"+$('#edit_categorie').val()).text())+1);\n                        }\n\n                        // tags\n                        $(\".round-grey\").addClass(\"ui-state-highlight ui-corner-all\");\n\n                        //Prepare clipboard copies\n                        if ($('#edit_pw1').val() != \"\") {\n                            new Clipboard(\"#menu_button_copy_pw, #button_quick_pw_copy\", {\n                                text: function() {\n                                    return unsanitizeString($('#edit_pw1').val());\n                                }\n                            });\n\n                            $(\"#button_quick_pw_copy\").show();\n                        } else {\n                            $(\"#button_quick_pw_copy\").addClass(\"hidden\");\n                        }\n                        if ($('#edit_item_login').val() != \"\") {\n                            var clipboard_elogin = new Clipboard(\"#menu_button_copy_login, #button_quick_login_copy\", {\n                                text: function() {\n                                    return unsanitizeString($('#edit_item_login').val());\n                                }\n                            });\n                            $(\"#button_quick_login_copy\").show();\n                        } else {\n                            $(\"#button_quick_login_copy\").addClass(\"hidden\");\n                        }\n\n\n                        $(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                        //Close dialogbox\n                        $(\"#div_formulaire_edition_item\").dialog('close');\n                        $(\"#div_formulaire_edition_item ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                        //hide loader\n                        $(\"#div_loading\").addClass(\"hidden\");\n                    }\n                }\n           );\n\n           // statistic\n           /*$.post(\n                \"sources/main.queries.php\",\n                {\n                    type                : 'item_stat',\n                    id                  : $('#id_item').val(),\n                    stat_action                : \"item\"\n                },\n                function(data) {\n\n                }\n            );*/\n\n        } else {\n            $('#edit_show_error')\n                .html(\"<?php echo addslashes($LANG['error_complex_not_enought']); ?>\")\n                .show();\n            $(\"#div_formulaire_edition_item ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n            $(\"#div_formulaire_edition_item_info\")\n                .addClass(\"hidden\")\n                .html(\"\");\n        }\n    }\n\n    if (erreur != \"\") {\n        $('#edit_show_error').html(erreur).show();\n        $(\"#div_formulaire_edition_item_info\")\n            .addClass(\"hidden\")\n            .html(\"\");\n        $(\"#div_formulaire_edition_item ~ .ui-dialog-buttonpane\")\n            .find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\")\n            .prop(\"disabled\", false);\n    }\n}\n\nfunction AddNewFolder()\n{\n    if ($(\"#new_rep_titre\").val() == \"\") {\n        $(\"#new_rep_show_error\").html(\"<?php echo addslashes($LANG['error_group_label']); ?>\").removeClass(\"hidden\");\n    } else if ($(\"#new_rep_groupe\").val() === \"\") {\n        $(\"#new_rep_show_error\").html(\"<?php echo addslashes($LANG['error_group_noparent']); ?>\").removeClass(\"hidden\");\n    } else if ($(\"#new_rep_complexite\").val() == \"\") {\n        $(\"#new_rep_show_error\").html(\"<?php echo addslashes($LANG['error_group_complex']); ?>\").removeClass(\"hidden\");\n    } else if (/^\\d+$/.test($(\"#new_rep_titre\").val())) {\n        // check if folder title contains only numbers\n        $(\"#new_rep_show_error\").html(\"<?php echo addslashes($LANG['error_only_numbers_in_folder_name']); ?>\").removeClass(\"hidden\");\n    } else if ($(\"#user_ongoing_action\").val() == \"\") {\n        $(\"#add_folder_loader\").removeClass(\"hidden\");\n        $(\"#user_ongoing_action\").val(\"true\");\n        $(\"#new_rep_show_error\").addClass(\"hidden\");\n        if ($(\"#new_rep_role\").val() == undefined) {\n            role_id = \"<?php echo $_SESSION['fonction_id']; ?>\";\n        } else {\n            role_id = $(\"#new_rep_role\").val();\n        }\n\n        //prepare data\n        var data = {\"title\": sanitizeString($('#new_rep_titre').val()),\n            \"complexity\": sanitizeString($('#new_rep_complexite').val()), \"is_pf\": $('#pf_selected').val(),\n            \"parent_id\": $(\"#new_rep_groupe option:selected\").val(), \"renewal_period\":\"0\"};\n\n        //send query\n        $.post(\n            \"sources/folders.queries.php\",\n            {\n                type   : \"add_folder\",\n                data   : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                key    : \"<?php echo $_SESSION['key']; ?>\"\n            },\n            function(data) {\n                $(\"#user_ongoing_action\").val(\"\");\n                //Check errors\n                if (data[0].error == \"error_group_exist\") {\n                    $(\"#new_rep_show_error\").html(\"<?php echo addslashes($LANG['error_group_exist']); ?>\").removeClass(\"hidden\");\n                } else if (data[0].error == \"error_html_codes\") {\n                    $(\"#new_rep_show_error\").html(\"<?php echo addslashes($LANG['error_html_codes']); ?>\").removeClass(\"hidden\");\n                } else if (data[0].error == \"error_title_only_with_numbers\") {\n                    $(\"#new_rep_show_error\").html(\"<?php echo addslashes($LANG['error_only_numbers_in_folder_name']); ?>\").removeClass(\"hidden\");\n                } else if (data[0].error != \"\") {\n                    $(\"#new_rep_show_error\").html(data[0].error).removeClass(\"hidden\");\n                } else {\n                    $(\"#new_rep_titre\").val(\"\");\n                    refreshTree(data[0].newid);\n                    $(\"#div_ajout_rep\").dialog(\"close\");\n                }\n                $(\"#add_folder_loader\").addClass(\"hidden\");\n            },\n            \"json\"\n           );\n    }\n}\n\n\nfunction SupprimerFolder()\n{\n    if ($(\"#delete_rep_groupe_validate\").is(':checked') === false) {\n        $(\"#del_rep_show_error\").html(\"<?php echo '<span class=\\\"fa fa-warning fa-lg\\\"></span>&nbsp;<\\span>'.addslashes($LANG['please_confirm']); ?>\").show(1).delay(2000).fadeOut(1000);\n    } else if ($(\"#delete_rep_groupe\").val() === \"0\") {\n        $(\"#del_rep_show_error\").html(\"<?php echo '<span class=\\\"fa fa-warning fa-lg\\\"></span>&nbsp;<\\span>'.addslashes($LANG['error_group']); ?>\").show(1).delay(2000).fadeOut(1000);\n    } else if ($(\"#delete_rep_groupe option:selected\").text() === \"<?php echo $_SESSION['login']; ?>\") {\n        $(\"#del_rep_show_error\").html(\"<?php echo '<span class=\\\"fa fa-warning fa-lg\\\"></span>&nbsp;<\\span>'.addslashes($LANG['error_not_allowed_to']); ?>\").show(1).delay(2000).fadeOut(1000);\n    } else {\n        $(\"#del_folder_loader\").show();\n        $.post(\n            \"sources/folders.queries.php\",\n            {\n                type    : \"delete_folder\",\n                id      : $(\"#delete_rep_groupe\").val(),\n                key        : \"<?php echo $_SESSION['key']; ?>\"\n            },\n            function(data) {\n                $(\"#del_folder_loader\").addClass(\"hidden\");\n\n                //decrypt data\n                try {\n                    data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                } catch (e) {\n                    // error\n                    $(\"#div_loading\").addClass(\"hidden\");\n                    $(\"#div_dialog_message_text\")\n                        .html(\"An error appears. Answer from Server cannot be parsed!<br />Returned data:<br />\"+\n                        data);\n                    $(\"#div_dialog_message\").dialog(\"open\");\n                    return;\n                }\n\n                if (data.error !== \"\") {\n                    if (data.error === \"ERR_SUB_FOLDERS_EXIST\") {\n                        $(\"#del_rep_show_error\").html(\"<?php echo '<span class=\\\"fa fa-warning fa-lg\\\"></span>&nbsp;<\\span>'.addslashes($LANG['error_cannot_delete_subfolders_exist']); ?>\").show(1).delay(3000).fadeOut(1000);\n\n                    } else if (data.error === \"ERR_FOLDER_NOT_ALLOWED\") {\n                        $(\"#del_rep_show_error\").html(\"<?php echo '<span class=\\\"fa fa-warning fa-lg\\\"></span>&nbsp;<\\span>'.addslashes($LANG['error_not_allowed_to']); ?>\").show(1).delay(3000).fadeOut(1000);\n                    }\n                } else {\n                    refreshTree(data.parent_id);\n                    ListerItems(data.parent_id,'', 0);\n                    $(\"#div_supprimer_rep\").dialog(\"close\");\n                }\n            }\n       );\n    }\n}\n\nfunction AfficherDetailsItem(id, salt_key_required, expired_item, restricted, display, open_edit, reload, id_tree)\n{\n    // If a request is already launched, then kill new.\n    if ($(\"#request_ongoing\").val() !== \"\") {\n        request.abort();\n        return;\n    }\n    id_tree = id_tree || \"\";\n    salt_key_required = salt_key_required || 0;\n    id_tree = id_tree || \"\";\n    id_tree = id_tree || \"\";\n\n    // Store status query running\n    $(\"#request_ongoing\").val(\"1\");\n\n    // If opening new item, reinit hidden fields\n    if ($(\"#request_lastItem\").val() != id) {\n        $(\"#request_lastItem\").val(\"\");\n        $(\"#item_editable\").val(\"\");\n    }\n\n    // Don't show details\n    if (display === \"no_display\") {\n        $(\"#item_details_nok\").removeClass(\"hidden\");\n        $(\"#item_details_ok\").addClass(\"hidden\");\n        $(\"#item_details_expired\").addClass(\"hidden\");\n        $(\"#item_details_expired_full\").addClass(\"hidden\");\n        $(\"#menu_button_edit_item, #menu_button_del_item, #menu_button_copy_item, #menu_button_add_fav, #menu_button_del_fav, #menu_button_show_pw, #menu_button_copy_pw, #menu_button_copy_login, #menu_button_copy_url, #menu_button_copy_link\").attr(\"disabled\",\"disabled\");\n        $(\"#request_ongoing\").val(\"\");\n        return false;\n    }\n    $(\"#div_loading\").removeClass(\"hidden\");\n    if ($(\"#is_admin\").val() == \"1\") {\n        $('#menu_button_edit_item,#menu_button_del_item,#menu_button_copy_item').attr('disabled', 'disabled');\n    }\n\n    if ($(\"#edit_restricted_to\") != undefined) {\n        $(\"#edit_restricted_to\").val(\"\");\n    }\n\n    // Check if personal SK is needed and set\n    if (($('#recherche_group_pf').val() === \"1\" && $('#personal_sk_set').val() === \"0\") && salt_key_required === \"1\") {\n        $(\"#set_personal_saltkey_warning\").html(\"<div style='font-size:16px;'><span class='fa fa-warning fa-lg'></span>&nbsp;</span><?php echo addslashes($LANG['alert_message_personal_sk_missing']); ?></div>\").show(1).delay(2500).fadeOut(1000);\n        $('#div_set_personal_saltkey').dialog('open');\n\n        //$(\"#div_dialog_message_text\").html(\"<div style='font-size:16px;'><span class='fa fa-warning fa-lg mi-red'></span>&nbsp;<\\/span><?php echo addslashes($LANG['alert_message_personal_sk_missing']); ?><\\/div>\");\n        $(\"#div_loading\").addClass(\"hidden\");\n        //$(\"#div_dialog_message\").dialog(\"open\");\n        $(\"#request_ongoing\").val(\"\");\n        return false;\n    } else if ($('#recherche_group_pf').val() === \"0\" || ($('#recherche_group_pf').val() === \"1\" && $('#personal_sk_set').val() === \"1\")) {\n        // Double click\n        if (open_edit == 1 && $(\"#item_editable\").val() == 1 && reload != 1) {\n            $(\"#request_ongoing\").val(\"\");\n            open_edit_item_div(\n                <?php if (isset($SETTINGS['restricted_to_roles']) && $SETTINGS['restricted_to_roles'] === \"1\") {\n    echo 1;\n} else {\n    echo 0;\n}?>\n            );\n        } else if ($(\"#request_lastItem\").val() == id && reload != 1) {\n            $(\"#request_ongoing\").val(\"\");\n            LoadingPage();\n            return;\n        } else {\n            $(\"#timestamp_item_displayed\").val(\"\");\n            var data = {\n                \"id\" : id,\n                \"folder_id\" : $('#hid_cat').val(),\n                \"salt_key_required\" : $('#recherche_group_pf').val(),\n                \"salt_key_set\" : $('#personal_sk_set').val(),\n                \"expired_item\" : expired_item === undefined ? \"\" : expired_item,\n                \"restricted\" : expired_item === undefined ? \"\" : expired_item,\n                \"page\" : \"items\"\n            };\n\n            //Send query\n            $.post(\n                \"sources/items.queries.php\",\n                {\n                    type : 'show_details_item',\n                    data : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key  : \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data_raw) {\n                    //decrypt data\n                    try {\n                        data = prepareExchangedData(data_raw , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                    } catch (e) {\n                        // error\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#request_ongoing\").val(\"\");\n                        $(\"#div_dialog_message_text\").html(\"An error appears. Answer from Server cannot be parsed!<br /><br />Returned data:<br />\"+data_raw);\n                        $(\"#div_dialog_message\").show();\n                        return;\n                    }\n\n                    if (data.error != \"\") {\n                        $(\"#div_dialog_message_text\").html(\"An error appears. Answer from Server cannot be parsed!<br /><br />Returned data:<br />\"+data.error);\n                        $(\"#div_dialog_message\").show();\n                    }\n\n                    // reset password shown info\n                    $(\"#pw_shown\").val(\"0\");\n\n                    // show some info on top\n                    if (data.auto_update_pwd_frequency != \"0\") var auto_update_pwd = \"<i class='fa fa-shield tip' title='<?php echo addslashes($LANG['server_auto_update_password_enabled_tip']); ?>'></i>&nbsp;<b>\"+data.auto_update_pwd_frequency+\"</b>&nbsp;|&nbsp;\";\n                    else var auto_update_pwd = \"\";\n                    $(\"#item_viewed_x_times\").html(auto_update_pwd+\"&nbsp;<i class='fa fa-sticky-note-o tip' title='Number of times item was displayed'></i>&nbsp;<b>\"+data.viewed_no+\"</b>\");\n\n                    // Show timestamp\n                    $(\"#timestamp_item_displayed\").val(data.timestamp);\n\n                    //Change the class of this selected item\n                    if ($(\"#selected_items\").val() != \"\") {\n                        $(\"#fileclass\"+$(\"#selected_items\").val()).removeClass(\"fileselected\");\n                    }\n                    $(\"#selected_items\").val(data.id);\n\n                    //Show saltkey\n                    if (data.edit_item_salt_key == \"1\") {\n                        $(\"#edit_item_salt_key\").show();\n                    } else {\n                        $(\"#edit_item_salt_key\").addClass(\"hidden\");\n                    }\n\n                    // clean some not used fields\n                    //$(\"#item_history_log, #edit_past_pwds, #hid_files, #item_edit_list_files\").html(\"\");\n\n                    //Show detail item\n                    if (data.show_detail_option == \"0\") {\n                        $(\"#item_details_ok\").removeClass(\"hidden\");\n                        $(\"#item_details_expired, #item_details_expired_full\").addClass(\"hidden\");\n                    }if (data.show_detail_option == \"1\") {\n                        $(\"#item_details_ok, #item_details_expired\").removeClass(\"hidden\");\n                        $(\"#item_details_expired_full\").addClass(\"hidden\");\n                    } else if (data.show_detail_option == \"2\") {\n                        $(\"#item_details_ok, #item_details_expired, #item_details_expired_full\").addClass(\"hidden\");\n                    }\n                    $(\"#item_details_nok\").addClass(\"hidden\");\n                    $(\"#fileclass\"+data.id).addClass(\"fileselected\");\n                    $(\"item_editable\").val(0);\n\n                    if (data.show_details == \"1\" && data.show_detail_option != \"2\") {\n                        //unprotect data\n                        data.login = unsanitizeString(data.login);\n\n                        $(\"#id_files\").html(\"\");\n\n                        //Display details\n                        $(\"#id_label\").html(data.label);\n                        $(\"#hid_label\").val(unsanitizeString(data.label));\n                        if (data.pw === \"\") {\n                            $(\"#id_pw\").html(\"\");\n                        } else {\n                            $(\"#id_pw\").html('<?php echo $var['hidden_asterisk']; ?>');\n                        }\n                        $(\"#hid_pw\").val(unsanitizeString(data.pw));\n                        if (data.url != \"\") {\n                            $(\"#id_url\").html(data.url+data.link);\n                            $(\"#hid_url\").val(data.url);\n                        } else {\n                            $(\"#id_url\").html(\"\");\n                            $(\"#hid_url\").val(\"\");\n                        }\n                        $(\"#id_desc\").html(data.description);\n                        $(\"#hid_desc\").val(data.description);\n                        $(\"#id_login\").html(data.login);\n                        $(\"#hid_login\").val(data.login);\n                        $(\"#id_email\").html(data.email);\n                        $(\"#hid_email\").val(data.email);\n                        //prepare nice list of users / groups\n                        var tmp_arr = data.id_restricted_to.split(\";\");\n                        var html_users = \"\";\n                        for (var i=0; i<tmp_arr.length; i++) {\n                            if (tmp_arr[i] !== \"\") html_users += \"<span class='round-grey'><i style='margin-right:2px;' class='fa fa-user fa-sm'></i>\"+tmp_arr[i]+\"</span>\";\n                        }\n                        var tmp_arr = data.id_restricted_to_roles.split(\";\");\n                        var html_groups = \"\";\n                        for (var i=0; i<tmp_arr.length; i++) {\n                            if (tmp_arr[i] !== \"\") html_groups += \"<span class='round-grey'><i style='margin-right:2px;' class='fa fa-group fa-sm'></i>\"+tmp_arr[i]+\"</span>\";\n                        }\n                        $(\"#id_restricted_to\").html(\n                            html_users+\n                            html_groups\n                        );\n                        $(\"#hid_restricted_to\").val(data.id_restricted_to);\n                        $(\"#hid_restricted_to_roles\").val(data.id_restricted_to_roles);\n                        $(\"#id_tags\").html(data.tags);\n                        // extract real tags list\n                        var item_tag = \"\";\n                        $(\"span.item_tag\").each(function(){\n                            if (item_tag == \"\") item_tag = $(this).text();\n                            else item_tag += \" \"+$(this).text();\n                        });\n                        $(\"#hid_tags\").val(item_tag);\n                        $(\"#hid_anyone_can_modify\").val(data.anyone_can_modify);\n                        $(\"#id_categorie\").val(data.folder);\n                        $(\"#id_item\").val(data.id);\n                        $(\"#id_kbs\").html(data.links_to_kbs);\n                        $(\".tip\").tooltipster({\n                            maxWidth: 400,\n                            contentAsHTML: true,\n                            multiple: true\n                        });\n\n                        // ---\n                        // Show Field values\n                        $(\".fields\").val(\"\");\n                        $(\".fields_div\").html(\"\");\n                        // If no CF then hide\n                        if (data.fields === \"\") {\n                            $(\".tr_fields\").addClass(\"hidden\");\n                        } else {\n                            $(\".tr_cf, .tr_fields\").removeClass(\"hidden\");\n                            var liste = data.fields.split('_|_');\n                            for (var i=0; i<liste.length; i++) {\n                                var field = liste[i].split('~~');\n                                $(\"#cf_tr_\" + field[0] + \", #tr_catfield_\" + field[2]).show();\n                                $('#hid_field_' + field[0] + '_' + field[2]).val(field[1]);\n                                if (field[3] === \"masked\") {\n                                    $('#id_field_' + field[0] + '_' + field[2])\n                                        .html('<?php echo $var['hidden_asterisk']; ?>');\n                                } else {\n                                    $('#id_field_' + field[0] + '_' + field[2])\n                                        .html(field[1]);\n                                }\n                            }\n                        }\n\n                        //Anyone can modify button\n                        if (data.anyone_can_modify == \"1\") {\n                            $(\"#edit_anyone_can_modify\").attr('checked', true);\n                            $(\"#new_history_entry_form\").show();\n                        } else {\n                            $(\"#edit_anyone_can_modify\").attr('checked', false);\n                            $(\"#new_history_entry_form\").addClass(\"hidden\");\n                        }\n\n                        //Show to be deleted in case activated\n                        if (data.to_be_deleted == \"not_enabled\") {\n                            $(\"#edit_to_be_deleted\").addClass(\"hidden\");\n                        } else {\n                            $(\"#edit_to_be_deleted\").show();\n                            if (data.to_be_deleted != \"\") {\n                                $(\"#edit_enable_delete_after_consultation\").attr(\"checked\",true);\n                                if (data.to_be_deleted_type == 2) {\n                                    $(\"#edit_times_before_deletion\").val(\"\");\n                                    $(\"#edit_deletion_after_date\").val(data.to_be_deleted);\n                                } else {\n                                    $(\"#edit_times_before_deletion\").val(data.to_be_deleted);\n                                    $(\"#edit_deletion_after_date\").val(\"\");\n                                }\n                            } else {\n                                $(\"#edit_enable_delete_after_consultation\").attr(\"checked\",false);\n                                $(\"#edit_times_before_deletion, #edit_deletion_after_date\").val(\"\");\n                            }\n                        }\n\n                        //manage buttons\n                        if ($(\"#user_is_read_only\").val() == 1) {\n                            $('#menu_button_add_item, #menu_button_edit_item, #menu_button_del_item, #menu_button_copy_item').attr('disabled', 'disabled');\n                        } else if (data.user_can_modify == 0) {\n                            $('#menu_button_edit_item, #menu_button_del_item, #menu_button_copy_item').attr('disabled', 'disabled');\n                        } else if (data.restricted == \"1\" || data.user_can_modify == \"1\") {\n                            //$(\"#menu_button_edit_item, #menu_button_del_item, #menu_button_copy_item\").prop(\"disabled\", false);\n                            var param = \"#menu_button_edit_item, #menu_button_del_item, #menu_button_copy_item\";\n                            $(\"#new_history_entry_form\").show();\n                        } else {\n                            //$(\"#menu_button_add_item, #menu_button_copy_item\").prop(\"disabled\", false);\n                            var param = \"#menu_button_del_item, #menu_button_copy_item\";\n                            $(\"#new_history_entry_form\").show();\n                        }\n                        //$(\"#menu_button_show_pw, #menu_button_copy_pw, #menu_button_copy_login, #menu_button_copy_link, #menu_button_history\").prop(\"disabled\", false);\n\n                        // disable share button for personal folder\n                        if ($(\"#recherche_group_pf\").val() == 1) {\n                            $(\"#menu_button_share, #menu_button_otv\").attr('disabled', 'disabled');\n                        } else {\n                            $(\"#menu_button_share, #menu_button_otv\").prop(\"disabled\", false);\n                        }\n\n                        //Manage to deleted information\n                        if (data.to_be_deleted != 0 && data.to_be_deleted != null && data.to_be_deleted != \"not_enabled\") {\n                            $('#item_extra_info')\n                                .html(\"<b><i class='fa fa-bell-o mi-red'></i></b>&nbsp;\")\n                                .attr(\"title\", \"<?php echo addslashes($LANG['automatic_deletion_activated']); ?>\");\n                            $('#item_extra_info').tooltipster({multiple: true});\n                        } else {\n                            $('#item_extra_info').html(\"\");\n                        }\n\n                        if (data.notification_status == 0 && data.id_user == <?php echo $_SESSION['user_id']; ?>) {\n                            $('#menu_button_notify')\n                                .prop(\"disabled\", false)\n                                .attr('title','<?php echo addslashes($LANG['enable_notify']); ?>')\n                                .attr('onclick','notify_click(\\'true\\')');\n                            $('#div_notify').attr('class', '<i class=\"fa fa-bell mi-green\"></i>&nbsp;');\n                        } else if (data.notification_status == 1 && data.id_user == <?php echo $_SESSION['user_id']; ?>) {\n                            $('#menu_button_notify')\n                                .prop(\"disabled\", false)\n                                .attr('title','<?php echo addslashes($LANG['disable_notify']); ?>')\n                                .attr('onclick','notify_click(\\'false\\')');\n                            $('#div_notify').attr('class', '<i class=\"fa fa-bell-slash mi-red\"></i>&nbsp;');\n                            $('#item_extra_info').html(\"<i><i class=\\'fa fa-bell mi-green\\'></i>&nbsp;<?php echo addslashes($LANG['notify_activated']); ?></i>\");\n                        } else {\n                            $('#menu_button_notify').attr('disabled', 'disabled');\n                            $('#div_notify').attr('class', '<i class=\"fa fa-bell mi-green\"></i>&nbsp;');\n                        }\n\n                        //Prepare clipboard copies\n                        if (data.pw != \"\") {\n                            var clipboard_pw = new Clipboard(\"#menu_button_copy_pw, #button_quick_pw_copy\", {\n                                text: function() {\n                                    return (unsanitizeString(data.pw));\n                                }\n                            });\n                            clipboard_pw.on('success', function(e) {\n                                $(\"#message_box\").html(\"<?php echo addslashes($LANG['pw_copied_clipboard']); ?>\").show().fadeOut(1000);\n                                itemLog(\"item_password_copied\");\n\n                                e.clearSelection();\n                            });\n\n                            $(\"#button_quick_pw_copy\").show();\n                        } else {\n                            $(\"#button_quick_pw_copy\").addClass(\"hidden\");\n                        }\n                        if (data.login != \"\") {\n                            var clipboard_login = new Clipboard(\"#menu_button_copy_login, #button_quick_login_copy\", {\n                                text: function() {\n                                    return (data.login);\n                                }\n                            });\n                            clipboard_login.on('success', function(e) {\n                                $(\"#message_box\").html(\"<?php echo addslashes($LANG['login_copied_clipboard']); ?>\").show().fadeOut(1000);\n\n                                e.clearSelection();\n                            });\n                            $(\"#button_quick_login_copy\").show();\n                        } else {\n                            $(\"#button_quick_login_copy\").addClass(\"hidden\");\n                        }\n                        // #525\n                        if (data.url != \"\") {\n                            var clipboard_url = new Clipboard(\"#menu_button_copy_url\", {\n                                text: function() {\n                                    return unsanitizeString(data.url);\n                                }\n                            });\n                            clipboard_url.on('success', function(e) {\n                                $(\"#message_box\").html(\"<?php echo addslashes($LANG['url_copied_clipboard']); ?>\").show().fadeOut(1000);\n\n                                e.clearSelection();\n                            });\n                        }\n\n                        //prepare link to clipboard\n                        var clipboard_link = new Clipboard(\"#menu_button_copy_link\", {\n                            text: function() {\n                                return \"<?php echo $SETTINGS['cpassman_url']; ?>\"+\"/index.php?page=items&group=\"+data.folder+\"&id=\"+data.id;\n                            }\n                        });\n                        clipboard_link.on('success', function(e) {\n                            $(\"#message_box\").html(\"<?php echo addslashes($LANG['url_copied']); ?>\").show().fadeOut(1000);\n\n                            e.clearSelection();\n                        });\n\n\n                        //set if user can edit\n                        if (data.restricted == \"1\" || data.user_can_modify == \"1\") {\n                            $(\"#item_editable\").val(1);\n                        }\n\n                        //Manage double click\n                        if (open_edit === true && (data.restricted == \"1\" || data.user_can_modify == \"1\")) {\n                            open_edit_item_div(\n                            <?php if (isset($SETTINGS['restricted_to_roles']) && $SETTINGS['restricted_to_roles'] == 1) {\n    echo 1;\n} else {\n    echo 0;\n}?>);\n                        }\n\n                        // tags\n                        $(\".round-grey\").addClass(\"ui-state-highlight ui-corner-all\");\n\n                        // continue loading data\n                        showDetailsStep2(id, param);\n\n                    } else if (data.show_details === \"1\" && data.show_detail_option === \"2\") {\n                        $(\"#item_details_nok\").addClass(\"hidden\");\n                        $(\"#item_details_ok\").addClass(\"hidden\");\n                        $(\"#item_details_expired_full\").show();\n                        $(\"#menu_button_edit_item, #menu_button_del_item, #menu_button_copy_item, #menu_button_add_fav, #menu_button_del_fav, #menu_button_show_pw, #menu_button_copy_pw, #menu_button_copy_login, #menu_button_copy_link\").attr(\"disabled\",\"disabled\");\n                        $(\"#div_loading\").addClass(\"hidden\");\n                    } else {\n                        //Dont show details\n                        $(\"#item_details_nok\").removeClass(\"hidden\");\n                        $(\"#item_details_nok_restriction_list\").html('<div style=\"margin:10px 0 0 20px;\"><b><?php echo addslashes($LANG['author']); ?>: </b>' + data.author + '<br /><b><?php echo addslashes($LANG['restricted_to']); ?>: </b>' + data.restricted_to + '<br /><br /><u><a href=\"#\" onclick=\"SendMail(\\'request_access_to_author\\',\\'' + data.id + ',' + data.id_user + '\\',\\'<?php echo $_SESSION['key']; ?>\\',\\'<?php echo addslashes($LANG['forgot_my_pw_email_sent']); ?>\\')\"><?php echo addslashes($LANG['request_access_ot_item']); ?></a></u></div>');\n                        $(\"#item_details_ok\").addClass(\"hidden\");\n                        $(\"#item_details_expired\").addClass(\"hidden\");\n                        $(\"#item_details_expired_full\").addClass(\"hidden\");\n                        $(\"#menu_button_edit_item, #menu_button_del_item, #menu_button_copy_item, #menu_button_add_fav, #menu_button_del_fav, #menu_button_show_pw, #menu_button_copy_pw, #menu_button_copy_login, #menu_button_copy_link\").attr(\"disabled\",\"disabled\");\n                        $(\"#div_loading\").addClass(\"hidden\");\n                    }\n                    $(\"#request_ongoing\").val(\"\");\n                }\n           );\n\n            if (id_tree != \"\" && id_tree != $(\"#hid_cat\").val()) {\n                refreshTree(id_tree, \"0\");\n            }\n\n           // statistic\n           /*$.post(\n                \"sources/main.queries.php\",\n                {\n                    type                : 'item_stat',\n                    id                  : id,\n                    scope                : \"item\"\n                },\n                function(data) {\n\n                }\n            );*/\n       }\n    //Store Item id shown\n    $(\"#request_lastItem\").val(id);\n    }\n}\n\n\n/*\n* Loading Item details step 2\n*/\nfunction showDetailsStep2(id, param)\n{\n    $(\"#div_loading\").removeClass(\"hidden\");\n    $.post(\n        \"sources/items.queries.php\",\n        {\n        type    : \"showDetailsStep2\",\n        id      : id\n        },\n        function(data) {\n            //decrypt data\n            try {\n                data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n            } catch (e) {\n                // error\n                $(\"#div_loading\").addClass(\"hidden\");\n                $(\"#request_ongoing\").val(\"\");\n                $(\"#div_dialog_message_text\").html(\"An error appears. Answer from Server cannot be parsed!<br />Returned data:<br />\"+data);\n                $(\"#div_dialog_message\").dialog(\"open\");\n\n                return;\n            }\n\n            if (data.error !== \"\") {\n                $(\"#div_dialog_message_text\").html(data.error_text);\n                $(\"#div_dialog_message\").show();\n                return false;\n            }\n\n            $(\"#item_history_log\").html(htmlspecialchars_decode(data.history));\n            $(\"#edit_past_pwds\").attr('title', htmlspecialchars_decode(data.history_of_pwds));\n            $(\"#edit_past_pwds_div\").html(htmlspecialchars_decode(data.history_of_pwds));\n\n            $(\"#id_files\").html(data.files_id);\n            $(\"#hid_files\").val(data.files_id);\n            $(\"#item_edit_list_files\").html(data.files_edit);\n\n            //$(\"#div_last_items\").html(htmlspecialchars_decode(data.div_last_items));\n\n            // function calling image lightbox when clicking on link\n            $(\"a.image_dialog\").click(function(event) {\n                event.preventDefault();\n                PreviewImage($(this).attr(\"href\"),$(this).attr(\"title\"));\n            });\n\n            //Set favourites icon\n            if (data.favourite == \"1\") {\n                $(\"#menu_button_add_fav\").attr(\"disabled\",\"disabled\");\n                $(\"#menu_button_del_fav\").prop(\"disabled\", false);\n            } else {\n                $(\"#menu_button_add_fav\").prop(\"disabled\", false);\n                $(\"#menu_button_del_fav\").attr(\"disabled\",\"disabled\");\n            }\n\n            // set indicator if item has change proposal\n            if (parseInt(data.has_change_proposal) > 0) {\n                $(\"#item_extra_info\").prepend('<i class=\"fa fa-lightbulb-o fa-sm mi-yellow tip\" title=\"<?php echo addslashes($LANG['item_has_change_proposal']); ?>\" onclick=\"\"></i>&nbsp;');\n            }\n\n            $(param).prop(\"disabled\", false);\n            $(\"#menu_button_show_pw, #menu_button_copy_pw, #menu_button_copy_login, #menu_button_copy_link, #menu_button_history\").prop(\"disabled\", false);\n            $(\"#div_loading\").addClass(\"hidden\");\n\n            $(\".tip\").tooltipster({multiple: true});\n\n            // refresh\n            if ($(\"#hid_cat\").val() !== \"\") {\n                refreshListLastSeenItems();\n            }\n         }\n     );\n};\n\n/*\n   * FUNCTION\n   * Launch an action when clicking on a quick icon\n   * $action = 0 => Make not favorite\n   * $action = 1 => Make favorite\n*/\nfunction ActionOnQuickIcon(id, action)\n{\n    //change quick icon\n    if (action == 1) {\n        $(\"#quick_icon_fav_\"+id).html(\"<i class='fa fa-sm fa-star mi-yellow' onclick='ActionOnQuickIcon(\"+id+\",0)'></i>\");\n    } else if (action == 0) {\n        $(\"#quick_icon_fav_\"+id).html(\"<i class='fa fa-sm fa-star-o' onclick='ActionOnQuickIcon(\"+id+\",1)'></i>\");\n    }\n\n    //Send query\n    LoadingPage();\n    $.post(\"sources/items.queries.php\",\n        {\n            type    : 'action_on_quick_icon',\n            id      : id,\n            action  : action\n        },\n        function(data) {\n            LoadingPage();\n            displayMessage(\"<?php echo addslashes($LANG['alert_message_done']); ?>\");\n        }\n   );\n}\n\n//###########\n//## FUNCTION : prepare new folder dialogbox\n//###########\nfunction open_add_group_div()\n{\n    if ($(\"#user_is_read_only\").length && $(\"#user_is_read_only\").val() == 1) {\n        displayMessage(\"<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n        return false;\n    }\n\n    $(\"#div_loading\").removeClass(\"hidden\");\n\n    // check if read only or forbidden\n    if (RecupComplexite($('#hid_cat').val(), 0, \"create_folder\") == 0) {\n        return false;\n    }\n\n    //Select the actual folder in the dialogbox\n    $('#new_rep_groupe option[value=' + $('#hid_cat').val() + ']').prop('selected', true);\n    $('#div_ajout_rep').dialog('open');\n    $(\"#div_loading\").addClass(\"hidden\");\n}\n\n//###########\n//## FUNCTION : prepare editing folder dialogbox\n//###########\nfunction open_edit_group_div()\n{\n    if ($(\"#user_is_read_only\").length && $(\"#user_is_read_only\").val() == 1) {\n        displayMessage(\"<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n        return false;\n    }\n\n    $(\"#div_loading\").removeClass(\"hidden\");\n\n    // check if read only or forbidden\n    if (RecupComplexite($('#hid_cat').val(), 0, \"edit_folder\") == 0) {\n        return false;\n    }\n\n    //Select the actual forlder in the dialogbox\n    $('#edit_folder_folder option[value=' + $('#hid_cat').val() + ']').prop('selected', true);\n    $('#edit_folder_title').val($.trim($('#edit_folder_folder :selected').text()));\n    $('#edit_folder_complexity').val($('#complexite_groupe').val());\n    $('#div_editer_rep').dialog('open');\n    $(\"#div_loading\").addClass(\"hidden\");\n}\n\n//###########\n//## FUNCTION : prepare moving folder dialogbox\n//###########\nfunction open_move_group_div()\n{\n    if ($.inArray($(\"#hid_cat\").val(), $(\"#personal_visible_groups_list\").val().split(',')) != -1 && $(\"#personal_sk_set\").val() === \"0\") {\n        displayMessage(\"<i class='fa fa-warning'></i>&nbsp;<?php echo addslashes($LANG['error_personal_sk_expected']); ?>\");\n        return false;\n    }\n\n    if ($(\"#hid_cat\").val() == \"<?php if (isset($_SESSION['personal_folders'][0])) {\n    echo $_SESSION['personal_folders'][0];\n} else {\n    echo \"\";\n}\n?>\") {\n        displayMessage(\"<i class='fa fa-warning'></i>&nbsp;<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n        return false;\n    }\n    if ($(\"#user_is_read_only\").length && $(\"#user_is_read_only\").val() == 1) {\n        displayMessage(\"<i class='fa fa-warning'></i>&nbsp;<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n        return false;\n    }\n    $(\"#div_loading\").removeClass(\"hidden\");\n\n    // check if read only or forbidden\n    if (RecupComplexite($('#hid_cat').val(), 0) == 0) return false;\n\n    //Select the actual folder in the dialogbox\n    //$('#move_folder_id option[value=' + $('#hid_cat').val() + ']').prop('selected', true);\n    $('#move_folder_title').html($.trim($('#move_folder_id :selected').text())+\" [id\"+$('#hid_cat').val()+\"]\");\n    $('#move_folder_id').val(0);\n    $('#div_move_folder').dialog('open');\n    $(\"#div_loading\").addClass(\"hidden\");\n}\n\n//###########\n//## FUNCTION : prepare delete folder dialogbox\n//###########\nfunction open_del_group_div()\n{\n    if ($(\"#user_is_read_only\").length && $(\"#user_is_read_only\").val() == 1) {\n        displayMessage(\"<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n        return false;\n    }\n    $(\"#div_loading\").removeClass(\"hidden\");\n\n\n    // check if read only or forbidden\n    if (RecupComplexite($('#hid_cat').val(), 0, \"delete_folder\") == 0) {\n        return false;\n    } else {\n        $('#div_supprimer_rep').dialog('open');\n        $('#delete_rep_groupe option[value=' + $('#hid_cat').val() + ']').prop('selected', true);\n        $(\"#div_loading\").addClass(\"hidden\");\n    }\n}\n\n//###########\n//## FUNCTION : prepare new item dialogbox\n//###########\nfunction open_add_item_div()\n{\n    LoadingPage();\n\n    //Check if personal SK is needed and set\n    if ($('#recherche_group_pf').val() == 1 && $('#personal_sk_set').val() == 0) {\n        $(\"#div_dialog_message_text\").html(\"<div style='font-size:16px;'><span class='ui-icon ui-icon-alert' style='float: left; margin-right: .3em;'><\\/span><?php echo addslashes($LANG['alert_message_personal_sk_missing']); ?><\\/div>\");\n        LoadingPage();\n        $(\"#div_dialog_message\").dialog(\"open\");\n    } else if ($(\"#hid_cat\").val() == \"\") {\n        LoadingPage();\n        $(\"#div_dialog_message_text\").html(\"<div style='font-size:16px;'><span class='ui-icon ui-icon-alert' style='float: left; margin-right: .3em;'><\\/span><?php echo addslashes($LANG['error_no_selected_folder']); ?><\\/div>\").dialog(\"open\");\n    } else if ($('#recherche_group_pf').val() == 0 || ($('#recherche_group_pf').val() == 1 && $('#personal_sk_set').val() == 1)) {\n        // is user read only and it is not a personal folder\n        if ($('#recherche_group_pf').val() == 0 && $(\"#user_is_read_only\").length && $(\"#user_is_read_only\").val() == \"1\") {\n            displayMessage(\"<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n            LoadingPage();\n            return false;\n        }\n\n        //Select the actual forlder in the dialogbox\n        $('#categorie').val($('#hid_cat').val());\n\n        //Get the associated complexity level\n        var compReturn = RecupComplexite($('#hid_cat').val(), 0);\n\n        // exclude because user is read only\n        if (compReturn == 0) {\n            $(\"#div_loading\").addClass(\"hidden\");\n            return false;\n        }\n\n        //Show WYGIWYS editor\n        CKEDITOR.replace(\n            \"desc\",\n            {\n                toolbar :[[\"Bold\", \"Italic\", \"Strike\", \"-\", \"NumberedList\", \"BulletedList\", \"-\", \"Link\",\"Unlink\",\"-\",\"RemoveFormat\"]],\n                height: 100,\n                language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n            }\n        );\n\n        // prepare select2 for users\n        $(\"#annonce_liste_destinataires\").select2({\n            language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n        });\n\n        if ($(\"#recherche_group_pf\").val() == 1) {\n            $(\"#div_editRestricted\").addClass(\"hidden\");\n        } else {\n            $(\"#div_editRestricted\").show();\n        }\n\n        //open dialog\n        $(\"#div_formulaire_saisi_info\").addClass(\"hidden\").html(\"\");\n        $(\"#div_formulaire_saisi\").dialog(\"open\");\n    }\n}\n\n//###########\n//## FUNCTION : prepare editing item dialogbox\n//###########\nfunction open_edit_item_div(restricted_to_roles)\n{\n    // is user read only and it is not a personal folder\n    if (\n        ($('#recherche_group_pf').val() === \"0\" && $(\"#user_is_read_only\").length && $(\"#user_is_read_only\").val() === \"1\")\n        || (\n            ($(\"#access_level\").val() === \"1\" || $(\"#access_level\").val() === \"3\")\n            && $('#recherche_group_pf').val() === \"0\"\n        )\n    ) {\n        // Exclude the case where the user is in his PF with PSK set\n        if ($('#recherche_group_pf').val() === \"1\" && $(\"#personal_sk_set\").val() === \"1\") {\n            // do nothing\n        } else {\n            displayMessage(\"<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n            return false;\n        }\n    }\n\n    // If no Item selected, no edition possible\n    if ($(\"#selected_items\").val() == \"\") {\n        displayMessage(\"<?php echo addslashes($LANG['none_selected_text']); ?>\");\n        return false;\n    }\n    $(\"#div_loading\").removeClass(\"hidden\");\n\n    // Get complexity level for this folder\n    // and stop edition if Item edited by another user\n    var compReturn = RecupComplexite($('#hid_cat').val(), 1);\n\n    if (compReturn == 0) {\n        if (CKEDITOR.instances[\"edit_desc\"]) {\n            CKEDITOR.instances[\"edit_desc\"].destroy();\n        }\n        if (CKEDITOR.instances[\"desc\"]) {\n            CKEDITOR.instances[\"desc\"].destroy();\n        }\n        $(\"#div_loading\").addClass(\"hidden\");\n        return;\n    }\n\n    // Check if Item has changed since loaded\n    if (CheckIfItemChanged() == 1) {\n        var tmp = $(\"#\"+$(\"#selected_items\").val()).attr(\"ondblclick\");\n        tmp = tmp.substring(20,tmp.indexOf(\")\"));\n        tmp = tmp.replace(/'/g, \"\").split(',');\n        AfficherDetailsItem(tmp[0], tmp[1], tmp[2], tmp[3], tmp[4], 1, 1);\n        $(\"#div_loading\").addClass(\"hidden\");\n        return;\n    }\n\n    // Show WYGIWYG editor\n    CKEDITOR.replace(\n        \"edit_desc\",\n        {\n            toolbar :[[\"Bold\", \"Italic\", \"Strike\", \"-\", \"NumberedList\", \"BulletedList\", \"-\", \"Link\",\"Unlink\",\"-\",\"RemoveFormat\"]],\n            height: 100,\n            language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n        }\n   );\n    CKEDITOR.instances[\"edit_desc\"].setData($('#hid_desc').val());\n\n    $('#edit_display_title').html($('#hid_label').val());\n    $('#edit_label').val($('#hid_label').val());\n    $('#edit_desc').html($('#hid_desc').val());\n    $('#edit_pw1, #edit_pw2').val($('#hid_pw').val());\n    $(\"#edit_visible_pw\").text($('#hid_pw').val());\n    $('#edit_item_login').val($('#hid_login').val());\n    $('#edit_email').val($('#hid_email').val());\n    $('#edit_url').val($('#hid_url').val());\n    $('#edit_categorie').val($('#id_categorie').val());\n    if ($('#edit_restricted_to').val() != undefined) {\n        $('#edit_restricted_to').val($('#hid_restricted_to').val());\n    }\n    if ($('#edit_restricted_to_roles').val() != undefined) {\n        $('#edit_restricted_to_roles').val($('#hid_restricted_to_roles').val());\n    }\n    $('#edit_tags').val($('#hid_tags').val());\n    if ($('#hid_anyone_can_modify').val() == \"1\") {\n        $('#edit_anyone_can_modify').attr(\"checked\",\"checked\");\n        $('#edit_anyone_can_modify').button(\"refresh\");\n    } else {\n        $('#edit_anyone_can_modify').attr(\"checked\",false);\n        $('#edit_anyone_can_modify').button(\"refresh\");\n    }\n    // fields display\n    if ($('.fields').val() != undefined && $(\"#display_categories\").val() != \"\") {\n        $('.fields').each(function(i){\n            id = $(this).attr('id').split('_');\n            $('#edit_field_' + id[2] + '_' + id[3]).val(htmlspecialchars_decode($('#hid_field_' + id[2] + '_' + id[3]).val()));\n        });\n    }\n\n    //Get list of people in restriction list\n    if ($(\"#recherche_group_pf\").val() == 1) {\n        $(\"#div_editRestricted\").addClass(\"hidden\");\n    } else {\n        $(\"#div_editRestricted\").show();\n        // tick selected users / roles\n        if ($('#edit_restricted_to').val() != undefined) {\n            var list = $('#hid_restricted_to').val().split(';');\n            for (var i=0; i<list.length; i++) {\n                var elem = list[i];\n                if (elem != \"\") {\n                    $(\".folder_rights_user_edit\").each(function() {\n                        if ($(this).attr(\"id\") == elem) {\n                            $(this).prop(\"checked\", true);\n                            exit;\n                        }\n                    });\n                }\n            }\n        }\n\n        if ($('#edit_restricted_to').val() != undefined) {\n            $('#edit_restricted_to_list').empty();\n            if (restricted_to_roles == 1) {\n                //add optgroup\n                var optgroup = $('<optgroup>');\n                optgroup.attr('label', \"<?php echo addslashes($LANG['users']); ?>\");\n                $(\"#edit_restricted_to_list option:last\").wrapAll(optgroup);\n            }\n            /*var liste = $('#input_liste_utilisateurs').val().split(';');\n            for (var i=0; i<liste.length; i++) {\n                var elem = liste[i].split('#');\n                if (elem[0] != \"\") {\n                    $(\"#edit_restricted_to_list\").append(\"<option value='\"+elem[0]+\"'>\"+elem[1]+\"</option>\");\n                    var index = $('#edit_restricted_to').val().lastIndexOf(elem[1]+\";\");\n                    if (index != -1) {\n                        $(\"#edit_restricted_to_list option[value=\"+elem[0]+\"]\").attr('selected', true);\n                    }\n                }\n            }*/\n        }\n\n        //Add list of roles if option is set\n        if (restricted_to_roles == 1 && $('#edit_restricted_to').val() != undefined) {\n            var j = i;\n            //add optgroup\n            var optgroup = $('<optgroup>');\n            optgroup.attr('label', \"<?php echo addslashes($LANG['roles']); ?>\");\n\n            var liste = $('#input_list_roles').val().split(';');\n            for (var i=0; i<liste.length; i++) {\n                var elem = liste[i].split('#');\n                if (elem[0] != \"\") {\n                    $(\"#edit_restricted_to_list\").append(\"<option value='role_\"+elem[0]+\"'>\"+elem[1]+\"</option>\");\n                    var index = $('#edit_restricted_to_roles').val().lastIndexOf(elem[1]+\";\");\n                    if (index != -1) {\n                        $(\"#edit_restricted_to_list option[value='role_\"+elem[0]+\"']\").attr('selected', true);\n                    }\n                    if (i==0) $(\"#edit_restricted_to_list option:last\").wrapAll(optgroup);\n                }\n                j++;\n            }\n        }\n    }\n\n    // prepare select2 for users\n    $(\"#edit_annonce_liste_destinataires\").select2({\n        language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n    });\n\n    // disable folder selection if PF\n    if ($('#recherche_group_pf').val() == \"1\") {\n        $(\"#edit_categorie\").prop(\"disabled\", true);\n    } else {\n        $(\"#edit_categorie\").prop(\"disabled\", false);\n    }\n\n    //open dialog\n    $(\"#div_formulaire_edition_item_info\").addClass(\"hidden\").html(\"\");\n    $(\"#div_formulaire_edition_item\").dialog(\"open\");\n}\n\n//###########\n//## FUNCTION : prepare new item dialogbox\n//###########\nfunction open_del_item_div()\n{\n    // is user read only\n    if (\n        ($('#recherche_group_pf').val() === \"0\" && $(\"#user_is_read_only\").length && $(\"#user_is_read_only\").val() === \"1\")\n        || (\n            ($(\"#access_level\").val() === \"1\" || $(\"#access_level\").val() === \"2\" || $(\"#access_level\").val() === \"3\")\n            && $('#recherche_group_pf').val() === \"0\"\n        )\n    ) {\n        displayMessage(\"<i class='fa fa-warning'></i>&nbsp;<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n        return false;\n    }\n\n    if ($(\"#selected_items\").val() != \"\") {\n        $(\"#div_loading\").removeClass(\"hidden\");\n        //Get the associated complexity level\n        var compReturn = RecupComplexite($('#hid_cat').val(), 0);\n\n        // exclude because user is read only\n        if (compReturn == 0) {\n            return false;\n        }\n\n        $(\"#div_loading\").addClass(\"hidden\");\n        $('#div_del_item').dialog('open');\n    } else {\n        displayMessage(\"<i class='fa fa-warning'></i>&nbsp;<?php echo addslashes($LANG['none_selected_text']); ?>\");\n    }\n}\n\n//###########\n//## FUNCTION : prepare copy item dialogbox\n//###########\nfunction open_copy_item_to_folder_div()\n{\n    // is user read only\n    if ($('#recherche_group_pf').val() == 0 && $(\"#user_is_read_only\").length && $(\"#user_is_read_only\").val() == \"1\") {\n        displayMessage(\"<i class='fa fa-warning'></i>&nbsp;<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n        return false;\n    }\n\n    if ($(\"#selected_items\").val() != \"\") {\n        $('#copy_in_folder').val($(\"#hid_cat\").val());\n        $('#div_copy_item_to_folder').dialog('open');\n    } else {\n        displayMessage(\"<i class='fa fa-warning'></i>&nbsp;<?php echo addslashes($LANG['none_selected_text']); ?>\");\n    }\n}\n\n\n//###########\n//## FUNCTION : Clear HTML tags from a string\n//###########\nfunction clear_html_tags()\n{\n    $.post(\n        \"sources/items.queries.php\",\n        {\n            type    : \"clear_html_tags\",\n            id_item  : $(\"#id_item\").val()\n        },\n        function(data) {\n            data = $.parseJSON(data);\n            $(\"#edit_desc\").val(data.description);\n        }\n   );\n}\n\n//###########\n//## FUNCTION : Permits to delete an attached file\n//###########\nfunction delete_attached_file(file_id)\n{\n    $.post(\n        \"sources/items.queries.php\",\n        {\n            type    : \"delete_attached_file\",\n            file_id : file_id,\n            key     : \"<?php echo $_SESSION['key']; ?>\"\n        },\n        function(data) {\n            $(\"#span_edit_file_\"+file_id).css(\"textDecoration\", \"line-through\");\n        }\n   );\n}\n\n//###########\n//## FUNCTION : Permits to preview an attached image\n//###########\nPreviewImage = function(uri,title) {\n    $(\"#div_loading\").removeClass(\"hidden\");\n    $.post(\n        \"sources/items.queries.php\",\n        {\n            type    : \"image_preview_preparation\",\n            uri     : uri,\n            title   : title,\n            key     : \"<?php echo $_SESSION['key']; ?>\"\n        },\n        function(data) {\n            data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n\n            $(\"#dialog_files\").html('<img id=\"image_files\" src=\"\" />');\n            //Get the HTML Elements\n            imageDialog = $(\"#dialog_files\");\n            imageTag = $('#image_files');\n\n            //Set the image src\n            imageTag.attr(\"src\", data.new_file);\n\n            //When the image has loaded, display the dialog\n            imageTag\n            .error(function() {\n                $(\"#div_loading\").addClass(\"hidden\");\n                displayMessage(\"<?php echo \"<i class='fa fa-exclamation-triangle fa-2x'></i>  \".addslashes($LANG['error_file_is_missing']); ?>\");\n            })\n            .load(function() {\n                $(\"#div_loading\").addClass(\"hidden\");\n                imageDialog.dialog({\n                    modal: true,\n                    resizable: false,\n                    draggable: false,\n                    width: 'auto',\n                    title: title,\n                    open: function( event, ui ) {\n                        // nothing to do\n                    },\n                    close: function (event, ui) {\n                        // delete file\n                        $.post(\n                            \"sources/main.queries.php\",\n                            {\n                                type    : \"file_deletion\",\n                                filename: data.file_path,\n                                key     : \"<?php echo $_SESSION['key']; ?>\"\n                            }\n                        );\n                    }\n                });\n            });\n        }\n    );\n}\n\nfunction notify_click(status)\n{\n    $.post(\"sources/items.queries.php\",\n    {\n        type     : \"notify_a_user\",\n        user_id : <?php echo $_SESSION['user_id']; ?>,\n        status    : status,\n        notify_type : 'on_show',\n        notify_role : '',\n        item_id : $('#id_item').val(),\n        key        : \"<?php echo $_SESSION['key']; ?>\"\n    },\n    function(data) {\n        if (data[0].error == \"something_wrong\") {\n            $(\"#new_show_error\").html('ERROR!!');\n            $(\"#new_show_error\").show();\n        } else {\n            $(\"#new_show_error\").addClass(\"hidden\");\n            if (data[0].new_status == \"true\") {\n                $('#menu_button_notify')\n                    .attr('title','<?php echo addslashes($LANG['disable_notify']); ?>')\n                    .attr('onclick','notify_click(\\'false\\')');\n                $('#div_notify').attr('class', '<i class=\"fa fa-bell-slash mi-green\"></i>&nbsp;');\n                $('#item_extra_info').html(\"<?php echo addslashes($LANG['notify_activated']); ?>\");\n            } else if (data[0].new_status == \"false\") {\n                $('#menu_button_notify')\n                    .attr('title','<?php echo addslashes($LANG['enable_notify']); ?>')\n                    .attr('onclick','notify_click(\\'true\\')');\n                $('#div_notify').attr('class', '<i class=\"fa fa-bell mi-green\"></i>&nbsp;');\n                $('#item_extra_info').html(\"\");\n            }\n        }\n    },\n    \"json\"\n    );\n}\n\n/*\n** Checks if current item title is a duplicate in current folder\n*/\nfunction checkTitleDuplicate(itemTitle, checkInCurrentFolder, checkInAllFolders, textFieldId)\n{\n    $(\"#new_show_error\").html(\"\").addClass(\"hidden\");\n    $(\"#div_formulaire_saisi ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").button(\"enable\");\n    if (itemTitle != \"\") {\n        if (checkInCurrentFolder == \"1\" || checkInAllFolders == \"1\") {\n            //prepare data\n            var data = {\"label\": itemTitle.replace(/\"/g,'&quot;') , \"idFolder\": $('#hid_cat').val()};\n\n            if (checkInCurrentFolder == \"1\") {\n                var typeOfCheck = \"same_folder\";\n            } else {\n                var typeOfCheck = \"all_folders\";\n            }\n\n            // disable Save button\n            $(\"#div_formulaire_saisi ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").button(\"disable\");\n\n            // send query\n            $.post(\n                \"sources/items.queries.php\",\n                {\n                    type    : \"check_for_title_duplicate\",\n                    option  : typeOfCheck,\n                    data    : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key     : \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data) {\n                    if (data[0].duplicate != \"1\") {\n                        $(\"#div_formulaire_saisi ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").button(\"enable\");\n                        // display title\n                        $(\"#\"+textFieldId).html(itemTitle.escapeHTML());\n                    } else {\n                        $(\"#label\").focus();\n                        $(\"#new_show_error\").html(\"<?php echo addslashes($LANG['duplicate_title_in_same_folder']); ?>\").show();\n                    }\n                }\n            );\n        } else {\n            // display title\n            $(\"#\"+textFieldId).html(itemTitle.escapeHTML());\n        }\n    }\n}\n\n/*\n* builds the folders tree\n*/\nfunction refreshTree(node_to_select, do_refresh, refresh_visible_folders)\n{\n    do_refresh = do_refresh || \"\"\n    node_to_select = node_to_select || \"\";\n    refresh_visible_folders = refresh_visible_folders || 1;\n\n    if (refresh_visible_folders !== 1) {\n        $(\"#jstree\").jstree(\"deselect_all\");\n        $('#jstree').jstree(\"select_node\", \"#li_\"+groupe_id);\n        return false;\n    }\n\n    if (do_refresh !== \"0\") {\n        $('#jstree').jstree(true).refresh();\n    }\n\n    if (node_to_select !== \"\") {\n        $(\"#hid_cat\").val(node_to_select);\n        $(\"#jstree\").jstree(\"deselect_all\");\n\n        $('#jstree')\n        .one(\"refresh.jstree\", function (e, data) {\n            data.instance.select_node(\"#li_\"+node_to_select);\n        });\n        //.jstree(\"select_node\", \"#li_\"+node_to_select);\n\n    }\n\n    if (refresh_visible_folders === 1) {\n        refreshVisibleFolders();\n    }\n}\n\n/*\n* refreshes the various lists of folders used in dialogboxes\n*/\nfunction refreshVisibleFolders()\n{\n    $.post(\n        \"sources/items.queries.php\",\n        {\n            type    : \"refresh_visible_folders\",\n            key        : \"<?php echo $_SESSION['key']; ?>\"\n        },\n        function(data) {\n            data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n            //check if format error\n            if (data.error == \"\") {\n                // append new list\n                $(\"#categorie, #edit_categorie, #new_rep_groupe, #edit_folder_folder, #delete_rep_groupe\").find('option').remove().end().append(data.selectVisibleFoldersOptions);\n                $(\"#move_folder_id\").find('option').remove().end().append(data.selectFullVisibleFoldersOptions);\n                $(\"#copy_in_folder\").find('option').remove().end().append(data.selectVisibleActiveFoldersOptions);\n\n                // remove ROOT option if exists\n                $('#edit_folder_folder option[value=\"0\"]').remove();\n                $('#delete_rep_groupe option[value=\"0\"]').remove();\n            }\n        }\n   );\n}\n\n\n//###########\n//## EXECUTE WHEN PAGE IS LOADED\n//###########\n$(function() {\n\n    var clear_tp_clipboard = new Clipboard(\"#but_empty_clipboard\", {\n        text: function() {\n            return \"cleared\";\n        }\n    });\n    clear_tp_clipboard.on('success', function(e) {\n        $(\"#message_box\").html(\"super\").show().fadeOut(1000);\n\n        e.clearSelection();\n    });\n\n    $.ajaxSetup({\n        error: function(jqXHR, exception) {\n            if (jqXHR.status === 0) {\n                console.log('Not connect.\\nVerify Network.');\n            } else if (jqXHR.status == 404) {\n                alert('Requested page not found. [404]');\n            } else if (jqXHR.status == 500) {\n                alert('Internal Server Error [500].');\n            } else if (exception === 'parsererror') {\n                alert('Requested JSON parse failed.');\n            } else if (exception === 'timeout') {\n                alert('Time out error.');\n            } else if (exception === 'abort') {\n                alert('Ajax request aborted.');\n            } else {\n                alert('Uncaught Error.n' + jqXHR.responseText);\n            }\n        }\n    });\n\n    // manage item div resize\n    $( \"#item_details_scroll\" ).resizable({handles: {'s': '#handle'}});\n    $(\"#handle\").dblclick(function() {\n        var inner = $(\"#item_details_scroll\").find('table');\n        var current_height = $(\"#item_details_scroll\").height();\n        $(\"#item_details_scroll\").animate({top:'+='+(current_height-inner.height())}, 0);\n        $(\"#item_details_scroll\").height(inner.outerHeight(true));\n    });\n\n    $('#toppathwrap').addClass(\"hidden\");\n    if ($(\".tr_fields\") != undefined) $(\".tr_fields\").addClass(\"hidden\");\n    //Expend/Collapse jstree\n    $(\"#jstree_close\").click(function() {\n        $(\"#jstree\").jstree(\"close_all\");\n    });\n    $(\"#jstree_open\").click(function() {\n        $(\"#jstree\").jstree(\"open_all\");\n    });\n    $(\"#jstree_search\").keypress(function(e) {\n        if (e.keyCode == 13) {\n            $(\"#jstree\").jstree(\"search\",$(\"#jstree_search\").val());\n        }\n    });\n\n    $(\".quick_menu\").menu({\n        icons: { submenu: \"no-icon\" }\n    });\n    $(\".quick_menu_left\").menu({\n        position: {\n            my : \"right top\",\n            at : \"left top\"\n        }\n    });\n\n    $('.menu_200, .menu_150').on('blur', function () {\n        $(this).addClass(\"hidden\");\n    });\n\n    $(\"#pw_size, #edit_pw_size\").spinner({\n        min:   3,\n        step:  1,\n        numberFormat: \"n\"\n    });\n\n    //Disable menu buttons\n    $('#menu_button_edit_item,#menu_button_del_item,#menu_button_add_fav,#menu_button_del_fav').attr('disabled', 'disabled');\n\n    //DIsable more buttons if read only user\n    if ($(\"#user_is_read_only\").val() == 1) {\n        $('#menu_button_add_item, #menu_button_add_group, #menu_button_edit_group, #menu_button_del_group').attr('disabled', 'disabled');\n    }\n\n    // Autoresize Textareas\n    $(\".items_tree, #items_content\").addClass(\"ui-corner-all\");\n\n    //automatic height\n    var window_height = $(window).height();\n    $(\"#div_items, #content\").height(window_height-170);\n    $(\"#items_center\").height(window_height-390);\n    $(\"#items_list\").height(window_height-440);\n    $(\".items_tree\").height(window_height-160);\n    $(\"#jstree\").height(window_height-185);\n\n    //warning if screen height too short\n    if (parseInt(window_height-440) <= 30) {\n        $(\"#div_dialog_message_text\").html(\"<?php echo addslashes($LANG['warning_screen_height']); ?>\");\n        $(\"#div_dialog_message\").dialog('open');\n    }\n\n    //Evaluate number of items to display - depends on screen height\n    if (parseInt($(\"#nb_items_to_display_once\").val()) || $(\"#nb_items_to_display_once\").val() == \"max\") {\n        //do nothing ... good value\n    } else {\n        //adapt to the screen height\n        $(\"#nb_items_to_display_once\").val(Math.max(Math.round((window_height-450)/23),2));\n    }\n\n    // Build buttons\n    $(\"#custom_pw, #edit_custom_pw\").buttonset();\n    $(\".cpm_button, #anyone_can_modify, #annonce, #edit_anyone_can_modify, #edit_annonce, .button\").button();\n\n    //Build multiselect box\n\n    //Build tree\n    $('#jstree').jstree({\n        \"core\" : {\n            \"animation\" : 0,\n            \"check_callback\" : true,\n            'data' : {\n                'url' : \"./sources/tree.php\",\n                \"dataType\" : \"json\",\n                \"async\" : true,\n                'data' : function (node) {\n                    return { 'id' : node.id.split('_')[1] };\n                }\n            },\n            \"strings\" : {\n                \"Loading ...\" : \"<?php echo addslashes($LANG['loading']); ?>...\"\n            },\n            \"error\" : {\n\n            }\n        },\n        \"plugins\" : [\n            \"state\", \"search\"\n        ]\n    })\n    //search in tree\n    .bind(\"search.jstree\", function (e, data) {\n        if (data.nodes.length == 1) {\n            //open the folder\n            ListerItems($(\"#jstree li>a.jstree-search\").attr('id').split('_')[1], '', 0);\n        }\n    });\n\n    // load list of visible folders for current user\n    refreshVisibleFolders();\n\n    $(\"#add_folder\").click(function() {\n        var posit = $('#item_selected').val();\n        //alert($(\"ul\").text());\n    });\n\n    $(\"#for_searchtext\").addClass(\"hidden\");\n    $(\"#copy_pw_done\").addClass(\"hidden\");\n    $(\"#copy_login_done\").addClass(\"hidden\");\n\n    //PREPARE DIALOGBOXES\n    //=> ADD A NEW GROUP\n    $(\"#div_ajout_rep\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 500,\n        height: 280,\n        title: \"<?php echo addslashes($LANG['item_menu_add_rep']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['save_button']); ?>\": function() {\n                AddNewFolder();\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                $(\"#new_rep_show_error\").html(\"\").addClass(\"hidden\");\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\"#new_rep_show_error\").addClass(\"hidden\");\n            $(\"#new_rep_show_error\").html(\"\");\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n        }\n    });\n    //<=\n    //=> EDIT A GROUP\n    $(\"#div_editer_rep\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 490,\n        height: 280,\n        title: \"<?php echo addslashes($LANG['item_menu_edi_rep']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['save_button']); ?>\": function() {\n                //Do some checks\n                $(\"#edit_rep_show_error\").addClass(\"hidden\");\n                if ($(\"#edit_folder_title\").val() == \"\") {\n                    $(\"#edit_rep_show_error\").html(\"<?php echo addslashes($LANG['error_group_label']); ?>\");\n                    $(\"#edit_rep_show_error\").show();\n                } else if ($(\"#edit_folder_folder\").val() == \"0\") {\n                    $(\"#edit_rep_show_error\").html(\"<?php echo addslashes($LANG['error_group']); ?>\");\n                    $(\"#edit_rep_show_error\").show();\n                } else if ($(\"#edit_folder_complexity\").val() == \"\") {\n                    $(\"#edit_rep_show_error\").html(\"<?php echo addslashes($LANG['error_group_complex']); ?>\");\n                    $(\"#edit_rep_show_error\").show();\n                } else if (/^\\d+$/.test($(\"#edit_folder_title\").val())) {\n                    $(\"#edit_rep_show_error\").html(\"<?php echo addslashes($LANG['error_only_numbers_in_folder_name']); ?>\");\n                    $(\"#edit_rep_show_error\").show();\n                } else {\n                    $(\"#edit_folder_loader\").show();\n                    $(\"#div_editer_rep ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", true);\n\n                    //prepare data\n                    var data = {\"title\": $('#edit_folder_title').val().replace(/\"/g,'&quot;'),\n                        \"complexity\": $('#edit_folder_complexity').val(),\n                        \"folder\": $('#edit_folder_folder').val()};\n\n                    //Send query\n                    $.post(\n                        \"sources/items.queries.php\",\n                        {\n                            type    : \"update_folder\",\n                            data      : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                            key        : \"<?php echo $_SESSION['key']; ?>\"\n                        },\n                        function(data) {\n                            //check if format error\n                            if (data[0].error == \"\") {\n                                refreshTree($('#edit_folder_folder').val());\n                                $(\"#folder_name_\"+$('#edit_folder_folder').val()).text($('#edit_folder_title').val());\n                                $(\"#path_elem_\"+$('#edit_folder_folder').val()).text($('#edit_folder_title').val());\n                                $(\"#fld_\"+$('#edit_folder_folder').val()).html($('#edit_folder_title').val());\n                                $(\"#edit_folder_title\").val($('#edit_folder_title').val());\n                                $(\"#div_editer_rep\").dialog(\"close\");\n                            } else {\n                                if (data[0].error === \"ERR_TITLE_ONLY_WITH_NUMBERS\") {\n                                    $(\"#edit_rep_show_error\").html('<?php echo addslashes($LANG['error_only_numbers_in_folder_name']); ?>').show();\n                                } else {\n                                    $(\"#edit_rep_show_error\").html(data[0].error).show();\n                                }\n\n                            }\n                            $(\"#edit_folder_loader\").addClass(\"hidden\");\n                            $(\"#div_editer_rep ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                        },\n                        \"json\"\n                   );\n                }\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                $(\"#edit_folder_loader\").addClass(\"hidden\");\n                $(\"#edit_rep_show_error\").html(\"\").addClass(\"hidden\");\n                $(\"#div_editer_rep ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n        }\n    });\n    //<=\n\n    // =>\n    $(\"#div_copy_item_to_folder\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 400,\n        height: 250,\n        title: \"<?php echo addslashes($LANG['item_menu_copy_elem']); ?>\",\n        open: function( event, ui ) {\n            $(\"#copy_in_folder\").select2({\n                language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n            });\n            $(\":button:contains('<?php echo addslashes($LANG['ok']); ?>')\").prop(\"disabled\", false);\n            $(\"#copy_item_info\").addClass(\"ui-state-highlight ui-corner-all\").addClass(\"hidden\");\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n            $(\"#div_copy_item_to_folder_item\").html(\"<center>\"+$(\"#id_label\").html()+\"</center>\");\n        },\n        buttons: {\n            \"<?php echo addslashes($LANG['ok']); ?>\": function() {\n                $(\"#copy_item_info\").addClass(\"ui-state-highlight ui-corner-all\").show().html(\"<span><?php echo addslashes($LANG['please_wait']).\" <i class=\\'fa fa-cog fa-spin'></i>\"; ?></span>\");\n                $(\":button:contains('<?php echo addslashes($LANG['ok']); ?>')\").prop(\"disabled\", true);\n                //Send query\n                $.post(\n                    \"sources/items.queries.php\",\n                    {\n                        type        : \"copy_item\",\n                        item_id     : $('#id_item').val(),\n                        source_id   : $('#hid_cat').val(),\n                        dest_id     : $('#copy_in_folder').val(),\n                        key         : \"<?php echo $_SESSION['key']; ?>\"\n                    },\n                    function(data) {\n                        //check if format error\n                        if (data[0].error !== \"\") {\n                            $(\"#copy_item_to_folder_show_error\").html(data[1].error_text).show(1).delay(2000).fadeOut(1000);\n                        }\n                        //if OK\n                        if (data[0].status == \"ok\") {\n                            //window.location.href = \"index.php?page=items&group=\"+$('#copy_in_folder').val()+\"&id=\"+data[1].new_id;\n                            ListerItems($('#copy_in_folder').val(),'', 0);\n                            AfficherDetailsItem(data[1].new_id);\n                            refreshTree($('#copy_in_folder').val());\n                            $(\"#copy_in_folder\").val(\"\");\n                            $(\"#div_copy_item_to_folder\").dialog('close');\n                        }\n                        $(\"#copy_item_info\").addClass(\"hidden\");\n                    },\n                    \"json\"\n               );\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                $(\"#copy_item_to_folder_show_error\").html(\"\").addClass(\"hidden\");\n                $(\"#div_copy_item_to_folder\").dialog('close');\n            }\n        }\n    });\n    // <=\n\n    //=> MOVE A GROUP\n    $(\"#div_move_folder\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 350,\n        height: 250,\n        title: \"<?php echo addslashes($LANG['item_menu_mov_rep']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['save_button']); ?>\": function() {\n                //Do some checks\n                $(\"#move_rep_show_error\").addClass(\"hidden\");\n                if ($(\"#move_folder_id\").val() == \"0\") {\n                    $(\"#move_rep_show_error\").html(\"<?php echo addslashes($LANG['error_group']); ?>\");\n                    $(\"#move_rep_show_error\").show();\n                } else if($('#hid_cat').val() === $('#move_folder_id').val()) {\n                    // do not move to itself\n                    $(\"#move_rep_show_error\").html(\"<?php echo addslashes($LANG['error_not_allowed_to']); ?>\");\n                    $(\"#move_rep_show_error\").show();\n                } else {\n                    $(\"#move_folder_loader\").show();\n                    $(\"#div_editer_rep ~ .ui-dialog-buttonpane\")\n                        .find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\")\n                        .prop(\"disabled\", true);\n\n                    //prepare data\n                    var data = {\"source_folder_id\": $('#hid_cat').val(),\n                        \"target_folder_id\": $('#move_folder_id').val()};\n\n                    //Send query\n                    $.post(\n                        \"sources/items.queries.php\",\n                        {\n                            type    : \"move_folder\",\n                            data    : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                            key     : \"<?php echo $_SESSION['key']; ?>\"\n                        },\n                        function(data) {\n                            //check if format error\n                            if (data[0].error == \"\") {\n                                $(\"#div_move_folder ~ .ui-dialog-buttonpane\")\n                                    .find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                                ListerItems($('#hid_cat').val(), \"\", 0);\n                                $(\"#move_folder_loader\").addClass(\"hidden\");\n                                refreshTree();\n                                $(\"#div_move_folder\").dialog(\"close\");\n                            } else {\n                                $(\"#move_rep_show_error\").html(data[0].error).show();\n                            }\n                            $(\"#move_folder_loader\").addClass(\"hidden\");\n                        },\n                        \"json\"\n                   );\n                }\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                $(\"#edit_rep_show_error\").html(\"\").addClass(\"hidden\");\n                $(\"#div_editer_rep ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                $(\"#move_rep_show_error\").html(\"\").addClass(\"hidden\");\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n        }\n    });\n    //<=\n\n\n    //=> COPY OF FOLDER\n    $(\"#div_copy_folder\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 500,\n        height: 290,\n        title: \"<?php echo addslashes($LANG['copy_folder']); ?>\",\n        close: function () {\n            $(\"#copy_folder_source_id, #copy_folder_destination_id\").children('option').remove();\n            $(\"#div_copy_folder_msg\")\n                .html('')\n                .removeClass(\"ui-state-highlight\")\n                .addClass(\"hidden\");\n        },\n        open: function(event,ui) {\n            $(\"#div_copy_folder ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n\n            // get list of folders\n                $.post(\n                    \"sources/folders.queries.php\",\n                    {\n                        type    : \"get_list_of_folders\",\n                        key     : \"<?php echo $_SESSION['key']; ?>\"\n                    },\n                    function(data) {\n                        $(\"#div_loading\").addClass(\"hidden\");\n\n                        //display to user\n                        $(\"#copy_folder_source_id, #copy_folder_destination_id\").append(data[0].list_folders);\n\n                        $(\"#copy_folder_source_id\").val($(\"#hid_cat\").val());\n                    },\n                    \"json\"\n                );\n        },\n        buttons: {\n            \"<?php echo addslashes($LANG['save_button']); ?>\": function() {\n                //Do some checks\n                if ($(\"#copy_folder_source_id\").val() === \"\" || $(\"#copy_folder_destination_id\").val() === \"\") {\n                    $(\"#div_copy_folder_msg\")\n                        .html('<i class=\"fa fa-warning\"></i>&nbsp;<?php echo addslashes($LANG['error_must_enter_all_fields']); ?>')\n                        .addClass(\"ui-state-error\")\n                        .show().delay(2000).fadeOut(1000);\n                        return false;\n                }\n\n                if ($(\"#copy_folder_source_id\").val() === $(\"#copy_folder_destination_id\").val()) {\n                    $(\"#div_copy_folder_msg\")\n                        .html('<i class=\"fa fa-warning\"></i>&nbsp;<?php echo addslashes($LANG['error_source_and_destination_are_equal']); ?>')\n                        .addClass(\"ui-state-error\")\n                        .show().delay(2000).fadeOut(1000);\n                        return false;\n                }\n\n\n                $(\"#div_copy_folder_msg\")\n                    .html('<i class=\"fa fa-cog fa-spin\"></i>&nbsp;<?php echo addslashes($LANG['please_wait']); ?>')\n                    .addClass(\"ui-state-highlight\")\n                    .show();\n\n                //prepare data\n                var data = {\"source_folder_id\": $('#copy_folder_source_id').val(),\n                    \"target_folder_id\": $('#copy_folder_destination_id').val()};\n\n                //Send query\n                $.post(\n                    \"sources/folders.queries.php\",\n                    {\n                        type    : \"copy_folder\",\n                        data    : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                        key     : \"<?php echo $_SESSION['key']; ?>\"\n                    },\n                    function(data) {\n                        //check if format error\n                        if (data[0].error == \"\") {\n                            $(\"#div_copy_folder ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                            refreshTree();\n                            $(\"#div_copy_folder\").dialog(\"close\");\n                        } else {\n                            $(\"#div_copy_folder_msg\").html(data[0].error).show().delay(2000).fadeOut(1000);\n                        }\n                    },\n                    \"json\"\n                );\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                $(\"#div_copy_folder_msg\").html(\"\").addClass(\"hidden\");\n                $(\"#div_copy_folder ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n                $(this).dialog('close');\n            }\n        }\n    });\n    //<=\n\n    //=> DELETE A GROUP\n    $(\"#div_supprimer_rep\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 600,\n        height: 230,\n        title: \"<?php echo addslashes($LANG['item_menu_del_rep']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['delete']); ?>\": function() {\n                SupprimerFolder();\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n        },\n        close: function() {\n            $(\"#delete_rep_groupe_validate\").prop(\"checked\", false);\n            $(\"#del_rep_show_error\").html(\"\").addClass(\"hidden\");\n        }\n    });\n    //<=\n    //=> ADD A NEW ITEM\n    $(\"#div_formulaire_saisi\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 505,\n        height: 680,\n        title: \"<?php echo addslashes($LANG['item_menu_add_elem']); ?>\",\n        open: function( event, ui ) {\n            $(\".ui-dialog-buttonpane button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").button(\"disabled\");\n        },\n        buttons: {\n            \"<?php echo addslashes($LANG['save_button']); ?>\": function() {\n                $(\"#div_loading\").removeClass(\"hidden\");\n                $(\".ui-dialog-buttonpane button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").button(\"enable\");\n                AjouterItem();\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                //Clear upload queue\n                $('#item_file_queue').html('');\n                //Select 1st tab\n                $(\"#item_tabs\").tabs({ selected: 0 });\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\"#label\").focus();\n            $(\"#visible_pw\").html(\"\");\n            $(\"#item_tabs\").tabs(\"option\", \"active\", 0);\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n\n            // show tab fields ? Not if PersonalFolder\n            if ($(\"#recherche_group_pf\").val() == 1) {\n                if ($(\"#form_tab_fields\") != undefined)\n                    $(\"#item_tabs\").tabs(\"option\", \"hidden\", 3);\n            } else {\n                if ($(\"#form_tab_fields\") != undefined && $(\"#display_categories\").val() != 1)\n                    $(\"#item_tabs\").tabs(\"option\", \"show\", 3);\n            }\n\n            // hide complexity if PF\n            if ($(\"#pf_selected\").val() == 1) {\n                $(\"#expected_complexity\").addClass(\"hidden\");\n            } else {\n                $(\"#expected_complexity\").show();\n            }\n\n            $(\"#categorie\").select2({\n                language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n            });\n        },\n        close: function(event,ui) {\n            if (CKEDITOR.instances[\"desc\"]) {\n                CKEDITOR.instances[\"desc\"].destroy();\n            }\n            $(\"#item_upload_list\").html(\"\");\n            $(\".item_field\").val(\"\");  // clean values in Fields\n            $(\"#pw1\").focus();\n            $(\"#new_show_error\").html(\"\").addClass(\"hidden\");\n            $(\".ui-dialog-buttonpane button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").button(\"enable\");\n            $(\"#div_loading\").addClass(\"hidden\");\n        }\n    });\n    //<=\n    //=> EDITER UN ELEMENT\n    $(\"#div_formulaire_edition_item\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 505,\n        height: 680,\n        title: \"<?php echo addslashes($LANG['item_menu_edi_elem']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['save_button']); ?>\": function() {\n                $(\"#div_formulaire_edition_item ~ .ui-dialog-buttonpane\").find(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", true);\n                EditerItem();\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                //Clear upload queue\n                $('#item_edit_file_queue').html('');\n                //Select 1st tab\n                $(\"#item_edit_tabs\").tabs({ selected: 0 });\n                $(\"#div_loading\").addClass(\"hidden\");\n                //Close dialog box\n                $(this).dialog('close');\n            }\n        },\n        close: function(event,ui) {\n            if (CKEDITOR.instances[\"edit_desc\"]) {\n                CKEDITOR.instances[\"edit_desc\"].destroy();\n            }\n            if (CKEDITOR.instances[\"desc\"]) {\n                CKEDITOR.instances[\"desc\"].destroy();\n            }\n            $(\"#div_loading, #edit_show_error\").addClass(\"hidden\");\n            $(\"#item_edit_upload_list\").html(\"\");\n            $(\".edit_item_field\").val(\"\");  // clean values in Fields\n            //Unlock the Item\n            $.post(\n                \"sources/items.queries.php\",\n                {\n                    type    : \"free_item_for_edition\",\n                    id      : $(\"#id_item\").val(),\n                    key        : \"<?php echo $_SESSION['key']; ?>\"\n                }\n            );\n            $(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n        },\n        open: function(event,ui) {\n            //refresh pw complexity\n            $(\"#item_edit_tabs\").tabs( \"option\", \"active\",1  );\n            $(\"#edit_pw1\").first().focus();\n            $(\"#item_edit_tabs\").tabs( \"option\", \"active\",0  );\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n\n            // show tab fields ? Not if PersonalFolder\n            if ($(\"#recherche_group_pf\").val() == 1) {\n                if ($(\"#edit_item_more\") != undefined) $(\"#edit_item_more\").addClass(\"hidden\");\n            } else {\n                if ($(\"#edit_item_more\") != undefined && $(\"#display_categories\").val() != 1)\n                    $(\"#edit_item_more\").show();\n            }\n            $(\"button:contains('<?php echo addslashes($LANG['save_button']); ?>')\").prop(\"disabled\", false);\n\n            // hide complexity if PF\n            if ($(\"#pf_selected\").val() == 1) {\n                $(\"#edit_expected_complexity\").addClass(\"hidden\");\n            } else {\n                $(\"#edit_expected_complexity\").show();\n            }\n\n            $(\"#edit_categorie\").select2({\n                language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n            });\n\n            // get list of Users\n            $.post(\n                \"sources/items.queries.php\",\n                {\n                    type    : \"build_list_of_users\",\n                    key     : \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data) {\n                    //decrypt data\n                    try {\n                        data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                    } catch (e) {\n                        // error\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#div_dialog_message_text\").html(\"An error appears. Answer from Server cannot be parsed!<br /><br />Returned data:<br />\"+data);\n                        $(\"#div_dialog_message\").show();\n                        return;\n                    }\n\n                    if (data.error === \"\") {\n                        var list = data.list.split(';');\n                        for (var i=0; i<list.length; i++) {\n                            var elem = list[i].split('#');\n                            if (elem[0] != \"\") {\n                                $(\"#edit_restricted_to_list\").append(\"<option value='\"+elem[0]+\"'>\"+elem[1]+\"</option>\");\n                                var index = $('#edit_restricted_to').val().lastIndexOf(elem[1]+\";\");\n                                if (index != -1) {\n                                    $(\"#edit_restricted_to_list option[value=\"+elem[0]+\"]\").attr('selected', true);\n                                }\n                            }\n                        }\n                    }\n                }\n           );\n        }\n    });\n    //<=\n    //=> SUPPRIMER UN ELEMENT\n    $(\"#div_del_item\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 400,\n        height: 220,\n        title: \"<?php echo addslashes($LANG['item_menu_del_elem']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['del_button']); ?>\": function() {\n                $.post(\n                    \"sources/items.queries.php\",\n                    {\n                        type        : \"del_item\",\n                        id          : $(\"#id_item\").val(),\n                        categorie   : $('#hid_cat').val(),\n                        label       : $(\"#hid_label\").val(),\n                        key         : \"<?php echo $_SESSION['key']; ?>\"\n                    },\n                    function(data) {\n                        $(\"#div_loading\").removeClass(\"hidden\");\n\n                        // refresh list of items\n                        $(\"#full_items_list\").html(\"\");\n                        ListerItems($('#hid_cat').val(), \"\", 0)\n\n                        // reload tree\n                        refreshTree($('#hid_cat').val());\n\n                        // clean fields\n                        $(\"#id_label, #id_desc, #id_pw, #id_login, #id_email, #id_url, #id_files, #id_restricted_to ,#id_tags, #id_kbs\").html(\"\");\n                        $(\"#button_quick_login_copy, #button_quick_pw_copy\").addClass(\"hidden\");\n                        $(\"#selected_items\").val(\"\");\n\n                        $(\"#div_loading\").addClass(\"hidden\");\n                    }\n               );\n                $(this).dialog('close');\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n            $(\"#div_del_item_selection\").html(\"<center>\"+$(\"#id_label\").html()+\"</center>\");\n        }\n    });\n    //<=\n    //=> SHOW LINK COPIED DIALOG\n    $(\"#div_item_copied\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 500,\n        height: 200,\n        title: \"<?php echo addslashes($LANG['admin_main']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['close']); ?>\": function() {\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n        }\n    });\n    //<=\n    //=> SHOW HISTORY DIALOG\n    $(\"#div_item_history\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 650,\n        height: 400,\n        title: \"<?php echo addslashes($LANG['history']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['close']); ?>\": function() {\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n\n            // load content\n            const data = {\"id\":$(\"#id_item\").val()};\n            $.post(\n                \"sources/items.queries.php\",\n                {\n                    type    : \"load_item_history\",\n                    data    : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                    key     : \"<?php echo $_SESSION['key']; ?>\"\n                },\n                function(data) {\n                    //decrypt data\n                    try {\n                        data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                    } catch (e) {\n                        // error\n                        $(\"#div_loading\").addClass(\"hidden\");\n                        $(\"#div_dialog_message_text\").html(\"An error appears. Answer from Server cannot be parsed!<br /><br />Returned data:<br />\"+data);\n                        $(\"#div_dialog_message\").show();\n                        return;\n                    }\n\n                    if (data.error === \"\") {\n                        $(\"#item_history_log\").html(data.new_html);\n                    }\n                }\n           );\n        }\n    });\n    //<=\n    //=> SHOW SHARE DIALOG\n    $(\"#div_item_share\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 500,\n        height: 200,\n        title: \"<?php echo addslashes($LANG['share']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['send']); ?>\": function() {\n                $(\"#div_item_share_error\").addClass(\"hidden\");\n                if (IsValidEmail($(\"#item_share_email\").val())) {    //check if email format is ok\n                    $(\"#div_item_share_status\").show();\n                    $.post(\n                        \"sources/items.queries.php\",\n                        {\n                            type    : \"send_email\",\n                            id      : $(\"#id_item\").val(),\n                            receipt    : $(\"#item_share_email\").val(),\n                            cat      : \"share_this_item\",\n                            key        : \"<?php echo $_SESSION['key']; ?>\"\n                        },\n                        function(data) {\n                            $(\"#div_item_share_status\").html(\"\").addClass(\"hidden\");\n                            if (data[0].error == \"\") {\n                                $(\"#div_item_share_error\").html(\"<?php echo addslashes($LANG['share_sent_ok']); ?>\").show();\n                            } else {\n                                $(\"#div_item_share_error\").html(data[0].message).show();\n                            }\n                        },\n                        \"json\"\n                   );\n                } else {\n                    $(\"#div_item_share_error\").html(\"<?php echo addslashes($LANG['bad_email_format']); ?>\").show();\n                }\n            },\n            \"<?php echo addslashes($LANG['close']); ?>\": function() {\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n        }\n    });\n    //<=\n    //=> SHOW ITEM UPDATED DIALOG\n    $(\"#div_item_updated\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 300,\n        height: 100,\n        title: \"<?php echo addslashes($LANG['share']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['ok']); ?>\": function() {\n\n            }\n        },\n        open: function(event,ui) {\n            $(\".ui-tooltip\").siblings(\".tooltip\").remove();\n        }\n    });\n    //<=\n    //=> SHOW SHARE DIALOG\n    $(\"#div_suggest_change\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 750,\n        height: 450,\n        title: \"<?php echo addslashes($LANG['suggest_password_change']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['ok']); ?>\": function() {\n                $(\"#div_suggest_change_wait\").html('<i class=\"fa fa-cog fa-spin fa-2x\"></i>').show().removeClass(\"ui-state-error\");\n\n                // do checks\n                if (!IsValidEmail($(\"#email_change\").val()) && $(\"#email_change\").val() !== \"\") {\n                    $(\"#div_suggest_change_wait\").html('<i class=\"fa fa-warning fa-lg\"></i>&nbsp;<?php echo addslashes($LANG['email_format_is_not_correct']); ?>').show(1).delay(2000).fadeOut(1000).addClass(\"ui-state-error\");\n                    return false;\n                }\n                if (!validateURL($(\"#url_change\").val()) && $(\"#url_change\").val() !== \"\") {\n                    $(\"#div_suggest_change_wait\").html('<i class=\"fa fa-warning fa-lg\"></i>&nbsp;<?php echo addslashes($LANG['url_format_is_not_correct']); ?>').show(1).delay(2000).fadeOut(1000).addClass(\"ui-state-error\");\n                    return false;\n                }\n\n                // prepare changes\n                var data = {\"label\": $(\"#label_change\").val(), \"pwd\": $(\"#pwd_change\").val(),\n                    \"url\": $(\"#url_change\").val(), \"login\": $(\"#login_change\").val(),\n                    \"email\": $(\"#email_change\").val(), \"folder\": $(\"#hid_cat\").val(),\n                    \"comment\": $(\"#comment_change\").val(), \"item_id\": $(\"#id_item\").val()};\n\n                $.post(\n                    \"sources/items.queries.php\",\n                    {\n                        type    : \"suggest_item_change\",\n                        data    : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n                        id      : $(\"#id_item\").val(),\n                        key     : \"<?php echo $_SESSION['key']; ?>\"\n                    },\n                    function(data) {\n                        if (data[0].error === \"\") {\n                            $(\"#div_suggest_change_wait\").html(\"<?php echo addslashes($LANG['suggestion_done']); ?>\").show(1).delay(1500).fadeOut(1000);\n\n                            // set indicator if item has change proposal\n                            $(\"#item_extra_info\").prepend('<i class=\"fa fa-lightbulb-o fa-sm mi-yellow tip\" title=\"<?php echo addslashes($LANG['item_has_change_proposal']); ?>\" onclick=\"\"></i>&nbsp;');\n                            $(\".tip\").tooltipster({multiple: true});\n\n                            setTimeout(\n                                function() {\n                                    $(\"#div_suggest_change\").dialog(\"close\");\n                                },\n                                500\n                            );\n                        }\n                    },\n                    \"json\"\n               );\n            },\n            \"<?php echo addslashes($LANG['close']); ?>\": function() {\n                $(this).dialog('close');\n            }\n        },\n        open: function(event,ui) {\n            $(\"#div_suggest_change_html\")\n            .html(\n                '<label class=\"form_label_100\" style=\"padding:4px;\"><?php echo addslashes($LANG['label']); ?></label><input type=\"text\" id=\"label_change\" value=\"'+$(\"#hid_label\").val()+'\" class=\"input_text_80 ui-widget-content ui-corner-all\">' +\n                '<label class=\"form_label_100\" style=\"padding:4px;\"><?php echo addslashes($LANG['pw']); ?></label><input type=\"text\" id=\"pwd_change\" value=\"\" class=\"input_text_80 ui-widget-content ui-corner-all\">' +\n                '&nbsp;<i class=\"fa fa-info-circle fa-lg tip\" title=\"<?php echo addslashes($LANG['suggest_change_password_blank']); ?>\"></i>' +\n                //'<label class=\"form_label_100\" style=\"padding:4px;\"><?php echo addslashes($LANG['description']); ?></label><textarea id=\"description_change_change\" class=\"input_text_80 ui-widget-content ui-corner-all\">'+$(\"#hid_desc\").val()+'</textarea>' +\n                '<label class=\"form_label_100\" style=\"padding:4px;\"><?php echo addslashes($LANG['index_login']); ?></label><input type=\"text\" id=\"login_change\" value=\"'+$(\"#hid_login\").val()+'\" class=\"input_text_80 ui-widget-content ui-corner-all\">' +\n                '<label class=\"form_label_100\" style=\"padding:4px;\"><?php echo addslashes($LANG['email']); ?></label><input type=\"text\" id=\"email_change\" value=\"'+$(\"#hid_email\").val()+'\" class=\"input_text_80 ui-widget-content ui-corner-all\">' +\n                '<label class=\"form_label_100\" style=\"padding:4px;\"><?php echo addslashes($LANG['url']); ?></label><input type=\"text\" id=\"url_change\" value=\"'+$(\"#hid_url\").val()+'\" class=\"input_text_80 ui-widget-content ui-corner-all\">' +\n                '<label class=\"form_label_100\" style=\"padding:4px;\"><?php echo addslashes($LANG['comment']); ?></label><input type=\"text\" id=\"comment_change\" value=\"\" class=\"input_text_80 ui-widget-content ui-corner-all\">'\n            )\n            .show();\n            $(\".tip\").tooltipster({multiple: true});\n        }\n    });\n    //<=\n\n    // => ATTACHMENTS INIT\n    var uploader_attachments = new plupload.Uploader({\n        runtimes : \"html5,flash,silverlight,html4\",\n        browse_button : \"item_attach_pickfiles\",\n        container : \"item_upload\",\n        max_file_size : \"<?php\nif (strrpos($SETTINGS['upload_maxfilesize'], \"mb\") === false) {\n    echo $SETTINGS['upload_maxfilesize'].\"mb\";\n} else {\n    echo $SETTINGS['upload_maxfilesize'];\n}\n?>\",\n        chunk_size : \"1mb\",\n        dragdrop : true,\n        url : \"sources/upload/upload.attachments.php\",\n        flash_swf_url : \"includes/libraries/Plupload/Moxie.swf\",\n        silverlight_xap_url : \"includes/libraries/Plupload/Moxie.xap\",\n        filters : [\n            {title : \"Image files\", extensions : \"<?php echo $SETTINGS['upload_imagesext']; ?>\"},\n            {title : \"Package files\", extensions : \"<?php echo $SETTINGS['upload_pkgext']; ?>\"},\n            {title : \"Documents files\", extensions : \"<?php echo $SETTINGS['upload_docext']; ?>\"},\n            {title : \"Other files\", extensions : \"<?php echo $SETTINGS['upload_otherext']; ?>\"}\n        ],<?php\nif ($SETTINGS['upload_imageresize_options'] == 1) {\n?>\n        resize : {\n            width : <?php echo $SETTINGS['upload_imageresize_width']; ?>,\n            height : <?php echo $SETTINGS['upload_imageresize_height']; ?>,\n            quality : <?php echo $SETTINGS['upload_imageresize_quality']; ?>\n        },\n<?php\n}\n?>\n        init: {\n            BeforeUpload: function (up, file) {\n                $(\"#item_upload_wait\").removeClass(\"hidden\");\n\n                if ($(\"#random_id\").val() == \"\") {\n                    var post_id = CreateRandomString(9,\"num_no_0\");\n                    $(\"#random_id\").val(post_id);\n                }\n\n                up.setOption('multipart_params', {\n                    PHPSESSID : \"<?php echo $_SESSION['user_id']; ?>\",\n                    itemId : $(\"#random_id\").val(),\n                    type_upload : \"item_attachments\",\n                    edit_item : false,\n                    user_token: $(\"#item_user_token\").val(),\n                    files_number: $(\"#files_number\").val()\n                });\n            },\n            UploadComplete: function(up, files) {\n                $(\"#item_upload_wait\").addClass(\"hidden\");\n                $(\"#files_number\").val(0);\n            }\n        }\n    });\n\n    // Uploader options\n    uploader_attachments.bind(\"UploadProgress\", function(up, file) {\n        $(\"#\" + file.id + \" b\").html(file.percent + \"%\");\n        $(\"#remove_\" + file.id).remove();\n    });\n    uploader_attachments.bind(\"Error\", function(up, err) {\n        $(\"#item_upload_list\").html(\n            \"<div class=\\'ui-state-error ui-corner-all\\' style=\\'padding:2px;\\'>Error: \" + err.code +\n            \", Message: \" + err.message +\n            (err.file ? \", File: \" + err.file.name : \"\") +\n            \"</div>\"\n        );\n        up.refresh(); // Reposition Flash/Silverlight\n    });\n    uploader_attachments.bind(\"+\", function(up, file) {\n        $(\"#\" + file.id + \" b\").html(\"100%\");\n    });\n\n    // Load edit uploaded click\n    $(\"#item_attach_uploadfiles\").click(function(e) {\n        // generate and save token\n        $.post(\n            \"sources/main.queries.php\",\n            {\n                type : \"save_token\",\n                size : 25,\n                capital: true,\n                numeric: true,\n                ambiguous: true,\n                reason: \"item_attachments\",\n                duration: 10\n            },\n            function(data) {\n                $(\"#item_user_token\").val(data[0].token);\n                uploader_attachments.start();\n            },\n            \"json\"\n        );\n        e.preventDefault();\n    });\n    uploader_attachments.init();\n    uploader_attachments.bind('FilesAdded', function(up, files) {\n        $.each(files, function(i, file) {\n            $('#item_upload_list').append(\n                '<div id= file.id><span id=\"remove_' + file.id + '>[<a href=\\'#\\' onclick=\\'$(\\\"#' + file.id + '\\\").remove();\\'>-</a>]</span> ' +\n                file.name + ' (' + plupload.formatSize(file.size) + ')' +\n            '</div>');\n            $(\"#files_number\").val(parseInt($(\"#files_number\").val())+1);\n        });\n        up.refresh(); // Reposition Flash/Silverlight\n    });\n\n    // Prepare uplupload object for attachments upload\n    var edit_uploader_attachments = new plupload.Uploader({\n        runtimes : \"html5,flash,silverlight,html4\",\n        browse_button : \"item_edit_attach_pickfiles\",\n        container : \"item_edit_upload\",\n        max_file_size : \"<?php\nif (strrpos($SETTINGS['upload_maxfilesize'], \"mb\") === false) {\n    echo $SETTINGS['upload_maxfilesize'].\"mb\";\n} else {\n    echo $SETTINGS['upload_maxfilesize'];\n}\n?>\",\n        chunk_size : \"1mb\",\n        dragdrop : true,\n        url : \"sources/upload/upload.attachments.php\",\n        flash_swf_url : \"includes/libraries/Plupload/Moxie.swf\",\n        silverlight_xap_url : \"includes/libraries/Plupload/Moxie.xap\",\n        filters : [\n            {title : \"Image files\", extensions : \"<?php echo $SETTINGS['upload_imagesext']; ?>\"},\n            {title : \"Package files\", extensions : \"<?php echo $SETTINGS['upload_pkgext']; ?>\"},\n            {title : \"Documents files\", extensions : \"<?php echo $SETTINGS['upload_docext']; ?>\"},\n            {title : \"Other files\", extensions : \"<?php echo $SETTINGS['upload_otherext']; ?>\"}\n        ],<?php\nif ($SETTINGS['upload_imageresize_options'] == 1) {\n        ?>\n        resize : {\n            width : <?php echo $SETTINGS['upload_imageresize_width']; ?>,\n            height : <?php echo $SETTINGS['upload_imageresize_height']; ?>,\n            quality : <?php echo $SETTINGS['upload_imageresize_quality']; ?>\n        },<?php\n}\n?>\n        init: {\n            BeforeUpload: function (up, file) {\n                $(\"#item_edit_upload_wait\").removeClass(\"hidden\");\n\n                up.setOption('multipart_params', {\n                    PHPSESSID : \"<?php echo $_SESSION['user_id']; ?>\",\n                    itemId : $('#selected_items').val(),\n                    type_upload : \"item_attachments\",\n                    edit_item : true,\n                    user_token: $(\"#item_user_token\").val(),\n                    files_number: $(\"#edit_files_number\").val()\n                });\n            },\n            UploadComplete: function(up, files) {\n                $(\"#item_edit_upload_wait\").addClass(\"hidden\");\n                $(\"#edit_files_number\").val(0);\n            }\n        }\n    });\n\n    // Uploader options\n    edit_uploader_attachments.bind(\"UploadProgress\", function(up, file) {\n        $(\"#\" + file.id + \" b\").html(file.percent + \"%\");\n        $(\"#edit_remove_\" + file.id).remove();\n    });\n    edit_uploader_attachments.bind(\"Error\", function(up, err) {\n        $(\"#item_edit_upload_list\").html(\n            \"<div class=\\'ui-state-error ui-corner-all\\' style=\\'padding:2px;\\'>Error: \" + err.code +\n            \", Message: \" + err.message +\n            (err.file ? \", File: \" + err.file.name : \"\") +\n            \"</div>\"\n        );\n        up.refresh(); // Reposition Flash/Silverlight\n    });\n    edit_uploader_attachments.bind(\"+\", function(up, file) {\n        $(\"#\" + file.id + \" b\").html(\"100%\");\n        $(\"#edit_remove_\" + file.id).remove();\n    });\n\n    // Load edit uploaded click\n    $(\"#item_edit_attach_uploadfiles\").click(function(e) {\n        // generate and save token\n        $.post(\n            \"sources/main.queries.php\",\n            {\n                type : \"save_token\",\n                size : 25,\n                capital: true,\n                numeric: true,\n                ambiguous: true,\n                reason: \"item_attachments\",\n                duration: 30\n            },\n            function(data) {\n                $(\"#item_user_token\").val(data[0].token);\n                edit_uploader_attachments.start();\n            },\n            \"json\"\n        );\n\n        e.preventDefault();\n    });\n    edit_uploader_attachments.init();\n    edit_uploader_attachments.bind('FilesAdded', function(up, files) {\n        $.each(files, function(i, file) {\n            $('#item_edit_upload_list').append(\n                '<div id= file.id><span id=\"edit_remove_' + file.id + '>[<a href=\\'#\\' onclick=\\'$(\\\"#' + file.id + '\\\").remove();\\'>-</a>]</span> ' +\n                file.name + ' (' + plupload.formatSize(file.size) + ')' +\n            '</div>');\n            $(\"#edit_files_number\").val(parseInt($(\"#edit_files_number\").val())+1);\n        });\n        up.refresh(); // Reposition Flash/Silverlight\n    });\n\n    //Launch items loading\n    if ($(\"#jstree_group_selected\").val() == \"\") {\n        var first_group = 1;\n    } else {\n        var first_group = $(\"#jstree_group_selected\").val();\n    }\n\n    if ($(\"#hid_cat\").val() != \"\") {\n        first_group = $(\"#hid_cat\").val();\n    }\n\n    //load items\n    if (parseInt($(\"#query_next_start\").val()) > 0) start = parseInt($(\"#query_next_start\").val());\n    else start = 0;\n\n    // load list of items\n    if (first_group !== \"\") {\n        ListerItems(first_group,'', start);\n    }\n\n    //Load item if needed and display items list\n    if ($(\"#open_id\").val() !== \"\") {\n        AfficherDetailsItem($(\"#open_id\").val());\n        //refreshTree($(\"#hid_cat\").val(), \"0\");\n        $(\"#open_item_by_get\").val(\"\");\n    }\n\n    //Password meter for item creation\n    $(\"#pw1\").simplePassMeter({\n        \"requirements\": {},\n        \"container\": \"#pw_strength\",\n        \"defaultText\" : \"<?php echo addslashes($LANG['index_pw_level_txt']); ?>\",\n        \"ratings\": [\n            {\"minScore\": 0,\n                \"className\": \"meterFail\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level0']); ?>\"\n            },\n            {\"minScore\": 25,\n                \"className\": \"meterWarn\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level1']); ?>\"\n            },\n            {\"minScore\": 50,\n                \"className\": \"meterWarn\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level2']); ?>\"\n            },\n            {\"minScore\": 60,\n                \"className\": \"meterGood\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level3']); ?>\"\n            },\n            {\"minScore\": 70,\n                \"className\": \"meterGood\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level4']); ?>\"\n            },\n            {\"minScore\": 80,\n                \"className\": \"meterExcel\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level5']); ?>\"\n            },\n            {\"minScore\": 90,\n                \"className\": \"meterExcel\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level6']); ?>\"\n            }\n        ]\n    });\n    $('#pw1').bind({\n        \"score.simplePassMeter\" : function(jQEvent, score) {\n            $(\"#mypassword_complex\").val(score);\n        }\n    }).change({\n        \"score.simplePassMeter\" : function(jQEvent, score) {\n            $(\"#mypassword_complex\").val(score);\n        }\n    });\n\n    $(\"#tabs-02\").on(\n        \"score.simplePassMeter\",\n        \"#pw1\",\n        function(jQEvent, score) {\n            $(\"#mypassword_complex\").val(score);\n        }\n    );\n\n\n    //Password meter for item update\n    $(\"#edit_pw1\").simplePassMeter({\n        \"requirements\": {},\n        \"container\": \"#edit_pw_strength\",\n        \"defaultText\" : \"<?php echo addslashes($LANG['index_pw_level_txt']); ?>\",\n        \"ratings\": [\n            {\"minScore\": 0,\n                \"className\": \"meterFail\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level0']); ?>\"\n            },\n            {\"minScore\": 25,\n                \"className\": \"meterWarn\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level1']); ?>\"\n            },\n            {\"minScore\": 50,\n                \"className\": \"meterWarn\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level2']); ?>\"\n            },\n            {\"minScore\": 60,\n                \"className\": \"meterGood\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level3']); ?>\"\n            },\n            {\"minScore\": 70,\n                \"className\": \"meterGood\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level4']); ?>\"\n            },\n            {\"minScore\": 80,\n                \"className\": \"meterExcel\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level5']); ?>\"\n            },\n            {\"minScore\": 90,\n                \"className\": \"meterExcel\",\n                \"text\": \"<?php echo addslashes($LANG['complex_level6']); ?>\"\n            }\n        ]\n    });\n    $('#edit_pw1').on(\n        \"score.simplePassMeter\", function(jQEvent, score) {\n            $(\"#edit_mypassword_complex\").val(score);\n        }\n    );\n\n    //Text search watermark\n    var tbval = $('#jstree_search').val();\n    $('#jstree_search').focus(function() { $(this).val('');});\n    $('#jstree_search').blur(function() { $(this).val(tbval);});\n    $('#search_item').focus(function() { $(this).val('');});\n    $('#search_item').blur(function() { $(this).val(tbval);});\n\n    //add date selector\n    $(\".datepicker\").datepicker({\n        dateFormat:\"<?php echo str_replace(array(\"Y\", \"M\"), array(\"yy\", \"mm\"), $SETTINGS['date_format']); ?>\",\n        changeMonth: true,\n        changeYear: true\n    });\n\n    //autocomplete for TAGS\n    $(\"#item_tags, #edit_tags\")\n        .focus()\n        .bind( \"keydown\", function( event ) {\n            if ( event.keyCode === $.ui.keyCode.TAB &&\n                    $( this ).data( \"autocomplete\" ).menu.active ) {\n                event.preventDefault();\n            }\n        })\n        .autocomplete({\n            //source: 'sources/items.queries.php?type=autocomplete_tags',\n            source: function( request, response ) {\n                $.getJSON( \"sources/items.queries.php?type=autocomplete_tags&t=1\", {\n                    term: extractLast( request.term )\n                }, response );\n            },\n            focus: function() {\n                // prevent value inserted on focus\n                return false;\n            },\n            search: function() {\n                var term = extractLast( this.value );\n            },\n            select: function( event, ui ) {\n                var terms = split( this.value );\n                // remove the current input\n                terms.pop();\n                // add the selected item\n                terms.push( ui.item.value );\n                // add placeholder to get the comma-and-space at the end\n                terms.push( \"\" );\n                this.value = terms.join( \" \" );\n\n                return false;\n            }\n        }\n    );\n\n    //DIALOG FOR OFFLINE MODE\n    $(\"#dialog_offline_mode\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 500,\n        height: 350,\n        title: \"<?php echo addslashes($LANG['offline_menu_title']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['button_offline_generate']); ?>\": function() {\n                generateOfflineFile();\n            },\n            \"<?php echo addslashes($LANG['close']); ?>\": function() {\n                $(this).dialog(\"close\");\n            }\n        },\n        close: function() {\n            $(\"#div_offline_mode\").html(\"<i class=\\\"fa fa-cog fa-spin fa-2x\\\"></i>\");\n        }\n    });\n\n    //DIALOG FOR EXPORT FILE\n    $(\"#dialog_export_file\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 500,\n        height: 350,\n        title: \"<?php echo addslashes($LANG['print_out_menu_title']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['button_export_file']); ?>\": function() {\n                exportItemsToFile();\n            },\n            \"<?php echo addslashes($LANG['close']); ?>\": function() {\n                $(this).dialog(\"close\");\n            }\n        },\n        close: function() {\n            $(\"#div_export_file\").html(\"<i class=\\\"fa fa-cog fa-spin fa-2x\\\"></i>\");\n        }\n    });\n\n    //DIALOG FOR IMPORT FILE\n    $(\"#dialog_import_file\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 600,\n        height: 500,\n        title: \"<?php echo addslashes($LANG['import_csv_menu_title']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['close']); ?>\": function() {\n                $(this).dialog(\"close\");\n            }\n        },\n        close: function() {\n            $(\"#div_import_file\").html(\"<i class=\\\"fa fa-cog fa-spin fa-2x\\\"></i>\");\n        }\n    });\n\n\n    // DIALOG BOX FOR PERSONAL PASSWORDS UPGRADE\n    $(\"#dialog_upgrade_personal_passwords\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 500,\n        height: 300,\n        title: \"<?php echo addslashes($LANG['upgrade_needed']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['admin_action_db_backup_start_tip']); ?>\": function() {\n                $(\"#dialog_upgrade_personal_passwords_status\").html('<i class=\"fa fa-cog fa-spin\"></i>&nbsp;<?php echo addslashes($LANG['please_wait']); ?>&nbsp;...&nbsp;<span id=\"reencryption_progress\">0%</span>').attr(\"class\",\"\").show();\n                $.post(\n                    \"sources/utils.queries.php\",\n                    {\n                        type    : \"reencrypt_personal_pwd_start\",\n                        user_id : \"<?php echo $_SESSION['user_id']; ?>\",\n                        key     : \"<?php echo $_SESSION['key']; ?>\"\n                    },\n                    function(data) {\n                        if (data[0].error != \"\") {\n                            $(\"#dialog_upgrade_personal_passwords_status\").html(data[0].error).addClass(\"ui-state-error\").show();\n                        } else {\n                            reEncryptPersonalPwds(data[0].pws_list, data[0].currentId, data[0].nb);\n                        }\n                    },\n                    \"json\"\n                );\n            },\n            \"<?php echo addslashes($LANG['cancel_button']); ?>\": function() {\n                $(this).dialog(\"close\");\n            }\n        }\n    });\n\n    //DIALOG FOR SSH\n    $(\"#dialog_ssh\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 620,\n        height: 500,\n        title: \"<?php echo addslashes($LANG['update_server_password']); ?>\",\n        buttons: {\n            \"<?php echo addslashes($LANG['close']); ?>\": function() {\n                $(this).dialog(\"close\");\n            }\n        },\n        close: function() {\n            $(\"#div_ssh\").html(\"<i class=\\'fa fa-cog fa-spin fa-2x\\'></i>&nbsp;<b><?php echo addslashes($LANG['please_wait']); ?></b>\");\n        }\n    });\n\n    //Simulate a CRON activity (only 8 secs after page loading)\n    setTimeout(\n        function() {\n            // send email\n            $.post(\n                \"sources/main.queries.php\",\n                {\n                    type : \"send_waiting_emails\",\n                    key     : \"<?php echo $_SESSION['key']; ?>\"\n                }\n            );\n\n            // send statistics\n            $.post(\n                \"sources/main.queries.php\",\n                {\n                    type : \"sending_statistics\",\n                    key     : \"<?php echo $_SESSION['key']; ?>\"\n                }\n            );\n        },\n        8000\n    );\n\n    NProgress.done();\n});\n\n// show password during longpress\nvar mouseStillDown = false;\n$('#item_details_ok').on('mousedown', '.unhide_masked_data', function(event) {\n    mouseStillDown = true;\n     showPwdContinuous($(this).attr('id'));\n}).on('mouseup', '.unhide_masked_data', function(event) {\n     mouseStillDown = false;\n}).on('mouseleave', '.unhide_masked_data', function(event) {\n     mouseStillDown = false;\n});\nvar showPwdContinuous = function(elem_id){\n    if(mouseStillDown){\n        $('#'+elem_id).text($('#h'+elem_id).val());\n        setTimeout(\"showPwdContinuous('\"+elem_id+\"')\", 50);\n        // log password is shown\n        if (elem_id === \"id_pw\" && $(\"#pw_shown\").val() == \"0\") {\n            itemLog(\"item_password_shown\");\n            $(\"#pw_shown\").val(\"1\");\n        }\n    } else {\n        $('#'+elem_id).html('<?php echo $var['hidden_asterisk']; ?>');\n        $('.tip').tooltipster({multiple: true});\n    }\n}\n\nvar showPwd = function(){\n    $(\"#visible_pw, #edit_visible_pw\").toggle();\n}\n\n/*\n* permits to save\n*/\nfunction itemLog(log_case)\n{\n    $.post(\n        \"sources/items.logs.php\",\n        {\n            type        : log_case,\n            id_item     : $('#id_item').val(),\n            folder_id   : $('#hid_cat').val(),\n        hid_label   : $('#hid_label').val(),\n            key         : \"<?php echo $_SESSION['key']; ?>\"\n        }\n    );\n}\n\nfunction htmlspecialchars_decode (string, quote_style)\n{\n    if (string != null && string != \"\") {\n        // Convert special HTML entities back to characters\n        var optTemp = 0, i = 0, noquotes= false;\n        if (typeof quote_style === 'undefined') {        quote_style = 2;\n        }\n        string = string.toString().replace(/&lt;/g, '<').replace(/&gt;/g, '>');\n        var OPTS = {\n            'ENT_NOQUOTES': 0,\n            'ENT_HTML_QUOTE_SINGLE' : 1,\n            'ENT_HTML_QUOTE_DOUBLE' : 2,\n            'ENT_COMPAT': 2,\n            'ENT_QUOTES': 3,\n            'ENT_IGNORE' : 4\n        };\n        if (quote_style === 0) {\n            noquotes = true;\n        }\n        if (typeof quote_style !== 'number') { // Allow for a single string or an array of string flags\n            quote_style = [].concat(quote_style);\n            for (i=0; i < quote_style.length; i++) {\n                // Resolve string input to bitwise e.g. 'PATHINFO_EXTENSION' becomes 4\n                if (OPTS[quote_style[i]] === 0) {\n                    noquotes = true;\n                } else if (OPTS[quote_style[i]]) {\n                    optTemp = optTemp | OPTS[quote_style[i]];\n                }\n            }\n            quote_style = optTemp;\n        }\n        if (quote_style & OPTS.ENT_HTML_QUOTE_SINGLE) {\n            string = string.replace(/&#0*39;/g, \"'\"); // PHP doesn't currently escape if more than one 0, but it should\n            // string = string.replace(/&apos;|&#x0*27;/g, \"'\"); // This would also be useful here, but not a part of PHP\n        }\n        if (!noquotes) {\n            string = string.replace(/&quot;/g, '\"');\n        }\n\n        string = string.replace(/&nbsp;/g, ' ');\n\n        // Put this in last place to avoid escape being double-decoded    string = string.replace(/&amp;/g, '&');\n    }\n    return string;\n}\n\n/**\n * Permit to load dynamically the list of Items\n */\nfunction proceed_list_update(stop_proceeding)\n{\n    stop_proceeding = stop_proceeding || \"\";\n\n    if (stop_proceeding === \"1\" || ($(\"#new_listing_characteristics\").val() !== \"\" && $(\"#query_next_start\").val() !== \"end\")) {\n        var tmp = $(\"#new_listing_characteristics\").val().split(',');\n        $(\"#new_listing_characteristics\").val(\"\");\n        ListerItems(tmp[0], tmp[1], tmp[2], tmp[3]);\n        return false;\n    }\n\n    if ($(\"#query_next_start\").val() !== \"end\") {\n        //Check if nb of items do display > to 0\n        if ($(\"#nb_items_to_display_once\").val() > 0) {\n            ListerItems($(\"#hid_cat\").val(),'', parseInt($(\"#query_next_start\").val()));\n        }\n    } else {\n        $('ul#full_items_list>li').tsort(\"\",{order:\"asc\",attr:\"name\"});\n        $(\"#items_list_loader\").addClass(\"hidden\");\n\n        // prepare clipboard items\n        var clipboard = new Clipboard('.mini_login');\n        clipboard.on('success', function(e) {\n            $(\"#message_box\").html(\"<?php echo addslashes($LANG['login_copied_clipboard']); ?>\").show().fadeOut(1000);\n            e.clearSelection();\n        });\n\n        var clipboard = new Clipboard('.mini_pw');\n        clipboard.on('success', function(e) {\n            $(\"#message_box\").html(\"<?php echo addslashes($LANG['pw_copied_clipboard']); ?>\").show().fadeOut(1000);\n            itemLog(\"item_password_copied\");\n            e.clearSelection();\n        });\n\n        $(\".tip\").tooltipster({multiple: true});\n        $(\".mini_login, .mini_pw\").css(\"cursor\", \"pointer\");\n\n        var restricted_to_roles = <?php if (isset($SETTINGS['restricted_to_roles']) && $SETTINGS['restricted_to_roles'] == 1) {\n    echo 1;\n} else {\n    echo 0;\n}\n?>;\n\n        // refine users list to the related roles\n        $.post(\n            \"sources/items.queries.php\",\n            {\n                type        : \"get_refined_list_of_users\",\n                iFolderId   : $('#hid_cat').val(),\n                key         : \"<?php echo $_SESSION['key']; ?>\"\n            },\n            function(data) {\n                data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                // *** restricted_to_list ***\n                $(\"#restricted_to_list\").empty();\n                // add list of users\n                if ($('#restricted_to').val() != undefined) {\n                    $(\"#restricted_to_list\").append(data.selOptionsUsers);\n                    if (restricted_to_roles == 1) {\n                        //add optgroup\n                        var optgroup = $('<optgroup>');\n                        optgroup.attr('label', \"<?php echo addslashes($LANG['users']); ?>\");\n                        $(\".folder_rights_user\").wrapAll(optgroup);\n                    }\n                }\n                //Add list of roles if option is set\n                if (restricted_to_roles == 1 && $('#restricted_to').val() != undefined) {\n                    //add optgroup\n                    var optgroup = $('<optgroup>');\n                    optgroup.attr('label', \"<?php echo addslashes($LANG['roles']); ?>\");\n                    $(\"#restricted_to_list\").append(data.selOptionsRoles);\n                    $(\".folder_rights_role\").wrapAll(optgroup);\n                }\n                //Prepare multiselect widget\n                $(\"#restricted_to_list\").select2({\n                    language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n                });\n\n                // *** edit_restricted_to_list ***\n                $(\"#edit_restricted_to_list\").empty();\n                if ($('#edit_restricted_to').val() != undefined) {\n                    $(\"#edit_restricted_to_list\").append(data.selEOptionsUsers);\n                    if (restricted_to_roles == 1) {\n                        //add optgroup\n                        var optgroup = $('<optgroup>');\n                        optgroup.attr('label', \"<?php echo addslashes($LANG['users']); ?>\");\n                        $(\".folder_rights_user_edit\").wrapAll(optgroup);\n                    }\n                }\n                //Add list of roles if option is set\n                if (restricted_to_roles == 1 && $('#edit_restricted_to').val() != undefined) {\n                    //add optgroup\n                    var optgroup = $('<optgroup>');\n                    optgroup.attr('label', \"<?php echo addslashes($LANG['roles']); ?>\");\n                    $(\"#edit_restricted_to_list\").append(data.selEOptionsRoles);\n                    $(\".folder_rights_role_edit\").wrapAll(optgroup);\n                }\n                //Prepare multiselect widget\n                $(\"#edit_restricted_to_list\").select2({\n                    language: \"<?php echo $_SESSION['user_language_code']; ?>\"\n                });\n            }\n       );\n    }\n}\n\n/**\n *\n * @access public\n * @return void\n **/\nfunction items_list_filter(id)\n{\n    $(\"#full_items_list\").find(\"li\").show();\n    if (id) {\n        $(\"#full_items_list\").find(\"a:not(:contains(\" + id + \"))\").parent().addClass(\"hidden\");\n        $(\"#full_items_list\").find(\"a:contains(\" + id + \")\").parent().show();\n    }\n}\n\n\nfunction manage_history_entry(type, id)\n{\n    var data = {\"item_id\": $(\"#id_item\").val(), \"label\": sanitizeString($('#add_history_entry_label').val())};\n\n    //Send query\n    $.post(\n        \"sources/items.queries.php\",\n        {\n            type      : \"history_entry_add\",\n            folder_id : $('#hid_cat').val(),\n            data      : prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n            key       : \"<?php echo $_SESSION['key']; ?>\"\n        },\n        function(data) {\n            //check if format error\n            data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n            if (data.error == \"\") {\n                $(\"#item_history_log_error\").html(\"\").addClass(\"hidden\");\n                $(\"#add_history_entry_label\").val(\"\");\n                $(\"#item_history_log\").append(htmlspecialchars_decode(data.new_line));\n            } else {\n                $(\"#item_history_log_error\").html(data.error).show();\n            }\n            $(\"#div_item_history\").dialog(\"open\");\n        }\n   );\n}\n\n\n/*\n* Launch the redirection to OTV page\n*/\nfunction prepareOneTimeView()\n{\n    if ($(\"#selected_items\").val() == \"\") return;\n    $(\"#div_loading\").removeClass(\"hidden\");\n\n    //Send query\n    $.post(\n        \"sources/items.queries.php\",\n        {\n            type    : \"generate_OTV_url\",\n            id      : $(\"#id_item\").val(),\n            key     : \"<?php echo $_SESSION['key']; ?>\"\n        },\n        function(data) {\n            //check if format error\n            if (data.error == \"\") {\n                $(\"#div_dialog_message\").dialog({height:300,minWidth:750});\n                $(\"#div_dialog_message\").dialog('open');\n                $(\"#div_dialog_message_text\").html(data.url+\n                    '<div style=\"margin-top:30px;font-size:13px;text-align:center;\"><span id=\"show_otv_copied\" class=\"ui-state-focus ui-corner-all\" style=\"padding:10px;display:none;\"></span></div>'\n                );\n\n                // prepare clipboard\n                var clipboard = new Clipboard(\"#button_copy_otv_link\", {\n                    text: function() {\n                        return unsanitizeString($('#otv_link').text());\n                    }\n                });\n                clipboard.on('success', function(e) {\n                    $(\"#show_otv_copied\").html(\"<?php echo addslashes($LANG['link_is_copied']); ?>\").show().fadeOut(2000);\n\n                    e.clearSelection();\n                });\n\n                $(\".tip\").tooltipster({multiple: true});\n            } else {\n                $(\"#item_history_log_error\").html(data.error).show();\n            }\n            $(\"#div_loading\").addClass(\"hidden\");\n        },\n        \"json\"\n   );\n}\n\nfunction globalItemsSearch()\n{\n    if ($(\"#search_item\").val() != \"\") {\n        // stop items loading (if on-going)\n        $(\"#items_listing_should_stop\").val(\"1\");\n\n        // wait\n        $(\"#items_list_loader\").removeClass(\"hidden\");\n        $(\"#items_path_var\").html('<i class=\"fa fa-filter\"></i>&nbsp;<?php echo addslashes($LANG['searching']); ?>');\n\n        // clean\n        $(\"#id_label, #id_desc, #id_pw, #id_login, #id_email, #id_url, #id_files, #id_restricted_to ,#id_tags, #id_kbs, .fields_div, #item_extra_info\").html(\"\");\n        $(\"#button_quick_login_copy, #button_quick_pw_copy\").addClass(\"hidden\");\n        $(\"#full_items_list\").html(\"\");\n        $(\"#selected_items\").val(\"\");\n\n        // send query\n        $.get(\n            \"sources/find.queries.php\",\n            {\n                type        : \"search_for_items\",\n                sSearch     : $(\"#search_item\").val(),\n                key         : \"<?php echo $_SESSION['key']; ?>\"\n            },\n            function(data) {\n                data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n                displayMessage(data.message);\n                $(\"#items_path_var\").html('<i class=\"fa fa-filter\"></i>&nbsp;<?php echo addslashes($LANG['search_results']); ?>');\n                $(\"#items_list\").html(\"<ul class='liste_items 'id='full_items_list'></ul>\");\n                $(\"#full_items_list\").html(data.items_html);\n                $(\"#items_list_loader\").addClass(\"hidden\");\n            }\n        );\n    }\n}\n\n/*\n*\n*/\nfunction searchItemsWithTags(tag)\n{\n    //console.log(\">\"+tag);\n    if (tag == \"\") return false\n\n    // wait\n    $(\"#items_list_loader\").removeClass(\"hidden\");\n    $(\"#items_path_var\").html('<i class=\"fa fa-filter\"></i>&nbsp;<?php echo addslashes($LANG['searching_tag']); ?>&nbsp;<b>' + tag + '</b> ...');\n\n    // clean\n    $(\"#id_label, #id_desc, #id_pw, #id_login, #id_email, #id_url, #id_files, #id_restricted_to ,#id_tags, #id_kbs\").html(\"\");\n    $(\"#button_quick_login_copy, #button_quick_pw_copy\").addClass(\"hidden\");\n    $(\"#full_items_list\").html(\"\");\n    $(\"#selected_items\").val(\"\");\n\n    // send query\n    $.get(\n        \"sources/find.queries.php\",\n        {\n            type        : \"search_for_items_with_tags\",\n            tagSearch   : tag,\n            key         : \"<?php echo $_SESSION['key']; ?>\"\n        },\n        function(data) {\n            data = prepareExchangedData(data , \"decode\", \"<?php echo $_SESSION['key']; ?>\");\n            displayMessage(data.message);\n            $(\"#items_path_var\").html('<i class=\"fa fa-filter\"></i>&nbsp;<?php echo addslashes($LANG['search_results']); ?>&nbsp;<b>' + tag + '</b>');\n            $(\"#full_items_list\").html(data.items_html);\n            $(\"#items_list_loader\").addClass(\"hidden\");\n        }\n    );\n}\n\nfunction loadOfflineDialog()\n{\n    $(\"#dialog_offline_mode\").dialog({\n        open: function(event, ui) {\n            $(\"#div_offline_mode\").load(\n                \"<?php echo $SETTINGS['cpassman_url']; ?>/items.offline.php?key=<?php echo $_SESSION['key']; ?>\", function(){}\n            );\n        }\n    }).dialog(\"open\");\n}\n\nfunction loadExportDialog()\n{\n    $(\"#dialog_export_file\").dialog({\n        open: function(event, ui) {\n            $(\"#div_export_file\").load(\n                \"<?php echo $SETTINGS['cpassman_url']; ?>/items.export.php?key=<?php echo $_SESSION['key']; ?>\", function(){}\n            );\n        }\n    }).dialog(\"open\");\n}\n\nfunction loadImportDialog()\n{\n    $(\"#dialog_import_file\").dialog({\n        open: function(event, ui) {\n            $(\"#div_import_file\").load(\n                \"<?php echo $SETTINGS['cpassman_url']; ?>/items.import.php?key=<?php echo $_SESSION['key']; ?>&folder_id=\"+$(\"#hid_cat\").val(), function(){}\n            );\n        }\n    }).dialog(\"open\");\n}\n\nfunction reEncryptPersonalPwds(remainingIds, currentId, nb)\n{\n    //console.log(remainingIds+\";\"+currentId+\";\"+nb);\n    $(\"#dialog_upgrade_personal_passwords_status\").html('<i class=\"fa fa-cog fa-spin\"></i>&nbsp;<?php echo addslashes($LANG['please_wait']); ?>&nbsp;...&nbsp;<span id=\"reencryption_progress\">0%</span>').attr(\"class\",\"\").show();\n\n    $.ajax({\n        url: \"sources/utils.queries.php\",\n        type : 'POST',\n        dataType : \"json\",\n        data : {\n            type        : \"reencrypt_personal_pwd\",\n            currentId   : currentId,\n            user_id     : \"<?php echo $_SESSION['user_id']; ?>\",\n            key         : \"<?php echo $_SESSION['key']; ?>\"\n        },\n        complete : function(data, statut){\n            var aIds = remainingIds.split(\",\");\n            var currentID = aIds[0];\n            aIds.shift();\n            var nb2 = aIds.length;\n            aIds = aIds.toString();\n            if (nb == 0)\n                $(\"#reencryption_progress\").html(\"100%\");\n            else\n                $(\"#reencryption_progress\").html(Math.floor(((nb-nb2) / nb) * 100)+\"%\");\n\n            if (nb2 != \"0\" || (nb2 == \"\" && currentID != \"\")) {\n                reEncryptPersonalPwds(aIds, currentID, nb);\n            } else {\n                $(\"#dialog_upgrade_personal_passwords\").html('<i class=\"fa fa-info\"></i>&nbsp;<?php echo addslashes($LANG['operation_encryption_done']); ?>');\n\n                // ensure that no upgrade popup is shown\n                $(\"#personal_upgrade_needed\").val(\"\");\n            }\n        }\n    });\n}\n\n function serverAutoChangePwd()\n {\n    //console.log(\"opening\");\n    $(\"#dialog_ssh\").dialog({\n        open: function(event, ui) {\n            $(\"#div_ssh\").load(\n                \"<?php echo $SETTINGS['cpassman_url'].'/ssh.php?key='.$_SESSION['key']; ?>&id=\"+$(\"#selected_items\").val(), function(){}\n            );\n        }\n    }).dialog(\"open\");\n}\n\n/*\n**\n*/\nfunction showPasswordsHistory() {\n    if ($('#edit_past_pwds_div').text() !== \"\") {\n        $('#edit_past_pwds_div').toggle();\n    }\n}\n\n$.fn.simulateClick = function() {\n    return this.each(function() {\n        if('createEvent' in document) {\n            var doc = this.ownerDocument,\n                evt = doc.createEvent('MouseEvents');\n            evt.initMouseEvent('click', true, true, doc.defaultView, 1, 0, 0, 0, 0, false, false, false, false, 0, null);\n            this.dispatchEvent(evt);\n        } else {\n            this.click(); // IE Boss!\n        }\n    });\n}\n\n\n// escape HTML characters\nString.prototype.escapeHTML = function() {\n    return this.replace(/&/g, \"&amp;\")\n        .replace(/</g, \"&lt;\")\n        .replace(/>/g, \"&gt;\")\n        .replace(/\"/g, \"&quot;\")\n        .replace(/'/g, \"&#039;\");\n}\n//]]>\n</script>\n", "<?php\n/**\n *\n * @file          items.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\n\nif (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 ||\n    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) ||\n    !isset($_SESSION['key']) || empty($_SESSION['key'])\n) {\n    die('Hacking attempt...');\n}\n\n// Load config\nif (file_exists('../includes/config/tp.config.php')) {\n    require_once '../includes/config/tp.config.php';\n} elseif (file_exists('./includes/config/tp.config.php')) {\n    require_once './includes/config/tp.config.php';\n} else {\n    throw new Exception(\"Error file '/includes/config/tp.config.php' not exists\", 1);\n}\n\n/* do checks */\nrequire_once $SETTINGS['cpassman_dir'].'/sources/checks.php';\nif (!checkUser($_SESSION['user_id'], $_SESSION['key'], curPage())) {\n    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n    include $SETTINGS['cpassman_dir'].'/error.php';\n    exit();\n}\n\nrequire_once $SETTINGS['cpassman_dir'].'/sources/SplClassLoader.php';\nrequire_once $SETTINGS['cpassman_dir'].'/sources/main.functions.php';\nrequire_once $SETTINGS['cpassman_dir'].'/includes/libraries/protect/SuperGlobal/SuperGlobal.php';\n$superGlobal = new protect\\SuperGlobal\\SuperGlobal();\n\n// Prepare GET variables\n$get_group = $superGlobal->get(\"group\", \"GET\");\n$get_id = $superGlobal->get(\"id\", \"GET\");\n\n// Prepare SESSION variables\n$session_user_admin = $superGlobal->get(\"user_admin\", \"SESSION\");\n\n\nif ($session_user_admin === '1' && (isset($SETTINGS_EXT['admin_full_right'])\n    && $SETTINGS_EXT['admin_full_right'] === true) || !isset($SETTINGS_EXT['admin_full_right'])) {\n    $_SESSION['groupes_visibles'] = $_SESSION['personal_visible_groups'];\n    $_SESSION['groupes_visibles_list'] = implode(',', $_SESSION['groupes_visibles']);\n}\n\n// Get list of users\n$usersList = array();\n$rows = DB::query(\"SELECT id,login,email FROM \".$pre.\"users ORDER BY login ASC\");\nforeach ($rows as $record) {\n    $usersList[$record['login']] = array(\n        \"id\" => $record['id'],\n        \"login\" => $record['login'],\n        \"email\" => $record['email'],\n        );\n}\n// Get list of roles\n$arrRoles = array();\n$listRoles = \"\";\n$rows = DB::query(\"SELECT id,title FROM \".$pre.\"roles_title ORDER BY title ASC\");\nforeach ($rows as $reccord) {\n    $arrRoles[$reccord['title']] = array(\n        'id' => $reccord['id'],\n        'title' => $reccord['title']\n        );\n    if (empty($listRoles)) {\n        $listRoles = $reccord['id'].'#'.$reccord['title'];\n    } else {\n        $listRoles .= ';'.$reccord['id'].'#'.$reccord['title'];\n    }\n}\n\n// Hidden things\necho '\n<input type=\"hidden\" name=\"hid_cat\" id=\"hid_cat\" value=\"', $get_group !== null ? $get_group : \"\", '\" />\n<input type=\"hidden\" id=\"complexite_groupe\" value=\"\" />\n<input type=\"hidden\" name=\"selected_items\" id=\"selected_items\" value=\"\" />\n<input type=\"hidden\" id=\"bloquer_creation_complexite\" value=\"\" />\n<input type=\"hidden\" id=\"bloquer_modification_complexite\" value=\"\" />\n<input type=\"hidden\" id=\"error_detected\" value=\"\" />\n<input type=\"hidden\" name=\"random_id\" id=\"random_id\" value=\"\" />\n<input type=\"hidden\" id=\"edit_wysiwyg_displayed\" value=\"\" />\n<input type=\"hidden\" id=\"richtext_on\" value=\"1\" />\n<input type=\"hidden\" id=\"query_next_start\" value=\"0\" />\n<input type=\"hidden\" id=\"display_categories\" value=\"0\" />\n<input type=\"hidden\" id=\"nb_items_to_display_once\" value=\"', isset($SETTINGS['nb_items_by_query']) ? htmlspecialchars($SETTINGS['nb_items_by_query']) : 'auto', '\" />\n<input type=\"hidden\" id=\"user_is_read_only\" value=\"', isset($_SESSION['user_read_only']) && $_SESSION['user_read_only'] == 1 ? '1' : '', '\" />\n<input type=\"hidden\" id=\"request_ongoing\" value=\"\" />\n<input type=\"hidden\" id=\"request_lastItem\" value=\"\" />\n<input type=\"hidden\" id=\"item_editable\" value=\"\" />\n<input type=\"hidden\" id=\"timestamp_item_displayed\" value=\"\" />\n<input type=\"hidden\" id=\"pf_selected\" value=\"\" />\n<input type=\"hidden\" id=\"user_ongoing_action\" value=\"\" />\n<input type=\"hidden\" id=\"input_list_roles\" value=\"'.htmlentities($listRoles).'\" />\n<input type=\"hidden\" id=\"path_fontsize\" value=\"\" />\n<input type=\"hidden\" id=\"access_level\" value=\"\" />\n<input type=\"hidden\" id=\"empty_clipboard\" value=\"\" />\n<input type=\"hidden\" id=\"selected_folder_is_personal\" value=\"\" />\n<input type=\"hidden\" id=\"personal_visible_groups_list\" value=\"', isset($_SESSION['personal_visible_groups_list']) ? $_SESSION['personal_visible_groups_list'] : \"\", '\" />\n<input type=\"hidden\" id=\"create_item_without_password\" value=\"', isset($SETTINGS['create_item_without_password']) ? $SETTINGS['create_item_without_password'] : \"0\", '\" />';\n// Hidden objects for Item search\nif ($get_group !== null && $get_id !== null) {\n    echo '\n    <input type=\"hidden\" name=\"open_folder\" id=\"open_folder\" value=\"'.$get_group.'\" />\n    <input type=\"hidden\" name=\"open_id\" id=\"open_id\" value=\"'.$get_id.'\" />\n    <input type=\"hidden\" name=\"recherche_group_pf\" id=\"recherche_group_pf\" value=\"', in_array($get_group, $_SESSION['personal_visible_groups']) ? '1' : '0', '\" />\n    <input type=\"hidden\" name=\"open_item_by_get\" id=\"open_item_by_get\" value=\"true\" />';\n} elseif ($get_group !== null && $get_id === null) {\n    echo '<input type=\"hidden\" name=\"open_folder\" id=\"open_folder\" value=\"'.$get_group.'\" />';\n    echo '<input type=\"hidden\" name=\"open_id\" id=\"open_id\" value=\"\" />';\n    echo '<input type=\"hidden\" name=\"recherche_group_pf\" id=\"recherche_group_pf\" value=\"', in_array($get_group, $_SESSION['personal_visible_groups']) ? '1' : '0', '\" />';\n    echo '<input type=\"hidden\" name=\"open_item_by_get\" id=\"open_item_by_get\" value=\"\" />';\n} else {\n    echo '<input type=\"hidden\" name=\"open_folder\" id=\"open_folder\" value=\"\" />';\n    echo '<input type=\"hidden\" name=\"open_id\" id=\"open_id\" value=\"\" />';\n    echo '<input type=\"hidden\" name=\"recherche_group_pf\" id=\"recherche_group_pf\" value=\"\" />';\n    echo '<input type=\"hidden\" name=\"open_item_by_get\" id=\"open_item_by_get\" value=\"\" />';\n}\n// Is personal SK available\necho '\n<input type=\"hidden\" name=\"personal_sk_set\" id=\"personal_sk_set\" value=\"', isset($_SESSION['user_settings']['session_psk']) && !empty($_SESSION['user_settings']['session_psk']) ? '1' : '0', '\" />\n<input type=\"hidden\" id=\"personal_upgrade_needed\" value=\"', isset($SETTINGS['enable_pf_feature']) && $SETTINGS['enable_pf_feature'] == 1 && $session_user_admin !== '1' && isset($_SESSION['user_upgrade_needed']) && $_SESSION['user_upgrade_needed'] == 1 ? '1' : '0', '\" />';\n// define what group todisplay in Tree\nif (isset($_COOKIE['jstree_select']) && !empty($_COOKIE['jstree_select'])) {\n    $firstGroup = str_replace(\"#li_\", \"\", $_COOKIE['jstree_select']);\n} else {\n    $firstGroup = \"\";\n}\n\necho '\n<input type=\"hidden\" name=\"jstree_group_selected\" id=\"jstree_group_selected\" value=\"'.htmlspecialchars($firstGroup).'\" />\n<input type=\"hidden\" id=\"item_user_token\" value=\"\" />\n<input type=\"hidden\" id=\"items_listing_should_stop\" value=\"\" />\n<input type=\"hidden\" id=\"new_listing_characteristics\" value=\"\" />\n<input type=\"hidden\" id=\"uniqueLoadData\" value=\"\" />';\n\necho '\n<div id=\"div_items\">';\n// MAIN ITEMS TREE\necho '\n    <div class=\"items_tree\">\n        <div id=\"quick_menu\" style=\"float:left; margin-right: 5px;\">\n            <ul class=\"quick_menu\">\n                <li><i class=\"fa fa-bars\"></i>\n                    <ul class=\"menu_250\">\n                        <li id=\"jstree_open\"><i class=\"fa fa-expand fa-fw\"></i>&nbsp; '.$LANG['expand'].'</li>\n                        <li id=\"jstree_close\"><i class=\"fa fa-compress fa-fw\"></i>&nbsp; '.$LANG['collapse'].'</li>\n                        <li onclick=\"refreshTree()\"><i class=\"fa fa-refresh fa-fw\"></i>&nbsp; '.$LANG['refresh'].'</li>\n                        <li onclick=\"open_add_group_div()\"><i class=\"fa fa-plus fa-fw\"></i>&nbsp; '.$LANG['item_menu_add_rep'].'</li>\n                        <li onclick=\"open_edit_group_div()\"><i class=\"fa fa-pencil fa-fw\"></i>&nbsp; '.$LANG['item_menu_edi_rep'].'</li>\n                        <li onclick=\"open_move_group_div()\"><i class=\"fa fa-arrows fa-fw\"></i>&nbsp; '.$LANG['item_menu_mov_rep'].'</li>\n                        <li onclick=\"open_del_group_div()\"><i class=\"fa fa-eraser fa-fw\"></i>&nbsp; '.$LANG['item_menu_del_rep'].'</li>\n                        <li onclick=\"$(\\'#div_copy_folder\\').dialog(\\'open\\');\"><i class=\"fa fa-copy fa-fw\"></i>&nbsp; '.$LANG['copy_folder'].'</li>\n                        ', isset($SETTINGS['allow_import']) && $SETTINGS['allow_import'] == 1 && $session_user_admin !== '1' ? '<li onclick=\"loadImportDialog()\"><i class=\"fa fa-cloud-upload fa-fw\"></i>&nbsp; '.$LANG['import_csv_menu_title'].'</li>' : '',\n                        (isset($SETTINGS['allow_print']) && $SETTINGS['allow_print'] == 1 && $session_user_admin !== '1' && $_SESSION['temporary']['user_can_printout'] === true) ? '<li onclick=\"loadExportDialog()\"><i class=\"fa fa-cloud-download fa-fw\"></i>&nbsp; '.$LANG['print_out_menu_title'].'</li>' : '',\n                        (isset($SETTINGS['settings_offline_mode']) && $SETTINGS['settings_offline_mode'] == 1 && $session_user_admin !== '1') ? '<li onclick=\"loadOfflineDialog()\"><i class=\"fa fa-laptop fa-fw\"></i>&nbsp; '.$LANG['offline_menu_title'].'</li>' : '', '\n                    </ul>\n                </li>\n            </ul>\n        </div>\n        <div style=\"margin:3px 0px 10px 18px;font-weight:bold;\">\n            '.$LANG['items_browser_title'].'\n            <input type=\"text\" name=\"jstree_search\" id=\"jstree_search\" class=\"text ui-widget-content ui-corner-all search_tree\" value=\"'.htmlentities(strip_tags($LANG['item_menu_find']), ENT_QUOTES).'\" />\n        </div>\n        <div id=\"sidebar\" class=\"sidebar\">\n            <div id=\"jstree\" style=\"overflow:auto;\"></div>\n        </div>\n    </div>';\n// Zone top right - items list\necho '\n    <div id=\"items_content\">\n        <div id=\"items_center\">\n            <div id=\"items_path\" class=\"ui-corner-all\">\n                <div class=\"quick_menu1\" style=\"float:left; margin-right: 5px;\">\n                    <ul class=\"quick_menu\">\n                        <li><i class=\"fa fa-bars\"></i>\n                            <ul class=\"menu_250\">\n                                <li id=\"menu_button_add_item\" onclick=\"open_add_item_div()\"><i class=\"fa fa-plus fa-fw\"></i>&nbsp; '.$LANG['item_menu_add_elem'].'</li>\n                                <li id=\"menu_button_edit_item\" onclick=\"open_edit_item_div(', isset($SETTINGS['restricted_to_roles']) && $SETTINGS['restricted_to_roles'] == 1 ? 1 : 0, ')\"><i class=\"fa fa-pencil fa-fw\"></i>&nbsp; '.$LANG['item_menu_edi_elem'].'</li>\n                                <li id=\"menu_button_del_item\" onclick=\"open_del_item_div()\"><i class=\"fa fa-eraser fa-fw\"></i>&nbsp; '.$LANG['item_menu_del_elem'].'</li>\n                                <li id=\"menu_button_copy_item\" onclick=\"open_copy_item_to_folder_div()\"><i class=\"fa fa-copy fa-fw\"></i>&nbsp; '.$LANG['item_menu_copy_elem'].'</li>\n                            </ul>\n                        </li>\n                    </ul>\n                </div>\n\n                <div style=\"margin-top: 3px;\">\n                    <div id=\"txt1\"  style=\"float:left;\">\n                        <span id=\"items_path_var\"></span>\n                    </div>\n\n                    <div class=\"input-group margin-bottom-sm\" style=\"float:right; margin-top:-1px;\">\n                        <span class=\"input-group-addon\"><i class=\"fa fa-binoculars fa-fw\"></i></span>\n                        <input class=\"form-control text ui-widget-content\" type=\"text\" onkeypress=\"javascript:if (event.keyCode == 13) globalItemsSearch();\" id=\"search_item\" />\n                    </div>\n\n                    <i id=\"items_list_loader\" style=\"float:right;margin-right:5px;\" class=\"fa fa-cog fa-spin mi-red hidden\"></i>&nbsp;\n                </div>\n            </div>\n            <div id=\"items_list\"></div>\n        </div>';\n// Zone ITEM DETAIL\necho '\n        <div id=\"item_details_ok\">\n            <input type=\"hidden\" id=\"id_categorie\" value=\"\" />\n            <input type=\"hidden\" id=\"id_item\" value=\"\" />\n            <input type=\"hidden\" id=\"hid_anyone_can_modify\" value=\"\" />\n            <div style=\"height:220px;overflow-y:auto;\" id=\"item_details_scroll\">\n                <div id=\"handle\" class=\"ui-resizable-handle ui-resizable-n\"></div>';\n\necho'\n                <div id=\"item_details_expired\" style=\"display:none;background-color:white; margin:5px;\">\n                    <div class=\"ui-state-error ui-corner-all\" style=\"padding:2px;\">\n                        <i class=\"fa fa-warning\"></i>&nbsp;<b>'.$LANG['pw_is_expired_-_update_it'].'</b>\n                    </div>\n                </div>\n                <table width=\"100%\" class=\"no-border\" id=\"item_details_table\">';\n// Line for LABEL\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\" width=\"120px\" style=\"background-color:rgba(178, 178, 178, 0.13);\">\n                        <div class=\"quick_menu2\" style=\"float:left; margin-right: 5px;\">\n                            <ul class=\"quick_menu ui-menu\">\n                                <li><i class=\"fa fa-bars\"></i>\n                                    <ul class=\"menu_250\">\n                                        <li id=\"menu_button_copy_pw\" class=\"copy_clipboard\"><i class=\"fa fa-lock fa-fw\"></i>&nbsp; '.$LANG['pw_copy_clipboard'].'</li>\n                                        <li id=\"menu_button_copy_login\" class=\"copy_clipboard\"><i class=\"fa fa-user fa-fw\"></i>&nbsp; '.$LANG['login_copy'].'</li>\n                                        <li id=\"menu_button_show_pw\" onclick=\"ShowPassword()\"><i class=\"fa fa-eye fa-fw\"></i>&nbsp; '.$LANG['mask_pw'].'</li>\n                                        <li id=\"menu_button_copy_link\" class=\"copy_clipboard\"><i class=\"fa fa-link fa-fw\"></i>&nbsp; '.$LANG['url_copy'].'</li>\n                                        <li id=\"menu_button_history\" onclick=\"OpenDialog(\\'div_item_history\\', \\'false\\')\"><i class=\"fa fa-history fa-fw\"></i>&nbsp; '.$LANG['history'].'</li>\n                                        <li id=\"menu_button_share\" onclick=\"OpenDialog(\\'div_item_share\\', \\'false\\')\"><i class=\"fa fa-share fa-fw\"></i>&nbsp; '.$LANG['share'].'</li>',\n                                        (isset($SETTINGS['otv_is_enabled']) && $SETTINGS['otv_is_enabled'] == 1) ? '<li id=\"menu_button_otv\" onclick=\"prepareOneTimeView()\"><i class=\"fa fa-users fa-fw\"></i>&nbsp; '.$LANG['one_time_item_view'].'</li>' : '', '\n                                        ', isset($SETTINGS['enable_email_notification_on_item_shown']) && $SETTINGS['enable_email_notification_on_item_shown'] == 1 ? '\n                                        <li id=\"menu_button_notify\"><i class=\"fa fa-volume-up fa-fw\"></i>&nbsp; '.$LANG['notify_me_on_change'].'</li>' : '', '\n                                        ', isset($SETTINGS['enable_server_password_change']) && $SETTINGS['enable_server_password_change'] == 1 && isset($_SESSION['user_read_only']) && $_SESSION['user_read_only'] !== \"1\" ? '\n                                        <li onclick=\"serverAutoChangePwd()\"><i class=\"fa fa-server fa-fw\"></i>&nbsp; '.$LANG['update_server_password'].'</li>' : '', '\n                                        ', isset($SETTINGS['enable_suggestion']) && $SETTINGS['enable_suggestion'] == 1 ? '\n                                        <li onclick=\"OpenDialog(\\'div_suggest_change\\', \\'false\\')\"><i class=\"fa fa-random fa-fw\"></i>&nbsp; '.$LANG['suggest_password_change'].'</li>' : '', '\n                                    </ul>\n                                </li>\n                            </ul>\n                        </div>\n                    </td>\n                    <td valign=\"middle\" style=\"background-color:rgba(178, 178, 178, 0.13);\">\n                        <span id=\"id_label\" style=\"font-weight:bold;\"></span>\n                    </td>\n                    <td style=\"background-color:rgba(178, 178, 178, 0.13);\">\n                        <input type=\"hidden\" id=\"hid_label\" value=\"', isset($dataItem) ? htmlspecialchars($dataItem['label']) : '', '\" />\n                        <div style=\"float:right; font-family:arial; margin-right:5px;\" id=\"item_viewed_x_times\"></div>\n\n                        <!-- INFO -->\n                        <div class=\"\" style=\"float:right;margin-right:5px;\" id=\"item_extra_info\" title=\"\"></div>\n                        <!-- INFO END -->\n\n                    </td>\n                </tr>';\n// Line for DESCRIPTION\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\" width=\"180px\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['description'].' :</td>\n                    <td colspan=\"2\">\n                        <div id=\"id_desc\" style=\"font-style:italic;display:inline;\"></div><input type=\"hidden\" id=\"hid_desc\" value=\"', isset($dataItem) ? htmlspecialchars($dataItem['description']) : '', '\" />\n                    </td>\n                </tr>';\n// Line for PW\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['pw'].' :<span id=\"button_quick_pw_copy\" class=\"fa fa-paste fa-border fa-sm tip\" style=\"cursor:pointer;display:none;float:right;margin-right:2px;\" title=\"'.$LANG['item_menu_copy_pw'].'\"></i></td>\n                    <td colspan=\"2\">\n                        &nbsp;\n                        <div id=\"id_pw\" class=\"unhide_masked_data\" style=\"float:left; cursor:pointer; width:300px;\"></div>\n                        <input type=\"hidden\" id=\"hid_pw\" value=\"\" />\n                        <input type=\"hidden\" id=\"pw_shown\" value=\"0\" />\n                    </td>\n                </tr>';\n// Line for LOGIN\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['index_login'].' :<span id=\"button_quick_login_copy\" class=\"fa fa-paste fa-border fa-sm tip\" style=\"cursor:pointer;display:none;float:right;margin-right:2px;\" title=\"'.$LANG['item_menu_copy_login'].'\"></span></td>\n                    <td colspan=\"2\">\n                        <div id=\"id_login\" style=\"float:left;\"></div>\n                        <input type=\"hidden\" id=\"hid_login\" value=\"\" />\n                    </td>\n                </tr>';\n// Line for EMAIL\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['email'].' :</td>\n                    <td colspan=\"2\">\n                        <div id=\"id_email\" style=\"display:inline;\"></div><input type=\"hidden\" id=\"hid_email\" value=\"\" />\n                    </td>\n                </tr>';\n// Line for URL\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['url'].' :</td>\n                    <td colspan=\"2\">\n                        <div id=\"id_url\" style=\"display:inline;\"></div><input type=\"hidden\" id=\"hid_url\" value=\"\" />\n                    </td>\n                </tr>';\n// Line for FILES\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['files_&_images'].' :</td>\n                    <td colspan=\"2\">\n                        <div id=\"id_files\" style=\"display:inline;font-size:11px;\"></div><input type=\"hidden\" id=\"hid_files\" />\n                        <div id=\"dialog_files\" style=\"display: none;\">\n\n                        </div>\n                    </td>\n                </tr>';\n// Line for RESTRICTED TO\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['restricted_to'].' :</td>\n                    <td colspan=\"2\">\n                        <div id=\"id_restricted_to\" style=\"display:inline;\"></div><input type=\"hidden\" id=\"hid_restricted_to\" /><input type=\"hidden\" id=\"hid_restricted_to_roles\" />\n                    </td>\n                </tr>';\n// Line for TAGS\necho '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['tags'].' :</td>\n                    <td colspan=\"2\">\n                        <div id=\"id_tags\" style=\"display:inline;\"></div><input type=\"hidden\" id=\"hid_tags\" />\n                    </td>\n                </tr>';\n// Line for KBs\nif (isset($SETTINGS['enable_kb']) && $SETTINGS['enable_kb'] == 1) {\n    echo '\n                <tr>\n                    <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$LANG['kbs'].' :</td>\n                    <td colspan=\"2\">\n                        <div id=\"id_kbs\" style=\"display:inline;\"></div><input type=\"hidden\" id=\"hid_kbs\" />\n                    </td>\n                </tr>';\n}\n// lines for FIELDS\nif (isset($SETTINGS['item_extra_fields']) && $SETTINGS['item_extra_fields'] == 1) {\n    foreach ($_SESSION['item_fields'] as $elem) {\n        $itemCatName = $elem[0];\n        echo '\n                <tr class=\"tr_fields hidden\" id=\"tr_catfield_'.$elem[0].'\">\n                    <td valign=\"top\" class=\"td_title\">&nbsp;<i class=\"fa fa-angle-right\"></i>&nbsp;'.$elem[1].' :</td>\n                    <td colspan=\"2\"></td>\n                </tr>';\n        foreach ($elem[2] as $field) {\n            echo '\n                    <tr class=\"tr_cf tr_fields hidden\" id=\"cf_tr_'.$field[0].'\">\n                        <td valign=\"top\" class=\"td_title\">&nbsp;&nbsp;<i class=\"fa fa-caret-right\"></i>&nbsp;<i>'.$field[1].'</i> :</td>\n                        <td colspan=\"2\">';\n            if ($field[3] === \"masked\") {\n                echo '\n                            <div id=\"id_field_'.htmlspecialchars($field[0]).'_'.$elem[0].'\" style=\"float:left; cursor:pointer; width:300px;\" class=\"fields_div unhide_masked_data pointer\"></div><input type=\"hidden\" id=\"hid_field_'.htmlspecialchars($field[0]).'_'.$elem[0].'\" class=\"fields\" />';\n            } else {\n                echo '\n                            <div id=\"id_field_'.htmlspecialchars($field[0]).'_'.$elem[0].'\" style=\"display:inline;\" class=\"fields_div\"></div><input type=\"hidden\" id=\"hid_field_'.htmlspecialchars($field[0]).'_'.$elem[0].'\" class=\"fields\" />';\n            }\n            echo '\n                        </td>\n                    </tr>';\n        }\n    }\n}\necho '\n                </table>\n            </div>\n        </div>';\n// # NOT ALLOWED\necho '\n        <div id=\"item_details_nok\" class=\"hidden\" style=\"width:400px; margin:20px auto 20px auto;\">\n            <div class=\"ui-state-highlight ui-corner-all\" style=\"padding:10px;\">\n                <i class=\"fa fa-warning fa-2x mi-red\"></i>&nbsp;<b>'.$LANG['not_allowed_to_see_pw'].'</b>\n                <span id=\"item_details_nok_restriction_list\"></span>\n            </div>\n        </div>';\n// DATA EXPIRED\necho '\n        <div id=\"item_details_expired_full\" style=\"display:none; width:400px; margin:20px auto 20px auto;\">\n            <div class=\"ui-state-error ui-corner-all\" style=\"padding:10px;\">\n                <i class=\"fa fa-warning fa-2x mi-red\"></i>&nbsp;<b>'.$LANG['pw_is_expired_-_update_it'].'</b>\n            </div>\n        </div>';\n// # NOT ALLOWED\necho '\n        <div id=\"item_details_no_personal_saltkey\" style=\"display:none; width:400px; margin:20px auto 20px auto; height:180px;\">\n            <div class=\"ui-state-highlight ui-corner-all\" style=\"padding:10px;\">\n                <i class=\"fa fa-warning fa-2x mi-red\"></i>&nbsp;<b>'.$LANG['home_personal_saltkey_info'].'</b>\n            </div>\n        </div>';\n\necho '\n    </div>';\n\necho '\n</div>';\n\n\n/********************************\n* NEW Item Form\n*/\necho '\n<div id=\"div_formulaire_saisi\" style=\"display:none;\">\n    <form method=\"post\" name=\"new_item\" action=\"\">\n        <div id=\"afficher_visibilite\" style=\"text-align:center;margin-bottom:6px;height:20px;\"></div>\n        <div id=\"display_title\" style=\"text-align:center;margin-bottom:6px;font-size:17px;font-weight:bold;height:25px;\"></div>\n        <div id=\"new_show_error\" style=\"text-align:center;margin:2px;display:none;\" class=\"ui-state-error ui-corner-all\"></div>\n\n        <div id=\"item_tabs\">\n        <ul>\n            <li><a href=\"#tabs-01\">'.$LANG['definition'].'</a></li>\n            <li><a href=\"#tabs-02\">'.$LANG['index_password'].' &amp; '.$LANG['visibility'].'</a></li>\n            <li><a href=\"#tabs-03\">'.$LANG['files_&_images'].'</a></li>\n            ', isset($SETTINGS['item_extra_fields']) && $SETTINGS['item_extra_fields'] == 1 ?\n            '<li id=\"form_tab_fields\"><a href=\"#tabs-04\">'.$LANG['more'].'</a></li>' : '', '\n        </ul>\n        <div id=\"tabs-01\">';\n// Line for LABEL\necho '\n            <label for=\"\" class=\"label_cpm\">'.$LANG['label'].' : </label>\n            <input type=\"text\" name=\"label\" id=\"label\" onchange=\"checkTitleDuplicate(this.value, \\'', isset($SETTINGS['item_duplicate_in_same_folder']) && $SETTINGS['item_duplicate_in_same_folder'] == 1 ? 0 : 1, '\\', \\'', isset($SETTINGS['duplicate_item']) && $SETTINGS['duplicate_item'] == 1 ? 0 : 1, '\\', \\'display_title\\')\" class=\"input_text text ui-widget-content ui-corner-all\" />';\n// Line for DESCRIPTION\necho '\n            <label for=\"\" class=\"label_cpm\">'.$LANG['description'].' : </label>\n            <span id=\"desc_span\">\n                <textarea rows=\"5\" cols=\"60\" name=\"desc\" id=\"desc\" class=\"input_text\"></textarea>\n            </span>\n            <br />';\n// Line for FOLDERS\necho '\n            <label for=\"\" class=\"\">'.$LANG['group'].' : </label>\n            <select name=\"categorie\" id=\"categorie\" onchange=\"RecupComplexite(this.value,0)\" style=\"width:250px; padding:3px;\" class=\"ui-widget-content\"><option style=\"display: none;\"></option></select>';\n// Line for LOGIN\necho '\n            <label for=\"\" class=\"label_cpm\" style=\"margin-top:10px;\">'.$LANG['login'].' : </label>\n            <input type=\"text\" name=\"item_login\" id=\"item_login\" class=\"input_text text ui-widget-content ui-corner-all\" />';\n// Line for EMAIL\necho '\n            <label for=\"\" class=\"label_cpm\">'.$LANG['email'].' : </label>\n            <input type=\"text\" name=\"email\" id=\"email\" class=\"input_text text ui-widget-content ui-corner-all\" />';\n// Line for URL\necho '\n            <label for=\"\" class=\"label_cpm\">'.$LANG['url'].' : </label>\n            <input type=\"text\" name=\"url\" id=\"url\" class=\"input_text text ui-widget-content ui-corner-all\" />\n        </div>';\n// Tabs Items N?2\necho '\n        <div id=\"tabs-02\">';\n// Line for folder complexity\necho'\n            <div style=\"margin-bottom:10px;\" id=\"expected_complexity\">\n                <label for=\"\" class=\"form_label_180\">'.$LANG['complex_asked'].'</label>\n                <span id=\"complex_attendue\" style=\"color:#D04806; margin-left:40px;\"></span>\n            </div>';\n// Line for PW\necho '\n            <label class=\"label_cpm\">'.$LANG['used_pw'].' :<span id=\"prout\"></span>\n                <span id=\"visible_pw\" style=\"display:none;margin-left:10px;font-weight:bold;\"></span>\n                <span id=\"pw_wait\" style=\"display:none;margin-left:10px;\"><span class=\"fa fa-cog fa-spin fa-1x\"></span></span>\n            </label>\n            <input type=\"password\" id=\"pw1\" class=\"input_text text ui-widget-content ui-corner-all\" />\n            <input type=\"hidden\" id=\"mypassword_complex\" />\n            <label for=\"\" class=\"label_cpm\">'.$LANG['index_change_pw_confirmation'].' :</label>\n            <input type=\"password\" name=\"pw2\" id=\"pw2\" class=\"input_text text ui-widget-content ui-corner-all\" />\n\n            <div style=\"font-size:9px; text-align:center; width:100%;\">\n                <span id=\"custom_pw\">\n                    <input type=\"checkbox\" id=\"pw_numerics\" /><label for=\"pw_numerics\">123</label>\n                    <input type=\"checkbox\" id=\"pw_maj\" /><label for=\"pw_maj\">ABC</label>\n                    <input type=\"checkbox\" id=\"pw_symbols\" /><label for=\"pw_symbols\">@#&amp;</label>\n                    <input type=\"checkbox\" id=\"pw_secure\" checked=\"checked\" /><label for=\"pw_secure\">'.$LANG['secure'].'</label>\n                    &nbsp;<label for=\"pw_size\">'.$LANG['size'].' : </label>\n                    &nbsp;<input type=\"text\" size=\"2\" id=\"pw_size\" value=\"8\" style=\"font-size:10px;\" />\n                </span>\n\n                <span class=\"fa-stack fa-lg tip\" title=\"'.$LANG['pw_generate'].'\" onclick=\"pwGenerate(\\'\\')\" style=\"cursor:pointer;\">\n                    <i class=\"fa fa-square fa-stack-2x\"></i>\n                    <i class=\"fa fa-cogs fa-stack-1x fa-inverse\"></i>\n                </span>&nbsp;\n                <span class=\"fa-stack fa-lg tip\" title=\"'.$LANG['copy'].'\" onclick=\"pwCopy(\\'\\')\" style=\"cursor:pointer;\">\n                    <i class=\"fa fa-square fa-stack-2x\"></i>\n                    <i class=\"fa fa-copy fa-stack-1x fa-inverse\"></i>\n                </span>&nbsp;\n                <span class=\"fa-stack fa-lg tip\" title=\"'.$LANG['mask_pw'].'\" onclick=\"showPwd()\" style=\"cursor:pointer;\">\n                    <i class=\"fa fa-square fa-stack-2x\"></i>\n                    <i class=\"fa fa-eye fa-stack-1x fa-inverse\"></i>\n                </span>\n            </div>\n            <div style=\"width:100%;\">\n                <div id=\"pw_strength\" style=\"margin:5px 0 5px 120px;\"></div>\n            </div>';\n\n// Line for RESTRICTED TO\nif (isset($SETTINGS['restricted_to']) && $SETTINGS['restricted_to'] == 1) {\n    echo '\n            <label for=\"\" class=\"label_cpm\">'.$LANG['restricted_to'].' : </label>\n            <select name=\"restricted_to_list\" id=\"restricted_to_list\" multiple=\"multiple\" style=\"width:100%;\" class=\"ui-widget-content\"></select>\n            <input type=\"hidden\" name=\"restricted_to\" id=\"restricted_to\" />\n            <input type=\"hidden\" size=\"50\" name=\"restricted_to_roles\" id=\"restricted_to_roles\" />\n            <div style=\"line-height:10px;\">&nbsp;</div>';\n}\n// Line for TAGS\necho '\n            <label for=\"\" class=\"label_cpm\">'.$LANG['tags'].' : </label>\n            <input type=\"text\" name=\"item_tags\" id=\"item_tags\" class=\"input_text text ui-widget-content ui-corner-all\" />';\n// Line for Item modification\necho '\n            <div style=\"width:100%;margin:0px 0px 6px 0px;', isset($SETTINGS['anyone_can_modify']) && $SETTINGS['anyone_can_modify'] == 1 ? '' : 'display:none;', '\">\n                <input type=\"checkbox\" name=\"anyone_can_modify\" id=\"anyone_can_modify\"',\n                    isset($SETTINGS['anyone_can_modify_bydefault'])\n                    && $SETTINGS['anyone_can_modify_bydefault'] == 1 ?\n                    ' checked=\"checked\"' : '', ' />\n                <label for=\"anyone_can_modify\">'.$LANG['anyone_can_modify'].'</label>\n            </div>';\n// Line for Item automatically deleted\necho '\n            <div style=\"width:100%;margin:0px 0px 6px 0px;', isset($SETTINGS['enable_delete_after_consultation']) && $SETTINGS['enable_delete_after_consultation'] == 1 ? '' : 'display:none;', '\">\n                <input type=\"checkbox\" name=\"enable_delete_after_consultation\" id=\"enable_delete_after_consultation\" />\n                <label for=\"enable_delete_after_consultation\">'.$LANG['enable_delete_after_consultation'].'</label>\n                <input type=\"text\" value=\"1\" size=\"1\" id=\"times_before_deletion\" />&nbsp;'.$LANG['times'].'&nbsp;\n                '.$LANG['automatic_del_after_date_text'].'&nbsp;<input type=\"text\" value=\"\" class=\"datepicker\" readonly=\"readonly\" size=\"10\" id=\"deletion_after_date\" onchange=\"$(\\'#times_before_deletion\\').val(\\'\\')\" />\n            </div>';\n// Line for EMAIL\necho '\n            <div>\n                <div style=\"line-height:10px;\">&nbsp;</div>\n                <label for=\"\" class=\"label_cpm\">'.$LANG['email_announce'].' : </label>\n                <select id=\"annonce_liste_destinataires\" multiple=\"multiple\" style=\"width:100%\">';\nforeach ($usersList as $user) {\n                    echo '<option value=\"'.$user['email'].'\">'.$user['login'].'</option>';\n}\n                echo '\n                </select>\n            </div>';\n\necho '\n\n        </div>';\n// Tabs EDIT N?3\necho '\n        <div id=\"tabs-03\">\n            <div id=\"item_upload\">\n                <div id=\"item_upload_list\"></div><br />\n                <div id=\"item_upload_wait\" class=\"ui-state-focus ui-corner-all hidden\" style=\"padding:2px;margin:5px 0 5px 0;\">'.$LANG['please_wait'].'...</div>\n                <a id=\"item_attach_pickfiles\" href=\"#\" class=\"button\">'.$LANG['select'].'</a>\n                <a id=\"item_attach_uploadfiles\" href=\"#\" class=\"button\">'.$LANG['start_upload'].'</a>\n                <input type=\"hidden\" id=\"files_number\" value=\"0\" />\n            </div>\n        </div>';\n// Tabs N\u00b04\nif (isset($SETTINGS['item_extra_fields']) && $SETTINGS['item_extra_fields'] == 1) {\n    echo '\n        <div id=\"tabs-04\">\n            <div id=\"item_more\">';\n    // load all categories and fields\n    foreach ($_SESSION['item_fields'] as $elem) {\n        $itemCatName = $elem[0];\n        echo '\n                <div id=\"newItemCatName_'.$itemCatName.'\" class=\"newItemCat\">\n                    <div style=\"font-weight:bold;font-size:12px;\">\n                        <span class=\"fa fa-folder-open mi-grey-1\">&nbsp;</span>'.$elem[1].'\n                    </div>';\n        foreach ($elem[2] as $field) {\n                echo '\n                    <div style=\"margin:2px 0 2px 15px;\">\n                        <span class=\"fa fa-tag mi-grey-1\">&nbsp;</span>\n                        <label class=\"cpm_label\">'.$field[1].'</span>\n                        <input type=\"text\" id=\"field_'.$field[0].'_'.$field[2].'\" class=\"item_field input_text text ui-widget-content ui-corner-all\" size=\"40\">\n                    </div>';\n        }\n        echo '\n                </div>';\n    }\n    echo '\n            </div>\n        </div>';\n}\necho '\n    </div>';\necho '\n    </form>\n    <div style=\"display:none; padding:5px; margin-top:5px; text-align:center;\" id=\"div_formulaire_saisi_info\" class=\"ui-state-default ui-corner-all\"></div>\n</div>';\n\n/***************************\n* Edit Item Form\n*/\necho '\n<div id=\"div_formulaire_edition_item\" style=\"display:none;\">\n    <form method=\"post\" name=\"form_edit\" action=\"\">\n    <div id=\"edit_afficher_visibilite\" style=\"text-align:center;margin-bottom:6px;height:25px;\"></div>\n    <div id=\"edit_display_title\" style=\"text-align:center;margin-bottom:6px;font-size:17px;font-weight:bold;height:25px;\"></div>\n    <div id=\"edit_show_error\" style=\"text-align:center;margin:2px;display:none;\" class=\"ui-state-error ui-corner-all\"></div>';\n// Prepare TABS\necho '\n    <div id=\"item_edit_tabs\">\n        <ul>\n            <li><a href=\"#tabs-1\">'.$LANG['definition'].'</a></li>\n            <li><a href=\"#tabs-2\">'.$LANG['index_password'].' &amp; '.$LANG['visibility'].'</a></li>\n            <li><a href=\"#tabs-3\">'.$LANG['files_&_images'].'</a></li>\n            ', isset($SETTINGS['item_extra_fields']) && $SETTINGS['item_extra_fields'] == 1 ?\n            '<li id=\"form_edit_tab_fields\"><a href=\"#tabs-4\">'.$LANG['more'].'</a></li>' : '', '\n        </ul>\n        <div id=\"tabs-1\">\n            <label for=\"\" class=\"cpm_label\">'.$LANG['label'].' : </label>\n            <input type=\"text\" size=\"60\" id=\"edit_label\" onchange=\"checkTitleDuplicate(this.value, \\'', isset($SETTINGS['item_duplicate_in_same_folder']) && $SETTINGS['item_duplicate_in_same_folder'] == 1 ? 0 : 1, '\\', \\'', isset($SETTINGS['duplicate_item']) && $SETTINGS['duplicate_item'] == 1 ? 0 : 1, '\\', \\'edit_display_title\\')\" class=\"input_text text ui-widget-content ui-corner-all\" />\n\n            <label for=\"\" class=\"cpm_label\">'.$LANG['description'].'&nbsp;<span class=\"fa fa-eraser\" style=\"cursor:pointer;\" onclick=\"clear_html_tags()\"></span>&nbsp;</label>\n            <span id=\"edit_desc_span\">\n                <textarea rows=\"5\" cols=\"70\" id=\"edit_desc\" name=\"edit_desc\" class=\"input_text\"></textarea>\n            </span>';\n// Line for FOLDER\necho '\n            <div style=\"margin:10px 0px 10px 0px;\">\n            <label for=\"\" class=\"\">'.$LANG['group'].' : </label>\n            <select id=\"edit_categorie\" onchange=\"RecupComplexite(this.value,1)\" style=\"width:100%;\"><option style=\"display: none;\"></option></select>\n            </div>';\n// Line for LOGIN\necho '\n            <label for=\"\" class=\"cpm_label\">'.$LANG['login'].' : </label>\n            <input type=\"text\" id=\"edit_item_login\" class=\"input_text text ui-widget-content ui-corner-all\" />\n\n            <label for=\"\" class=\"cpm_label\">'.$LANG['email'].' : </label>\n            <input type=\"text\" id=\"edit_email\" class=\"input_text text ui-widget-content ui-corner-all\" />\n\n            <label for=\"\" class=\"cpm_label\">'.$LANG['url'].' : </label>\n            <input type=\"text\" id=\"edit_url\" class=\"input_text text ui-widget-content ui-corner-all\" />\n        </div>';\n// TABS edit n?2\necho '\n        <div id=\"tabs-2\">';\n// Line for folder complexity\necho'\n            <div style=\"margin-bottom:10px;\" id=\"edit_expected_complexity\">\n                <label for=\"\" class=\"cpm_label\">'.$LANG['complex_asked'].'</label>\n                <span id=\"edit_complex_attendue\" style=\"color:#D04806;\"></span>\n            </div>';\n\necho '\n            <div style=\"line-height:20px;\">\n                <label for=\"\" class=\"label_cpm\">'.$LANG['used_pw'].' :\n                    <span id=\"edit_visible_pw\" style=\"display:none;margin-left:10px;font-weight:bold; padding:2px;\" class=\"ui-corner-all ui-state-default\"></span>\n                    <span id=\"edit_pw_wait\" style=\"margin-left:10px;\" class=\"hidden\"><span class=\"fa fa-cog fa-spin fa-1x\"></span></span>\n                </label>\n                <input type=\"password\" id=\"edit_pw1\" class=\"input_text text ui-widget-content ui-corner-all\" style=\"width:390px;\" />\n                <span class=\"fa fa-history tip\" style=\"cursor:pointer;\" id=\"edit_past_pwds\" onclick=\"showPasswordsHistory()\"></span>\n                <div style=\"display:none; padding:3px; width:390px; font-weight:normal; font-size:11px; font-family:italic;\" id=\"edit_past_pwds_div\" class=\"ui-corner-all ui-state-default\"></div>\n                <input type=\"hidden\" id=\"edit_mypassword_complex\" />\n\n                <label for=\"\" class=\"cpm_label\">'.$LANG['confirm'].' : </label>\n                <input type=\"password\" id=\"edit_pw2\" class=\"input_text text ui-widget-content ui-corner-all\" style=\"width:390px;\" />\n            </div>\n            <div style=\"font-size:9px; text-align:center; width:100%;\">\n                <span id=\"edit_custom_pw\">\n                    <input type=\"checkbox\" id=\"edit_pw_numerics\" /><label for=\"edit_pw_numerics\">123</label>\n                    <input type=\"checkbox\" id=\"edit_pw_maj\" /><label for=\"edit_pw_maj\">ABC</label>\n                    <input type=\"checkbox\" id=\"edit_pw_symbols\" /><label for=\"edit_pw_symbols\">@#&amp;</label>\n                    <input type=\"checkbox\" id=\"edit_pw_secure\" checked=\"checked\" /><label for=\"edit_pw_secure\">'.$LANG['secure'].'</label>\n                    &nbsp;<label for=\"edit_pw_size\">'.$LANG['size'].' : </label>\n                    &nbsp;<input type=\"text\" size=\"2\" id=\"edit_pw_size\" value=\"8\" style=\"font-size:10px;\" />\n                </span>\n\n                <span class=\"fa-stack fa-lg tip\" title=\"'.$LANG['pw_generate'].'\" onclick=\"pwGenerate(\\'edit\\')\" style=\"cursor:pointer;\">\n                    <i class=\"fa fa-square fa-stack-2x\"></i>\n                    <i class=\"fa fa-cogs fa-stack-1x fa-inverse\"></i>\n                </span>&nbsp;\n                <span class=\"fa-stack fa-lg tip\" title=\"'.$LANG['copy'].'\" onclick=\"pwCopy(\\'edit\\')\" style=\"cursor:pointer;\">\n                    <i class=\"fa fa-square fa-stack-2x\"></i>\n                    <i class=\"fa fa-copy fa-stack-1x fa-inverse\"></i>\n                </span>&nbsp;\n                <span class=\"fa-stack fa-lg tip\" title=\"'.$LANG['mask_pw'].'\" onclick=\"ShowPasswords_EditForm()\" style=\"cursor:pointer;\">\n                    <i class=\"fa fa-square fa-stack-2x\"></i>\n                    <i class=\"fa fa-eye fa-stack-1x fa-inverse\"></i>\n                </span>\n            </div>\n            <div style=\"width:100%;\">\n                <div id=\"edit_pw_strength\" style=\"margin:5px 0 5px 120px;\"></div>\n            </div>';\n\nif (isset($SETTINGS['restricted_to']) && $SETTINGS['restricted_to'] == 1) {\n    echo '\n            <div id=\"div_editRestricted\">\n                <label for=\"\" class=\"label_cpm\">'.$LANG['restricted_to'].' : </label>\n                <select name=\"edit_restricted_to_list\" id=\"edit_restricted_to_list\" multiple=\"multiple\" style=\"width:100%\"></select>\n                <input type=\"hidden\" size=\"50\" name=\"edit_restricted_to\" id=\"edit_restricted_to\" />\n                <input type=\"hidden\" size=\"50\" name=\"edit_restricted_to_roles\" id=\"edit_restricted_to_roles\" />\n                <div style=\"line-height:10px;\">&nbsp;</div>\n            </div>';\n}\n\necho '\n            <label for=\"\" class=\"cpm_label\">'.$LANG['tags'].' : </label>\n            <input type=\"text\" size=\"50\" name=\"edit_tags\" id=\"edit_tags\" class=\"input_text text ui-widget-content ui-corner-all\" />';\n// Line for Item modification\necho '\n            <div style=\"width:100%;margin:0px 0px 6px 0px;', isset($SETTINGS['anyone_can_modify']) && $SETTINGS['anyone_can_modify'] == 1 ? '' : 'display:none;', '\">\n                <input type=\"checkbox\" name=\"edit_anyone_can_modify\" id=\"edit_anyone_can_modify\"',\n                    isset($SETTINGS['anyone_can_modify_bydefault'])\n                    && $SETTINGS['anyone_can_modify_bydefault'] == 1 ?\n                    ' checked=\"checked\"' : '', ' />\n                <label for=\"edit_anyone_can_modify\">'.$LANG['anyone_can_modify'].'</label>\n            </div>';\n// Line for Item automatically deleted\necho '\n            <div id=\"edit_to_be_deleted\" style=\"width:100%;margin:0px 0px 6px 0px;', isset($SETTINGS['enable_delete_after_consultation']) && $SETTINGS['enable_delete_after_consultation'] == 1 ? '' : 'display:none;', '\">\n                <input type=\"checkbox\" name=\"edit_enable_delete_after_consultation\" id=\"edit_enable_delete_after_consultation\" />\n                <label for=\"edit_enable_delete_after_consultation\">'.$LANG['enable_delete_after_consultation'].'</label>\n                <input type=\"text\" value=\"\" size=\"1\" id=\"edit_times_before_deletion\" onchange=\"$(\\'#edit_deletion_after_date\\').val(\\'\\')\" />&nbsp;'.$LANG['times'].'&nbsp;\n                '.$LANG['automatic_del_after_date_text'].'&nbsp;<input type=\"text\" value=\"\" class=\"datepicker\" readonly=\"readonly\" size=\"10\" id=\"edit_deletion_after_date\" onchange=\"$(\\'#edit_times_before_deletion\\').val(\\'\\')\" />\n            </div>';\n\necho '\n            <div id=\"div_anounce_change_by_email\">\n                <div style=\"line-height:10px;\">&nbsp;</div>\n                <label for=\"\" class=\"label_cpm\">'.$LANG['email_announce'].' : </label>\n                <select id=\"edit_annonce_liste_destinataires\" multiple=\"multiple\" style=\"width:100%\">';\nforeach ($usersList as $user) {\n    echo '<option value=\"'.$user['email'].'\">'.$user['login'].'</option>';\n}\necho '\n                </select>\n            </div>';\n\necho '\n        </div>';\n// Tab EDIT N\u00b03\necho '\n        <div id=\"tabs-3\">\n            <div style=\"font-weight:bold;font-size:12px;\">\n                <span class=\"fa fa-folder-open mi-grey-1\">&nbsp;</span>'.$LANG['uploaded_files'].'\n            </div>\n            <div id=\"item_edit_list_files\" style=\"margin-left:5px;\"></div>\n            <div style=\"margin-top:10px;font-weight:bold;font-size:12px;\">\n                <span class=\"fa fa-folder-open mi-grey-1\">&nbsp;</span>'.$LANG['upload_files'].'\n            </div>\n            <div id=\"item_edit_upload\">\n                <div id=\"item_edit_upload_list\"></div><br />\n                <div id=\"item_edit_upload_wait\" class=\"ui-state-focus ui-corner-all hidden\" style=\"padding:2px;margin:5px 0 5px 0;\">'.$LANG['please_wait'].'...</div>\n                <a id=\"item_edit_attach_pickfiles\" href=\"#\" class=\"button\">'.$LANG['select'].'</a>\n                <a id=\"item_edit_attach_uploadfiles\" href=\"#sd\" class=\"button\">'.$LANG['start_upload'].'</a>\n                <input type=\"hidden\" id=\"edit_files_number\" value=\"0\" />\n            </div>\n        </div>';\n// Tabs EDIT N\u00b04 -> Categories\nif (isset($SETTINGS['item_extra_fields']) && $SETTINGS['item_extra_fields'] == 1) {\n    echo '\n        <div id=\"tabs-4\">\n            <div id=\"edit_item_more\">';\n    // load all categories and fields\n    foreach ($_SESSION['item_fields'] as $elem) {\n        echo '\n                <div class=\"editItemCat\" id=\"editItemCatName_'.$elem[0].'\">\n                    <div style=\"font-weight:bold;font-size:12px;\">\n                        <span class=\"fa fa-folder-open mi-grey-1\">&nbsp;</span>'.$elem[1].'\n                    </div>';\n        foreach ($elem[2] as $field) {\n            echo '\n                    <div style=\"margin:2px 0 2px 15px;\">\n                        <span class=\"fa fa-tag mi-grey-1\">&nbsp;</span>\n                        <label class=\"cpm_label\">'.$field[1].'</label>\n                        <input type=\"text\" id=\"edit_field_'.$field[0].'_'.$elem[0].'\" class=\"edit_item_field input_text text ui-widget-content ui-corner-all\" size=\"40\">\n                    </div>';\n        }\n        echo '\n                </div>';\n    }\n    echo '\n            </div>\n        </div>\n    </div>';\n}\necho '\n    <div style=\"padding:5px;\" id=\"div_formulaire_edition_item_info\" class=\"ui-state-default ui-corner-all hidden\"></div>\n    </div>\n    </form>\n</div>';\n\n/*\n* ADD NEW FOLDER form\n*/\necho '\n<div id=\"div_ajout_rep\" style=\"display:none;\">\n    <div id=\"new_rep_show_error\" style=\"text-align:center;margin:2px;\" class=\"ui-state-error ui-corner-all\"></div>\n    <table>\n        <tr>\n            <td>'.$LANG['label'].' : </td>\n            <td><input type=\"text\" id=\"new_rep_titre\" style=\"width:242px; padding:3px;\" class=\"ui-widget-content\" /></td>\n        </tr>\n        <tr>\n            <td>'.$LANG['sub_group_of'].' : </td>\n            <td><select id=\"new_rep_groupe\" style=\"width:250px; padding:3px;\" class=\"ui-widget-content\">\n                ', (isset($SETTINGS['can_create_root_folder']) && $SETTINGS['can_create_root_folder'] == 1 || $_SESSION['user_manager'] === \"1\") ? '<option value=\"0\">'.$LANG['root'].'</option>' : '', '\n            </select></td>\n        </tr>\n        <tr>\n            <td>'.$LANG['complex_asked'].' : </td>\n            <td><select id=\"new_rep_complexite\" style=\"width:250px; padding:3px;\" class=\"ui-widget-content\">';\nforeach ($SETTINGS_EXT['pwComplexity'] as $complex) {\n    echo '<option value=\"'.$complex[0].'\">'.$complex[1].'</option>';\n}\necho '\n            </select>\n            </td>\n        </tr>';\necho '\n    </table>\n    <div id=\"add_folder_loader\" style=\"display:none;text-align:center;margin-top:20px;\">\n        <i class=\"fa fa-cog fa-spin\"></i>&nbsp;'.$LANG['please_wait'].'...\n    </div>\n</div>';\n// Formulaire EDITER REPERTORIE\necho '\n<div id=\"div_editer_rep\" style=\"display:none;\">\n    <div id=\"edit_rep_show_error\" style=\"text-align:center;margin:2px;display:none;\" class=\"ui-state-error ui-corner-all\"></div>\n    <table>\n        <tr>\n            <td>'.$LANG['new_label'].' : </td>\n            <td><input type=\"text\" id=\"edit_folder_title\" style=\"width:242px; padding:3px;\" class=\"ui-widget-content\" /></td>\n        </tr>\n        <tr>\n            <td>'.$LANG['group_select'].' : </td>\n            <td><select id=\"edit_folder_folder\" style=\"width:250px; padding:3px;\" class=\"ui-widget-content\"></select></td>\n        </tr>\n        <tr>\n            <td>'.$LANG['complex_asked'].' : </td>\n            <td><select id=\"edit_folder_complexity\" style=\"width:250px; padding:3px;\" class=\"ui-widget-content\">\n                <option value=\"\">---</option>';\nforeach ($SETTINGS_EXT['pwComplexity'] as $complex) {\n    echo '<option value=\"'.$complex[0].'\">'.$complex[1].'</option>';\n}\necho '\n            </select>\n            </td>\n        </tr>\n    </table>\n    <div id=\"edit_folder_loader\" style=\"display:none;text-align:center;margin-top:20px;\">\n        <i class=\"fa fa-cog fa-spin\"></i>&nbsp;'.$LANG['please_wait'].'...\n    </div>\n</div>';\n// Formulaire MOVE FOLDER\necho '\n<div id=\"div_move_folder\" style=\"display:none;\">\n    <div id=\"move_rep_show_error\" style=\"text-align:center;margin:2px;display:none;\" class=\"ui-state-error ui-corner-all\"></div>\n    <div style=\"text-align:center;margin-top:20px;\">\n        <p>'.$LANG['folder_will_be_moved_below'].'</p>\n        <div>\n        <select id=\"move_folder_id\" style=\"width:250px; padding:3px;\" class=\"ui-widget-content\">\n        </select>\n        </div>\n    </div>\n    <div id=\"move_folder_loader\" style=\"display:none;text-align:center;margin-top:20px;\">\n        <i class=\"fa fa-cog fa-spin\"></i>&nbsp;'.$LANG['please_wait'].'...\n    </div>\n</div>';\n// Formulaire COPY FOLDER\necho '\n<div id=\"div_copy_folder\" style=\"display:none;\">\n    <div id=\"div_copy_folder_info\" class=\"ui-widget-content ui-state-highlight ui-corner-all\" style=\"padding:5px;\"><span class=\"fa fa-info-circle fa-2x\"></span>&nbsp;'.$LANG['copy_folder_info'].'</div>\n\n    <div style=\"margin:10px 0 0 0;\">\n        <label style=\"float:left; width:150px;\">'.$LANG['copy_folder_source'].'</label>\n        <select id=\"copy_folder_source_id\" style=\"width:300px; padding:3px;\" class=\"ui-widget-content\"></select>\n    </div>\n    <div style=\"margin:10px 0 0 0;\">\n        <label style=\"float:left; width:150px;\">'.$LANG['copy_folder_destination'].'</label>\n        <select id=\"copy_folder_destination_id\" style=\"width:300px; padding:3px;\" class=\"ui-widget-content\"></select>\n    </div>\n\n    <div id=\"div_copy_folder_msg\" style=\"text-align:center;padding:5px;display:none; margin-top:10px; font-size:14px;\" class=\"ui-corner-all\"></div>\n</div>';\n// Formulaire SUPPRIMER REPERTORIE\necho '\n<div id=\"div_supprimer_rep\" style=\"display:none;\">\n    <table>\n        <tr>\n            <td>'.$LANG['group_select'].' : </td>\n            <td><select id=\"delete_rep_groupe\" style=\"width:250px; padding:3px;\" class=\"ui-widget-content\">\n            </select></td>\n        </tr>\n        <tr>\n        <td colspan=\"2\">\n            <div id=\"delete_rep_groupe_validate_div\" class=\"ui-state-default ui-corner-all\" style=\"padding:5px; margin-top:10px;\">\n                <input type=\"checkbox\" id=\"delete_rep_groupe_validate\"><label for=\"delete_rep_groupe_validate\">'.$LANG['confirm_delete_group'].'</label>\n            </div>\n        </td>\n        </tr>\n    </table>\n    <div id=\"del_rep_show_error\" style=\"text-align:center;padding:5px;display:none;margin-top:10px;\" class=\"ui-state-error ui-corner-all\"></div>\n\n    <div id=\"del_folder_loader\" style=\"display:none;text-align:center;margin-top:15px;\">\n        <i class=\"fa fa-cog fa-spin\"></i>&nbsp;'.$LANG['please_wait'].'...\n    </div>\n</div>';\n// SUPPRIMER UN ELEMENT\necho '\n<div id=\"div_del_item\" style=\"display:none;\">\n        <h2 id=\"div_del_item_selection\"></h2>\n        <div style=\"text-align:center;padding:8px;\" class=\"ui-state-error ui-corner-all\">\n            <span class=\"fa fa-warning fa-2x\"></span>&nbsp;'.$LANG['confirm_deletion'].'\n        </div>\n</div>';\n// DIALOG INFORM USER THAT LINK IS COPIED\necho '\n<div id=\"div_item_copied\" style=\"display:none;\">\n    <div style=\"text-align:center;padding:8px;\" class=\"ui-state-focus ui-corner-all\">\n        <span class=\"fa fa-info fa-2x\"></span>&nbsp;'.$LANG['link_is_copied'].'\n    </div>\n    <div id=\"div_display_link\"></div>\n</div>';\n// DIALOG TO WHAT FOLDER COPYING ITEM\necho '\n<div id=\"div_copy_item_to_folder\" style=\"display:none;\">\n    <h2 id=\"div_copy_item_to_folder_item\"></h2>\n    <div style=\"text-align:center;\">\n        <div>'.$LANG['item_copy_to_folder'].'</div>\n        <div style=\"margin:10px;\">\n            <select id=\"copy_in_folder\" style=\"width:300px;\">\n                ', (isset($_SESSION['can_create_root_folder']) && $_SESSION['can_create_root_folder'] == 1) ? '<option value=\"0\">'.$LANG['root'].'</option>' : '', ''.\n            '</select>\n        </div>\n    </div>\n    <div id=\"copy_item_to_folder_show_error\" style=\"text-align:center;margin:2px;display:none; padding:3px;\" class=\"ui-state-error ui-corner-all\"></div>\n    <div style=\"height:20px;text-align:center;margin:2px;\" id=\"copy_item_info\" class=\"\"></div>\n</div>';\n// DIALOG FOR HISTORY OF ITEM\necho '\n<div id=\"div_item_history\" style=\"display:none;\">\n    <div id=\"item_history_log\"></div>\n    ', (isset($SETTINGS['insert_manual_entry_item_history']) && $SETTINGS['insert_manual_entry_item_history'] == 1) ?\n'<div id=\"new_history_entry_form\" style=\"display:none; margin-top:10px;\"><hr>\n        <div id=\"div_add_history_entry\">\n            <div id=\"item_history_log_error\"></div>\n            '.$LANG['label'].'&nbsp;<input type=\"text\" id=\"add_history_entry_label\" size=\"40\" />&nbsp;\n            <span class=\"button\" style=\"margin-top:6px;\" onclick=\"manage_history_entry(\\'add_entry\\',\\'\\')\">'.$LANG['add_history_entry'].'</div>\n        </div>\n    </div>'\n:'', '\n</div>';\n// DIALOG FOR ITEM SHARE\necho '\n<div id=\"div_item_share\" style=\"display:none;\">\n    <div id=\"div_item_share_error\" style=\"text-align:center;margin:2px;display:none;\" class=\"ui-state-error ui-corner-all\"></div>\n    <div style=\"\">'.$LANG['item_share_text'].'</div>\n    <input type=\"text\" id=\"item_share_email\" class=\"ui-corner-all\" style=\"width:100%;\" />\n    <div id=\"div_item_share_status\" style=\"text-align:center;margin-top:15px;display:none; padding:5px;\" class=\"ui-corner-all\">\n        <i class=\"fa fa-cog fa-spin fa-2x\"></i>&nbsp;<b>'.$LANG['please_wait'].'</b>\n    </div>\n</div>';\n// DIALOG FOR ITEM IS UPDATED\necho '\n<div id=\"div_item_updated\" style=\"display:none;\">\n    <div style=\"\">'.$LANG['item_updated_text'].'</div>\n</div><br />';\n\n// DIALOG FOR SUGGESTING PWD CHANGE\necho '\n<div id=\"div_suggest_change\" style=\"display:none;\">\n    <div style=\"padding:5px; text-align:center;\" class=\"ui-corner-all ui-state-default\"><i class=\"fa fa-info-circle fa-lg\"></i>&nbsp;'.$LANG['suggest_password_change_intro'].'</div>\n    <div style=\" margin-top:10px;\" id=\"div_suggest_change_html\"></div>\n    <div id=\"div_suggest_change_wait\" style=\"margin-top:10; padding:5px; display:none;\" class=\"ui-state-focus ui-corner-all\"></div>\n</div><br />';\n\n// Off line mode\nif (isset($SETTINGS['settings_offline_mode']) && $SETTINGS['settings_offline_mode'] == 1) {\n    echo '\n    <div id=\"dialog_offline_mode\" style=\"display:none;\">\n        <div id=\"div_offline_mode\">\n            <i class=\"fa fa-cog fa-spin fa-2x\"></i>\n        </div>\n    </div>';\n}\n\n// Export items to file\nif (isset($SETTINGS['allow_print']) && $SETTINGS['allow_print'] == 1 && $_SESSION['temporary']['user_can_printout'] === true) {\n    echo '\n    <div id=\"dialog_export_file\" style=\"display:none;\">\n        <div id=\"div_export_file\">\n            <i class=\"fa fa-cog fa-spin fa-2x\"></i>\n        </div>\n    </div>';\n}\n\n// Import items\nif (isset($SETTINGS['allow_import']) && $SETTINGS['allow_import'] == 1 && $session_user_admin !== '1') {\n    echo '\n    <div id=\"dialog_import_file\" style=\"display:none;\">\n        <div id=\"div_import_file\">\n            <i class=\"fa fa-cog fa-spin fa-2x\"></i>\n        </div>\n    </div>';\n}\n\n// USERS passwords upgrade\nif (isset($SETTINGS['enable_pf_feature']) && $SETTINGS['enable_pf_feature'] == 1\n    && $session_user_admin !== '1' && isset($_SESSION['user_upgrade_needed']) && $_SESSION['user_upgrade_needed'] == 1\n) {\n    echo '\n    <div id=\"dialog_upgrade_personal_passwords\" style=\"display:none;\">\n        <div style=\"text-align:center;\">\n            <div>'.$LANG['pf_change_encryption'].'</div>\n            <div id=\"dialog_upgrade_personal_passwords_status\" style=\"margin:15px 0 15px 0; font-weight:bold;\">', isset($_SESSION['user_settings']['session_psk']) ? $LANG['pf_sk_set'] : $LANG['pf_sk_not_set'], '</div>\n        </div>\n    </div>';\n}\n\n// SSH dialogbox\necho '\n<div id=\"dialog_ssh\" style=\"display:none;padding:4px;\">\n    <div id=\"div_ssh\">\n        <i class=\"fa fa-cog fa-spin fa-2x\"></i>&nbsp;<b>'.$LANG['please_wait'].'</b>\n    </div>\n</div>';\n\nrequire_once 'items.load.php';\n", "<?php\n/**\n * @file          roles.load.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\n\nif (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n    die('Hacking attempt...');\n}\n?>\n<script type=\"text/javascript\">\n//<![CDATA[\n$(function() {\n    // manage delete\n    $(\"input[name=right_types_radio]\").click(function(event) {\n        if ($(\"input[name=right_types_radio]:checked\").attr(\"id\").substring(6) == \"write\") {\n            $(\"#div_delete_option\").show();\n        } else {\n            $(\"#div_delete_option\").hide();\n        }\n    });\n\n\n    $(\"#add_new_role\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 400,\n        height: 280,\n        title: \"<?php echo $LANG[\"give_function_title\"]; ?>\",\n        buttons: {\n            \"<?php echo $LANG[\"save_button\"]; ?>\": function() {\n                $(\"#new_role_error\").hide().html(\"\");\n                if ($(\"#new_role_complexity\").val() != \"\") {\n                    $(\"#add_role_loader\").show();\n                    $.post(\n                        \"sources/roles.queries.php\",\n                        {\n                            type    : \"add_new_role\",\n                            name    : $(\"#new_function\").val(),\n                            complexity    : $(\"#new_role_complexity\").val()\n                        },\n                        function(data) {\n                            if (data[0].error == \"no\") {\n                                $(\"#new_function\").val(\"\");\n                                $(\"#add_new_role\").dialog(\"close\");\n                                refresh_roles_matrix(\"reload\");\n                            } else {\n                                $(\"#new_role_error\").show().html(data[0].message);\n                            }\n                            $(\"#add_role_loader\").hide();\n                        },\n                        \"json\"\n                   );\n                } else {\n                    $(\"#new_role_error\").show().html(\"<?php echo addslashes($LANG['error_role_complex_not_set']); ?>\");\n                }\n            },\n            \"<?php echo $LANG[\"cancel_button\"]; ?>\": function() {\n                $(this).dialog(\"close\");\n            }\n        }\n    });\n\n    $(\"#delete_role\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 400,\n        height: 190,\n        title: \"<?php echo $LANG[\"admin_action\"]; ?>\",\n        buttons: {\n            \"<?php echo $LANG[\"ok\"]; ?>\": function() {\n                $(\"#delete_role_loader\").show();\n                $.post(\n                    \"sources/roles.queries.php\",\n                    {\n                        type    : \"delete_role\",\n                        id        : $(\"#delete_role_id\").val()\n                    },\n                    function(data) {\n                        if (data[0].error == \"no\") {\n                            $(\"#delete_role\").dialog(\"close\");\n                            refresh_roles_matrix(\"reload\");\n                        }\n                        $(\"#delete_role_loader\").hide();\n                    },\n                    \"json\"\n               );\n            },\n            \"<?php echo $LANG[\"cancel_button\"]; ?>\": function() {\n                $(this).dialog(\"close\");\n            }\n        }\n    });\n\n    $(\"#edit_role\").dialog({\n        bgiframe: true,\n        modal: true,\n        autoOpen: false,\n        width: 400,\n        height: 300,\n        title: \"<?php echo $LANG[\"admin_action\"]; ?>\",\n        buttons: {\n            \"<?php echo $LANG[\"ok\"]; ?>\": function() {\n                $(\"#edit_role_error\").hide().html(\"\");\n                $(\"#edit_role_loader\").show();\n                $.post(\n                    \"sources/roles.queries.php\",\n                    {\n                        type    : \"edit_role\",\n                        id      : $(\"#edit_role_id\").val(),\n                        start    : $('#role_start').val(),\n                        title      : $(\"#edit_role_title\").val(),\n                        complexity    : $(\"#edit_role_complexity\").val()\n                    },\n                    function(data) {\n                        if (data[0].error == \"yes\") {\n                            $(\"#edit_role_error\").show().html(data[0].message);\n                        } else {\n                            $(\"#edit_role_title\").val(\"\");\n                            $(\"#edit_role\").dialog(\"close\");\n                            $(\"#div_loading\").show();\n                            refresh_roles_matrix(\"reload\");\n                        }\n                        $(\"#edit_role_loader\").hide();\n                    },\n                    \"json\"\n               );\n            },\n            \"<?php echo $LANG[\"cancel_button\"]; ?>\": function() {\n                $(\"#edit_role_error\").html(\"\").hide();\n                $(this).dialog(\"close\");\n            }\n        }\n    });\n\n    $(\"#type_of_rights\").dialog({\n        bgiframe: false,\n        modal: false,\n        autoOpen: false,\n        width: 300,\n        height: 270,\n        title: \"<?php echo $LANG[\"change_right_access\"]; ?>\",\n        buttons: {\n            \"<?php echo $LANG[\"save_button\"]; ?>\": function() {\n                $(\"#edit_role_error\").hide().html(\"\");\n                $(\"#role_rights_loader\").show();\n\n                // get write option\n                var accessoption = \"\";\n                if ($(\"input[name=right_types_radio]:checked\").attr(\"id\").substring(6) == \"write\") {\n                    if ($(\"#right_nodelete\").prop(\"checked\") === true && $(\"#right_noedit\").prop(\"checked\") === true) {\n                        accessoption = \"nodelete_noedit\";\n                    } else if ($(\"#right_nodelete\").prop(\"checked\") === true) {\n                        accessoption = \"nodelete\";\n                    } else if ($(\"#right_noedit\").prop(\"checked\") === true) {\n                        accessoption = \"noedit\";\n                    }\n                }\n\n                // is several folders selected?\n                var multiselection = '',\n                    tmp;\n                $(\".multi_folders:checkbox:checked\").each(function(){\n                    tmp = $(this).attr('id').substring(9).split('_');\n                    multiselection += tmp[0] + \"-\" + tmp[1] + \",\";   //folder_id-role_id\n                });\n                multiselection += $(\"#change_folder\").val() + \"-\" + $('#change_role').val();\n\n                $.post(\n                    \"sources/roles.queries.php\",\n                    {\n                        type    : \"change_role_via_tm\",\n                        access  : $(\"input[name=right_types_radio]:checked\").attr(\"id\").substring(6),\n                        accessoption : accessoption,\n                        //folder  : $(\"#change_folder\").val(),\n                        //role    : $('#change_role').val(),\n                        line    : $(\"#change_line\").val(),\n                        multiselection: multiselection\n                    },\n                    function(data) {\n                        $(\"#div_loading\").show();\n                        refresh_roles_matrix(\"reload\");\n                        $(\"#type_of_rights\").dialog(\"close\");\n                        $(\"#role_rights_loader\").hide();\n                    },\n                    \"json\"\n               );\n            },\n            \"<?php echo $LANG[\"close\"]; ?>\": function() {\n                $(this).dialog(\"close\");\n            }\n        },\n        open: function() {\n            $(\"#accordion\").accordion({ autoHeight: false, navigation: true, collapsible: true, active: false });\n        }\n    });\n\n    refresh_roles_matrix();\n});\n\n//###########\n//## FUNCTION : Change the actual right of the role other the select folder\n//###########\nfunction tm_change_role(role,folder,cell_id,allowed)\n{\n    $(\"#div_loading\").show();\n    $.post(\n        \"sources/roles.queries.php\",\n        {\n            type    : \"change_role_via_tm\",\n            role    : role,\n            folder    : folder,\n            cell_id    : cell_id,\n            allowed    : allowed\n        },\n        function(data) {\n            refresh_roles_matrix(\"reload\");\n            $(\"#div_loading\").hide();\n        }\n   );\n}\n\nfunction delete_this_role(id,name)\n{\n    $(\"#delete_role_id\").val(id);\n    $(\"#delete_role_show\").html(name);\n    $(\"#delete_role\").dialog(\"open\");\n}\n\nfunction edit_this_role(id,name,complexity)\n{\n    $(\"#edit_role_id\").val(id);\n    $(\"#edit_role_show\").html(name);\n    $(\"#edit_role_title\").val(name);\n    $(\"#edit_role_complexity\").val(complexity);\n    $(\"#edit_role\").dialog(\"open\");\n}\n\nfunction allow_pw_change_for_role(id, value)\n{\n    $(\"#div_loading\").show();\n    //Send query\n    $.post(\n        \"sources/roles.queries.php\",\n        {\n            type    : \"allow_pw_change_for_role\",\n            id      : id,\n            value      : value\n        },\n        function(data) {\n            if (value == 0)\n                $(\"#img_apcfr_\"+id).attr(\"class\",\"fa mi-red fa-2x fa-magic tip\");\n            else\n                $(\"#img_apcfr_\"+id).attr(\"class\",\"fa mi-green fa-2x fa-magic tip\");\n            $(\"#div_loading\").hide();\n            refresh_roles_matrix(\"reload\");\n        }\n   );\n}\n\n/**\n *\n * @access public\n * @return void\n **/\nfunction refresh_roles_matrix(order)\n{\n    $(\"#div_loading\").show();\n\n    //clean up\n    $(\".roles_next, .roles_previous\").hide();\n\n    //manage start query\n    if (order == \"next\") {\n        var start = $('#next_role').val();\n    } else if (order == \"previous\") {\n        var start = $('#previous_role').val();\n    } else if (order == \"reload\") {\n        var start = $('#role_start').val();\n    } else {\n        var start = 0;\n    }\n    $('#role_start').val(start);\n\n    //send query\n    $.post(\n        \"sources/roles.queries.php\",\n        {\n            type    : \"refresh_roles_matrix\",\n            start   : start,\n            filter  : $(\"#filter_roles\").val()\n        },\n        function(data) {\n            //decrypt data\n            data = $.parseJSON(data);\n            $(\"#matrice_droits\").html(\"\");\n            if (data.new_table !== \"\") {\n                $(\"#matrice_droits\").html(data.new_table);\n                if (data.next < data.all && data.next >= 9) {\n                    $(\".roles_next\").show();\n                }\n                if (data.next >= 9 && data.previous >= 0) {\n                    $(\".roles_previous\").show();\n                }\n                //manage next & previous arrows\n                $('#next_role').val(data.next);\n                $('#previous_role').val(data.previous);\n\n                $(\"#filter_roles\").val(\"\");\n            } else {\n                $(\"#matrice_droits\").html(data.error);\n            }\n\n            // Prepare autocomplete for filterbox\n            //Prepare autocomplete for filter\n            $(\"#filter_roles\")\n                .autocomplete({\n                    source: data.list_of_roles,\n                    focus: function() {\n                        // prevent value inserted on focus\n                        return false;\n                    }\n                }\n            );\n\n            $(\"#div_loading\").hide();\n        }\n   );\n}\n\nfunction openRightsDialog(role, folder, line, right)\n{\n    if (right == \"W\") {\n        $(\"#right_write\").prop(\"checked\", true);\n        $(\"#right_nodelete, #right_noedit\").prop(\"checked\", false);\n        $(\"#div_delete_option\").show();\n    } else if (right == \"ND\") {\n        $(\"#right_write\").prop(\"checked\", true);\n        $(\"#right_nodelete\").prop(\"checked\", true);\n        $(\"#right_noedit\").prop(\"checked\", false);\n        $(\"#div_delete_option\").show();\n    } else if (right == \"NE\") {\n        $(\"#right_write\").prop(\"checked\", true);\n        $(\"#right_nodelete\").prop(\"checked\", false);\n        $(\"#right_noedit\").prop(\"checked\", true);\n        $(\"#div_delete_option\").show();\n    } else if (right == \"NDNE\") {\n        $(\"#right_write\").prop(\"checked\", true);\n        $(\"#right_noedit, #right_nodelete\").prop(\"checked\", true);\n        $(\"#div_delete_option\").show();\n    } else if (right == \"R\") {\n        $(\"#right_read\").prop(\"checked\", true);\n        $(\"#div_delete_option\").hide();\n    } else {\n        $(\"#right_noaccess\").prop(\"checked\", true);\n        $(\"#div_delete_option\").hide();\n    }\n    $(\"#change_role\").val(role);\n    $(\"#change_folder\").val(folder);\n    $(\"#change_line\").val(line);\n    $(\"#type_of_rights\").dialog(\"open\");\n}\n//]]>\n</script>\n", "<?php\n/**\n * @file          roles.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\n\nif (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 ||\n    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) ||\n    !isset($_SESSION['key']) || empty($_SESSION['key'])\n) {\n    die('Hacking attempt...');\n}\n\n// Load config\nif (file_exists('../includes/config/tp.config.php')) {\n    require_once '../includes/config/tp.config.php';\n} elseif (file_exists('./includes/config/tp.config.php')) {\n    require_once './includes/config/tp.config.php';\n} else {\n    throw new Exception(\"Error file '/includes/config/tp.config.php' not exists\", 1);\n}\n\n/* do checks */\nrequire_once $SETTINGS['cpassman_dir'].'/sources/checks.php';\nif (!checkUser($_SESSION['user_id'], $_SESSION['key'], curPage())) {\n    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n    include $SETTINGS['cpassman_dir'].'/error.php';\n    exit();\n}\n\nrequire_once $SETTINGS['cpassman_dir'].'/sources/main.functions.php';\n\n//Get full list of groups\n$arr_groups = array();\n$rows = DB::query(\"SELECT id,title FROM \".prefix_table(\"nested_tree\"));\nforeach ($rows as $reccord) {\n    $arr_groups[$reccord['id']] = $reccord['title'];\n}\n\n//display\necho '\n<div class=\"title ui-widget-content ui-corner-all\">\n    '.$LANG['admin_functions'].'&nbsp;&nbsp;\n    <button title=\"'.htmlentities(strip_tags($LANG['add_role_tip']), ENT_QUOTES).'\" onclick=\"OpenDialog(\\'add_new_role\\')\" class=\"button\" style=\"font-size:16px;\">\n        <span class=\"fa fa-plus\"></span>\n    </button>\n    &nbsp;\n    <span class=\"normal\"><input id=\"filter_roles\" class=\"ui-widget ui-corner-all\" type=\"text\" value=\"\" placeholder=\"No filter\" /></span>\n    <button title=\"'.htmlentities(strip_tags($LANG['refresh_matrix']), ENT_QUOTES).'\" onclick=\"refresh_roles_matrix()\" class=\"button\" style=\"font-size:16px;\">\n        <span class=\"fa fa-refresh\"></span>\n    </button>\n    &nbsp;\n    <button onclick=\"refresh_roles_matrix(\\'previous\\')\" class=\"button roles_previous\" style=\"font-size:16px;\">\n        <span class=\"fa fa-arrow-left\"></span>\n    </button>\n    <button onclick=\"refresh_roles_matrix(\\'next\\')\" class=\"button roles_next\" style=\"font-size:16px;\">\n        <span class=\"fa fa-arrow-right\"></span>\n    </button>\n</div>\n<div style=\"line-height:20px;\" align=\"center\">\n    <div id=\"matrice_droits\"></div>\n    <div style=\"\">\n        <button onclick=\"refresh_roles_matrix(\\'previous\\')\" class=\"button roles_previous\" style=\"font-size:16px;\">\n            <span class=\"fa fa-arrow-left\"></span>\n        </button>\n        <button onclick=\"refresh_roles_matrix(\\'next\\')\" class=\"button roles_next\" style=\"font-size:16px;\">\n            <span class=\"fa fa-arrow-right\"></span>\n        </button>\n    </div>\n</div>\n<input type=\"hidden\" id=\"selected_function\" />\n<input type=\"hidden\" id=\"next_role\" value=\"0\" />\n<input type=\"hidden\" id=\"previous_role\" value=\"0\" />\n<input type=\"hidden\" id=\"role_start\" value=\"0\" />\n<input type=\"hidden\" id=\"change_role\" value=\"0\" />\n<input type=\"hidden\" id=\"change_folder\" value=\"0\" />\n<input type=\"hidden\" id=\"change_line\" value=\"0\" />';\n\n// DIV FOR ADDING A ROLE\necho '\n<div id=\"add_new_role\" style=\"\">\n    <div style=\"text-align:center;padding:2px;display:none;\" class=\"ui-state-error ui-corner-all\" id=\"new_role_error\"></div>\n    <p>\n    <label for=\"new_function\" class=\"form_label_100\">'.$LANG['name'].'</label><input type=\"text\" id=\"new_function\" size=\"40\" />\n    </p>\n    <p>\n    <label for=\"new_role_complexity\" class=\"form_label\">'.$LANG['complex_asked'].' :</label>\n    <select id=\"new_role_complexity\" class=\"input_text text ui-widget-content ui-corner-all\">\n        <option value=\"\">---</option>';\nforeach ($SETTINGS_EXT['pwComplexity'] as $complex) {\n    echo '<option value=\"'.$complex[0].'\">'.$complex[1].'</option>';\n}\necho '\n    </select>\n    </p>\n    <div id=\"add_role_loader\" style=\"display:none;text-align:center;margin-top:20px;\">\n        <i class=\"fa fa-cog fa-spin\"></i>&nbsp;'.$LANG['please_wait'].'...\n    </div>\n</div>';\n\n// DIV FOR DELETING A ROLE\necho '\n<div id=\"delete_role\" style=\"display:none;\">\n    <div>'.$LANG['confirm_del_role'].'</div>\n    <div style=\"font-weight:bold;text-align:center;color:#FF8000;text-align:center;font-size:13pt;\" id=\"delete_role_show\"></div>\n    <input type=\"hidden\" id=\"delete_role_id\" />\n    <div id=\"delete_role_loader\" style=\"display:none;text-align:center;margin-top:20px;\">\n        <i class=\"fa fa-cog fa-spin\"></i>&nbsp;'.$LANG['please_wait'].'...\n    </div>\n</div>';\n\n// DIV FOR EDITING A ROLE\necho '\n<div id=\"edit_role\" style=\"display:none;\">\n    <div style=\"text-align:center;padding:2px;display:none;\" class=\"ui-state-error ui-corner-all\" id=\"edit_role_error\"></div>\n    <div>'.$LANG['confirm_edit_role'].'</div>\n    <div style=\"font-weight:bold;text-align:center;color:#FF8000;text-align:center;font-size:13pt;\" id=\"edit_role_show\"></div>\n    <input type=\"hidden\" id=\"edit_role_id\" />\n    <label for=\"edit_role_title\" class=\"form_label\">'.$LANG['new_role_title'].'</label><input type=\"text\" id=\"edit_role_title\" size=\"40\" />\n    <p>\n    <label for=\"edit_role_complexity\" class=\"form_label\">'.$LANG['complex_asked'].' :</label>\n    <select id=\"edit_role_complexity\" class=\"input_text text ui-widget-content ui-corner-all\">\n        <option value=\"\">---</option>';\nforeach ($SETTINGS_EXT['pwComplexity'] as $complex) {\n    echo '<option value=\"'.$complex[0].'\">'.$complex[1].'</option>';\n}\necho '\n    </select>\n    </p>\n    <div id=\"edit_role_loader\" style=\"display:none;text-align:center;margin-top:20px;\">\n        <i class=\"fa fa-cog fa-spin\"></i>&nbsp;'.$LANG['please_wait'].'...\n    </div>\n</div>';\n\n// DIV FOR TYPE OF RIGHTS\necho '\n<div id=\"type_of_rights\">\n    <div>'.$LANG['right_types_label'].'</div>\n    <div style=\"margin-top:10px; text-align:center;\">\n        <input type=\"radio\" name=\"right_types_radio\" id=\"right_write\" /><label for=\"right_write\">'.$LANG['write'].'</label>&nbsp;\n        <input type=\"radio\" name=\"right_types_radio\" id=\"right_read\" /><label for=\"right_read\">'.$LANG['read'].'</label>&nbsp;\n        <input type=\"radio\" name=\"right_types_radio\" id=\"right_noaccess\" /><label for=\"right_noaccess\">'.$LANG['no_access'].'</label>\n    </div>\n    <div style=\"margin:10px 0 0 30px; display:none;\" id=\"div_delete_option\">\n        <input type=\"checkbox\" id=\"right_nodelete\" />&nbsp;'.$LANG['role_cannot_delete_item'].'<br />\n        <input type=\"checkbox\" id=\"right_noedit\" />&nbsp;'.$LANG['role_cannot_edit_item'].'\n    </div>\n    <div id=\"role_rights_loader\" style=\"display:none;text-align:center;margin-top:20px;\">\n        <i class=\"fa fa-cog fa-spin\"></i>&nbsp;'.$LANG['please_wait'].'...\n    </div>\n</div>';\n\n//call to roles.load.php\nrequire_once 'roles.load.php';\n", "<?php\n/**\n * @file          import.queries.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\nuse Goodby\\CSV\\Import\\Standard\\Lexer;\nuse Goodby\\CSV\\Import\\Standard\\Interpreter;\nuse Goodby\\CSV\\Import\\Standard\\LexerConfig;\n\nrequire_once 'SecureHandler.php';\nsession_start();\nif (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || !isset($_SESSION['key']) || empty($_SESSION['key'])) {\n    die('Hacking attempt...');\n}\n\n// Load config\nif (file_exists('../includes/config/tp.config.php')) {\n    require_once '../includes/config/tp.config.php';\n} elseif (file_exists('./includes/config/tp.config.php')) {\n    require_once './includes/config/tp.config.php';\n} else {\n    throw new Exception(\"Error file '/includes/config/tp.config.php' not exists\", 1);\n}\n\n// No time limit\nset_time_limit(0);\n\n// Set some constants for program readability\ndefine('KP_PATH', 0);\ndefine('KP_GROUP', 1);\ndefine('KP_TITLE', 2);\ndefine('KP_PASSWORD', 3);\ndefine('KP_USERNAME', 4);\ndefine('KP_URL', 5);\ndefine('KP_UUID', 6);\ndefine('KP_NOTES', 7);\n\n/*\n * sanitiseString\n *\n * Used to format the string ready for insertion in to the database\n */\n/**\n * @param string $crLFReplacement\n */\nfunction sanitiseString($str, $crLFReplacement)\n{\n    $str = preg_replace('#[\\r\\n]#', $crLFReplacement, $str);\n    $str = str_replace('\\\\', '&#92;', $str);\n    $str = str_replace('\"', \"&quot;\", $str);\n    if (!empty($str)) {\n        addslashes($str);\n    }\n    return $str;\n}\n\nglobal $k, $settings;\nheader(\"Content-type: text/html; charset=utf-8\");\nerror_reporting(E_ERROR);\ninclude $SETTINGS['cpassman_dir'].'/includes/config/settings.php';\n\n//Class loader\nrequire_once $SETTINGS['cpassman_dir'].'/sources/SplClassLoader.php';\n\n// call needed functions\nrequire_once $SETTINGS['cpassman_dir'].'/sources/main.functions.php';\n\n// connect to the server\nrequire_once $SETTINGS['cpassman_dir'].'/includes/libraries/Database/Meekrodb/db.class.php';\n$pass = defuse_return_decrypted($pass);\nDB::$host = $server;\nDB::$user = $user;\nDB::$password = $pass;\nDB::$dbName = $database;\nDB::$port = $port;\nDB::$encoding = $encoding;\nDB::$error_handler = true;\n$link = mysqli_connect($server, $user, $pass, $database, $port);\n$link->set_charset($encoding);\n\n//Load Tree\n$tree = new SplClassLoader('Tree\\NestedTree', '../includes/libraries');\n$tree->register();\n$tree = new Tree\\NestedTree\\NestedTree($pre.'nested_tree', 'id', 'parent_id', 'title');\n\n//Load AES\n$aes = new SplClassLoader('Encryption\\Crypt', '../includes/libraries');\n$aes->register();\n\n//User's language loading\nrequire_once $SETTINGS['cpassman_dir'].'/includes/language/'.$_SESSION['user_language'].'.php';\n\n// Build query\nswitch (filter_input(INPUT_POST, 'type', FILTER_SANITIZE_STRING)) {\n    //Check if import CSV file format is what expected\n    case \"import_file_format_csv\":\n        //load full tree\n        $tree->rebuild();\n        $tree = $tree->getDescendants();\n       // Init post variable\n        $post_operation_id = filter_input(INPUT_POST, 'file', FILTER_SANITIZE_NUMBER_INT);\n\n        // Get filename from database\n        $data = DB::queryFirstRow(\n            \"SELECT valeur\n            FROM \".$pre.\"misc\n            WHERE increment_id = %i\",\n            $post_operation_id\n        );\n\n        // Delete operation id\n        DB::delete(\n            prefix_table('misc'),\n            \"increment_id = %i\",\n            $post_operation_id\n        );\n\n        // do some initializations\n        $file = $SETTINGS['path_to_files_folder'].\"/\".$data['valeur'];\n        $size = 4096;\n        $separator = \",\";\n        $enclosure = '\"';\n        $fields_expected = array(\"Label\", \"Login\", \"Password\", \"URL\", \"Comments\"); //requiered fields from CSV\n        $importation_possible = true;\n        $display = \"<table>\";\n        $line_number = $prev_level = 0;\n        $account = $text = \"\";\n        $continue_on_next_line = false;\n\n        // Open file\n        if ($fp = fopen($file, \"r\")) {\n            // data from CSV\n            $valuesToImport = array();\n            // load libraries\n            require_once $SETTINGS['cpassman_dir'].'/includes/libraries/Goodby/CSV/Import/Standard/Lexer.php';\n            require_once $SETTINGS['cpassman_dir'].'/includes/libraries/Goodby/CSV/Import/Standard/Interpreter.php';\n            require_once $SETTINGS['cpassman_dir'].'/includes/libraries/Goodby/CSV/Import/Standard/LexerConfig.php';\n\n            // Lexer configuration\n            $config = new LexerConfig();\n            $lexer = new Lexer($config);\n            $config->setIgnoreHeaderLine(\"true\");\n            // extract data from CSV file\n            $interpreter = new Interpreter();\n            $interpreter->addObserver(function (array $row) use (&$valuesToImport) {\n                $valuesToImport[] = array(\n                    'Label'     => $row[0],\n                    'Login'     => $row[1],\n                    'Password'  => $row[2],\n                    'url'       => $row[3],\n                    'Comments'  => $row[4],\n                );\n            });\n            $lexer->parse($file, $interpreter);\n\n            // extract one line\n            foreach ($valuesToImport as $key => $row) {\n                //Check number of fields. MUST be 5. if not stop importation\n                if (count($row) != 5) {\n                    $importation_possible = false;\n                    //Stop if file has not expected structure\n                    if ($importation_possible === false) {\n                        echo '[{\"error\":\"bad_structure\"}]';\n                        break;\n                    }\n                }\n\n                //If any comment is on several lines, then replace 'lf' character\n                $row['Comments'] = str_replace(array(\"\\r\\n\", \"\\n\", \"\\r\"), \"<br />\", $row['Comments']);\n\n                // Check if current line contains a \"<br />\" character in order to identify an ITEM on several CSV lines\n                if (substr_count('<br />', $row['Comments']) > 0 || substr_count('<br />', $row['Label']) > 0) {\n                    $continue_on_next_line = true;\n                    $comment .= addslashes($row['Label']);\n                } else {\n                    // Store in variable values from previous line\n                    if (!empty($account)) {\n                        if ($continue_on_next_line === false) {\n                            // Prepare listing that will be shown to user\n                            $display .= '<tr><td><input type=\\\"checkbox\\\" class=\\\"item_checkbox\\\" id=\\\"item_to_import-'.$line_number.'\\\" /></td><td><span id=\\\"item_text-'.$line_number.'\\\">'.$account.'</span><input type=\\\"hidden\\\" value=\\\"'.$account.'@|@'.$login.'@|@'.$pwd.'@|@'.$url.'@|@'.$comment.'@|@'.$line_number.'\\\" id=\\\"item_to_import_values-'.$line_number.'\\\" /></td></tr>';\n\n                            // Initialize this variable in order to restart from scratch\n                            $account = \"\";\n                        }\n                    }\n                }\n\n                // Get values of current line\n                if ($account == \"\" && $continue_on_next_line === false) {\n                    $account = htmlspecialchars($row['Label'], ENT_QUOTES, 'UTF-8');\n                    $login = htmlspecialchars($row['Login'], ENT_QUOTES, 'UTF-8');\n                    $pwd = str_replace('\"', \"&quot;\", $row['Password']);\n                    $url = addslashes($row['url']);\n                    $to_find = array(\"\\\"\", \"'\");\n                    $to_ins = array(\"&quot\", \"&#39;\");\n                    $comment = htmlentities(addslashes(str_replace($to_find, $to_ins, $row['Comments'])), ENT_QUOTES, 'UTF-8');\n\n                    $continue_on_next_line = false;\n                }\n\n                //increment number of lines found\n                $line_number++;\n            }\n            // close file\n            fclose($fp);\n        } else {\n            echo '[{\"error\":\"cannot_open\"}]';\n            break;\n        }\n\n        if ($line_number > 0) {\n            //add last line\n            $display .= '<tr><td><input type=\\\"checkbox\\\" class=\\\"item_checkbox\\\" id=\\\"item_to_import-'.$line_number.'\\\" /></td><td><span id=\\\"item_text-'.$line_number.'\\\">'.$account.'</span><input type=\\\"hidden\\\" value=\\\"'.$account.'@|@'.$login.'@|@'.str_replace('\"', \"&quote;\", $pwd).'@|@'.$url.'@|@'.$comment.'@|@'.$line_number.'\\\" id=\\\"item_to_import_values-'.$line_number.'\\\" /></td></tr>';\n\n            // Add a checkbox for select/unselect all others\n            $display .= '<tr><td colspan=\\\"2\\\"><br><input type=\\\"checkbox\\\" id=\\\"item_all_selection\\\" />&nbsp;'.$LANG['all'].'</td></tr>';\n\n            // Prepare a list of all folders that the user can choose\n            $display .= '</table><div style=\\\"margin:10px 0 10px 0;\\\"><label><b>'.$LANG['import_to_folder'].'</b></label>&nbsp;<select id=\\\"import_items_to\\\" style=\\\"width:87%;\\\">';\n            foreach ($tree as $t) {\n                if (in_array($t->id, $_SESSION['groupes_visibles'])) {\n                    $ident = \"\";\n                    for ($x = 1; $x < $t->nlevel; $x++) {\n                        $ident .= \"&nbsp;&nbsp;\";\n                    }\n                    if (null !== filter_input(INPUT_POST, 'folder_id', FILTER_SANITIZE_NUMBER_INT) && filter_input(INPUT_POST, 'folder_id', FILTER_SANITIZE_NUMBER_INT) === $t->id) {\n                        $selected = \" selected\";\n                    } else {\n                        $selected = \"\";\n                    }\n                    if ($prev_level != null && $prev_level < $t->nlevel) {\n                        $display .= '<option value=\\\"'.$t->id.'\\\"'.$selected.'>'.$ident.str_replace(array(\"&\", '\"'), array(\"&amp;\", \"&quot;\"), $t->title).'</option>';\n                    } elseif ($prev_level != null && $prev_level == $t->nlevel) {\n                        $display .= '<option value=\\\"'.$t->id.'\\\"'.$selected.'>'.$ident.str_replace(array(\"&\", '\"'), array(\"&amp;\", \"&quot;\"), $t->title).'</option>';\n                    } else {\n                        $display .= '<option value=\\\"'.$t->id.'\\\"'.$selected.'>'.$ident.str_replace(array(\"&\", '\"'), array(\"&amp;\", \"&quot;\"), $t->title).'</option>';\n                    }\n                    $prev_level = $t->nlevel;\n                }\n            }\n            $display .= '</select></div>';\n\n            // Show results to user.\n            echo '[{\"error\":\"no\" , \"output\" : \"'.$display.'\"}]';\n        }\n\n        //delete file\n        unlink($file);\n\n        break;\n\n    //Insert into DB the items the user has selected\n    case \"import_items\":\n        //decrypt and retreive data in JSON format\n        $dataReceived = (Encryption\\Crypt\\aesctr::decrypt(\n            filter_input(INPUT_POST, 'data', FILTER_SANITIZE_STRING),\n            $_SESSION['key'],\n            256\n        ));\n\n        //Get some info about personal folder\n        if (filter_input(INPUT_POST, 'folder', FILTER_SANITIZE_NUMBER_INT) === $_SESSION['user_id']) {\n            $personalFolder = 1;\n        } else {\n            $personalFolder = 0;\n        }\n        $data_fld = DB::queryFirstRow(\n            \"SELECT title\n            FROM \".prefix_table(\"nested_tree\").\"\n            WHERE id = %i\",\n            filter_input(INPUT_POST, 'folder', FILTER_SANITIZE_NUMBER_INT)\n        );\n\n        //Prepare variables\n        $listItems = htmlspecialchars_decode($dataReceived);\n        $list = \"\";\n\n        foreach (explode('@_#sep#_@', stripslashes($listItems)) as $item) {\n            //For each item, insert into DB\n            $item = explode('@|@', $item); //explode item to get all fields\n\n            //Encryption key\n            if ($personalFolder == 1) {\n                $encrypt = cryption(\n                    $item[2],\n                    $_SESSION['user_settings']['session_psk'],\n                    \"encrypt\"\n                );\n            } else {\n                $encrypt = cryption(\n                    $item[2],\n                    \"\",\n                    \"encrypt\"\n                );\n            }\n\n            // Insert new item in table ITEMS\n            DB::insert(\n                prefix_table(\"items\"),\n                array(\n                    'label' => substr($item[0], 0, 500),\n                    'description' => empty($item[4]) ? '' : $item[4],\n                    'pw' => $encrypt['string'],\n                    'pw_iv' => $encrypt['iv'],\n                    'url' => empty($item[3]) ? '' : substr($item[3], 0, 500),\n                    'id_tree' => filter_input(INPUT_POST, 'folder', FILTER_SANITIZE_NUMBER_INT),\n                    'login' => empty($item[1]) ? '' : substr($item[1], 0, 200),\n                    'anyone_can_modify' => filter_input(INPUT_POST, 'import_csv_anyone_can_modify', FILTER_SANITIZE_STRING) === \"true\" ? 1 : 0\n                )\n            );\n            $newId = DB::insertId();\n\n            //if asked, anyone in role can modify\n            if (null !== filter_input(INPUT_POST, 'import_csv_anyone_can_modify_in_role', FILTER_SANITIZE_STRING)\n                && filter_input(INPUT_POST, 'import_csv_anyone_can_modify_in_role', FILTER_SANITIZE_STRING) === \"true\"\n            ) {\n                foreach ($_SESSION['arr_roles'] as $role) {\n                    DB::insert(\n                        prefix_table(\"restriction_to_roles\"),\n                        array(\n                            'role_id' => $role['id'],\n                            'item_id' => $newId\n                        )\n                    );\n                }\n            }\n\n            // Insert new item in table LOGS_ITEMS\n            DB::insert(\n                prefix_table(\"log_items\"),\n                array(\n                    'id_item' => $newId,\n                    'date' => time(),\n                    'id_user' => $_SESSION['user_id'],\n                    'action' => 'at_creation'\n                )\n            );\n\n            if (empty($list)) {\n                $list = $item[5];\n            } else {\n                $list .= \";\".$item[5];\n            }\n\n            //Add entry to cache table\n            DB::insert(\n                prefix_table(\"cache\"),\n                array(\n                    'id' => $newId,\n                    'label' => substr($item[0], 0, 500),\n                    'description' => empty($item[4]) ? '' : $item[4],\n                    'id_tree' => filter_input(INPUT_POST, 'folder', FILTER_SANITIZE_NUMBER_INT),\n                    'url' => \"0\",\n                    'perso' => $personalFolder == 0 ? 0 : 1,\n                    'login' => empty($item[1]) ? '' : substr($item[1], 0, 500),\n                    'folder' => $data_fld['title'],\n                    'author' => $_SESSION['user_id'],\n                    'timestamp' => time(),\n                    'tags' => '',\n                    'restricted_to' => '0',\n                    'renewal_period' => \"0\",\n                    'timestamp' => time()\n                )\n            );\n        }\n        echo '[{\"items\":\"'.$list.'\"}]';\n        break;\n\n    //Check if import KEEPASS file format is what expected\n    case \"import_file_format_keepass\":\n        //Initialization\n        $root = $meta = $group = $entry = $key = $title = $notes = $pwd = $username = $url = $notKeepassFile = $newItem = $history = $generatorFound = false;\n        $name = $levelInProgress = $previousLevel = $fullPath = $historyLevel = $path = $display = $keepassVersion = \"\";\n        $numGroups = $numItems = 0;\n        $temparray = $arrFolders = array();\n        $levelMin = 2;\n        $foldersSeparator = '@&##&@';\n        $itemsSeparator = '<=|#|=>';\n        $lineEndSeparator = '@*1|#9*|@';\n\n        //prepare CACHE files\n        $cacheFileName = $SETTINGS['path_to_files_folder'].\"/cpassman_cache_\".md5(time().mt_rand());\n        $cacheFileNameFolder = $cacheFileName.\"_folders\";\n        $cacheFile = fopen($cacheFileName, \"w\");\n        $cacheFileF = fopen($cacheFileNameFolder, \"w\");\n        $logFileName = \"/keepassImport_\".date('YmdHis').\".log\";\n        $cacheLogFile = fopen($SETTINGS['path_to_files_folder'].$logFileName, 'w');\n\n        // Init post variable\n        $post_operation_id = filter_input(INPUT_POST, 'file', FILTER_SANITIZE_STRING);\n\n        // Get filename from database\n        $data = DB::queryFirstRow(\n            \"SELECT valeur\n            FROM \".$pre.\"misc\n            WHERE increment_id = %i\",\n            $post_operation_id\n        );\n\n        // Delete operation id\n        DB::delete(\n            prefix_table('misc'),\n            \"increment_id = %i\",\n            $post_operation_id\n        );\n\n        // do some initializations\n        $file = $data['valeur'];\n\n        //read xml file\n        if (file_exists($SETTINGS['path_to_files_folder'].\"/\".$file)) {\n            $xml = simplexml_load_file(\n                $SETTINGS['path_to_files_folder'].\"/\".$file\n            );\n        }\n\n        /**\n        Recursive function that will permit to read each level of XML nodes\n         */\n        function recursiveKeepassXML($xmlRoot, $xmlLevel = 0)\n        {\n            global $meta, $root, $group, $name, $entry, $levelMin, $title, $notes, $pwd, $username, $url,\n                $newItem, $temparray, $history, $levelInProgress, $historyLevel,\n                $path, $previousLevel, $generatorFound, $cacheFile, $cacheFileF, $numGroups,\n                $numItems, $foldersSeparator, $itemsSeparator, $keepassVersion, $arrFolders;\n\n            $groupsArray = array();\n\n            // For each node, get the name and SimpleXML balise\n            foreach ($xmlRoot as $nom => $elem) {\n                /*\n                * check if file is generated by keepass 1\n                * key \"pwentry\" is only used in KP1.xx XML files\n                */\n                if ($nom == \"pwentry\") {\n                    if (empty($keepassVersion)) {\n                        $keepassVersion = 1;\n                        $generatorFound = true;\n                        $entry = true;\n                    } else {\n                        $entry = true;\n                    }\n\n                    //get children\n                    $xmlChildren = $elem->children();\n\n                    //recursive call\n                    recursiveKeepassXML($xmlChildren, $xmlLevel + 1);\n                }\n                //IMPORTING KEEPASS 1 XML FILE\n                if ($keepassVersion == 1) {\n                    if ($entry === true && $nom == \"expiretime\") {\n                        //save previous keepass entry\n                        $tree = preg_replace('/\\\\\\\\/', $foldersSeparator, $temparray['tree']);\n                        fputs(\n                            $cacheFile,\n                            $tree.$itemsSeparator.$temparray[KP_GROUP].$itemsSeparator.$temparray[KP_TITLE].\n                            $itemsSeparator.$temparray[KP_PW].$itemsSeparator.$temparray[KP_USERNAME].\n                            $itemsSeparator.$temparray[KP_URL].$itemsSeparator.$temparray[KP_UUID].$itemsSeparator.$temparray[KP_NOTES].\"\\n\"\n                        );\n\n                        if (!in_array($temparray['tree'], $arrFolders)) {\n                            fwrite($cacheFileF, $tree.\"\\n\");\n                            array_push($arrFolders, $temparray['tree']);\n                        }\n\n                        $temparray = array();\n                        $newItem++;\n                    }\n\n                    if ($entry === true && $nom == \"group\") {\n                        $temparray[KP_GROUP] = addslashes(preg_replace('#[\\r\\n]#', '', $elem));\n                        foreach ($elem->attributes() as $attributeskey0 => $attributesvalue1) {\n                            if ($attributeskey0 == \"tree\") {\n                                $path = explode('\\\\', $attributesvalue1);\n                                if (count($path) > 1) {\n                                    unset($path[0]);\n                                    $temparray['tree'] = implode('\\\\', $path).'\\\\'.$temparray[KP_GROUP];\n                                } else {\n                                    $temparray['tree'] = $temparray[KP_GROUP];\n                                }\n                            }\n                        }\n                        $numGroups++;\n                    } elseif ($entry === true && $nom == \"title\") {\n                        $temparray[KP_TITLE] = sanitiseString($elem, '');\n                    } elseif ($entry === true && $nom == \"username\") {\n                        $temparray[KP_USERNAME] = sanitiseString($elem, '');\n                    } elseif ($entry === true && $nom == \"url\") {\n                        $temparray[KP_URL] = sanitiseString($elem, '');\n                    } elseif ($entry === true && $nom == \"uuid\") {\n                        $temparray[KP_UUID] = addslashes(preg_replace('#[\\r\\n]#', '', $elem));\n                    } elseif ($entry === true && $nom == \"password\") {\n                        $temparray[KP_PW] = sanitiseString($elem, '');\n                    } elseif ($entry === true && $nom == \"notes\") {\n                        $temparray[KP_NOTES] = sanitiseString($elem, '');\n                    }\n                }\n\n                /*\n                   * check if file is generated by keepass 2\n                */\n                if (trim($elem) == \"\" && $keepassVersion != 1) {\n                    //check if file is generated by keepass 2\n                    if ($nom == \"Meta\") {\n                        $meta = true;\n                    }\n                    if ($nom == \"Root\") {\n                        $root = true;\n                    }\n\n                    if ($nom == \"Group\") {\n                        $group = true;\n                        $entry = false;\n                        $name = \"\";\n\n                        // recap previous info\n                        if (!empty($temparray[KP_TITLE])) {\n                            //store data\n                            fputs(\n                                $cacheFile,\n                                $temparray[KP_PATH].$itemsSeparator.$temparray[KP_GROUP].\n                                $itemsSeparator.$temparray[KP_TITLE].$itemsSeparator.$temparray[KP_PW].\n                                $itemsSeparator.$temparray[KP_USERNAME].$itemsSeparator.\n                                $temparray[KP_URL].$itemsSeparator.$temparray[KP_UUID].$itemsSeparator.$temparray[KP_NOTES].\"\\n\"\n                            );\n\n                            //Clean temp array\n                            $temparray[KP_TITLE] = $temparray[KP_NOTES] = $temparray[KP_PW] = $temparray[KP_USERNAME] = $temparray[KP_URL] = \"\";\n\n                            //increment number\n                            $numItems++;\n                        }\n                        $historyLevel = 0;\n                    }\n\n                    //History node needs to be managed in order to not polluate final list\n                    if ($nom == \"History\") {\n                        $history = true;\n                        $entry = false;\n                        $historyLevel = $xmlLevel;\n                    }\n\n                    if ($nom == \"Entry\" && ($xmlLevel < $historyLevel || empty($historyLevel))) {\n                        $entry = true;\n                        $group = false;\n\n                        // recap previous info\n                        if (!empty($temparray[KP_TITLE])) {\n                            //store data\n                            fputs($cacheFile, $temparray[KP_PATH].$itemsSeparator.$temparray[KP_GROUP].$itemsSeparator.$temparray[KP_TITLE].$itemsSeparator.$temparray[KP_PW].$itemsSeparator.$temparray[KP_USERNAME].$itemsSeparator.$temparray[KP_URL].$itemsSeparator.$temparray[KP_UUID].$itemsSeparator.$temparray[KP_NOTES].\"\\n\");\n\n                            //Clean temp array\n                            $temparray[KP_TITLE] = $temparray[KP_NOTES] = $temparray[KP_PW] = $temparray[KP_USERNAME] = $temparray[KP_URL] = $temparray[KP_UUID] = \"\";\n\n                            //increment number\n                            $numItems++;\n                        }\n                        $historyLevel = 0;\n                    }\n\n                    //get children\n                    $xmlChildren = $elem->children();\n\n                    //recursive call\n                    recursiveKeepassXML($xmlChildren, $xmlLevel + 1);\n\n                    //IMPORTING KEEPASS 2 XML FILE\n                } elseif ($keepassVersion != 1) {\n                    // exit if XML file not generated by KeePass\n                    if ($meta === true && $nom == \"Generator\" && $elem == \"KeePass\") {\n                        $generatorFound = true;\n                        $keepassVersion = 2;\n                        break;\n                    } elseif ($root === true && $xmlLevel > $levelMin) {\n                        //Check each node name and get data from some of them\n                        if ($entry === true && $nom == \"Key\" && $elem == \"Title\") {\n                            $title = true;\n                            $notes = $pwd = $url = $username = false;\n                        } elseif ($entry === true && $nom == \"Key\" && $elem == \"Notes\") {\n                            $notes = true;\n                            $title = $pwd = $url = $username = false;\n                        } elseif ($entry === true && $nom == \"UUID\") {\n                            $temparray[KP_UUID] = $elem;\n                        } elseif ($entry === true && $nom == \"Key\" && $elem == \"Password\") {\n                            $pwd = true;\n                            $notes = $title = $url = $username = false;\n                        } elseif ($entry === true && $nom == \"Key\" && $elem == \"URL\") {\n                            $url = true;\n                            $notes = $pwd = $title = $username = false;\n                        } elseif ($entry === true && $nom == \"Key\" && $elem == \"UserName\") {\n                            $username = true;\n                            $notes = $pwd = $url = $title = false;\n                        } elseif ($group === true && $nom == \"Name\") {\n                            $temparray[KP_GROUP] = addslashes(preg_replace('#[\\r\\n]#', '', $elem));\n                            $temparray['level'] = $xmlLevel;\n                            //build current path\n                            if ($xmlLevel > $levelInProgress) {\n                                if (!empty($temparray[KP_PATH])) {\n                                    $temparray[KP_PATH] .= $foldersSeparator.$temparray[KP_GROUP];\n                                } else {\n                                    $temparray[KP_PATH] = $temparray[KP_GROUP];\n                                }\n                            } elseif ($xmlLevel == $levelInProgress) {\n                                if ($levelInProgress == 3) {\n                                    $temparray[KP_PATH] = $temparray[KP_GROUP];\n                                } else {\n                                    $temparray[KP_PATH] = substr($temparray[KP_PATH], 0, strrpos($temparray[KP_PATH], $foldersSeparator) + strlen($foldersSeparator)).$temparray[KP_GROUP];\n                                }\n                            } else {\n                                $diff = abs($xmlLevel - $levelInProgress) + 1;\n                                $tmp = explode($foldersSeparator, $temparray[KP_PATH]);\n                                $temparray[KP_PATH] = \"\";\n                                for ($x = 0; $x < (count($tmp) - $diff); $x++) {\n                                    if (!empty($temparray[KP_PATH])) {\n                                        $temparray[KP_PATH] = $temparray[KP_PATH].$foldersSeparator.$tmp[$x];\n                                    } else {\n                                        $temparray[KP_PATH] = $tmp[$x];\n                                    }\n                                }\n                                if (!empty($temparray[KP_PATH])) {\n                                    $temparray[KP_PATH] .= $foldersSeparator.$temparray[KP_GROUP];\n                                } else {\n                                    $temparray[KP_PATH] = $temparray[KP_GROUP];\n                                }\n                            }\n\n                            //store folders\n                            if (!in_array($temparray[KP_PATH], $groupsArray)) {\n                                fwrite($cacheFileF, $temparray[KP_PATH].\"\\n\");\n                                array_push($groupsArray, $temparray[KP_PATH]);\n                                //increment number\n                                $numGroups++;\n                            }\n\n                            //Store actual level\n                            $levelInProgress = $xmlLevel;\n                            $previousLevel = $temparray[KP_GROUP];\n                        } elseif ($title === true && $nom == \"Value\") {\n                            $title = false;\n                            $temparray[KP_TITLE] = sanitiseString($elem, '');\n                        } elseif ($notes === true && $nom == \"Value\") {\n                            $notes = false;\n                            $temparray[KP_NOTES] = sanitiseString($elem, '');\n                        } elseif ($pwd === true && $nom == \"Value\") {\n                            $pwd = false;\n                            $temparray[KP_PW] = sanitiseString($elem, '');\n                        } elseif ($url === true && $nom == \"Value\") {\n                            $url = false;\n                            $temparray[KP_URL] = sanitiseString($elem, '');\n                        } elseif ($username === true && $nom == \"Value\") {\n                            $username = false;\n                            $temparray[KP_USERNAME] = sanitiseString($elem, '');\n                        }\n                    }\n                }\n            }\n        }\n\n        fputs($cacheLogFile, date('H:i:s ').\"Writing XML File \".filter_input(INPUT_POST, 'file', FILTER_SANITIZE_STRING).\"\\n\");\n\n        // Go through each node of XML file\n        recursiveKeepassXML($xml);\n\n        //Stop if not a keepass file\n        if ($generatorFound === false) {\n            //Close file & delete it\n            fclose($cacheFileF);\n            fclose($cacheFile);\n            unlink($cacheFileName);\n            unlink($cacheFileNameFolder);\n            unlink($SETTINGS['url_to_files_folder'].\"/\".filter_input(INPUT_POST, 'file', FILTER_SANITIZE_STRING));\n\n            fputs($cacheLogFile, date('H:i').$LANG['import_error_no_read_possible_kp'].\"\\n\");\n\n            echo '[{\"error\":\"not_kp_file\" , \"message\":\"'.$LANG['import_error_no_read_possible_kp'].'\"}]';\n            break;\n        }\n\n        //save last item\n        if (!empty($temparray[KP_TITLE])) {\n            //store data\n            fputs(\n                $cacheFile,\n                $temparray[KP_PATH].$itemsSeparator.$temparray[KP_GROUP].$itemsSeparator.\n                $temparray[KP_TITLE].$itemsSeparator.$temparray[KP_PW].$itemsSeparator.$temparray[KP_USERNAME].\n                $itemsSeparator.$temparray[KP_URL].$itemsSeparator.$temparray[KP_UUID].$itemsSeparator.$temparray[KP_NOTES].\"\\n\"\n            );\n\n            //increment number\n            $numItems++;\n        }\n\n        ##################\n        ## STARTING IMPORTING IF NO ERRORS OR NOT EMPTY\n        ##################\n        if ($numItems > 0 || $numGroups > 0) {\n            // Write in file\n            fputs($cacheLogFile, date('H:i:s ').$LANG['nb_folders'].' '.$numGroups.\"\\n\");\n            fputs($cacheLogFile, date('H:i:s ').$LANG['nb_items'].' '.$numItems.\"\\n\");\n\n            $import_perso = false;\n            $itemsArray = array();\n            $text = '<span class=\"fa fa-folder-open\"></span>&nbsp;'.$LANG['nb_folders'].': '.\n                $numGroups.'<br /><span class=\"fa fa-tag\"></span>>&nbsp;'.$LANG['nb_items'].': '.\n                $numItems.'<br /><br />';\n            $post_destination = filter_input(INPUT_POST, 'destination', FILTER_SANITIZE_STRING);\n\n            // If personal folder, then remove the suffix in ID\n            if (substr_count($post_destination, '-perso') > 0) {\n                $post_destination = str_replace('-perso', '', $post_destination);\n            }\n\n            // If destination is not ROOT then get the complexity level\n            if (strpos($post_destination, \"perso\") !== 0) {\n                $levelPwComplexity = 50;\n                $startPathLevel = 1;\n                $import_perso = true;\n            } elseif ($post_destination > 0) {\n                $data = DB::queryFirstRow(\n                    \"SELECT m.valeur as value, t.nlevel as nlevel\n                    FROM \".prefix_table(\"misc\").\" as m\n                    INNER JOIN \".prefix_table(\"nested_tree\").\" as t ON (m.intitule = t.id)\n                    WHERE m.type = %s AND m.intitule = %s\",\n                    \"complex\",\n                    mysqli_escape_string($link, $post_destination)\n                );\n                $levelPwComplexity = $data['value'];\n                $startPathLevel = $data['nlevel'];\n            } else {\n                $levelPwComplexity = 50;\n                $startPathLevel = 0;\n            }\n\n            //Get all folders from file\n            fclose($cacheFileF);\n            $cacheFileF = fopen($cacheFileNameFolder, \"r\");\n\n            //Create folders\n            $i = 1;\n            $level = 0;\n            $foldersArray = array();\n            $nbFoldersImported = 0;\n\n            fputs($cacheLogFile, date('H:i:s ').\"Creating Folders\\n\");\n            $results = \"Folders\\n\\n\";\n\n            while (!feof($cacheFileF)) {\n                $folder = fgets($cacheFileF, 4096);\n                if (!empty($folder)) {\n                    $folder = str_replace(array(\"\\r\\n\", \"\\n\", \"\\r\"), '', $folder);\n                    //get number of levels in path\n                    $path = explode($foldersSeparator, $folder);\n                    $folderLevel = count($path);\n\n                    //get folder name\n                    if (strrpos($folder, $foldersSeparator) > 0) {\n                        $fold = substr($folder, strrpos($folder, $foldersSeparator) + strlen($foldersSeparator));\n                        $parent = implode($foldersSeparator, array_slice($path, 0, -1));\n                        $parent_id = $foldersArray[$parent]['id'];\n                    } else {\n                        $fold = $folder;\n                        $parent_id = $post_destination; //permits to select the folder destination\n                    }\n\n                    $fold = stripslashes($fold);\n                    //create folder - if not exists at the same level\n                    DB::query(\n                        \"SELECT * FROM \".prefix_table(\"nested_tree\").\"\n                        WHERE nlevel = %i AND title = %s AND parent_id = %i LIMIT 1\",\n                        intval($folderLevel + $startPathLevel),\n                        $fold,\n                        $parent_id\n                    );\n                    $results .= str_replace($foldersSeparator, '\\\\', $folder);\n                    $counter = DB::count();\n                    if ($counter == 0) {\n                        $results .= \" - Inserting\\n\";\n                        //do query\n                        DB::insert(\n                            prefix_table(\"nested_tree\"),\n                            array(\n                                'parent_id' => $parent_id,\n                                'title' => stripslashes($fold),\n                                'nlevel' => $folderLevel\n                            )\n                        );\n                        $id = DB::insertId();\n                        //Add complexity level => level is set to \"medium\" by default.\n                        DB::insert(\n                            prefix_table(\"misc\"),\n                            array(\n                                'type' => 'complex',\n                                'intitule' => $id,\n                                'valeur' => $levelPwComplexity\n                            )\n                        );\n\n                        //For each role to which the user depends on, add the folder just created.\n                        foreach ($_SESSION['arr_roles'] as $role) {\n                            DB::insert(\n                                prefix_table(\"roles_values\"),\n                                array(\n                                    'role_id' => $role['id'],\n                                    'folder_id' => $id,\n                                    'type' => \"W\"\n                                )\n                            );\n                        }\n\n                        //Add this new folder to the list of visible folders for the user.\n                        array_push($_SESSION['groupes_visibles'], $id);\n\n                        //increment number of imported folders\n                        $nbFoldersImported++;\n                    } else {\n                        $results .= \" - Skipped\\n\";\n                        //get folder actual ID\n                        $data = DB::queryFirstRow(\n                            \"SELECT id FROM \".prefix_table(\"nested_tree\").\"\n                            WHERE nlevel = %i AND title = %s AND parent_id = %i\",\n                            intval($folderLevel + $startPathLevel),\n                            $fold,\n                            $parent_id\n                        );\n                        $id = $data['id'];\n                    }\n\n                    //store in array\n                    $foldersArray[$folder] = array(\n                        'folder' => $fold,\n                        'nlevel' => $folderLevel,\n                        'id' => $id\n                    );\n\n                    $_SESSION['nb_folders']++;\n                    $i++;\n                }\n            }\n\n            $results .= \"\\n\\nItems\\n\\n\";\n            //if no new folders them inform\n            if ($nbFoldersImported > 0) {\n                fputs($cacheLogFile, date('H:i:s ').\"Setting User Rights\\n\");\n                //Refresh the rights of actual user\n                identifyUserRights(\n                    implode(';', $_SESSION['groupes_visibles']).';'.$newId,\n                    $_SESSION['groupes_interdits'],\n                    $_SESSION['is_admin'],\n                    $_SESSION['fonction_id']\n                );\n\n                fputs($cacheLogFile, date('H:i:s ').\"Rebuilding Tree\\n\");\n                //rebuild full tree\n                $tree->rebuild();\n            }\n\n            fputs($cacheLogFile, date('H:i:s ').\"Importing Items\\n\");\n\n            // Now import ITEMS\n            $nbItemsImported = 0;\n            $count = 0;\n\n            //Get some info about personal folder\n            if ($post_destination == $_SESSION['user_id']) {\n                $personalFolder = 1;\n            } else {\n                $personalFolder = 0;\n            }\n\n            //prepare file to be read\n            fclose($cacheFile);\n            $cacheFile = fopen($cacheFileName, \"r\");\n\n            while (!feof($cacheFile)) {\n                //prepare an array with item to import\n                $full_item = fgets($cacheFile, 8192);\n                $full_item = str_replace(array(\"\\r\\n\", \"\\n\", \"\\r\"), '', $full_item);\n                $item = explode($itemsSeparator, $full_item);\n\n                $count++;\n                if (!($count % 10)) {\n                    fputs($cacheLogFile, date('H:i:s ').\"  Imported $count items (\".number_format(($count / $numItems) * 100, 1).\")\\n\");\n                }\n\n                if (!empty($item[KP_TITLE])) {\n                    //$count++;\n                    //check if not exists\n                    $results .= str_replace($foldersSeparator, \"\\\\\", $item[KP_PATH]).'\\\\'.$item[KP_TITLE];\n\n                    $pwd = $item[KP_PASSWORD];\n\n                    //Get folder label\n                    if (count($foldersArray) == 0 || empty($item[KP_PATH])) {\n                        $folderId = $post_destination;\n                    } else {\n                        $folderId = $foldersArray[$item[KP_PATH]]['id'];\n                    }\n                    $data = DB::queryFirstRow(\n                        \"SELECT title FROM \".prefix_table(\"nested_tree\").\" WHERE id = %i\",\n                        intval($folderId)\n                    );\n\n                    // escape if folderId is empty\n                    if (!empty($folderId)) {\n                        $results .= \" - Inserting\\n\";\n\n                        // prepare PW\n                        if ($import_perso === true) {\n                            $encrypt = cryption(\n                                $pwd,\n                                $_SESSION['user_settings']['session_psk'],\n                                \"encrypt\"\n                            );\n                        } else {\n                            $encrypt = cryption(\n                                $pwd,\n                                \"\",\n                                \"encrypt\"\n                            );\n                        }\n\n                        //ADD item\n                        DB::insert(\n                            prefix_table(\"items\"),\n                            array(\n                                'label' => substr(stripslashes($item[KP_TITLE]), 0, 500),\n                                'description' => stripslashes(str_replace($lineEndSeparator, '<br />', $item[KP_NOTES])),\n                                'pw' => $encrypt['string'],\n                                'pw_iv' => $encrypt['iv'],\n                                'url' => substr(stripslashes($item[KP_URL]), 0, 500),\n                                'id_tree' => $folderId,\n                                'login' => substr(stripslashes($item[KP_USERNAME]), 0, 500),\n                                'anyone_can_modify' => filter_input(INPUT_POST, 'import_kps_anyone_can_modify', FILTER_SANITIZE_STRING) === \"true\" ? 1 : 0\n                            )\n                        );\n                        $newId = DB::insertId();\n\n                        //if asked, anyone in role can modify\n                        if (null !== filter_input(INPUT_POST, 'import_kps_anyone_can_modify_in_role', FILTER_SANITIZE_STRING) && filter_input(INPUT_POST, 'import_kps_anyone_can_modify_in_role', FILTER_SANITIZE_STRING) === \"true\") {\n                            foreach ($_SESSION['arr_roles'] as $role) {\n                                DB::insert(\n                                    prefix_table(\"restriction_to_roles\"),\n                                    array(\n                                        'role_id' => $role['id'],\n                                        'item_id' => $newId\n                                    )\n                                );\n                            }\n                        }\n\n                        //Add log\n                        DB::insert(\n                            prefix_table(\"log_items\"),\n                            array(\n                                'id_item' => $newId,\n                                'date' => time(),\n                                'id_user' => $_SESSION['user_id'],\n                                'action' => 'at_creation',\n                                'raison' => 'at_import'\n                            )\n                        );\n\n                        //Add entry to cache table\n                        DB::insert(\n                            prefix_table(\"cache\"),\n                            array(\n                                'id' => $newId,\n                                'label' => substr(stripslashes($item[KP_TITLE]), 0, 500),\n                                'description' => stripslashes(str_replace($lineEndSeparator, '<br />', $item[KP_NOTES])),\n                                'url' => (isset($item[KP_NOTES]) && !empty($item[KP_NOTES])) ? $item[KP_NOTES] : \"0\",\n                                'tags' => \"\",\n                                'id_tree' => $folderId,\n                                'perso' => $personalFolder == 0 ? 0 : 1,\n                                'login' => substr(stripslashes($item[KP_USERNAME]), 0, 500),\n                                'restricted_to' => \"0\",\n                                'folder' => $data['title'],\n                                'author' => $_SESSION['user_id'],\n                                'renewal_period' => \"0\",\n                                'timestamp' => time()\n                            )\n                        );\n\n                        //increment number of imported items\n                        $nbItemsImported++;\n                    } else {\n                        $results .= \" - \".$item[KP_TITLE].\" was not imported\\n\";\n                    }\n                    fputs($cacheLogFile, date('H:i:s ').\" \".$results.\"\\n\");\n                }\n            }\n\n            //SHow finished\n            $text .= \"Folders imported: $nbFoldersImported<br />\";\n            $text .= \"Items imported: $nbItemsImported<br />\";\n            $text .= '</div><br /><br /><b>'.$LANG['import_kp_finished'].'</b>';\n            $text .= '<a href=\\''.$SETTINGS['url_to_files_folder'].'/'.$logFileName.'\\' target=\\'_blank\\'>'.$LANG['pdf_download'].'</a>';\n\n            fputs($cacheLogFile, date('H:i:s ').\"Import finished\\n\");\n            fputs($cacheLogFile, date('H:i:s ').\"Statistics\\n\");\n            fputs($cacheLogFile, date('H:i:s ').\"Folders imported: $nbFoldersImported\\n\");\n            fputs($cacheLogFile, date('H:i:s ').\"Items imported: $nbItemsImported\\n\\n\".$results);\n\n            //Delete cache file\n            fclose($cacheFileF);\n            fclose($cacheFile);\n            fclose($cacheLogFile);\n            unlink($cacheFileName);\n            unlink($cacheFileNameFolder);\n            unlink($SETTINGS['path_to_files_folder'].\"/\".$file);\n\n            //Display all messages to user\n            echo '[{\"error\":\"no\" , \"message\":\"'.str_replace('\"', \"&quote;\", strip_tags($text, '<br /><a><div><b><br>')).'\"}]';\n        } else {\n            echo '[{\"error\":\"yes\" , \"message\":\"\"}]';\n        }\n        break;\n}\n\nspl_autoload_register(function ($class) {\n    $prefix = 'League\\\\Csv\\\\';\n    $base_dir = __DIR__.'/src/';\n    $len = strlen($prefix);\n    if (strncmp($prefix, $class, $len) !== 0) {\n        // no, move to the next registered autoloader\n        return;\n    }\n    $relative_class = substr($class, $len);\n    $file = $base_dir.str_replace('\\\\', '/', $relative_class).'.php';\n    if (file_exists($file)) {\n        require $file;\n    }\n});\n", "<?php\n/**\n * @file          roles.queries.php\n * @author        Nils Laumaill\u00e9\n * @version       2.1.27\n * @copyright     (c) 2009-2017 Nils Laumaill\u00e9\n * @licensing     GNU AFFERO GPL 3.0\n * @link          http://www.teampass.net\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n */\n\nrequire_once 'SecureHandler.php';\nsession_start();\nif (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 ||\n    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) ||\n    !isset($_SESSION['key']) || empty($_SESSION['key'])\n) {\n    die('Hacking attempt...');\n}\n\n// Load config\nif (file_exists('../includes/config/tp.config.php')) {\n    require_once '../includes/config/tp.config.php';\n} elseif (file_exists('./includes/config/tp.config.php')) {\n    require_once './includes/config/tp.config.php';\n} else {\n    throw new Exception(\"Error file '/includes/config/tp.config.php' not exists\", 1);\n}\n/* do checks */\nrequire_once $SETTINGS['cpassman_dir'].'/includes/config/include.php';\nrequire_once $SETTINGS['cpassman_dir'].'/sources/checks.php';\nif (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"manage_roles\")) {\n    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n    include $SETTINGS['cpassman_dir'].'/error.php';\n    exit();\n}\n\ninclude $SETTINGS['cpassman_dir'].'/includes/language/'.$_SESSION['user_language'].'.php';\ninclude $SETTINGS['cpassman_dir'].'/includes/config/settings.php';\nheader(\"Content-type: text/html; charset=utf-8\");\nrequire_once 'main.functions.php';\n\nrequire_once $SETTINGS['cpassman_dir'].'/sources/SplClassLoader.php';\n\n//Connect to DB\nrequire_once $SETTINGS['cpassman_dir'].'/includes/libraries/Database/Meekrodb/db.class.php';\n$pass = defuse_return_decrypted($pass);\nDB::$host = $server;\nDB::$user = $user;\nDB::$password = $pass;\nDB::$dbName = $database;\nDB::$port = $port;\nDB::$encoding = $encoding;\nDB::$error_handler = true;\n$link = mysqli_connect($server, $user, $pass, $database, $port);\n$link->set_charset($encoding);\n\n//Build tree\n$tree = new SplClassLoader('Tree\\NestedTree', $SETTINGS['cpassman_dir'].'/includes/libraries');\n$tree->register();\n$tree = new Tree\\NestedTree\\NestedTree($pre.'nested_tree', 'id', 'parent_id', 'title');\n\nif (null !== filter_input(INPUT_POST, 'type', FILTER_SANITIZE_STRING)) {\n    switch (filter_input(INPUT_POST, 'type', FILTER_SANITIZE_STRING)) {\n        #CASE adding a new role\n        case \"add_new_role\":\n            // Prepare POST variables\n            $post_name = filter_input(INPUT_POST, 'name', FILTER_SANITIZE_STRING);\n\n            //Check if role already exist : No similar roles\n            $tmp = DB::query(\n                \"SELECT * FROM \".prefix_table(\"roles_title\").\" WHERE title = %s\",\n                stripslashes($post_name)\n            );\n            $counter = DB::count();\n            if ($counter == 0) {\n                db::debugmode(false);\n                DB::insert(\n                    prefix_table(\"roles_title\"),\n                    array(\n                        'title' => noHTML($post_name),\n                        'complexity' => filter_input(INPUT_POST, 'complexity', FILTER_SANITIZE_NUMBER_INT),\n                        'creator_id' => $_SESSION['user_id']\n                    )\n                );\n                $role_id = DB::insertId();\n\n                if ($role_id != 0) {\n                    //Actualize the variable\n                    $_SESSION['nb_roles']++;\n\n                    // get some data\n                    $data_tmp = DB::queryfirstrow(\n                        \"SELECT fonction_id FROM \".prefix_table(\"users\").\" WHERE id = %s\",\n                        $_SESSION['user_id']\n                    );\n\n                    // add new role to user\n                    $tmp = str_replace(\";;\", \";\", $data_tmp['fonction_id']);\n                    if (substr($tmp, -1) == \";\") {\n                        $_SESSION['fonction_id'] = str_replace(\";;\", \";\", $data_tmp['fonction_id'].$role_id);\n                    } else {\n                        $_SESSION['fonction_id'] = str_replace(\";;\", \";\", $data_tmp['fonction_id'].\";\".$role_id);\n                    }\n                    // store in DB\n                    DB::update(\n                        prefix_table(\"users\"),\n                        array(\n                            'fonction_id' => $_SESSION['fonction_id']\n                            ),\n                        \"id = %i\",\n                        $_SESSION['user_id']\n                    );\n                    $_SESSION['user_roles'] = explode(\";\", $_SESSION['fonction_id']);\n\n\n                    echo '[ { \"error\" : \"no\" } ]';\n                } else {\n                    echo '[ { \"error\" : \"yes\" , \"message\" : \"Database error. Contact your administrator!\" } ]';\n                }\n            } else {\n                echo '[ { \"error\" : \"yes\" , \"message\" : \"'.$LANG['error_role_exist'].'\" } ]';\n            }\n            break;\n\n        //-------------------------------------------\n        #CASE delete a role\n        case \"delete_role\":\n            // Prepare POST variables\n            $post_id = filter_input(INPUT_POST, 'id', FILTER_SANITIZE_NUMBER_INT);\n\n            // Delete roles\n            DB::delete(prefix_table(\"roles_title\"), \"id = %i\", $post_id);\n            DB::delete(prefix_table(\"roles_values\"), \"role_id = %i\", $post_id);\n\n            //Actualize the variable\n            $_SESSION['nb_roles']--;\n\n            // parse all users to remove this role\n            $rows = DB::query(\n                \"SELECT id, fonction_id FROM \".prefix_table(\"users\").\"\n                ORDER BY id ASC\"\n            );\n            foreach ($rows as $record) {\n                $tab = explode(\";\", $record['fonction_id']);\n                if (($key = array_search($post_id, $tab)) !== false) {\n                    // remove the deleted role id\n                    unset($tab[$key]);\n\n                    // store new list of functions\n                    DB::update(\n                        prefix_table(\"users\"),\n                        array(\n                            'fonction_id' => rtrim(implode(\";\", $tab), \";\")\n                            ),\n                        \"id = %i\",\n                        $record['id']\n                    );\n                }\n            }\n\n            echo '[ { \"error\" : \"no\" } ]';\n            break;\n\n        //-------------------------------------------\n        #CASE editing a role\n        case \"edit_role\":\n            // Prepare POST variables\n            $post_id = filter_input(INPUT_POST, 'id', FILTER_SANITIZE_NUMBER_INT);\n            $post_title = filter_input(INPUT_POST, 'title', FILTER_SANITIZE_STRING);\n\n            //Check if role already exist : No similar roles\n            DB::query(\n                \"SELECT * FROM \".prefix_table(\"roles_title\").\" WHERE title = %s AND id != %i\",\n                $post_title,\n                $post_id\n            );\n            $counter = DB::count();\n            if ($counter == 0) {\n                DB::update(\n                    prefix_table(\"roles_title\"),\n                    array(\n                        'title' => noHTML(filter_input(INPUT_POST, 'title', FILTER_SANITIZE_STRING)),\n                        'complexity' => filter_input(INPUT_POST, 'complexity', FILTER_SANITIZE_NUMBER_INT),\n                    ),\n                    'id = %i',\n                    filter_input(INPUT_POST, 'id', FILTER_SANITIZE_NUMBER_INT)\n                );\n                echo '[ { \"error\" : \"no\" } ]';\n            } else {\n                echo '[ { \"error\" : \"yes\" , \"message\" : \"'.$LANG['error_role_exist'].'\" } ]';\n            }\n            break;\n\n        /******************************************\n        *CASE editing a role\n        */\n        case \"allow_pw_change_for_role\":\n            DB::update(\n                prefix_table(\"roles_title\"),\n                array(\n                    'allow_pw_change' => filter_input(INPUT_POST, 'value', FILTER_SANITIZE_STRING)\n                ),\n                'id = %i',\n                filter_input(INPUT_POST, 'id', FILTER_SANITIZE_NUMBER_INT)\n            );\n            break;\n\n        //-------------------------------------------\n        #CASE change right for a role on a folder via the TM\n        case \"change_role_via_tm\":\n            // Prepare POST variables\n            $post_access = filter_input(INPUT_POST, 'access', FILTER_SANITIZE_STRING);\n            $post_accessoption = filter_input(INPUT_POST, 'accessoption', FILTER_SANITIZE_STRING);\n\n            // Loop on selection\n            $arr = explode(\",\", filter_input(INPUT_POST, 'multiselection', FILTER_SANITIZE_STRING));\n            foreach ($arr as $elem) {\n                $tmp = explode('-', $elem);\n                $folder_id = $tmp[0];\n                $role_id = $tmp[1];\n\n                //get full tree dependencies\n                $tree_list = $tree->getDescendants($folder_id, true);\n\n                if ($post_access === \"read\" || $post_access === \"write\" || $post_access === \"nodelete\") {\n                    // define code to use\n                    if ($post_access == \"read\") {\n                        $access = \"R\";\n                    } elseif ($post_access == \"write\") {\n                        if (empty($post_accessoption) === true) {\n                            $access = \"W\";\n                        } elseif ($post_accessoption === \"nodelete\") {\n                            $access = \"ND\";\n                        } elseif ($post_accessoption === \"noedit\") {\n                            $access = \"NE\";\n                        } elseif ($post_accessoption === \"nodelete_noedit\") {\n                            $access = \"NDNE\";\n                        }\n                    } else {\n                        $access = \"\";\n                    }\n\n                    // loop\n                    foreach ($tree_list as $node) {\n                        // delete\n                        DB::delete(prefix_table(\"roles_values\"), \"folder_id = %i AND role_id = %i\", $node->id, $role_id);\n\n                        //Store in DB\n                        DB::insert(\n                            prefix_table(\"roles_values\"),\n                            array(\n                                'folder_id' => $node->id,\n                                'role_id' => $role_id,\n                                'type' => $access\n                            )\n                        );\n                    }\n                } else {\n                    foreach ($tree_list as $node) {\n                        // delete\n                        DB::delete(prefix_table(\"roles_values\"), \"folder_id = %i AND role_id = %i\", $node->id, $role_id);\n                    }\n                }\n            }\n\n            echo '[ { \"error\" : \"no\" } ]';\n            break;\n\n        //-------------------------------------------\n        #CASE refresh the matrix\n        case \"refresh_roles_matrix\":\n            // Ensure Complexity levels are translated\n            if (isset($SETTINGS_EXT['pwComplexity']) === false) {\n                $SETTINGS_EXT['pwComplexity'] = array(\n                    0=>array(0, $LANG['complex_level0']),\n                    25=>array(25, $LANG['complex_level1']),\n                    50=>array(50, $LANG['complex_level2']),\n                    60=>array(60, $LANG['complex_level3']),\n                    70=>array(70, $LANG['complex_level4']),\n                    80=>array(80, $LANG['complex_level5']),\n                    90=>array(90, $LANG['complex_level6'])\n                );\n            }\n\n            // Prepare POST variables\n            $post_start = filter_input(INPUT_POST, 'start', FILTER_SANITIZE_NUMBER_INT);\n            $post_filter = filter_input(INPUT_POST, 'filter', FILTER_SANITIZE_STRING);\n\n            $tree = $tree->getDescendants();\n            $texte = '<table><thead><tr><th>'.$LANG['groups'].'</th>';\n            $gpes_ok = array();\n            $gpes_nok = array();\n            $arrRolesTitle = array();\n            $arrRoles = array();\n            $display_nb = 8;\n            $sql_limit = \"\";\n            $next = 1;\n            $previous = 1;\n            $where = \"\";\n\n            // Should we filter on role names\n            if (empty($post_filter) === false) {\n                $where = \" WHERE title LIKE '\".$post_filter.\"%'\";\n            }\n\n            //count nb of roles\n            $arrUserRoles = array_filter($_SESSION['user_roles']);\n            if (count($arrUserRoles) >= 0 && $_SESSION['is_admin'] !== \"1\") {\n                if (empty($where) === false) {\n                    $where = \" WHERE id IN (\".implode(',', $arrUserRoles).\")\";\n                } else {\n                    $where .= \" AND id IN (\".implode(',', $arrUserRoles).\")\";\n                }\n            }\n            DB::query(\"SELECT * FROM \".prefix_table(\"roles_title\").$where);\n            $roles_count = DB::count();\n            if ($roles_count > $display_nb) {\n                if (null === $post_start || $post_start === 0) {\n                    $start = 0;\n                    $previous = 0;\n                } else {\n                    $start = $post_start;\n                    $previous = $start - $display_nb;\n                }\n                $sql_limit = \" LIMIT \".mysqli_real_escape_string($link, filter_var($start, FILTER_SANITIZE_NUMBER_INT)).\", \".mysqli_real_escape_string($link, filter_var($display_nb, FILTER_SANITIZE_NUMBER_INT));\n                $next = $start + $display_nb + 1;\n            }\n\n            // array of roles for actual user\n            $my_functions = $arrUserRoles;\n\n            //Display table header\n            $rows = DB::query(\n                \"SELECT * FROM \".prefix_table(\"roles_title\").\n                $where.\"\n                ORDER BY title ASC\".$sql_limit\n            );\n            foreach ($rows as $record) {\n                if ($_SESSION['is_admin'] == 1 || ($_SESSION['user_manager'] == 1 && (in_array($record['id'], $my_functions) || $record['creator_id'] == $_SESSION['user_id']))) {\n                    if ($record['allow_pw_change'] == 1) {\n                        $allow_pw_change = '&nbsp;<span class=\\'fa mi-red fa-2x fa-magic tip\\' id=\\'img_apcfr_'.$record['id'].'\\' onclick=\\'allow_pw_change_for_role('.$record['id'].', 0)\\' style=\\'cursor:pointer;\\' title=\\''.$LANG['role_cannot_modify_all_seen_items'].'\\'></span>';\n                    } else {\n                        $allow_pw_change = '&nbsp;<span class=\\'fa fa-magic fa-2x mi-green tip\\'  id=\\'img_apcfr_'.$record['id'].'\\' onclick=\\'allow_pw_change_for_role('.$record['id'].', 1)\\' style=\\'cursor:pointer;\\' title=\\''.$LANG['role_can_modify_all_seen_items'].'\\'></span>';\n                    }\n                    $title = mysqli_real_escape_string($link, filter_var($record['title'], FILTER_SANITIZE_STRING));\n\n                    $texte .= '<th style=\\'font-size:10px;min-width:60px;\\' class=\\'edit_role\\'>'.\n                        $title.\n                        '<br>'.\n                        '<span class=\\'fa fa-pencil fa-2x mi-grey-1\\' onclick=\\'edit_this_role('.$record['id'].',\"'.htmlentities($record['title'], ENT_QUOTES, \"UTF-8\").'\",'.$record['complexity'].')\\' style=\\'cursor:pointer;\\'></span>&nbsp;'.\n                        '<span class=\\'fa fa-trash fa-2x mi-grey-1\\' style=\\'cursor:pointer;\\' onclick=\\'delete_this_role('.$record['id'].',\"'.htmlentities($record['title'], ENT_QUOTES, \"UTF-8\").'\")\\'></span>'.\n                        $allow_pw_change.\n                        '<div style=\\'margin-top:-8px;\\'>[&nbsp;'.$SETTINGS_EXT['pwComplexity'][$record['complexity']][1].'&nbsp;]</div></th>';\n\n                    array_push($arrRoles, $record['id']);\n                    array_push($arrRolesTitle, $record['title']);\n                }\n            }\n            $texte .= '</tr></thead><tbody>';\n\n            //Display each folder with associated rights by role\n            $i = 0;\n            foreach ($tree as $node) {\n                if (in_array($node->id, $_SESSION['groupes_visibles']) && !in_array($node->id, $_SESSION['personal_visible_groups'])) {\n                    $ident = \"\";\n                    for ($a = 1; $a < $node->nlevel; $a++) {\n                        $ident .= '<i class=\\'fa fa-sm fa-caret-right mi-grey-1\\'></i>&nbsp;';\n                    }\n\n                    //display 1st cell of the line\n                    $texte .= '<tr><td style=\\'font-size:10px; font-family:arial;\\' title=\\'ID='.$node->id.'\\'>'.$ident.\" \".$node->title.'</td>';\n\n                    foreach ($arrRoles as $role) {\n                        //check if this role has access or not\n                        // if not then color is red; if yes then color is green\n                        $role_detail = DB::queryfirstrow(\"SELECT * FROM \".prefix_table(\"roles_values\").\" WHERE folder_id = %i AND role_id = %i\", $node->id, $role);\n                        if (DB::count() > 0) {\n                            if ($role_detail['type'] == \"W\") {\n                                $color = '#008000';\n                                $allowed = \"W\";\n                                $title = $LANG['write'];\n                                $label = '<i class=\"fa fa-indent\"></i>&nbsp;<i class=\"fa fa-edit\"></i>&nbsp;<i class=\"fa fa-eraser\"></i>';\n                            } elseif ($role_detail['type'] == \"ND\") {\n                                $color = '#4E45F7';\n                                $allowed = \"ND\";\n                                $title = $LANG['no_delete'];\n                                $label = '<i class=\"fa fa-indent\"></i>&nbsp;<i class=\"fa fa-edit\"></i>';\n                            } elseif ($role_detail['type'] == \"NE\") {\n                                $color = '#4E45F7';\n                                $allowed = \"NE\";\n                                $title = $LANG['no_edit'];\n                                $label = '<i class=\"fa fa-indent\"></i>&nbsp;<i class=\"fa fa-eraser\"></i>';\n                            } elseif ($role_detail['type'] == \"NDNE\") {\n                                $color = '#4E45F7';\n                                $allowed = \"NDNE\";\n                                $title = $LANG['no_edit_no_delete'];\n                                $label = '<i class=\"fa fa-indent\"></i>';\n                            } else {\n                                $color = '#FEBC11';\n                                $allowed = \"R\";\n                                $title = $LANG['read'];\n                                $label = '<i class=\"fa fa-eye\"></i>';\n                            }\n                        } else {\n                            $color = '#FF0000';\n                            $allowed = false;\n                            $title = $LANG['no_access'];\n                            $label = '<i class=\"fa fa-hand-stop-o\"></i>';\n                        }\n                        if (in_array($node->id, $_SESSION['read_only_folders']) || !in_array($node->id, $_SESSION['groupes_visibles'])) {\n                            $texte .= '<td align=\\'center\\' style=\\'text-align:center;background-color:'.$color.'\\' id=\\'tm_cell_'.$i.'\\' title=\\''.$title.'\\'>'.$label.'</td>';\n                        } else {\n                            $texte .= '<td align=\\'center\\' style=\\'text-align:center;background-color:'.$color.'\\' id=\\'tm_cell_'.$i.'\\' title=\\''.$title.'\\'><span onclick=\\'openRightsDialog('.$role.','.$node->id.','.$i.',\"'.$allowed.'\")\\'>'.$label.'</span><span style=\\'float:right;\\'><input type=\\'checkbox\\' title=\\'\\' class=\\'multi_folders\\' id=\\'multisel_'.$node->id.'_'.$role.'\\'></span></td>';\n                        }\n\n\n                        $i++;\n                    }\n                    $texte .= '</tr>';\n                }\n            }\n            $texte .= '</tbody></table>';\n\n            $return_values = array(\n                \"new_table\" => $texte,\n                \"all\" => $roles_count,\n                \"next\" => $next,\n                \"previous\" => $previous,\n                \"list_of_roles\" => $arrRolesTitle\n            );\n\n            $return_values = json_encode($return_values, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP);\n\n            //return data\n            echo $return_values;\n\n            break;\n    }\n}\n"], "filenames": ["changelog.md", "includes/css/passman.css", "index.php", "install/install.queries.php", "install/upgrade_run_2.1.27.php", "items.load.php", "items.php", "roles.load.php", "roles.php", "sources/import.queries.php", "sources/roles.queries.php"], "buggy_code_start_loc": [13, 168, 119, 367, 191, 795, 229, 208, 53, 254, 290], "buggy_code_end_loc": [13, 394, 787, 368, 707, 3295, 782, 321, 64, 255, 423], "fixing_code_start_loc": [14, 168, 120, 367, 191, 795, 229, 207, 53, 254, 291], "fixing_code_end_loc": [15, 405, 788, 368, 715, 3311, 786, 336, 77, 255, 434], "type": "CWE-269", "message": "TeamPass before 2.1.27.9 does not properly enforce manager access control when requesting roles.queries.php. It is then possible for a manager user to modify any arbitrary roles within the application, or delete any arbitrary role. To exploit the vulnerability, an authenticated attacker must have the manager rights on the application, then tamper with the requests sent directly, for example by changing the \"id\" parameter when invoking \"delete_role\" on roles.queries.php.", "other": {"cve": {"id": "CVE-2017-15053", "sourceIdentifier": "cve@mitre.org", "published": "2017-11-27T19:29:00.317", "lastModified": "2019-10-03T00:03:26.223", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "TeamPass before 2.1.27.9 does not properly enforce manager access control when requesting roles.queries.php. It is then possible for a manager user to modify any arbitrary roles within the application, or delete any arbitrary role. To exploit the vulnerability, an authenticated attacker must have the manager rights on the application, then tamper with the requests sent directly, for example by changing the \"id\" parameter when invoking \"delete_role\" on roles.queries.php."}, {"lang": "es", "value": "Las versiones anteriores a la 2.1.27.9 de TeamPass no aplican correctamente el control de acceso de managers al solicitar roles.queries.php. Es posible para un usuario manager modificar o eliminar cualquier rol arbitrario en la aplicaci\u00f3n.. Para explotar la vulnerabilidad, un atacante autenticado debe tener los derechos de manager de la aplicaci\u00f3n y alterar las peticiones enviadas directamente, por ejemplo cambiando el par\u00e1metro \"id\" al invocar \"delete_role\" en roles.queries.php."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:H/UI:N/S:U/C:N/I:H/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "HIGH", "availabilityImpact": "NONE", "baseScore": 4.9, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 1.2, "impactScore": 3.6}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-269"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:teampass:teampass:*:*:*:*:*:*:*:*", "versionEndExcluding": "2.1.27.9", "matchCriteriaId": "35D9C25C-1C7F-404B-B27E-00B1BC77A868"}]}]}], "references": [{"url": "http://blog.amossys.fr/teampass-multiple-cve-01.html", "source": "cve@mitre.org", "tags": ["Exploit", "Technical Description", "Third Party Advisory"]}, {"url": "https://github.com/nilsteampassnet/TeamPass/commit/ef32e9c28b6ddc33cee8a25255bc8da54434af3e", "source": "cve@mitre.org", "tags": ["Patch"]}]}, "github_commit_url": "https://github.com/nilsteampassnet/TeamPass/commit/ef32e9c28b6ddc33cee8a25255bc8da54434af3e"}}