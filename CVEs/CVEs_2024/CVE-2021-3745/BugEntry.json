{"buggy_code": ["<?php\n\n$year = date('Y',time());\n$gallery_id = 'gallery'. (int) $_REQUEST['gal'];\n$uploads_dir = '../../content/galleries/'.$year.'/'.$gallery_id;\n\n$max_width = (int) $_REQUEST['w']; // max image width\n$max_height = (int) $_REQUEST['h']; // max image height\n$max_width_tmb = (int) $_REQUEST['w_tmb']; // max thumbnail width\n$max_height_tmb = (int) $_REQUEST['h_tmb']; // max thumbnail height\n\nif(!is_dir($uploads_dir)) {\n\tmkdir($uploads_dir, 0777, true);\n}\n\nif(!is_dir($uploads_dir)) {\n\t$result['uploaddir'] = \"Folder missing\";\n} else {\n\t$result['uploaddir'] = \"Folder okay\";\n}\n\nif(array_key_exists('file',$_FILES) && $_FILES['file']['error'] == 0 ){\n\t$tmp_name = $_FILES[\"file\"][\"tmp_name\"];\n\t$timestring = microtime(true);\n\t      \n\t$suffix = strrchr($_FILES[\"file\"][\"name\"],\".\");\n\t$org_name = $timestring . $suffix;\n\t$img_name = $timestring.\"_img.jpg\";\n\t$tmb_name = $timestring.\"_tmb.jpg\";\n        \n\tif(move_uploaded_file($tmp_name, \"$uploads_dir/$org_name\")) {\n\t\tcreate_thumbs($uploads_dir,$org_name,$img_name, $max_width,$max_height,90);\n\t\tcreate_thumbs($uploads_dir,$img_name,$tmb_name, $max_width_tmb,$max_height_tmb,80);\n\t\tunlink(\"$uploads_dir/$org_name\");\n\t\tprint ('Uploaded');\n\t}\n}\nfunction create_thumbs($updir, $img, $name, $thumbnail_width, $thumbnail_height, $quality){\n\t$arr_image_details\t= GetImageSize(\"$updir/$img\");\n\t$original_width\t\t= $arr_image_details[0];\n\t$original_height\t= $arr_image_details[1];\n\t$a = $thumbnail_width / $thumbnail_height;\n  $b = $original_width / $original_height;\n\t\n\t\n\tif ($a<$b) {\n     $new_width = $thumbnail_width;\n     $new_height\t= intval($original_height*$new_width/$original_width);\n  } else {\n     $new_height = $thumbnail_height;\n     $new_width\t= intval($original_width*$new_height/$original_height);\n  }\n\t\n\tif(($original_width <= $thumbnail_width) AND ($original_height <= $thumbnail_height)) {\n\t  $new_width = $original_width;\n\t  $new_height = $original_height;\n  }\t\n\tif($arr_image_details[2]==1) { $imgt = \"imagegif\"; $imgcreatefrom = \"imagecreatefromgif\";  }\n\tif($arr_image_details[2]==2) { $imgt = \"imagejpeg\"; $imgcreatefrom = \"imagecreatefromjpeg\";  }\n\tif($arr_image_details[2]==3) { $imgt = \"imagepng\"; $imgcreatefrom = \"imagecreatefrompng\";  }\n\tif($imgt) { \n\t\t$old_image\t= $imgcreatefrom(\"$updir/$img\");\n\t\t$new_image\t= imagecreatetruecolor($new_width, $new_height);\n\t\timagecopyresampled($new_image,$old_image,0,0,0,0,$new_width,$new_height,$original_width,$original_height);\n\t\timagejpeg($new_image,\"$updir/$name\",$quality);\n\t\timagedestroy($new_image);\n\t}\n}\n?>", "<div class=\"modal fade\" id=\"uploadGalModal\" tabindex=\"-1\" role=\"dialog\">\n  <div class=\"modal-dialog modal-lg modal-dialog-centered\" role=\"document\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\">\n        <h5 class=\"modal-title\">Upload into {post_id}</h5>\n        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\">\n          <span aria-hidden=\"true\">&times;</span>\n        </button>\n      </div>\n      <div class=\"modal-body\">\n\t\t\t\t<form method=\"post\" action=\"core/files.upload_gallery.php?gal={post_id}\" id=\"myDropzone\" class=\"dropzone dropzone-default\">\n\t\t\t\t\t<div class=\"fallback\">\n\t\t\t\t\t\t<input name=\"file\" type=\"file\" multiple />\n\t\t\t\t\t</div>\n\t\t\t\t\t<input type=\"hidden\" name=\"gal\" value=\"{post_id}\">\n\t\t\t\t\t<input type=\"hidden\" name=\"w\" value=\"{max_img_width}\">\n\t\t\t\t\t<input type=\"hidden\" name=\"w_tmb\" value=\"{max_tmb_width}\">\n\t\t\t\t\t<input type=\"hidden\" name=\"h\" value=\"{max_img_height}\">\n\t\t\t\t\t<input type=\"hidden\" name=\"h_tmb\" value=\"{max_tmb_height}\">\n\t\t\t\t\t<input type=\"hidden\" name=\"csrf_token\" value=\"{token}\">\n\t\t\t\t</form>\n      </div>\n    </div>\n  </div>\n</div>\n\n<form action=\"acp.php?tn=posts&sub=edit\" method=\"POST\" id=\"reload_form\">\n\t<input type=\"hidden\" name=\"post_id\" value=\"{post_id}\">\n</form>\n\n<script>\n$(function() {\n\t$('#uploadGalModal').on('hidden.bs.modal', function (e) {\n\t\t$(\"#reload_form\").submit();\n\t});\n});\n</script>"], "fixing_code": ["<?php\n\nsession_start();\n\nif($_SESSION['user_class'] != \"administrator\"){\n\theader(\"location:../index.php\");\n\tdie(\"PERMISSION DENIED!\");\n}\n\nrequire '../../config.php';\nif(is_file('../../'.FC_CONTENT_DIR.'/config.php')) {\n\tinclude '../../'.FC_CONTENT_DIR.'/config.php';\n}\n\nif($_POST['csrf_token'] !== $_SESSION['token']) {\n\tdie('Error: CSRF Token is invalid');\n}\n\n$year = date('Y',time());\n$gallery_id = 'gallery'. (int) $_REQUEST['gal'];\n$uploads_dir = '../../content/galleries/'.$year.'/'.$gallery_id;\n\n$max_width = (int) $_REQUEST['w']; // max image width\n$max_height = (int) $_REQUEST['h']; // max image height\n$max_width_tmb = (int) $_REQUEST['w_tmb']; // max thumbnail width\n$max_height_tmb = (int) $_REQUEST['h_tmb']; // max thumbnail height\n\nif(!is_dir($uploads_dir)) {\n\tmkdir($uploads_dir, 0777, true);\n}\n\nif(!is_dir($uploads_dir)) {\n\t$result['uploaddir'] = \"Folder missing\";\n} else {\n\t$result['uploaddir'] = \"Folder okay\";\n}\n\nif(array_key_exists('file',$_FILES) && $_FILES['file']['error'] == 0 ){\n\t\n\t$tmp_name = $_FILES[\"file\"][\"tmp_name\"];\n\t$timestring = microtime(true);\n\t$random_int = random_int(0, 999);\n\t      \n\t$suffix = substr(strrchr($_FILES[\"file\"][\"name\"],\".\"),1);\n\t$org_name = $timestring .'.'. $suffix;\n\t$img_name = $timestring.$random_int.\"_img.jpg\";\n\t$tmb_name = $timestring.$random_int.\"_tmb.jpg\";\n\n\tif(!in_array($suffix, $fc_upload_img_types)) {\n\t\texit;\n\t} else {\n        \n\t\tif(move_uploaded_file($tmp_name, \"$uploads_dir/$org_name\")) {\n\t\t\tcreate_thumbs($uploads_dir,$org_name,$img_name, $max_width,$max_height,90);\n\t\t\tcreate_thumbs($uploads_dir,$img_name,$tmb_name, $max_width_tmb,$max_height_tmb,80);\n\t\t\tunlink(\"$uploads_dir/$org_name\");\n\t\t\tprint ('Uploaded');\n\t\t}\n\t}\n}\nfunction create_thumbs($updir, $img, $name, $thumbnail_width, $thumbnail_height, $quality){\n\t$arr_image_details\t= GetImageSize(\"$updir/$img\");\n\t$original_width\t\t= $arr_image_details[0];\n\t$original_height\t= $arr_image_details[1];\n\t$a = $thumbnail_width / $thumbnail_height;\n\t$b = $original_width / $original_height;\n\t\n\t\n\tif ($a<$b) {\n     $new_width = $thumbnail_width;\n     $new_height\t= intval($original_height*$new_width/$original_width);\n  } else {\n     $new_height = $thumbnail_height;\n     $new_width\t= intval($original_width*$new_height/$original_height);\n  }\n\t\n\tif(($original_width <= $thumbnail_width) AND ($original_height <= $thumbnail_height)) {\n\t  $new_width = $original_width;\n\t  $new_height = $original_height;\n  }\t\n\tif($arr_image_details[2]==1) { $imgt = \"imagegif\"; $imgcreatefrom = \"imagecreatefromgif\";  }\n\tif($arr_image_details[2]==2) { $imgt = \"imagejpeg\"; $imgcreatefrom = \"imagecreatefromjpeg\";  }\n\tif($arr_image_details[2]==3) { $imgt = \"imagepng\"; $imgcreatefrom = \"imagecreatefrompng\";  }\n\tif($imgt) { \n\t\t$old_image\t= $imgcreatefrom(\"$updir/$img\");\n\t\t$new_image\t= imagecreatetruecolor($new_width, $new_height);\n\t\timagecopyresampled($new_image,$old_image,0,0,0,0,$new_width,$new_height,$original_width,$original_height);\n\t\timagejpeg($new_image,\"$updir/$name\",$quality);\n\t\timagedestroy($new_image);\n\t}\n}\n?>", "<div class=\"modal fade\" id=\"uploadGalModal\" tabindex=\"-1\" role=\"dialog\">\n  <div class=\"modal-dialog modal-lg modal-dialog-centered\" role=\"document\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\">\n        <h5 class=\"modal-title\">Upload into Gallery ID #{post_id}</h5>\n        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\">\n        </button>\n      </div>\n      <div class=\"modal-body\">\n\t\t\t\t<form method=\"post\" action=\"core/files.upload_gallery.php?gal={post_id}\" id=\"myDropzone\" class=\"dropzone dropzone-default\">\n\t\t\t\t\t<div class=\"fallback\">\n\t\t\t\t\t\t<input name=\"file\" type=\"file\" multiple />\n\t\t\t\t\t</div>\n\t\t\t\t\t<input type=\"hidden\" name=\"gal\" value=\"{post_id}\">\n\t\t\t\t\t<input type=\"hidden\" name=\"w\" value=\"{max_img_width}\">\n\t\t\t\t\t<input type=\"hidden\" name=\"w_tmb\" value=\"{max_tmb_width}\">\n\t\t\t\t\t<input type=\"hidden\" name=\"h\" value=\"{max_img_height}\">\n\t\t\t\t\t<input type=\"hidden\" name=\"h_tmb\" value=\"{max_tmb_height}\">\n\t\t\t\t\t<input type=\"hidden\" name=\"csrf_token\" value=\"{token}\">\n\t\t\t\t</form>\n      </div>\n    </div>\n  </div>\n</div>\n\n<form action=\"acp.php?tn=posts&sub=edit\" method=\"POST\" id=\"reload_form\">\n\t<input type=\"hidden\" name=\"post_id\" value=\"{post_id}\">\n\t<input type=\"hidden\" name=\"csrf_token\" value=\"{token}\">\n</form>\n\n<script>\n$(function() {\n\t$('#uploadGalModal').on('hidden.bs.modal', function (e) {\n\t\t$(\"#reload_form\").submit();\n\t});\n});\n</script>"], "filenames": ["acp/core/files.upload_gallery.php", "acp/templates/gallery_upload_form.tpl"], "buggy_code_start_loc": [1, 5], "buggy_code_end_loc": [44, 28], "fixing_code_start_loc": [2, 5], "fixing_code_end_loc": [67, 29], "type": "CWE-434", "message": "flatcore-cms is vulnerable to Unrestricted Upload of File with Dangerous Type", "other": {"cve": {"id": "CVE-2021-3745", "sourceIdentifier": "security@huntr.dev", "published": "2021-10-28T17:15:07.467", "lastModified": "2021-11-01T15:26:23.677", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "flatcore-cms is vulnerable to Unrestricted Upload of File with Dangerous Type"}, {"lang": "es", "value": "flatcore-cms es vulnerable a una Carga no Restringida de Archivos de Tipo Peligroso"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:H/PR:H/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "HIGH", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 6.6, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 0.7, "impactScore": 5.9}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:H/PR:H/UI:N/S:C/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "HIGH", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "CHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.0, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.3, "impactScore": 6.0}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 6.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 6.8, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "security@huntr.dev", "type": "Primary", "description": [{"lang": "en", "value": "CWE-434"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:flatcore:flatcore-cms:*:*:*:*:*:*:*:*", "versionEndExcluding": "2.1.0", "matchCriteriaId": "F16B3E68-502B-4EFF-9EE2-3B3E45C22C9E"}]}]}], "references": [{"url": "https://github.com/flatcore/flatcore-cms/commit/5cc3937b6bc38293ec921a5cf00018b48b668dc6", "source": "security@huntr.dev", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://huntr.dev/bounties/7879ab3d-8018-402a-aa0b-131bdbd1966c", "source": "security@huntr.dev", "tags": ["Exploit", "Issue Tracking", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/flatcore/flatcore-cms/commit/5cc3937b6bc38293ec921a5cf00018b48b668dc6"}}